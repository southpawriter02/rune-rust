# v0.2.2b Design Specification: Dynamic Pricing & Haggling

## Overview

**Version:** 0.2.2b
**Status:** Planning
**Focus:** Implement price modifiers based on charisma, reputation, and merchant attitude, plus the haggling system for negotiating better prices
**Prerequisites:** v0.2.2a (Shop Foundation)
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Haggle Flow](#8-haggle-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces dynamic pricing based on player attributes and merchant relationships, along with a haggling system that allows players to negotiate better prices through skill checks. Price modifiers combine charisma, reputation, attitude, and haggle discounts into a comprehensive pricing system.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Value Objects** | PriceModifier, HaggleResult, HaggleAttempt |
| **Services** | HaggleService (IHaggleService) |
| **Commands** | `haggle` |
| **Entity Updates** | Player (Charisma, haggle tracking), Merchant (haggle state) |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **dynamic pricing and negotiation pattern** that enhances the economy system:
- PriceModifier value object for multiplicative price adjustments
- Charisma stat as the first player attribute affecting commerce
- Reputation integration with faction system (from v0.2.0)
- Dice-based haggling using existing SuccessLevel system
- Foundation for future social skill checks

---

## 2. Feature Overview

```
v0.2.2b Features
├── Price Modifier System
│   ├── PriceModifier value object (multiplicative factors)
│   ├── Charisma-based pricing (2% per point from 10)
│   ├── Reputation-based pricing (Exalted to Hated)
│   ├── Attitude-based pricing (Friendly to Hostile)
│   └── Haggle discount integration
├── Haggle System
│   ├── HaggleResult value object (outcome tracking)
│   ├── HaggleAttempt value object (player state)
│   ├── IHaggleService interface
│   ├── HaggleService implementation
│   ├── Dice-based skill check (2d6 + Charisma)
│   └── SuccessLevel-based discounts
├── Player Enhancements
│   ├── Charisma stat (default 10)
│   ├── HaggleAttempts tracking per merchant
│   ├── HaggleDiscounts storage per merchant
│   └── GetHaggleBonus() method
├── Merchant Enhancements
│   ├── MaxHaggleAttempts (default 3)
│   ├── HaggleCooldownMinutes (default 60)
│   └── LastHaggleAttempt tracking
└── Integration
    ├── ShopService price calculation updates
    ├── Buy/Sell commands use PriceModifier
    └── Attitude changes from critical failures
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │    HaggleHandler    │  │   ShopHandler       │  │ IGameRenderer  │  │
│  │                     │  │   (updated)         │  │ (updated)      │  │
│  │ - HandleHaggle()    │  │ - ShowPrices()      │  │ - RenderHaggle│  │
│  │ - DisplayResult()   │  │ - ApplyModifiers()  │  │ - RenderPrices│  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         HaggleService                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + AttemptHaggle(player, merchant) : HaggleResult                 │   │
│  │ + CanHaggle(player, merchant) : bool                             │   │
│  │ + GetRemainingAttempts(player, merchant) : int                   │   │
│  │ + GetCurrentDiscount(player, merchant) : decimal                 │   │
│  │ + CalculateHaggleDC(merchant) : int                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    ShopService (updated)                         │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetBuyPrice(merchant, item, player) : int  // NEW signature    │   │
│  │ + GetSellPrice(merchant, item, player) : int // NEW signature    │   │
│  │ + CalculatePriceModifier(player, merchant) : PriceModifier       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 GameSessionService (updated)                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + HaggleWithMerchant() : HaggleResultDto                         │   │
│  │ + GetCurrentPrices() : PriceListDto                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES (Updated)                                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                     Player (updated)                            │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Charisma: int  // NEW (default 10)                           │    │
│  │ + HaggleAttempts: Dictionary<Guid, int>  // NEW                │    │
│  │ + HaggleDiscounts: Dictionary<Guid, decimal>  // NEW           │    │
│  │ + GetHaggleBonus(): int  // NEW                                │    │
│  │ + RecordHaggleAttempt(merchantId): void  // NEW                │    │
│  │ + SetHaggleDiscount(merchantId, discount): void  // NEW        │    │
│  │ + GetHaggleDiscount(merchantId): decimal  // NEW               │    │
│  │ + GetHaggleAttemptCount(merchantId): int  // NEW               │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Merchant (updated)                           │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + MaxHaggleAttempts: int  // NEW (default 3)                   │    │
│  │ + HaggleCooldownMinutes: int  // NEW (default 60)              │    │
│  │ + LastHaggleAttempt: Dictionary<Guid, DateTime>  // NEW        │    │
│  │ + CanPlayerHaggle(playerId): bool  // NEW                      │    │
│  │ + RecordHaggleAttempt(playerId): void  // NEW                  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  VALUE OBJECTS (New)                                                    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      PriceModifier                              │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + BaseMultiplier: decimal                                       │    │
│  │ + CharismaModifier: decimal                                     │    │
│  │ + ReputationModifier: decimal                                   │    │
│  │ + AttitudeModifier: decimal                                     │    │
│  │ + HaggleModifier: decimal                                       │    │
│  │ + TotalMultiplier: decimal (computed)                           │    │
│  │ + Default: PriceModifier (static)                               │    │
│  │ + ApplyToBuyPrice(basePrice): int                               │    │
│  │ + ApplyToSellPrice(basePrice): int                              │    │
│  │ + Calculate(charisma, reputation, attitude, ...): PriceModifier │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       HaggleResult                              │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + IsSuccess: bool                                               │    │
│  │ + SuccessLevel: SuccessLevel                                    │    │
│  │ + DiscountPercent: decimal                                      │    │
│  │ + RollResult: DiceRollResult                                    │    │
│  │ + DC: int                                                       │    │
│  │ + Message: string                                               │    │
│  │ + AttitudeChanged: bool                                         │    │
│  │ + NewAttitude: NPCAttitude?                                     │    │
│  │ + Success(level, discount, roll, dc, message): HaggleResult     │    │
│  │ + Failure(level, roll, dc, message, ...): HaggleResult          │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      HaggleAttempt                              │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + MerchantId: Guid                                              │    │
│  │ + AttemptNumber: int                                            │    │
│  │ + Timestamp: DateTime                                           │    │
│  │ + WasSuccessful: bool                                           │    │
│  │ + DiscountAchieved: decimal                                     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Price Modifier Calculation Flow

```
┌───────────────────────────────────────────────────────────────┐
│                    PRICE MODIFIER CALCULATION                  │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ 1. CHARISMA MODIFIER                                          │
│                                                               │
│    Formula: 1.0 - ((Charisma - 10) × 0.02)                   │
│                                                               │
│    Examples:                                                  │
│    ├── Charisma 15: 1.0 - (5 × 0.02) = 0.90 (10% discount)   │
│    ├── Charisma 10: 1.0 - (0 × 0.02) = 1.00 (no change)      │
│    └── Charisma  6: 1.0 - (-4 × 0.02) = 1.08 (8% markup)     │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ 2. REPUTATION MODIFIER                                        │
│                                                               │
│    Based on player's faction reputation with merchant:        │
│                                                               │
│    ├── Exalted    → 0.80  (20% discount)                     │
│    ├── Revered    → 0.85  (15% discount)                     │
│    ├── Honored    → 0.90  (10% discount)                     │
│    ├── Friendly   → 0.95  (5% discount)                      │
│    ├── Neutral    → 1.00  (no change)                        │
│    ├── Unfriendly → 1.10  (10% markup)                       │
│    ├── Hostile    → 1.25  (25% markup)                       │
│    └── Hated      → 1.50  (50% markup)                       │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ 3. ATTITUDE MODIFIER                                          │
│                                                               │
│    Based on merchant's current attitude toward player:        │
│                                                               │
│    ├── Friendly → 0.95  (5% discount)                        │
│    ├── Neutral  → 1.00  (no change)                          │
│    ├── Wary     → 1.05  (5% markup)                          │
│    └── Hostile  → 1.20  (20% markup)                         │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ 4. HAGGLE MODIFIER                                            │
│                                                               │
│    Applied if player has successfully haggled:                │
│                                                               │
│    Formula: 1.0 - haggleDiscount                             │
│                                                               │
│    Examples:                                                  │
│    ├── No haggle      → 1.00 (no change)                     │
│    ├── 10% discount   → 0.90 (10% off)                       │
│    └── 20% discount   → 0.80 (20% off)                       │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ 5. TOTAL MULTIPLIER                                           │
│                                                               │
│    Formula: Base × Charisma × Reputation × Attitude × Haggle  │
│                                                               │
│    Example calculation:                                       │
│    ├── Base price:      100 gold                             │
│    ├── Charisma 14:     × 0.92                               │
│    ├── Friendly rep:    × 0.95                               │
│    ├── Neutral attitude:× 1.00                               │
│    ├── 10% haggle:      × 0.90                               │
│    ├── Total mult:      0.7866                               │
│    └── Final price:     79 gold (ceiling)                    │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Haggle Flow Diagram

```
┌───────────────────┐
│   Player Input    │
│ "haggle"          │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                      VALIDATIONS                              │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────┐                                        │
│  │ Merchant in room? │──NO──▶ "No merchant to haggle with"    │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Already haggled   │──YES─▶ "You already have a discount"   │
│  │ successfully?     │                                        │
│  └─────────┬─────────┘                                        │
│            NO                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Attempts remain?  │──NO──▶ "Merchant won't negotiate"      │
│  └─────────┬─────────┘        "further. Try again later."     │
│           YES                                                 │
│            │                                                  │
└────────────┼──────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    CALCULATE HAGGLE DC                        │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  Base DC: 12                                                  │
│                                                               │
│  Attitude Modifier:                                           │
│  ├── Friendly:  DC - 2                                        │
│  ├── Neutral:   DC + 0                                        │
│  ├── Wary:      DC + 2                                        │
│  └── Hostile:   DC + 5                                        │
│                                                               │
│  Transaction Bonus:                                           │
│  ├── 10+ transactions: DC - 2                                 │
│  └── 5+ transactions:  DC - 1                                 │
│                                                               │
│  Minimum DC: 8                                                │
│                                                               │
└───────────────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    SKILL CHECK (2d6 + Charisma Bonus)         │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  Roll: 2d6 + GetHaggleBonus()                                 │
│                                                               │
│  Charisma Bonus = (Charisma - 10) / 2 (rounded down)          │
│                                                               │
│  Example: Charisma 14 → Bonus +2                              │
│           Charisma 8  → Bonus -1                              │
│                                                               │
└───────────────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                   DETERMINE RESULT                            │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ Roll >= DC + 5: CRITICAL SUCCESS                       │   │
│  │                                                        │   │
│  │ - Discount: 20%                                        │   │
│  │ - Message: Merchant impressed by negotiation           │   │
│  │ - Discount locked for session                          │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ Roll >= DC: SUCCESS                                    │   │
│  │                                                        │   │
│  │ - Discount: 10%                                        │   │
│  │ - Message: Merchant agrees to better prices            │   │
│  │ - Discount locked for session                          │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ Roll >= DC - 3: PARTIAL SUCCESS                        │   │
│  │                                                        │   │
│  │ - Discount: 5%                                         │   │
│  │ - Message: Merchant offers small concession            │   │
│  │ - Discount locked for session                          │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ Roll >= DC - 6: FAILURE                                │   │
│  │                                                        │   │
│  │ - Discount: 0%                                         │   │
│  │ - Message: Merchant refuses                            │   │
│  │ - Can try again (uses attempt)                         │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ Roll < DC - 6: CRITICAL FAILURE                        │   │
│  │                                                        │   │
│  │ - Discount: 0%                                         │   │
│  │ - Message: Merchant offended                           │   │
│  │ - Attitude may worsen (Friendly→Neutral, etc.)         │   │
│  │ - No more haggle attempts allowed                      │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    UPDATE STATE                               │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  - Player.RecordHaggleAttempt(merchantId)                     │
│  - If success: Player.SetHaggleDiscount(merchantId, discount) │
│  - Merchant.RecordHaggleAttempt(playerId)                     │
│  - If critical failure: Merchant.SetAttitude(newAttitude)     │
│                                                               │
└───────────────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    DISPLAY RESULT                             │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  [Haggle Check: DC 12]                                        │
│  Rolling 2d6 + Charisma (2)...                                │
│  Rolled: 5, 4 = 9 + 2 = 11                                    │
│  Failed!                                                      │
│                                                               │
│  Grimbold frowns. "My prices are fair."                       │
│  Attempts remaining: 2                                        │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-2.2b-1: View Dynamic Prices
**As a** player with high charisma and good reputation
**I want to** see lower prices when shopping
**So that** my character attributes provide tangible benefits

**Acceptance Criteria:**
- Prices displayed reflect charisma modifier
- Prices reflect faction reputation with merchant
- Prices reflect merchant's current attitude
- Price breakdown shows individual modifiers on request

### US-2.2b-2: Haggle for Better Prices
**As a** player interacting with a merchant
**I want to** attempt to negotiate better prices
**So that** I can spend less gold on purchases

**Acceptance Criteria:**
- `haggle` command initiates negotiation
- Dice roll shown with modifiers
- Success grants discount on all purchases
- Discount persists for current shop session

### US-2.2b-3: Limited Haggle Attempts
**As a** player negotiating with a merchant
**I want to** know how many attempts I have left
**So that** I can decide whether to keep trying

**Acceptance Criteria:**
- Remaining attempts shown after each haggle
- Merchants have configurable max attempts (default 3)
- Attempts reset after cooldown period
- Successful haggle ends negotiation phase

### US-2.2b-4: Critical Haggle Results
**As a** player taking risks in negotiation
**I want to** potentially achieve greater discounts or face consequences
**So that** haggling feels meaningful and has tension

**Acceptance Criteria:**
- Critical success grants 20% discount
- Critical failure may worsen merchant attitude
- Standard success grants 10% discount
- Partial success grants 5% discount

### US-2.2b-5: Charisma Stat Effects
**As a** player with a charismatic character
**I want my** charisma stat to affect prices and haggling
**So that** character building affects commerce

**Acceptance Criteria:**
- High charisma reduces base prices
- Charisma provides bonus to haggle rolls
- Low charisma increases prices
- Effects are clearly visible in UI

---

## 5. Data Models

### 5.1 PriceModifier Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents factors that modify transaction prices.
/// </summary>
public readonly record struct PriceModifier
{
    /// <summary>
    /// Gets the base multiplier (1.0 = no change).
    /// </summary>
    public decimal BaseMultiplier { get; init; }

    /// <summary>
    /// Gets the charisma modifier.
    /// </summary>
    public decimal CharismaModifier { get; init; }

    /// <summary>
    /// Gets the reputation modifier.
    /// </summary>
    public decimal ReputationModifier { get; init; }

    /// <summary>
    /// Gets the attitude modifier.
    /// </summary>
    public decimal AttitudeModifier { get; init; }

    /// <summary>
    /// Gets the haggle modifier (if successful).
    /// </summary>
    public decimal HaggleModifier { get; init; }

    /// <summary>
    /// Gets the combined multiplier.
    /// </summary>
    public decimal TotalMultiplier =>
        BaseMultiplier * CharismaModifier * ReputationModifier * AttitudeModifier * HaggleModifier;

    /// <summary>
    /// Gets a default modifier with no adjustments.
    /// </summary>
    public static PriceModifier Default => new()
    {
        BaseMultiplier = 1.0m,
        CharismaModifier = 1.0m,
        ReputationModifier = 1.0m,
        AttitudeModifier = 1.0m,
        HaggleModifier = 1.0m
    };

    /// <summary>
    /// Applies this modifier to a base price for buying.
    /// </summary>
    /// <param name="basePrice">The item's base price.</param>
    /// <returns>The modified buy price (rounded up).</returns>
    public int ApplyToBuyPrice(int basePrice)
    {
        return (int)Math.Ceiling(basePrice * TotalMultiplier);
    }

    /// <summary>
    /// Applies this modifier to a sell price (inverse for player benefit).
    /// </summary>
    /// <param name="basePrice">The item's base sell price.</param>
    /// <returns>The modified sell price (rounded down).</returns>
    public int ApplyToSellPrice(int basePrice)
    {
        // For selling, lower multiplier = better for player
        var sellMultiplier = 2.0m - TotalMultiplier; // Inverse
        sellMultiplier = Math.Max(0.5m, Math.Min(1.5m, sellMultiplier)); // Clamp
        return (int)Math.Floor(basePrice * sellMultiplier);
    }

    /// <summary>
    /// Creates a modifier from character stats and context.
    /// </summary>
    /// <param name="charisma">Player's charisma stat.</param>
    /// <param name="reputation">Player's reputation with merchant's faction.</param>
    /// <param name="attitude">Merchant's attitude toward player.</param>
    /// <param name="hasHaggled">Whether player has successfully haggled.</param>
    /// <param name="haggleDiscount">Discount percentage from haggling (0-0.30).</param>
    /// <returns>A configured PriceModifier.</returns>
    public static PriceModifier Calculate(
        int charisma,
        ReputationLevel reputation,
        NPCAttitude attitude,
        bool hasHaggled = false,
        decimal haggleDiscount = 0m)
    {
        return new PriceModifier
        {
            BaseMultiplier = 1.0m,
            CharismaModifier = CalculateCharismaModifier(charisma),
            ReputationModifier = CalculateReputationModifier(reputation),
            AttitudeModifier = CalculateAttitudeModifier(attitude),
            HaggleModifier = hasHaggled ? (1.0m - haggleDiscount) : 1.0m
        };
    }

    private static decimal CalculateCharismaModifier(int charisma)
    {
        // Each point of charisma above 10 reduces prices by 2%
        // Each point below 10 increases prices by 2%
        var difference = charisma - 10;
        return 1.0m - (difference * 0.02m);
    }

    private static decimal CalculateReputationModifier(ReputationLevel reputation)
    {
        return reputation switch
        {
            ReputationLevel.Exalted => 0.80m,    // 20% discount
            ReputationLevel.Revered => 0.85m,    // 15% discount
            ReputationLevel.Honored => 0.90m,    // 10% discount
            ReputationLevel.Friendly => 0.95m,   // 5% discount
            ReputationLevel.Neutral => 1.00m,    // No change
            ReputationLevel.Unfriendly => 1.10m, // 10% markup
            ReputationLevel.Hostile => 1.25m,    // 25% markup
            ReputationLevel.Hated => 1.50m,      // 50% markup
            _ => 1.00m
        };
    }

    private static decimal CalculateAttitudeModifier(NPCAttitude attitude)
    {
        return attitude switch
        {
            NPCAttitude.Friendly => 0.95m,  // 5% discount
            NPCAttitude.Neutral => 1.00m,   // No change
            NPCAttitude.Wary => 1.05m,      // 5% markup
            NPCAttitude.Hostile => 1.20m,   // 20% markup
            _ => 1.00m
        };
    }
}
```

### 5.2 HaggleResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of a haggle attempt.
/// </summary>
public readonly record struct HaggleResult
{
    /// <summary>
    /// Gets whether the haggle was successful.
    /// </summary>
    public bool IsSuccess { get; init; }

    /// <summary>
    /// Gets the success level achieved.
    /// </summary>
    public SuccessLevel SuccessLevel { get; init; }

    /// <summary>
    /// Gets the discount percentage achieved (0-0.30).
    /// </summary>
    public decimal DiscountPercent { get; init; }

    /// <summary>
    /// Gets the dice roll result.
    /// </summary>
    public DiceRollResult RollResult { get; init; }

    /// <summary>
    /// Gets the difficulty class that was checked.
    /// </summary>
    public int DC { get; init; }

    /// <summary>
    /// Gets a flavor message for the result.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets whether the merchant's attitude changed.
    /// </summary>
    public bool AttitudeChanged { get; init; }

    /// <summary>
    /// Gets the new attitude if changed.
    /// </summary>
    public NPCAttitude? NewAttitude { get; init; }

    /// <summary>
    /// Creates a successful haggle result.
    /// </summary>
    /// <param name="level">The success level achieved.</param>
    /// <param name="discount">The discount percentage (0.05 to 0.20).</param>
    /// <param name="roll">The dice roll result.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="message">Flavor message for the outcome.</param>
    /// <returns>A successful HaggleResult.</returns>
    public static HaggleResult Success(
        SuccessLevel level,
        decimal discount,
        DiceRollResult roll,
        int dc,
        string message)
    {
        return new HaggleResult
        {
            IsSuccess = true,
            SuccessLevel = level,
            DiscountPercent = discount,
            RollResult = roll,
            DC = dc,
            Message = message,
            AttitudeChanged = false,
            NewAttitude = null
        };
    }

    /// <summary>
    /// Creates a failed haggle result.
    /// </summary>
    /// <param name="level">The failure level.</param>
    /// <param name="roll">The dice roll result.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="message">Flavor message for the outcome.</param>
    /// <param name="attitudeChanged">Whether attitude worsened.</param>
    /// <param name="newAttitude">The new attitude if changed.</param>
    /// <returns>A failed HaggleResult.</returns>
    public static HaggleResult Failure(
        SuccessLevel level,
        DiceRollResult roll,
        int dc,
        string message,
        bool attitudeChanged = false,
        NPCAttitude? newAttitude = null)
    {
        return new HaggleResult
        {
            IsSuccess = false,
            SuccessLevel = level,
            DiscountPercent = 0m,
            RollResult = roll,
            DC = dc,
            Message = message,
            AttitudeChanged = attitudeChanged,
            NewAttitude = newAttitude
        };
    }
}
```

### 5.3 HaggleAttempt Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Records a haggle attempt by a player with a merchant.
/// </summary>
public readonly record struct HaggleAttempt
{
    /// <summary>
    /// Gets the merchant ID this attempt was with.
    /// </summary>
    public Guid MerchantId { get; init; }

    /// <summary>
    /// Gets which attempt number this was (1-based).
    /// </summary>
    public int AttemptNumber { get; init; }

    /// <summary>
    /// Gets when this attempt occurred.
    /// </summary>
    public DateTime Timestamp { get; init; }

    /// <summary>
    /// Gets whether this attempt was successful.
    /// </summary>
    public bool WasSuccessful { get; init; }

    /// <summary>
    /// Gets the discount achieved (0 if failed).
    /// </summary>
    public decimal DiscountAchieved { get; init; }

    /// <summary>
    /// Creates a new haggle attempt record.
    /// </summary>
    /// <param name="merchantId">The merchant ID.</param>
    /// <param name="attemptNumber">Which attempt this is.</param>
    /// <param name="wasSuccessful">Whether it succeeded.</param>
    /// <param name="discountAchieved">The discount if successful.</param>
    /// <returns>A new HaggleAttempt record.</returns>
    public static HaggleAttempt Create(
        Guid merchantId,
        int attemptNumber,
        bool wasSuccessful,
        decimal discountAchieved = 0m)
    {
        return new HaggleAttempt
        {
            MerchantId = merchantId,
            AttemptNumber = attemptNumber,
            Timestamp = DateTime.UtcNow,
            WasSuccessful = wasSuccessful,
            DiscountAchieved = discountAchieved
        };
    }
}
```

### 5.4 Player Entity Updates

```csharp
// Additions to Player.cs

/// <summary>
/// Gets the player's charisma stat.
/// </summary>
public int Charisma { get; private set; } = 10;

/// <summary>
/// Gets haggle attempts per merchant (merchant ID -> attempt count).
/// </summary>
private readonly Dictionary<Guid, int> _haggleAttempts = new();

/// <summary>
/// Gets haggle discounts per merchant (merchant ID -> discount percentage).
/// </summary>
private readonly Dictionary<Guid, decimal> _haggleDiscounts = new();

/// <summary>
/// Gets the haggle bonus from charisma.
/// </summary>
/// <returns>The modifier to add to haggle rolls.</returns>
public int GetHaggleBonus()
{
    // Standard D&D-style modifier: (Stat - 10) / 2
    return (Charisma - 10) / 2;
}

/// <summary>
/// Records a haggle attempt with a merchant.
/// </summary>
/// <param name="merchantId">The merchant's ID.</param>
public void RecordHaggleAttempt(Guid merchantId)
{
    if (_haggleAttempts.ContainsKey(merchantId))
    {
        _haggleAttempts[merchantId]++;
    }
    else
    {
        _haggleAttempts[merchantId] = 1;
    }
}

/// <summary>
/// Sets the haggle discount for a merchant.
/// </summary>
/// <param name="merchantId">The merchant's ID.</param>
/// <param name="discount">The discount percentage (0.05-0.20).</param>
public void SetHaggleDiscount(Guid merchantId, decimal discount)
{
    _haggleDiscounts[merchantId] = discount;
}

/// <summary>
/// Gets the current haggle discount for a merchant.
/// </summary>
/// <param name="merchantId">The merchant's ID.</param>
/// <returns>The discount percentage, or 0 if none.</returns>
public decimal GetHaggleDiscount(Guid merchantId)
{
    return _haggleDiscounts.TryGetValue(merchantId, out var discount) ? discount : 0m;
}

/// <summary>
/// Gets the number of haggle attempts with a merchant.
/// </summary>
/// <param name="merchantId">The merchant's ID.</param>
/// <returns>The attempt count.</returns>
public int GetHaggleAttemptCount(Guid merchantId)
{
    return _haggleAttempts.TryGetValue(merchantId, out var count) ? count : 0;
}

/// <summary>
/// Checks if the player has already successfully haggled with a merchant.
/// </summary>
/// <param name="merchantId">The merchant's ID.</param>
/// <returns>True if player has a discount with this merchant.</returns>
public bool HasHaggleDiscount(Guid merchantId)
{
    return _haggleDiscounts.ContainsKey(merchantId) && _haggleDiscounts[merchantId] > 0;
}

/// <summary>
/// Clears all haggle state (for session reset).
/// </summary>
public void ClearHaggleState()
{
    _haggleAttempts.Clear();
    _haggleDiscounts.Clear();
}
```

### 5.5 Merchant Entity Updates

```csharp
// Additions to Merchant.cs

/// <summary>
/// Gets the maximum haggle attempts allowed per player.
/// </summary>
public int MaxHaggleAttempts { get; private set; } = 3;

/// <summary>
/// Gets the cooldown in minutes before haggle attempts reset.
/// </summary>
public int HaggleCooldownMinutes { get; private set; } = 60;

/// <summary>
/// Gets the last haggle attempt time per player (player ID -> timestamp).
/// </summary>
private readonly Dictionary<Guid, DateTime> _lastHaggleAttempt = new();

/// <summary>
/// Checks if a player can attempt to haggle.
/// </summary>
/// <param name="playerId">The player's ID.</param>
/// <param name="currentAttempts">The player's current attempt count.</param>
/// <returns>True if the player can haggle.</returns>
public bool CanPlayerHaggle(Guid playerId, int currentAttempts)
{
    // Check if cooldown has passed
    if (_lastHaggleAttempt.TryGetValue(playerId, out var lastAttempt))
    {
        var cooldownEnd = lastAttempt.AddMinutes(HaggleCooldownMinutes);
        if (DateTime.UtcNow < cooldownEnd && currentAttempts >= MaxHaggleAttempts)
        {
            return false;
        }
    }

    return currentAttempts < MaxHaggleAttempts;
}

/// <summary>
/// Records a haggle attempt from a player.
/// </summary>
/// <param name="playerId">The player's ID.</param>
public void RecordHaggleAttempt(Guid playerId)
{
    _lastHaggleAttempt[playerId] = DateTime.UtcNow;
}

/// <summary>
/// Gets minutes remaining until haggle cooldown ends.
/// </summary>
/// <param name="playerId">The player's ID.</param>
/// <returns>Minutes remaining, or 0 if no cooldown active.</returns>
public int GetHaggleCooldownRemaining(Guid playerId)
{
    if (!_lastHaggleAttempt.TryGetValue(playerId, out var lastAttempt))
    {
        return 0;
    }

    var cooldownEnd = lastAttempt.AddMinutes(HaggleCooldownMinutes);
    var remaining = cooldownEnd - DateTime.UtcNow;

    return remaining.TotalMinutes > 0 ? (int)Math.Ceiling(remaining.TotalMinutes) : 0;
}
```

---

## 6. Configuration Schemas

### 6.1 Merchant Configuration Updates

The existing `merchants.json` configuration will be extended with haggle settings:

```json
{
  "$schema": "./schemas/merchants.schema.json",
  "merchants": [
    {
      "id": "grimbold-blacksmith",
      "name": "Grimbold",
      "type": "Merchant",
      "defaultAttitude": "Neutral",
      "greeting": "Welcome to my shop! See anything you like?",
      "description": "A gruff dwarf with soot-stained hands.",
      "startingGold": 500,
      "buyMultiplier": 1.0,
      "sellMultiplier": 0.5,
      "factionId": "town-merchants-guild",
      "haggleSettings": {
        "maxAttempts": 3,
        "cooldownMinutes": 60,
        "baseDC": 12
      },
      "initialStock": [
        { "itemId": "iron-sword", "quantity": 3 },
        { "itemId": "leather-armor", "quantity": 2 },
        { "itemId": "health-potion", "quantity": 10 },
        { "itemId": "torch", "quantity": -1 }
      ]
    },
    {
      "id": "elara-alchemist",
      "name": "Elara",
      "type": "Merchant",
      "defaultAttitude": "Friendly",
      "greeting": "Ah, a customer! I have just the thing you need.",
      "description": "A young elf surrounded by bubbling potions.",
      "startingGold": 300,
      "buyMultiplier": 1.1,
      "sellMultiplier": 0.6,
      "factionId": "mages-guild",
      "haggleSettings": {
        "maxAttempts": 2,
        "cooldownMinutes": 30,
        "baseDC": 14
      },
      "initialStock": [
        { "itemId": "health-potion", "quantity": 20 },
        { "itemId": "mana-potion", "quantity": 15 },
        { "itemId": "antidote", "quantity": 5 }
      ]
    }
  ]
}
```

### 6.2 Haggle Settings Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "HaggleSettings",
  "type": "object",
  "properties": {
    "maxAttempts": {
      "type": "integer",
      "minimum": 1,
      "maximum": 10,
      "default": 3,
      "description": "Maximum haggle attempts per player before cooldown"
    },
    "cooldownMinutes": {
      "type": "integer",
      "minimum": 0,
      "maximum": 1440,
      "default": 60,
      "description": "Minutes before haggle attempts reset"
    },
    "baseDC": {
      "type": "integer",
      "minimum": 5,
      "maximum": 25,
      "default": 12,
      "description": "Base difficulty class for haggle checks"
    }
  },
  "required": [],
  "additionalProperties": false
}
```

### 6.3 Haggle Messages Configuration

```json
{
  "$schema": "./schemas/haggle-messages.schema.json",
  "haggleMessages": {
    "criticalSuccess": [
      "{merchant} is impressed! \"You drive a hard bargain. 20% off everything!\"",
      "\"Well played,\" {merchant} admits. \"You've earned a 20% discount.\"",
      "{merchant} laughs. \"Fine, fine! 20% off. You've bested me fairly.\""
    ],
    "success": [
      "{merchant} nods reluctantly. \"Alright, 10% off my prices.\"",
      "\"You make a fair point,\" {merchant} concedes. \"10% discount for you.\"",
      "{merchant} strokes their chin. \"Very well. 10% off.\""
    ],
    "partialSuccess": [
      "{merchant} sighs. \"I'll knock 5% off, but that's my final offer.\"",
      "\"Don't push your luck,\" {merchant} warns. \"5% is all I can do.\"",
      "{merchant} grudgingly agrees. \"Fine. 5% off. Take it or leave it.\""
    ],
    "failure": [
      "{merchant} shakes their head. \"My prices are fair as they are.\"",
      "\"Nice try,\" {merchant} says with a smirk. \"But no.\"",
      "{merchant} crosses their arms. \"The price stands.\""
    ],
    "criticalFailure": [
      "{merchant} scowls. \"You insult me with such offers!\"",
      "\"How dare you!\" {merchant} snaps angrily.",
      "{merchant}'s expression darkens. \"I don't appreciate such disrespect.\""
    ],
    "noMoreAttempts": [
      "{merchant} holds up a hand. \"We're done negotiating. Buy something or leave.\"",
      "\"Enough!\" {merchant} says firmly. \"No more haggling today.\"",
      "{merchant} sighs wearily. \"I've heard enough. My prices are final.\""
    ],
    "alreadyHasDiscount": [
      "You already have a {discount}% discount with {merchant}.",
      "{merchant} reminds you of your existing {discount}% discount."
    ]
  }
}
```

---

## 7. Service Specifications

### 7.1 IHaggleService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages haggling negotiations with merchants.
/// </summary>
public interface IHaggleService
{
    /// <summary>
    /// Attempts to haggle with a merchant for better prices.
    /// </summary>
    /// <param name="player">The player attempting to haggle.</param>
    /// <param name="merchant">The merchant being haggled with.</param>
    /// <returns>The result of the haggle attempt.</returns>
    HaggleResult AttemptHaggle(Player player, Merchant merchant);

    /// <summary>
    /// Checks whether the player can haggle with this merchant.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="merchant">The merchant.</param>
    /// <returns>True if haggling is possible.</returns>
    bool CanHaggle(Player player, Merchant merchant);

    /// <summary>
    /// Gets the remaining haggle attempts for a player with a merchant.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="merchant">The merchant.</param>
    /// <returns>Number of remaining attempts.</returns>
    int GetRemainingAttempts(Player player, Merchant merchant);

    /// <summary>
    /// Gets the current haggle discount for a player with a merchant.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="merchant">The merchant.</param>
    /// <returns>The discount percentage (0-0.30), or 0 if none.</returns>
    decimal GetCurrentDiscount(Player player, Merchant merchant);

    /// <summary>
    /// Calculates the haggle difficulty class for a merchant.
    /// </summary>
    /// <param name="merchant">The merchant.</param>
    /// <returns>The DC for haggle checks.</returns>
    int CalculateHaggleDC(Merchant merchant);
}
```

### 7.2 HaggleService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Implementation of haggle negotiation logic.
/// </summary>
public class HaggleService : IHaggleService
{
    private readonly IDiceService _diceService;
    private readonly ILogger<HaggleService> _logger;

    /// <summary>
    /// Initializes a new instance of the HaggleService.
    /// </summary>
    /// <param name="diceService">The dice rolling service.</param>
    /// <param name="logger">The logger instance.</param>
    public HaggleService(
        IDiceService diceService,
        ILogger<HaggleService> logger)
    {
        _diceService = diceService ?? throw new ArgumentNullException(nameof(diceService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public HaggleResult AttemptHaggle(Player player, Merchant merchant)
    {
        _logger.LogInformation(
            "AttemptHaggle: Player {PlayerId} haggling with {MerchantName}",
            player.Id, merchant.Name);

        // Validate can haggle
        if (!CanHaggle(player, merchant))
        {
            _logger.LogDebug("Player cannot haggle with this merchant");
            return HaggleResult.Failure(
                SuccessLevel.Failure,
                default,
                0,
                GetCannotHaggleMessage(player, merchant));
        }

        // Calculate DC
        var dc = CalculateHaggleDC(merchant);

        // Roll 2d6 + charisma bonus
        var roll = _diceService.RollDice(2, 6);
        var bonus = player.GetHaggleBonus();
        var total = roll.Total + bonus;

        _logger.LogDebug(
            "Haggle roll: {RollTotal} + {Bonus} = {Total} vs DC {DC}",
            roll.Total, bonus, total, dc);

        // Record the attempt
        player.RecordHaggleAttempt(merchant.Id);
        merchant.RecordHaggleAttempt(player.Id);

        // Determine success level and result
        return DetermineHaggleResult(player, merchant, roll, bonus, total, dc);
    }

    private HaggleResult DetermineHaggleResult(
        Player player,
        Merchant merchant,
        DiceRollResult roll,
        int bonus,
        int total,
        int dc)
    {
        if (total >= dc + 5)
        {
            // Critical Success - 20% discount
            var discount = 0.20m;
            player.SetHaggleDiscount(merchant.Id, discount);

            _logger.LogInformation(
                "Haggle CRITICAL SUCCESS: {Discount}% discount achieved",
                discount * 100);

            return HaggleResult.Success(
                SuccessLevel.CriticalSuccess,
                discount,
                roll,
                dc,
                GetSuccessMessage(merchant.Name, SuccessLevel.CriticalSuccess));
        }
        else if (total >= dc)
        {
            // Success - 10% discount
            var discount = 0.10m;
            player.SetHaggleDiscount(merchant.Id, discount);

            _logger.LogInformation(
                "Haggle SUCCESS: {Discount}% discount achieved",
                discount * 100);

            return HaggleResult.Success(
                SuccessLevel.Success,
                discount,
                roll,
                dc,
                GetSuccessMessage(merchant.Name, SuccessLevel.Success));
        }
        else if (total >= dc - 3)
        {
            // Partial Success - 5% discount
            var discount = 0.05m;
            player.SetHaggleDiscount(merchant.Id, discount);

            _logger.LogInformation(
                "Haggle PARTIAL SUCCESS: {Discount}% discount achieved",
                discount * 100);

            return HaggleResult.Success(
                SuccessLevel.PartialSuccess,
                discount,
                roll,
                dc,
                GetSuccessMessage(merchant.Name, SuccessLevel.PartialSuccess));
        }
        else if (total >= dc - 6)
        {
            // Failure - no discount
            _logger.LogDebug("Haggle FAILURE: No discount");

            return HaggleResult.Failure(
                SuccessLevel.Failure,
                roll,
                dc,
                GetFailureMessage(merchant.Name, SuccessLevel.Failure));
        }
        else
        {
            // Critical Failure - attitude may worsen
            _logger.LogDebug("Haggle CRITICAL FAILURE: Attitude may worsen");

            var attitudeChanged = false;
            NPCAttitude? newAttitude = null;

            // Worsen attitude
            if (merchant.Attitude == NPCAttitude.Friendly)
            {
                merchant.SetAttitude(NPCAttitude.Neutral);
                attitudeChanged = true;
                newAttitude = NPCAttitude.Neutral;
            }
            else if (merchant.Attitude == NPCAttitude.Neutral)
            {
                merchant.SetAttitude(NPCAttitude.Wary);
                attitudeChanged = true;
                newAttitude = NPCAttitude.Wary;
            }

            return HaggleResult.Failure(
                SuccessLevel.CriticalFailure,
                roll,
                dc,
                GetFailureMessage(merchant.Name, SuccessLevel.CriticalFailure),
                attitudeChanged,
                newAttitude);
        }
    }

    /// <inheritdoc />
    public bool CanHaggle(Player player, Merchant merchant)
    {
        // Already has discount
        if (player.HasHaggleDiscount(merchant.Id))
        {
            return false;
        }

        // Check attempts remaining
        var attempts = player.GetHaggleAttemptCount(merchant.Id);
        return merchant.CanPlayerHaggle(player.Id, attempts);
    }

    /// <inheritdoc />
    public int GetRemainingAttempts(Player player, Merchant merchant)
    {
        var attempts = player.GetHaggleAttemptCount(merchant.Id);
        return Math.Max(0, merchant.MaxHaggleAttempts - attempts);
    }

    /// <inheritdoc />
    public decimal GetCurrentDiscount(Player player, Merchant merchant)
    {
        return player.GetHaggleDiscount(merchant.Id);
    }

    /// <inheritdoc />
    public int CalculateHaggleDC(Merchant merchant)
    {
        var baseDC = 12;

        // Attitude affects DC
        baseDC += merchant.Attitude switch
        {
            NPCAttitude.Friendly => -2,
            NPCAttitude.Neutral => 0,
            NPCAttitude.Wary => 2,
            NPCAttitude.Hostile => 5,
            _ => 0
        };

        // Previous purchases lower DC
        if (merchant.TransactionCount > 10)
        {
            baseDC -= 2;
        }
        else if (merchant.TransactionCount > 5)
        {
            baseDC -= 1;
        }

        return Math.Max(8, baseDC); // Minimum DC 8
    }

    private string GetCannotHaggleMessage(Player player, Merchant merchant)
    {
        if (player.HasHaggleDiscount(merchant.Id))
        {
            var discount = player.GetHaggleDiscount(merchant.Id) * 100;
            return $"You already have a {discount:F0}% discount with {merchant.Name}.";
        }

        var remaining = GetRemainingAttempts(player, merchant);
        if (remaining <= 0)
        {
            var cooldown = merchant.GetHaggleCooldownRemaining(player.Id);
            if (cooldown > 0)
            {
                return $"{merchant.Name} won't negotiate further. Try again in {cooldown} minutes.";
            }
            return $"{merchant.Name} won't negotiate further.";
        }

        return "You cannot haggle with this merchant.";
    }

    private string GetSuccessMessage(string merchantName, SuccessLevel level)
    {
        return level switch
        {
            SuccessLevel.CriticalSuccess =>
                $"{merchantName} is impressed! \"You drive a hard bargain. 20% off everything!\"",
            SuccessLevel.Success =>
                $"{merchantName} nods reluctantly. \"Alright, 10% off my prices.\"",
            SuccessLevel.PartialSuccess =>
                $"{merchantName} sighs. \"I'll knock 5% off, but that's my final offer.\"",
            _ => $"{merchantName} agrees to your terms."
        };
    }

    private string GetFailureMessage(string merchantName, SuccessLevel level)
    {
        return level switch
        {
            SuccessLevel.CriticalFailure =>
                $"{merchantName} scowls. \"You insult me with such offers!\"",
            _ =>
                $"{merchantName} shakes their head. \"My prices are fair as they are.\""
        };
    }
}
```

### 7.3 ShopService Updates

```csharp
// Updates to ShopService.cs

/// <summary>
/// Gets the buy price for an item with all modifiers applied.
/// </summary>
/// <param name="merchant">The merchant.</param>
/// <param name="item">The item to price.</param>
/// <param name="player">The player buying.</param>
/// <returns>The final buy price.</returns>
public int GetBuyPrice(Merchant merchant, Item item, Player player)
{
    var basePrice = merchant.GetBuyPrice(item);
    var modifier = CalculatePriceModifier(player, merchant);

    var finalPrice = modifier.ApplyToBuyPrice(basePrice);

    _logger.LogDebug(
        "GetBuyPrice: {Item} base {Base} × {Modifier} = {Final}",
        item.Name, basePrice, modifier.TotalMultiplier, finalPrice);

    return finalPrice;
}

/// <summary>
/// Gets the sell price for an item with all modifiers applied.
/// </summary>
/// <param name="merchant">The merchant.</param>
/// <param name="item">The item to price.</param>
/// <param name="player">The player selling.</param>
/// <returns>The final sell price.</returns>
public int GetSellPrice(Merchant merchant, Item item, Player player)
{
    var basePrice = merchant.GetSellPrice(item);
    var modifier = CalculatePriceModifier(player, merchant);

    var finalPrice = modifier.ApplyToSellPrice(basePrice);

    _logger.LogDebug(
        "GetSellPrice: {Item} base {Base} → {Final}",
        item.Name, basePrice, finalPrice);

    return finalPrice;
}

/// <summary>
/// Calculates the price modifier for a player-merchant interaction.
/// </summary>
/// <param name="player">The player.</param>
/// <param name="merchant">The merchant.</param>
/// <returns>The combined price modifier.</returns>
public PriceModifier CalculatePriceModifier(Player player, Merchant merchant)
{
    // Get player's reputation with merchant's faction
    var reputation = GetPlayerReputation(player, merchant.FactionId);

    // Check if player has haggled
    var hasHaggled = player.HasHaggleDiscount(merchant.Id);
    var haggleDiscount = player.GetHaggleDiscount(merchant.Id);

    return PriceModifier.Calculate(
        player.Charisma,
        reputation,
        merchant.Attitude,
        hasHaggled,
        haggleDiscount);
}

private ReputationLevel GetPlayerReputation(Player player, string? factionId)
{
    if (string.IsNullOrEmpty(factionId))
    {
        return ReputationLevel.Neutral;
    }

    // Use reputation service if available
    return _reputationService?.GetReputation(player, factionId) ?? ReputationLevel.Neutral;
}
```

---

## 8. Haggle Flow

### 8.1 Haggle Command Flow

```
Player Input: "haggle"
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ InputHandler.ParseCommand()                           │
│ - Identifies "haggle" command                         │
│ - No arguments needed                                 │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ GameSessionService.HaggleWithMerchant()               │
│ - Gets current room                                   │
│ - Calls ShopService.FindMerchant(room)                │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ HaggleService.CanHaggle(player, merchant)             │
│ - Checks if player already has discount               │
│ - Checks remaining attempts                           │
│ - Checks cooldown timer                               │
└───────────────────────────────────────────────────────┘
        │
        ▼ (if can haggle)
┌───────────────────────────────────────────────────────┐
│ HaggleService.CalculateHaggleDC(merchant)             │
│ - Base DC: 12                                         │
│ - Attitude modifier (-2 to +5)                        │
│ - Transaction history bonus (-1 to -2)                │
│ - Minimum DC: 8                                       │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ DiceService.RollDice(2, 6)                            │
│ - Rolls 2d6                                           │
│ - Returns DiceRollResult with individual dice         │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ HaggleService.DetermineHaggleResult()                 │
│ - Total = Roll + Player.GetHaggleBonus()              │
│ - Compare to DC for success level                     │
│ - Record attempt on player and merchant               │
│ - Apply discount if successful                        │
│ - Worsen attitude if critical failure                 │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Renderer displays result:                             │
│                                                       │
│ [Haggle Check: DC 12]                                 │
│ Rolling 2d6 + Charisma (2)...                         │
│ Rolled: 6, 5 = 11 + 2 = 13                            │
│ Success!                                              │
│                                                       │
│ Grimbold nods reluctantly. "Alright, 10% off          │
│ my prices."                                           │
│                                                       │
│ [HAGGLE SUCCESS] 10% discount applied!                │
└───────────────────────────────────────────────────────┘
```

### 8.2 Price Calculation Flow

```
Buy/Sell Request
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService.GetBuyPrice(merchant, item, player)       │
│ - OR GetSellPrice()                                   │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ merchant.GetBuyPrice(item)                            │
│ - Returns: item.BasePrice × merchant.BuyMultiplier    │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService.CalculatePriceModifier(player, merchant)  │
│                                                       │
│ - Get player.Charisma                                 │
│ - Get reputation with merchant.FactionId              │
│ - Get merchant.Attitude                               │
│ - Get player.GetHaggleDiscount(merchant.Id)           │
│                                                       │
│ - Call PriceModifier.Calculate(...)                   │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ PriceModifier.Calculate()                             │
│                                                       │
│ CharismaModifier:                                     │
│   1.0 - ((14 - 10) × 0.02) = 0.92                     │
│                                                       │
│ ReputationModifier (Friendly):                        │
│   0.95                                                │
│                                                       │
│ AttitudeModifier (Neutral):                           │
│   1.00                                                │
│                                                       │
│ HaggleModifier (10% discount):                        │
│   0.90                                                │
│                                                       │
│ TotalMultiplier:                                      │
│   1.0 × 0.92 × 0.95 × 1.00 × 0.90 = 0.7866            │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ PriceModifier.ApplyToBuyPrice(basePrice)              │
│                                                       │
│ - BasePrice: 100                                      │
│ - Multiplied: 100 × 0.7866 = 78.66                    │
│ - Ceiling: 79 gold                                    │
│                                                       │
│ Final Buy Price: 79 gold                              │
└───────────────────────────────────────────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 New Commands

| Command | Description | Example |
|---------|-------------|---------|
| `haggle` | Attempt to negotiate better prices | `haggle` |

### 9.2 Command Output Examples

**Successful Haggle:**
```
> haggle
You try to negotiate a better deal with Grimbold.

[Haggle Check: DC 12]
Rolling 2d6 + Charisma (2)...
Rolled: 6, 5 = 11 + 2 = 13
Success!

Grimbold nods reluctantly. "Alright, 10% off my prices."

[HAGGLE SUCCESS] 10% discount applied to all purchases!

---

Current Prices (with 10% discount):
  Iron Sword .......... 45 gold (was 50)
  Leather Armor ....... 32 gold (was 35)
  Health Potion ....... 14 gold (was 15)
```

**Failed Haggle:**
```
> haggle
You try to negotiate a better deal with Grimbold.

[Haggle Check: DC 12]
Rolling 2d6 + Charisma (2)...
Rolled: 5, 4 = 9 + 2 = 11
Failed!

Grimbold frowns. "My prices are fair. Take it or leave it."
Attempts remaining: 2
```

**Critical Success:**
```
> haggle
You try to negotiate a better deal with Elara.

[Haggle Check: DC 10]
Rolling 2d6 + Charisma (3)...
Rolled: 6, 6 = 12 + 3 = 15
Critical Success!

Elara is impressed! "You drive a hard bargain. 20% off everything!"

[HAGGLE SUCCESS] 20% discount applied to all purchases!
```

**Critical Failure:**
```
> haggle
You try to negotiate a better deal with Grimbold.

[Haggle Check: DC 12]
Rolling 2d6 + Charisma (-1)...
Rolled: 1, 2 = 3 + (-1) = 2
Critical Failure!

Grimbold scowls. "You insult me with such offers!"

Grimbold's attitude has worsened.
No more haggle attempts today.
```

**No More Attempts:**
```
> haggle
Grimbold holds up a hand. "We're done negotiating. Buy something
or leave."

Haggle attempts will reset in 45 minutes.
```

**Already Has Discount:**
```
> haggle
You already have a 10% discount with Grimbold.
```

### 9.3 Price Display with Modifiers

**Talk Command with Prices:**
```
> talk grimbold
Grimbold looks up from his ledger. "Welcome back!"

FOR SALE:
  Iron Sword .......... 46 gold  (base 50, -8% charisma/rep)
  Leather Armor ....... 32 gold  (base 35, -8% charisma/rep)
  Health Potion ....... 14 gold  (base 15, -8% charisma/rep)
  Torch ............... 5 gold   (base 5, no discount)

Your gold: 127
Your modifiers: Charisma 14 (+4%), Reputation Friendly (+5%)

Type 'buy <item>' to purchase, 'sell <item>' to sell,
or 'haggle' to negotiate better prices.
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Haggle attempt | Information | `AttemptHaggle: Player {PlayerId} haggling with {MerchantName}` |
| Haggle roll | Debug | `Haggle roll: {RollTotal} + {Bonus} = {Total} vs DC {DC}` |
| Haggle success | Information | `Haggle {SuccessLevel}: {Discount}% discount achieved` |
| Haggle failure | Debug | `Haggle {FailureLevel}: No discount` |
| Price calculation | Debug | `GetBuyPrice: {Item} base {Base} × {Modifier} = {Final}` |
| Cannot haggle | Debug | `Player cannot haggle with this merchant` |
| Attitude changed | Information | `Merchant {MerchantId} attitude changed to {NewAttitude}` |

### 10.2 Structured Logging Fields

```csharp
// Haggle attempt log
_logger.LogInformation(
    "AttemptHaggle: Player {PlayerId} haggling with {MerchantName}",
    player.Id,      // Guid
    merchant.Name   // string
);

// Haggle result log
_logger.LogInformation(
    "Haggle {SuccessLevel}: {Discount}% discount achieved for player {PlayerId}",
    result.SuccessLevel,          // SuccessLevel
    result.DiscountPercent * 100, // decimal
    player.Id                     // Guid
);

// Price modifier log
_logger.LogDebug(
    "PriceModifier: Charisma={Charisma}, Rep={Rep}, Attitude={Att}, Haggle={Haggle}, Total={Total}",
    modifier.CharismaModifier,
    modifier.ReputationModifier,
    modifier.AttitudeModifier,
    modifier.HaggleModifier,
    modifier.TotalMultiplier
);
```

---

## 11. Unit Test Specifications

### 11.1 PriceModifier Tests (~10 tests)

```csharp
namespace RuneAndRust.Tests.Domain.ValueObjects;

[TestFixture]
public class PriceModifierTests
{
    [Test]
    public void Default_ReturnsAllOnesMultiplier()
    {
        // Act: Get PriceModifier.Default
        // Assert: All modifiers are 1.0, TotalMultiplier is 1.0
    }

    [Test]
    public void TotalMultiplier_MultipliesAllModifiers()
    {
        // Arrange: Set each modifier to different values
        // Act: Get TotalMultiplier
        // Assert: Returns product of all modifiers
    }

    [Test]
    public void Calculate_HighCharisma_ReducesPrice()
    {
        // Arrange: Charisma 15
        // Act: Call Calculate()
        // Assert: CharismaModifier is 0.90 (10% discount)
    }

    [Test]
    public void Calculate_LowCharisma_IncreasesPrice()
    {
        // Arrange: Charisma 6
        // Act: Call Calculate()
        // Assert: CharismaModifier is 1.08 (8% markup)
    }

    [Test]
    public void Calculate_ExaltedReputation_Returns20PercentDiscount()
    {
        // Arrange: ReputationLevel.Exalted
        // Act: Call Calculate()
        // Assert: ReputationModifier is 0.80
    }

    [Test]
    public void Calculate_HatedReputation_Returns50PercentMarkup()
    {
        // Arrange: ReputationLevel.Hated
        // Act: Call Calculate()
        // Assert: ReputationModifier is 1.50
    }

    [Test]
    public void Calculate_FriendlyAttitude_Returns5PercentDiscount()
    {
        // Arrange: NPCAttitude.Friendly
        // Act: Call Calculate()
        // Assert: AttitudeModifier is 0.95
    }

    [Test]
    public void ApplyToBuyPrice_RoundsUp()
    {
        // Arrange: BasePrice 100, TotalMultiplier 0.91
        // Act: Call ApplyToBuyPrice()
        // Assert: Returns 91 (ceiling of 91.0)
    }

    [Test]
    public void ApplyToSellPrice_InvertsModifierForPlayerBenefit()
    {
        // Arrange: BasePrice 100, TotalMultiplier 0.90
        // Act: Call ApplyToSellPrice()
        // Assert: Returns higher value (better for player)
    }

    [Test]
    public void ApplyToSellPrice_ClampsToValidRange()
    {
        // Arrange: Extreme modifier values
        // Act: Call ApplyToSellPrice()
        // Assert: Result within 0.5-1.5 range
    }
}
```

### 11.2 HaggleResult Tests (~5 tests)

```csharp
namespace RuneAndRust.Tests.Domain.ValueObjects;

[TestFixture]
public class HaggleResultTests
{
    [Test]
    public void Success_SetsIsSuccessTrue()
    {
        // Act: Call HaggleResult.Success()
        // Assert: IsSuccess is true
    }

    [Test]
    public void Success_SetsDiscountPercent()
    {
        // Arrange: Discount 0.10
        // Act: Call HaggleResult.Success()
        // Assert: DiscountPercent is 0.10
    }

    [Test]
    public void Failure_SetsIsSuccessFalse()
    {
        // Act: Call HaggleResult.Failure()
        // Assert: IsSuccess is false
    }

    [Test]
    public void Failure_SetsZeroDiscount()
    {
        // Act: Call HaggleResult.Failure()
        // Assert: DiscountPercent is 0
    }

    [Test]
    public void Failure_WithAttitudeChange_SetsNewAttitude()
    {
        // Arrange: attitudeChanged true, newAttitude Wary
        // Act: Call HaggleResult.Failure()
        // Assert: AttitudeChanged is true, NewAttitude is Wary
    }
}
```

### 11.3 HaggleService Tests (~10 tests)

```csharp
namespace RuneAndRust.Tests.Application.Services;

[TestFixture]
public class HaggleServiceTests
{
    [Test]
    public void AttemptHaggle_WhenCannotHaggle_ReturnsFailure()
    {
        // Arrange: Player already has discount
        // Act: Call AttemptHaggle()
        // Assert: Returns failure with appropriate message
    }

    [Test]
    public void AttemptHaggle_RollBeatsD_ReturnsSuccess()
    {
        // Arrange: Mock dice to return high roll
        // Act: Call AttemptHaggle()
        // Assert: Returns success with 10% discount
    }

    [Test]
    public void AttemptHaggle_CriticalSuccess_Returns20PercentDiscount()
    {
        // Arrange: Mock dice to beat DC by 5+
        // Act: Call AttemptHaggle()
        // Assert: DiscountPercent is 0.20
    }

    [Test]
    public void AttemptHaggle_CriticalFailure_WorsensAttitude()
    {
        // Arrange: Mock dice to fail badly, Merchant is Neutral
        // Act: Call AttemptHaggle()
        // Assert: NewAttitude is Wary
    }

    [Test]
    public void CanHaggle_WhenHasDiscount_ReturnsFalse()
    {
        // Arrange: Player has existing discount
        // Act: Call CanHaggle()
        // Assert: Returns false
    }

    [Test]
    public void CanHaggle_WhenNoAttemptsRemaining_ReturnsFalse()
    {
        // Arrange: Player has used all attempts
        // Act: Call CanHaggle()
        // Assert: Returns false
    }

    [Test]
    public void GetRemainingAttempts_ReturnsCorrectCount()
    {
        // Arrange: Max 3, used 1
        // Act: Call GetRemainingAttempts()
        // Assert: Returns 2
    }

    [Test]
    public void CalculateHaggleDC_FriendlyAttitude_LowersDC()
    {
        // Arrange: Merchant with Friendly attitude
        // Act: Call CalculateHaggleDC()
        // Assert: DC is 10 (12 - 2)
    }

    [Test]
    public void CalculateHaggleDC_HostileAttitude_RaisesDC()
    {
        // Arrange: Merchant with Hostile attitude
        // Act: Call CalculateHaggleDC()
        // Assert: DC is 17 (12 + 5)
    }

    [Test]
    public void CalculateHaggleDC_HighTransactionCount_LowersDC()
    {
        // Arrange: Merchant with 15 transactions
        // Act: Call CalculateHaggleDC()
        // Assert: DC is 10 (12 - 2)
    }
}
```

### 11.4 Player Haggle Method Tests (~5 tests)

```csharp
namespace RuneAndRust.Tests.Domain.Entities;

[TestFixture]
public class PlayerHaggleTests
{
    [Test]
    public void GetHaggleBonus_HighCharisma_ReturnsPositive()
    {
        // Arrange: Player with Charisma 16
        // Act: Call GetHaggleBonus()
        // Assert: Returns 3 ((16-10)/2)
    }

    [Test]
    public void GetHaggleBonus_LowCharisma_ReturnsNegative()
    {
        // Arrange: Player with Charisma 6
        // Act: Call GetHaggleBonus()
        // Assert: Returns -2 ((6-10)/2)
    }

    [Test]
    public void RecordHaggleAttempt_IncrementsCount()
    {
        // Arrange: Fresh player
        // Act: Call RecordHaggleAttempt() twice
        // Assert: GetHaggleAttemptCount() returns 2
    }

    [Test]
    public void SetHaggleDiscount_StoresDiscount()
    {
        // Arrange: Player, merchant ID
        // Act: Call SetHaggleDiscount(merchantId, 0.15)
        // Assert: GetHaggleDiscount(merchantId) returns 0.15
    }

    [Test]
    public void HasHaggleDiscount_WhenSet_ReturnsTrue()
    {
        // Arrange: Player with discount set
        // Act: Call HasHaggleDiscount()
        // Assert: Returns true
    }
}
```

---

## 12. Use Cases

### UC-2.2b-1: Player Haggles Successfully

**Primary Actor:** Player
**Preconditions:** Player in room with merchant, has haggle attempts remaining
**Postconditions:** Discount applied to all purchases from this merchant

**Main Flow:**
1. Player enters `haggle` command
2. System finds merchant in current room
3. System validates player can haggle (has attempts, no existing discount)
4. System calculates haggle DC based on merchant attitude and history
5. System rolls 2d6 + player's charisma bonus
6. Roll meets or exceeds DC
7. System applies discount (5-20% based on success level)
8. System stores discount for player with this merchant
9. System displays success message with discount

**Alternative Flows:**
- 2a. No merchant in room → Display error
- 3a. No attempts remaining → Display cooldown message
- 3b. Already has discount → Display existing discount
- 6a. Roll fails by small margin → Display failure, decrement attempts
- 6b. Roll fails by large margin → Worsen attitude, no more attempts

### UC-2.2b-2: Prices Reflect Charisma

**Primary Actor:** Player
**Preconditions:** Player has Charisma stat set
**Postconditions:** Prices adjusted based on Charisma

**Main Flow:**
1. Player views merchant inventory (via `talk`)
2. System retrieves player's Charisma stat
3. System calculates charisma modifier (2% per point from 10)
4. System applies modifier to all displayed prices
5. System shows base price and modified price

### UC-2.2b-3: Reputation Affects Prices

**Primary Actor:** Player
**Preconditions:** Player has reputation with merchant's faction
**Postconditions:** Prices reflect reputation level

**Main Flow:**
1. Player interacts with merchant
2. System retrieves player's reputation with merchant's faction
3. System calculates reputation modifier (Exalted=0.80 to Hated=1.50)
4. System applies modifier to prices
5. Buy prices reduced for good reputation
6. Sell prices increased for good reputation

---

## 13. Acceptance Criteria

### AC-2.2b-1: Price Modifier Value Object
- [ ] PriceModifier calculates combined multiplier from all factors
- [ ] Charisma modifier: 2% per point above/below 10
- [ ] Reputation modifier: 0.80 (Exalted) to 1.50 (Hated)
- [ ] Attitude modifier: 0.95 (Friendly) to 1.20 (Hostile)
- [ ] Haggle modifier applied when discount exists
- [ ] ApplyToBuyPrice rounds up (ceiling)
- [ ] ApplyToSellPrice inverts modifier for player benefit

### AC-2.2b-2: Haggle Command
- [ ] `haggle` command initiates negotiation
- [ ] Command only works when merchant in room
- [ ] Command blocked if player has existing discount
- [ ] Command blocked if no attempts remaining
- [ ] Displays remaining attempts after failure

### AC-2.2b-3: Haggle Mechanics
- [ ] Haggle uses 2d6 + Charisma bonus roll
- [ ] Base DC is 12, modified by attitude (-2 to +5)
- [ ] Transaction history provides bonus (-1 to -2)
- [ ] Minimum DC is 8
- [ ] Critical success (DC+5): 20% discount
- [ ] Success (DC): 10% discount
- [ ] Partial success (DC-3): 5% discount
- [ ] Failure: No discount, uses attempt
- [ ] Critical failure: No discount, attitude worsens

### AC-2.2b-4: Player Updates
- [ ] Player has Charisma stat (default 10)
- [ ] Player tracks haggle attempts per merchant
- [ ] Player stores haggle discounts per merchant
- [ ] GetHaggleBonus returns (Charisma-10)/2

### AC-2.2b-5: Merchant Updates
- [ ] Merchant has MaxHaggleAttempts (default 3)
- [ ] Merchant has HaggleCooldownMinutes (default 60)
- [ ] Merchant tracks last haggle attempt per player
- [ ] CanPlayerHaggle respects attempts and cooldown

### AC-2.2b-6: Integration
- [ ] ShopService uses PriceModifier for buy prices
- [ ] ShopService uses PriceModifier for sell prices
- [ ] Talk command shows modified prices
- [ ] Transaction confirmation shows final prices

### AC-2.2b-7: Tests
- [ ] ~30 unit tests implemented and passing
- [ ] PriceModifier tests cover all modifiers
- [ ] HaggleResult tests cover success/failure
- [ ] HaggleService tests cover all outcomes
- [ ] Player haggle method tests pass

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `PriceModifier.cs` - Price modifier value object
- [ ] `HaggleResult.cs` - Haggle result value object
- [ ] `HaggleAttempt.cs` - Haggle attempt value object
- [ ] Update `Player.cs` - Add Charisma, haggle tracking methods
- [ ] Update `Merchant.cs` - Add haggle settings and tracking

### Application Layer
- [ ] `IHaggleService.cs` - Haggle service interface
- [ ] `HaggleService.cs` - Haggle service implementation
- [ ] Update `IShopService.cs` - Add price modifier methods
- [ ] Update `ShopService.cs` - Integrate price modifiers
- [ ] Update `GameSessionService.cs` - Add haggle command handling

### Infrastructure Layer
- [ ] Update merchant configuration loader for haggle settings

### Presentation Layer
- [ ] `HaggleHandler.cs` - Haggle command handler
- [ ] Update `InputHandler.cs` - Parse haggle command
- [ ] Update renderer for haggle output and price display

### Configuration
- [ ] Update `config/merchants.json` - Add haggle settings
- [ ] `config/schemas/haggle-settings.schema.json` - Schema for validation
- [ ] `config/haggle-messages.json` - Flavor messages (optional)

### Tests
- [ ] `PriceModifierTests.cs` - Price modifier tests (~10)
- [ ] `HaggleResultTests.cs` - Haggle result tests (~5)
- [ ] `HaggleServiceTests.cs` - Service tests (~10)
- [ ] `PlayerHaggleTests.cs` - Player method tests (~5)

---

## 15. Dependencies

### Internal Dependencies (from v0.2.2a)

| Dependency | Location | Usage |
|------------|----------|-------|
| Merchant entity | `Domain/Entities/Merchant.cs` | Extends with haggle tracking |
| Player entity | `Domain/Entities/Player.cs` | Adds Charisma, haggle methods |
| ShopService | `Application/Services/ShopService.cs` | Integrates price modifiers |
| NPCAttitude enum | `Domain/Enums/NPCAttitude.cs` | Attitude-based pricing |
| TransactionResult | `Domain/ValueObjects/TransactionResult.cs` | Transaction outcomes |

### Internal Dependencies (from v0.2.0)

| Dependency | Location | Usage |
|------------|----------|-------|
| ReputationLevel enum | `Domain/Enums/ReputationLevel.cs` | Reputation-based pricing |
| IReputationService | `Application/Interfaces/IReputationService.cs` | Get player reputation |
| FactionDefinition | `Domain/Definitions/FactionDefinition.cs` | Merchant faction |

### Internal Dependencies (from v0.0.5)

| Dependency | Location | Usage |
|------------|----------|-------|
| IDiceService | `Application/Interfaces/IDiceService.cs` | Dice rolling |
| DiceRollResult | `Domain/ValueObjects/DiceRollResult.cs` | Roll results |
| SuccessLevel enum | `Domain/Enums/SuccessLevel.cs` | Success determination |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Microsoft.Extensions.Logging | 8.0.0+ | Logging |

---

## 16. Future Considerations

### v0.2.2c: Shop UI & Specialty Merchants
- TUI shop interface with navigation
- Item comparison display (equipped vs shop item)
- `appraise` command for detailed value breakdown
- MerchantType enum for specializations
- Inventory refresh mechanics

### v0.3.0: Quest System Integration
- Quest rewards may include reputation bonuses
- Merchants as quest givers
- Reputation gains from completed quests

### v0.4.0: Character Advancement
- Charisma can be improved through leveling
- Haggling skill or feat for better outcomes
- Social skill checks using similar mechanics

### Deferred Features (Not in v0.2.2b Scope)
- **Haggle mini-game**: Interactive negotiation beyond dice rolls
- **Counter-offers**: Merchant proposes alternative deals
- **Relationship persistence**: Long-term merchant relationships
- **Barter system**: Trade items directly without gold

---

*This design specification provides the complete Dynamic Pricing & Haggling system (v0.2.2b). It builds upon the Shop Foundation (v0.2.2a) by adding price modifiers based on player attributes and a dice-based haggling system for negotiating better deals.*
