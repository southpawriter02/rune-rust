# v0.18.0e Design Specification: Configuration & Schema

**Version:** 0.18.0e
**Parent:** v0.18.0 (Psychic Stress System)
**Prerequisites:** v0.18.0a (Stress Enums & State)
**Status:** Design Complete
**Estimated Unit Tests:** ~3

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [JSON Schema Definition](#5-json-schema-definition)
6. [Configuration File](#6-configuration-file)
7. [DTO Definition](#7-dto-definition)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

This design specification defines the JSON configuration infrastructure for the Psychic Stress system, including schema validation, stress source definitions, recovery rates, and trauma reset values.

v0.18.0e establishes the **data-driven foundation** that allows game designers to:

- Define stress-inducing events without code changes
- Configure recovery formulas per rest type
- Customize trauma check reset behavior

### Key Deliverables

| Category                | Items                                                                   |
| ----------------------- | ----------------------------------------------------------------------- |
| **Configuration Files** | `config/stress-sources.json`                                            |
| **JSON Schemas**        | `config/schemas/stress-sources.schema.json`                             |
| **Application DTOs**    | `StressSourceDefinition`, `StressRecoveryConfig`, `StressConfiguration` |
| **Tests**               | ~3 schema validation tests                                              |

### Configuration Summary

| Config Section     | Purpose                                           |
| ------------------ | ------------------------------------------------- |
| `stressSources`    | Categorized stress events with base stress and DC |
| `recoveryRates`    | Formula definitions for each `RestType`           |
| `traumaCheckReset` | Reset values for passed/failed trauma checks      |

---

## 2. Feature Overview

```
v0.18.0e Features
└── Stress Configuration System
    │
    ├── JSON SCHEMA (stress-sources.schema.json)
    │   ├── StressSourceDefinition — id, baseStress, resistDc, description
    │   ├── RecoveryRate — formula (WILL multiplier or fixed)
    │   └── TraumaCheckReset — passed, failed values
    │
    ├── CONFIGURATION FILE (stress-sources.json)
    │   ├── stressSources
    │   │   ├── combat[] — Fear aura, overwhelming force, etc.
    │   │   ├── exploration[] — Darkness, isolation, etc.
    │   │   ├── narrative[] — Betrayal, loss, etc.
    │   │   ├── heretical[] — Forbidden knowledge, corruption, etc.
    │   │   ├── environmental[] — Extreme weather, hazards, etc.
    │   │   └── corruption[] — Blight exposure, mutations, etc.
    │   ├── recoveryRates
    │   │   ├── shortRest — "WILL × 2"
    │   │   ├── longRest — "WILL × 5"
    │   │   ├── sanctuary — "FULL_RESET"
    │   │   └── milestone — "25"
    │   └── traumaCheckReset
    │       ├── passed — 75
    │       └── failed — 50
    │
    └── DTOs (Application Layer)
        ├── StressSourceDefinition
        ├── StressRecoveryConfig
        └── StressConfiguration
```

---

## 3. Architecture Diagrams

### 3.1 Configuration Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CONFIG LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              config/schemas/stress-sources.schema.json           │   │
│  │              (JSON Schema Draft-07)                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │ validates                              │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  config/stress-sources.json                      │   │
│  │                  (Game Configuration)                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
└───────────────────────────────┼─────────────────────────────────────────┘
                                │
                                │ loads via IConfigurationProvider
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    StressConfiguration                           │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  + StressSources: Dictionary<string, StressSourceDefinition[]>  │   │
│  │  + RecoveryRates: StressRecoveryConfig                          │   │
│  │  + TraumaCheckReset: TraumaResetConfig                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
│                               │ used by                                 │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      StressService                               │   │
│  │  (Configuration-aware stress operations)                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Schema Structure Diagram

```
stress-sources.schema.json
│
├── $schema: "http://json-schema.org/draft-07/schema#"
├── $id: "stress-sources.schema.json"
├── title: "Stress Sources Configuration"
│
├── properties
│   │
│   ├── $schema (string)
│   ├── version (string, pattern: "^\d+\.\d+$")
│   │
│   ├── stressSources (object)
│   │   ├── combat: StressSourceDefinition[]
│   │   ├── exploration: StressSourceDefinition[]
│   │   ├── narrative: StressSourceDefinition[]
│   │   ├── heretical: StressSourceDefinition[]
│   │   ├── environmental: StressSourceDefinition[]
│   │   └── corruption: StressSourceDefinition[]
│   │
│   ├── recoveryRates (RecoveryRatesConfig)
│   │   ├── shortRest: RecoveryRate
│   │   ├── longRest: RecoveryRate
│   │   ├── sanctuary: RecoveryRate
│   │   └── milestone: RecoveryRate
│   │
│   └── traumaCheckReset (TraumaResetConfig)
│       ├── passed (integer, 0-100)
│       └── failed (integer, 0-100)
│
└── definitions
    │
    ├── StressSourceDefinition
    │   ├── id (string, pattern: "^[a-z][a-z0-9-]*$")
    │   ├── baseStress (integer, 1-100)
    │   ├── resistDc (integer, 0-10)
    │   └── description (string, optional)
    │
    └── RecoveryRate
        └── formula (string)
```

### 3.3 Stress Source Categories

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      STRESS SOURCE CATEGORIES                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  COMBAT                     EXPLORATION             NARRATIVE           │
│  ┌───────────────────┐      ┌─────────────────┐     ┌────────────────┐ │
│  │ enemy-fear-aura   │      │ darkness-alone  │     │ ally-betrayal  │ │
│  │ overwhelming-odds │      │ strange-sounds  │     │ loved-one-death│ │
│  │ ally-down         │      │ corpse-discovery│     │ moral-dilemma  │ │
│  │ near-death        │      │ architecture-   │     │ secret-revealed│ │
│  │                   │      │   impossible    │     │                │ │
│  └───────────────────┘      └─────────────────┘     └────────────────┘ │
│                                                                         │
│  HERETICAL                  ENVIRONMENTAL           CORRUPTION          │
│  ┌───────────────────┐      ┌─────────────────┐     ┌────────────────┐ │
│  │ forbidden-text    │      │ extreme-cold    │     │ blight-exposure│ │
│  │ eldritch-symbol   │      │ toxic-air       │     │ corruption-     │ │
│  │ void-whispers     │      │ unstable-ground │     │   touch        │ │
│  │ reality-tear      │      │ lightning-storm │     │ mutation-pain  │ │
│  │                   │      │                 │     │                │ │
│  └───────────────────┘      └─────────────────┘     └────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18e-1: Define Stress Events

**As a** game designer
**I want to** define stress-inducing events in configuration
**So that** I can balance stress sources without code changes

**Acceptance Criteria:**

- Each stress source has ID, base stress, and resist DC
- Sources are categorized by StressSource enum values
- Schema validates all required fields

### US-18e-2: Configure Recovery Rates

**As a** game designer
**I want to** configure recovery formulas per rest type
**So that** I can tune the stress-rest equation balance

**Acceptance Criteria:**

- Formula supports WILL multipliers and fixed values
- All four rest types are configurable
- Schema validates formula format

### US-18e-3: Validate Configuration

**As a** developer
**I want to** validate stress configuration at startup
**So that** invalid configuration is caught early

**Acceptance Criteria:**

- Schema rejects invalid baseStress (< 1 or > 100)
- Schema rejects invalid resistDc (< 0 or > 10)
- Schema enforces kebab-case for IDs

---

## 5. JSON Schema Definition

### 5.1 Schema File

**File:** `config/schemas/stress-sources.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "stress-sources.schema.json",
    "title": "Stress Sources Configuration",
    "description": "Configuration schema for Psychic Stress sources, recovery rates, and trauma reset values.",
    "type": "object",
    "required": [
        "version",
        "stressSources",
        "recoveryRates",
        "traumaCheckReset"
    ],
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to this schema file."
        },
        "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+$",
            "description": "Configuration version in MAJOR.MINOR format."
        },
        "stressSources": {
            "type": "object",
            "description": "Stress sources organized by category.",
            "properties": {
                "combat": {
                    "type": "array",
                    "description": "Stress sources from combat encounters.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                },
                "exploration": {
                    "type": "array",
                    "description": "Stress sources from exploration and discovery.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                },
                "narrative": {
                    "type": "array",
                    "description": "Stress sources from story events and dialogue.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                },
                "heretical": {
                    "type": "array",
                    "description": "Stress sources from forbidden knowledge and eldritch encounters.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                },
                "environmental": {
                    "type": "array",
                    "description": "Stress sources from environmental hazards.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                },
                "corruption": {
                    "type": "array",
                    "description": "Stress sources from Runic Blight and corruption.",
                    "items": { "$ref": "#/definitions/StressSourceDefinition" }
                }
            },
            "additionalProperties": false
        },
        "recoveryRates": {
            "type": "object",
            "description": "Recovery formulas for each rest type.",
            "required": ["shortRest", "longRest", "sanctuary", "milestone"],
            "properties": {
                "shortRest": { "$ref": "#/definitions/RecoveryRate" },
                "longRest": { "$ref": "#/definitions/RecoveryRate" },
                "sanctuary": { "$ref": "#/definitions/RecoveryRate" },
                "milestone": { "$ref": "#/definitions/RecoveryRate" }
            },
            "additionalProperties": false
        },
        "traumaCheckReset": {
            "type": "object",
            "description": "Stress reset values after trauma check resolution.",
            "required": ["passed", "failed"],
            "properties": {
                "passed": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Stress value after passing a Trauma Check."
                },
                "failed": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Stress value after failing a Trauma Check."
                }
            },
            "additionalProperties": false
        }
    },
    "additionalProperties": false,
    "definitions": {
        "StressSourceDefinition": {
            "type": "object",
            "description": "Definition of a single stress-inducing event.",
            "required": ["id", "baseStress", "resistDc"],
            "properties": {
                "id": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "description": "Unique identifier in kebab-case format."
                },
                "baseStress": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 100,
                    "description": "Base stress amount before resistance."
                },
                "resistDc": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 10,
                    "description": "Difficulty class for WILL resistance check. 0 means no resistance allowed."
                },
                "description": {
                    "type": "string",
                    "description": "Optional narrative description of the stress source."
                }
            },
            "additionalProperties": false
        },
        "RecoveryRate": {
            "type": "object",
            "description": "Recovery formula configuration.",
            "required": ["formula"],
            "properties": {
                "formula": {
                    "type": "string",
                    "description": "Recovery formula. Supports 'WILL × N', 'FULL_RESET', or fixed integer as string."
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 6. Configuration File

### 6.1 Configuration File

**File:** `config/stress-sources.json`

```json
{
    "$schema": "./schemas/stress-sources.schema.json",
    "version": "1.0",
    "stressSources": {
        "combat": [
            {
                "id": "enemy-fear-aura",
                "baseStress": 15,
                "resistDc": 2,
                "description": "An enemy's terrifying presence radiates fear."
            },
            {
                "id": "overwhelming-odds",
                "baseStress": 10,
                "resistDc": 1,
                "description": "Facing vastly superior enemy numbers."
            },
            {
                "id": "ally-down",
                "baseStress": 20,
                "resistDc": 2,
                "description": "Witnessing an ally fall in combat."
            },
            {
                "id": "near-death-experience",
                "baseStress": 25,
                "resistDc": 3,
                "description": "Being reduced to critical health."
            }
        ],
        "exploration": [
            {
                "id": "darkness-isolation",
                "baseStress": 8,
                "resistDc": 1,
                "description": "Alone in complete darkness."
            },
            {
                "id": "strange-sounds",
                "baseStress": 5,
                "resistDc": 1,
                "description": "Unexplained sounds in the distance."
            },
            {
                "id": "corpse-discovery",
                "baseStress": 12,
                "resistDc": 2,
                "description": "Finding remains of previous explorers."
            },
            {
                "id": "impossible-architecture",
                "baseStress": 15,
                "resistDc": 2,
                "description": "Geometry that defies natural law."
            }
        ],
        "narrative": [
            {
                "id": "ally-betrayal",
                "baseStress": 30,
                "resistDc": 3,
                "description": "A trusted ally reveals their treachery."
            },
            {
                "id": "loved-one-death",
                "baseStress": 40,
                "resistDc": 4,
                "description": "Learning of the death of someone dear."
            },
            {
                "id": "moral-dilemma",
                "baseStress": 15,
                "resistDc": 2,
                "description": "Forced to make an impossible choice."
            },
            {
                "id": "dark-secret-revealed",
                "baseStress": 20,
                "resistDc": 2,
                "description": "Learning a terrible truth about oneself."
            }
        ],
        "heretical": [
            {
                "id": "forbidden-text",
                "baseStress": 25,
                "resistDc": 3,
                "description": "Reading prohibited knowledge."
            },
            {
                "id": "eldritch-symbol",
                "baseStress": 20,
                "resistDc": 2,
                "description": "Seeing a symbol that burns the mind."
            },
            {
                "id": "void-whispers",
                "baseStress": 30,
                "resistDc": 3,
                "description": "Hearing voices from beyond reality."
            },
            {
                "id": "reality-tear",
                "baseStress": 35,
                "resistDc": 4,
                "description": "Witnessing a breach in the fabric of existence."
            }
        ],
        "environmental": [
            {
                "id": "extreme-cold",
                "baseStress": 10,
                "resistDc": 1,
                "description": "Exposure to life-threatening cold."
            },
            {
                "id": "toxic-atmosphere",
                "baseStress": 15,
                "resistDc": 2,
                "description": "Breathing poisoned air."
            },
            {
                "id": "unstable-ground",
                "baseStress": 12,
                "resistDc": 1,
                "description": "Floor crumbling underfoot."
            },
            {
                "id": "lightning-storm",
                "baseStress": 8,
                "resistDc": 1,
                "description": "Caught in a violent electrical storm."
            }
        ],
        "corruption": [
            {
                "id": "blight-exposure",
                "baseStress": 20,
                "resistDc": 2,
                "description": "Direct contact with Runic Blight."
            },
            {
                "id": "corruption-touch",
                "baseStress": 25,
                "resistDc": 3,
                "description": "Being touched by a corrupted entity."
            },
            {
                "id": "mutation-pain",
                "baseStress": 30,
                "resistDc": 3,
                "description": "Experiencing corruption-induced mutations."
            },
            {
                "id": "blight-resonance",
                "baseStress": 15,
                "resistDc": 2,
                "description": "Feeling the Blight's influence on the mind."
            }
        ]
    },
    "recoveryRates": {
        "shortRest": {
            "formula": "WILL × 2"
        },
        "longRest": {
            "formula": "WILL × 5"
        },
        "sanctuary": {
            "formula": "FULL_RESET"
        },
        "milestone": {
            "formula": "25"
        }
    },
    "traumaCheckReset": {
        "passed": 75,
        "failed": 50
    }
}
```

---

## 7. DTO Definition

### 7.1 StressSourceDefinition

**File:** `src/Core/RuneAndRust.Application/DTOs/StressSourceDefinitionDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

using System.Text.Json.Serialization;

/// <summary>
/// DTO representing a single stress-inducing event from configuration.
/// </summary>
/// <remarks>
/// Loaded from <c>config/stress-sources.json</c> and used to
/// apply consistent stress amounts across the game.
/// </remarks>
public sealed record StressSourceDefinitionDto
{
    /// <summary>
    /// Gets the unique identifier for this stress source.
    /// </summary>
    /// <remarks>
    /// Must be in kebab-case format (e.g., "enemy-fear-aura").
    /// </remarks>
    [JsonPropertyName("id")]
    public required string Id { get; init; }

    /// <summary>
    /// Gets the base stress amount before any resistance.
    /// </summary>
    /// <remarks>
    /// Valid range: 1-100. Higher values indicate more severe stressors.
    /// </remarks>
    [JsonPropertyName("baseStress")]
    public required int BaseStress { get; init; }

    /// <summary>
    /// Gets the difficulty class for WILL-based resistance checks.
    /// </summary>
    /// <remarks>
    /// Valid range: 0-10. A value of 0 means no resistance check is allowed.
    /// </remarks>
    [JsonPropertyName("resistDc")]
    public required int ResistDc { get; init; }

    /// <summary>
    /// Gets the optional narrative description of this stress source.
    /// </summary>
    [JsonPropertyName("description")]
    public string? Description { get; init; }
}
```

### 7.2 StressRecoveryConfig

**File:** `src/Core/RuneAndRust.Application/DTOs/StressRecoveryConfigDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

using System.Text.Json.Serialization;

/// <summary>
/// DTO representing recovery rate configuration for all rest types.
/// </summary>
public sealed record StressRecoveryConfigDto
{
    /// <summary>
    /// Gets the recovery configuration for Short Rest.
    /// </summary>
    [JsonPropertyName("shortRest")]
    public required RecoveryRateDto ShortRest { get; init; }

    /// <summary>
    /// Gets the recovery configuration for Long Rest.
    /// </summary>
    [JsonPropertyName("longRest")]
    public required RecoveryRateDto LongRest { get; init; }

    /// <summary>
    /// Gets the recovery configuration for Sanctuary Rest.
    /// </summary>
    [JsonPropertyName("sanctuary")]
    public required RecoveryRateDto Sanctuary { get; init; }

    /// <summary>
    /// Gets the recovery configuration for Milestone Recovery.
    /// </summary>
    [JsonPropertyName("milestone")]
    public required RecoveryRateDto Milestone { get; init; }
}

/// <summary>
/// DTO representing a single recovery rate formula.
/// </summary>
public sealed record RecoveryRateDto
{
    /// <summary>
    /// Gets the recovery formula string.
    /// </summary>
    /// <remarks>
    /// Supported formats:
    /// <list type="bullet">
    /// <item>"WILL × N" — WILL multiplied by N</item>
    /// <item>"FULL_RESET" — Reset to 0</item>
    /// <item>"N" — Fixed amount N</item>
    /// </list>
    /// </remarks>
    [JsonPropertyName("formula")]
    public required string Formula { get; init; }
}
```

### 7.3 StressConfiguration

**File:** `src/Core/RuneAndRust.Application/DTOs/StressConfigurationDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

using System.Text.Json.Serialization;

/// <summary>
/// Root DTO for the complete stress configuration.
/// </summary>
/// <remarks>
/// Loaded from <c>config/stress-sources.json</c>.
/// </remarks>
public sealed record StressConfigurationDto
{
    /// <summary>
    /// Gets the configuration version.
    /// </summary>
    [JsonPropertyName("version")]
    public required string Version { get; init; }

    /// <summary>
    /// Gets the stress sources organized by category.
    /// </summary>
    [JsonPropertyName("stressSources")]
    public required StressSourcesDto StressSources { get; init; }

    /// <summary>
    /// Gets the recovery rate configuration.
    /// </summary>
    [JsonPropertyName("recoveryRates")]
    public required StressRecoveryConfigDto RecoveryRates { get; init; }

    /// <summary>
    /// Gets the trauma check reset configuration.
    /// </summary>
    [JsonPropertyName("traumaCheckReset")]
    public required TraumaResetConfigDto TraumaCheckReset { get; init; }
}

/// <summary>
/// DTO for stress sources organized by category.
/// </summary>
public sealed record StressSourcesDto
{
    /// <summary>Combat-related stress sources.</summary>
    [JsonPropertyName("combat")]
    public StressSourceDefinitionDto[] Combat { get; init; } = [];

    /// <summary>Exploration-related stress sources.</summary>
    [JsonPropertyName("exploration")]
    public StressSourceDefinitionDto[] Exploration { get; init; } = [];

    /// <summary>Narrative/story-related stress sources.</summary>
    [JsonPropertyName("narrative")]
    public StressSourceDefinitionDto[] Narrative { get; init; } = [];

    /// <summary>Heretical/forbidden knowledge stress sources.</summary>
    [JsonPropertyName("heretical")]
    public StressSourceDefinitionDto[] Heretical { get; init; } = [];

    /// <summary>Environmental hazard stress sources.</summary>
    [JsonPropertyName("environmental")]
    public StressSourceDefinitionDto[] Environmental { get; init; } = [];

    /// <summary>Corruption/Blight stress sources.</summary>
    [JsonPropertyName("corruption")]
    public StressSourceDefinitionDto[] Corruption { get; init; } = [];
}

/// <summary>
/// DTO for trauma check reset values.
/// </summary>
public sealed record TraumaResetConfigDto
{
    /// <summary>
    /// Gets the stress value after passing a Trauma Check.
    /// </summary>
    [JsonPropertyName("passed")]
    public required int Passed { get; init; }

    /// <summary>
    /// Gets the stress value after failing a Trauma Check.
    /// </summary>
    [JsonPropertyName("failed")]
    public required int Failed { get; init; }
}
```

---

## 8. Logging Specifications

### 8.1 Configuration Loading Logs

| Event            | Level       | Template                                                                  |
| ---------------- | ----------- | ------------------------------------------------------------------------- |
| Config Loaded    | Information | `"Stress configuration loaded: {SourceCount} sources, version {Version}"` |
| Category Loaded  | Debug       | `"Loaded {Count} stress sources for category {Category}"`                 |
| Validation Error | Error       | `"Stress configuration validation failed: {Error}"`                       |
| Source Lookup    | Debug       | `"Looking up stress source '{SourceId}' in category '{Category}'"`        |
| Source Not Found | Warning     | `"Stress source '{SourceId}' not found in category '{Category}'"`         |

### 8.2 Example Log Output

```
[10:00:01 INF] Stress configuration loaded: 24 sources, version 1.0
[10:00:01 DBG] Loaded 4 stress sources for category Combat
[10:00:01 DBG] Loaded 4 stress sources for category Exploration
[10:00:01 DBG] Loaded 4 stress sources for category Narrative
[10:00:01 DBG] Loaded 4 stress sources for category Heretical
[10:00:01 DBG] Loaded 4 stress sources for category Environmental
[10:00:01 DBG] Loaded 4 stress sources for category Corruption
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature             | Test Count |
| ------------------- | ---------- |
| Schema Validation   | ~2         |
| DTO Deserialization | ~1         |
| **Total**           | **~3**     |

### 9.2 StressSourcesSchemaTests

**File:** `tests/RuneAndRust.Application.UnitTests/Schemas/StressSourcesSchemaTests.cs`

```csharp
namespace RuneAndRust.Application.UnitTests.Schemas;

using FluentAssertions;
using NUnit.Framework;
using Json.Schema;
using System.Text.Json;

[TestFixture]
public class StressSourcesSchemaTests
{
    private JsonSchema _schema = null!;

    [OneTimeSetUp]
    public void Setup()
    {
        var schemaPath = Path.Combine(
            TestContext.CurrentContext.TestDirectory,
            "..", "..", "..", "..", "..",
            "config", "schemas", "stress-sources.schema.json");

        var schemaJson = File.ReadAllText(schemaPath);
        _schema = JsonSchema.FromText(schemaJson);
    }

    [Test]
    public void Schema_ValidatesCorrectConfiguration()
    {
        // Arrange
        var configPath = Path.Combine(
            TestContext.CurrentContext.TestDirectory,
            "..", "..", "..", "..", "..",
            "config", "stress-sources.json");

        var configJson = File.ReadAllText(configPath);
        using var doc = JsonDocument.Parse(configJson);

        // Act
        var result = _schema.Evaluate(doc.RootElement);

        // Assert
        result.IsValid.Should().BeTrue(
            because: "the configuration file should validate against the schema");
    }

    [Test]
    public void Schema_RejectsInvalidBaseStress()
    {
        // Arrange
        var invalidConfig = """
        {
          "version": "1.0",
          "stressSources": {
            "combat": [
              { "id": "test", "baseStress": 150, "resistDc": 2 }
            ]
          },
          "recoveryRates": {
            "shortRest": { "formula": "WILL × 2" },
            "longRest": { "formula": "WILL × 5" },
            "sanctuary": { "formula": "FULL_RESET" },
            "milestone": { "formula": "25" }
          },
          "traumaCheckReset": { "passed": 75, "failed": 50 }
        }
        """;

        using var doc = JsonDocument.Parse(invalidConfig);

        // Act
        var result = _schema.Evaluate(doc.RootElement);

        // Assert
        result.IsValid.Should().BeFalse(
            because: "baseStress of 150 exceeds maximum of 100");
    }

    [Test]
    public void Schema_RejectsInvalidResistDc()
    {
        // Arrange
        var invalidConfig = """
        {
          "version": "1.0",
          "stressSources": {
            "combat": [
              { "id": "test", "baseStress": 20, "resistDc": 15 }
            ]
          },
          "recoveryRates": {
            "shortRest": { "formula": "WILL × 2" },
            "longRest": { "formula": "WILL × 5" },
            "sanctuary": { "formula": "FULL_RESET" },
            "milestone": { "formula": "25" }
          },
          "traumaCheckReset": { "passed": 75, "failed": 50 }
        }
        """;

        using var doc = JsonDocument.Parse(invalidConfig);

        // Act
        var result = _schema.Evaluate(doc.RootElement);

        // Assert
        result.IsValid.Should().BeFalse(
            because: "resistDc of 15 exceeds maximum of 10");
    }
}
```

---

## 10. Use Cases

### UC-001: Load Stress Configuration

**Actor:** Application Startup
**Flow:** Load JSON → Validate against schema → Deserialize to DTOs → Register in DI
**Precondition:** Configuration file exists
**Postcondition:** Stress configuration available via DI

### UC-002: Lookup Stress Source

**Actor:** CombatService
**Flow:** Get source by ID → Retrieve baseStress and resistDc → Apply via StressService
**Precondition:** Stress source ID known
**Postcondition:** Correct stress values applied

### UC-003: Validate Configuration

**Actor:** CI/CD Pipeline
**Flow:** Parse JSON → Validate against schema → Report errors
**Precondition:** Schema and config files exist
**Postcondition:** Validation result returned

---

## 11. Deliverable Checklist

### Configuration Files

- [ ] `config/stress-sources.json`

### JSON Schemas

- [ ] `config/schemas/stress-sources.schema.json`

### Application DTOs

- [ ] `src/Core/RuneAndRust.Application/DTOs/StressSourceDefinitionDto.cs`
- [ ] `src/Core/RuneAndRust.Application/DTOs/StressRecoveryConfigDto.cs`
- [ ] `src/Core/RuneAndRust.Application/DTOs/StressConfigurationDto.cs`

### Unit Tests

- [ ] `tests/RuneAndRust.Application.UnitTests/Schemas/StressSourcesSchemaTests.cs`

---

## 12. Acceptance Criteria

### Functional Criteria

- [ ] Schema validates correct stress source definitions
- [ ] Schema rejects invalid `baseStress` values (< 1 or > 100)
- [ ] Schema rejects invalid `resistDc` values (< 0 or > 10)
- [ ] Schema enforces kebab-case ID pattern
- [ ] Configuration includes all 6 stress source categories
- [ ] Configuration includes all 4 recovery rate formulas
- [ ] Configuration includes trauma reset values (75/50)
- [ ] DTOs deserialize correctly from JSON

### Quality Criteria

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~3 unit tests pass
- [ ] XML documentation complete on all DTOs
- [ ] Schema includes descriptions for all fields

---

## 13. Dependencies

### Required from v0.18.0a

| Type           | Usage                        |
| -------------- | ---------------------------- |
| `StressSource` | Category alignment in config |
| `RestType`     | Recovery rate alignment      |

### Required Infrastructure

| Type                     | Usage                      |
| ------------------------ | -------------------------- |
| `IConfigurationProvider` | JSON loading (existing)    |
| `Json.Schema`            | Schema validation in tests |

### Provides to StressService

| Type                        | Usage                      |
| --------------------------- | -------------------------- |
| `StressSourceDefinitionDto` | Lookup stress values by ID |
| `StressRecoveryConfigDto`   | Formula retrieval          |
| `TraumaResetConfigDto`      | Reset value retrieval      |

---

## 14. Future Considerations

### Deferred to v0.18.0f

- Integration with StressService for config lookup
- Database caching of frequently used sources

### Deferred to Later Versions

- UI for stress source editing
- Hot-reload of configuration changes
- Per-difficulty scaling of stress values

### Out of Scope

- Runtime configuration modification
- Custom formula parsing engine

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
