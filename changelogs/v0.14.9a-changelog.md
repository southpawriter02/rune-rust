# v0.14.9a Changelog - Dialogue Schema

## Summary

Introduced the comprehensive **Dialogue Schema** (`dialogue.schema.json`) which validates NPC dialogue tree configurations including dialogue nodes, player response options, attribute-based skill checks, outcomes (combat, reputation, quests, items, flags), and conditional visibility for both nodes and options. This schema enables full customization of NPC conversations without code changes, supporting modding scenarios such as custom NPC dialogues, expanded conversation branches, faction reputation systems, and quest integration. The schema validates all 8 existing dialogue files in `docs/design/descriptors/dialogues/`. This is the first entry in the v0.14.9 Advanced Descriptor Configuration Schemas series.

## Added

### Schema File
- **[config/schemas/dialogue.schema.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/schemas/dialogue.schema.json)** - Comprehensive JSON Schema Draft-07

### Schema Definitions (5 Total)

| Definition | Description | Required Fields |
|------------|-------------|-----------------|
| `DialogueNode` | Single conversation point with NPC text | Id, Text, Options |
| `DialogueOption` | Player response choice | Text, NextNodeId |
| `SkillCheck` | Attribute-based check for dialogue options | Attribute, TargetValue |
| `Outcome` | Result of selecting an option | Type, Data |
| `Condition` | Visibility control for nodes/options | Type, Target, Value |

### Attribute Enumeration (5 values)

| Attribute | Description | Example Use |
|-----------|-------------|-------------|
| `might` | Physical strength | Intimidation, breaking objects |
| `finesse` | Dexterity/agility | Sleight of hand, quick reactions |
| `will` | Mental fortitude | Persuasion, resist manipulation |
| `wits` | Knowledge/reasoning | Recall lore, solve puzzles |
| *(empty)* | Skill-only check | Special ability checks |

### Outcome Type Enumeration (10 values)

| Type | Data Field | Effect |
|------|------------|--------|
| `InitiateCombat` | Enemy ID | Start combat encounter |
| `ReputationChange` | Description | Modify faction reputation |
| `Information` | Info description | Reveal information/lore |
| `EndConversation` | Empty | Close dialogue |
| `QuestGiven` | Quest ID | Add quest to journal |
| `QuestUpdate` | Quest:state | Update quest progress |
| `ItemGiven` | Item ID | Give item to player |
| `ItemReceived` | Item ID | Give item to player (alias) |
| `ItemTaken` | Item ID | Remove item from player |
| `FlagSet` | Flag name | Set world state flag |

### Condition Type Enumeration (5 values)

| Type | Target | Value | Description |
|------|--------|-------|-------------|
| `HasItem` | Item ID | Quantity (integer) | Player has N+ of item |
| `HasReputation` | Faction ID | Level (integer) | Faction standing threshold |
| `HasQuestState` | Quest ID | State (string) | Quest in specified state |
| `HasFlag` | Flag name | Value (string/bool) | World flag is set |
| `SkillLevel` | Skill name | Level (integer) | Player skill rank |

### Comparison Operator Enumeration (6 values)

| Operator | Description | Example |
|----------|-------------|---------|
| `equals` | Value exactly matches | HasFlag: boss_defeated = true |
| `notEquals` | Value does not match | HasQuestState != completed |
| `greaterThan` | Value is greater than | HasReputation > 25 |
| `lessThan` | Value is less than | HasItem < 100 |
| `greaterThanOrEquals` | Value is >= | SkillLevel >= 3 |
| `lessThanOrEquals` | Value is <= | HasReputation <= -25 |

### DialogueNode Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `Id` | string | Yes | Unique identifier (snake_case pattern) |
| `Text` | string | Yes | NPC dialogue text |
| `Options` | array | Yes | Player response options (minItems: 1) |
| `EndsConversation` | boolean | No | Auto-end after any option |
| `Conditions` | array | No | Visibility conditions |

### DialogueOption Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `Text` | string | Yes | Player response text |
| `NextNodeId` | string/null | Yes | Navigation target or null to end |
| `SkillCheck` | object | No | Attribute check configuration |
| `Outcome` | object/null | No | Result when selected |
| `Conditions` | array | No | Visibility conditions |

### SkillCheck Properties

| Property | Type | Range | Description |
|----------|------|-------|-------------|
| `Attribute` | string | enum (5) | Attribute to test |
| `TargetValue` | integer | ≥0 | Difficulty number |
| `Skill` | string/null | - | Optional skill for bonus |
| `SkillRanks` | integer | ≥0 | Skill rank bonus |

### Existing Dialogue Files Validated (8 Total)

| File | NPC | Nodes | Key Features |
|------|-----|-------|--------------|
| `bjorn_dialogues.json` | Bjorn | 4 | Combat initiation, WILL checks, RustClans reputation |
| `sigrun_dialogues.json` | Sigrun | 8 | Quest giving, WILL/WITS checks, MidgardCombine reputation |
| `astrid_dialogues.json` | Astrid | 5 | Lore dialogue, QuestGiven, Independents reputation |
| `eydis_dialogues.json` | Eydis | 4 | Skill-only check (BoneSetter), ItemReceived |
| `gunnar_dialogues.json` | Gunnar | 4 | Faction conflict, RustClans/MidgardCombine reputation |
| `kjartan_dialogues.json` | Kjartan | 5 | Merchant hints, MidgardCombine reputation |
| `rolf_dialogues.json` | Rolf | 6 | WITS check, Information outcome, Independents reputation |
| `thorvald_dialogues.json` | Thorvald | 4 | Quest giving, MidgardCombine reputation |

### Unit Tests
- **[DialogueSchemaTests.cs](file:///Volumes/GitHub/github/southpawriter02/rune-rust/tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/DialogueSchemaTests.cs)** - 76 tests
  - `DialogueSchema_LoadsAndParses_Successfully` - Schema structure validation (5 definitions)
  - `DialogueSchema_*Dialogues_PassesValidation` - 8 tests for existing dialogue files
  - `NodeStructure_*` - 8 tests for node validation
  - `OptionStructure_*` - 7 tests for option validation
  - `SkillCheck_*` - 8 tests for skill check validation
  - `OutcomeType_*` - 6 tests for outcome validation
  - `NodeIdPattern_*` - 5 tests for ID pattern validation
  - `Condition_*` - 10 tests for condition validation

## Files Changed

| File | Change Type |
|------|-------------|
| `config/schemas/dialogue.schema.json` | Added |
| `tests/.../Schemas/DialogueSchemaTests.cs` | Added |
| `changelogs/v0.14.9a-changelog.md` | Added |

## Test Results

```
Test summary: total: 76, failed: 0, succeeded: 76, skipped: 0
Build succeeded with 0 errors
```

## Dialogue Schema Structure

```
┌─────────────────────────────────────────────────────────────────┐
│  DIALOGUE TREE CONFIGURATION                                    │
├─────────────────────────────────────────────────────────────────┤
│  $schema: "http://json-schema.org/draft-07/schema#"             │
│  type: array (of DialogueNode)                                  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  DIALOGUE NODES (required, minItems: 1)                   │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ { Id: "npc_greeting", Text: "...", Options: [...] } │  │  │
│  │  │ { Id: "npc_quest", Text: "...", Conditions: [...] } │  │  │
│  │  │ { Id: "npc_farewell", EndsConversation: true }      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  DIALOGUE OPTIONS (within each node)                      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ { Text: "Hello.", NextNodeId: "npc_response" }      │  │  │
│  │  │ { Text: "[WILL 4] Persuade.", SkillCheck: {...} }   │  │  │
│  │  │ { Text: "Fight!", Outcome: { Type: "InitiateCombat"}}│  │  │
│  │  │ { Text: "Goodbye.", NextNodeId: null }              │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  SKILL CHECK (optional per option)                        │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  Attribute: "will" | "wits" | "might" | "finesse"   │  │  │
│  │  │  TargetValue: 4              (difficulty)           │  │  │
│  │  │  Skill: "Persuasion"         (optional bonus)       │  │  │
│  │  │  SkillRanks: 2               (bonus multiplier)     │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  OUTCOME (optional per option)                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  Type: "ReputationChange" | "InitiateCombat" | ...  │  │  │
│  │  │  Data: "quest_id" | "enemy_id" | "description"      │  │  │
│  │  │  ReputationChange: 10        (for reputation)       │  │  │
│  │  │  AffectedFaction: "RustClans" (faction ID)          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  CONDITION (optional per node/option for visibility)      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  Type: "HasItem" | "HasReputation" | "HasQuestState"│  │  │
│  │  │  Target: "item_id" | "faction_id" | "quest_id"      │  │  │
│  │  │  Value: 5 | "completed" | true                      │  │  │
│  │  │  Operator: "equals" | "greaterThan" | ...           │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Skill Check Flow

```
  Player Selects Option with SkillCheck
                    │
                    ▼
      ┌─────────────────────────────┐
      │ Get Player's Attribute Value │
      │ (e.g., Will = 12)           │
      └─────────────┬───────────────┘
                    │
      ┌─────────────▼───────────────┐
      │ If Skill specified:         │
      │   Add skill bonus           │
      │   (ranks × modifier)        │
      └─────────────┬───────────────┘
                    │
      ┌─────────────▼───────────────┐
      │ Compare total vs TargetValue │
      │ e.g., 12 >= 4 ?             │
      └─────────────┬───────────────┘
                    │
          ┌─────────┴─────────┐
          │                   │
        Pass                Fail
          │                   │
          ▼                   ▼
   Option Available    Option Unavailable
```

## v0.14.9 Advanced Descriptor Schemas - Progress

| Version | Schema | Tests | Status |
|---------|--------|-------|--------|
| v0.14.9a | `dialogue.schema.json` | 76 ✓ | **Complete** |
| v0.14.9b | `ability-descriptors.schema.json` | ~6 | Pending |
| v0.14.9c | `npc-descriptors.schema.json` | ~6 | Pending |
| v0.14.9d | `psychological-descriptors.schema.json` | ~6 | Pending |
| v0.14.9e | `capture-templates.schema.json` | ~6 | Pending |
| **Total** | **5 schemas** | **~30 tests** | 1/5 complete |

## Modding Scenarios Enabled

After this implementation, modders can:
- Create custom NPC dialogue trees with branching conversations
- Add skill checks using any of the 4 attributes (might, finesse, will, wits)
- Implement skill-only checks for special abilities (e.g., Bone-Setter)
- Configure outcomes including combat, reputation, quests, items, and flags
- Set up conditional dialogue options based on player state
- Create faction reputation systems integrated with dialogue choices
- Design complex conversation flows with multiple paths

---

*First entry in v0.14.9 Advanced Descriptor Configuration Schemas series. Next: v0.14.9b (Ability Descriptor Schema).*
