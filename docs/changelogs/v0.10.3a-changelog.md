# v0.10.3a Changelog: Combo Definitions

**Version:** 0.10.3a
**Phase:** Combo System - Combo Definitions
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements the combo definition system, providing the foundation for ability combos. Defines `ComboDefinition`, `ComboStep`, and `ComboBonusEffect` entities that describe ability sequences, timing windows, and bonus effects. Adds `IComboProvider` interface and `JsonComboProvider` implementation for loading combo definitions from JSON configuration. Includes four sample combos (Elemental Burst, Warrior's Onslaught, Assassin's Dance, Divine Judgment) demonstrating various combo patterns and bonus types.

---

## Added

### Domain Layer - Enums

| Enum | Values | Description |
|------|--------|-------------|
| `ComboTargetRequirement` | Any, SameTarget, DifferentTarget, Self | Target requirements for combo steps |
| `ComboBonusType` | ExtraDamage, DamageMultiplier, ApplyStatus, Heal, ResetCooldown, RefundResource, AreaEffect | Types of combo bonus effects |
| `ComboBonusTarget` | LastTarget, AllHitTargets, Self, Area | Targets for bonus effect application |

**ComboTargetRequirement Values:**
- `Any` - No target restriction, any valid target acceptable
- `SameTarget` - Must target same entity as previous step
- `DifferentTarget` - Must target different entity than previous step
- `Self` - Must target the caster (for buffs, vanish, etc.)

**ComboBonusType Values:**
- `ExtraDamage` - Dice notation damage (e.g., "4d6")
- `DamageMultiplier` - Multiplier value (e.g., "2.0")
- `ApplyStatus` - Status effect ID
- `Heal` - Dice notation healing
- `ResetCooldown` - Ability ID to reset
- `RefundResource` - Percentage or flat amount
- `AreaEffect` - Radius in cells

### Domain Layer - Definitions

| Class | Properties | Description |
|-------|------------|-------------|
| `ComboDefinition` | Id, ComboId, Name, Description, WindowTurns, RequiredClassIds, Steps, BonusEffects, IconPath | Root combo entity |
| `ComboStep` | StepNumber, AbilityId, TargetRequirement, CustomRequirement | Single step in combo sequence |
| `ComboBonusEffect` | EffectType, Value, DamageType, StatusEffectId, Target | Bonus effect on completion |

**ComboDefinition Features:**
- Implements `IEntity` interface with `Guid Id`
- Private parameterless constructor for EF Core
- Static `Create()` factory method with validation
- Requires minimum 2 steps
- Steps ordered by `StepNumber`
- Class restrictions (empty = all classes)

**ComboDefinition Methods:**
- `StepCount` - Total number of steps
- `FirstAbilityId` - First step's ability ID (for indexing)
- `GetAbilityForStep(stepNumber)` - Get ability for specific step
- `GetStep(stepNumber)` - Get step at position
- `ContainsAbility(abilityId)` - Check if ability in combo
- `IsAvailableForClass(classId)` - Check class availability
- `GetAllAbilityIds()` - All unique ability IDs
- `GetBonusDescriptions()` - Human-readable effect descriptions

**ComboStep.Matches() Method:**
```csharp
// Check if an ability usage matches this step
public bool Matches(string abilityId, bool isSameTarget, bool isSelfTarget)
{
    if (!AbilityId.Equals(abilityId, StringComparison.OrdinalIgnoreCase))
        return false;

    return TargetRequirement switch
    {
        ComboTargetRequirement.Any => true,
        ComboTargetRequirement.SameTarget => isSameTarget,
        ComboTargetRequirement.DifferentTarget => !isSameTarget,
        ComboTargetRequirement.Self => isSelfTarget,
        _ => true
    };
}
```

**ComboBonusEffect.GetDescription() Output:**
- ExtraDamage: "+4d6 piercing damage"
- DamageMultiplier: "x2.0 damage"
- ApplyStatus: "Apply stunned"
- Heal: "Heal 2d8"
- ResetCooldown: "Reset vanish cooldown"
- AreaEffect: "Expand to 2 cell radius"

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IComboProvider` | GetCombo, GetAllCombos, GetCombosForClass, GetCombosContaining, GetCombosStartingWith |

**IComboProvider Methods:**
- `GetCombo(comboId)` - Get combo by ID (case-insensitive)
- `GetAllCombos()` - Get all loaded combos
- `GetCombosForClass(classId)` - Get combos available to class
- `GetCombosContaining(abilityId)` - Find combos with ability
- `GetCombosStartingWith(abilityId)` - Find combos starting with ability

### Infrastructure Layer - Providers

| Provider | Dependencies | Description |
|----------|--------------|-------------|
| `JsonComboProvider` | ILogger | JSON-based combo definition provider |

**JsonComboProvider Features:**
- Loads from `combos.json` at startup
- Primary index: combo ID -> ComboDefinition
- Secondary index: first ability ID -> List<ComboDefinition>
- Case-insensitive lookups
- Comprehensive logging
- DTO-based JSON deserialization

### Configuration Files

| File | Description |
|------|-------------|
| `config/combos.json` | Combo definitions |
| `config/schemas/combos.schema.json` | JSON schema for validation |

**Sample Combos:**

| Combo | Class | Steps | Window | Bonus Effects |
|-------|-------|-------|--------|---------------|
| Elemental Burst | Mage/Sorcerer | Fire Bolt → Ice Shard → Lightning | 3 turns | x2.0 damage, Apply elemental-overload |
| Warrior's Onslaught | Warrior/Paladin | Charge → Power Strike → Execute | 2 turns | Apply stunned, Apply bleeding |
| Assassin's Dance | Rogue/Assassin | Backstab → Vanish (self) → Ambush | 2 turns | +4d6 piercing, Reset Vanish cooldown |
| Divine Judgment | Paladin/Cleric | Smite → Holy Light | 3 turns | 2-cell AoE, Heal 2d8 |

### Tests

| Test File | Test Count | Description |
|-----------|------------|-------------|
| `JsonComboProviderTests.cs` | 16 | Combo definition and provider tests |

**Test Coverage:**
- `Create_ValidCombo_ReturnsComboDefinition` - Valid combo creation
- `Create_LessThanTwoSteps_ThrowsArgumentException` - Minimum step validation
- `StepCount_ReturnsCorrectCount` - Step count accuracy
- `GetAbilityForStep_ValidStep_ReturnsAbilityId` - Step lookup
- `ContainsAbility_AbilityPresent_ReturnsTrue` - Ability search (found)
- `ContainsAbility_AbilityMissing_ReturnsFalse` - Ability search (not found)
- `IsAvailableForClass_MatchingClass_ReturnsTrue` - Class filtering (match)
- `IsAvailableForClass_EmptyClassList_ReturnsTrue` - Class filtering (all)
- `ComboStep_Matches_ChecksAbilityId` - Step matching (ability)
- `ComboStep_Matches_ChecksTargetRequirement` - Step matching (target)
- `ComboBonusEffect_GetDescription_ReturnsCorrectDescription` - Effect descriptions
- `GetAllCombos_ReturnsAllLoadedCombos` - Provider load all
- `GetCombosForClass_FiltersCorrectly` - Provider class filter
- `GetCombosStartingWith_ReturnsIndexedCombos` - Provider index lookup
- `GetCombo_ExistingId_ReturnsCombo` - Provider single lookup
- `GetCombo_UnknownId_ReturnsNull` - Provider null handling

---

## Modified

### Infrastructure Layer - DependencyInjection

| File | Change |
|------|--------|
| `DependencyInjection.cs` | Added `IComboProvider` singleton registration |

**DI Registration:**
```csharp
// Combo provider (v0.10.3a) - loads combo definitions from JSON config
services.AddSingleton<IComboProvider>(sp =>
{
    var combosPath = Path.Combine(configPath, "combos.json");
    var logger = sp.GetRequiredService<ILogger<JsonComboProvider>>();
    return new JsonComboProvider(combosPath, logger);
});
```

---

## Architecture

### Combo Definition Structure

```
ComboDefinition (IEntity)
├── Id: Guid
├── ComboId: string
├── Name: string
├── Description: string
├── WindowTurns: int
├── RequiredClassIds: IReadOnlyList<string>
├── IconPath: string?
├── Steps: IReadOnlyList<ComboStep>
│   └── ComboStep
│       ├── StepNumber: int
│       ├── AbilityId: string
│       ├── TargetRequirement: ComboTargetRequirement
│       └── CustomRequirement: string?
└── BonusEffects: IReadOnlyList<ComboBonusEffect>
    └── ComboBonusEffect
        ├── EffectType: ComboBonusType
        ├── Value: string
        ├── DamageType: string?
        ├── StatusEffectId: string?
        └── Target: ComboBonusTarget
```

### Provider Indexing

```
JsonComboProvider
├── _combos: Dictionary<string, ComboDefinition>
│   └── Key: ComboId (case-insensitive)
│   └── Value: ComboDefinition
│
└── _byFirstAbility: Dictionary<string, List<ComboDefinition>>
    └── Key: FirstAbilityId (case-insensitive)
    └── Value: List of combos starting with that ability
```

---

## JSON Configuration Format

```json
{
  "$schema": "./schemas/combos.schema.json",
  "combos": [
    {
      "comboId": "elemental-burst",
      "name": "Elemental Burst",
      "description": "Chain fire, ice, and lightning for explosive damage",
      "windowTurns": 3,
      "requiredClassIds": ["mage", "sorcerer"],
      "steps": [
        { "stepNumber": 1, "abilityId": "fire-bolt", "targetRequirement": "any" },
        { "stepNumber": 2, "abilityId": "ice-shard", "targetRequirement": "sameTarget" },
        { "stepNumber": 3, "abilityId": "lightning", "targetRequirement": "sameTarget" }
      ],
      "bonusEffects": [
        { "effectType": "DamageMultiplier", "value": "2.0", "target": "lastTarget" },
        { "effectType": "ApplyStatus", "value": "", "statusEffectId": "elemental-overload", "target": "lastTarget" }
      ],
      "icon": "icons/combos/elemental-burst.png"
    }
  ]
}
```

---

## Dependencies

| Dependency | Usage |
|------------|-------|
| Domain.IEntity | ComboDefinition implements IEntity |
| Domain.Enums | ComboTargetRequirement, ComboBonusType, ComboBonusTarget |
| Microsoft.Extensions.Logging | Provider logging |
| System.Text.Json | JSON deserialization |

---

## Breaking Changes

None. This version adds new types without modifying existing APIs.

---

## Migration Notes

No migration required. The combo system is additive and does not affect existing functionality.

---

## Next Steps

- **v0.10.3b:** Combo Detection - Track ability usage and detect combo completion
- **v0.10.3c:** Combo Execution - Apply bonus effects when combos complete

---

*Document Version: 1.0 | Last Updated: 2026-01-19*
