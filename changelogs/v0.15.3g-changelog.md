# v0.15.3g Changelog - Cultural Protocol System

## Summary

Implements the **Cultural Protocol System** subsystem of the Rhetoric skill. Enables culture-specific social interaction mechanics where characters must navigate unique communication customs for each of five major cultures: Dvergr (DC 18, Logic-Chain protocols), Utgard (DC 16, Veil-Speech conventions), Gorge-Maw (DC 14, Hospitality Rites), Rune-Lupin (DC 12, Pack-Speech telepathy), and Iron-Bane (DC 16, Blood Oath honor codes). Features Cant fluency mechanics (None/-1d10, Basic/+0, Fluent/+1d10), Veil-Speech state tracking for Utgard interactions (DirectTruth/-2d10, ProperVeil/+1d10, Deceptive/DC-4), and escalating protocol violation consequences (Minor/+2 DC to Unforgivable/blocks interaction).

## Added

### Domain Layer - Enums (5 files)

| File | Description |
|------|-------------|
| `CantFluency.cs` | 3-level enum: None (unfamiliar, -1d10), Basic (functional, +0), Fluent (native-level, +1d10). Represents character's proficiency in cultural trade languages. |
| `VeilSpeechState.cs` | 3-state enum: DirectTruth (offensive, -2d10), ProperVeil (respected, +1d10), Deceptive (culturally expected, DC-4). Utgard-specific communication modes. |
| `ProtocolViolationType.cs` | 5-severity enum: None, Minor (+2 DC), Moderate (+4 DC, -1d10), Severe (+6 DC, -2d10), Unforgivable (blocks interaction). Escalating consequences. |
| `ProtocolRequirementType.cs` | 7-type enum: GreetingRitual, StatusAcknowledgment, GiftExchange, LogicalArgument, MentalOpenness, HonorDisplay, PatienceDisplay. Protocol components. |
| `SpecialProtocolType.cs` | 5-type enum: VeilSpeech (Utgard), LogicChain (Dvergr), Telepathy (Rune-Lupin), BloodOath (Iron-Bane), HospitalityRite (Gorge-Maw). Culture-specific rules. |

### Domain Layer - Extensions (3 files)

| File | Description |
|------|-------------|
| `CantFluencyExtensions.cs` | `GetDiceModifier()`, `GetDisplayName()`, `GetDescription()`, `GetNarrativeDescription()`, `CanUnderstand()`, `CanSpeak()`, `ProvidesBonus()`, `IncursPenalty()`, `GrantsCulturalDialogueAccess()`, `GetColorHint()`, `GetIconHint()` |
| `VeilSpeechStateExtensions.cs` | `GetDiceModifier()`, `GetDcModifier()`, `GetDisplayName()`, `GetDescription()`, `GetNarrativeHint()`, `IsOffensive()`, `IsRespected()`, `GetColorHint()`, `GetIconHint()` |
| `ProtocolViolationTypeExtensions.cs` | `GetDcIncrease()`, `GetDicePenalty()`, `GetDispositionChange()`, `GetDisplayName()`, `GetDescription()`, `GetConsequenceDescription()`, `GetRecoveryDescription()`, `BlocksInteraction()`, `IsRecoverable()`, `MayTriggerHostility()`, `AffectsFactionReputation()`, `GetColorHint()`, `GetSeverityLevel()`, `IsMoreSevereThan()` |

### Domain Layer - Value Objects (4 files)

| File | Description |
|------|-------------|
| `CantModifier.cs` | Tracks cant usage: Fluency, DiceModifier, CultureId, CantName. Computed properties: `IsBonus`, `IsPenalty`, `IsNeutral`, `CanUnderstand`, `CanSpeak`, `HasCulturalDialogueAccess`. Methods: `ToDisplayString()`, `ToShortDisplay()`, `ToSocialModifier()`, `GetSummary()`. Factory methods: `FromFluency()`, `Neutral()`, `Unfamiliar()`, `FluentSpeaker()` |
| `VeilSpeechContext.cs` | Utgard-specific context: State, DiceModifier, DcModifier, IsOffensive, IsRespected, NarrativeHint. Methods: `ToSocialModifier()`, `ToDisplayString()`, `GetStateDescription()`. Factory method: `Create()` |
| `ProtocolRequirement.cs` | Protocol rule definition: Type, Description, IsMandatory, ViolationSeverity, NarrativeHint. Methods: `ToDisplayString()`, `GetViolationWarning()`. Factory method: `Create()` |
| `ProtocolCheckResult.cs` | Compliance outcome: IsCompliant, Violations, TotalDcModifier, TotalDiceModifier, BlocksInteraction, MostSevereViolation. Methods: `ToDisplayString()`, `GetViolationSummary()`, `ToSocialModifiers()`. Factory methods: `Compliant()`, `WithViolations()` |

### Domain Layer - Entities (1 file)

| File | Description |
|------|-------------|
| `CultureProtocol.cs` | Complete protocol definition: CultureId, ProtocolName, BaseDc, CantName, Requirements, SpecialProtocols, ViolationConsequence, NarrativeIntro. Methods: `HasSpecialProtocol()`, `GetRequirementsByType()`, `GetMandatoryRequirements()`, `ToDisplayString()`, `GetSummary()`. Factory method: `Create()` |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `ICulturalProtocolService.cs` | Interface: `GetProtocolAsync`, `GetAllProtocolsAsync`, `GetCantModifierAsync`, `CheckProtocolComplianceAsync`, `ApplyVeilSpeechLogicAsync`, `GetVeilSpeechStateAsync`, `RecordProtocolViolationAsync`, `GetRequirementsAsync`, `HasSpecialProtocolAsync`, `CalculateEffectiveDcAsync`, `CalculateDiceModifierAsync`, `UpdateVeilSpeechStateAsync`, `ClearCharacterStateAsync`, `GetCultureCantNameAsync`, `GetProtocolNarrativeIntroAsync` |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `CulturalProtocolService.cs` | Full implementation with comprehensive logging, in-memory Veil-Speech state tracking via `_veilSpeechStates` dictionary, violation history via `_violationHistory` dictionary, default protocol definitions for all 5 cultures, DC/dice calculation with cumulative modifiers, `ViolationRecord` internal record type |

### Application Layer - Configuration (1 file)

| File | Description |
|------|-------------|
| `CulturalProtocolOptions.cs` | Options classes: `CulturalProtocolOptions` (main class with `SectionName = "CulturalProtocols"`), `ProtocolConfig` (individual protocol), `DetailedRequirementConfig` (granular requirements), `CantModifierConfig` (fluency values), `VeilSpeechRulesConfig` (Utgard-specific modifiers) |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/social/cultural-protocols.json` | Protocol definitions for all 5 cultures: BaseDc, Requirements (with RequirementType, IsMandatory, ViolationSeverity), VeilSpeechRules (DeceptionDcReduction, ProperVeilSpeechBonus, DirectTruthPenalty, OffenseEscalationThreshold), ViolationConsequences, CultureSummary |
| `config/social/cant-modifiers.json` | Cant definitions: CantModifiers (None/Basic/Fluent with DiceModifier, Description, DisplayText, NarrativeDescription, CanUnderstand, CanSpeak, GrantsCulturalDialogueAccess), CultureCants (5 cultures with CantName, Description, NarrativeIntro, KeyFeatures, LearningDifficulty, CommonPhrases), FluencyAcquisition rules, DisplayFormats, Settings |

### Unit Tests (1 test file, 50+ tests)

| File | Tests |
|------|-------|
| `CulturalProtocolSystemTests.cs` | CantFluency dice modifiers (-1/0/+1), CantFluency CanUnderstand/CanSpeak capabilities, CantFluency cultural dialogue access, VeilSpeechState dice modifiers (-2/+1/0), VeilSpeechState DC modifiers (0/0/-4), VeilSpeechState offensive/respected states, ProtocolViolationType DC increases (+0/+2/+4/+6/∞), ProtocolViolationType dice penalties (0/0/-1/-2), ProtocolViolationType BlocksInteraction, ProtocolViolationType disposition scaling, ProtocolViolationType recoverability, CantModifier factory methods, VeilSpeechContext factory methods, ProtocolCheckResult compliance/violations, CultureProtocol special protocol types, Culture base DC tests (18/16/14/12/16) |

## Key Features

### Culture Protocols

| Culture | Base DC | Special Protocol | Cant Name | Key Features |
|---------|:-------:|------------------|-----------|--------------|
| Dvergr | 18 | LogicChain | Dvergr Trade-Tongue | Precision language, logical arguments required |
| Utgard | 16 | VeilSpeech | Utgard Shadow-Tongue | Layered meaning, direct truth offends |
| Gorge-Maw | 14 | HospitalityRite | Gorge-Maw Rumble | Patient tonal language, extended greetings |
| Rune-Lupin | 12 | Telepathy | Lupin Mind-Speech | Semi-telepathic, emotions leak through |
| Iron-Bane | 16 | BloodOath | Iron-Bane War-Cant | Martial honor, binding oaths |

### Cant Fluency System

| Level | Dice Modifier | Can Understand | Can Speak | Cultural Dialogue | Description |
|-------|:-------------:|:--------------:|:---------:|:-----------------:|-------------|
| None | -1d10 | No | No | No | Unfamiliar with the dialect |
| Basic | +0 | Yes | Yes | No | Functional but lacks nuance |
| Fluent | +1d10 | Yes | Yes | Yes | Native-level proficiency |

### Veil-Speech States (Utgard-specific)

| State | Dice Modifier | DC Modifier | Cultural Reception | Description |
|-------|:-------------:|:-----------:|:------------------:|-------------|
| DirectTruth | -2d10 | +0 | Offensive | Blunt honesty offends |
| ProperVeil | +1d10 | +0 | Respected | Expected indirect communication |
| Deceptive | +0 | -4 | Respected | Skilled lying is culturally valued |

### Protocol Violation Consequences

| Severity | DC Increase | Dice Penalty | Disposition | Blocks? | Recoverable? |
|----------|:-----------:|:------------:|:-----------:|:-------:|:------------:|
| None | +0 | 0 | 0 | No | N/A |
| Minor | +2 | 0 | -5 | No | Yes (automatic) |
| Moderate | +4 | -1d10 | -15 | No | Yes (apology) |
| Severe | +6 | -2d10 | -30 | No | Yes (difficult) |
| Unforgivable | ∞ | N/A | -100 | **Yes** | **No** |

### Effective DC Calculation

```
Effective DC = Culture Base DC
             + Protocol Violation DC Modifier
             + Veil-Speech DC Modifier (if Utgard)
             + Any contextual modifiers
```

### Dice Pool Calculation

```
Dice Pool = Base Attribute + Rhetoric
          + Cant Fluency Modifier (-1/0/+1)
          + Veil-Speech Modifier (-2/+1/0) (if Utgard)
          - Protocol Violation Dice Penalty (0/-1/-2)
          + Any contextual bonuses
```

## Files Changed

| File | Change |
|------|--------|
| `src/Core/RuneAndRust.Domain/Enums/CantFluency.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/VeilSpeechState.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/ProtocolViolationType.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/ProtocolRequirementType.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/SpecialProtocolType.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/CantFluencyExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/VeilSpeechStateExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/ProtocolViolationTypeExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/CantModifier.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/VeilSpeechContext.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/ProtocolRequirement.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/ProtocolCheckResult.cs` | Added |
| `src/Core/RuneAndRust.Domain/Entities/CultureProtocol.cs` | Added |
| `src/Core/RuneAndRust.Application/Interfaces/ICulturalProtocolService.cs` | Added |
| `src/Core/RuneAndRust.Application/Services/CulturalProtocolService.cs` | Added |
| `src/Core/RuneAndRust.Application/Configuration/CulturalProtocolOptions.cs` | Added |
| `config/social/cultural-protocols.json` | Added |
| `config/social/cant-modifiers.json` | Added |
| `tests/RuneAndRust.Domain.UnitTests/Services/CulturalProtocolSystemTests.cs` | Added |
| `changelogs/v0.15.3g-changelog.md` | Added |

## Test Results

```
Total tests: 121
     Passed: 121 (all tests passed)
Build succeeded with 0 errors
```

## Dependencies

- **v0.15.3f:** `InterrogationService` patterns for state tracking
- **v0.15.3e:** `NegotiationService` patterns for multi-round mechanics
- **v0.15.3c:** `DeceptionService` patterns (Veil-Speech deception mechanics)
- **v0.15.3b:** `PersuasionService` patterns (proper communication bonuses)
- **v0.15.3a:** `SocialContext`, `SocialContextBuilder`, `SocialModifier`, `SocialModifierType.Cultural`
- **v0.15.1b:** `SkillOutcome`, dice pool calculation patterns
- **v0.15.0:** `DiceRollResult`, `IDiceRollerService`

## Integration Points

### Previous Subsystems (v0.15.3a-f)

- **Persuasion:** Proper cant fluency and protocol compliance enhance persuasion attempts
- **Intimidation:** Cultural protocols affect how intimidation is received
- **Deception:** Veil-Speech states directly integrate with deception mechanics
- **Negotiation:** Cultural context affects negotiation DC and available options
- **Interrogation:** Subject's culture affects resistance and method effectiveness

### v0.15.3h (Extended Influence)

- Cultural protocols affect long-term relationship building
- Protocol violations create lasting reputation effects
- Fluency levels affect available influence strategies

### v0.15.3i (Specialization Abilities)

- Kupmaðr specialization bonuses for specific cultures
- Cultural background grants automatic fluency in home culture cant
- Specialization abilities may grant additional protocol bonuses

## Notes

- Cant fluency defaults to Fluent for character's own culture, Basic for neighboring cultures, None for distant cultures
- Veil-Speech state tracking is per-character per-NPC; states can escalate from Offended to DeepOffense after repeated direct truth offenses
- Protocol violations are cumulative within a session; recovery requires appropriate actions based on severity
- Unforgivable violations permanently block interaction with that NPC
- Service uses in-memory tracking; production requires persistence for violation history
- Only fluent speakers can access cultural-specific dialogue options that reference deep cultural knowledge
- Configuration files use JSON schemas for validation: `cultural-protocols-schema.json`, `cant-modifiers-schema.json`
- `SocialModifierType.Cultural` is used for all cant and protocol-related modifiers
- Gorge-Maw Hospitality Rite requires 30+ second greetings; interruption is a Severe violation
- Rune-Lupin Telepathy makes deception nearly impossible (emotions leak through Mind-Speech)
- Iron-Bane Blood Oaths are binding; breaking an oath is an Unforgivable violation
