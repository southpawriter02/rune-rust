# Changelog: v0.3.20a - The Notes (Room Annotations)

**Release Date:** 2025-12-26
**Total Tests:** 12 new tests

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [Verification Results](#verification-results)
- [Directory Structure After v0.3.20a](#directory-structure-after-v0320a)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

v0.3.20a "The Notes" implements a persistent user-defined room annotation system, the first sub-version of the v0.3.20 Cartographer II feature set. Players can now attach text notes to any explored room, which persist across save/load cycles and display as a yellow `!` symbol on the minimap.

**Layers Touched:** Core, Engine, Terminal, Tests

**Key Achievements:**
- **Note Command:** Added `note`, `note <text>`, and `note clear` commands to CommandParser
- **Minimap Integration:** Annotated rooms display yellow `!` symbol with higher priority than feature symbols
- **Persistence:** Notes stored in `GameState.UserNotes` dictionary and serialized via source-generated JSON
- **Case Preservation:** Note text maintains original casing despite command lowercasing
- **Length Validation:** Notes truncated to 100 characters with user notification

**Patterns Introduced:**
- Original input passthrough for case-sensitive command arguments
- Symbol priority override in minimap tile resolution

---

## New Files Created

### Test Layer

| File | Purpose | Tests |
|------|---------|-------|
| `RuneAndRust.Tests/Engine/NoteCommandTests.cs` | Unit tests for note command covering set, read, clear, truncation, and edge cases | 12 |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Models/GameState.cs` | Added `UserNotes` dictionary property (line 55-58); added `UserNotes.Clear()` to `Reset()` method (line 95) |
| `RuneAndRust.Core/Serialization/GameStateContext.cs` | Added `[JsonSerializable(typeof(Dictionary<Guid, string>))]` attribute (line 41) |
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Added `UserNotes` parameter to record (line 30, 52) |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added note command detection (lines 704-709); added `HandleNoteCommand()` method (lines 1487-1561); updated `HandleExplorationAsync()` signature to include `originalInput` parameter |
| `RuneAndRust.Terminal/Rendering/MinimapRenderer.cs` | Added `userNotes` parameter to `Render()` and `ResolveTile()` methods; added annotation check returning yellow `!` symbol (lines 149-153, 185-189) |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Updated `MinimapRenderer.Render()` call to pass `vm.UserNotes` (line 58-62) |
| `RuneAndRust.Engine/Services/GameService.cs` | Updated `BuildExplorationViewModelAsync()` to include `_state.UserNotes` in ViewModel construction |
| `RuneAndRust.Tests/Terminal/MinimapRendererTests.cs` | Added `userNotes` parameter to all `ResolveTile()` and `Render()` test calls; added `ResolveTile_AnnotatedRoom_ReturnsYellowExclamation` and `Render_WithAnnotatedRoom_ReturnsPanel` tests |
| `RuneAndRust.Tests/Terminal/RoomRendererTests.cs` | Updated `CreateTestViewModel()` helper to include `UserNotes` parameter |

---

## Code Implementation Details

### GameState.UserNotes Property

**Location:** `RuneAndRust.Core/Models/GameState.cs` (lines 55-58)

```csharp
/// <summary>
/// User-defined notes for rooms, keyed by RoomId (v0.3.20a).
/// Displayed on minimap with '!' symbol.
/// </summary>
public Dictionary<Guid, string> UserNotes { get; set; } = new();
```

**Behaviors:**
- Dictionary keyed by room GUID with string note values
- Initialized to empty dictionary (never null)
- Cleared on `Reset()` to prevent note leakage between sessions
- Serialized via source-generated JSON for save/load persistence

---

### GameStateContext Serialization

**Location:** `RuneAndRust.Core/Serialization/GameStateContext.cs` (line 41)

```csharp
[JsonSerializable(typeof(Dictionary<Guid, string>))] // UserNotes (v0.3.20a)
```

**Purpose:** Enables source-generated serialization for the `Dictionary<Guid, string>` type used by `UserNotes`, eliminating reflection overhead during save/load.

---

### ExplorationViewModel.UserNotes Parameter

**Location:** `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` (lines 30, 52)

```csharp
/// <param name="UserNotes">User-defined room notes, keyed by RoomId (v0.3.20a).</param>
public record ExplorationViewModel(
    // ... existing parameters ...
    HashSet<Guid> VisitedRoomIds,
    Dictionary<Guid, string> UserNotes,  // NEW (v0.3.20a)
    List<string> VisibleObjects,
    // ... remaining parameters ...
);
```

**Behaviors:**
- Immutable record parameter for thread-safe view model
- Passed through to MinimapRenderer for annotation display
- Position: After `VisitedRoomIds`, before `VisibleObjects`

---

### CommandParser.HandleNoteCommand Method

**Location:** `RuneAndRust.Engine/Services/CommandParser.cs` (lines 1487-1561)

```csharp
/// <summary>
/// Handles the note command for annotating rooms on the minimap.
/// </summary>
/// <param name="originalInput">The original (non-lowercased) command string to preserve note text casing.</param>
/// <param name="state">The current game state.</param>
/// <returns>A ParseResult (always None for note commands).</returns>
private ParseResult HandleNoteCommand(string originalInput, GameState state)
{
    // Validate room
    if (state.CurrentRoomId == null)
    {
        _inputHandler.DisplayError("You are nowhere. Cannot set a note.");
        _logger.LogWarning("Note command attempted with null CurrentRoomId.");
        return ParseResult.None;
    }

    var roomId = state.CurrentRoomId.Value;

    // Parse command: "note" (read), "note clear" (delete), "note <text>" (set)
    if (originalInput.Equals("note", StringComparison.OrdinalIgnoreCase))
    {
        // Read current note
        if (state.UserNotes.TryGetValue(roomId, out var existingNote))
        {
            _inputHandler.DisplayMessage($"[yellow]Note:[/] {existingNote}");
            _logger.LogDebug("Note read for room {RoomId}: {Note}", roomId, existingNote);
        }
        else
        {
            _inputHandler.DisplayMessage("[grey]No note for this room.[/]");
            _logger.LogDebug("No note exists for room {RoomId}.", roomId);
        }
        return ParseResult.None;
    }

    // Extract note text after "note " (case-insensitive prefix removal)
    var noteText = originalInput.Substring(5).Trim(); // Remove "note "

    if (noteText.Equals("clear", StringComparison.OrdinalIgnoreCase))
    {
        // Clear note
        if (state.UserNotes.Remove(roomId))
        {
            _inputHandler.DisplayMessage("[grey]Note cleared.[/]");
            _logger.LogDebug("Note cleared for room {RoomId}.", roomId);
        }
        else
        {
            _inputHandler.DisplayMessage("[grey]No note to clear.[/]");
        }
        return ParseResult.None;
    }

    // Validate note text
    if (string.IsNullOrWhiteSpace(noteText))
    {
        _inputHandler.DisplayMessage("[grey]Usage: note <text> | note clear | note (to view)[/]");
        return ParseResult.None;
    }

    // Clamp note length
    const int maxNoteLength = 100;
    if (noteText.Length > maxNoteLength)
    {
        noteText = noteText.Substring(0, maxNoteLength);
        _inputHandler.DisplayMessage($"[yellow]Note truncated to {maxNoteLength} characters.[/]");
    }

    // Set note
    state.UserNotes[roomId] = noteText;
    _inputHandler.DisplayMessage($"[green]Note set:[/] {noteText}");
    _logger.LogDebug("Note set for room {RoomId}: {Note}", roomId, noteText);

    return ParseResult.None;
}
```

**Command Syntax:**

| Command | Result |
|---------|--------|
| `note` | Displays current room's note (or "No note for this room") |
| `note Danger ahead!` | Sets note to "Danger ahead!" for current room (preserves casing) |
| `note clear` | Removes note from current room |

**Behaviors:**
- Validates `CurrentRoomId` is not null before processing
- Uses `originalInput` parameter to preserve note text casing
- Supports case-insensitive `clear` subcommand
- Truncates notes exceeding 100 characters with user notification
- Returns `ParseResult.None` (no async follow-up required)

---

### MinimapRenderer Annotation Display

**Location:** `RuneAndRust.Terminal/Rendering/MinimapRenderer.cs` (lines 149-153, 185-189)

**Themed Version (lines 149-153):**
```csharp
// User annotation - show yellow ! for rooms with notes (v0.3.20a)
if (userNotes.ContainsKey(room.Id))
{
    return new Markup($"[{themeService.GetColor("WarningColor")}]![/]");
}
```

**Legacy Version (lines 185-189):**
```csharp
// User annotation - show yellow ! for rooms with notes (v0.3.20a)
if (userNotes.ContainsKey(room.Id))
{
    return new Markup("[yellow]![/]");
}
```

**Symbol Priority (Updated):**

| Priority | Condition | Symbol | Color |
|----------|-----------|--------|-------|
| 1 | Player position | `@` | Cyan |
| 2 | **Annotated room** | `!` | Yellow |
| 3 | Boss Lair | `☠` | Red |
| 4 | Stairs Up | `▲` | White |
| 5 | Stairs Down | `▼` | White |
| 6 | Settlement | `⌂` | Blue |
| 7 | Runic Anchor | `◆` | Cyan |
| 8 | Workbench/Alchemy | `⚒` | Yellow |
| 9 | Danger Level | `O` | Varies |

---

## Logging Matrix

### CommandParser (Note Command)

| Event | Level | Template |
|-------|-------|----------|
| Note read (exists) | Debug | `Note read for room {RoomId}: {Note}` |
| Note read (missing) | Debug | `No note exists for room {RoomId}.` |
| Note cleared | Debug | `Note cleared for room {RoomId}.` |
| Note set | Debug | `Note set for room {RoomId}: {Note}` |
| No room context | Warning | `Note command attempted with null CurrentRoomId.` |

---

## Test Coverage

**Summary:**
```
Total: 12 | Passed: 12 | Failed: 0
```

### NoteCommandTests (12 tests)

| Test Name | Description |
|-----------|-------------|
| `NoteCommand_SetNote_AddsNoteToState` | Verifies `note <text>` adds entry to UserNotes dictionary |
| `NoteCommand_SetNote_DisplaysConfirmation` | Confirms "Note set:" message displayed with note text |
| `NoteCommand_OverwriteExistingNote_ReplacesNote` | Verifies new note replaces previous note for same room |
| `NoteCommand_LongNote_TruncatesToMaxLength` | Confirms notes > 100 chars truncated with notification |
| `NoteCommand_ReadExistingNote_DisplaysNote` | Verifies `note` command displays existing note text |
| `NoteCommand_ReadNonExistentNote_DisplaysNoNoteMessage` | Confirms "No note for this room" for rooms without notes |
| `NoteCommand_ClearExistingNote_RemovesNote` | Verifies `note clear` removes entry from UserNotes |
| `NoteCommand_ClearNonExistentNote_DisplaysNoNoteMessage` | Confirms "No note to clear" when no note exists |
| `NoteCommand_ClearCaseInsensitive_Works` | Verifies `note CLEAR` works (case-insensitive) |
| `NoteCommand_NoCurrentRoom_DisplaysError` | Confirms error when CurrentRoomId is null |
| `NoteCommand_JustNoteWord_ReadsNote` | Verifies "note " with trailing space trims to read command |
| `GameState_Reset_ClearsUserNotes` | Confirms Reset() clears UserNotes dictionary |

### MinimapRendererTests (2 new tests)

| Test Name | Description |
|-----------|-------------|
| `ResolveTile_AnnotatedRoom_ReturnsYellowExclamation` | Verifies annotated rooms return `!` symbol |
| `Render_WithAnnotatedRoom_ReturnsPanel` | Integration test with annotated room in map |

---

## Verification Results

### Build Output

```
Build succeeded.

    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:03.21
```

### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    12, Skipped:     0, Total:    12
Total time: 0.3847 Seconds
```

### Related Test Suites (No Regressions)

| Test Suite | Tests | Status |
|------------|-------|--------|
| MinimapRendererTests | 24 | Passed |
| RoomRendererTests | 33 | Passed |
| SaveManagerTests | 21 | Passed |

---

## Directory Structure After v0.3.20a

```
RuneAndRust.Core/
├── Models/
│   └── GameState.cs                              [MODIFIED]
├── Serialization/
│   └── GameStateContext.cs                       [MODIFIED]
└── ViewModels/
    └── ExplorationViewModel.cs                   [MODIFIED]

RuneAndRust.Engine/
└── Services/
    ├── CommandParser.cs                          [MODIFIED]
    └── GameService.cs                            [MODIFIED]

RuneAndRust.Terminal/
└── Rendering/
    ├── ExplorationScreenRenderer.cs              [MODIFIED]
    └── MinimapRenderer.cs                        [MODIFIED]

RuneAndRust.Tests/
├── Engine/
│   └── NoteCommandTests.cs                       [NEW]
└── Terminal/
    ├── MinimapRendererTests.cs                   [MODIFIED]
    └── RoomRendererTests.cs                      [MODIFIED]
```

---

## Running Tests

### Run All v0.3.20a Tests

```bash
dotnet test --filter "FullyQualifiedName~NoteCommandTests"
```

### Run All Minimap Tests (Including Annotation Tests)

```bash
dotnet test --filter "FullyQualifiedName~MinimapRendererTests"
```

### Run Specific Test

```bash
dotnet test --filter "FullyQualifiedName~NoteCommand_SetNote_AddsNoteToState"
```

---

## Design Decisions

### Why Store Notes in GameState (Not Room)?

**Problem:** Notes could be stored on the `Room` entity directly, but this would:
- Require database migration for new column
- Complicate serialization (Room is a complex entity)
- Mix user-generated data with world-generated data

**Solution:** Store notes in `GameState.UserNotes` dictionary keyed by room GUID:
- Persists with save file automatically via existing GameState serialization
- Clean separation between world data and player data
- Simple dictionary lookup (O(1)) for annotation checks

### Why Pass originalInput to HandleNoteCommand?

**Problem:** `CommandParser` normalizes all commands to lowercase for case-insensitive matching:
```csharp
var command = input.Trim().ToLowerInvariant();
```
This caused note text like "Danger ahead!" to be stored as "danger ahead!".

**Solution:** Added `originalInput` parameter to `HandleExplorationAsync()` method chain:
```csharp
private async Task<ParseResult> HandleExplorationAsync(string command, string originalInput, GameState state)
```
The `command` is used for matching, while `originalInput` preserves the user's intended casing for the note text.

### Why 100 Character Limit?

**Rationale:**
- Minimap tooltip display constraints
- Prevents excessive memory usage
- Matches typical note-taking UX patterns
- Truncation with notification (not silent)

---

## Next Steps

**v0.3.20b (Map Export):** Add `map export` command to export explored map data as ASCII art or structured format.

**v0.3.20c (Waypoint System):** Add named waypoints for fast-travel anchors with `waypoint set/list/clear` commands.

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new NoteCommand functionality (12/12 tests passing)
**Integration:** Zero regressions in MinimapRenderer (24), RoomRenderer (33), and SaveManager (21) tests

---

**End of Changelog v0.3.20a**
