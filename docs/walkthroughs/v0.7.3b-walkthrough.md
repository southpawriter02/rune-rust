# v0.7.3b Walkthrough - Grid Interaction

## Overview

This version implements click-based interaction with the combat grid for movement and targeting. The `GridInteractionService` manages interaction modes, calculates valid targets, and raises events when targeting completes.

## Architecture

```
┌─────────────────────────────────────────────┐
│           CombatGridPanelViewModel          │
│  ┌───────────────────────────────────────┐  │
│  │ Subscribes to:                        │  │
│  │  • OnHighlightsChanged → RefreshCells │  │
│  │  • OnTargetingComplete → Execute      │  │
│  └───────────────────────────────────────┘  │
│                     ▲                        │
│                     │ Events                 │
│                     │                        │
│  ┌───────────────────────────────────────┐  │
│  │        GridInteractionService         │  │
│  │  • CurrentMode (None/Move/Attack/Abl) │  │
│  │  • ValidTargets (HashSet<GridPos>)    │  │
│  │  • HandleCellClick(pos)               │  │
│  │  • HandleCellHover(pos)               │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

## Interaction Flow

1. **Enter Mode**: Call `EnterMovementMode()`, `EnterAttackMode()`, or `EnterAbilityMode()`
2. **Highlights Update**: Service calculates valid targets, raises `OnHighlightsChanged`
3. **User Clicks Cell**: `HandleCellClick(position)` validates and either:
   - Raises `OnTargetingComplete(success)` if valid
   - Raises `OnTargetingComplete(failure)` if invalid
4. **Cancel**: Right-click or Escape calls `CancelTargeting()`

## Key Components

### GridInteractionMode Enum
```csharp
public enum GridInteractionMode { None, Movement, Attack, Ability }
```

### TargetingResult Record
```csharp
public record TargetingResult(
    GridInteractionMode Mode,
    GridPosition Target,
    bool Success,
    string? Message = null);
```

### ViewModel Integration
```csharp
// Subscribe to service events
InteractionService.OnHighlightsChanged += RefreshHighlights;
InteractionService.OnTargetingComplete += HandleTargetingComplete;

// RefreshHighlights updates cell highlighting
foreach (var highlight in InteractionService.GetHighlightedCells())
{
    var cell = GetCellAt(highlight.Position);
    cell.IsHighlighted = true;
    cell.HighlightType = highlight.Type;
}
```

## Test Coverage

| Test | Purpose |
|------|---------|
| `EnterMovementMode_SetsCorrectState` | Verifies mode and IsTargeting |
| `EnterMovementMode_CalculatesReachableCells` | Validates range calculation |
| `CancelTargeting_ClearsState` | Ensures clean state reset |
| `HandleCellClick_OnValidTarget_RaisesCompletionEvent` | Success path |
| `HandleCellClick_OnInvalidTarget_ReturnsFailure` | Failure path |
| `GetHighlightedCells_ReturnsCorrectType_ForMovement` | HighlightType mapping |
| `HandleCellHover_UpdatesHoverInfo` | Tooltip data generation |

## Verification

```bash
# Build
dotnet build --no-restore
# 0 errors, 0 warnings

# Tests
dotnet test --filter "GridInteractionService"
# 8 passed
```
