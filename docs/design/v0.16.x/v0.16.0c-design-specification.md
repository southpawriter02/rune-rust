# v0.16.0c Design Specification: Drop Probability Tables

**Version:** 0.16.0c  
**Phase Name:** Drop Probability Tables  
**Parent Version:** v0.16.0 (Quality Tier System)  
**Prerequisites:** v0.16.0a Complete (Quality Tier Enum), v0.16.0b Complete (Stat Scaling)  
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [EnemyDropClass Enum](#4-enemydropclass-enum)
5. [DropProbabilityEntry Value Object](#5-dropprobabilityentry-value-object)
6. [DropRollResult Value Object](#6-droprollresult-value-object)
7. [IDropTableProvider Interface](#7-idroptableprovider-interface)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the drop probability table system that determines what quality tier of loot an enemy drops when defeated. Different enemy classes have distinct probability distributions, creating a meaningful loot progression where stronger enemies yield better rewards.

The five enemy drop classes are:

- **Trash (Servitor)**: Common fodder, drops Tier 0-1 with 10% no-drop chance
- **Standard (Drone)**: Regular enemies, guaranteed drops of Tier 1-3
- **Elite (Warden)**: Stronger enemies, higher chance of Tier 3-4
- **MiniBoss**: Powerful mid-bosses, guaranteed drops with 30% Myth-Forged chance
- **Boss**: Main bosses, 70% Myth-Forged, 30% Optimized, always drops

The probability system uses **weighted random selection** where each tier has a percentage chance, and the total probabilities (including no-drop) sum to 100%.

### 1.2 Key Deliverables

| Category          | Items                                         |
| ----------------- | --------------------------------------------- |
| **Enums**         | `EnemyDropClass`                              |
| **Value Objects** | `DropProbabilityEntry`, `DropRollResult`      |
| **Interfaces**    | `IDropTableProvider`                          |
| **Configuration** | `drop-tables.json`, `drop-tables.schema.json` |
| **Tests**         | ~4 unit tests                                 |

### 1.3 Architectural Significance

This version establishes the **Drop Table Pattern** that will be used throughout the loot system:

- **Class-Based Probabilities**: Each enemy class has a fixed probability distribution
- **Weighted Selection Algorithm**: Cumulative probability rolling for tier selection
- **No-Drop Support**: Some enemy classes can drop nothing
- **Configuration-Driven**: All probabilities loaded from `drop-tables.json`
- **Abstract Provider**: `IDropTableProvider` abstracts data source

---

## 2. Feature Overview

```
v0.16.0c Drop Probability Tables
├── EnemyDropClass Enum
│   ├── Trash (0) — Servitor, weak enemies
│   ├── Standard (1) — Drone, regular combat
│   ├── Elite (2) — Warden, tougher fights
│   ├── MiniBoss (3) — Mid-bosses
│   └── Boss (4) — Main bosses
├── DropProbabilityEntry Value Object
│   ├── EnemyClass: EnemyDropClass
│   ├── TierProbabilities: Dictionary<QualityTier, decimal>
│   ├── NoDropChance: decimal
│   ├── RollDrop(random): DropRollResult
│   └── Validate(): bool
├── DropRollResult Value Object
│   ├── DroppedTier: QualityTier?
│   ├── IsNoDrop: bool
│   └── RolledValue: decimal (for debugging)
└── IDropTableProvider Interface
    ├── GetDropEntry(enemyClass): DropProbabilityEntry
    ├── RollDrop(enemyClass, random): DropRollResult
    └── ValidateConfiguration(): bool
```

### 2.1 Scope Alignment

**In Scope:**

- `EnemyDropClass` enum with five enemy classifications
- `DropProbabilityEntry` value object with tier probabilities
- `DropRollResult` value object for drop outcomes
- `IDropTableProvider` interface for drop table access
- Weighted probability selection algorithm
- `drop-tables.json` configuration file
- `drop-tables.schema.json` validation schema

**Out of Scope:**

- Loot service integration (v0.16.0d)
- Smart loot filtering by class (v0.16.3)
- Container loot tables (v0.16.4)
- Unique item drops (v0.16.5)
- Monster entity association with drop classes

---

## 3. Architecture Diagrams

### 3.1 Drop Probability System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  DROP PROBABILITY SYSTEM OVERVIEW                    │
└─────────────────────────────────────────────────────────────────────┘

    Defeated Enemy
           │
           │  Has EnemyDropClass
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        EnemyDropClass                                │
├─────────────────────────────────────────────────────────────────────┤
│  Trash (0)   │  Standard (1)  │  Elite (2)  │                       │
│  MiniBoss (3)│  Boss (4)      │             │                       │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Lookup drop table
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      IDropTableProvider                              │
├─────────────────────────────────────────────────────────────────────┤
│  + GetDropEntry(enemyClass): DropProbabilityEntry                   │
│  + RollDrop(enemyClass, random): DropRollResult                     │
│  + ValidateConfiguration(): bool                                     │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Get probability distribution
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     DropProbabilityEntry                             │
├─────────────────────────────────────────────────────────────────────┤
│  EnemyClass: EnemyDropClass                                         │
│  TierProbabilities: { T0: 60%, T1: 30%, T2: 0%, T3: 0%, T4: 0% }    │
│  NoDropChance: 10%                                                  │
│  RollDrop(random): DropRollResult                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Perform weighted roll
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       DropRollResult                                 │
├─────────────────────────────────────────────────────────────────────┤
│  DroppedTier: QualityTier.Scavenged (or null if no drop)            │
│  IsNoDrop: false                                                    │
│  RolledValue: 0.45 (for debugging)                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Weighted Probability Selection Algorithm

```
┌─────────────────────────────────────────────────────────────────────┐
│              WEIGHTED PROBABILITY SELECTION ALGORITHM                │
└─────────────────────────────────────────────────────────────────────┘

    Example: Trash Enemy (Servitor)
    ┌────────────────────────────────────────────────────────────────┐
    │  Tier 0 (JuryRigged): 60%                                      │
    │  Tier 1 (Scavenged):  30%                                      │
    │  Tier 2 (ClanForged):  0%                                      │
    │  Tier 3 (Optimized):   0%                                      │
    │  Tier 4 (MythForged):  0%                                      │
    │  No Drop:             10%                                      │
    │  ─────────────────────────                                     │
    │  TOTAL:              100%                                      │
    └────────────────────────────────────────────────────────────────┘

    Algorithm:
    ┌────────────────────────────────────────────────────────────────┐
    │  1. Roll random number 0.0 to 1.0                              │
    │     Example: rolled = 0.75                                     │
    │                                                                │
    │  2. Build cumulative thresholds:                               │
    │     [0.00 - 0.60) → Tier 0                                     │
    │     [0.60 - 0.90) → Tier 1                                     │
    │     [0.90 - 0.90) → Tier 2 (0%)                               │
    │     [0.90 - 0.90) → Tier 3 (0%)                               │
    │     [0.90 - 0.90) → Tier 4 (0%)                               │
    │     [0.90 - 1.00) → No Drop                                    │
    │                                                                │
    │  3. Find bucket containing rolled value:                       │
    │     0.75 is in [0.60 - 0.90) → Tier 1 (Scavenged)             │
    │                                                                │
    │  4. Return result:                                             │
    │     DropRollResult { DroppedTier: Scavenged, IsNoDrop: false } │
    └────────────────────────────────────────────────────────────────┘

    Visualization (Trash Enemy probability line):
    ┌─────────────────────────────────────────────────────────────────┐
    │  0.0          0.60         0.90   1.0                           │
    │   ├────────────┼────────────┼──────┤                            │
    │   │   Tier 0   │   Tier 1   │ None │                            │
    │   │   (60%)    │   (30%)    │(10%) │                            │
    │   └────────────┴────────────┴──────┘                            │
    │                      ▲                                          │
    │                    0.75 = Tier 1                                │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  LootNotification                                                    │
│  └── Uses DropRollResult.DroppedTier to color loot messages         │
│                                                                      │
│  CombatLogView                                                       │
│  └── Displays "Enemy dropped [Tier] Item" messages                  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   DropTableProvider                            │  │
│  │              (implements IDropTableProvider)                   │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetDropEntry(class): DropProbabilityEntry                  │  │
│  │  + RollDrop(class, random): DropRollResult                    │  │
│  │  + ValidateConfiguration(): bool                              │  │
│  │                                                               │  │
│  │  - LoadConfiguration(): void                                  │  │
│  │  - _dropTables: Dictionary<EnemyDropClass, DropProbEntry>     │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  LootService (v0.16.0d)                                              │
│  └── Uses IDropTableProvider to determine drop tier                 │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │    EnemyDropClass       │  │    DropProbabilityEntry         │  │
│  │        (Enum)           │  │      (Value Object)             │  │
│  ├─────────────────────────┤  ├─────────────────────────────────┤  │
│  │ Trash = 0               │  │ EnemyClass: EnemyDropClass      │  │
│  │ Standard = 1            │  │ TierProbabilities: Dict         │  │
│  │ Elite = 2               │  │ NoDropChance: decimal           │  │
│  │ MiniBoss = 3            │  │ RollDrop(random): result        │  │
│  │ Boss = 4                │  │ Validate(): bool                │  │
│  └─────────────────────────┘  └─────────────────────────────────┘  │
│                                                                      │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │     DropRollResult      │  │        QualityTier              │  │
│  │     (Value Object)      │  │        (from v0.16.0a)          │  │
│  ├─────────────────────────┤  ├─────────────────────────────────┤  │
│  │ DroppedTier: Tier?      │  │ JuryRigged = 0                  │  │
│  │ IsNoDrop: bool          │  │ Scavenged = 1                   │  │
│  │ RolledValue: decimal    │  │ ClanForged = 2                  │  │
│  └─────────────────────────┘  │ Optimized = 3                   │  │
│                               │ MythForged = 4                  │  │
│                               └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Drop Roll Decision Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                     DROP ROLL DECISION FLOW                          │
└─────────────────────────────────────────────────────────────────────┘

    Enemy Defeated
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  1. GET ENEMY DROP CLASS                                        │
    ├─────────────────────────────────────────────────────────────────┤
    │  Monster.DropClass → EnemyDropClass                             │
    │                                                                  │
    │  Example mappings:                                              │
    │    - Skeleton → Trash                                           │
    │    - Servitor → Trash                                           │
    │    - Drone → Standard                                           │
    │    - Warden → Elite                                             │
    │    - Chamber Guardian → MiniBoss                                │
    │    - Dungeon Lord → Boss                                        │
    └─────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  2. GET DROP PROBABILITY ENTRY                                  │
    ├─────────────────────────────────────────────────────────────────┤
    │  IDropTableProvider.GetDropEntry(enemyClass)                    │
    │                                                                  │
    │  Returns DropProbabilityEntry with tier probabilities           │
    └─────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  3. ROLL FOR DROP                                               │
    ├─────────────────────────────────────────────────────────────────┤
    │  entry.RollDrop(random)                                         │
    │                                                                  │
    │  - Generate random 0.0-1.0                                      │
    │  - Walk cumulative probabilities                                │
    │  - Return matching QualityTier or no-drop                       │
    └─────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  4. CHECK RESULT                                                │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │     IsNoDrop == true?                                           │
    │        YES ─────────────────────────────────────────────────┐   │
    │        │ "The enemy dropped nothing."                       │   │
    │        │ ← Exit, no item generated                          │   │
    │        ▼                                                    │   │
    │     ┌─────────────────────────────────────────────────────┐ │   │
    │     │ NO: DroppedTier is set                              │ │   │
    │     │                                                     │ │   │
    │     │ → Pass tier to LootService.GenerateItem(tier)       │ │   │
    │     │ → Apply stat scaling from v0.16.0b                  │ │   │
    │     │ → Present item to player                            │ │   │
    │     └─────────────────────────────────────────────────────┘ │   │
    │                                                             │   │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.5 Enemy Drop Class to Monster Mapping (Reference)

```
┌─────────────────────────────────────────────────────────────────────┐
│            ENEMY DROP CLASS TO MONSTER TYPE MAPPING                  │
│                    (For Reference - v0.16.0d)                        │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │  EnemyDropClass.Trash                                           │
    ├─────────────────────────────────────────────────────────────────┤
    │  - Servitors (all types)                                        │
    │  - Basic Undead (Skeletons, Zombies)                            │
    │  - Vermin (Rats, Spiders)                                       │
    │  - Swarm creatures                                              │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │  EnemyDropClass.Standard                                        │
    ├─────────────────────────────────────────────────────────────────┤
    │  - Drones (all types)                                           │
    │  - Standard humanoids                                           │
    │  - Pack leaders                                                 │
    │  - Regular dungeon inhabitants                                  │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │  EnemyDropClass.Elite                                           │
    ├─────────────────────────────────────────────────────────────────┤
    │  - Wardens (all types)                                          │
    │  - Champion variants                                            │
    │  - Special patrol enemies                                       │
    │  - Named elites                                                 │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │  EnemyDropClass.MiniBoss                                        │
    ├─────────────────────────────────────────────────────────────────┤
    │  - Chamber Guardians                                            │
    │  - Gate Keepers                                                 │
    │  - Optional challenge bosses                                    │
    │  - Area sub-bosses                                              │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │  EnemyDropClass.Boss                                            │
    ├─────────────────────────────────────────────────────────────────┤
    │  - Dungeon Lords                                                │
    │  - World Bosses                                                 │
    │  - Story-critical enemies                                       │
    │  - Final area bosses                                            │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. EnemyDropClass Enum

### 4.1 Purpose

The `EnemyDropClass` enum classifies enemies by their loot potential. This classification determines what quality tiers of items they can drop and at what probability.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/EnemyDropClass.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Classifies enemies by their loot drop potential.
/// </summary>
/// <remarks>
/// <para>
/// Enemy drop classes determine the probability distribution of quality
/// tiers when an enemy is defeated. Higher classes have better chances
/// of dropping higher-tier equipment.
/// </para>
/// <para>
/// The classification loosely maps to enemy threat levels:
/// - Trash: Weak fodder enemies (Servitors)
/// - Standard: Regular combat encounters (Drones)
/// - Elite: Challenging enemies (Wardens)
/// - MiniBoss: Mid-dungeon bosses
/// - Boss: Major bosses with guaranteed high-tier drops
/// </para>
/// </remarks>
public enum EnemyDropClass
{
    /// <summary>
    /// Weak fodder enemies with poor drop rates.
    /// </summary>
    /// <remarks>
    /// Trash enemies (e.g., Servitors) primarily drop Tier 0-1 items
    /// and have a 10% chance of dropping nothing.
    /// </remarks>
    Trash = 0,

    /// <summary>
    /// Standard combat enemies with decent drop rates.
    /// </summary>
    /// <remarks>
    /// Standard enemies (e.g., Drones) are guaranteed to drop something
    /// and can drop up to Tier 3 items.
    /// </remarks>
    Standard = 1,

    /// <summary>
    /// Challenging elite enemies with good drop rates.
    /// </summary>
    /// <remarks>
    /// Elite enemies (e.g., Wardens) are guaranteed drops with a small
    /// chance of Tier 4 items.
    /// </remarks>
    Elite = 2,

    /// <summary>
    /// Mid-dungeon bosses with excellent drop rates.
    /// </summary>
    /// <remarks>
    /// MiniBosses are guaranteed to drop Tier 2+ items with a 30%
    /// chance of Tier 4 (Myth-Forged) equipment.
    /// </remarks>
    MiniBoss = 3,

    /// <summary>
    /// Major bosses with the best drop rates.
    /// </summary>
    /// <remarks>
    /// Bosses always drop high-tier items: 70% Tier 4 (Myth-Forged),
    /// 30% Tier 3 (Optimized). Never drops nothing.
    /// </remarks>
    Boss = 4
}
```

### 4.3 Drop Class Characteristics

| Class    | Tier Range | No-Drop Chance | Best Tier Chance | Design Intent             |
| -------- | ---------- | -------------- | ---------------- | ------------------------- |
| Trash    | 0-1        | 10%            | 30% T1           | Clear quickly, low reward |
| Standard | 1-3        | 0%             | 20% T3           | Core gameplay loop        |
| Elite    | 2-4        | 0%             | 10% T4           | Risk/reward encounters    |
| MiniBoss | 2-4        | 0%             | 30% T4           | Memorable milestones      |
| Boss     | 3-4        | 0%             | 70% T4           | Climactic rewards         |

---

## 5. DropProbabilityEntry Value Object

### 5.1 Purpose

The `DropProbabilityEntry` value object encapsulates the probability distribution for a single enemy drop class. It contains the chance of each quality tier and the no-drop chance, and includes logic to roll for a drop result.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/DropProbabilityEntry.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the drop probability distribution for an enemy class.
/// </summary>
/// <remarks>
/// <para>
/// Each enemy class has a fixed probability distribution that determines
/// what quality tier of item drops when the enemy is defeated. The sum
/// of all tier probabilities plus the no-drop chance must equal 1.0 (100%).
/// </para>
/// <para>
/// The <see cref="RollDrop"/> method implements weighted random selection
/// using cumulative probability thresholds.
/// </para>
/// </remarks>
public sealed class DropProbabilityEntry
{
    /// <summary>
    /// Gets the enemy class this entry applies to.
    /// </summary>
    public EnemyDropClass EnemyClass { get; }

    /// <summary>
    /// Gets the probability for each quality tier (0.0-1.0).
    /// </summary>
    public IReadOnlyDictionary<QualityTier, decimal> TierProbabilities { get; }

    /// <summary>
    /// Gets the chance of no drop occurring (0.0-1.0).
    /// </summary>
    public decimal NoDropChance { get; }

    /// <summary>
    /// Gets whether this entry can result in no drop.
    /// </summary>
    public bool CanDropNothing => NoDropChance > 0;

    /// <summary>
    /// Gets whether this entry guarantees a drop.
    /// </summary>
    public bool GuaranteedDrop => NoDropChance == 0;

    /// <summary>
    /// Gets the highest tier that can drop from this class.
    /// </summary>
    public QualityTier HighestPossibleTier =>
        TierProbabilities
            .Where(kvp => kvp.Value > 0)
            .OrderByDescending(kvp => (int)kvp.Key)
            .Select(kvp => kvp.Key)
            .FirstOrDefault();

    // Private constructor for factory method
    private DropProbabilityEntry(
        EnemyDropClass enemyClass,
        IReadOnlyDictionary<QualityTier, decimal> tierProbabilities,
        decimal noDropChance)
    {
        EnemyClass = enemyClass;
        TierProbabilities = tierProbabilities;
        NoDropChance = noDropChance;
    }

    /// <summary>
    /// Creates a new DropProbabilityEntry with validation.
    /// </summary>
    /// <param name="enemyClass">The enemy drop class.</param>
    /// <param name="tierProbabilities">Probability for each quality tier.</param>
    /// <param name="noDropChance">Chance of no drop.</param>
    /// <returns>A new DropProbabilityEntry instance.</returns>
    /// <exception cref="ArgumentNullException">Thrown when tierProbabilities is null.</exception>
    /// <exception cref="ArgumentException">Thrown when probabilities don't sum to 1.0.</exception>
    public static DropProbabilityEntry Create(
        EnemyDropClass enemyClass,
        IReadOnlyDictionary<QualityTier, decimal> tierProbabilities,
        decimal noDropChance)
    {
        ArgumentNullException.ThrowIfNull(tierProbabilities);
        ArgumentOutOfRangeException.ThrowIfNegative(noDropChance);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(noDropChance, 1.0m);

        // Validate probabilities sum to 1.0
        var totalProbability = tierProbabilities.Values.Sum() + noDropChance;
        if (Math.Abs(totalProbability - 1.0m) > 0.001m)
        {
            throw new ArgumentException(
                $"Probabilities must sum to 1.0, but got {totalProbability:F3}",
                nameof(tierProbabilities));
        }

        // Validate no negative probabilities
        if (tierProbabilities.Any(kvp => kvp.Value < 0))
        {
            throw new ArgumentException(
                "Tier probabilities cannot be negative",
                nameof(tierProbabilities));
        }

        return new DropProbabilityEntry(enemyClass, tierProbabilities, noDropChance);
    }

    /// <summary>
    /// Rolls for a drop result using weighted random selection.
    /// </summary>
    /// <param name="random">Random number generator.</param>
    /// <returns>The drop roll result indicating tier or no-drop.</returns>
    /// <exception cref="ArgumentNullException">Thrown when random is null.</exception>
    public DropRollResult RollDrop(Random random)
    {
        ArgumentNullException.ThrowIfNull(random);

        var roll = (decimal)random.NextDouble();
        var cumulative = 0m;

        // Check each tier in order
        foreach (var tier in Enum.GetValues<QualityTier>())
        {
            if (TierProbabilities.TryGetValue(tier, out var probability) && probability > 0)
            {
                cumulative += probability;
                if (roll < cumulative)
                {
                    return DropRollResult.Dropped(tier, roll);
                }
            }
        }

        // If we get here, it's a no-drop
        return DropRollResult.NoDrop(roll);
    }

    /// <summary>
    /// Gets the probability for a specific tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>The probability (0.0-1.0), or 0 if tier not in table.</returns>
    public decimal GetTierProbability(QualityTier tier)
    {
        return TierProbabilities.TryGetValue(tier, out var prob) ? prob : 0m;
    }

    /// <summary>
    /// Validates that this entry is properly configured.
    /// </summary>
    /// <returns>True if valid, false otherwise.</returns>
    public bool Validate()
    {
        var total = TierProbabilities.Values.Sum() + NoDropChance;
        return Math.Abs(total - 1.0m) < 0.001m;
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString()
    {
        var tierStr = string.Join(", ",
            TierProbabilities
                .Where(kvp => kvp.Value > 0)
                .OrderBy(kvp => (int)kvp.Key)
                .Select(kvp => $"T{(int)kvp.Key}:{kvp.Value:P0}"));
        var noDropStr = NoDropChance > 0 ? $", None:{NoDropChance:P0}" : "";
        return $"{EnemyClass}: {tierStr}{noDropStr}";
    }
}
```

---

## 6. DropRollResult Value Object

### 6.1 Purpose

The `DropRollResult` value object represents the outcome of a drop probability roll. It indicates either the quality tier that was rolled or that no drop occurred.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/DropRollResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a drop probability roll.
/// </summary>
/// <remarks>
/// <para>
/// A drop roll result is either a successful drop with a specific quality
/// tier, or a "no drop" result where the enemy dropped nothing.
/// </para>
/// <para>
/// The <see cref="RolledValue"/> property is included for debugging and
/// logging purposes to understand the random distribution over time.
/// </para>
/// </remarks>
/// <param name="DroppedTier">The quality tier that was rolled, or null for no-drop.</param>
/// <param name="IsNoDrop">Whether this result is a no-drop.</param>
/// <param name="RolledValue">The random value that was rolled (0.0-1.0) for debugging.</param>
public readonly record struct DropRollResult(
    QualityTier? DroppedTier,
    bool IsNoDrop,
    decimal RolledValue)
{
    /// <summary>
    /// Gets whether a valid tier was rolled.
    /// </summary>
    public bool HasDrop => !IsNoDrop && DroppedTier.HasValue;

    /// <summary>
    /// Gets the dropped tier, throwing if no drop occurred.
    /// </summary>
    /// <exception cref="InvalidOperationException">Thrown when IsNoDrop is true.</exception>
    public QualityTier Tier =>
        DroppedTier ?? throw new InvalidOperationException(
            "Cannot access Tier on a no-drop result.");

    /// <summary>
    /// Creates a successful drop result.
    /// </summary>
    /// <param name="tier">The quality tier that was rolled.</param>
    /// <param name="rolledValue">The random value for debugging.</param>
    /// <returns>A drop result with the specified tier.</returns>
    public static DropRollResult Dropped(QualityTier tier, decimal rolledValue)
    {
        return new DropRollResult(tier, false, rolledValue);
    }

    /// <summary>
    /// Creates a no-drop result.
    /// </summary>
    /// <param name="rolledValue">The random value for debugging.</param>
    /// <returns>A no-drop result.</returns>
    public static DropRollResult NoDrop(decimal rolledValue)
    {
        return new DropRollResult(null, true, rolledValue);
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString()
    {
        if (IsNoDrop)
        {
            return $"No Drop (rolled {RolledValue:F3})";
        }
        return $"{DroppedTier} (rolled {RolledValue:F3})";
    }
}
```

---

## 7. IDropTableProvider Interface

### 7.1 Purpose

The `IDropTableProvider` interface defines the contract for accessing drop probability tables. This abstraction allows the drop table source to be configured (JSON, database, in-memory) without affecting consuming code.

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IDropTableProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to enemy drop probability tables.
/// </summary>
/// <remarks>
/// <para>
/// This interface abstracts the source of drop probability data, allowing
/// it to be loaded from configuration files, databases, or hardcoded defaults.
/// </para>
/// <para>
/// Implementations should cache loaded tables for performance and validate
/// that all enemy drop classes have corresponding probability entries.
/// </para>
/// </remarks>
public interface IDropTableProvider
{
    /// <summary>
    /// Gets the drop probability entry for a specific enemy class.
    /// </summary>
    /// <param name="enemyClass">The enemy drop class to get probabilities for.</param>
    /// <returns>The DropProbabilityEntry for the specified class.</returns>
    /// <exception cref="ArgumentException">Thrown when entry for class is not found.</exception>
    DropProbabilityEntry GetDropEntry(EnemyDropClass enemyClass);

    /// <summary>
    /// Rolls for a drop from the specified enemy class.
    /// </summary>
    /// <param name="enemyClass">The enemy drop class.</param>
    /// <param name="random">Random number generator.</param>
    /// <returns>The drop roll result.</returns>
    /// <exception cref="ArgumentException">Thrown when entry for class is not found.</exception>
    DropRollResult RollDrop(EnemyDropClass enemyClass, Random random);

    /// <summary>
    /// Gets all drop probability entries, ordered by enemy class.
    /// </summary>
    /// <returns>A read-only list of all drop probability entries.</returns>
    IReadOnlyList<DropProbabilityEntry> GetAllEntries();

    /// <summary>
    /// Validates that all required enemy classes have probability entries.
    /// </summary>
    /// <returns>True if all classes are configured, false otherwise.</returns>
    bool ValidateConfiguration();

    /// <summary>
    /// Gets the highest tier that can drop from a specific enemy class.
    /// </summary>
    /// <param name="enemyClass">The enemy drop class.</param>
    /// <returns>The highest quality tier with non-zero probability.</returns>
    QualityTier GetHighestPossibleTier(EnemyDropClass enemyClass);

    /// <summary>
    /// Gets whether an enemy class can result in no drop.
    /// </summary>
    /// <param name="enemyClass">The enemy drop class.</param>
    /// <returns>True if the class has a non-zero no-drop chance.</returns>
    bool CanDropNothing(EnemyDropClass enemyClass);
}
```

### 7.3 Usage Examples

```csharp
// Roll a drop from a defeated enemy
var enemyClass = EnemyDropClass.Standard;
var result = _dropTableProvider.RollDrop(enemyClass, random);

if (result.IsNoDrop)
{
    Console.WriteLine("The enemy dropped nothing.");
}
else
{
    Console.WriteLine($"The enemy dropped a {result.Tier} item!");
    // Pass to loot service for item generation
}

// Check drop class characteristics
var bossEntry = _dropTableProvider.GetDropEntry(EnemyDropClass.Boss);
Console.WriteLine($"Boss guarantees drop: {bossEntry.GuaranteedDrop}");  // true
Console.WriteLine($"Boss best tier: {bossEntry.HighestPossibleTier}");  // MythForged

// Get probability for specific tier
var tier4Chance = bossEntry.GetTierProbability(QualityTier.MythForged);
Console.WriteLine($"Boss Myth-Forged chance: {tier4Chance:P0}");  // 70%

// Validate configuration on startup
if (!_dropTableProvider.ValidateConfiguration())
{
    _logger.LogWarning("Drop table configuration is incomplete");
}
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

| Type                   | Layer       | Category     | Description                        |
| ---------------------- | ----------- | ------------ | ---------------------------------- |
| `EnemyDropClass`       | Domain      | Enum         | Enemy loot classification          |
| `DropProbabilityEntry` | Domain      | Value Object | Probability distribution per class |
| `DropRollResult`       | Domain      | Value Object | Outcome of drop roll               |
| `IDropTableProvider`   | Application | Interface    | Drop table data access             |

### 8.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Enums/
│   └── EnemyDropClass.cs                     ← NEW
└── ValueObjects/
    ├── DropProbabilityEntry.cs               ← NEW
    └── DropRollResult.cs                     ← NEW

src/Core/RuneAndRust.Application/
└── Interfaces/
    └── IDropTableProvider.cs                 ← NEW

config/
├── drop-tables.json                          ← NEW
└── schemas/
    └── drop-tables.schema.json               ← NEW
```

### 8.3 Entity Relationships

```
┌─────────────────┐         ┌─────────────────────┐
│ EnemyDropClass  │◄────────│ DropProbabilityEntry│
│     (Enum)      │  1:1    │   (Value Object)    │
└─────────────────┘         └──────────┬──────────┘
                                       │
                                       │ indexes by
                                       ▼
                            ┌─────────────────────┐
                            │    QualityTier      │
                            │  (from v0.16.0a)    │
                            └─────────────────────┘

┌─────────────────────┐         ┌─────────────────────┐
│  IDropTableProvider │─────────│  DropRollResult     │
│    (Interface)      │ returns │   (Value Object)    │
└─────────────────────┘         └─────────────────────┘
```

---

## 9. Configuration File Schemas

### 9.1 drop-tables.json

**File:** `config/drop-tables.json`

```json
{
    "$schema": "./schemas/drop-tables.schema.json",
    "dropTables": [
        {
            "enemyClass": "Trash",
            "enemyClassValue": 0,
            "description": "Weak fodder enemies (Servitors)",
            "tierProbabilities": {
                "JuryRigged": 0.6,
                "Scavenged": 0.3,
                "ClanForged": 0.0,
                "Optimized": 0.0,
                "MythForged": 0.0
            },
            "noDropChance": 0.1
        },
        {
            "enemyClass": "Standard",
            "enemyClassValue": 1,
            "description": "Regular combat enemies (Drones)",
            "tierProbabilities": {
                "JuryRigged": 0.0,
                "Scavenged": 0.4,
                "ClanForged": 0.4,
                "Optimized": 0.2,
                "MythForged": 0.0
            },
            "noDropChance": 0.0
        },
        {
            "enemyClass": "Elite",
            "enemyClassValue": 2,
            "description": "Challenging elite enemies (Wardens)",
            "tierProbabilities": {
                "JuryRigged": 0.0,
                "Scavenged": 0.0,
                "ClanForged": 0.4,
                "Optimized": 0.5,
                "MythForged": 0.1
            },
            "noDropChance": 0.0
        },
        {
            "enemyClass": "MiniBoss",
            "enemyClassValue": 3,
            "description": "Mid-dungeon bosses",
            "tierProbabilities": {
                "JuryRigged": 0.0,
                "Scavenged": 0.0,
                "ClanForged": 0.2,
                "Optimized": 0.5,
                "MythForged": 0.3
            },
            "noDropChance": 0.0
        },
        {
            "enemyClass": "Boss",
            "enemyClassValue": 4,
            "description": "Major dungeon bosses",
            "tierProbabilities": {
                "JuryRigged": 0.0,
                "Scavenged": 0.0,
                "ClanForged": 0.0,
                "Optimized": 0.3,
                "MythForged": 0.7
            },
            "noDropChance": 0.0
        }
    ]
}
```

### 9.2 drop-tables.schema.json

**File:** `config/schemas/drop-tables.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "drop-tables.schema.json",
    "title": "Drop Tables Configuration",
    "description": "Defines drop probability tables by enemy class",
    "type": "object",
    "required": ["dropTables"],
    "properties": {
        "$schema": {
            "type": "string",
            "description": "JSON schema reference"
        },
        "dropTables": {
            "type": "array",
            "description": "Drop probability entries for each enemy class",
            "minItems": 5,
            "maxItems": 5,
            "items": {
                "$ref": "#/$defs/dropTableEntry"
            }
        }
    },
    "$defs": {
        "enemyClassEnum": {
            "type": "string",
            "enum": ["Trash", "Standard", "Elite", "MiniBoss", "Boss"]
        },
        "tierProbabilities": {
            "type": "object",
            "description": "Probability for each quality tier (0.0-1.0)",
            "required": [
                "JuryRigged",
                "Scavenged",
                "ClanForged",
                "Optimized",
                "MythForged"
            ],
            "properties": {
                "JuryRigged": { "type": "number", "minimum": 0, "maximum": 1 },
                "Scavenged": { "type": "number", "minimum": 0, "maximum": 1 },
                "ClanForged": { "type": "number", "minimum": 0, "maximum": 1 },
                "Optimized": { "type": "number", "minimum": 0, "maximum": 1 },
                "MythForged": { "type": "number", "minimum": 0, "maximum": 1 }
            },
            "additionalProperties": false
        },
        "dropTableEntry": {
            "type": "object",
            "required": [
                "enemyClass",
                "enemyClassValue",
                "tierProbabilities",
                "noDropChance"
            ],
            "properties": {
                "enemyClass": {
                    "$ref": "#/$defs/enemyClassEnum"
                },
                "enemyClassValue": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 4
                },
                "description": {
                    "type": "string",
                    "description": "Human-readable description of this enemy class"
                },
                "tierProbabilities": {
                    "$ref": "#/$defs/tierProbabilities"
                },
                "noDropChance": {
                    "type": "number",
                    "description": "Chance of no drop occurring (0.0-1.0)",
                    "minimum": 0,
                    "maximum": 1
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component           | Level       | Events                                              |
| ------------------- | ----------- | --------------------------------------------------- |
| `DropTableProvider` | Information | Configuration loaded, validation complete           |
| `DropTableProvider` | Debug       | Drop rolled, entry lookup                           |
| `DropTableProvider` | Warning     | Missing entry for enemy class                       |
| `DropTableProvider` | Error       | Configuration file not found, invalid probabilities |

### 10.2 Structured Logging Templates

```csharp
// Information - Configuration loaded
_logger.LogInformation(
    "Drop table configuration loaded. EntryCount={EntryCount}",
    entries.Count);

// Debug - Drop rolled
_logger.LogDebug(
    "Drop rolled. EnemyClass={EnemyClass}, Roll={RollValue:F3}, Result={Result}",
    enemyClass,
    result.RolledValue,
    result.IsNoDrop ? "NoDrop" : result.Tier.ToString());

// Debug - Entry lookup
_logger.LogDebug(
    "Drop entry retrieved. EnemyClass={EnemyClass}, HighestTier={HighestTier}, NoDrop={NoDropChance:P0}",
    enemyClass,
    entry.HighestPossibleTier,
    entry.NoDropChance);

// Warning - Missing entry
_logger.LogWarning(
    "Drop entry not found for enemy class. EnemyClass={EnemyClass}",
    enemyClass);

// Error - Invalid probabilities
_logger.LogError(
    "Invalid drop probabilities. EnemyClass={EnemyClass}, Total={Total:F3}, Expected=1.000",
    enemyClass,
    totalProbability);
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature                           | Test Count |
| --------------------------------- | ---------- |
| EnemyDropClass enum               | ~1         |
| DropProbabilityEntry value object | ~1         |
| DropRollResult value object       | ~1         |
| IDropTableProvider integration    | ~1         |
| **Total**                         | **~4**     |

### 11.2 Test Specifications

#### EnemyDropClassTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/Enums/EnemyDropClassTests.cs`

```csharp
[TestFixture]
public class EnemyDropClassTests
{
    [Test]
    public void EnemyDropClass_AllClassesHaveExpectedValues_ValuesMatchSpecification();

    [Test]
    public void EnemyDropClass_CanCastToInt_ReturnsCorrectValues();

    [Test]
    public void EnemyDropClass_AllFiveClassesDefined_CountEquals5();
}
```

#### DropProbabilityEntryTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DropProbabilityEntryTests.cs`

```csharp
[TestFixture]
public class DropProbabilityEntryTests
{
    [Test]
    public void Create_WithValidProbabilities_CreatesEntry();

    [Test]
    public void Create_WithProbabilitiesNotSummingTo100_ThrowsArgumentException();

    [Test]
    public void RollDrop_WithTrashEnemy_NeverReturnsHighTier();

    [Test]
    public void RollDrop_WithBossEnemy_NeverReturnsNoDrop();

    [Test]
    public void RollDrop_DistributesCorrectly_OverManyRuns();

    [Test]
    public void GetTierProbability_ReturnsCorrectValue();

    [Test]
    public void HighestPossibleTier_ReturnsCorrectTier();

    [Test]
    public void Validate_WithValidEntry_ReturnsTrue();
}
```

#### DropRollResultTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DropRollResultTests.cs`

```csharp
[TestFixture]
public class DropRollResultTests
{
    [Test]
    public void Dropped_CreatesDrppedResult_WithCorrectTier();

    [Test]
    public void NoDrop_CreatesNoDropResult_WithNullTier();

    [Test]
    public void Tier_WhenNoDrop_ThrowsInvalidOperationException();

    [Test]
    public void HasDrop_WhenDropped_ReturnsTrue();

    [Test]
    public void HasDrop_WhenNoDrop_ReturnsFalse();
}
```

---

## 12. Use Cases

### UC-001: Roll Drop from Defeated Enemy

**Actor:** Combat System / Loot Service  
**Flow:** Enemy defeated → Get enemy drop class → Call RollDrop() → Check result → Generate item if dropped

### UC-002: Validate Drop Tables on Startup

**Actor:** Application Startup  
**Flow:** Load configuration → Parse entries → Validate all classes present → Validate probabilities sum correctly → Log result

### UC-003: Display Enemy Loot Potential

**Actor:** Bestiary / Enemy Info UI  
**Flow:** Select enemy → Get drop class → Get drop entry → Show tier probability breakdown

### UC-004: Debug Drop Distribution

**Actor:** Developer / Tester  
**Flow:** Run many drops → Collect results → Verify distribution matches configured probabilities

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `EnemyDropClass.cs` enum created in `src/Core/RuneAndRust.Domain/Enums/`
- [ ] `DropProbabilityEntry.cs` value object created in `src/Core/RuneAndRust.Domain/ValueObjects/`
- [ ] `DropRollResult.cs` value object created in `src/Core/RuneAndRust.Domain/ValueObjects/`
- [ ] All types have complete XML documentation

### Application Layer

- [ ] `IDropTableProvider.cs` interface created in `src/Core/RuneAndRust.Application/Interfaces/`
- [ ] Interface has complete XML documentation

### Configuration Files

- [ ] `config/drop-tables.json` created with all 5 enemy classes
- [ ] `config/schemas/drop-tables.schema.json` created
- [ ] Configuration validates against schema
- [ ] All probabilities sum to 1.0 for each class

### Testing

- [ ] `EnemyDropClassTests.cs` created
- [ ] `DropProbabilityEntryTests.cs` created
- [ ] `DropRollResultTests.cs` created
- [ ] ~4 unit tests passing

### Documentation

- [ ] `v0.16.0c-changelog.md` created
- [ ] Inline code comments complete

---

## 14. Acceptance Criteria

### Functional

- [ ] `EnemyDropClass` enum defines exactly 5 classes with values 0-4
- [ ] `DropProbabilityEntry.Create()` validates probabilities sum to 1.0
- [ ] `DropProbabilityEntry.Create()` throws for negative probabilities
- [ ] `DropProbabilityEntry.RollDrop()` returns tier within probability distribution
- [ ] Trash enemies never drop Tier 2+ (ClanForged or higher)
- [ ] Boss enemies always drop something (0% no-drop chance)
- [ ] Boss enemies have 70% Myth-Forged, 30% Optimized probability
- [ ] `DropRollResult.Dropped()` creates successful drop result
- [ ] `DropRollResult.NoDrop()` creates no-drop result
- [ ] `IDropTableProvider.RollDrop()` delegates to entry correctly

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~4 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 15. Dependencies

### Required from v0.16.0a

| Type          | Location                    | Usage                               |
| ------------- | --------------------------- | ----------------------------------- |
| `QualityTier` | `RuneAndRust.Domain/Enums/` | Tier keys in probability dictionary |

### Required from v0.16.0b

| Type | Location | Usage                                |
| ---- | -------- | ------------------------------------ |
| N/A  | N/A      | No direct dependency on stat scaling |

### Provides to v0.16.0d

| Type                   | Usage                                 |
| ---------------------- | ------------------------------------- |
| `EnemyDropClass`       | Maps Monster entities to drop classes |
| `DropProbabilityEntry` | Used to roll drops in LootService     |
| `DropRollResult`       | Returned from drop rolls              |
| `IDropTableProvider`   | Injected into LootService             |

### Provides to v0.16.3+

| Type             | Usage                              |
| ---------------- | ---------------------------------- |
| `DropRollResult` | Extended with smart loot filtering |

---

## 16. Future Considerations

### Deferred to v0.16.0d

- **LootService Integration**: Using drop tables in actual loot generation
- **Monster to EnemyDropClass Mapping**: Associating monsters with drop classes
- **DroppedItem Enhancement**: Tracking tier on generated items

### Deferred to v0.16.3

- **Smart Loot Filtering**: Filtering drops by player class
- **Weighted Item Pools**: Per-class item type weighting

### Deferred to v0.16.4

- **Container Loot Tables**: Different probability distributions for containers
- **Biome Modifiers**: Adjusting drop rates by dungeon area

### Out of Scope

- **Dynamic Drop Rate Modifiers**: Luck stats, etc. not in current scope
- **Guaranteed First Drop**: No special first-kill mechanics planned
- **Drop Rate Display to Player**: UI showing exact percentages

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
