# v0.20.5c Changelog — Berserkr Tier 3 & Capstone Abilities

## Version: 0.20.5c

## Date: 2026-02-15

## Focus: Berserkr Specialization — Tier 3 Abilities (Fury of the Forlorn, Death Defiance) & Capstone (Avatar of Destruction)

---

## Added

### Domain Layer — Enums

- **`CrowdControlType`** — 10-value crowd control enum: Stun, Root, Fear, Charm, Paralyze, Slow, Prone, ForcedMovement, Sleep, Confusion. Used by Avatar of Destruction's CC immunity system.

### Domain Layer — Value Objects

- **`FuryCleavesResult`** — Sealed record (immutable, `init` properties) following `FuryStrikeResult` pattern. Properties: AttackRoll, TargetsHit (`IReadOnlyList<Guid>`), TargetsMissed, DamageDealt, RageSpent=30, CorruptionTriggered=true (always), CorruptionAmount=1 (always). Computed: TotalDamageAcrossTargets = DamageDealt × hits. Methods: GetHitCount(), GetMissCount(), WasEffective(), GetDamageBreakdown(), GetResultString().

- **`DeathDefianceState`** — Sealed record with `private set` + `static Create(Guid)` factory following `RecklessAssaultState` pattern. Properties: StateId, CharacterId, HasTriggeredThisCombat, TriggeredAt, DamagePreventedOnTrigger. Constant: RageGainOnTrigger=20. Methods: CanTrigger(), Trigger(int), ResetForNewCombat(), GetDescription().

- **`AvatarState`** — Sealed record with `private set` on TurnsRemaining + `static Create(Guid)` factory following `UnstoppableEffect` pattern. Properties: StateId, CharacterId, StartedAt, TurnsRemaining=2, DamageMultiplier=2.0f, MovementBonus=2, ImmuneToCrowdControl=true, CCImmunityList (all 10 types), CorruptionGenerated=2, WillCauseExhaustion=true. Constants: DefaultDuration=2, DefaultDamageMultiplier=2.0f, DefaultMovementBonus=2. Methods: Tick(), End(), IsActive(), GetDamageMultiplier(), IsImmuneToCC(CrowdControlType), GetDescription().

### Application Layer — Interface Extensions

- **`IBerserkrAbilityService`** — Extended with 5 Tier 3/Capstone methods:
  - `ExecuteFuryOfTheForlorn(Player, List<targets>)` — Cleave attack vs all adjacent enemies
  - `CheckDeathDefiance(Player, int)` — Passive death prevention check
  - `ExecuteAvatarOfDestruction(Player)` — Capstone transformation activation
  - `GetDeathDefianceState(Player)` — Query death defiance state
  - `GetAvatarState(Player)` — Query avatar transformation state

### Application Layer — Service Extensions

- **`BerserkrAbilityService`** — Extended with Tier 3 & Capstone implementations:
  - Fury of the Forlorn: 3 AP + 30 Rage, requires 80+ Rage, single attack roll vs each target's Defense individually, single damage roll (weapon + 3d6) applied to all hits, always +1 Corruption
  - Death Defiance: called after TakeDamage brings HP to 0, uses Heal(1) to restore to 1 HP, grants +20 Rage via AddRage, once per combat, no Corruption
  - Avatar of Destruction: 3 AP + exactly 100 Rage (all consumed), 2-turn transformation with 2× damage/CC immunity/+2 movement, once per combat, always +2 Corruption
  - `GetAbilityReadiness` extended with Tier 3/Capstone ability readiness checks
  - 6 new constants: FuryOfTheForlornApCost, FuryOfTheForlornRageCost, FuryOfTheForlornRageRequirement, DeathDefianceRageGain, AvatarOfDestructionApCost, AvatarOfDestructionRageCost

### Entity Extensions

- **`Player.cs`** — Berserkr Tier 3 & Capstone section added:
  - `DeathDefianceState? DeathDefianceState { get; set; }` — Death prevention state
  - `AvatarState? AvatarState { get; set; }` — Capstone transformation state
  - `HasDeathDefianceAvailable` — Computed property for death prevention readiness
  - `IsInAvatarState` — Computed property for transformation check

### Configuration

- Updated `config/abilities.json` with 3 Tier 3/Capstone Berserkr abilities:
  - `fury-of-the-forlorn`: Active, 3 AP + 30 Rage, requires 80+ Rage, cleave all adjacent, single roll vs each Defense, +1 Corruption always
  - `death-defiance`: Passive, prevent death once per combat, stay at 1 HP, +20 Rage on trigger, no Corruption
  - `avatar-of-destruction`: Ultimate, 3 AP + exactly 100 Rage, 2 turns, 2× damage, CC immune (10 types), +2 movement, once per combat, +2 Corruption always, exhaustion aftermath

### Unit Tests

- **`FuryCleavesResultTests`** — 14 tests: init properties, computed TotalDamageAcrossTargets, zero hits returns zero, RageSpent=30, CorruptionTriggered always true, CorruptionAmount always 1, GetHitCount, GetMissCount, WasEffective (true/false), GetDamageBreakdown (hits/no hits), GetResultString (hits+misses/all missed)
- **`DeathDefianceStateTests`** — 10 tests: Create factory, CanTrigger (true/false), Trigger records damage & timestamp, cannot trigger twice, RageGainOnTrigger==20, ResetForNewCombat clears state, ResetForNewCombat allows re-trigger, GetDescription (ready/used)
- **`AvatarStateTests`** — 17 tests: Create factory, GetDamageMultiplier (2.0 active, 1.0 expired), IsImmuneToCC for all 10 CC types, CCImmunityList contains 10, Tick countdown, Tick expires after two ticks, Tick floors at 0, End() makes inactive, IsActive (true/false), constants (DefaultDuration, DefaultDamageMultiplier, DefaultMovementBonus), CorruptionGenerated==2, WillCauseExhaustion==true, GetDescription (active/inactive)
- **`BerserkrAbilityServiceTests`** (extended) — 21 Tier 3/Capstone tests: Fury of the Forlorn (hits all/partial/insufficient rage/rage below 80/insufficient AP/no targets/always corruption/tier3 locked/ability not unlocked), Death Defiance (prevents lethal/non-lethal returns false/grants 20 rage/cannot trigger twice/ability not unlocked), Avatar of Destruction (at 100 rage/rage not 100/insufficient AP/already used/doubles damage/CC immunity all 10 types/always +2 corruption/capstone locked/spends all 100 rage), Readiness (tier 3 abilities/avatar requires exactly 100)

## Changed

- **`BerserkrAbilityService`** — Updated class XML docs to include Tier 3 and Capstone ability descriptions
- **`IBerserkrAbilityService`** — Added Tier 3 & Capstone method signatures with full XML documentation

## Design Decisions

- **Corruption before spend**: All ability methods evaluate Corruption risk BEFORE spending AP/Rage, consistent with the v0.20.5a/b design pattern. This ensures the player always sees the risk assessment before committing resources.
- **Death Defiance called after damage**: `CheckDeathDefiance` is called AFTER `TakeDamage` has already reduced HP to 0. The service then uses `player.Heal(1)` to restore to 1 HP, working within the Player entity's `private set` constraint on Health.
- **Avatar requires exactly 100 Rage**: Strict equality check (`== 100`), not `>= 100`. This follows the design spec's intent that the ultimate transformation demands total commitment of fury.
- **Shared capstone gate**: Uses existing `player.HasUsedCapstoneThisCombat` property (same as Skjaldmaer's TheWallLives) to enforce the once-per-combat restriction.
- **No changes to BerserkrCorruptionService**: The corruption service already handles all Tier 3/Capstone routing from v0.20.5a — FuryOfTheForlorn routes through `EvaluateRageThresholdRisk` (always triggers since ability requires 80+ Rage), AvatarOfDestruction always returns +2 Corruption, and DeathDefiance returns safe (no corruption risk).
- **No new dice methods needed**: Existing `RollD20()`, `Roll3D6()`, and `RollWeaponDamage()` suffice for Fury of the Forlorn's cleave mechanics.
- **Single roll cleave**: Fury of the Forlorn uses a single attack roll and a single damage roll, compared against each target's Defense individually. This ensures consistent damage across all targets while allowing individual hit/miss determination.

## Test Results

```
Berserkr tests: 125
     Passed: 125
     Failed: 0

Breakdown:
  RageResourceTests:              23 domain tests
  RecklessAssaultStateTests:      11 domain tests
  UnstoppableEffectTests:          6 domain tests
  IntimidationEffectTests:        12 domain tests (v0.20.5b)
  FuryCleavesResultTests:         14 domain tests (v0.20.5c)
  DeathDefianceStateTests:        10 domain tests (v0.20.5c)
  AvatarStateTests:               17 domain tests (v0.20.5c)
  BerserkrCorruptionServiceTests:  9 application tests
  BerserkrAbilityServiceTests:    23 application tests (v0.20.5c: +21 T3/Capstone)
```
