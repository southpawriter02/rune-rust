> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.0](../v0.3.x/v0.3.0.md).

# v0.3.0b Changelog: The Stain (Corruption & Tiers)

**Release Date:** 2025-12-20
**Milestone:** v0.3.0 - The Trauma Economy (2 of 3)
**Test Count:** 1638 tests (83 new)

---

## Summary

This release introduces the **Runic Blight Corruption** system, a 0-100 accumulating permanent resource representing the corrupting influence of the Runic Blight. Unlike Stress which can be mitigated by WILL rolls, **Corruption accumulates directly with NO mitigation** - it is a "High Water Mark" mechanic that scales up easily but requires rare, significant resources to lower. The system features a **6-tier classification** (Pristine → Tainted → Corrupted → Blighted → Fractured → Terminal) with escalating penalties affecting Max Aether Points and attributes. Reaching 100 Corruption triggers **Terminal Error** - the character becomes a Forlorn (unplayable). The Combat UI now displays corruption with a dark red/black color scheme, and the StatCalculationService applies corruption penalties to derived stats.

---

## New Features

### Runic Blight Corruption System

Core corruption mechanics:

| Component | Formula | Description |
|-----------|---------|-------------|
| **Max Corruption** | 100 (fixed) | All characters have 100 max corruption |
| **Accumulation** | Direct | NO mitigation from WILL - corruption is permanent |
| **Terminal Error** | Corruption = 100 | Character becomes Forlorn (unplayable) |
| **Purging** | Rare | Requires special rituals or artifacts |

### Corruption Tiers & Penalties

| Tier | Range | Max AP | WILL | WITS | UI Color |
|------|-------|--------|------|------|----------|
| Pristine | 0-20 | 100% | - | - | Green |
| Tainted | 21-40 | 100% | - | - | Grey |
| Corrupted | 41-60 | 90% | - | - | Maroon |
| Blighted | 61-80 | 80% | -1 | - | Red |
| Fractured | 81-99 | 60% | -2 | -1 | Bold Red |
| Terminal | 100 | 0% | -2 | -1 | White on Red |

### Corruption Penalty Integration

Corruption penalties now affect the StatCalculationService:

```
Effective WILL = Base WILL - Corruption WILL Penalty
Effective WITS = Base WITS - Corruption WITS Penalty
Base Max AP = 10 + (WILL * 5) for Mystics, 0 for others
Final Max AP = Base Max AP * Corruption Multiplier
```

**Example:** A Mystic with WILL 5 and 70 Corruption (Blighted):
- Effective WILL = 5 - 1 = 4
- Base Max AP = 10 + (4 * 5) = 30
- Final Max AP = 30 * 0.80 = 24 (instead of 35)

### Combat UI Corruption Display

The combat header now shows corruption on a second line (only when > 0):

```
──────── COMBAT ────────────────────────────────────────────────
  HP: 45/60    Stamina: 35/50    Stress: 45 (Shaken)
  Blight: 65 (Blighted)
```

Corruption uses a dark color scheme to distinguish from stress.

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CorruptionTier.cs` | 6-tier corruption classification enum |
| `RuneAndRust.Core/Models/Combat/CorruptionState.cs` | Value object with tier logic and penalty calculations |
| `RuneAndRust.Core/Models/Combat/CorruptionResult.cs` | Record for corruption change results |
| `RuneAndRust.Tests/Core/CorruptionStateTests.cs` | 48 unit tests for CorruptionState |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/Character.cs` | Added `Corruption` (0-100) and `MaxCorruption` (always 100) properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `CurrentCorruption`, `MaxCorruption`; updated `FromCharacter()` and `FromEnemy()` factory methods |
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Added `CurrentCorruption`, `MaxCorruption` to `PlayerStatsView` record |
| `RuneAndRust.Core/Interfaces/ITraumaService.cs` | Added corruption methods region: `AddCorruption`, `PurgeCorruption`, `GetCorruptionState`, `HandleTerminalError` |
| `RuneAndRust.Core/Interfaces/IStatCalculationService.cs` | Added `CalculateBaseMaxAp()` method signature |
| `RuneAndRust.Engine/Services/TraumaService.cs` | Implemented all corruption methods (no WILL mitigation) |
| `RuneAndRust.Engine/Services/StatCalculationService.cs` | Added `CalculateBaseMaxAp()`; updated `RecalculateDerivedStats()` with corruption penalties |
| `RuneAndRust.Engine/Services/CombatService.cs` | Updated `GetViewModel()` to pass corruption to `PlayerStatsView` |
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Added corruption bar display with 6-tier dark color scheme |
| `RuneAndRust.Tests/Engine/TraumaServiceTests.cs` | Added 16 corruption tests |

---

## Code Implementation Details

### CorruptionTier Enum

```csharp
public enum CorruptionTier
{
    Pristine = 0,    // 0-20
    Tainted = 1,     // 21-40
    Corrupted = 2,   // 41-60
    Blighted = 3,    // 61-80
    Fractured = 4,   // 81-99
    Terminal = 5     // 100
}
```

### CorruptionState Record

```csharp
public record CorruptionState(int Value)
{
    public CorruptionTier Tier => Value switch
    {
        >= 100 => CorruptionTier.Terminal,
        >= 81 => CorruptionTier.Fractured,
        >= 61 => CorruptionTier.Blighted,
        >= 41 => CorruptionTier.Corrupted,
        >= 21 => CorruptionTier.Tainted,
        _ => CorruptionTier.Pristine
    };

    public double MaxApMultiplier => Tier switch
    {
        CorruptionTier.Terminal => 0.0,
        CorruptionTier.Fractured => 0.60,
        CorruptionTier.Blighted => 0.80,
        CorruptionTier.Corrupted => 0.90,
        _ => 1.0
    };

    public int WillPenalty => Tier switch
    {
        CorruptionTier.Terminal => 2,
        CorruptionTier.Fractured => 2,
        CorruptionTier.Blighted => 1,
        _ => 0
    };

    public int WitsPenalty => Tier switch
    {
        CorruptionTier.Terminal => 1,
        CorruptionTier.Fractured => 1,
        _ => 0
    };

    public bool IsTerminal => Tier == CorruptionTier.Terminal;
}
```

### CorruptionResult Record

```csharp
public record CorruptionResult(
    int RawCorruption,          // Initial corruption amount
    int NetCorruptionApplied,   // Actual corruption added (no mitigation)
    int CurrentTotal,           // New corruption total after application
    CorruptionTier PreviousTier,
    CorruptionTier NewTier,
    bool TierChanged,           // True if tier changed
    bool IsTerminal,            // True if just reached 100
    string Source               // What caused the corruption
);
```

### ITraumaService Corruption Methods

```csharp
public interface ITraumaService
{
    // ... existing stress methods ...

    #region Corruption Methods (v0.3.0b)
    CorruptionResult AddCorruption(Character character, int amount, string source);
    CorruptionResult AddCorruption(Combatant combatant, int amount, string source);
    CorruptionResult PurgeCorruption(Character character, int amount, string source);
    CorruptionState GetCorruptionState(int corruptionValue);
    void HandleTerminalError(Character character);
    #endregion
}
```

### Key TraumaService Methods

**AddCorruption (NO mitigation):**
```csharp
public CorruptionResult AddCorruption(Character character, int amount, string source)
{
    // Corruption accumulates directly - NO WILL mitigation
    _logger.LogWarning("{Name} corrupted: +{Amount} (Source: {Source})",
        character.Name, amount, source);

    var previousCorruption = character.Corruption;
    var previousState = GetCorruptionState(previousCorruption);

    // Direct accumulation, clamped to 100
    character.Corruption = Math.Min(100, character.Corruption + amount);

    var newState = GetCorruptionState(character.Corruption);
    var isTerminal = newState.IsTerminal && !previousState.IsTerminal;

    if (isTerminal)
    {
        _logger.LogCritical("TERMINAL ERROR: {Name} reached 100 Corruption. Entity Lost.",
            character.Name);
        HandleTerminalError(character);
    }

    return new CorruptionResult(...);
}
```

### StatCalculationService Corruption Integration

```csharp
public void RecalculateDerivedStats(Character character)
{
    // Get corruption state for penalty calculations
    var corruptionState = new CorruptionState(character.Corruption);

    var effectiveWill = character.GetEffectiveAttribute(CharacterAttribute.Will);
    var effectiveWits = character.GetEffectiveAttribute(CharacterAttribute.Wits);

    // Apply corruption attribute penalties
    if (corruptionState.WillPenalty > 0)
    {
        effectiveWill = Math.Max(1, effectiveWill - corruptionState.WillPenalty);
    }
    if (corruptionState.WitsPenalty > 0)
    {
        effectiveWits = Math.Max(1, effectiveWits - corruptionState.WitsPenalty);
    }

    // Calculate Max AP with corruption penalty
    var baseMaxAp = CalculateBaseMaxAp(character.Archetype, effectiveWill);
    character.MaxAp = (int)(baseMaxAp * corruptionState.MaxApMultiplier);
}
```

### Combat Screen Corruption Display

```csharp
// Corruption color mapping based on tier
var corruptionColor = stats.CurrentCorruption switch
{
    >= 100 => "bold white on red",  // Terminal - inverted for emphasis
    >= 81 => "bold red",             // Fractured
    >= 61 => "red",                  // Blighted
    >= 41 => "maroon",               // Corrupted
    >= 21 => "grey",                 // Tainted
    _ => "green"                     // Pristine
};

// Second line for corruption (only show if > 0)
if (stats.CurrentCorruption > 0)
{
    AnsiConsole.MarkupLine(
        $"  [bold darkred]Blight:[/] [{corruptionColor}]{stats.CurrentCorruption}[/] [grey]({corruptionLabel})[/]");
}
```

---

## Architecture

### Corruption vs Stress Comparison

| Aspect | Stress | Corruption |
|--------|--------|------------|
| Mitigation | WILL roll reduces incoming | None - direct accumulation |
| Recovery | Via rest, abilities | Rare rituals only |
| Effect | Defense penalty | Max AP, WILL, WITS penalties |
| Terminal | Breaking Point (v0.3.0c) | Forlorn (unplayable) |
| Thematic | Psychological strain | Physical/spiritual contamination |

### Corruption Flow

```
Corruption Source (e.g., Blight creature, dark artifact)
    │
    └─ TraumaService.AddCorruption(target, amount, "Blight Exposure")
          │
          ├─ NO WILL roll - corruption is permanent
          │
          ├─ previousState = GetCorruptionState(current)
          │
          ├─ target.Corruption = Min(100, current + amount)
          │
          ├─ newState = GetCorruptionState(target.Corruption)
          │
          ├─ If newState.IsTerminal && !previousState.IsTerminal
          │     └─ HandleTerminalError(target) - character lost
          │
          └─ Return CorruptionResult with tier changes
```

### Stat Recalculation with Corruption

```
StatCalculationService.RecalculateDerivedStats(character)
    │
    ├─ corruptionState = new CorruptionState(character.Corruption)
    │
    ├─ Apply WILL penalty (Blighted: -1, Fractured: -2)
    │     └─ effectiveWill = Max(1, baseWill - corruptionState.WillPenalty)
    │
    ├─ Apply WITS penalty (Fractured: -1)
    │     └─ effectiveWits = Max(1, baseWits - corruptionState.WitsPenalty)
    │
    ├─ Calculate Base Max AP
    │     └─ Mystic: 10 + (effectiveWill * 5), Others: 0
    │
    └─ Apply corruption multiplier
          └─ MaxAp = baseMaxAp * corruptionState.MaxApMultiplier
```

---

## Logging Matrix

### TraumaService Corruption Logs

| Event | Level | Template |
|-------|-------|----------|
| Corruption Added | Warning | `"{Name} corrupted: +{Amount} (Source: {Source})"` |
| Tier Transition | Information | `"{Name} corruption threshold reached: {OldTier} -> {NewTier}"` |
| Penalty Applied | Debug | `"Applied corruption penalty: MaxAP x{Mult}, WILL -{WillPen}, WITS -{WitsPen}"` |
| Terminal Error | Critical | `"TERMINAL ERROR: {Name} reached 100 Corruption. Entity Lost."` |
| Corruption Purged | Information | `"{Name} purged of corruption: -{Amount} (Source: {Source})"` |
| Tier Improved | Information | `"{Name} corruption tier improved: {OldTier} -> {NewTier}"` |
| Non-player Combatant | Debug | `"AddCorruption called on non-player combatant {Name}, updating local state only"` |

### StatCalculationService Corruption Logs

| Event | Level | Template |
|-------|-------|----------|
| WILL Penalty Applied | Debug | `"Corruption penalty applied to WILL: -{Penalty} (effective: {Effective})"` |
| WITS Penalty Applied | Debug | `"Corruption penalty applied to WITS: -{Penalty} (effective: {Effective})"` |
| MaxAP Penalty Applied | Debug | `"Corruption penalty applied to MaxAP: -{Penalty}% (base: {Base}, final: {Final})"` |

---

## Test Coverage Matrix

### CorruptionStateTests (48 tests)

| Test Category | Count | Description |
|---------------|-------|-------------|
| Tier Classification | 16 | Boundary tests for all tier thresholds |
| MaxApMultiplier | 12 | Multiplier values for each tier |
| WillPenalty | 8 | WILL penalty values |
| WitsPenalty | 8 | WITS penalty values |
| Terminal Detection | 4 | IsTerminal flag |
| Display Labels | 11 | TierDisplayName for each tier |
| Edge Cases | 2 | Negative and over-100 values |
| Boundary Tests | 5 | Exact boundary transitions |
| Combined Penalties | 4 | Multi-penalty tier verification |

### TraumaServiceTests Corruption Tests (16 tests)

| Test Name | Category | Validates |
|-----------|----------|-----------|
| `AddCorruption_AccumulatesDirectly_NoMitigation` | Unit | No WILL roll |
| `AddCorruption_ClampsAt100` | Unit | Max corruption cap |
| `AddCorruption_TriggersTerminalAt100` | Unit | Terminal flag |
| `AddCorruption_NoTerminalIfAlreadyAt100` | Unit | No repeat terminal |
| `AddCorruption_TracksTierTransition` | Unit | Tier change tracking |
| `AddCorruption_IgnoresNonPositiveAmounts` | Unit | Zero/negative handling |
| `AddCorruption_Combatant_UpdatesCharacterSource` | Integration | Player sync |
| `AddCorruption_NonPlayerCombatant_OnlyUpdatesLocal` | Integration | Enemy handling |
| `PurgeCorruption_ReducesCorruption` | Unit | Purge math |
| `PurgeCorruption_ClampsAtZero` | Unit | Min corruption cap |
| `PurgeCorruption_TracksTierTransition` | Unit | Tier improvement |
| `PurgeCorruption_NeverTriggersTerminal` | Unit | No terminal on purge |
| `GetCorruptionState_ReturnsCorrectState` | Unit | State factory |

---

## Verification Results

### Build Output

```
Build succeeded.
    63 Warning(s)
    0 Error(s)
```

### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:  1638, Skipped:     0, Total:  1638, Duration: 584 ms
```

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Entities/
│   └── Character.cs                    [MODIFIED - added Corruption, MaxCorruption]
├── Enums/
│   ├── StressStatus.cs                 [v0.3.0a]
│   └── CorruptionTier.cs               [NEW]
├── Interfaces/
│   ├── ITraumaService.cs               [MODIFIED - added corruption methods]
│   └── IStatCalculationService.cs      [MODIFIED - added CalculateBaseMaxAp]
├── Models/Combat/
│   ├── Combatant.cs                    [MODIFIED - added CurrentCorruption, MaxCorruption]
│   ├── StressResult.cs                 [v0.3.0a]
│   ├── CorruptionState.cs              [NEW]
│   └── CorruptionResult.cs             [NEW]
├── ViewModels/
│   └── CombatViewModel.cs              [MODIFIED - added corruption to PlayerStatsView]

RuneAndRust.Engine/Services/
├── TraumaService.cs                    [MODIFIED - added corruption methods]
├── StatCalculationService.cs           [MODIFIED - corruption penalties]
├── CombatService.cs                    [MODIFIED - corruption in GetViewModel]

RuneAndRust.Terminal/
├── Services/
│   └── CombatScreenRenderer.cs         [MODIFIED - corruption bar display]

RuneAndRust.Tests/
├── Core/
│   └── CorruptionStateTests.cs         [NEW - 48 tests]
├── Engine/
│   └── TraumaServiceTests.cs           [MODIFIED - 16 corruption tests]
```

---

## Milestone v0.3.0 Progress

| Sub-version | Feature | Status |
|-------------|---------|--------|
| v0.3.0a | Psychic Stress & Resolve | Complete |
| v0.3.0b | Corruption & Tiers | **Complete** |
| v0.3.0c | Breaking Point & Trauma Selection | Pending |

---

## Next Steps (v0.3.0c)

- Implement Breaking Point event when stress hits 100:
  - Force trauma selection from available options
  - Apply permanent debuffs or quirks
- Create Trauma catalog with selection UI
- Implement Terminal Error full sequence:
  - Lock character as Forlorn
  - Display Terminal Error modal
  - Force return to Main Menu
- Add corruption sources in combat:
  - Blight creature attacks
  - Corrupted artifact usage
  - Failed aether manipulation

---

## Known Limitations

1. **Corruption Sources Not Implemented:** No game events currently inflict corruption
2. **Terminal Error Is Stub:** Reaching 100 corruption logs a critical error but doesn't lock the character
3. **No Purge Mechanics:** PurgeCorruption method exists but nothing calls it yet
4. **Corruption Not Persisted:** Character.Corruption is not saved to database yet
5. **StatCalculationService Dependency:** Corruption penalties only apply when RecalculateDerivedStats is called

---

## Contributors

- Implementation: Claude Opus 4.5
