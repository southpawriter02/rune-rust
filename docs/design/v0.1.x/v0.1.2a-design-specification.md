# v0.1.2a Design Specification: Biome System Core

**Version:** 0.1.2a
**Phase Name:** Biome System Core
**Parent Version:** v0.1.2 (Dungeon Theming & Biomes)
**Prerequisites:** v0.1.1 Complete (Dynamic Room Generation)
**Estimated Tests:** ~25 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BiomeDefinition Entity](#4-biomedefinition-entity)
5. [BiomeDescriptors Value Object](#5-biomedescriptors-value-object)
6. [BiomeRules Value Object](#6-biomerules-value-object)
7. [BiomeService](#7-biomeservice)
8. [Room Biome Integration](#8-room-biome-integration)
9. [DescriptorService Integration](#9-descriptorservice-integration)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement the foundational biome system that enables themed dungeon zones with distinct atmospheric characteristics. Each biome defines environmental descriptors (lighting, sounds, smells, textures), gameplay modifiers, and depth constraints. This phase establishes the core data model and services that will be extended in subsequent phases for content pools, hazards, and transitions.

### 1.2 Current State

| Area | Current State (v0.1.1) | Target State (v0.1.2a) |
|------|------------------------|------------------------|
| Room theming | Basic `EnvironmentContext` reference | Full `BiomeDefinition` integration |
| Descriptors | Generic descriptor pools | Biome-specific descriptor arrays |
| Gameplay modifiers | None | BiomeRules with visibility, movement, regen modifiers |
| Biome selection | None | Depth-constrained weighted selection |
| Room biome | None | `Room.BiomeId` property |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `BiomeDefinition` |
| **Value Objects** | `BiomeDescriptors`, `BiomeRules` |
| **Services** | `BiomeService` (with `IBiomeService` interface) |
| **Configuration** | `biomes.json`, `biomes-schema.json` |
| **Entity Updates** | `Room.BiomeId` property |
| **Service Updates** | `DescriptorService` biome-aware filtering |
| **Tests** | ~25 new unit tests |

### 1.4 Architectural Significance

This version establishes the **biome theming pattern** that will be expanded throughout v0.1.2:
- Data-driven biome definitions loaded from JSON configuration
- Layered descriptor system for atmospheric variety
- Modular gameplay rules that affect exploration
- Depth-based biome distribution for natural progression

---

## 2. Feature Overview

```
v0.1.2a Biome System Core
├── BiomeDefinition Entity
│   ├── Unique biome identification (Id)
│   ├── Display name and description
│   ├── Environmental descriptors
│   ├── Depth constraints (MinDepth, MaxDepth)
│   ├── Selection weight for randomization
│   ├── Gameplay rules
│   ├── Tags for categorization
│   ├── UI properties (icon, color)
│   └── Factory method (Create)
├── BiomeDescriptors Value Object
│   ├── Lighting descriptors (array)
│   ├── Sound descriptors (array)
│   ├── Smell descriptors (array)
│   ├── Texture descriptors (array)
│   ├── Atmosphere descriptors (array)
│   ├── Temperature descriptors (array)
│   └── Descriptor pool prefix
├── BiomeRules Value Object
│   ├── Visibility modifier
│   ├── Movement modifier
│   ├── Light requirement flag
│   ├── Regeneration modifier
│   ├── Stealth modifier
│   ├── Ambient damage (placeholder)
│   └── Ambient status effects (placeholder)
├── BiomeService
│   ├── GetBiome(biomeId)
│   ├── GetAllBiomes()
│   ├── GetBiomesForDepth(depth)
│   ├── SelectBiomeForPosition(position)
│   ├── IsValidForDepth(biomeId, depth)
│   └── GetRandomDescriptor(biomeId, type, position)
├── Room Biome Integration
│   ├── Room.BiomeId property
│   └── Room.SetBiome(biomeId) method
├── DescriptorService Integration
│   └── Biome-aware descriptor filtering
└── Configuration
    ├── biomes.json (6 default biomes)
    └── biomes-schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Room descriptions now include biome-themed descriptors                      │
│  ├── GameView displays biome name in status                                  │
│  └── Look command shows biome-appropriate descriptions                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  BiomeService                        DescriptorService (Updated)             │
│  ├── GetBiome(biomeId)               ├── GetDescriptor() // biome-aware     │
│  ├── GetAllBiomes()                  └── FilterByBiome()                     │
│  ├── GetBiomesForDepth(depth)                                                │
│  ├── SelectBiomeForPosition()        RoomGeneratorService (Updated)          │
│  ├── IsValidForDepth()               └── Assigns BiomeId during generation   │
│  └── GetRandomDescriptor()                                                   │
│                                                                              │
│  Interfaces:                         Configuration:                          │
│  └── IBiomeService                   └── BiomeConfigurationDto               │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions:                  Value Objects:                                │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                   │
│  │ BiomeDefinition         │  │ BiomeDescriptors        │                   │
│  │ ├── Id: string          │  │ ├── Lighting: string[]  │                   │
│  │ ├── Name: string        │  │ ├── Sounds: string[]    │                   │
│  │ ├── Description: string │  │ ├── Smells: string[]    │                   │
│  │ ├── Descriptors         │  │ ├── Textures: string[]  │                   │
│  │ ├── MinDepth: int       │  │ ├── Atmosphere: string[]│                   │
│  │ ├── MaxDepth: int?      │  │ ├── Temperature: string[]                   │
│  │ ├── Weight: int         │  │ └── DescriptorPoolPrefix│                   │
│  │ ├── Rules               │  └─────────────────────────┘                   │
│  │ ├── Tags: string[]      │  ┌─────────────────────────┐                   │
│  │ ├── Icon: string        │  │ BiomeRules              │                   │
│  │ └── Color: string       │  │ ├── VisibilityModifier  │                   │
│  └─────────────────────────┘  │ ├── MovementModifier    │                   │
│                               │ ├── RequiresLight       │                   │
│  Entities (Updated):          │ ├── RegenerationModifier│                   │
│  ┌─────────────────────────┐  │ ├── StealthModifier     │                   │
│  │ Room                    │  │ ├── AmbientDamage       │                   │
│  │ └── ADD: BiomeId: string│  │ └── AmbientStatusEffects│                   │
│  └─────────────────────────┘  └─────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetBiomeDefinitions(): IReadOnlyList<BiomeDefinition>                  │
│  └── Loads and deserializes config/biomes.json                              │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/biomes.json (6 default biomes)                                  │
│  └── config/schemas/biomes-schema.json (validation schema)                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Biome Selection Flow

```
┌───────────────────────────────────────┐
│ RoomGeneratorService generates room   │
│ at Position3D (X, Y, Z)               │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ BiomeService.SelectBiomeForPosition(position)                 │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Get Biomes Valid for Depth                            │
├───────────────────────────────────────────────────────────────┤
│ GetBiomesForDepth(position.Z)                                 │
│ ├── Catacombs (depth 0-5) ✓                                   │
│ ├── Sewers (depth 0-3) ✓                                      │
│ ├── Mines (depth 2-8) ✗ (minDepth > current)                  │
│ ├── Ancient Ruins (depth 3+) ✗                                │
│ ├── Frozen Depths (depth 4+) ✗                                │
│ └── Volcanic Caverns (depth 6+) ✗                             │
│                                                               │
│ Valid biomes at depth 1: [Catacombs, Sewers]                  │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Weighted Random Selection                             │
├───────────────────────────────────────────────────────────────┤
│ SeededRandomService.SelectWeighted(position, biomes, "biome") │
│                                                               │
│ Biome weights:                                                │
│ ├── Catacombs: 100                                            │
│ └── Sewers: 80                                                │
│                                                               │
│ Total weight: 180                                             │
│ Seeded roll for position → 0.45 × 180 = 81                    │
│ ├── 0-99: Catacombs ← Selected                                │
│ └── 100-179: Sewers                                           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Assign Biome to Room                                  │
├───────────────────────────────────────────────────────────────┤
│ room.SetBiome("catacombs")                                    │
│                                                               │
│ Room now has:                                                 │
│ ├── BiomeId: "catacombs"                                      │
│ └── Access to biome descriptors, rules via BiomeService       │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Descriptor Integration Flow

```
┌───────────────────────────────────────┐
│ DescriptorService generates room text │
│ for Room with BiomeId = "catacombs"   │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Get Biome Definition                                          │
├───────────────────────────────────────────────────────────────┤
│ BiomeService.GetBiome("catacombs")                            │
│ └── Returns BiomeDefinition with Descriptors                  │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Select Random Descriptors                                     │
├───────────────────────────────────────────────────────────────┤
│ For each descriptor type:                                     │
│                                                               │
│ Lighting: ["pale candlelight", "flickering shadows", ...]     │
│ └── Selected: "flickering shadows"                            │
│                                                               │
│ Sounds: ["whispered prayers", "rattling bones", ...]          │
│ └── Selected: "distant chanting"                              │
│                                                               │
│ Smells: ["incense and decay", "ancient dust", ...]            │
│ └── Selected: "ancient dust"                                  │
│                                                               │
│ Atmosphere: ["reverent silence", "oppressive grief", ...]     │
│ └── Selected: "lingering spirits"                             │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Generate Description                                          │
├───────────────────────────────────────────────────────────────┤
│ "You stand in a crypt chamber. Flickering shadows dance       │
│  across carved crypts. The smell of ancient dust fills the    │
│  air. Distant chanting echoes from somewhere below. A sense   │
│  of lingering spirits pervades the deathly cold space."       │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. BiomeDefinition Entity

### 4.1 Purpose

The `BiomeDefinition` entity represents a themed dungeon zone with all its environmental characteristics, gameplay modifiers, and configuration properties. Biomes are loaded from JSON configuration and are immutable during runtime.

### 4.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Definitions/BiomeDefinition.cs`

### 4.3 Implementation

```csharp
namespace RuneAndRust.Domain.Definitions;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines a themed dungeon zone with environmental characteristics.
/// </summary>
public class BiomeDefinition
{
    /// <summary>
    /// Gets the unique identifier for this biome (e.g., "catacombs").
    /// </summary>
    /// <remarks>
    /// Uses kebab-case naming convention. Must be unique across all biomes.
    /// </remarks>
    public string Id { get; init; } = string.Empty;

    /// <summary>
    /// Gets the display name (e.g., "The Catacombs").
    /// </summary>
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// Gets the biome description for codex/discovery.
    /// </summary>
    public string Description { get; init; } = string.Empty;

    /// <summary>
    /// Gets the environmental descriptors for this biome.
    /// </summary>
    public BiomeDescriptors Descriptors { get; init; } = BiomeDescriptors.Default;

    /// <summary>
    /// Gets the minimum depth (Z-level) where this biome can appear.
    /// </summary>
    /// <remarks>
    /// Depth 0 is the dungeon entrance. Higher values are deeper.
    /// </remarks>
    public int MinDepth { get; init; }

    /// <summary>
    /// Gets the maximum depth where this biome can appear.
    /// </summary>
    /// <remarks>
    /// Null indicates no maximum depth limit.
    /// </remarks>
    public int? MaxDepth { get; init; }

    /// <summary>
    /// Gets the probability weight for biome selection.
    /// </summary>
    /// <remarks>
    /// Higher weights increase selection probability. Default is 100.
    /// </remarks>
    public int Weight { get; init; } = 100;

    /// <summary>
    /// Gets biome-specific gameplay rules.
    /// </summary>
    public BiomeRules Rules { get; init; } = BiomeRules.Default;

    /// <summary>
    /// Gets tags for filtering and categorization.
    /// </summary>
    /// <remarks>
    /// Tags enable filtering biomes by characteristics (e.g., "undead", "fire", "water").
    /// </remarks>
    public IReadOnlyList<string> Tags { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets the icon or symbol representing this biome.
    /// </summary>
    /// <remarks>
    /// Used in UI displays and map legends.
    /// </remarks>
    public string Icon { get; init; } = string.Empty;

    /// <summary>
    /// Gets the primary color theme for UI display.
    /// </summary>
    /// <remarks>
    /// Color name or hex value (e.g., "gray", "#808080").
    /// </remarks>
    public string Color { get; init; } = "white";

    /// <summary>
    /// Private constructor for EF Core and factory method.
    /// </summary>
    private BiomeDefinition() { }

    /// <summary>
    /// Creates a biome definition from configuration.
    /// </summary>
    /// <param name="id">Unique biome identifier (kebab-case).</param>
    /// <param name="name">Display name.</param>
    /// <param name="description">Codex description.</param>
    /// <param name="descriptors">Environmental descriptors.</param>
    /// <param name="minDepth">Minimum depth for appearance.</param>
    /// <param name="maxDepth">Maximum depth (null = unlimited).</param>
    /// <param name="weight">Selection weight.</param>
    /// <param name="rules">Gameplay rules.</param>
    /// <param name="tags">Categorization tags.</param>
    /// <param name="icon">UI icon.</param>
    /// <param name="color">UI color theme.</param>
    /// <returns>A new BiomeDefinition instance.</returns>
    /// <exception cref="ArgumentException">Thrown when id or name is null/empty.</exception>
    public static BiomeDefinition Create(
        string id,
        string name,
        string description,
        BiomeDescriptors descriptors,
        int minDepth = 0,
        int? maxDepth = null,
        int weight = 100,
        BiomeRules? rules = null,
        IEnumerable<string>? tags = null,
        string icon = "",
        string color = "white")
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id, nameof(id));
        ArgumentException.ThrowIfNullOrWhiteSpace(name, nameof(name));

        if (minDepth < 0)
            throw new ArgumentOutOfRangeException(nameof(minDepth), "MinDepth cannot be negative.");

        if (maxDepth.HasValue && maxDepth.Value < minDepth)
            throw new ArgumentException("MaxDepth cannot be less than MinDepth.", nameof(maxDepth));

        if (weight <= 0)
            throw new ArgumentOutOfRangeException(nameof(weight), "Weight must be positive.");

        return new BiomeDefinition
        {
            Id = id,
            Name = name,
            Description = description ?? string.Empty,
            Descriptors = descriptors,
            MinDepth = minDepth,
            MaxDepth = maxDepth,
            Weight = weight,
            Rules = rules ?? BiomeRules.Default,
            Tags = tags?.ToList() ?? new List<string>(),
            Icon = icon ?? string.Empty,
            Color = color ?? "white"
        };
    }

    /// <summary>
    /// Checks if this biome is valid for a given depth.
    /// </summary>
    /// <param name="depth">The Z-level depth to check.</param>
    /// <returns>True if the biome can appear at this depth.</returns>
    public bool IsValidForDepth(int depth)
    {
        if (depth < MinDepth)
            return false;

        if (MaxDepth.HasValue && depth > MaxDepth.Value)
            return false;

        return true;
    }

    /// <summary>
    /// Checks if this biome has a specific tag.
    /// </summary>
    /// <param name="tag">The tag to check for.</param>
    /// <returns>True if the biome has the tag.</returns>
    public bool HasTag(string tag)
    {
        return Tags.Contains(tag, StringComparer.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets a string representation of the biome.
    /// </summary>
    public override string ToString() => $"Biome[{Id}] {Name} (depth {MinDepth}-{MaxDepth?.ToString() ?? "∞"})";
}
```

### 4.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `string` | Unique identifier (kebab-case) | Required |
| `Name` | `string` | Display name | Required |
| `Description` | `string` | Codex description | Empty |
| `Descriptors` | `BiomeDescriptors` | Environmental descriptors | Default |
| `MinDepth` | `int` | Minimum Z-level | 0 |
| `MaxDepth` | `int?` | Maximum Z-level | null (unlimited) |
| `Weight` | `int` | Selection probability weight | 100 |
| `Rules` | `BiomeRules` | Gameplay modifiers | Default |
| `Tags` | `IReadOnlyList<string>` | Categorization tags | Empty |
| `Icon` | `string` | UI icon | Empty |
| `Color` | `string` | UI color theme | "white" |

---

## 5. BiomeDescriptors Value Object

### 5.1 Purpose

The `BiomeDescriptors` value object contains arrays of themed descriptive text for each sensory category. These descriptors are randomly selected during room description generation to create atmospheric variety.

### 5.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/BiomeDescriptors.cs`

### 5.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Environmental descriptors that define a biome's atmosphere.
/// </summary>
/// <remarks>
/// Each property contains an array of themed descriptive text.
/// During room generation, random selections create varied descriptions.
/// </remarks>
public readonly record struct BiomeDescriptors
{
    /// <summary>
    /// Gets lighting descriptors (e.g., "dim", "flickering torchlight", "pitch black").
    /// </summary>
    public IReadOnlyList<string> Lighting { get; init; }

    /// <summary>
    /// Gets ambient sound descriptors (e.g., "dripping water", "distant screams").
    /// </summary>
    public IReadOnlyList<string> Sounds { get; init; }

    /// <summary>
    /// Gets smell descriptors (e.g., "damp earth", "sulfurous fumes").
    /// </summary>
    public IReadOnlyList<string> Smells { get; init; }

    /// <summary>
    /// Gets texture descriptors (e.g., "moss-covered", "crumbling stone").
    /// </summary>
    public IReadOnlyList<string> Textures { get; init; }

    /// <summary>
    /// Gets atmosphere descriptors (e.g., "oppressive", "eerily silent").
    /// </summary>
    public IReadOnlyList<string> Atmosphere { get; init; }

    /// <summary>
    /// Gets temperature descriptors (e.g., "freezing", "sweltering").
    /// </summary>
    public IReadOnlyList<string> Temperature { get; init; }

    /// <summary>
    /// Gets the descriptor pool prefix for extended descriptor lookups.
    /// </summary>
    /// <remarks>
    /// Used to reference additional descriptor pools in the descriptor service.
    /// Format: "biome.{biomeId}" (e.g., "biome.catacombs").
    /// </remarks>
    public string DescriptorPoolPrefix { get; init; }

    /// <summary>
    /// Creates default biome descriptors.
    /// </summary>
    public static BiomeDescriptors Default => new()
    {
        Lighting = new[] { "dim", "shadowy" },
        Sounds = new[] { "silence" },
        Smells = new[] { "musty" },
        Textures = new[] { "stone" },
        Atmosphere = new[] { "still" },
        Temperature = new[] { "cool" },
        DescriptorPoolPrefix = "biome.default"
    };

    /// <summary>
    /// Gets a random descriptor from a specific category.
    /// </summary>
    /// <param name="category">The category name (lighting, sounds, smells, textures, atmosphere, temperature).</param>
    /// <param name="random">Random instance for selection.</param>
    /// <returns>A random descriptor string, or empty if category not found.</returns>
    public string GetRandomDescriptor(string category, Random random)
    {
        var pool = category.ToLowerInvariant() switch
        {
            "lighting" => Lighting,
            "sounds" => Sounds,
            "smells" => Smells,
            "textures" => Textures,
            "atmosphere" => Atmosphere,
            "temperature" => Temperature,
            _ => Array.Empty<string>()
        };

        if (pool.Count == 0)
            return string.Empty;

        return pool[random.Next(pool.Count)];
    }

    /// <summary>
    /// Checks if all descriptor arrays have at least one entry.
    /// </summary>
    public bool IsValid =>
        Lighting?.Count > 0 &&
        Sounds?.Count > 0 &&
        Smells?.Count > 0 &&
        Textures?.Count > 0 &&
        Atmosphere?.Count > 0 &&
        Temperature?.Count > 0;
}
```

### 5.4 Descriptor Categories

| Category | Purpose | Example Values |
|----------|---------|----------------|
| `Lighting` | Visual illumination | "pale candlelight", "molten glow", "darkness" |
| `Sounds` | Ambient audio | "dripping water", "rattling bones", "howling wind" |
| `Smells` | Olfactory atmosphere | "decay", "sulfur", "crisp cold" |
| `Textures` | Surface descriptions | "carved crypts", "obsidian walls", "frost patterns" |
| `Atmosphere` | Emotional ambiance | "reverent silence", "oppressive heat", "deadly beauty" |
| `Temperature` | Thermal sensation | "deathly cold", "sweltering", "freezing" |

---

## 6. BiomeRules Value Object

### 6.1 Purpose

The `BiomeRules` value object defines gameplay modifiers specific to a biome. These rules affect visibility, movement speed, regeneration rates, and other mechanics when the player is in the biome.

### 6.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/BiomeRules.cs`

### 6.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Gameplay rules specific to a biome.
/// </summary>
/// <remarks>
/// Modifiers are multiplicative (1.0 = normal, 0.5 = halved, 2.0 = doubled).
/// </remarks>
public readonly record struct BiomeRules
{
    /// <summary>
    /// Gets the visibility range modifier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Affects how far the player can see in the biome.
    /// Lower values mean reduced visibility.
    /// </remarks>
    public float VisibilityModifier { get; init; }

    /// <summary>
    /// Gets the movement speed modifier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Affects movement point costs in the biome.
    /// Lower values mean slower movement.
    /// </remarks>
    public float MovementModifier { get; init; }

    /// <summary>
    /// Gets whether light sources are required in this biome.
    /// </summary>
    /// <remarks>
    /// When true, players without a light source have severely reduced visibility.
    /// </remarks>
    public bool RequiresLight { get; init; }

    /// <summary>
    /// Gets the natural regeneration modifier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Affects health/resource regeneration rates in the biome.
    /// Lower values mean slower regeneration.
    /// </remarks>
    public float RegenerationModifier { get; init; }

    /// <summary>
    /// Gets whether stealth is easier or harder (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Higher values make stealth easier (stealth checks get a bonus).
    /// </remarks>
    public float StealthModifier { get; init; }

    /// <summary>
    /// Gets ambient damage per turn (0 = none).
    /// </summary>
    /// <remarks>
    /// Reserved for v0.1.2c (Environmental Hazards).
    /// Set to 0 for this phase.
    /// </remarks>
    public int AmbientDamage { get; init; }

    /// <summary>
    /// Gets the damage type for ambient damage.
    /// </summary>
    /// <remarks>
    /// Reserved for v0.1.2c (Environmental Hazards).
    /// </remarks>
    public string? AmbientDamageType { get; init; }

    /// <summary>
    /// Gets status effects that may be applied each turn.
    /// </summary>
    /// <remarks>
    /// Reserved for v0.1.2c (Environmental Hazards).
    /// </remarks>
    public IReadOnlyList<string> AmbientStatusEffects { get; init; }

    /// <summary>
    /// Gets the chance for ambient status effects (0.0-1.0).
    /// </summary>
    /// <remarks>
    /// Reserved for v0.1.2c (Environmental Hazards).
    /// </remarks>
    public float AmbientEffectChance { get; init; }

    /// <summary>
    /// Creates default biome rules with no modifiers.
    /// </summary>
    public static BiomeRules Default => new()
    {
        VisibilityModifier = 1.0f,
        MovementModifier = 1.0f,
        RequiresLight = false,
        RegenerationModifier = 1.0f,
        StealthModifier = 1.0f,
        AmbientDamage = 0,
        AmbientDamageType = null,
        AmbientStatusEffects = Array.Empty<string>(),
        AmbientEffectChance = 0f
    };

    /// <summary>
    /// Applies the visibility modifier to a base range.
    /// </summary>
    /// <param name="baseRange">The base visibility range.</param>
    /// <returns>The modified visibility range.</returns>
    public int ApplyVisibilityModifier(int baseRange)
    {
        return Math.Max(1, (int)(baseRange * VisibilityModifier));
    }

    /// <summary>
    /// Applies the movement modifier to a base cost.
    /// </summary>
    /// <param name="baseCost">The base movement cost.</param>
    /// <returns>The modified movement cost.</returns>
    public int ApplyMovementModifier(int baseCost)
    {
        if (MovementModifier == 1.0f)
            return baseCost;

        // Lower modifier = slower movement = higher cost
        return Math.Max(1, (int)(baseCost / MovementModifier));
    }

    /// <summary>
    /// Applies the regeneration modifier to a base amount.
    /// </summary>
    /// <param name="baseRegen">The base regeneration amount.</param>
    /// <returns>The modified regeneration amount.</returns>
    public int ApplyRegenerationModifier(int baseRegen)
    {
        return Math.Max(0, (int)(baseRegen * RegenerationModifier));
    }

    /// <summary>
    /// Applies the stealth modifier to a base check value.
    /// </summary>
    /// <param name="baseCheck">The base stealth check value.</param>
    /// <returns>The modified stealth check value.</returns>
    public int ApplyStealthModifier(int baseCheck)
    {
        return (int)(baseCheck * StealthModifier);
    }
}
```

### 6.4 Modifier Reference

| Modifier | < 1.0 | = 1.0 | > 1.0 |
|----------|-------|-------|-------|
| `VisibilityModifier` | Reduced sight | Normal | Enhanced sight |
| `MovementModifier` | Slower movement | Normal | Faster movement |
| `RegenerationModifier` | Slower regen | Normal | Faster regen |
| `StealthModifier` | Harder stealth | Normal | Easier stealth |

### 6.5 Default Biome Rule Presets

| Biome | Visibility | Movement | Light | Regen | Stealth |
|-------|------------|----------|-------|-------|---------|
| Catacombs | 0.8 | 1.0 | Yes | 0.9 | 1.1 |
| Sewers | 0.7 | 0.9 | No | 0.8 | 0.9 |
| Mines | 0.6 | 0.95 | Yes | 1.0 | 0.8 |
| Ancient Ruins | 1.0 | 1.0 | No | 1.1 | 0.7 |
| Frozen Depths | 1.2 | 0.85 | No | 0.7 | 1.0 |
| Volcanic Caverns | 0.9 | 0.9 | No | 0.6 | 0.8 |

---

## 7. BiomeService

### 7.1 Purpose

The `BiomeService` provides biome lookup, selection, and descriptor access. It integrates with the `SeededRandomService` for reproducible biome selection based on position.

### 7.2 File Locations

**Interface:** `src/Core/RuneAndRust.Application/Interfaces/IBiomeService.cs`
**Implementation:** `src/Core/RuneAndRust.Application/Services/BiomeService.cs`

### 7.3 Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for biome lookup, selection, and management.
/// </summary>
public interface IBiomeService
{
    /// <summary>
    /// Gets a biome definition by ID.
    /// </summary>
    /// <param name="biomeId">The unique biome identifier.</param>
    /// <returns>The biome definition, or null if not found.</returns>
    BiomeDefinition? GetBiome(string biomeId);

    /// <summary>
    /// Gets all available biome definitions.
    /// </summary>
    /// <returns>A read-only list of all biome definitions.</returns>
    IReadOnlyList<BiomeDefinition> GetAllBiomes();

    /// <summary>
    /// Gets biomes valid for a given depth.
    /// </summary>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>Biomes that can appear at this depth.</returns>
    IReadOnlyList<BiomeDefinition> GetBiomesForDepth(int depth);

    /// <summary>
    /// Selects a biome for a position using seeded random.
    /// </summary>
    /// <param name="position">The 3D position.</param>
    /// <returns>The selected biome definition.</returns>
    BiomeDefinition SelectBiomeForPosition(Position3D position);

    /// <summary>
    /// Validates that a biome can appear at the specified depth.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>True if the biome is valid for this depth.</returns>
    bool IsValidForDepth(string biomeId, int depth);

    /// <summary>
    /// Gets a random descriptor from a biome's pools.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="descriptorType">The descriptor category.</param>
    /// <param name="position">Position for seeded randomization.</param>
    /// <returns>A random descriptor string.</returns>
    string GetRandomDescriptor(string biomeId, string descriptorType, Position3D position);

    /// <summary>
    /// Gets biomes matching specified tags.
    /// </summary>
    /// <param name="tags">Tags to match.</param>
    /// <param name="matchAll">True to require all tags, false for any.</param>
    /// <returns>Matching biome definitions.</returns>
    IReadOnlyList<BiomeDefinition> GetBiomesByTags(IEnumerable<string> tags, bool matchAll = false);

    /// <summary>
    /// Gets the default biome (fallback when no biomes match).
    /// </summary>
    /// <returns>The default biome definition.</returns>
    BiomeDefinition GetDefaultBiome();
}
```

### 7.4 Implementation

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for biome lookup, selection, and management.
/// </summary>
public class BiomeService : IBiomeService
{
    private readonly IConfigurationProvider _config;
    private readonly SeededRandomService _random;
    private readonly ILogger<BiomeService> _logger;

    private const string DefaultBiomeId = "dungeon";

    /// <summary>
    /// Initializes a new instance of the BiomeService.
    /// </summary>
    public BiomeService(
        IConfigurationProvider config,
        SeededRandomService random,
        ILogger<BiomeService> logger)
    {
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _random = random ?? throw new ArgumentNullException(nameof(random));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public BiomeDefinition? GetBiome(string biomeId)
    {
        if (string.IsNullOrWhiteSpace(biomeId))
            return null;

        return _config.GetBiomeDefinitions()
            .FirstOrDefault(b => b.Id.Equals(biomeId, StringComparison.OrdinalIgnoreCase));
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeDefinition> GetAllBiomes()
    {
        return _config.GetBiomeDefinitions();
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeDefinition> GetBiomesForDepth(int depth)
    {
        return _config.GetBiomeDefinitions()
            .Where(b => b.IsValidForDepth(depth))
            .ToList();
    }

    /// <inheritdoc />
    public BiomeDefinition SelectBiomeForPosition(Position3D position)
    {
        var validBiomes = GetBiomesForDepth(position.Z);

        if (!validBiomes.Any())
        {
            _logger.LogWarning(
                "No valid biomes for depth {Depth}, using default biome",
                position.Z);

            return GetDefaultBiome();
        }

        // Use weighted selection based on biome weights
        var weightedBiomes = validBiomes.Select(b => (Item: b, Weight: b.Weight));
        var selected = _random.SelectWeighted(position, weightedBiomes, "biome_select");

        _logger.LogDebug(
            "Selected biome {BiomeId} for position ({X}, {Y}, {Z})",
            selected.Id,
            position.X,
            position.Y,
            position.Z);

        return selected;
    }

    /// <inheritdoc />
    public bool IsValidForDepth(string biomeId, int depth)
    {
        var biome = GetBiome(biomeId);
        return biome?.IsValidForDepth(depth) ?? false;
    }

    /// <inheritdoc />
    public string GetRandomDescriptor(string biomeId, string descriptorType, Position3D position)
    {
        var biome = GetBiome(biomeId);
        if (biome == null)
        {
            _logger.LogWarning("Biome {BiomeId} not found for descriptor lookup", biomeId);
            return string.Empty;
        }

        var pool = descriptorType.ToLowerInvariant() switch
        {
            "lighting" => biome.Descriptors.Lighting,
            "sounds" => biome.Descriptors.Sounds,
            "smells" => biome.Descriptors.Smells,
            "textures" => biome.Descriptors.Textures,
            "atmosphere" => biome.Descriptors.Atmosphere,
            "temperature" => biome.Descriptors.Temperature,
            _ => Array.Empty<string>()
        };

        if (!pool.Any())
        {
            _logger.LogDebug(
                "No descriptors for type {Type} in biome {BiomeId}",
                descriptorType,
                biomeId);
            return string.Empty;
        }

        var index = _random.NextForPosition(
            position,
            0,
            pool.Count,
            $"descriptor_{descriptorType}");

        return pool[index];
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeDefinition> GetBiomesByTags(
        IEnumerable<string> tags,
        bool matchAll = false)
    {
        var tagList = tags.ToList();
        if (!tagList.Any())
            return Array.Empty<BiomeDefinition>();

        return _config.GetBiomeDefinitions()
            .Where(b => matchAll
                ? tagList.All(t => b.HasTag(t))
                : tagList.Any(t => b.HasTag(t)))
            .ToList();
    }

    /// <inheritdoc />
    public BiomeDefinition GetDefaultBiome()
    {
        var defaultBiome = GetBiome(DefaultBiomeId);

        if (defaultBiome == null)
        {
            // Return first available biome as fallback
            var allBiomes = GetAllBiomes();
            if (allBiomes.Any())
            {
                _logger.LogWarning(
                    "Default biome '{DefaultId}' not found, using first available",
                    DefaultBiomeId);
                return allBiomes.First();
            }

            // Create minimal fallback biome
            _logger.LogError("No biomes configured, creating minimal fallback");
            return BiomeDefinition.Create(
                "fallback",
                "Unknown",
                "A mysterious place.",
                BiomeDescriptors.Default);
        }

        return defaultBiome;
    }
}
```

---

## 8. Room Biome Integration

### 8.1 Purpose

Extend the `Room` entity to store the biome assignment for each room. This enables biome-aware features throughout the game.

### 8.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs` (modification)

### 8.3 Changes

```csharp
// Add to Room.cs

/// <summary>
/// Gets the biome ID for this room's themed zone.
/// </summary>
/// <remarks>
/// Set during room generation based on depth and random selection.
/// </remarks>
public string BiomeId { get; private set; } = "dungeon";

/// <summary>
/// Sets the biome for this room.
/// </summary>
/// <param name="biomeId">The biome identifier to assign.</param>
/// <exception cref="ArgumentException">Thrown when biomeId is null or whitespace.</exception>
public void SetBiome(string biomeId)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(biomeId, nameof(biomeId));
    BiomeId = biomeId;
}

/// <summary>
/// Gets whether this room has a specific biome assigned.
/// </summary>
/// <param name="biomeId">The biome identifier to check.</param>
/// <returns>True if the room has this biome.</returns>
public bool HasBiome(string biomeId)
{
    return BiomeId.Equals(biomeId, StringComparison.OrdinalIgnoreCase);
}
```

### 8.4 Data Model Change

```
MODIFY: Room
├── ADD: BiomeId: string (default: "dungeon")
├── ADD: SetBiome(biomeId): void
└── ADD: HasBiome(biomeId): bool
```

---

## 9. DescriptorService Integration

### 9.1 Purpose

Update the `DescriptorService` to support biome-aware descriptor selection, allowing room descriptions to use biome-specific descriptor pools.

### 9.2 File Location

**File:** `src/Core/RuneAndRust.Application/Services/DescriptorService.cs` (modification)

### 9.3 Changes

```csharp
// Add to DescriptorService interface and implementation

/// <summary>
/// Gets a descriptor filtered by biome.
/// </summary>
/// <param name="category">The descriptor category.</param>
/// <param name="biomeId">The biome to filter by.</param>
/// <param name="position">Position for seeded randomization.</param>
/// <returns>A biome-appropriate descriptor.</returns>
public string GetBiomeDescriptor(string category, string biomeId, Position3D position)
{
    // First try biome-specific descriptor
    var biomeDescriptor = _biomeService.GetRandomDescriptor(biomeId, category, position);

    if (!string.IsNullOrEmpty(biomeDescriptor))
        return biomeDescriptor;

    // Fall back to generic descriptor pool
    return GetDescriptor(category, position);
}

/// <summary>
/// Generates a full room description using biome descriptors.
/// </summary>
/// <param name="room">The room to describe.</param>
/// <param name="position">Position for seeded randomization.</param>
/// <returns>A formatted room description.</returns>
public string GenerateBiomeRoomDescription(Room room, Position3D position)
{
    var biomeId = room.BiomeId;
    var biome = _biomeService.GetBiome(biomeId);

    if (biome == null)
    {
        _logger.LogWarning("Biome {BiomeId} not found, using generic description", biomeId);
        return GenerateRoomDescription(room, position);
    }

    var lighting = GetBiomeDescriptor("lighting", biomeId, position);
    var texture = GetBiomeDescriptor("textures", biomeId, position);
    var smell = GetBiomeDescriptor("smells", biomeId, position);
    var sound = GetBiomeDescriptor("sounds", biomeId, position);
    var atmosphere = GetBiomeDescriptor("atmosphere", biomeId, position);
    var temperature = GetBiomeDescriptor("temperature", biomeId, position);

    var description = new StringBuilder();

    // Build atmospheric description
    description.Append($"You stand in a chamber bathed in {lighting}. ");
    description.Append($"The walls are {texture}. ");

    if (!string.IsNullOrEmpty(smell))
        description.Append($"The air carries the scent of {smell}. ");

    if (!string.IsNullOrEmpty(sound))
        description.Append($"You hear {sound}. ");

    if (!string.IsNullOrEmpty(atmosphere))
        description.Append($"A sense of {atmosphere} pervades the {temperature} space.");

    return description.ToString().Trim();
}
```

---

## 10. Data Model Changes

### 10.1 Summary

```
NEW: BiomeDefinition (Definition)
├── Id: string (unique identifier)
├── Name: string (display name)
├── Description: string (codex text)
├── Descriptors: BiomeDescriptors
├── MinDepth: int
├── MaxDepth: int?
├── Weight: int
├── Rules: BiomeRules
├── Tags: IReadOnlyList<string>
├── Icon: string
├── Color: string
├── IsValidForDepth(depth): bool
└── HasTag(tag): bool

NEW: BiomeDescriptors (Value Object)
├── Lighting: IReadOnlyList<string>
├── Sounds: IReadOnlyList<string>
├── Smells: IReadOnlyList<string>
├── Textures: IReadOnlyList<string>
├── Atmosphere: IReadOnlyList<string>
├── Temperature: IReadOnlyList<string>
├── DescriptorPoolPrefix: string
├── GetRandomDescriptor(category, random): string
└── IsValid: bool

NEW: BiomeRules (Value Object)
├── VisibilityModifier: float
├── MovementModifier: float
├── RequiresLight: bool
├── RegenerationModifier: float
├── StealthModifier: float
├── AmbientDamage: int
├── AmbientDamageType: string?
├── AmbientStatusEffects: IReadOnlyList<string>
├── AmbientEffectChance: float
├── ApplyVisibilityModifier(base): int
├── ApplyMovementModifier(base): int
├── ApplyRegenerationModifier(base): int
└── ApplyStealthModifier(base): int

MODIFY: Room
├── ADD: BiomeId: string
├── ADD: SetBiome(biomeId): void
└── ADD: HasBiome(biomeId): bool

MODIFY: IConfigurationProvider
└── ADD: GetBiomeDefinitions(): IReadOnlyList<BiomeDefinition>
```

---

## 11. Configuration File Schemas

### 11.1 Biomes Configuration

**File:** `config/biomes.json`

```json
{
  "$schema": "schemas/biomes-schema.json",
  "biomes": [
    {
      "id": "catacombs",
      "name": "The Catacombs",
      "description": "Ancient burial chambers where the dead rest uneasily. Bone-lined walls and forgotten tombs hold treasures and terrors alike.",
      "icon": "skull",
      "color": "gray",
      "minDepth": 0,
      "maxDepth": 5,
      "weight": 100,
      "descriptors": {
        "lighting": [
          "pale candlelight",
          "flickering shadows",
          "ghostly luminescence",
          "dim alcoves"
        ],
        "sounds": [
          "whispered prayers",
          "rattling bones",
          "distant chanting",
          "echoing footsteps"
        ],
        "smells": [
          "incense and decay",
          "ancient dust",
          "dried flowers",
          "mold"
        ],
        "textures": [
          "carved crypts",
          "stacked bones",
          "crumbling epitaphs",
          "worn stone"
        ],
        "atmosphere": [
          "reverent silence",
          "oppressive grief",
          "lingering spirits",
          "cold stillness"
        ],
        "temperature": [
          "deathly cold",
          "chill air",
          "bone-chilling"
        ],
        "descriptorPoolPrefix": "biome.catacombs"
      },
      "rules": {
        "visibilityModifier": 0.8,
        "movementModifier": 1.0,
        "requiresLight": true,
        "regenerationModifier": 0.9,
        "stealthModifier": 1.1,
        "ambientDamage": 0
      },
      "tags": ["undead", "dark", "treasure"]
    },
    {
      "id": "sewers",
      "name": "The Sewers",
      "description": "Fetid tunnels beneath the city where disease and creatures thrive in the darkness.",
      "icon": "droplet",
      "color": "green",
      "minDepth": 0,
      "maxDepth": 3,
      "weight": 80,
      "descriptors": {
        "lighting": [
          "sickly green glow",
          "phosphorescent slime",
          "murky darkness"
        ],
        "sounds": [
          "dripping water",
          "scurrying rats",
          "gurgling flows",
          "distant splashing"
        ],
        "smells": [
          "rot and waste",
          "stagnant water",
          "methane",
          "disease"
        ],
        "textures": [
          "slick stone",
          "corroded metal",
          "fungal growths",
          "ankle-deep water"
        ],
        "atmosphere": [
          "nauseating",
          "claustrophobic",
          "treacherous footing"
        ],
        "temperature": [
          "damp",
          "humid",
          "clammy"
        ],
        "descriptorPoolPrefix": "biome.sewers"
      },
      "rules": {
        "visibilityModifier": 0.7,
        "movementModifier": 0.9,
        "requiresLight": false,
        "regenerationModifier": 0.8,
        "stealthModifier": 0.9,
        "ambientStatusEffects": ["poisoned"],
        "ambientEffectChance": 0.05
      },
      "tags": ["disease", "vermin", "water"]
    },
    {
      "id": "mines",
      "name": "The Abandoned Mines",
      "description": "Collapsed tunnels and forgotten shafts where miners once sought riches. Now home to creatures that dwell in the dark.",
      "icon": "pickaxe",
      "color": "brown",
      "minDepth": 2,
      "maxDepth": 8,
      "weight": 90,
      "descriptors": {
        "lighting": [
          "darkness",
          "scattered helmet lights",
          "glowing crystals",
          "lantern remnants"
        ],
        "sounds": [
          "creaking timbers",
          "dripping water",
          "distant collapses",
          "pickaxe echoes"
        ],
        "smells": [
          "coal dust",
          "damp earth",
          "rust",
          "stale air"
        ],
        "textures": [
          "rough-hewn walls",
          "ore veins",
          "abandoned equipment",
          "timber supports"
        ],
        "atmosphere": [
          "industrial decay",
          "forgotten labor",
          "unstable passages"
        ],
        "temperature": [
          "cool",
          "earth-chilled",
          "draft currents"
        ],
        "descriptorPoolPrefix": "biome.mines"
      },
      "rules": {
        "visibilityModifier": 0.6,
        "movementModifier": 0.95,
        "requiresLight": true,
        "regenerationModifier": 1.0,
        "stealthModifier": 0.8
      },
      "tags": ["cave", "mining", "treasure", "collapse"]
    },
    {
      "id": "ancient-ruins",
      "name": "Ancient Ruins",
      "description": "Remnants of a civilization lost to time. Magical wards and ancient guardians protect secrets long forgotten.",
      "icon": "landmark",
      "color": "gold",
      "minDepth": 3,
      "maxDepth": null,
      "weight": 70,
      "descriptors": {
        "lighting": [
          "magical glyphs",
          "starlight through cracks",
          "arcane torches",
          "crystal formations"
        ],
        "sounds": [
          "humming wards",
          "whispering echoes",
          "magical chimes",
          "ancient machinery"
        ],
        "smells": [
          "ozone",
          "ancient parchment",
          "stone dust",
          "arcane residue"
        ],
        "textures": [
          "intricate carvings",
          "rune-marked stones",
          "polished marble",
          "crumbling murals"
        ],
        "atmosphere": [
          "mystical",
          "timeless",
          "watchful presence",
          "forgotten grandeur"
        ],
        "temperature": [
          "temperature-controlled",
          "magically stable",
          "slightly warm"
        ],
        "descriptorPoolPrefix": "biome.ruins"
      },
      "rules": {
        "visibilityModifier": 1.0,
        "movementModifier": 1.0,
        "requiresLight": false,
        "regenerationModifier": 1.1,
        "stealthModifier": 0.7
      },
      "tags": ["magic", "ancient", "treasure", "guardian"]
    },
    {
      "id": "frozen-depths",
      "name": "Frozen Depths",
      "description": "Ice-covered caverns where eternal winter reigns. Cold-adapted creatures and frozen treasures await the prepared.",
      "icon": "snowflake",
      "color": "cyan",
      "minDepth": 4,
      "maxDepth": null,
      "weight": 60,
      "descriptors": {
        "lighting": [
          "blue ice glow",
          "frost-refracted light",
          "aurora shimmer",
          "crystalline sparkle"
        ],
        "sounds": [
          "cracking ice",
          "howling wind",
          "frozen silence",
          "ice groaning"
        ],
        "smells": [
          "crisp cold",
          "nothing",
          "frozen earth"
        ],
        "textures": [
          "ice walls",
          "frost patterns",
          "frozen pools",
          "icicle formations"
        ],
        "atmosphere": [
          "deadly beautiful",
          "pristine isolation",
          "merciless cold"
        ],
        "temperature": [
          "freezing",
          "bitter cold",
          "numbing",
          "hypothermic"
        ],
        "descriptorPoolPrefix": "biome.frozen"
      },
      "rules": {
        "visibilityModifier": 1.2,
        "movementModifier": 0.85,
        "requiresLight": false,
        "regenerationModifier": 0.7,
        "stealthModifier": 1.0,
        "ambientDamage": 2,
        "ambientDamageType": "ice",
        "ambientStatusEffects": ["chilled", "slowed"],
        "ambientEffectChance": 0.1
      },
      "tags": ["cold", "ice", "elemental"]
    },
    {
      "id": "volcanic-caverns",
      "name": "Volcanic Caverns",
      "description": "Molten passages carved by ancient lava flows. Extreme heat and fire creatures make this the most dangerous biome.",
      "icon": "flame",
      "color": "red",
      "minDepth": 6,
      "maxDepth": null,
      "weight": 50,
      "descriptors": {
        "lighting": [
          "molten glow",
          "ember light",
          "fire-lit passages",
          "magma rivers"
        ],
        "sounds": [
          "bubbling lava",
          "cracking stone",
          "distant eruptions",
          "hissing steam"
        ],
        "smells": [
          "sulfur",
          "ash",
          "burning rock",
          "smoke"
        ],
        "textures": [
          "obsidian walls",
          "cooled magma",
          "volcanic glass",
          "scorched stone"
        ],
        "atmosphere": [
          "oppressive heat",
          "dangerous instability",
          "primal fury",
          "deadly beauty"
        ],
        "temperature": [
          "sweltering",
          "scorching",
          "unbearably hot",
          "heat-wavering"
        ],
        "descriptorPoolPrefix": "biome.volcanic"
      },
      "rules": {
        "visibilityModifier": 0.9,
        "movementModifier": 0.9,
        "requiresLight": false,
        "regenerationModifier": 0.6,
        "stealthModifier": 0.8,
        "ambientDamage": 3,
        "ambientDamageType": "fire",
        "ambientStatusEffects": ["burning"],
        "ambientEffectChance": 0.15
      },
      "tags": ["fire", "lava", "elemental", "dangerous"]
    }
  ]
}
```

### 11.2 JSON Schema

**File:** `config/schemas/biomes-schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "biomes-schema.json",
  "title": "Biome Definitions",
  "description": "Schema for dungeon biome configuration",
  "type": "object",
  "required": ["biomes"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "biomes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/biomeDefinition"
      }
    }
  },
  "$defs": {
    "biomeDefinition": {
      "type": "object",
      "required": ["id", "name", "descriptors"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier in kebab-case"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name for the biome"
        },
        "description": {
          "type": "string",
          "description": "Codex/discovery description"
        },
        "icon": {
          "type": "string",
          "description": "UI icon identifier"
        },
        "color": {
          "type": "string",
          "description": "UI color theme"
        },
        "minDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Minimum Z-level for this biome"
        },
        "maxDepth": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Maximum Z-level (null = unlimited)"
        },
        "weight": {
          "type": "integer",
          "minimum": 1,
          "default": 100,
          "description": "Selection probability weight"
        },
        "descriptors": {
          "$ref": "#/$defs/biomeDescriptors"
        },
        "rules": {
          "$ref": "#/$defs/biomeRules"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Categorization tags"
        }
      }
    },
    "biomeDescriptors": {
      "type": "object",
      "required": ["lighting", "sounds", "smells", "textures", "atmosphere", "temperature"],
      "properties": {
        "lighting": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "sounds": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "smells": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "textures": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "atmosphere": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "temperature": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "descriptorPoolPrefix": {
          "type": "string",
          "pattern": "^biome\\.[a-z]+$"
        }
      }
    },
    "biomeRules": {
      "type": "object",
      "properties": {
        "visibilityModifier": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 3.0,
          "default": 1.0
        },
        "movementModifier": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 3.0,
          "default": 1.0
        },
        "requiresLight": {
          "type": "boolean",
          "default": false
        },
        "regenerationModifier": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 3.0,
          "default": 1.0
        },
        "stealthModifier": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 3.0,
          "default": 1.0
        },
        "ambientDamage": {
          "type": "integer",
          "minimum": 0,
          "default": 0
        },
        "ambientDamageType": {
          "type": ["string", "null"]
        },
        "ambientStatusEffects": {
          "type": "array",
          "items": { "type": "string" }
        },
        "ambientEffectChance": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.0
        }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `BiomeService` | Information | Biome loaded, biome selected for position |
| `BiomeService` | Debug | Biome lookup, descriptor selection |
| `BiomeService` | Warning | Biome not found, no valid biomes for depth |
| `BiomeService` | Error | Configuration loading failure |
| `DescriptorService` | Debug | Biome descriptor selection |
| `DescriptorService` | Warning | Fallback to generic descriptor |
| `Room` | Debug | Biome assignment |

### 12.2 Log Message Examples

```csharp
// Information
_logger.LogInformation("Loaded {Count} biome definitions", biomes.Count);
_logger.LogInformation("Selected biome {BiomeId} for position ({X}, {Y}, {Z})",
    selected.Id, position.X, position.Y, position.Z);

// Debug
_logger.LogDebug("Looking up biome {BiomeId}", biomeId);
_logger.LogDebug("Selected descriptor '{Descriptor}' for {Type} in {Biome}",
    descriptor, type, biomeId);

// Warning
_logger.LogWarning("Biome {BiomeId} not found, using default", biomeId);
_logger.LogWarning("No valid biomes for depth {Depth}, using fallback", depth);

// Error
_logger.LogError(ex, "Failed to load biome configuration from {Path}", configPath);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| BiomeDefinition entity | ~6 |
| BiomeDescriptors value object | ~4 |
| BiomeRules value object | ~5 |
| BiomeService | ~7 |
| Room biome integration | ~3 |
| **Total** | **~25** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `BiomeDefinitionTests.cs` | ~6 | Create, validation, IsValidForDepth, HasTag |
| `BiomeDescriptorsTests.cs` | ~4 | Default, GetRandomDescriptor, IsValid |
| `BiomeRulesTests.cs` | ~5 | Default, Apply* methods |
| `BiomeServiceTests.cs` | ~7 | GetBiome, GetBiomesForDepth, SelectBiomeForPosition, GetRandomDescriptor |
| `RoomBiomeTests.cs` | ~3 | SetBiome, HasBiome |

### 13.3 Test Categories

**BiomeDefinition Tests:**
```csharp
[Test]
public void Create_WithValidParameters_CreatesBiomeDefinition()

[Test]
public void Create_WithNullId_ThrowsArgumentException()

[Test]
public void Create_WithNegativeMinDepth_ThrowsArgumentOutOfRangeException()

[Test]
public void Create_WithMaxDepthLessThanMinDepth_ThrowsArgumentException()

[Test]
public void IsValidForDepth_WithDepthInRange_ReturnsTrue()

[Test]
public void IsValidForDepth_WithDepthBelowMin_ReturnsFalse()

[Test]
public void IsValidForDepth_WithDepthAboveMax_ReturnsFalse()

[Test]
public void IsValidForDepth_WithNoMaxDepth_ReturnsTrueForHighDepth()

[Test]
public void HasTag_WithMatchingTag_ReturnsTrue()

[Test]
public void HasTag_WithNoMatchingTag_ReturnsFalse()
```

**BiomeService Tests:**
```csharp
[Test]
public void GetBiome_WithExistingId_ReturnsBiome()

[Test]
public void GetBiome_WithNonExistingId_ReturnsNull()

[Test]
public void GetBiomesForDepth_ReturnsOnlyValidBiomes()

[Test]
public void SelectBiomeForPosition_ReturnsValidBiomeForDepth()

[Test]
public void SelectBiomeForPosition_WithNoValidBiomes_ReturnsDefault()

[Test]
public void GetRandomDescriptor_ReturnsDescriptorFromPool()

[Test]
public void GetBiomesByTags_WithMatchAll_ReturnsOnlyFullMatches()
```

---

## 14. Use Cases

### UC-001: Generate Room with Biome

**Actor:** System (Room Generator)
**Flow:** Room generated → BiomeService.SelectBiomeForPosition(position) → Room.SetBiome(biomeId) → Room has biome

### UC-002: Display Biome-Themed Room

**Actor:** Player
**Flow:** Player enters room → DescriptorService.GenerateBiomeRoomDescription(room, position) → Biome descriptors selected → Themed description displayed

### UC-003: Apply Biome Rules

**Actor:** System (Game Logic)
**Flow:** Player performs action → BiomeService.GetBiome(room.BiomeId) → Rules.Apply*Modifier() → Modified result applied

### UC-004: Filter Biomes by Depth

**Actor:** System (Room Generator)
**Flow:** Generating room at depth Z → BiomeService.GetBiomesForDepth(Z) → Valid biomes returned → Weighted selection performed

### UC-005: Look Up Biome Information

**Actor:** System (UI/Codex)
**Flow:** Display biome info → BiomeService.GetBiome(biomeId) → BiomeDefinition returned → Name, description, icon displayed

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `BiomeDefinition.cs` created
- [ ] `BiomeDescriptors.cs` created
- [ ] `BiomeRules.cs` created
- [ ] `Room.cs` updated with BiomeId

### Application Layer
- [ ] `IBiomeService.cs` created
- [ ] `BiomeService.cs` created
- [ ] `DescriptorService.cs` updated with biome support

### Infrastructure Layer
- [ ] `IConfigurationProvider.cs` updated
- [ ] `JsonConfigurationProvider.cs` updated to load biomes
- [ ] `BiomeConfigurationDto.cs` created

### Configuration Files
- [ ] `config/biomes.json` created with 6 default biomes
- [ ] `config/schemas/biomes-schema.json` created

### Testing
- [ ] `BiomeDefinitionTests.cs` created (~6 tests)
- [ ] `BiomeDescriptorsTests.cs` created (~4 tests)
- [ ] `BiomeRulesTests.cs` created (~5 tests)
- [ ] `BiomeServiceTests.cs` created (~7 tests)
- [ ] `RoomBiomeTests.cs` created (~3 tests)
- [ ] All ~25 tests passing

### Documentation
- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 16. Acceptance Criteria

### Functional

- [ ] BiomeDefinition entity stores all biome properties
- [ ] BiomeDescriptors provides 6 descriptor categories
- [ ] BiomeRules applies gameplay modifiers correctly
- [ ] BiomeService loads biomes from JSON configuration
- [ ] BiomeService.GetBiome returns definition by ID
- [ ] BiomeService.GetBiomesForDepth filters by depth constraints
- [ ] BiomeService.SelectBiomeForPosition uses weighted selection
- [ ] BiomeService.GetRandomDescriptor returns seeded descriptor
- [ ] Room.BiomeId stores assigned biome
- [ ] Room.SetBiome validates and assigns biome
- [ ] DescriptorService generates biome-themed descriptions
- [ ] Six default biomes configured with unique characteristics

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~25 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on public members
- [ ] Code follows .editorconfig conventions
- [ ] No hardcoded descriptor strings outside configuration

---

## 17. Dependencies

### 17.1 Prerequisites (v0.1.1)

| Component | Purpose for v0.1.2a |
|-----------|---------------------|
| `SeededRandomService` | Reproducible biome selection |
| `DescriptorService` | Base for biome descriptor integration |
| `EnvironmentContext` | Existing biome reference pattern |
| `Room.Position3D` | Z-axis depth for biome selection |
| `IConfigurationProvider` | Configuration loading pattern |
| `Position3D` | Position-based seeded randomization |

### 17.2 Provides to Future Phases

| Component | Used By |
|-----------|---------|
| `BiomeDefinition` | v0.1.2b (Spawn Tables), v0.1.2c (Hazards), v0.1.2d (Transitions) |
| `BiomeService` | All subsequent v0.1.2 phases |
| `Room.BiomeId` | All biome-aware features |
| `BiomeDescriptors` | Room generation, description service |
| `BiomeRules` | Combat service, movement service |

### 17.3 Dependency Diagram

```
v0.1.1 (Dynamic Room Generation)
    │
    ├── SeededRandomService ──────────┐
    ├── DescriptorService ────────────┤
    ├── EnvironmentContext ───────────┤
    └── Room.Position3D ──────────────┘
                                      │
                                      ▼
v0.1.2a (Biome System Core)
    │
    ├── BiomeDefinition ──────────────────────────────────┐
    ├── BiomeDescriptors ──────────────────────────────── │
    ├── BiomeRules ───────────────────────────────────────│
    ├── BiomeService ─────────────────────────────────────┤
    └── Room.BiomeId ─────────────────────────────────────┘
                                                          │
                                                          ▼
                                      ┌───────────────────┴───────────────────┐
                                      │                                       │
                                      ▼                                       ▼
                              v0.1.2b (Content Pools)             v0.1.2c (Hazards)
                                      │                                       │
                                      └───────────────────┬───────────────────┘
                                                          │
                                                          ▼
                                              v0.1.2d (Transitions)
```

---

## 18. Future Considerations

### 18.1 Deferred to v0.1.2b

- **BiomeSpawnTable** - Monster/item pools per biome
- **Biome-exclusive content** - Monsters and items unique to biomes
- **Crafting materials** - Biome-specific resource drops

### 18.2 Deferred to v0.1.2c

- **BiomeHazard** - Environmental dangers per biome
- **BiomeDamageModifier** - Elemental resistance/vulnerability
- **Ambient damage application** - BiomeRules.AmbientDamage processing

### 18.3 Deferred to v0.1.2d

- **BiomeTransition** - Rules for zone connections
- **Transitional zones** - Blended areas between biomes
- **BiomeProgress** - Player discovery tracking
- **Codex integration** - Biome lore entries

### 18.4 Out of Scope (Future Versions)

- **Custom biome creation UI** - Player/modder biome editor
- **Biome-specific quests** - Quest chains tied to biomes
- **Biome weather effects** - Dynamic environmental changes
- **Biome music/sound themes** - Audio integration

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
