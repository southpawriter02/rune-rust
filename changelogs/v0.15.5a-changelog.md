# v0.15.5a Changelog - Extended Tracking System

## Summary

Implements the **Extended Tracking System** for the Wasteland Survival skill. This multi-phase tracking subsystem enables characters to pursue targets across the wasteland through systematic trail analysis. Features a 5-phase state machine (Acquisition, Pursuit, ClosingIn, Lost, Cold), 6 trail age classifications with base DCs (Obvious DC8 to Cold DC28), terrain-based check intervals, comprehensive condition modifiers, and 3 recovery procedures (Backtrack, SpiralSearch, ReturnToLastKnown) with escalating DC penalties.

## Added

### Domain Layer - Enums (4 files)

| File | Description |
|------|-------------|
| `TrailAge.cs` | 6-level enum with DC values: Obvious (8), Fresh (12), Standard (16), Old (20), Obscured (24), Cold (28). Cold trails require Master rank (Rank 5) in Wasteland Survival. |
| `TrackingPhase.cs` | 5-phase state machine enum: Acquisition (initial trail finding), Pursuit (following over distance), ClosingIn (final approach), Lost (recovery needed), Cold (terminal - unrecoverable). |
| `TrackingStatus.cs` | 4-value status enum: Active (pursuit in progress), Abandoned (player chose to stop), TargetFound (successfully located), TrailCold (unrecoverable). |
| `NavigationTerrainType.cs` | **NEW** 5-value terrain enum for overland navigation: OpenWasteland, ModerateRuins, DenseRuins, Labyrinthine, GlitchedLabyrinth. Distinct from TerrainType (used for combat grids). |

### Domain Layer - Value Objects (3 files)

| File | Description |
|------|-------------|
| `TrackingModifiers.cs` | Sealed class for condition-based modifiers. DC modifiers: blood trail (-4), rain (+4), multiple targets (-2), target hiding (+2), fresh injury (-2), hours elapsed (+1/hr). Dice modifiers: equipment bonus, familiar territory (+2d10). Methods: `TotalDcModifier`, `TotalDiceModifier`, `GetCheckIntervalMiles()`, `ToSkillContext()`. Factory: `Default`. |
| `TrackingCheck.cs` | `readonly record struct` for individual check records. Properties: CheckId, Phase, BaseDc, EffectiveDc, NetSuccesses, Outcome, Terrain, DistanceAtCheck, Timestamp, ModifiersApplied. Computed: `IsSuccess`, `IsCriticalSuccess`, `IsFumble`, `IsFailure`, `Margin`, `DcModifierApplied`. Factory methods: `FromSkillCheck()`, `Create()`. |
| `TrackingResult.cs` | `readonly record struct` result container. Properties: IsSuccess, Phase, PreviousPhase, Check, TrackingState, NarrativeDescription, NextActions, DiscoveredInfo. Computed: `PhaseChanged`, `IsComplete`, `TrailWentCold`, `TargetFound`, `TrailLost`, `RecoverySuccessful`, `WasAcquisition`, `HasDiscovery`. Factory methods: `Success()`, `Failure()`, `TargetLocated()`, `TrailGoneCold()`. Includes `TrackingDiscovery` record struct with factory methods: `DirectionOnly()`, `WithTargetCount()`, `WithTrailAge()`, `Full()`. |

### Domain Layer - Entities (1 file)

| File | Description |
|------|-------------|
| `TrackingState.cs` | Aggregate root entity managing tracking pursuit lifecycle. Properties: TrackingId, TrackerId, TargetDescription, CurrentPhase, TrailAge, DistanceCovered, CumulativeDcModifier, FailedAttemptsInPhase, CheckHistory, TerrainHistory, Status, StartedAt, LastCheckAt, EstimatedDistanceToTarget, EstimatedTargetCount. Computed: `BaseDc`, `EffectiveDc`, `IsActive`, `IsComplete`, `TotalChecks`, `SuccessfulChecks`, `FailedChecks`. State transitions: `TransitionToPursuit()`, `TransitionToClosingIn()`, `TransitionToLost()`, `TransitionToCold()`, `RecoverToPursuit()`. Status updates: `MarkTargetFound()`, `Abandon()`. Factory: `Create()`. |

### Domain Layer - Interfaces (2 files)

| File | Description |
|------|-------------|
| `ITrackingStateRepository.cs` | Repository interface: `SaveAsync()`, `GetByIdAsync()`, `GetActiveByTrackerAsync()`, `GetAllByTrackerAsync()`, `DeleteAsync()`, `HasActiveTrackingAsync()`. Supports async operations with CancellationToken. |
| `ITrackingService.cs` | Service interface: `InitiateTrackingAsync()`, `ContinuePursuitAsync()`, `AttemptRecoveryAsync()`, `CloseInAsync()`, `GetTrackingStateAsync()`, `GetActiveTrackingAsync()`, `HasActiveTrackingAsync()`, `AbandonTrackingAsync()`, `EstimateTargetCountAsync()`, `EstimateTrailAgeAsync()`. Includes `RecoveryType` enum (Backtrack, SpiralSearch, ReturnToLastKnown). |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `TrackingService.cs` | Full implementation of ITrackingService. Dependencies: SkillCheckService, ITrackingStateRepository, IGameConfigurationProvider, ILogger. Constants: EstimateTargetCountDc (10), EstimateTrailAgeDc (12), AcquisitionRetryDcModifier (+2), SpiralSearchDcModifier (+4), ReturnToLastKnownDcModifier (+8), MaxFailedAttempts (3), ClosingInThresholdFeet (500), AutoSuccessDistanceFeet (50), Within500FtDcModifier (-4), Within100FtDcModifier (-6), MasterRankRequirement (5). Comprehensive logging at Information and Debug levels. Narrative text generation based on outcome tiers. |

### Configuration (4 files)

| File | Description |
|------|-------------|
| `config/trail-ages.json` | Trail age definitions: 6 types with id, type, baseDc, displayName, description, timeRange, requiresMasterRank, examples. |
| `config/tracking-modifiers.json` | Condition modifiers (blood trail, rain, etc.), equipment bonuses, terrain check intervals, recovery procedures with dcModifier and timeCost, closing-in modifiers, failure thresholds (maxFailedAcquisition, maxFailedRecovery), optional checks (estimateTargetCount DC 10, estimateTrailAge DC 12). |
| `config/schemas/trail-ages.schema.json` | JSON Schema 2020-12 for trail-ages.json validation. |
| `config/schemas/tracking-modifiers.schema.json` | JSON Schema 2020-12 for tracking-modifiers.json validation. |

### Unit Tests (1 file, 18+ tests)

| File | Tests |
|------|-------|
| `TrackingServiceTests.cs` | Trail age DC tests (6 parameterized cases: 8/12/16/20/24/28), Tracking modifier accumulation (blood trail -4, injury -2, multiple targets -2, rain +4, hiding +2, hours +N, equipment/familiar territory dice), Terrain check interval tests (5 cases: 2.0/1.0/0.5/0.1/0.1 miles), Phase transition tests (Acquisition→Pursuit→ClosingIn→Lost→Pursuit, Cold terminal), Invalid transition exceptions, Failed attempts increment/reset, Recovery procedure DC tests (3 parameterized cases: Backtrack +0, SpiralSearch +4, ReturnToLastKnown +8), Initiate tracking tests, Continue pursuit validation, CloseIn auto-success within 50ft, Abandon tracking tests, State query delegation, Result factory method tests, Discovery factory method tests. |

## Key Features

### Trail Age Classification

| Trail Age | Base DC | Time Range | Description |
|-----------|:-------:|------------|-------------|
| Obvious | 8 | Recent | Caravan, large group passage |
| Fresh | 12 | <1 hour | Clear footprints, undisturbed |
| Standard | 16 | 2-8 hours | Partially obscured, settling |
| Old | 20 | 12-24 hours | Significantly degraded |
| Obscured | 24 | Any | Deliberately hidden trail |
| Cold | 28 | 24-48 hours | Master rank required |

### Tracking Phase State Machine

```
Acquisition → Pursuit → ClosingIn → TargetFound
     ↓            ↓           ↓
     └──────── Lost ←────────┘
                 ↓
               Cold
```

| Phase | Check Type | On Success | On Failure |
|-------|------------|------------|------------|
| Acquisition | Find trail | → Pursuit | Retry (+2 DC) or → Cold |
| Pursuit | Maintain trail | Continue | → Lost |
| ClosingIn | Final approach | → TargetFound | → Lost (target alerted) |
| Lost | Recovery | → Pursuit | Retry or → Cold |
| Cold | N/A | Terminal | Terminal |

### Condition Modifiers

| Condition | DC Modifier | Description |
|-----------|:-----------:|-------------|
| Blood trail | -4 | Target leaving blood |
| Fresh injury | -2 | Active bleeding |
| Multiple targets (2+) | -2 | More signs of passage |
| Recent rain | +4 | Tracks washed away |
| Target hiding | +2 | Counter-tracking |
| Time elapsed | +1/hour | Trail degradation |

### Navigation Terrain Types

| Terrain | Check Interval | Navigation DC |
|---------|:--------------:|:-------------:|
| OpenWasteland | 2.0 miles | 8 |
| ModerateRuins | 1.0 mile | 12 |
| DenseRuins | 0.5 miles | 16 |
| Labyrinthine | 0.1 miles | 20 |
| GlitchedLabyrinth | 0.1 miles | 24 |

### Recovery Procedures

| Procedure | DC Modifier | Time Cost | Description |
|-----------|:-----------:|:---------:|-------------|
| Backtrack | +0 | 10 min | Retrace steps |
| SpiralSearch | +4 | 30 min | Expand search area |
| ReturnToLastKnown | +8 | 1 hour | Go back to confirmed position |

### Closing In Modifiers

| Distance | DC Modifier | Notes |
|----------|:-----------:|-------|
| ≤500 ft | -4 | Target may detect pursuit |
| ≤100 ft | -6 | Contested vs target Perception |
| ≤50 ft | Auto-success | Immediate encounter |

## Files Changed

### Added (17 files)
- `src/Core/RuneAndRust.Domain/Enums/TrailAge.cs`
- `src/Core/RuneAndRust.Domain/Enums/TrackingPhase.cs`
- `src/Core/RuneAndRust.Domain/Enums/TrackingStatus.cs`
- `src/Core/RuneAndRust.Domain/Enums/NavigationTerrainType.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/TrackingModifiers.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/TrackingCheck.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/TrackingResult.cs`
- `src/Core/RuneAndRust.Domain/Entities/TrackingState.cs`
- `src/Core/RuneAndRust.Domain/Interfaces/ITrackingStateRepository.cs`
- `src/Core/RuneAndRust.Domain/Interfaces/ITrackingService.cs`
- `src/Core/RuneAndRust.Application/Services/TrackingService.cs`
- `config/trail-ages.json`
- `config/tracking-modifiers.json`
- `config/schemas/trail-ages.schema.json`
- `config/schemas/tracking-modifiers.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/TrackingServiceTests.cs`
- `changelogs/v0.15.5a-changelog.md`

## Dependencies

- `SkillCheckService.cs` - For performing Wasteland Survival skill checks
- `SkillCheckResult.cs` - Result type from skill checks
- `SkillContext.cs` - For passing equipment/situational modifiers
- `SkillContextBuilder.cs` - For constructing skill contexts
- `SkillOutcome.cs` enum - For outcome classification
- `Player.cs` entity - For tracker identification
- `IGameConfigurationProvider.cs` - For configuration access

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithContext()` for all tracking checks
- **SkillContext**: TrackingModifiers converts to SkillContext via `ToSkillContext()`
- **ITrackingStateRepository**: Persistence abstraction for tracking state
- **IGameConfigurationProvider**: Configuration for skill definitions

## Notes

- TrailAge enum values ARE the base DC (e.g., `TrailAge.Standard = 16`)
- NavigationTerrainType is distinct from TerrainType (combat grids)
- One active tracking pursuit per player at a time
- 3 failed acquisition attempts → trail cold
- 3 failed recovery attempts → trail cold
- Fumble during acquisition → immediate cold
- Master rank (Rank 5) required for Cold trails (DC 28)
- Auto-success when within 50 feet of target
- HasMasterRank() is a placeholder pending skill rank system integration
