# v0.0.8a Design Specification: Core Experience System

**Version:** 0.0.8a
**Parent:** v0.0.8 (Experience & Leveling)
**Prerequisites:** v0.0.7 Complete (Equipment System)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#overview)
2. [Scope](#scope)
3. [Data Model](#data-model)
4. [Services](#services)
5. [Command Changes](#command-changes)
6. [Rendering Changes](#rendering-changes)
7. [Configuration](#configuration)
8. [Acceptance Criteria](#acceptance-criteria)
9. [Test Specifications](#test-specifications)
10. [Dependencies](#dependencies)

---

## Overview

### Purpose

Establish the foundational experience system that allows players to earn XP from defeating monsters. This phase creates the core infrastructure that v0.0.8b (Level-Up Mechanics) and v0.0.8c (Progression Configuration) will build upon, including experience tracking on the Player entity, XP values on monsters, XP awarding on combat victory, and XP display in the game UI.

### Key Changes

| Area | Current State (v0.0.7) | Target State (v0.0.8a) |
|------|------------------------|------------------------|
| Player Entity | Has `Level` property (set manually) | Adds `Experience` property, `AddExperience()` method |
| Monster Entity | No XP value | Adds `ExperienceValue` property |
| Combat Result | Returns damage dealt/received | Adds `ExperienceGained` on monster defeat |
| Status Display | Shows HP, stats | Adds XP progress display |
| Combat Display | Shows damage and defeat | Shows XP gain message on victory |

### Design Principles

1. **Foundation First**: Build the XP tracking infrastructure without level-up logic (reserved for v0.0.8b)
2. **Minimal Changes**: Extend existing entities rather than creating new ones where possible
3. **Service Encapsulation**: XP awarding logic lives in `ExperienceService`, not scattered across handlers
4. **Display Consistency**: XP display follows established status output patterns
5. **Future-Ready**: Infrastructure supports configurable XP formulas (implemented in v0.0.8c)

---

## Scope

### In Scope

- `Experience` property on `Player` entity (int, default 0)
- `AddExperience(amount)` method on `Player` entity
- `ExperienceToNextLevel` computed property on `Player` (default formula initially)
- `ExperienceProgressPercent` computed property on `Player` (0-100)
- `ExperienceValue` property on `Monster` entity
- Update `Monster.CreateGoblin()` factory to include 25 XP
- `ExperienceGainResult` value object for XP award results
- `ExperienceService` for XP calculation and awarding
- `ExperienceGained` property added to `CombatResult` record
- `CombatService.ResolveCombatRound()` includes XP value when monster defeated
- `ExperienceGainDto` for presenting XP gain to the UI
- XP display in status output ("XP: 75/100 (75%)")
- XP gain message after combat victory ("You gained 25 XP!")
- Update `IGameRenderer` with `RenderExperienceGainAsync()`
- Implement XP rendering in `SpectreGameRenderer`

### Out of Scope (Future Phases)

- Level-up detection (v0.0.8b)
- Stat increases on level-up (v0.0.8b)
- Level-up notifications (v0.0.8b)
- Configurable XP terminology (v0.0.8c)
- Configurable progression curves (v0.0.8c)
- Class-specific XP bonuses (v0.0.8c)
- XP from sources other than monster kills (future)

---

## Data Model

### Modified: Player (Entity)

```csharp
// Add to existing Player entity in src/Core/RuneAndRust.Domain/Entities/Player.cs

/// <summary>
/// Gets the player's current experience points.
/// </summary>
/// <remarks>
/// Experience accumulates from defeating monsters and other sources.
/// When experience reaches the threshold for the next level, level-up
/// logic is handled by ProgressionService (v0.0.8b).
/// </remarks>
public int Experience { get; private set; } = 0;

/// <summary>
/// Gets the experience points required to reach the next level.
/// </summary>
/// <remarks>
/// Uses a default formula initially: Level * 100.
/// This will be replaced with configurable curves in v0.0.8c.
/// </remarks>
public int ExperienceToNextLevel => GetDefaultXpForLevel(Level + 1);

/// <summary>
/// Gets the player's progress toward the next level as a percentage (0-100).
/// </summary>
/// <remarks>
/// Calculated as: (Experience / ExperienceToNextLevel) * 100, clamped to 0-100.
/// </remarks>
public int ExperienceProgressPercent
{
    get
    {
        if (ExperienceToNextLevel <= 0) return 100;
        var percent = (int)((double)Experience / ExperienceToNextLevel * 100);
        return Math.Clamp(percent, 0, 100);
    }
}

/// <summary>
/// Adds experience points to the player.
/// </summary>
/// <param name="amount">The amount of experience to add (must be non-negative).</param>
/// <returns>The player's new experience total.</returns>
/// <exception cref="ArgumentOutOfRangeException">Thrown when amount is negative.</exception>
/// <remarks>
/// This method only adds XP; it does not check for or trigger level-ups.
/// Level-up detection is handled by ProgressionService (v0.0.8b).
/// </remarks>
public int AddExperience(int amount)
{
    ArgumentOutOfRangeException.ThrowIfNegative(amount);
    Experience += amount;
    return Experience;
}

/// <summary>
/// Gets the default XP required to reach a specific level.
/// </summary>
/// <param name="level">The level to get XP for.</param>
/// <returns>The cumulative XP required.</returns>
/// <remarks>
/// Default formula: level * 100 (Level 2 = 100 XP, Level 3 = 200 XP, etc.)
/// This will be replaced with configurable curves in v0.0.8c.
/// </remarks>
private static int GetDefaultXpForLevel(int level)
{
    if (level <= 1) return 0;
    return level * 100;
}
```

### Modified: Monster (Entity)

```csharp
// Add to existing Monster entity in src/Core/RuneAndRust.Domain/Entities/Monster.cs

/// <summary>
/// Gets the experience points awarded when this monster is defeated.
/// </summary>
/// <remarks>
/// XP is awarded to the player upon defeating the monster.
/// Value is set during construction, typically via factory methods.
/// </remarks>
public int ExperienceValue { get; private set; }

// Update existing constructor to include experienceValue parameter:
/// <summary>
/// Creates a new monster with the specified properties.
/// </summary>
/// <param name="name">The display name of the monster.</param>
/// <param name="description">The description shown to players.</param>
/// <param name="maxHealth">The maximum health points of the monster.</param>
/// <param name="stats">The combat statistics for the monster.</param>
/// <param name="experienceValue">The XP awarded when defeated (default 0).</param>
/// <exception cref="ArgumentNullException">Thrown when name or description is null.</exception>
/// <exception cref="ArgumentOutOfRangeException">Thrown when maxHealth is not positive.</exception>
public Monster(string name, string description, int maxHealth, Stats stats, int experienceValue = 0)
{
    Id = Guid.NewGuid();
    Name = name ?? throw new ArgumentNullException(nameof(name));
    Description = description ?? throw new ArgumentNullException(nameof(description));
    MaxHealth = maxHealth > 0 ? maxHealth : throw new ArgumentOutOfRangeException(nameof(maxHealth));
    Health = maxHealth;
    Stats = stats;
    ExperienceValue = Math.Max(0, experienceValue); // No negative XP
}

// Update factory method:
/// <summary>
/// Factory method to create a basic goblin enemy.
/// </summary>
/// <returns>A new goblin monster with 25 XP value.</returns>
public static Monster CreateGoblin() => new(
    "Goblin",
    "A small, green creature with sharp teeth and beady eyes. It looks hostile.",
    30,
    new Stats(30, 8, 2),
    experienceValue: 25
);
```

### Modified: CombatResult (Record)

```csharp
// Modify existing CombatResult in src/Core/RuneAndRust.Domain/Services/CombatService.cs

/// <summary>
/// Represents the outcome of a single round of combat.
/// </summary>
/// <param name="DamageDealt">The amount of damage the player dealt to the monster.</param>
/// <param name="DamageReceived">The amount of damage the player received from the monster.</param>
/// <param name="MonsterDefeated">True if the monster was defeated this round.</param>
/// <param name="PlayerDefeated">True if the player was defeated this round.</param>
/// <param name="ExperienceGained">The XP gained from defeating the monster (0 if not defeated).</param>
public record CombatResult(
    int DamageDealt,
    int DamageReceived,
    bool MonsterDefeated,
    bool PlayerDefeated,
    int ExperienceGained = 0
);
```

### New: ExperienceGainResult (Value Object)

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of an experience gain operation.
/// </summary>
/// <param name="AmountGained">The XP amount that was gained.</param>
/// <param name="NewTotal">The player's new total XP after the gain.</param>
/// <param name="PreviousTotal">The player's XP before the gain.</param>
/// <param name="Source">A description of where the XP came from.</param>
public readonly record struct ExperienceGainResult(
    int AmountGained,
    int NewTotal,
    int PreviousTotal,
    string Source)
{
    /// <summary>
    /// Gets whether any experience was actually gained.
    /// </summary>
    public bool DidGainExperience => AmountGained > 0;

    /// <summary>
    /// Creates an experience gain result from defeating a monster.
    /// </summary>
    /// <param name="monsterName">The name of the defeated monster.</param>
    /// <param name="xpValue">The XP value of the monster.</param>
    /// <param name="previousTotal">The player's XP before the gain.</param>
    /// <param name="newTotal">The player's XP after the gain.</param>
    /// <returns>An ExperienceGainResult for the monster defeat.</returns>
    public static ExperienceGainResult FromMonsterDefeat(
        string monsterName,
        int xpValue,
        int previousTotal,
        int newTotal) =>
        new(xpValue, newTotal, previousTotal, $"Defeated {monsterName}");

    /// <summary>
    /// Creates a result indicating no experience was gained.
    /// </summary>
    /// <param name="currentTotal">The player's current XP total.</param>
    /// <returns>An ExperienceGainResult with zero gain.</returns>
    public static ExperienceGainResult None(int currentTotal) =>
        new(0, currentTotal, currentTotal, string.Empty);
}
```

---

## Services

### New: ExperienceService

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Services;

/// <summary>
/// Service for managing experience point awards and calculations.
/// </summary>
/// <remarks>
/// Handles the logic for awarding XP to players from various sources.
/// Level-up detection and stat increases are handled by ProgressionService (v0.0.8b).
/// </remarks>
public class ExperienceService
{
    private readonly ILogger<ExperienceService> _logger;

    /// <summary>
    /// Creates a new ExperienceService instance.
    /// </summary>
    /// <param name="logger">The logger for experience operations.</param>
    public ExperienceService(ILogger<ExperienceService> logger)
    {
        _logger = logger;
    }

    /// <summary>
    /// Awards experience points to a player from defeating a monster.
    /// </summary>
    /// <param name="player">The player to award XP to.</param>
    /// <param name="monster">The defeated monster (must be defeated).</param>
    /// <returns>The result of the XP award operation.</returns>
    /// <exception cref="ArgumentNullException">Thrown when player or monster is null.</exception>
    /// <remarks>
    /// Only awards XP if the monster is actually defeated (IsDefeated == true).
    /// Returns ExperienceGainResult.None if the monster is still alive.
    /// </remarks>
    public ExperienceGainResult AwardExperienceFromMonster(Player player, Monster monster)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(monster);

        // Don't award XP for alive monsters
        if (!monster.IsDefeated)
        {
            _logger.LogWarning(
                "Attempted to award XP from non-defeated monster {MonsterName}",
                monster.Name);
            return ExperienceGainResult.None(player.Experience);
        }

        // Don't award if monster has no XP value
        if (monster.ExperienceValue <= 0)
        {
            _logger.LogDebug(
                "Monster {MonsterName} has no XP value",
                monster.Name);
            return ExperienceGainResult.None(player.Experience);
        }

        return AwardExperience(player, monster.ExperienceValue, $"Defeated {monster.Name}");
    }

    /// <summary>
    /// Awards a specific amount of experience points to a player.
    /// </summary>
    /// <param name="player">The player to award XP to.</param>
    /// <param name="amount">The amount of XP to award.</param>
    /// <param name="source">A description of where the XP came from.</param>
    /// <returns>The result of the XP award operation.</returns>
    /// <exception cref="ArgumentNullException">Thrown when player is null.</exception>
    /// <remarks>
    /// For zero or negative amounts, returns ExperienceGainResult.None.
    /// </remarks>
    public ExperienceGainResult AwardExperience(Player player, int amount, string source)
    {
        ArgumentNullException.ThrowIfNull(player);

        if (amount <= 0)
        {
            _logger.LogDebug("No XP to award (amount: {Amount})", amount);
            return ExperienceGainResult.None(player.Experience);
        }

        var previousXp = player.Experience;
        var newTotal = player.AddExperience(amount);

        _logger.LogInformation(
            "Player {PlayerName} gained {Amount} XP from {Source} (Total: {PreviousXp} -> {NewTotal})",
            player.Name, amount, source, previousXp, newTotal);

        return new ExperienceGainResult(amount, newTotal, previousXp, source);
    }

    /// <summary>
    /// Gets the default XP value for a monster by name.
    /// </summary>
    /// <param name="monsterName">The name of the monster.</param>
    /// <returns>The default XP value.</returns>
    /// <remarks>
    /// This is a temporary method for looking up XP values.
    /// Will be replaced with configuration-based lookup in v0.0.8c.
    /// </remarks>
    public static int GetDefaultMonsterXp(string monsterName)
    {
        return monsterName.ToLowerInvariant() switch
        {
            "goblin" => 25,
            _ => 10 // Default for unknown monsters
        };
    }
}
```

### Modified: CombatService

```csharp
// Modify ResolveCombatRound in src/Core/RuneAndRust.Domain/Services/CombatService.cs

/// <summary>
/// Resolves a single round of combat between a player and a monster.
/// </summary>
/// <param name="player">The player engaging in combat.</param>
/// <param name="monster">The monster being fought.</param>
/// <returns>A <see cref="CombatResult"/> containing the outcome of the combat round.</returns>
/// <exception cref="ArgumentNullException">Thrown when player or monster is null.</exception>
/// <remarks>
/// Combat proceeds as follows:
/// <list type="number">
/// <item>Player attacks the monster, dealing damage based on attack vs defense.</item>
/// <item>If the monster survives, it counterattacks the player.</item>
/// <item>The result indicates damage dealt/received, defeat status, and XP gained.</item>
/// </list>
/// </remarks>
public CombatResult ResolveCombatRound(Player player, Monster monster)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(monster);

    _logger.LogDebug(
        "Resolving combat round - Player: {PlayerName} vs Monster: {MonsterName}",
        player.Name, monster.Name);

    // Player attacks first
    var playerDamage = CalculateDamage(player.Stats.Attack, monster.Stats.Defense);
    var actualPlayerDamage = monster.TakeDamage(playerDamage);

    var monsterDamage = 0;
    var actualMonsterDamage = 0;

    // Monster attacks if still alive
    if (monster.IsAlive)
    {
        monsterDamage = CalculateDamage(monster.Stats.Attack, player.Stats.Defense);
        actualMonsterDamage = player.TakeDamage(monsterDamage);
    }

    // Determine XP gained (only if monster was defeated)
    var experienceGained = monster.IsDefeated ? monster.ExperienceValue : 0;

    var result = new CombatResult(
        DamageDealt: actualPlayerDamage,
        DamageReceived: actualMonsterDamage,
        MonsterDefeated: monster.IsDefeated,
        PlayerDefeated: player.IsDead,
        ExperienceGained: experienceGained  // NEW
    );

    _logger.LogInformation(
        "Combat round complete - Dealt: {DamageDealt}, Received: {DamageReceived}, " +
        "MonsterDefeated: {MonsterDefeated}, PlayerDefeated: {PlayerDefeated}, XP: {XP}",
        result.DamageDealt, result.DamageReceived,
        result.MonsterDefeated, result.PlayerDefeated, result.ExperienceGained);

    return result;
}
```

### Service Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      XP AWARD FLOW (Monster Defeat)                          │
└─────────────────────────────────────────────────────────────────────────────┘

    Monster Defeated in Combat
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 1: COMBAT RESULT                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  CombatService.ResolveCombatRound()                                         │
│  ├── MonsterDefeated = true                                                 │
│  └── ExperienceGained = monster.ExperienceValue (e.g., 25)                  │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 2: EXPERIENCE SERVICE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  ExperienceService.AwardExperienceFromMonster(player, monster)              │
│  ├── Check monster.IsDefeated? (must be true)                               │
│  ├── Check monster.ExperienceValue > 0?                                     │
│  ├── previousXp = player.Experience                                         │
│  ├── newTotal = player.AddExperience(amount)                                │
│  ├── Log: "Player gained 25 XP from Defeated Goblin"                        │
│  └── Return ExperienceGainResult                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 3: CREATE DTO                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ExperienceGainDto.FromResult(result, level, xpToNext, progressPercent)     │
│  ├── AmountGained: 25                                                       │
│  ├── NewTotal: 25                                                           │
│  ├── Source: "Defeated Goblin"                                              │
│  ├── CurrentLevel: 1                                                        │
│  ├── ExperienceToNextLevel: 200                                             │
│  └── ProgressPercent: 12                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 4: RENDER XP GAIN                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  IGameRenderer.RenderExperienceGainAsync(dto)                               │
│  ├── "★ You gained 25 XP!"                                                  │
│  └── "XP: 25/200 (12%)"                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Command Changes

### No New Commands

v0.0.8a does not introduce any new player commands. Experience is gained automatically through combat and displayed through existing mechanisms (status command, combat results).

### Modified: Status Command Output

The existing `status` command will be enhanced to display XP information:

```
> status

=== Hero (Level 1 Warrior) ===
HP: 100/100
XP: 75/200 (37%)           <-- NEW: Experience display
Attack: 15  Defense: 8
```

### Combat Victory Output

After defeating a monster, the combat output will include XP gain:

```
> attack goblin

You attack the Goblin for 12 damage!
The Goblin has been defeated!

★ You gained 25 XP!        <-- NEW: XP gain message
XP: 25/200 (12%)           <-- NEW: Progress display
```

---

## Rendering Changes

### New: ExperienceGainDto

```csharp
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for displaying experience gain information to the UI.
/// </summary>
/// <param name="AmountGained">The XP amount gained.</param>
/// <param name="NewTotal">The player's new total XP.</param>
/// <param name="Source">Description of the XP source.</param>
/// <param name="CurrentLevel">The player's current level.</param>
/// <param name="ExperienceToNextLevel">XP needed for next level.</param>
/// <param name="ProgressPercent">Progress toward next level (0-100).</param>
public record ExperienceGainDto(
    int AmountGained,
    int NewTotal,
    string Source,
    int CurrentLevel,
    int ExperienceToNextLevel,
    int ProgressPercent)
{
    /// <summary>
    /// Creates a DTO from an ExperienceGainResult and player state.
    /// </summary>
    /// <param name="result">The experience gain result.</param>
    /// <param name="currentLevel">The player's current level.</param>
    /// <param name="xpToNextLevel">XP needed for next level.</param>
    /// <param name="progressPercent">Progress percentage.</param>
    /// <returns>A DTO for rendering.</returns>
    public static ExperienceGainDto FromResult(
        ExperienceGainResult result,
        int currentLevel,
        int xpToNextLevel,
        int progressPercent) =>
        new(
            result.AmountGained,
            result.NewTotal,
            result.Source,
            currentLevel,
            xpToNextLevel,
            progressPercent);
}
```

### Modified: IGameRenderer

```csharp
// Add to existing IGameRenderer interface in src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs

/// <summary>
/// Renders experience gain information after combat or other XP sources.
/// </summary>
/// <param name="experienceGain">The XP gain information to display.</param>
/// <param name="ct">Cancellation token.</param>
/// <returns>A task representing the async operation.</returns>
Task RenderExperienceGainAsync(ExperienceGainDto experienceGain, CancellationToken ct = default);
```

### Modified: SpectreGameRenderer

```csharp
// Implement in src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs

/// <inheritdoc />
public Task RenderExperienceGainAsync(ExperienceGainDto experienceGain, CancellationToken ct = default)
{
    AnsiConsole.WriteLine();
    AnsiConsole.MarkupLine($"[yellow]★[/] You gained [green]{experienceGain.AmountGained} XP[/]!");
    AnsiConsole.MarkupLine(
        $"[dim]XP: {experienceGain.NewTotal}/{experienceGain.ExperienceToNextLevel} " +
        $"({experienceGain.ProgressPercent}%)[/]");
    AnsiConsole.WriteLine();

    return Task.CompletedTask;
}

// Update RenderPlayerStatusAsync to include XP:
// In the status rendering section, add:

AnsiConsole.MarkupLine(
    $"XP: [cyan]{player.Experience}[/]/[cyan]{player.ExperienceToNextLevel}[/] " +
    $"([cyan]{player.ExperienceProgressPercent}%[/])");
```

### Modified: GameSessionService

```csharp
// Update combat handling in src/Core/RuneAndRust.Application/Services/GameSessionService.cs

// Add ExperienceService dependency:
private readonly ExperienceService _experienceService;

// Update constructor:
public GameSessionService(
    // ... existing dependencies ...
    ExperienceService experienceService)
{
    // ... existing initialization ...
    _experienceService = experienceService;
}

// In HandleAttackCommand or equivalent combat resolution:
private async Task HandleCombatResult(CombatResult result, Monster monster, CancellationToken ct)
{
    // ... existing combat result handling (render damage, defeat message) ...

    // Award XP if monster was defeated
    if (result.MonsterDefeated && result.ExperienceGained > 0)
    {
        var xpResult = _experienceService.AwardExperienceFromMonster(_session!.Player, monster);

        if (xpResult.DidGainExperience)
        {
            var xpDto = ExperienceGainDto.FromResult(
                xpResult,
                _session.Player.Level,
                _session.Player.ExperienceToNextLevel,
                _session.Player.ExperienceProgressPercent);

            await _renderer.RenderExperienceGainAsync(xpDto, ct);
        }
    }
}
```

### Display Examples

**Status Command:**
```
> status

╭─────────────────────────────────────────╮
│     === Hero (Level 1 Warrior) ===      │
├─────────────────────────────────────────┤
│  HP: 100/100                            │
│  XP: 75/200 (37%)                       │
│  Attack: 15  Defense: 8                 │
╰─────────────────────────────────────────╯
```

**Combat Victory (Monster Defeated):**
```
> attack goblin

You attack the Goblin for 15 damage!
The Goblin has been defeated!

★ You gained 25 XP!
XP: 25/200 (12%)
```

**Combat (Monster Survives):**
```
> attack goblin

You attack the Goblin for 8 damage!
The Goblin strikes back for 3 damage!
```

*(No XP message when monster is not defeated)*

**Status After Multiple Kills:**
```
> status

=== Hero (Level 1 Warrior) ===
HP: 85/100
XP: 175/200 (87%)
Attack: 15  Defense: 8
```

---

## Configuration

*No configuration files are required for v0.0.8a. The XP system uses hardcoded default values that will be replaced with configurable values in v0.0.8c.*

### Default Values

| Setting | Value | Notes |
|---------|-------|-------|
| Starting XP | 0 | All new players start with 0 XP |
| Goblin XP | 25 | XP awarded for defeating a goblin |
| Default Monster XP | 10 | XP for monsters without specific value |
| Level 2 XP Threshold | 200 | XP needed to reach level 2 (Level * 100) |
| XP Formula | `level * 100` | Default progression curve |

---

## Acceptance Criteria

### Player Entity

- [ ] Player has `Experience` property (int, default 0)
- [ ] `AddExperience(amount)` adds XP and returns new total
- [ ] `AddExperience()` throws `ArgumentOutOfRangeException` on negative amounts
- [ ] `ExperienceToNextLevel` returns correct value for current level
- [ ] `ExperienceProgressPercent` returns value between 0-100
- [ ] New players start with 0 XP

### Monster Entity

- [ ] Monster has `ExperienceValue` property
- [ ] `CreateGoblin()` returns monster with 25 XP value
- [ ] Constructor accepts `experienceValue` parameter (defaults to 0)
- [ ] Negative XP values are clamped to 0

### CombatResult

- [ ] Includes `ExperienceGained` property (default 0)
- [ ] `ExperienceGained` is populated with monster XP when defeated
- [ ] `ExperienceGained` is 0 when monster survives

### ExperienceService

- [ ] `AwardExperienceFromMonster()` awards XP from defeated monsters
- [ ] `AwardExperienceFromMonster()` returns `None` result for alive monsters
- [ ] `AwardExperience()` adds XP to player total
- [ ] `AwardExperience()` returns `None` for zero/negative amounts
- [ ] Returns correct `ExperienceGainResult` with all fields populated

### CombatService

- [ ] `ResolveCombatRound()` returns XP value when monster defeated
- [ ] `ResolveCombatRound()` returns 0 XP when monster survives

### Display

- [ ] Status command shows XP in "XP: 75/200 (37%)" format
- [ ] Combat victory shows "★ You gained 25 XP!" message
- [ ] XP progress displayed after XP gain

### General

- [ ] ~18 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## Test Specifications

### Unit Tests (~18 tests)

#### PlayerExperienceTests.cs (~6 tests)

```csharp
[TestFixture]
public class PlayerExperienceTests
{
    [Test]
    public void NewPlayer_HasZeroExperience()
    {
        var player = new Player("Test");
        Assert.That(player.Experience, Is.EqualTo(0));
    }

    [Test]
    public void AddExperience_PositiveAmount_IncreasesExperience()
    {
        var player = new Player("Test");
        player.AddExperience(100);
        Assert.That(player.Experience, Is.EqualTo(100));
    }

    [Test]
    public void AddExperience_NegativeAmount_ThrowsException()
    {
        var player = new Player("Test");
        Assert.Throws<ArgumentOutOfRangeException>(() => player.AddExperience(-10));
    }

    [Test]
    public void AddExperience_ReturnsNewTotal()
    {
        var player = new Player("Test");
        player.AddExperience(50);
        var result = player.AddExperience(25);
        Assert.That(result, Is.EqualTo(75));
    }

    [Test]
    public void ExperienceToNextLevel_Level1_ReturnsCorrectValue()
    {
        var player = new Player("Test");
        // Level 1 player needs level 2 XP = 2 * 100 = 200
        Assert.That(player.ExperienceToNextLevel, Is.EqualTo(200));
    }

    [Test]
    public void ExperienceProgressPercent_CalculatesCorrectly()
    {
        var player = new Player("Test");
        player.AddExperience(50);
        // 50/200 = 25%
        Assert.That(player.ExperienceProgressPercent, Is.EqualTo(25));
    }
}
```

#### MonsterExperienceTests.cs (~4 tests)

```csharp
[TestFixture]
public class MonsterExperienceTests
{
    [Test]
    public void Monster_HasExperienceValueProperty()
    {
        var monster = new Monster("Test", "Desc", 30, new Stats(30, 8, 2), experienceValue: 50);
        Assert.That(monster.ExperienceValue, Is.EqualTo(50));
    }

    [Test]
    public void CreateGoblin_Has25ExperienceValue()
    {
        var goblin = Monster.CreateGoblin();
        Assert.That(goblin.ExperienceValue, Is.EqualTo(25));
    }

    [Test]
    public void Monster_Constructor_DefaultsExperienceToZero()
    {
        var monster = new Monster("Test", "Desc", 30, new Stats(30, 8, 2));
        Assert.That(monster.ExperienceValue, Is.EqualTo(0));
    }

    [Test]
    public void Monster_NegativeExperience_ClampsToZero()
    {
        var monster = new Monster("Test", "Desc", 30, new Stats(30, 8, 2), experienceValue: -10);
        Assert.That(monster.ExperienceValue, Is.EqualTo(0));
    }
}
```

#### ExperienceServiceTests.cs (~5 tests)

```csharp
[TestFixture]
public class ExperienceServiceTests
{
    private ExperienceService _service = null!;
    private Player _player = null!;
    private Monster _goblin = null!;

    [SetUp]
    public void SetUp()
    {
        var loggerFactory = new NullLoggerFactory();
        _service = new ExperienceService(loggerFactory.CreateLogger<ExperienceService>());
        _player = new Player("TestPlayer");
        _goblin = Monster.CreateGoblin();
    }

    [Test]
    public void AwardExperienceFromMonster_DefeatedMonster_AwardsXp()
    {
        _goblin.TakeDamage(1000); // Defeat the goblin

        var result = _service.AwardExperienceFromMonster(_player, _goblin);

        Assert.That(result.DidGainExperience, Is.True);
        Assert.That(result.AmountGained, Is.EqualTo(25));
        Assert.That(_player.Experience, Is.EqualTo(25));
    }

    [Test]
    public void AwardExperienceFromMonster_AliveMonster_ReturnsNone()
    {
        // Goblin is still alive
        var result = _service.AwardExperienceFromMonster(_player, _goblin);

        Assert.That(result.DidGainExperience, Is.False);
        Assert.That(result.AmountGained, Is.EqualTo(0));
        Assert.That(_player.Experience, Is.EqualTo(0));
    }

    [Test]
    public void AwardExperience_AddsToPlayerTotal()
    {
        _player.AddExperience(50);

        var result = _service.AwardExperience(_player, 25, "test");

        Assert.That(result.NewTotal, Is.EqualTo(75));
        Assert.That(result.PreviousTotal, Is.EqualTo(50));
        Assert.That(_player.Experience, Is.EqualTo(75));
    }

    [Test]
    public void AwardExperience_ZeroAmount_ReturnsNone()
    {
        var result = _service.AwardExperience(_player, 0, "test");

        Assert.That(result.DidGainExperience, Is.False);
        Assert.That(_player.Experience, Is.EqualTo(0));
    }

    [Test]
    public void AwardExperience_ReturnsCorrectResult()
    {
        var result = _service.AwardExperience(_player, 100, "Quest");

        Assert.That(result.AmountGained, Is.EqualTo(100));
        Assert.That(result.NewTotal, Is.EqualTo(100));
        Assert.That(result.PreviousTotal, Is.EqualTo(0));
        Assert.That(result.Source, Is.EqualTo("Quest"));
    }
}
```

#### CombatResultExperienceTests.cs (~3 tests)

```csharp
[TestFixture]
public class CombatResultExperienceTests
{
    private CombatService _service = null!;

    [SetUp]
    public void SetUp()
    {
        var loggerFactory = new NullLoggerFactory();
        _service = new CombatService(loggerFactory.CreateLogger<CombatService>());
    }

    [Test]
    public void CombatResult_MonsterDefeated_IncludesXp()
    {
        var player = new Player("Test", new Stats(100, 50, 5)); // High attack
        var goblin = Monster.CreateGoblin();

        var result = _service.ResolveCombatRound(player, goblin);

        Assert.That(result.MonsterDefeated, Is.True);
        Assert.That(result.ExperienceGained, Is.EqualTo(25));
    }

    [Test]
    public void CombatResult_MonsterAlive_ZeroXp()
    {
        var player = new Player("Test", new Stats(100, 1, 5)); // Low attack
        var goblin = Monster.CreateGoblin();

        var result = _service.ResolveCombatRound(player, goblin);

        Assert.That(result.MonsterDefeated, Is.False);
        Assert.That(result.ExperienceGained, Is.EqualTo(0));
    }

    [Test]
    public void CombatResult_DefaultExperienceGained_IsZero()
    {
        var result = new CombatResult(10, 5, false, false);

        Assert.That(result.ExperienceGained, Is.EqualTo(0));
    }
}
```

### Test Summary

| Test File | Test Count | Focus Areas |
|-----------|------------|-------------|
| `PlayerExperienceTests.cs` | ~6 | XP property, AddExperience(), XP helpers |
| `MonsterExperienceTests.cs` | ~4 | ExperienceValue property, factory methods |
| `ExperienceServiceTests.cs` | ~5 | XP awarding, result generation |
| `CombatResultExperienceTests.cs` | ~3 | Combat XP integration |
| **Total** | **~18** | |

---

## Dependencies

### Required from Previous Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | `Domain/Entities/Player.cs` | Extended with Experience property and methods |
| `Player.Level` | `Domain/Entities/Player.cs` | Used for XP-to-next-level calculations |
| `Monster` | `Domain/Entities/Monster.cs` | Extended with ExperienceValue property |
| `CombatResult` | `Domain/Services/CombatService.cs` | Extended with ExperienceGained field |
| `CombatService` | `Domain/Services/CombatService.cs` | Modified to include XP in results |
| `IGameRenderer` | `Application/Interfaces/IGameRenderer.cs` | Extended with RenderExperienceGainAsync |
| `SpectreGameRenderer` | `Presentation.Tui/Adapters/SpectreGameRenderer.cs` | Implements XP rendering |
| `GameSessionService` | `Application/Services/GameSessionService.cs` | Awards XP after combat |

### Provides to v0.0.8b (Level-Up Mechanics)

| Type | Usage |
|------|-------|
| `Player.Experience` | Check against level thresholds for level-up |
| `Player.AddExperience()` | XP addition triggers level-up check |
| `ExperienceService` | Extended with level-up detection |
| `ExperienceGainResult` | Extended with level-up information |
| `ExperienceGainDto` | Extended with level-up details |

### Provides to v0.0.8c (Progression Configuration)

| Type | Usage |
|------|-------|
| `Player.ExperienceToNextLevel` | Replace with config-driven calculation |
| `ExperienceService.GetDefaultMonsterXp()` | Replace with config loading |
| `ExperienceGainDto` | Extended with custom terminology |
| XP formula (`level * 100`) | Replace with configurable curves |

---

## Files Summary

### Files to Create (New)

| File | Purpose |
|------|---------|
| `src/Core/RuneAndRust.Domain/ValueObjects/ExperienceGainResult.cs` | XP gain result value object |
| `src/Core/RuneAndRust.Domain/Services/ExperienceService.cs` | XP awarding service |
| `src/Core/RuneAndRust.Application/DTOs/ExperienceGainDto.cs` | XP gain display DTO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ExperienceGainResultTests.cs` | Value object tests |
| `tests/RuneAndRust.Domain.UnitTests/Services/ExperienceServiceTests.cs` | Service tests |

### Files to Modify

| File | Changes |
|------|---------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Add Experience, AddExperience(), XP helpers |
| `src/Core/RuneAndRust.Domain/Entities/Monster.cs` | Add ExperienceValue, update constructor, update CreateGoblin() |
| `src/Core/RuneAndRust.Domain/Services/CombatService.cs` | Add ExperienceGained to CombatResult, update ResolveCombatRound() |
| `src/Core/RuneAndRust.Application/Services/GameSessionService.cs` | Award XP after combat, render XP gain |
| `src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs` | Add RenderExperienceGainAsync() |
| `src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs` | Implement XP rendering, update status display |
| DI Container | Register ExperienceService |
| `tests/RuneAndRust.Domain.UnitTests/Entities/PlayerTests.cs` | Add experience tests |
| `tests/RuneAndRust.Domain.UnitTests/Entities/MonsterTests.cs` | Add ExperienceValue tests |

### Test Files Summary

| File | Test Count |
|------|------------|
| `PlayerExperienceTests.cs` | ~6 |
| `MonsterExperienceTests.cs` | ~4 |
| `ExperienceServiceTests.cs` | ~5 |
| `CombatResultExperienceTests.cs` | ~3 |
| **Total** | **~18** |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Monster constructor changes break existing code | Medium | Medium | Add default parameter value (experienceValue = 0) |
| XP overflow at very high values | Low | Low | Use int (2B+ max), consider long in future if needed |
| Status display formatting issues | Low | Low | Test with various XP values (0, 100, 9999) |
| Missing XP award in some combat paths | Medium | Medium | Ensure all combat resolution paths award XP |
| EF Core not persisting Experience | Low | High | Verify property mapping in DbContext |
| CombatResult breaking change | Medium | Medium | Add ExperienceGained with default value = 0 |

---

*This design specification provides the detailed blueprint for implementing v0.0.8a Core Experience System. This phase establishes the XP tracking foundation that v0.0.8b (Level-Up Mechanics) and v0.0.8c (Progression Configuration) will build upon.*
