# Changelog: v0.4.2d - The Parley (TUI & Game Loop Integration)

**Release Date:** 2025-12-30

---

## Summary

v0.4.2d implements the terminal user interface for the dialogue system and integrates it into the game loop, completing the foundational dialogue feature set. This release bridges the dialogue engine (v0.4.2c) with player interaction by introducing TUI-specific view models, keyboard-driven navigation controllers, and Spectre.Console rendering components. The architecture employs strict layer separation: Core layer defines the view models and controller interfaces, Terminal layer implements rendering and input handling, and Engine layer orchestrates the dialogue phase within the game loop. The dialogue phase operates as a modal key-based interaction similar to the Specialization Menu, using arrow keys for navigation, Enter for selection, and number keys for quick selection. This implementation introduces locked option feedback, boundary clamping for selection state, and theme-aware visual styling. The release includes placeholder logic for NPC entity resolution (deferred to v0.4.2e) and full integration with CommandParser for dialogue initiation via the `talk`, `speak`, and `converse` commands.

Key architectural patterns: Modal input handling with GamePhase.Dialogue state, TUI view model transformation from domain view models, interface-based controller abstraction for Engine/Terminal separation, Spectre.Console markup escaping for safe rendering, and selection state clamping on node transitions.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/ViewModels/DialogueTuiViewModel.cs` | TUI-specific view model extending DialogueViewModel with selection state tracking. Record type with factory method `FromDialogueViewModel()` for converting domain models to UI models. Includes nested `DialogueOptionTuiViewModel` record for option rendering. |
| `RuneAndRust.Core/Interfaces/IDialogueScreenRenderer.cs` | Interface for dialogue TUI rendering contract. Defines `Render(DialogueTuiViewModel)` for screen output and `PlayLockedFeedback(string lockReason)` for locked option feedback with 500ms delay. |
| `RuneAndRust.Core/Interfaces/IDialogueController.cs` | Interface for dialogue input handling. Defines properties for `SelectedIndex` and `LastSelectedOptionId`, methods for `HandleInputAsync()` (key processing), `BuildTuiViewModelAsync()` (view model construction), `ResetSelection()` (state reset), and `IsInDialogue()` (session checking). |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/DialogueScreenRenderer.cs` | Spectre.Console implementation of `IDialogueScreenRenderer`. Renders dialogue UI with decorative header, bordered text panel, numbered options list, and control hints footer. Implements text wrapping (max width 70), markup escaping for special characters, and theme-aware coloring. |
| `RuneAndRust.Terminal/Controllers/DialogueController.cs` | Implementation of `IDialogueController` for keyboard input processing. Handles navigation (Up/Down arrows), selection (Enter, Spacebar), quick selection (number keys 1-9), and exit (Escape, Q). Manages selection state with boundary clamping and locked option detection. |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/DialogueControllerTests.cs` | Unit tests for DialogueController covering navigation (4 tests), selection (5 tests), exit (3 tests), BuildTuiViewModelAsync (4 tests), ResetSelection (2 tests), and IsInDialogue (2 tests). Total: 20 tests. |
| `RuneAndRust.Tests/Terminal/DialogueScreenRendererTests.cs` | Unit tests for DialogueScreenRenderer covering Render method (10 tests), PlayLockedFeedback (3 tests), and DialogueTuiViewModel properties (2 tests). Total: 15 tests. |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/GamePhase.cs` | Added `Dialogue = 6` enum value with XML documentation referencing v0.4.2d implementation. |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added `RequiresDialogue` (bool) and `DialogueTarget` (string?) properties to `ParseResult` class. Added command parsing for `talk`, `speak`, and `converse` verbs that populate these properties with the target NPC name. |
| `RuneAndRust.Engine/Services/GameService.cs` | Added `IDialogueService`, `IDialogueScreenRenderer`, and `IDialogueController` fields with nullable references for optional injection. Updated constructor to accept dialogue dependencies (lines 73-75, 94-96). Added GamePhase.Dialogue case to game loop input handling (line 202) and rendering logic (line 312). Added `HandleDialogueInitiationAsync()` method for dialogue phase transition (lines 620-653). Added `ResolveNpcDialogueTreeAsync()` placeholder method (lines 660-670) that maps NPC names to tree IDs using naming convention (returns `"npc_{normalized_name}"`). |
| `RuneAndRust.Terminal/Program.cs` | Registered dialogue services in DI container: `IDialogueScreenRenderer` as Singleton (line 190) and `IDialogueController` as Scoped (line 191). |

---

## Code Implementation Details

### DialogueTuiViewModel (Record)

**Properties:**

```csharp
Guid SessionId                                    // Active dialogue session identifier
string NpcName                                     // NPC display name
string? NpcTitle                                   // Optional NPC title (e.g., "Iron-Bane Elder")
string SpeakerName                                 // Current speaker name
string Text                                        // Dialogue text content
bool IsTerminalNode                                // Whether node ends dialogue
IReadOnlyList<DialogueOptionTuiViewModel> Options  // Available response options
int SelectedIndex                                  // Currently selected option (0-based)
```

**Computed Properties:**

- `SpeakerDisplay` (string): Returns `"{SpeakerName}, {NpcTitle}"` if title exists, otherwise just `SpeakerName`
- `OptionCount` (int): Returns `Options.Count`
- `SelectedOption` (DialogueOptionTuiViewModel?): Returns option at `SelectedIndex` if valid, otherwise null
- `HasAvailableOptions` (bool): Returns true if any option has `IsAvailable == true`

**Factory Method:**

```csharp
static DialogueTuiViewModel FromDialogueViewModel(DialogueViewModel vm, int selectedIndex)
```

Behavior:
- Filters options where `IsVisible == true`
- Orders by `DisplayOrder` ascending
- Maps to `DialogueOptionTuiViewModel` records
- Returns new `DialogueTuiViewModel` with provided `selectedIndex`

### DialogueOptionTuiViewModel (Record)

**Properties:**

```csharp
string OptionId                 // Unique option identifier
string Text                     // Option display text
int DisplayOrder                // Sort order for rendering
bool IsVisible                  // Visibility flag (filtered by factory)
bool IsAvailable                // Locked/unlocked state
string? LockReason              // Reason if locked (e.g., "Requires Reputation")
string? Tooltip                 // Additional context (unused in v0.4.2d)
```

**Computed Properties:**

- `DisplayText` (string): Returns `Text` if available, otherwise `"[{LockReason ?? "LOCKED"}] {Text}"`

### IDialogueScreenRenderer Interface

**Method Signatures:**

```csharp
void Render(DialogueTuiViewModel viewModel)
void PlayLockedFeedback(string lockReason)
```

### IDialogueController Interface

**Properties:**

```csharp
int SelectedIndex { get; }           // Current selection (0-based)
string? LastSelectedOptionId { get; } // Last selected option ID
```

**Method Signatures:**

```csharp
Task<GamePhase> HandleInputAsync(ConsoleKey key, Character character, GameState gameState)
Task<DialogueTuiViewModel?> BuildTuiViewModelAsync(Character character, GameState gameState)
void ResetSelection()
bool IsInDialogue(Guid characterId, GameState gameState)
```

### DialogueScreenRenderer Implementation

**Constants:**

- `MaxTextWidth = 70` - Maximum dialogue text width before word wrapping

**Behaviors:**

- Clears screen using `AnsiConsole.Clear()` before rendering
- Renders header with decorative Unicode characters (✦ U+2726) and Rule separator
- Creates bordered Panel with `BoxBorder.Rounded` and grey border color
- Wraps dialogue text using word-based algorithm (splits on spaces)
- Escapes Spectre.Console markup using `Markup.Escape()` for speaker names and text
- Uses `[[ ]]` double brackets to render literal brackets in locked option reasons
- Applies theme colors via `IThemeService.GetColor()` with fallbacks:
  - `DialogueSpeakerColor` → "cyan"
  - `DialogueTextColor` → "white"
  - `DialogueSelectedColor` → "yellow"
  - `DialogueOptionColor` → "white"
  - `DialogueLockedColor` → "dim grey"
- Renders options with 1-based numbering for display
- Shows selection indicator `>` for selected option with bold markup
- Displays locked options in dim grey with `[{lockReason}]` prefix using escaped brackets
- Renders footer with Unicode control hint symbols (↑↓ U+2191/U+2193, │ U+2502)
- `PlayLockedFeedback()` outputs red markup message and sleeps for 500ms

### DialogueController Implementation

**Key Input Handling:**

| Key | Behavior |
|-----|----------|
| UpArrow, W | Decrements `SelectedIndex` if > 0 (boundary clamped) |
| DownArrow, S | Increments `SelectedIndex` if < optionCount - 1 (boundary clamped) |
| Enter, Spacebar | Calls `HandleSelectionAsync()` on current option |
| Escape, Q | Ends dialogue via `DialogueService.EndDialogueAsync()` with `PlayerCancel` reason, returns `GamePhase.Exploration` |
| D1-D9 | Sets `SelectedIndex` to (key - D1) if within bounds, immediately calls `HandleSelectionAsync()` |
| Other | Ignored, returns `GamePhase.Dialogue` to stay in dialogue |

**HandleSelectionAsync() Behaviors:**

- Validates `SelectedIndex` is within bounds (returns Dialogue phase if invalid)
- Checks selected option's `IsAvailable` property
- If locked: calls `_renderer.PlayLockedFeedback()` with `LockedReason`, stays in Dialogue phase
- If available: stores `OptionId` in `LastSelectedOptionId`, calls `DialogueService.SelectOptionAsync()`
- On selection success: calls `ResetSelection()` and returns `GamePhase.Exploration` if dialogue ended, otherwise `GamePhase.Dialogue`
- On selection failure: logs warning and stays in Dialogue phase

**BuildTuiViewModelAsync() Behaviors:**

- Retrieves current dialogue via `DialogueService.GetCurrentDialogueAsync()`
- Returns null if no active dialogue
- Clamps `SelectedIndex` to valid range using `Math.Clamp(SelectedIndex, 0, Options.Count - 1)`
- Converts to `DialogueTuiViewModel` using factory method

**ResetSelection() Behaviors:**

- Sets `SelectedIndex = 0`
- Sets `LastSelectedOptionId = null`

**Text Truncation:**

- Private method `TruncateText(string text, int maxLength)` truncates to `maxLength - 3` and appends `"..."` if exceeded
- Used for logging selected option text with 30-character limit

### CommandParser Modifications

**ParseResult Properties Added:**

```csharp
public bool RequiresDialogue { get; set; }
public string? DialogueTarget { get; set; }
```

**Command Parsing Logic:**

Detects verbs: `"talk"`, `"speak"`, `"converse"`

Example command: `"talk old scavenger"` →
- `RequiresDialogue = true`
- `DialogueTarget = "old scavenger"` (everything after verb)

### GameService Integration

**Dialogue Initiation Flow (HandleDialogueInitiationAsync):**

1. Validates `CurrentCharacter` and `CurrentRoomId` exist
2. Calls `ResolveNpcDialogueTreeAsync(targetName, roomId)` to get tree ID
3. If tree ID null/empty: displays "no one named X here" message
4. Calls `DialogueService.StartDialogueAsync(character, treeId, gameState)`
5. If start successful: transitions to `GamePhase.Dialogue`, resets controller selection, triggers render
6. If start fails: logs warning and stays in current phase

**NPC Resolution Placeholder (ResolveNpcDialogueTreeAsync):**

```csharp
private Task<string?> ResolveNpcDialogueTreeAsync(string targetName, Guid roomId)
{
    // TODO v0.4.2e: Implement NPC entity lookup
    // Convention: "talk <npc_name>" maps to tree ID "npc_<npc_name>"
    var normalizedName = targetName.ToLowerInvariant().Replace(" ", "_");
    return Task.FromResult<string?>($"npc_{normalizedName}");
}
```

Notes:
- NPC entities not yet implemented
- Uses naming convention for testing: `"talk merchant"` → tree ID `"npc_merchant"`
- Returns null if no matching tree (placeholder always returns value)
- Will be replaced with repository lookup in v0.4.2e

**Game Loop Integration:**

- Exploration phase input handling (line 237-240): checks `result.RequiresDialogue` and calls `HandleDialogueInitiationAsync()`
- Dialogue phase input handling (line 202): delegates to `_dialogueController.HandleInputAsync()` if `_inputService` and `_dialogueController` available
- Dialogue phase rendering (line 312): builds TUI view model via `_dialogueController.BuildTuiViewModelAsync()` and renders via `_dialogueRenderer.Render()`

---

## Logging Matrix

### DialogueController

| Event | Level | Template |
|-------|-------|----------|
| Key pressed | Trace | `"[Dialogue TUI] Key pressed: {Key}"` |
| No active dialogue on input | Warning | `"[Dialogue TUI] HandleInput called with no active dialogue"` |
| Selection moved up | Trace | `"[Dialogue TUI] Selection moved up to index {Index}"` |
| Selection moved down | Trace | `"[Dialogue TUI] Selection moved down to index {Index}"` |
| Player cancelled via Escape | Information | `"[Dialogue TUI] Player cancelled dialogue via Escape"` |
| Invalid selection index | Warning | `"[Dialogue TUI] Invalid selection index: {Index}"` |
| Locked option attempt | Debug | `"[Dialogue TUI] Attempted to select locked option: {OptionId}"` |
| Option selected | Information | `"[Dialogue TUI] Selecting option: '{Text}'"` |
| Selection failed | Warning | `"[Dialogue TUI] Option selection failed: {Error}"` |
| Dialogue completed | Information | `"[Dialogue TUI] Dialogue completed via terminal option"` |

### DialogueScreenRenderer

| Event | Level | Template |
|-------|-------|----------|
| Render completed | Trace | `"[Dialogue TUI] Rendered. Selected: {Index}, Options: {Count}"` |

---

## Test Coverage

**Total Tests:** 35
**Passed:** 35
**Failed:** 0
**Duration:** 1140ms (DialogueController: 140ms, DialogueScreenRenderer: 1000ms)

### DialogueControllerTests (20 tests)

#### Navigation Tests (4 tests)

| Test Name | Description |
|-----------|-------------|
| `HandleInputAsync_UpArrow_DecrementsSelectedIndex` | Verifies UpArrow decrements SelectedIndex from 1 to 0 |
| `HandleInputAsync_DownArrow_IncrementsSelectedIndex` | Verifies DownArrow increments SelectedIndex from 0 to 1 |
| `HandleInputAsync_UpArrowAtTop_StaysAtZero` | Verifies UpArrow at index 0 does not decrement (boundary clamp) |
| `HandleInputAsync_DownArrowAtBottom_StaysAtMax` | Verifies DownArrow at max index does not increment (boundary clamp) |

#### Selection Tests (5 tests)

| Test Name | Description |
|-----------|-------------|
| `HandleInputAsync_EnterOnAvailableOption_SelectsOption` | Verifies Enter key calls SelectOptionAsync on available option |
| `HandleInputAsync_EnterOnLockedOption_PlaysLockedFeedback` | Verifies locked option triggers PlayLockedFeedback, does not select |
| `HandleInputAsync_SelectTerminalOption_ReturnsExploration` | Verifies terminal option selection returns GamePhase.Exploration |
| `HandleInputAsync_NumberKey_SelectsCorrespondingOption` | Verifies D2 key selects option at index 1 (quick selection) |
| `HandleInputAsync_InvalidNumberKey_DoesNothing` | Verifies D9 with only 2 options does not trigger selection |

#### Exit Tests (3 tests)

| Test Name | Description |
|-----------|-------------|
| `HandleInputAsync_Escape_EndsDialogue` | Verifies Escape key calls EndDialogueAsync with PlayerCancel reason |
| `HandleInputAsync_Q_EndsDialogue` | Verifies Q key ends dialogue and returns Exploration phase |
| `HandleInputAsync_NoActiveDialogue_ReturnsExploration` | Verifies null dialogue ViewModel returns Exploration phase |

#### BuildTuiViewModelAsync Tests (4 tests)

| Test Name | Description |
|-----------|-------------|
| `BuildTuiViewModelAsync_WithActiveDialogue_ReturnsViewModel` | Verifies active dialogue returns valid TUI ViewModel |
| `BuildTuiViewModelAsync_NoActiveDialogue_ReturnsNull` | Verifies null DialogueViewModel returns null TUI ViewModel |
| `BuildTuiViewModelAsync_ClampsSelectionToValidRange` | Verifies SelectedIndex clamped when exceeds option count |
| `BuildTuiViewModelAsync_FiltersHiddenOptions` | Verifies only visible options included in TUI ViewModel |

#### ResetSelection Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `ResetSelection_ResetsIndexToZero` | Verifies ResetSelection sets SelectedIndex to 0 |
| `ResetSelection_ClearsLastSelectedOptionId` | Verifies ResetSelection clears LastSelectedOptionId to null |

#### IsInDialogue Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `IsInDialogue_WithActiveSession_ReturnsTrue` | Verifies returns true when character has active dialogue session |
| `IsInDialogue_WithNoSession_ReturnsFalse` | Verifies returns false when no active session exists |

### DialogueScreenRendererTests (15 tests)

#### Render Tests (10 tests)

| Test Name | Description |
|-----------|-------------|
| `Render_WithValidViewModel_DoesNotThrow` | Verifies rendering with valid ViewModel completes without exceptions |
| `Render_WithNpcTitle_IncludesTitle` | Verifies SpeakerDisplay includes NPC title when present |
| `Render_WithNoOptions_DoesNotThrow` | Verifies rendering terminal node with empty options list succeeds |
| `Render_WithLockedOptions_DoesNotThrow` | Verifies rendering locked options with LockReason succeeds |
| `Render_WithLongText_WrapsCorrectly` | Verifies word wrapping for text exceeding MaxTextWidth (70 chars) |
| `Render_WithSpecialCharacters_EscapesMarkup` | Verifies Markup.Escape() called for names/text containing `[` brackets |
| `Render_WithManyOptions_HandlesAll` | Verifies rendering 9 options (max expected for quick select) succeeds |
| `Render_WithDifferentSelectedIndex_DoesNotThrow` | Verifies rendering with non-zero SelectedIndex succeeds |
| `Render_WithTerminalNode_DoesNotThrow` | Verifies rendering terminal node with goodbye option succeeds |
| `Render_WithNullThemeColors_UsesDefaults` | Verifies fallback colors used when IThemeService returns null |

#### PlayLockedFeedback Tests (3 tests)

| Test Name | Description |
|-----------|-------------|
| `PlayLockedFeedback_WithReason_DoesNotThrow` | Verifies feedback displays with lock reason text |
| `PlayLockedFeedback_WithSpecialCharacters_DoesNotThrow` | Verifies feedback escapes markup in lock reason |
| `PlayLockedFeedback_WithEmptyReason_DoesNotThrow` | Verifies feedback handles empty lock reason string |

#### DialogueTuiViewModel Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `DialogueTuiViewModel_SpeakerDisplay_WithTitle_IncludesTitle` | Verifies SpeakerDisplay formats as "Name, Title" when title exists |
| `DialogueTuiViewModel_SpeakerDisplay_WithoutTitle_ShowsNameOnly` | Verifies SpeakerDisplay shows only name when title is null |

---

## DI Registration

```csharp
// RuneAndRust.Terminal/Program.cs (lines 190-191)
services.AddSingleton<IDialogueScreenRenderer, DialogueScreenRenderer>();
services.AddScoped<IDialogueController, DialogueController>();
```

**Lifetime Justification:**

- **IDialogueScreenRenderer (Singleton):** Stateless renderer, shared across all sessions, same lifetime as IThemeService
- **IDialogueController (Scoped):** Maintains selection state per game session, requires fresh instance per scope

---

## Verification Results

### Build Output

```
Build succeeded.

RuneAndRust.Core -> .../RuneAndRust.Core/bin/Debug/net9.0/RuneAndRust.Core.dll
RuneAndRust.Persistence -> .../RuneAndRust.Persistence/bin/Debug/net9.0/RuneAndRust.Persistence.dll
RuneAndRust.Engine -> .../RuneAndRust.Engine/bin/Debug/net9.0/RuneAndRust.Engine.dll
RuneAndRust.Terminal -> .../RuneAndRust.Terminal/bin/Debug/net9.0/RuneAndRust.Terminal.dll
RuneAndRust.Tests -> .../RuneAndRust.Tests/bin/Debug/net9.0/RuneAndRust.Tests.dll

0 Error(s)
Time Elapsed 00:00:02.28
```

### Test Output (DialogueControllerTests)

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
Passed!  - Failed:     0, Passed:    20, Skipped:     0, Total:    20, Duration: 140 ms
```

### Test Output (DialogueScreenRendererTests)

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
Passed!  - Failed:     0, Passed:    15, Skipped:     0, Total:    15, Duration: 1 s
```

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Enums/
│   └── GamePhase.cs                          [MODIFIED] - Added Dialogue = 6 enum value
├── Interfaces/
│   ├── IDialogueController.cs                [NEW] - Dialogue input handler contract
│   └── IDialogueScreenRenderer.cs            [NEW] - Dialogue rendering contract
└── ViewModels/
    └── DialogueTuiViewModel.cs               [NEW] - TUI-specific dialogue view model with selection

RuneAndRust.Engine/
└── Services/
    ├── CommandParser.cs                      [MODIFIED] - Added RequiresDialogue and DialogueTarget to ParseResult
    └── GameService.cs                        [MODIFIED] - Added dialogue phase handling and NPC resolution placeholder

RuneAndRust.Terminal/
├── Controllers/
│   └── DialogueController.cs                 [NEW] - Keyboard input handling for dialogue navigation
├── Rendering/
│   └── DialogueScreenRenderer.cs             [NEW] - Spectre.Console dialogue UI implementation
└── Program.cs                                [MODIFIED] - Registered IDialogueScreenRenderer and IDialogueController

RuneAndRust.Tests/
└── Terminal/
    ├── DialogueControllerTests.cs            [NEW] - 20 tests for input handling logic
    └── DialogueScreenRendererTests.cs        [NEW] - 15 tests for rendering behaviors
```

---

## Running Tests

### Run All Dialogue Tests

```bash
dotnet test --filter "FullyQualifiedName~Dialogue"
```

### Run Controller Tests Only

```bash
dotnet test --filter "FullyQualifiedName~DialogueController"
```

### Run Renderer Tests Only

```bash
dotnet test --filter "FullyQualifiedName~DialogueScreenRenderer"
```

### Run Specific Test

```bash
dotnet test --filter "FullyQualifiedName~HandleInputAsync_EnterOnAvailableOption_SelectsOption"
```

---

## Next Steps

### v0.4.2e - The Populace (NPC Entity Implementation)

- Implement `Npc` entity in Core layer with properties: Id, Name, Title, Location, FactionId, DialogueTreeId
- Create `NpcRepository` in Persistence layer with room-based lookup methods
- Replace `ResolveNpcDialogueTreeAsync()` placeholder with repository-based NPC resolution
- Seed database with NPC entities linked to dialogue trees from v0.4.2b
- Add NPC presence to room descriptions (integrate with exploration rendering)
- Implement NPC spawn/despawn logic based on world state

### v0.4.3a - The Codex (Journal System)

- Design journal entry model for quest tracking, lore discoveries, and NPC notes
- Implement persistent journal storage via GameState
- Create journal UI phase accessible via `j` or `journal` command
- Integrate dialogue flags with journal updates (unlock entries on tree completion)
- Add codex categories: Bestiary, Discoveries, Factions, NPCs

### v0.4.3b - The Dispatch (Quest System Foundation)

- Design quest objective model with completion tracking
- Implement quest repository for active/completed quest persistence
- Create quest trigger system linked to dialogue outcomes and world events
- Add quest UI panel to exploration screen showing active objectives
- Integrate quest completion with dialogue tree conditions
