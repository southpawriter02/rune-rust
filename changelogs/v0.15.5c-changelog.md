# v0.15.5c Changelog - Foraging System

## Summary

Implements the **Foraging System** for the Wasteland Survival skill. This subsystem allows characters to scavenge resources from the wasteland with yields based on skill check success and search duration. Features 3 search durations with bonus dice (+0 to +4), 4 forage targets with varying DCs (10-22), success-tiered yield tables, hidden cache discovery triggered by rolling any 10, biome-specific loot tables, and area exhaustion penalties for repeated searches.

## Added

### Domain Layer - Enums (2 files)

| File | Description |
|------|-------------|
| `SearchDuration.cs` | 3-value enum for search duration: Quick (10 min, +0 dice), Thorough (1 hour, +2 dice), Complete (4 hours, +4 dice). Each duration trades time for better odds and higher potential yields. |
| `ForageTarget.cs` | 4-value enum for forage targets: CommonSalvage (DC 10), UsefulSupplies (DC 14), ValuableComponents (DC 18), HiddenCache (DC 22). Determines base DC and primary yield type. |

### Domain Layer - Value Objects (2 files)

| File | Description |
|------|-------------|
| `ForagingContext.cs` | `readonly record struct` for foraging context. Properties: CharacterId, BiomeId, SearchDuration, ForageTarget, EquipmentBonus, PreviousSearches. Computed: TimeMinutes, TimeSpan, DurationBonusDice, ExhaustionPenalty (capped at 3), TotalDiceModifier, BaseDc, IsExhaustedArea, HasEquipmentBonus, DiceModifierDisplay. Methods: `ToSkillContext()`, `ToDisplayString()`, `ToDetailedString()`. Factory methods: `CreateQuick()`, `CreateThorough()`, `CreateComplete()`. |
| `ForagingResult.cs` | `readonly record struct` result container. Properties: NetSuccesses, ScrapYield, RationsYield, ComponentsYield, CacheFound, CacheMarks, CacheItem, BiomeSpecificItems, TimeSpent, RollDetails. Computed: FoundAnything, SuccessTier (Nothing Found/Meager Haul/Decent Finds/Good Haul/Excellent Haul), EstimatedValue, IsCriticalSuccess. Factory methods: `Empty()`, `CacheOnly()`, `ScrapOnly()`. |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `IForagingService.cs` | Service interface: `AttemptForagingAsync()`, `CalculateYields()`, `CheckForCache()`, `GenerateCacheContents()`, `GetDurationBonus()`, `GetDurationTimeMinutes()`, `GetDurationDescription()`, `GetTargetBaseDc()`, `GetTargetDescription()`, `GetBiomeLootTable()`, `GetRandomBiomeItem()`, `CalculateEstimatedValue()`, `GetExpectedValuePerHour()`. Full XML documentation with examples. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `ForagingService.cs` | Full implementation of IForagingService. Dependencies: SkillCheckService, DiceService, ILogger. Constants: WastelandSurvivalSkillId, duration bonuses (Quick=0, Thorough=2, Complete=4), duration times (10, 60, 240 minutes), target DCs (10, 14, 18, 22), economy values (Scrap=1, Rations=5, Components=20 Marks), CacheTriggerValue (10), CacheItemProbability (0.5), CriticalSuccessThreshold (5). Static yield table dictionary and biome loot table dictionaries. Comprehensive logging at Information and Debug levels. |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/foraging-yields.json` | Yield table (5 tiers by success), duration bonuses with times, forage target DCs, cache trigger settings (die value 10, 1d100 marks, 50% item chance), critical success threshold, area exhaustion config, biome loot tables (industrial-ruins, residential-ruins, wasteland, swamp, forest, default), economy balance values. |
| `config/schemas/foraging-yields.schema.json` | JSON Schema 2020-12 for foraging-yields.json validation. Defines yieldTier, durationDefinition, forageDcDefinition, cacheTriggerDefinition, criticalSuccessDefinition, areaExhaustionDefinition, lootTableItem, economyBalanceDefinition. |

### Unit Tests (1 file, 30+ tests)

| File | Tests |
|------|-------|
| `ForagingServiceTests.cs` | Duration bonus tests (3 cases: bonus for each duration, time for each duration, descriptions), Yield calculation tests (7 cases: zero/one success returns nothing, success tiers match yields, high successes clamp), Cache discovery tests (5 cases: ten triggers cache, no ten returns false, multiple tens, empty rolls, cache always returns marks), Target DC tests (2 cases: correct DCs, descriptions), Biome loot table tests (4 cases: known biome, unknown defaults, case insensitive, random item), Economy tests (3 cases: estimated value calculation, zeros, expected value per hour), ForagingContext tests (6 cases: time minutes, bonus dice, base DC, total modifier, exhaustion cap, ToSkillContext), ForagingResult tests (6 cases: FoundAnything, SuccessTier, EstimatedValue, IsCriticalSuccess, Empty factory, ToDisplayString). |

## Key Features

### Search Durations

| Duration | Time | Bonus Dice | Economy Notes |
|----------|------|------------|---------------|
| Quick | 10 min | +0 | ~48 value/hr, time-efficient but low rare finds |
| Thorough | 1 hour | +2 | ~20 value/hr, balanced approach |
| Complete | 4 hours | +4 | ~15 value/hr, highest total yields |

### Forage Targets

| Target | Base DC | Primary Yield |
|--------|---------|---------------|
| CommonSalvage | 10 | Scrap metal, wiring, debris |
| UsefulSupplies | 14 | Rations, water, basic supplies |
| ValuableComponents | 18 | Tech parts, rare materials |
| HiddenCache | 22 | Marks and survivor items |

### Yield Table by Successes

| Successes | Scrap | Rations | Components | Success Tier |
|-----------|-------|---------|------------|--------------|
| 0-1 | — | — | — | Nothing Found |
| 2-3 | 2d10 | — | — | Meager Haul |
| 4-5 | 3d10 | 1d6 | — | Decent Finds |
| 6-7 | 4d10 | 1d6 | 1 | Good Haul |
| 8+ | 5d10 | 2d6 | 1d4 | Excellent Haul |

### Hidden Cache Discovery

- **Trigger**: Any die showing 10 during foraging check
- **Contents**: 1d100 Marks (always) + 50% chance of biome item
- **Independent**: Works regardless of success/failure on main check

### Critical Success

- **Threshold**: Net successes ≥ 5
- **Bonus**: Grants a biome-specific item in addition to normal yields

### Area Exhaustion

- **Penalty**: -1 die per previous search in same area
- **Maximum**: -3 dice (caps at 3 previous searches)
- **Purpose**: Prevents infinite resource exploitation

### Economy Values

| Resource | Value (Marks) |
|----------|---------------|
| Scrap | 1 per unit |
| Rations | 5 per unit |
| Components | 20 per unit |

### Biome Loot Tables

| Biome | Sample Items |
|-------|--------------|
| industrial-ruins | Corroded Medkit, Rusty Toolkit, Fuel Canister, Wire Spool |
| residential-ruins | Canned Food, Tattered Map, Old Currency, Faded Photograph |
| wasteland | Mutant Bone, Glowing Crystal, Petrified Wood, Strange Ore |
| swamp | Medicinal Moss, Poison Gland, Bog Iron, Reed Bundle |
| forest | Edible Mushrooms, Medicinal Herbs, Animal Hide, Sturdy Branch |
| default | Mysterious Object, Salvageable Scrap, Strange Device |

## Files Changed

### Added (9 files)
- `src/Core/RuneAndRust.Domain/Enums/SearchDuration.cs`
- `src/Core/RuneAndRust.Domain/Enums/ForageTarget.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/ForagingContext.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/ForagingResult.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IForagingService.cs`
- `src/Core/RuneAndRust.Application/Services/ForagingService.cs`
- `config/foraging-yields.json`
- `config/schemas/foraging-yields.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/ForagingServiceTests.cs`
- `changelogs/v0.15.5c-changelog.md`

## Dependencies

- `SkillCheckService.cs` - For performing Wasteland Survival foraging checks
- `DiceService.cs` - For rolling yield dice and cache contents
- `SkillCheckResult.cs` - Result type from skill checks
- `SkillContext.cs` - For passing situational modifiers from ForagingContext
- `Player.cs` entity - For forager identification
- `ILogger<ForagingService>` - For comprehensive logging

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithContext()` for foraging checks
- **DiceService**: Uses `RollTotal()` for yield calculations and cache contents
- **SkillContext**: ForagingContext converts to SkillContext via `ToSkillContext()`
- **Biome System**: Loot tables keyed by biome ID for location-specific rewards

## Notes

- Search duration bonus dice stack with equipment bonuses
- Area exhaustion penalty caps at -3 dice regardless of search count
- Cache discovery is independent of success/failure (luck mechanic)
- Critical success threshold (5+) grants bonus biome item
- Biome IDs are case-insensitive for robustness
- Unknown biomes fall back to default loot table with warning log
- This establishes the time-investment resource gathering pattern for future mechanics
- This builds upon v0.15.5a (Extended Tracking System) and v0.15.5b (Counter-Tracking System)
