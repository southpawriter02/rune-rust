# v0.17.2f Changelog: Attribute Allocation Service

**Version:** 0.17.2f
**Phase:** Attribute Allocation Service
**Date:** 2026-01-30
**Status:** Complete

---

## Summary

Implements the `IAttributeAllocationService` interface and `AttributeAllocationService` for managing attribute point allocation during character creation. The service handles both Simple (archetype-based) and Advanced (point-buy) allocation modes, including state creation, attribute modification with cost validation, mode switching, allocation validation, and reset. Also introduces the `AttributeModificationResult` value object for modification outcomes and `AllocationValidationResult` for multi-error validation feedback.

---

## Added

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IAttributeAllocationService` | Contract for managing attribute allocation state and modifications during character creation |

#### IAttributeAllocationService Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `CreateAllocationState(mode, archetypeId?)` | `AttributeAllocationState` | Creates initial state for Simple or Advanced mode |
| `TryModifyAttribute(state, attribute, newValue)` | `AttributeModificationResult` | Attempts to modify an attribute value with cost validation |
| `CalculateCost(fromValue, toValue)` | `int` | Calculates point cost for attribute value change |
| `ValidateAllocation(state)` | `AllocationValidationResult` | Validates allocation state against all constraints |
| `SwitchMode(currentState, newMode, archetypeId?)` | `AttributeAllocationState` | Switches between Simple and Advanced modes |
| `ResetAllocation(mode, archetypeId?)` | `AttributeAllocationState` | Resets allocation to initial defaults |

### Application Layer - Services

| Service | Description |
|---------|-------------|
| `AttributeAllocationService` | Implementation of `IAttributeAllocationService` using `IAttributeProvider` for configuration |

### Domain Layer - Value Objects

| Value Object | Description |
|--------------|-------------|
| `AttributeModificationResult` | Encapsulates the outcome of an attribute modification attempt (success/failure with state and error message) |
| `AllocationValidationResult` | Multi-error validation result for attribute allocation state validation |

#### AttributeModificationResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `Success` | `bool` | Whether the modification succeeded |
| `NewState` | `AttributeAllocationState?` | Updated state on success, null on failure |
| `PointsSpent` | `int` | Total points spent (from new or current state) |
| `PointsRemaining` | `int` | Points remaining (from new or current state) |
| `ErrorMessage` | `string?` | Failure reason, null on success |
| `IsFailure` | `bool` | Inverse of Success |
| `HasNewState` | `bool` | Whether NewState has a value |
| `HasErrorMessage` | `bool` | Whether ErrorMessage is non-empty |

#### AttributeModificationResult Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Succeeded(newState)` | `AttributeModificationResult` | Factory for successful result |
| `Failed(errorMessage, currentState)` | `AttributeModificationResult` | Factory for failed result |

#### AllocationValidationResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsValid` | `bool` | Whether validation passed |
| `Errors` | `IReadOnlyList<string>` | Collection of error messages |
| `HasErrors` | `bool` | Whether any errors exist |
| `ErrorCount` | `int` | Number of errors |

#### AllocationValidationResult Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Valid()` | `AllocationValidationResult` | Factory for valid result |
| `Invalid(errors)` | `AllocationValidationResult` | Factory for invalid result with error collection |
| `GetErrorSummary()` | `string` | Semicolon-separated error summary |

### Tests

#### AttributeAllocationServiceTests (~11 tests)

- CreateAllocationState in Simple mode returns recommended build with correct attributes
- CreateAllocationState in Advanced mode returns default state with all attributes at 1
- TryModifyAttribute succeeds with enough points (Might 1→5, costs 4)
- TryModifyAttribute fails with insufficient points after partial spending
- TryModifyAttribute fails in Simple mode with appropriate error
- TryModifyAttribute fails for out-of-range value (11)
- SwitchMode from Simple to Advanced preserves attribute values
- SwitchMode from Advanced to Simple applies recommended build
- ValidateAllocation returns valid for correctly configured state
- ResetAllocation returns initial default state
- CalculateCost delegates to provider for standard, premium, refund, and no-change scenarios

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Interfaces/IAttributeAllocationService.cs` | Allocation service interface |
| `src/Core/RuneAndRust.Application/Services/AttributeAllocationService.cs` | Allocation service implementation |
| `src/Core/RuneAndRust.Domain/ValueObjects/AttributeModificationResult.cs` | Modification result value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/AllocationValidationResult.cs` | Validation result value object |
| `tests/RuneAndRust.Application.UnitTests/Services/AttributeAllocationServiceTests.cs` | Unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 3 glossary terms for allocation service concepts |
| `docs/design/v0.17.x/v0.17.2-scope-breakdown.md` | Checked off v0.17.2f deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.2 deliverable checkboxes |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.17.2a | `CoreAttribute` | Attribute identifiers for modification and validation |
| v0.17.2b | `AttributeAllocationMode` | Mode enum for Simple/Advanced distinction |
| v0.17.2b | `AttributeAllocationState` | Immutable state management with factory methods |
| v0.17.2c | `PointBuyConfiguration` | Cost calculation and validation constraints |
| v0.17.2e | `IAttributeProvider` | Configuration, recommended builds, starting points |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.17.5 | `IAttributeAllocationService` | Character creation workflow UI integration |
| v0.17.5 | `AttributeModificationResult` | UI feedback for attribute adjustments |
| v0.17.5 | `AllocationValidationResult` | Pre-navigation validation checks |

---

## Key Design Decisions

1. **Immutable State Transitions** — Every modification returns a new `AttributeAllocationState` instance rather than mutating state in place. This ensures thread safety and enables future undo/redo support.
2. **Try-Pattern for Modifications** — `TryModifyAttribute` returns a result object instead of throwing exceptions, allowing callers to handle failures gracefully without try/catch blocks.
3. **Multi-Error Validation** — `AllocationValidationResult` collects all constraint violations simultaneously rather than failing on the first error, providing comprehensive feedback to the player.
4. **Provider Delegation** — The service delegates all configuration concerns (cost tables, recommended builds, starting points) to `IAttributeProvider`, maintaining separation of concerns and enabling configuration changes without service modifications.
5. **AllocationValidationResult Naming** — Named `AllocationValidationResult` instead of `ValidationResult` to avoid ambiguity with `Spectre.Console.ValidationResult` used in the TUI presentation layer.
6. **Mode-Based Access Control** — Simple mode categorically blocks manual attribute modifications at the service level, enforcing the design constraint that Simple mode is read-only.

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | State creation parameters, modification attempt details, cost calculations, validation step details, mode switch parameters |
| Information | State created successfully, attribute modified successfully, mode switched, allocation reset complete |
| Warning | Simple mode modification blocked, value out of range, insufficient points, validation failed with error count |

---

## Notes

- The service uses `ArgumentNullException.ThrowIfNull` for constructor parameter validation, following the .NET 9 idiomatic pattern.
- `CreateAllocationState` with Simple mode throws `ArgumentException` if archetypeId is null or whitespace, consistent with `IAttributeProvider.GetRecommendedBuild()` behavior.
- `SwitchMode` to Advanced mode recalculates points spent by summing `GetCumulativeCost()` for each attribute's current value, ensuring accurate point tracking after mode transitions.
- `ResetAllocation` delegates to `CreateAllocationState` for consistent initialization logic.
- The `CalculateCost` method is a thin delegate to the provider's configuration, providing a convenient service-level API without duplicating cost logic.
- Test for insufficient points uses a two-step approach: first spends points (Might to 8 = 7 pts), then attempts an unaffordable change (Finesse to 10 = 11 pts with only 8 remaining).
