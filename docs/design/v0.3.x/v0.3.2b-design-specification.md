# v0.3.2b Design Specification: Failure Conditions

## Overview

**Version:** 0.3.2b
**Parent:** v0.3.2 (Quest Chains & Advanced Features)
**Prerequisites:** v0.3.2a Complete (Quest Chains)
**Status:** Design Complete
**Estimated Unit Tests:** ~25

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Requirements](#9-logging-requirements)
10. [Unit Test Specifications](#10-unit-test-specifications)
11. [Use Cases](#11-use-cases)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

This phase implements quest failure mechanics including time limits, failure conditions, and tracking of failed quests. Players must manage time-sensitive quests and can experience quest failure when conditions are not met. The FailureCondition value object defines conditions that cause quest failure, while the FailureType enum categorizes different failure triggers. Time-based failures use turn tracking for deterministic, save-friendly behavior.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Value Objects** | FailureCondition, QuestFailureResult |
| **Enums** | FailureType |
| **Quest Updates** | TimeLimit, TurnsRemaining, IsTimed, IsExpired, FailureConditions, FailureReason |
| **Player Updates** | FailedQuests collection, MoveFailed(), HasFailedQuest() |
| **Service Updates** | ProcessQuestTimers() in QuestService |
| **Tests** | ~25 new unit tests |

### Architectural Significance

This version establishes the **quest failure pattern** that enables:
- Time-sensitive quests with turn-based expiration
- Multiple failure condition types (NPC death, item loss, reputation drop, area departure)
- Failed quest tracking separate from completed quests
- End-of-turn failure condition evaluation
- Foundation for escort quests and complex timed scenarios in future versions
- Integration with turn processing system

---

## 2. Feature Overview

```
v0.3.2b Features
├── FailureCondition Value Object
│   ├── Type (FailureType enum)
│   ├── TargetId (NPC, item, location, faction ID)
│   ├── Threshold (for numeric conditions)
│   ├── FailureMessage (player-facing message)
│   ├── TimeExpired() factory method
│   ├── NPCDied() factory method
│   ├── ItemLost() factory method
│   ├── ReputationDropped() factory method
│   ├── LeftArea() factory method
│   └── ShouldFail(player, state) evaluation method
├── FailureType Enum
│   ├── TimeExpired
│   ├── NPCDied
│   ├── ItemLost
│   ├── ReputationDropped
│   ├── LeftArea
│   ├── WrongTarget
│   └── Custom
├── Quest Entity Updates
│   ├── TimeLimit (nullable int - turns)
│   ├── TurnsRemaining (nullable int)
│   ├── IsTimed (computed property)
│   ├── IsExpired (computed property)
│   ├── FailureConditions (IReadOnlyList<FailureCondition>)
│   ├── FailureReason (string?)
│   ├── SetTimeLimit() method
│   ├── TickTime() method
│   ├── Fail() method
│   └── CheckFailureConditions() method
├── Player Entity Updates
│   ├── FailedQuests (IReadOnlyList<Quest>)
│   ├── MoveFailed() method
│   └── HasFailedQuest() method
├── QuestFailureResult Value Object
│   ├── Quest reference
│   ├── Type (FailureType)
│   └── Message (failure reason)
└── Turn Processing Updates
    ├── ProcessQuestTimers() method
    ├── Time expiration check
    ├── Failure condition evaluation
    └── Failure notification trigger
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IGameRenderer (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ RenderQuestDetailAsync(QuestDetailDto)  // shows time remaining │   │
│  │ RenderQuestFailedAsync(QuestFailedDto)  // failure notification │   │
│  │ RenderTimeWarningAsync(TimeWarningDto)  // low time warning     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IQuestService (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ProcessQuestTimers(player, state): IEnumerable<QuestFailure>  │   │
│  │ + FailQuest(player, quest, reason): QuestFailureResult          │   │
│  │ + GetTimedQuests(player): IEnumerable<Quest>                    │   │
│  │ + GetQuestsNearExpiration(player, threshold): IEnumerable<Quest>│   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestFailedDto (new)                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + QuestId: Guid                                                  │   │
│  │ + QuestName: string                                              │   │
│  │ + FailureType: string                                            │   │
│  │ + FailureMessage: string                                         │   │
│  │ + WasInChain: bool                                               │   │
│  │ + ChainName: string?                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    TimeWarningDto (new)                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + QuestId: Guid                                                  │   │
│  │ + QuestName: string                                              │   │
│  │ + TurnsRemaining: int                                            │   │
│  │ + IsUrgent: bool                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestDetailDto (updated)                      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + TimeLimit: int?                                    // NEW      │   │
│  │ + TurnsRemaining: int?                               // NEW      │   │
│  │ + IsTimed: bool                                      // NEW      │   │
│  │ + FailureConditions: IReadOnlyList<FailureCondDto>?  // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    FailureConditionDto (new)                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Type: string                                                   │   │
│  │ + Description: string                                            │   │
│  │ + FailureMessage: string                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENUMS                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    FailureType (new)                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ TimeExpired                                                      │   │
│  │ NPCDied                                                          │   │
│  │ ItemLost                                                         │   │
│  │ ReputationDropped                                                │   │
│  │ LeftArea                                                         │   │
│  │ WrongTarget                                                      │   │
│  │ Custom                                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    FailureCondition (new)                        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Type: FailureType                                              │   │
│  │ + TargetId: string                                               │   │
│  │ + Threshold: int                                                 │   │
│  │ + FailureMessage: string                                         │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + TimeExpired(turnLimit, message?): static                       │   │
│  │ + NPCDied(npcId, message?): static                               │   │
│  │ + ItemLost(itemId, message?): static                             │   │
│  │ + ReputationDropped(factionId, minRep, message?): static         │   │
│  │ + LeftArea(locationId, message?): static                         │   │
│  │ + ShouldFail(player, state): bool                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestFailureResult (new)                      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Quest: Quest                                                   │   │
│  │ + Type: FailureType                                              │   │
│  │ + Message: string                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ENTITIES                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Quest (updated)                               │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + TimeLimit: int?                                    // NEW      │   │
│  │ + TurnsRemaining: int?                               // NEW      │   │
│  │ + IsTimed: bool                                      // NEW      │   │
│  │ + IsExpired: bool                                    // NEW      │   │
│  │ + FailureConditions: IReadOnlyList<FailureCondition> // NEW      │   │
│  │ + FailureReason: string?                             // NEW      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + SetTimeLimit(turns): void                          // NEW      │   │
│  │ + TickTime(): bool                                   // NEW      │   │
│  │ + Fail(reason): void                                 // NEW      │   │
│  │ + CheckFailureConditions(player, state): FailureCond?// NEW      │   │
│  │ + AddFailureCondition(condition): void               // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Player (updated)                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + FailedQuests: IReadOnlyList<Quest>                 // NEW      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + MoveFailed(quest): void                            // NEW      │   │
│  │ + HasFailedQuest(questDefinitionId): bool            // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Configuration Updates:                                                 │
│  └── quests.json (updated with failure conditions)                     │
│                                                                         │
│  DTOs for Deserialization:                                              │
│  └── FailureConditionConfigDto                                         │
│                                                                         │
│  IConfigurationProvider Updates:                                        │
│  └── LoadQuestDefinitions() - includes failure conditions              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Failure Condition Evaluation Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    FAILURE CONDITION EVALUATION FLOW                    │
└─────────────────────────────────────────────────────────────────────────┘

    End of Player Turn
            │
            ▼
    ┌───────────────────────────────────────┐
    │   QuestService.ProcessQuestTimers()   │
    └───────────────────────────────────────┘
            │
            ├──► For each active quest in player.ActiveQuests
            │
            ▼
    ┌───────────────────────────────────────┐
    │   Check: Is quest timed?              │
    │   (quest.IsTimed == true)             │
    └───────────────────────────────────────┘
            │
            ├── Yes ──► quest.TickTime()
            │               │
            │               ├── Returns true (expired)
            │               │       │
            │               │       ▼
            │               │   quest.Fail("Time has run out.")
            │               │   player.MoveFailed(quest)
            │               │   Add to failures list
            │               │   Continue to next quest
            │               │
            │               └── Returns false (not expired)
            │                       │
            │                       ▼
            │                   Continue to condition check
            │
            └── No ──► Continue to condition check
                            │
                            ▼
    ┌───────────────────────────────────────┐
    │   quest.CheckFailureConditions()      │
    │   (player, gameState)                 │
    └───────────────────────────────────────┘
            │
            ├── Returns FailureCondition (failed)
            │       │
            │       ▼
            │   quest.Fail(condition.FailureMessage)
            │   player.MoveFailed(quest)
            │   Add to failures list
            │
            └── Returns null (no failure)
                    │
                    ▼
                Continue to next quest
            │
            ▼
    ┌───────────────────────────────────────┐
    │   Return all QuestFailureResults      │
    │   for notification display            │
    └───────────────────────────────────────┘
```

### 3.3 Time Tracking Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         TIME TRACKING FLOW                              │
└─────────────────────────────────────────────────────────────────────────┘

    Quest "Urgent Delivery" accepted
    ┌─────────────────────────────────────────┐
    │  TimeLimit: 20 turns                    │
    │  TurnsRemaining: 20                     │
    │  IsTimed: true                          │
    │  IsExpired: false                       │
    └─────────────────────────────────────────┘
            │
            ▼ (End of Turn 1)
    ┌───────────────────────────────────────┐
    │   quest.TickTime()                    │
    │   TurnsRemaining: 20 → 19             │
    │   Returns: false (not expired)        │
    └───────────────────────────────────────┘
            │
            ▼ (Turns 2-17...)
    ┌───────────────────────────────────────┐
    │   TurnsRemaining decrements each turn │
    │   ...                                 │
    └───────────────────────────────────────┘
            │
            ▼ (End of Turn 18, TurnsRemaining = 3)
    ┌───────────────────────────────────────┐
    │   Time Warning Threshold (≤ 3 turns)  │
    │   Display warning to player:          │
    │                                       │
    │   ⚠ QUEST TIME WARNING:              │
    │   "Urgent Delivery"                   │
    │   Only 3 turns remaining!             │
    └───────────────────────────────────────┘
            │
            ▼ (End of Turn 20)
    ┌───────────────────────────────────────┐
    │   quest.TickTime()                    │
    │   TurnsRemaining: 1 → 0               │
    │   Returns: true (expired)             │
    └───────────────────────────────────────┘
            │
            ▼
    ┌───────────────────────────────────────┐
    │   Quest Failure Triggered             │
    │   quest.Status → QuestStatus.Failed   │
    │   quest.FailureReason = "Time out"    │
    │   player.MoveFailed(quest)            │
    └───────────────────────────────────────┘
            │
            ▼
    ┌───────────────────────────────────────────────────────────────────┐
    │   Display Quest Failed Notification:                              │
    │                                                                   │
    │   ═══════════════════════════════════════════════════════════    │
    │                       QUEST FAILED                                │
    │   ═══════════════════════════════════════════════════════════    │
    │                                                                   │
    │     "Urgent Delivery"                                             │
    │                                                                   │
    │     Time has run out. The medicine could not be delivered         │
    │     in time, and the villagers suffered for it.                   │
    │                                                                   │
    │   ═══════════════════════════════════════════════════════════    │
    └───────────────────────────────────────────────────────────────────┘
```

### 3.4 Failure Condition Types

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      FAILURE CONDITION TYPES                            │
└─────────────────────────────────────────────────────────────────────────┘

    FailureType Enum
    ├─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │  TimeExpired                                                    │
    │  ├── Quest time limit reached                                   │
    │  ├── Evaluated via TickTime() return value                      │
    │  └── Example: "Deliver medicine within 20 turns"                │
    │                                                                 │
    │  NPCDied                                                        │
    │  ├── Target NPC killed or died                                  │
    │  ├── TargetId = NPC definition ID                               │
    │  └── Example: "Protect the merchant from bandits"               │
    │                                                                 │
    │  ItemLost                                                       │
    │  ├── Required item no longer in inventory                       │
    │  ├── TargetId = Item definition ID                              │
    │  └── Example: "Don't lose the sacred artifact"                  │
    │                                                                 │
    │  ReputationDropped                                              │
    │  ├── Faction reputation fell below threshold                    │
    │  ├── TargetId = Faction ID, Threshold = minimum reputation      │
    │  └── Example: "Keep guild standing above 50"                    │
    │                                                                 │
    │  LeftArea                                                       │
    │  ├── Player left required location                              │
    │  ├── TargetId = Location/Zone ID                                │
    │  └── Example: "Don't abandon the defense"                       │
    │                                                                 │
    │  WrongTarget                                                    │
    │  ├── Player killed/attacked wrong target                        │
    │  ├── TargetId = Monster/NPC that shouldn't be harmed            │
    │  └── Example: "Don't harm the neutral creatures"                │
    │                                                                 │
    │  Custom                                                         │
    │  ├── Scripted/special condition                                 │
    │  ├── For future extensibility                                   │
    │  └── Example: Complex multi-condition checks                    │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-3.2b-1: Configure Timed Quests
**As a** game designer
**I want to** set time limits on quests in configuration
**So that** players experience urgency in certain quests

**Acceptance Criteria:**
- TimeLimit can be set in quest configuration (in turns)
- Quest tracks TurnsRemaining when accepted
- TurnsRemaining decrements each turn
- Quest fails when TurnsRemaining reaches 0
- Invalid time limits produce clear errors

### US-3.2b-2: View Time Remaining
**As a** player
**I want to** see how much time remains on timed quests
**So that** I can prioritize my actions

**Acceptance Criteria:**
- Timed quests show turns remaining in journal
- Time indicator is prominent and clear
- Low time triggers visual warning
- Expired time shows appropriate messaging

### US-3.2b-3: Receive Time Warnings
**As a** player
**I want to** be warned when quest time is running low
**So that** I can take urgent action

**Acceptance Criteria:**
- Warning displays when ≤ 3 turns remain
- Warning message is clear and prominent
- Warning shows quest name and turns remaining
- Warning appears at end of turn

### US-3.2b-4: Experience Quest Failure
**As a** player
**I want to** see a clear notification when a quest fails
**So that** I understand what happened and why

**Acceptance Criteria:**
- Failure notification displays prominently
- Failure reason is clearly explained
- Failed quest moves to FailedQuests collection
- Quest status changes to Failed
- Failure notification shows quest name

### US-3.2b-5: Configure Failure Conditions
**As a** game designer
**I want to** define multiple failure conditions per quest
**So that** quests can fail for various reasons

**Acceptance Criteria:**
- NPCDied condition triggers when NPC dies
- ItemLost condition triggers when item removed
- ReputationDropped condition triggers on rep loss
- LeftArea condition triggers on area departure
- Multiple conditions can be combined per quest
- Custom failure messages display correctly

### US-3.2b-6: Track Failed Quests
**As a** player
**I want to** see my failed quests in the journal
**So that** I know which quests I didn't complete

**Acceptance Criteria:**
- Failed quests appear in separate journal section
- Failed quest shows failure reason
- HasFailedQuest() correctly identifies failed quests
- Failed quests persist in player state

---

## 5. Data Models

### 5.1 FailureType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of conditions that can cause quest failure.
/// </summary>
/// <remarks>
/// Used by FailureCondition to categorize different failure triggers.
/// Each type has specific evaluation logic in the ShouldFail method.
/// </remarks>
public enum FailureType
{
    /// <summary>
    /// Quest time limit expired.
    /// </summary>
    /// <remarks>
    /// Evaluated via Quest.TickTime() return value, not ShouldFail().
    /// Threshold represents the original turn limit.
    /// </remarks>
    TimeExpired,

    /// <summary>
    /// A required NPC has died.
    /// </summary>
    /// <remarks>
    /// TargetId specifies the NPC definition ID to monitor.
    /// Used for escort and protection quests.
    /// </remarks>
    NPCDied,

    /// <summary>
    /// A required item was lost from inventory.
    /// </summary>
    /// <remarks>
    /// TargetId specifies the item definition ID.
    /// Triggers when item is no longer in player inventory.
    /// </remarks>
    ItemLost,

    /// <summary>
    /// Reputation with a faction fell below threshold.
    /// </summary>
    /// <remarks>
    /// TargetId specifies the faction ID.
    /// Threshold specifies the minimum required reputation.
    /// </remarks>
    ReputationDropped,

    /// <summary>
    /// Player left a required area.
    /// </summary>
    /// <remarks>
    /// TargetId specifies the required location/zone ID.
    /// Triggers when player.CurrentRoomId doesn't match.
    /// </remarks>
    LeftArea,

    /// <summary>
    /// A monster or NPC that shouldn't be harmed was killed.
    /// </summary>
    /// <remarks>
    /// TargetId specifies the entity that must not be killed.
    /// Used for stealth or pacifist objectives.
    /// </remarks>
    WrongTarget,

    /// <summary>
    /// Custom condition evaluated by script or special logic.
    /// </summary>
    /// <remarks>
    /// Reserved for future extensibility.
    /// Requires custom evaluation implementation.
    /// </remarks>
    Custom
}
```

### 5.2 FailureCondition Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a condition that causes quest failure.
/// </summary>
/// <remarks>
/// Immutable record struct defining failure triggers for quests.
/// Each quest can have multiple failure conditions that are
/// evaluated at the end of each turn.
/// </remarks>
public readonly record struct FailureCondition
{
    /// <summary>
    /// Gets the type of failure condition.
    /// </summary>
    public FailureType Type { get; init; }

    /// <summary>
    /// Gets the target ID for the condition.
    /// </summary>
    /// <remarks>
    /// Interpretation depends on Type:
    /// - NPCDied: NPC definition ID
    /// - ItemLost: Item definition ID
    /// - ReputationDropped: Faction ID
    /// - LeftArea: Location/Zone ID
    /// - WrongTarget: Entity definition ID
    /// - TimeExpired: Not used (empty string)
    /// - Custom: Custom identifier
    /// </remarks>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the threshold value for numeric conditions.
    /// </summary>
    /// <remarks>
    /// Used by:
    /// - TimeExpired: Original turn limit
    /// - ReputationDropped: Minimum required reputation
    /// Other types ignore this value.
    /// </remarks>
    public int Threshold { get; init; }

    /// <summary>
    /// Gets the failure message shown to the player.
    /// </summary>
    /// <remarks>
    /// Displayed when this condition triggers quest failure.
    /// Should be narrative and descriptive.
    /// </remarks>
    public string FailureMessage { get; init; }

    /// <summary>
    /// Creates a time limit failure condition.
    /// </summary>
    /// <param name="turnLimit">The turn limit that was set.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new TimeExpired failure condition.</returns>
    /// <remarks>
    /// Note: Time expiration is typically handled by Quest.TickTime(),
    /// but this condition is created for display purposes.
    /// </remarks>
    public static FailureCondition TimeExpired(int turnLimit, string? message = null) => new()
    {
        Type = FailureType.TimeExpired,
        TargetId = string.Empty,
        Threshold = turnLimit,
        FailureMessage = message ?? "Time has run out."
    };

    /// <summary>
    /// Creates an NPC death failure condition.
    /// </summary>
    /// <param name="npcId">The NPC definition ID to protect.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new NPCDied failure condition.</returns>
    public static FailureCondition NPCDied(string npcId, string? message = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(npcId);

        return new()
        {
            Type = FailureType.NPCDied,
            TargetId = npcId.ToLowerInvariant(),
            Threshold = 0,
            FailureMessage = message ?? "The NPC you were protecting has died."
        };
    }

    /// <summary>
    /// Creates an item lost failure condition.
    /// </summary>
    /// <param name="itemId">The item definition ID that must be kept.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new ItemLost failure condition.</returns>
    public static FailureCondition ItemLost(string itemId, string? message = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);

        return new()
        {
            Type = FailureType.ItemLost,
            TargetId = itemId.ToLowerInvariant(),
            Threshold = 0,
            FailureMessage = message ?? "You have lost a required item."
        };
    }

    /// <summary>
    /// Creates a reputation drop failure condition.
    /// </summary>
    /// <param name="factionId">The faction ID to monitor.</param>
    /// <param name="minReputation">The minimum required reputation.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new ReputationDropped failure condition.</returns>
    public static FailureCondition ReputationDropped(string factionId, int minReputation, string? message = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(factionId);

        return new()
        {
            Type = FailureType.ReputationDropped,
            TargetId = factionId.ToLowerInvariant(),
            Threshold = minReputation,
            FailureMessage = message ?? "Your standing has fallen too low."
        };
    }

    /// <summary>
    /// Creates a location-based failure condition.
    /// </summary>
    /// <param name="locationId">The location/zone ID that must not be left.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new LeftArea failure condition.</returns>
    public static FailureCondition LeftArea(string locationId, string? message = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(locationId);

        return new()
        {
            Type = FailureType.LeftArea,
            TargetId = locationId.ToLowerInvariant(),
            Threshold = 0,
            FailureMessage = message ?? "You left the area before completing the objective."
        };
    }

    /// <summary>
    /// Creates a wrong target failure condition.
    /// </summary>
    /// <param name="entityId">The entity ID that must not be harmed.</param>
    /// <param name="message">Optional custom failure message.</param>
    /// <returns>A new WrongTarget failure condition.</returns>
    public static FailureCondition WrongTarget(string entityId, string? message = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(entityId);

        return new()
        {
            Type = FailureType.WrongTarget,
            TargetId = entityId.ToLowerInvariant(),
            Threshold = 0,
            FailureMessage = message ?? "You harmed something you shouldn't have."
        };
    }

    /// <summary>
    /// Evaluates whether this condition should trigger quest failure.
    /// </summary>
    /// <param name="player">The player to evaluate against.</param>
    /// <param name="gameState">The current game state.</param>
    /// <returns>True if the condition is met and quest should fail.</returns>
    /// <remarks>
    /// TimeExpired is not evaluated here - it's handled by Quest.TickTime().
    /// This method checks other conditions against current game state.
    /// </remarks>
    public bool ShouldFail(Player player, GameState gameState)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(gameState);

        return Type switch
        {
            FailureType.TimeExpired => false, // Handled by turn counter
            FailureType.NPCDied => gameState.IsNPCDead(TargetId),
            FailureType.ItemLost => !player.Inventory.HasItem(TargetId),
            FailureType.ReputationDropped => player.GetReputation(TargetId) < Threshold,
            FailureType.LeftArea => !IsInRequiredArea(player, TargetId),
            FailureType.WrongTarget => gameState.WasEntityKilled(TargetId),
            FailureType.Custom => false, // Custom conditions require specific implementation
            _ => false
        };
    }

    /// <summary>
    /// Checks if player is in the required area.
    /// </summary>
    private static bool IsInRequiredArea(Player player, string locationId)
    {
        // Check if player's current room matches or is within the required location/zone
        if (string.IsNullOrEmpty(player.CurrentRoomId))
            return false;

        return player.CurrentRoomId.Equals(locationId, StringComparison.OrdinalIgnoreCase) ||
               player.CurrentRoomId.StartsWith(locationId + "-", StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets a human-readable description of this condition.
    /// </summary>
    /// <returns>Description suitable for display to player.</returns>
    public string GetDescription()
    {
        return Type switch
        {
            FailureType.TimeExpired => $"Time expires ({Threshold} turns)",
            FailureType.NPCDied => $"NPC must survive",
            FailureType.ItemLost => $"Item must be kept",
            FailureType.ReputationDropped => $"Reputation must stay above {Threshold}",
            FailureType.LeftArea => $"Must stay in area",
            FailureType.WrongTarget => $"Must not harm target",
            FailureType.Custom => "Special condition",
            _ => "Unknown condition"
        };
    }
}
```

### 5.3 QuestFailureResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of a quest failure event.
/// </summary>
/// <remarks>
/// Returned by ProcessQuestTimers() when a quest fails.
/// Contains all information needed to display failure notification.
/// </remarks>
public readonly record struct QuestFailureResult
{
    /// <summary>
    /// Gets the quest that failed.
    /// </summary>
    public Quest Quest { get; init; }

    /// <summary>
    /// Gets the type of failure.
    /// </summary>
    public FailureType Type { get; init; }

    /// <summary>
    /// Gets the failure message.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Creates a new quest failure result.
    /// </summary>
    /// <param name="quest">The failed quest.</param>
    /// <param name="type">The failure type.</param>
    /// <param name="message">The failure message.</param>
    public QuestFailureResult(Quest quest, FailureType type, string message)
    {
        Quest = quest ?? throw new ArgumentNullException(nameof(quest));
        Type = type;
        Message = message ?? string.Empty;
    }

    /// <summary>
    /// Gets whether this failure was due to time expiration.
    /// </summary>
    public bool WasTimeExpired => Type == FailureType.TimeExpired;

    /// <summary>
    /// Gets whether this quest was part of a chain.
    /// </summary>
    public bool WasInChain => Quest.IsInChain;

    /// <summary>
    /// Gets the chain ID if quest was in a chain.
    /// </summary>
    public string? ChainId => Quest.ChainId;
}
```

### 5.4 Quest Entity Updates

```csharp
// Additions to existing Quest class in RuneAndRust.Domain.Entities

/// <summary>
/// Gets the time limit in turns (null = no limit).
/// </summary>
/// <remarks>
/// Set from configuration. Once set, TurnsRemaining starts at this value
/// and decrements each turn until reaching 0.
/// </remarks>
public int? TimeLimit { get; private set; }

/// <summary>
/// Gets the remaining turns until expiration (null = no limit).
/// </summary>
/// <remarks>
/// Decremented by TickTime() at end of each turn.
/// Quest fails when this reaches 0.
/// </remarks>
public int? TurnsRemaining { get; private set; }

/// <summary>
/// Gets whether this quest has a time limit.
/// </summary>
public bool IsTimed => TimeLimit.HasValue;

/// <summary>
/// Gets whether this quest has expired due to time.
/// </summary>
/// <remarks>
/// True when TurnsRemaining has reached 0.
/// </remarks>
public bool IsExpired => TurnsRemaining.HasValue && TurnsRemaining <= 0;

/// <summary>
/// Gets failure conditions for this quest.
/// </summary>
/// <remarks>
/// Evaluated at end of each turn by ProcessQuestTimers().
/// Empty collection means no failure conditions (besides optional time limit).
/// </remarks>
public IReadOnlyList<FailureCondition> FailureConditions => _failureConditions;
private readonly List<FailureCondition> _failureConditions = new();

/// <summary>
/// Gets the reason for failure (if quest has failed).
/// </summary>
/// <remarks>
/// Set when Fail() is called. Null if quest hasn't failed.
/// </remarks>
public string? FailureReason { get; private set; }

/// <summary>
/// Sets the time limit for this quest.
/// </summary>
/// <param name="turns">The number of turns allowed.</param>
/// <exception cref="ArgumentException">Thrown if turns is not positive.</exception>
/// <exception cref="InvalidOperationException">Thrown if quest is not active.</exception>
public void SetTimeLimit(int turns)
{
    if (turns <= 0)
        throw new ArgumentException("Time limit must be positive.", nameof(turns));

    if (Status != QuestStatus.Active && Status != QuestStatus.Available)
        throw new InvalidOperationException("Cannot set time limit on non-active quest.");

    TimeLimit = turns;
    TurnsRemaining = turns;
}

/// <summary>
/// Decrements the remaining time by one turn.
/// </summary>
/// <returns>True if time has expired (TurnsRemaining reached 0), false otherwise.</returns>
/// <remarks>
/// Called at end of each turn by ProcessQuestTimers().
/// Returns false if quest is not timed.
/// </remarks>
public bool TickTime()
{
    if (!TurnsRemaining.HasValue || TurnsRemaining <= 0)
        return false;

    TurnsRemaining--;
    return TurnsRemaining <= 0;
}

/// <summary>
/// Fails the quest with the specified reason.
/// </summary>
/// <param name="reason">The failure reason to display.</param>
/// <exception cref="InvalidOperationException">Thrown if quest is not active.</exception>
public void Fail(string reason)
{
    if (Status != QuestStatus.Active)
        throw new InvalidOperationException("Can only fail active quests.");

    Status = QuestStatus.Failed;
    FailureReason = reason ?? "Quest failed.";
}

/// <summary>
/// Checks all failure conditions against current game state.
/// </summary>
/// <param name="player">The player to check against.</param>
/// <param name="gameState">The current game state.</param>
/// <returns>The first failed condition, or null if none failed.</returns>
/// <remarks>
/// Returns on first failure found. Time expiration is handled separately.
/// </remarks>
public FailureCondition? CheckFailureConditions(Player player, GameState gameState)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(gameState);

    foreach (var condition in _failureConditions)
    {
        if (condition.ShouldFail(player, gameState))
            return condition;
    }

    return null;
}

/// <summary>
/// Adds a failure condition to this quest.
/// </summary>
/// <param name="condition">The failure condition to add.</param>
public void AddFailureCondition(FailureCondition condition)
{
    _failureConditions.Add(condition);
}

/// <summary>
/// Sets failure conditions from a collection.
/// </summary>
/// <param name="conditions">The failure conditions to set.</param>
public void SetFailureConditions(IEnumerable<FailureCondition> conditions)
{
    _failureConditions.Clear();
    if (conditions != null)
    {
        _failureConditions.AddRange(conditions);
    }
}

/// <summary>
/// Gets whether time is running low (3 or fewer turns remaining).
/// </summary>
public bool IsTimeLow => TurnsRemaining.HasValue && TurnsRemaining > 0 && TurnsRemaining <= 3;
```

### 5.5 Player Entity Updates

```csharp
// Additions to existing Player class in RuneAndRust.Domain.Entities

/// <summary>
/// Gets quests that have been failed.
/// </summary>
/// <remarks>
/// Contains quests moved from ActiveQuests upon failure.
/// Separate from CompletedQuests collection.
/// </remarks>
public IReadOnlyList<Quest> FailedQuests => _failedQuests;
private readonly List<Quest> _failedQuests = new();

/// <summary>
/// Moves a quest from active to failed collection.
/// </summary>
/// <param name="quest">The quest that has failed.</param>
/// <remarks>
/// Called after Quest.Fail() sets the failure status.
/// Quest must be in ActiveQuests to be moved.
/// </remarks>
public void MoveFailed(Quest quest)
{
    ArgumentNullException.ThrowIfNull(quest);

    if (_activeQuests.Remove(quest))
    {
        _failedQuests.Add(quest);
    }
}

/// <summary>
/// Gets whether a specific quest has been failed.
/// </summary>
/// <param name="questDefinitionId">The quest definition ID to check.</param>
/// <returns>True if the quest is in the failed collection.</returns>
public bool HasFailedQuest(string questDefinitionId)
{
    if (string.IsNullOrWhiteSpace(questDefinitionId))
        return false;

    return _failedQuests.Any(q =>
        q.DefinitionId.Equals(questDefinitionId, StringComparison.OrdinalIgnoreCase));
}

/// <summary>
/// Gets the count of failed quests.
/// </summary>
public int FailedQuestCount => _failedQuests.Count;

/// <summary>
/// Gets a failed quest by definition ID.
/// </summary>
/// <param name="questDefinitionId">The quest definition ID.</param>
/// <returns>The failed quest, or null if not found.</returns>
public Quest? GetFailedQuest(string questDefinitionId)
{
    if (string.IsNullOrWhiteSpace(questDefinitionId))
        return null;

    return _failedQuests.FirstOrDefault(q =>
        q.DefinitionId.Equals(questDefinitionId, StringComparison.OrdinalIgnoreCase));
}
```

---

## 6. Configuration Schemas

### 6.1 quests.json Updates (Failure Conditions)

```json
{
  "$schema": "../schemas/quests.schema.json",
  "quests": [
    {
      "id": "urgent-delivery",
      "name": "Urgent Delivery",
      "description": "The medicine must reach the village before sunset! Travel quickly through the forest to deliver the package.",
      "giverNpcId": "courier-master",
      "timeLimit": 20,
      "objectives": [
        {
          "type": "Talk",
          "description": "Deliver medicine to Thornwood",
          "target": { "targetId": "village-healer" }
        }
      ],
      "failureConditions": [
        {
          "type": "ItemLost",
          "targetId": "medicine-package",
          "message": "The medicine was lost or destroyed!"
        }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 100 },
          { "type": "Gold", "amount": 50 },
          { "type": "Reputation", "targetId": "thornwood-village", "amount": 200, "displayName": "Thornwood Village" }
        ]
      }
    },
    {
      "id": "protect-merchant",
      "name": "Protect the Merchant",
      "description": "Escort Grimbold safely through the dangerous Mountain Pass. Bandits are known to lurk in the shadows.",
      "giverNpcId": "grimbold-trader",
      "objectives": [
        {
          "type": "Explore",
          "description": "Reach the Mountain Pass exit",
          "target": { "targetId": "room-pass-exit" }
        }
      ],
      "failureConditions": [
        {
          "type": "NPCDied",
          "targetId": "grimbold-trader",
          "message": "Grimbold has been killed! You failed to protect him from the bandits."
        },
        {
          "type": "LeftArea",
          "targetId": "zone-mountain-pass",
          "message": "You abandoned Grimbold in the dangerous pass."
        }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 150 },
          { "type": "Gold", "amount": 100 },
          { "type": "Item", "targetId": "traders-gratitude", "displayName": "Trader's Token of Gratitude" }
        ]
      }
    },
    {
      "id": "guild-reputation",
      "name": "Maintain Guild Standing",
      "description": "The guild is watching your actions. Don't let your reputation fall while completing this task.",
      "giverNpcId": "guild-master",
      "objectives": [
        {
          "type": "Kill",
          "description": "Defeat the rival gang members",
          "target": { "targetType": "rival-gang-member" },
          "requiredCount": 5
        }
      ],
      "failureConditions": [
        {
          "type": "ReputationDropped",
          "targetId": "thieves-guild",
          "threshold": 50,
          "message": "Your standing with the guild has fallen too low. They no longer trust you."
        }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 120 },
          { "type": "Reputation", "targetId": "thieves-guild", "amount": 100, "displayName": "Thieves Guild" }
        ]
      }
    },
    {
      "id": "peaceful-negotiation",
      "name": "Peaceful Negotiation",
      "description": "Negotiate with the forest spirits. Violence will doom the negotiations.",
      "giverNpcId": "druid-elder",
      "objectives": [
        {
          "type": "Talk",
          "description": "Speak with the Forest Spirit",
          "target": { "targetId": "forest-spirit-elder" }
        }
      ],
      "failureConditions": [
        {
          "type": "WrongTarget",
          "targetId": "forest-spirit",
          "message": "You attacked the forest spirits! The negotiations have failed."
        }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 200 },
          { "type": "Item", "targetId": "spirit-blessing", "displayName": "Spirit's Blessing" }
        ]
      }
    }
  ]
}
```

### 6.2 quests.schema.json Updates (Failure Conditions)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Quest Configuration",
  "description": "Quest definitions including failure conditions",
  "type": "object",
  "required": ["quests"],
  "properties": {
    "quests": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/questDefinition"
      }
    }
  },
  "definitions": {
    "questDefinition": {
      "type": "object",
      "required": ["id", "name", "objectives"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100
        },
        "description": {
          "type": "string",
          "maxLength": 2000
        },
        "giverNpcId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "timeLimit": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "description": "Time limit in turns (optional)"
        },
        "objectives": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/objective"
          }
        },
        "failureConditions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/failureCondition"
          },
          "description": "Conditions that cause quest failure"
        },
        "rewards": {
          "$ref": "#/definitions/questReward"
        }
      }
    },
    "failureCondition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["TimeExpired", "NPCDied", "ItemLost", "ReputationDropped", "LeftArea", "WrongTarget", "Custom"],
          "description": "Type of failure condition"
        },
        "targetId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Target ID (NPC, item, location, faction, entity)"
        },
        "threshold": {
          "type": "integer",
          "description": "Threshold value for numeric conditions (e.g., minimum reputation)"
        },
        "message": {
          "type": "string",
          "maxLength": 500,
          "description": "Custom failure message to display"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "NPCDied" } }
          },
          "then": {
            "required": ["targetId"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "ItemLost" } }
          },
          "then": {
            "required": ["targetId"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "ReputationDropped" } }
          },
          "then": {
            "required": ["targetId", "threshold"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "LeftArea" } }
          },
          "then": {
            "required": ["targetId"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "WrongTarget" } }
          },
          "then": {
            "required": ["targetId"]
          }
        }
      ]
    },
    "objective": {
      "type": "object",
      "required": ["type", "description"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["Kill", "Collect", "Talk", "Explore", "Escort", "Interact"]
        },
        "description": {
          "type": "string"
        },
        "target": {
          "type": "object",
          "properties": {
            "targetId": { "type": "string" },
            "targetType": { "type": "string" }
          }
        },
        "requiredCount": {
          "type": "integer",
          "minimum": 1,
          "default": 1
        }
      }
    },
    "questReward": {
      "type": "object",
      "required": ["entries"],
      "properties": {
        "entries": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/rewardEntry"
          }
        }
      }
    },
    "rewardEntry": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["XP", "Gold", "Item", "Reputation", "Unlock"]
        },
        "amount": {
          "type": "integer"
        },
        "targetId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "displayName": {
          "type": ["string", "null"]
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IQuestService Updates

```csharp
namespace RuneAndRust.Application.Interfaces;

// Additions to existing IQuestService interface

/// <summary>
/// Processes quest timers and failure conditions at end of turn.
/// </summary>
/// <param name="player">The player whose quests to process.</param>
/// <param name="gameState">The current game state for condition evaluation.</param>
/// <returns>Collection of quest failure results for any quests that failed.</returns>
/// <remarks>
/// Should be called at the end of each turn.
/// Decrements time on timed quests and evaluates all failure conditions.
/// </remarks>
IEnumerable<QuestFailureResult> ProcessQuestTimers(Player player, GameState gameState);

/// <summary>
/// Fails a specific quest with the given reason.
/// </summary>
/// <param name="player">The player.</param>
/// <param name="quest">The quest to fail.</param>
/// <param name="reason">The failure reason.</param>
/// <returns>The failure result.</returns>
QuestFailureResult FailQuest(Player player, Quest quest, string reason);

/// <summary>
/// Gets all timed quests for a player.
/// </summary>
/// <param name="player">The player.</param>
/// <returns>Active quests that have time limits.</returns>
IEnumerable<Quest> GetTimedQuests(Player player);

/// <summary>
/// Gets quests that are near expiration.
/// </summary>
/// <param name="player">The player.</param>
/// <param name="turnsThreshold">Maximum turns remaining to be considered "near expiration".</param>
/// <returns>Timed quests with turns remaining at or below threshold.</returns>
IEnumerable<Quest> GetQuestsNearExpiration(Player player, int turnsThreshold = 3);

/// <summary>
/// Gets all failed quests for a player.
/// </summary>
/// <param name="player">The player.</param>
/// <returns>All quests in the player's failed collection.</returns>
IEnumerable<Quest> GetFailedQuests(Player player);
```

### 7.2 QuestService Implementation Updates

```csharp
namespace RuneAndRust.Application.Services;

// Additions to existing QuestService class

/// <inheritdoc />
public IEnumerable<QuestFailureResult> ProcessQuestTimers(Player player, GameState gameState)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(gameState);

    var failures = new List<QuestFailureResult>();

    // Process each active quest
    foreach (var quest in player.ActiveQuests.ToList())
    {
        // Check time expiration first
        if (quest.IsTimed)
        {
            var expired = quest.TickTime();

            if (expired)
            {
                _logger.LogInformation(
                    "Quest '{QuestId}' expired - time limit reached",
                    quest.DefinitionId);

                quest.Fail("Time has run out.");
                player.MoveFailed(quest);

                failures.Add(new QuestFailureResult(
                    quest,
                    FailureType.TimeExpired,
                    "Time has run out."));

                continue; // Skip other condition checks for this quest
            }

            // Log warning if time is low
            if (quest.IsTimeLow)
            {
                _logger.LogDebug(
                    "Quest '{QuestId}' has {TurnsRemaining} turns remaining",
                    quest.DefinitionId, quest.TurnsRemaining);
            }
        }

        // Check other failure conditions
        var failedCondition = quest.CheckFailureConditions(player, gameState);

        if (failedCondition.HasValue)
        {
            var condition = failedCondition.Value;

            _logger.LogInformation(
                "Quest '{QuestId}' failed due to {FailureType}: {Message}",
                quest.DefinitionId, condition.Type, condition.FailureMessage);

            quest.Fail(condition.FailureMessage);
            player.MoveFailed(quest);

            failures.Add(new QuestFailureResult(
                quest,
                condition.Type,
                condition.FailureMessage));
        }
    }

    if (failures.Any())
    {
        _logger.LogInformation(
            "Processed quest timers: {FailureCount} quest(s) failed",
            failures.Count);
    }

    return failures;
}

/// <inheritdoc />
public QuestFailureResult FailQuest(Player player, Quest quest, string reason)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(quest);

    if (quest.Status != QuestStatus.Active)
    {
        throw new InvalidOperationException(
            $"Cannot fail quest '{quest.DefinitionId}' - not active.");
    }

    _logger.LogInformation(
        "Manually failing quest '{QuestId}': {Reason}",
        quest.DefinitionId, reason);

    quest.Fail(reason);
    player.MoveFailed(quest);

    return new QuestFailureResult(
        quest,
        FailureType.Custom,
        reason);
}

/// <inheritdoc />
public IEnumerable<Quest> GetTimedQuests(Player player)
{
    ArgumentNullException.ThrowIfNull(player);

    return player.ActiveQuests.Where(q => q.IsTimed);
}

/// <inheritdoc />
public IEnumerable<Quest> GetQuestsNearExpiration(Player player, int turnsThreshold = 3)
{
    ArgumentNullException.ThrowIfNull(player);

    return player.ActiveQuests
        .Where(q => q.IsTimed &&
                    q.TurnsRemaining.HasValue &&
                    q.TurnsRemaining.Value > 0 &&
                    q.TurnsRemaining.Value <= turnsThreshold);
}

/// <inheritdoc />
public IEnumerable<Quest> GetFailedQuests(Player player)
{
    ArgumentNullException.ThrowIfNull(player);

    return player.FailedQuests;
}
```

### 7.3 Configuration DTOs

```csharp
namespace RuneAndRust.Application.Configuration;

/// <summary>
/// DTO for failure condition configuration in quests.json.
/// </summary>
public class FailureConditionConfigDto
{
    /// <summary>
    /// Gets or sets the failure condition type.
    /// </summary>
    public string Type { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the target ID.
    /// </summary>
    public string? TargetId { get; set; }

    /// <summary>
    /// Gets or sets the threshold value.
    /// </summary>
    public int? Threshold { get; set; }

    /// <summary>
    /// Gets or sets the custom failure message.
    /// </summary>
    public string? Message { get; set; }
}

/// <summary>
/// Updates to QuestConfigDto to include failure conditions.
/// </summary>
public class QuestConfigDto
{
    // ... existing properties ...

    /// <summary>
    /// Gets or sets the time limit in turns.
    /// </summary>
    public int? TimeLimit { get; set; }

    /// <summary>
    /// Gets or sets the failure conditions.
    /// </summary>
    public List<FailureConditionConfigDto>? FailureConditions { get; set; }
}
```

### 7.4 Application DTOs

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for quest failure notification display.
/// </summary>
/// <param name="QuestId">The quest instance ID.</param>
/// <param name="QuestName">The quest display name.</param>
/// <param name="FailureType">The type of failure.</param>
/// <param name="FailureMessage">The failure message to display.</param>
/// <param name="WasInChain">Whether the quest was part of a chain.</param>
/// <param name="ChainName">The chain name if applicable.</param>
public record QuestFailedDto(
    Guid QuestId,
    string QuestName,
    string FailureType,
    string FailureMessage,
    bool WasInChain,
    string? ChainName);

/// <summary>
/// DTO for time warning notification display.
/// </summary>
/// <param name="QuestId">The quest instance ID.</param>
/// <param name="QuestName">The quest display name.</param>
/// <param name="TurnsRemaining">The number of turns remaining.</param>
/// <param name="IsUrgent">Whether this is an urgent warning (1 turn left).</param>
public record TimeWarningDto(
    Guid QuestId,
    string QuestName,
    int TurnsRemaining,
    bool IsUrgent)
{
    /// <summary>
    /// Gets the formatted warning message.
    /// </summary>
    public string WarningMessage => IsUrgent
        ? $"URGENT: Only 1 turn remaining!"
        : $"Only {TurnsRemaining} turns remaining!";
}

/// <summary>
/// DTO for failure condition display.
/// </summary>
/// <param name="Type">The failure condition type.</param>
/// <param name="Description">Human-readable description.</param>
/// <param name="FailureMessage">The message shown if triggered.</param>
public record FailureConditionDto(
    string Type,
    string Description,
    string FailureMessage);

/// <summary>
/// Updates to QuestDetailDto to include time and failure info.
/// </summary>
public record QuestDetailDto(
    Guid Id,
    string Name,
    string Description,
    string Status,
    int Progress,
    IReadOnlyList<ObjectiveSummaryDto> Objectives,
    string? Hint,
    string? GiverName,
    string? TurnInName,
    DateTime? AcceptedAt,
    RewardDisplayDto Rewards,
    RewardDisplayDto? BonusRewards,
    ChainMembershipDto? ChainInfo,
    int? TimeLimit,                                    // NEW
    int? TurnsRemaining,                               // NEW
    bool IsTimed,                                      // NEW
    IReadOnlyList<FailureConditionDto>? FailureConditions);  // NEW
```

---

## 8. User-Facing Changes

### 8.1 Timed Quest Display

```
┌─────────────────────────────────────────────────────────────┐
│                  URGENT DELIVERY                            │
├─────────────────────────────────────────────────────────────┤
│  Status: Active                        ⏱ 15 turns remaining │
│  Given by: Courier Master                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The medicine must reach the village before sunset!         │
│  Travel quickly through the forest to deliver the package.  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Deliver medicine to Thornwood                  [  ]      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  REWARDS                                                    │
│  • 100 XP                                                   │
│  • 50 gold                                                  │
│  • +200 Thornwood Village reputation                        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ⚠ FAILURE CONDITIONS                                       │
│  • Time expires (20 turns)                                  │
│  • Medicine is lost or destroyed                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 Quest Journal with Timed Quests

```
┌─────────────────────────────────────────────────────────────┐
│                    QUEST JOURNAL                            │
├─────────────────────────────────────────────────────────────┤
│  [ACTIVE QUESTS]                                            │
│  ───────────────────────────────────────────────────────────│
│                                                             │
│  ⏱ Urgent Delivery                          ⚠ 3 turns left │
│     Deliver medicine to Thornwood                           │
│                                                             │
│  ⏱ Protect the Merchant                      12 turns left  │
│     Escort Grimbold through the Mountain Pass               │
│                                                             │
│    Lost Heirloom                                [ACTIVE]    │
│     Find the family ring in the old ruins                   │
│                                                             │
│  [FAILED QUESTS]                                            │
│  ───────────────────────────────────────────────────────────│
│                                                             │
│  ✗ The Quick Courier                            [FAILED]    │
│     Time has run out.                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 Time Warning Notification

```
=== END OF TURN ===

⚠ QUEST TIME WARNING: "Urgent Delivery"
  Only 3 turns remaining!

---

=== END OF TURN ===

⚠ URGENT: "Urgent Delivery"
  Only 1 turn remaining!
```

### 8.4 Quest Failure Notification

```
═══════════════════════════════════════════════════════════════
                    QUEST FAILED
═══════════════════════════════════════════════════════════════

  "Urgent Delivery"

  Time has run out. The medicine could not be delivered
  in time, and the villagers suffered for it.

═══════════════════════════════════════════════════════════════

---

═══════════════════════════════════════════════════════════════
                    QUEST FAILED
═══════════════════════════════════════════════════════════════

  "Protect the Merchant"

  Grimbold has been killed! You failed to protect him
  from the bandits.

═══════════════════════════════════════════════════════════════

---

═══════════════════════════════════════════════════════════════
                    QUEST FAILED
═══════════════════════════════════════════════════════════════

  "Maintain Guild Standing"

  Your standing with the guild has fallen too low.
  They no longer trust you.

═══════════════════════════════════════════════════════════════
```

### 8.5 Escort Quest Display

```
┌─────────────────────────────────────────────────────────────┐
│                  PROTECT THE MERCHANT                       │
├─────────────────────────────────────────────────────────────┤
│  Status: Active                                             │
│  Given by: Grimbold the Trader                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Escort Grimbold safely through the dangerous Mountain      │
│  Pass. Bandits are known to lurk in the shadows.            │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Reach the Mountain Pass exit                   [  ]      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  REWARDS                                                    │
│  • 150 XP                                                   │
│  • 100 gold                                                 │
│  • Trader's Token of Gratitude                              │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ⚠ FAILURE CONDITIONS                                       │
│  • Grimbold is killed                                       │
│  • You abandon Grimbold in the pass                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. Logging Requirements

### 9.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Time Tick | Debug | "Quest '{QuestId}' has {TurnsRemaining} turns remaining" | QuestId, TurnsRemaining |
| Time Expired | Info | "Quest '{QuestId}' expired - time limit reached" | QuestId |
| Condition Failed | Info | "Quest '{QuestId}' failed due to {FailureType}: {Message}" | QuestId, FailureType, Message |
| Manual Fail | Info | "Manually failing quest '{QuestId}': {Reason}" | QuestId, Reason |
| Timer Processed | Info | "Processed quest timers: {FailureCount} quest(s) failed" | FailureCount |
| Quest Moved Failed | Debug | "Quest '{QuestId}' moved to failed collection" | QuestId |

### 9.2 Example Log Output

```
[2024-01-20 15:30:00 DBG] Quest 'urgent-delivery' has 5 turns remaining
[2024-01-20 15:35:00 DBG] Quest 'urgent-delivery' has 4 turns remaining
[2024-01-20 15:40:00 DBG] Quest 'urgent-delivery' has 3 turns remaining
[2024-01-20 15:45:00 DBG] Quest 'urgent-delivery' has 2 turns remaining
[2024-01-20 15:50:00 DBG] Quest 'urgent-delivery' has 1 turns remaining
[2024-01-20 15:55:00 INF] Quest 'urgent-delivery' expired - time limit reached
[2024-01-20 15:55:00 INF] Processed quest timers: 1 quest(s) failed

[2024-01-20 16:15:00 INF] Quest 'protect-merchant' failed due to NPCDied: Grimbold has been killed!
[2024-01-20 16:15:00 INF] Processed quest timers: 1 quest(s) failed

[2024-01-20 17:00:00 INF] Quest 'guild-reputation' failed due to ReputationDropped: Your standing with the guild has fallen too low.
```

---

## 10. Unit Test Specifications

### 10.1 FailureCondition Tests (~8 tests)

```csharp
namespace RuneAndRust.Domain.Tests.ValueObjects;

[TestFixture]
public class FailureConditionTests
{
    [Test]
    public void TimeExpired_CreatesConditionWithCorrectType()
    {
        var condition = FailureCondition.TimeExpired(20);

        condition.Type.Should().Be(FailureType.TimeExpired);
        condition.Threshold.Should().Be(20);
        condition.FailureMessage.Should().Be("Time has run out.");
    }

    [Test]
    public void TimeExpired_WithCustomMessage_UsesCustomMessage()
    {
        var condition = FailureCondition.TimeExpired(10, "The ritual window has closed.");

        condition.FailureMessage.Should().Be("The ritual window has closed.");
    }

    [Test]
    public void NPCDied_CreatesConditionWithTargetId()
    {
        var condition = FailureCondition.NPCDied("grimbold-trader");

        condition.Type.Should().Be(FailureType.NPCDied);
        condition.TargetId.Should().Be("grimbold-trader");
    }

    [Test]
    public void NPCDied_WithNullNpcId_ThrowsArgumentException()
    {
        var act = () => FailureCondition.NPCDied(null!);

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void ItemLost_CreatesConditionWithTargetId()
    {
        var condition = FailureCondition.ItemLost("sacred-artifact");

        condition.Type.Should().Be(FailureType.ItemLost);
        condition.TargetId.Should().Be("sacred-artifact");
    }

    [Test]
    public void ReputationDropped_CreatesConditionWithThreshold()
    {
        var condition = FailureCondition.ReputationDropped("thieves-guild", 50);

        condition.Type.Should().Be(FailureType.ReputationDropped);
        condition.TargetId.Should().Be("thieves-guild");
        condition.Threshold.Should().Be(50);
    }

    [Test]
    public void LeftArea_CreatesConditionWithLocationId()
    {
        var condition = FailureCondition.LeftArea("zone-mountain-pass");

        condition.Type.Should().Be(FailureType.LeftArea);
        condition.TargetId.Should().Be("zone-mountain-pass");
    }

    [Test]
    public void ShouldFail_TimeExpired_ReturnsFalse()
    {
        var condition = FailureCondition.TimeExpired(20);
        var player = CreateTestPlayer();
        var gameState = CreateTestGameState();

        var result = condition.ShouldFail(player, gameState);

        result.Should().BeFalse(); // Time expiration handled by TickTime()
    }
}
```

### 10.2 Quest Entity Time Tests (~8 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class QuestTimeTests
{
    [Test]
    public void SetTimeLimit_WithValidTurns_SetsTimeLimit()
    {
        var quest = CreateActiveQuest();

        quest.SetTimeLimit(20);

        quest.TimeLimit.Should().Be(20);
        quest.TurnsRemaining.Should().Be(20);
        quest.IsTimed.Should().BeTrue();
    }

    [Test]
    public void SetTimeLimit_WithZeroTurns_ThrowsArgumentException()
    {
        var quest = CreateActiveQuest();

        var act = () => quest.SetTimeLimit(0);

        act.Should().Throw<ArgumentException>()
            .WithMessage("*positive*");
    }

    [Test]
    public void SetTimeLimit_WithNegativeTurns_ThrowsArgumentException()
    {
        var quest = CreateActiveQuest();

        var act = () => quest.SetTimeLimit(-5);

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void TickTime_DecrementsRemaining()
    {
        var quest = CreateActiveQuest();
        quest.SetTimeLimit(20);

        quest.TickTime();

        quest.TurnsRemaining.Should().Be(19);
    }

    [Test]
    public void TickTime_WhenExpires_ReturnsTrue()
    {
        var quest = CreateActiveQuest();
        quest.SetTimeLimit(1);

        var result = quest.TickTime();

        result.Should().BeTrue();
        quest.TurnsRemaining.Should().Be(0);
        quest.IsExpired.Should().BeTrue();
    }

    [Test]
    public void TickTime_WhenNotExpired_ReturnsFalse()
    {
        var quest = CreateActiveQuest();
        quest.SetTimeLimit(5);

        var result = quest.TickTime();

        result.Should().BeFalse();
        quest.IsExpired.Should().BeFalse();
    }

    [Test]
    public void TickTime_WhenNotTimed_ReturnsFalse()
    {
        var quest = CreateActiveQuest();

        var result = quest.TickTime();

        result.Should().BeFalse();
    }

    [Test]
    public void IsTimeLow_WhenThreeOrFewerTurns_ReturnsTrue()
    {
        var quest = CreateActiveQuest();
        quest.SetTimeLimit(3);

        quest.IsTimeLow.Should().BeTrue();
    }
}
```

### 10.3 Quest Failure Tests (~5 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class QuestFailureTests
{
    [Test]
    public void Fail_SetsStatusToFailed()
    {
        var quest = CreateActiveQuest();

        quest.Fail("Test failure reason");

        quest.Status.Should().Be(QuestStatus.Failed);
        quest.FailureReason.Should().Be("Test failure reason");
    }

    [Test]
    public void Fail_WhenNotActive_ThrowsInvalidOperationException()
    {
        var quest = CreateCompletedQuest();

        var act = () => quest.Fail("Should fail");

        act.Should().Throw<InvalidOperationException>()
            .WithMessage("*active*");
    }

    [Test]
    public void CheckFailureConditions_WhenConditionMet_ReturnsCondition()
    {
        var quest = CreateActiveQuest();
        quest.AddFailureCondition(FailureCondition.ItemLost("test-item"));

        var player = CreatePlayerWithoutItem("test-item");
        var gameState = CreateTestGameState();

        var result = quest.CheckFailureConditions(player, gameState);

        result.Should().NotBeNull();
        result!.Value.Type.Should().Be(FailureType.ItemLost);
    }

    [Test]
    public void CheckFailureConditions_WhenNoConditionMet_ReturnsNull()
    {
        var quest = CreateActiveQuest();
        quest.AddFailureCondition(FailureCondition.ItemLost("test-item"));

        var player = CreatePlayerWithItem("test-item");
        var gameState = CreateTestGameState();

        var result = quest.CheckFailureConditions(player, gameState);

        result.Should().BeNull();
    }

    [Test]
    public void AddFailureCondition_AddsToCollection()
    {
        var quest = CreateActiveQuest();

        quest.AddFailureCondition(FailureCondition.NPCDied("npc-1"));
        quest.AddFailureCondition(FailureCondition.ItemLost("item-1"));

        quest.FailureConditions.Should().HaveCount(2);
    }
}
```

### 10.4 Player FailedQuests Tests (~4 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class PlayerFailedQuestsTests
{
    [Test]
    public void MoveFailed_MovesQuestToFailedCollection()
    {
        var player = CreateTestPlayer();
        var quest = CreateActiveQuest();
        player.AddQuest(quest);
        quest.Fail("Test failure");

        player.MoveFailed(quest);

        player.ActiveQuests.Should().NotContain(quest);
        player.FailedQuests.Should().Contain(quest);
    }

    [Test]
    public void HasFailedQuest_WhenQuestFailed_ReturnsTrue()
    {
        var player = CreateTestPlayer();
        var quest = CreateActiveQuest("test-quest");
        player.AddQuest(quest);
        quest.Fail("Test failure");
        player.MoveFailed(quest);

        player.HasFailedQuest("test-quest").Should().BeTrue();
    }

    [Test]
    public void HasFailedQuest_WhenQuestNotFailed_ReturnsFalse()
    {
        var player = CreateTestPlayer();

        player.HasFailedQuest("nonexistent-quest").Should().BeFalse();
    }

    [Test]
    public void FailedQuestCount_ReturnsCorrectCount()
    {
        var player = CreateTestPlayer();
        var quest1 = CreateActiveQuest("quest-1");
        var quest2 = CreateActiveQuest("quest-2");
        player.AddQuest(quest1);
        player.AddQuest(quest2);
        quest1.Fail("Failure 1");
        quest2.Fail("Failure 2");
        player.MoveFailed(quest1);
        player.MoveFailed(quest2);

        player.FailedQuestCount.Should().Be(2);
    }
}
```

### 10.5 Test Summary Table

| File | Tests | Coverage |
|------|-------|----------|
| `FailureConditionTests.cs` | ~8 | Factory methods, ShouldFail evaluation |
| `QuestTimeTests.cs` | ~8 | SetTimeLimit, TickTime, IsExpired, IsTimeLow |
| `QuestFailureTests.cs` | ~5 | Fail method, CheckFailureConditions |
| `PlayerFailedQuestsTests.cs` | ~4 | MoveFailed, HasFailedQuest |
| **Total** | **~25** | |

---

## 11. Use Cases

### UC-3.2b-1: Quest Time Expiration

**Actors:** Player, System
**Preconditions:** Player has active timed quest
**Trigger:** End of turn processing

**Main Flow:**
1. System processes end of turn
2. System calls ProcessQuestTimers() for player
3. For each active timed quest:
   a. System calls quest.TickTime()
   b. If returns true (expired):
      - System calls quest.Fail("Time has run out.")
      - System calls player.MoveFailed(quest)
      - System adds to failure results
4. System returns failure results
5. Renderer displays failure notifications

**Postconditions:**
- Quest status is Failed
- Quest is in player.FailedQuests
- Quest is not in player.ActiveQuests

### UC-3.2b-2: NPC Death Failure

**Actors:** Player, NPC, Enemy, System
**Preconditions:** Player has quest with NPCDied failure condition
**Trigger:** Protected NPC is killed

**Main Flow:**
1. Enemy attacks and kills protected NPC
2. GameState records NPC death
3. End of turn processing begins
4. System calls ProcessQuestTimers()
5. System evaluates quest.CheckFailureConditions(player, gameState)
6. NPCDied condition returns ShouldFail = true
7. System fails quest with condition's message
8. System moves quest to failed collection
9. Renderer displays failure notification

**Postconditions:**
- Quest status is Failed
- Quest shows NPC death as failure reason

### UC-3.2b-3: Time Warning Display

**Actors:** Player, System
**Preconditions:** Player has timed quest with 3 or fewer turns remaining
**Trigger:** End of turn processing

**Main Flow:**
1. System processes quest timers
2. System detects quest.IsTimeLow is true
3. System creates TimeWarningDto
4. Renderer displays time warning
5. Player sees warning message

**Postconditions:**
- Warning is displayed
- Player is informed of urgency

---

## 12. Acceptance Criteria

### AC-3.2b-1: Time Limit Tracking
- [ ] Quest.TimeLimit stores turn-based time constraints
- [ ] Quest.TurnsRemaining decrements each turn via TickTime()
- [ ] Quest.IsTimed returns true when TimeLimit is set
- [ ] Quest.IsExpired returns true when TurnsRemaining reaches 0

### AC-3.2b-2: Automatic Time Failure
- [ ] Quest fails automatically when time expires
- [ ] Quest.Fail() sets status to Failed
- [ ] Quest.FailureReason contains "Time has run out."
- [ ] ProcessQuestTimers() triggers time expiration

### AC-3.2b-3: Failure Conditions
- [ ] FailureCondition.NPCDied triggers when NPC is dead
- [ ] FailureCondition.ItemLost triggers when item not in inventory
- [ ] FailureCondition.ReputationDropped triggers below threshold
- [ ] FailureCondition.LeftArea triggers when player leaves location
- [ ] Multiple failure conditions can be combined per quest

### AC-3.2b-4: Failed Quest Tracking
- [ ] Player.FailedQuests contains failed quests
- [ ] Player.MoveFailed() moves quest from active to failed
- [ ] Player.HasFailedQuest() correctly identifies failed quests
- [ ] Failed quests persist in player state

### AC-3.2b-5: User Interface
- [ ] Timed quests show remaining turns in journal
- [ ] Time warnings display at 3 or fewer turns remaining
- [ ] Failure notifications display prominently with reason
- [ ] Failure conditions display in quest detail view

### AC-3.2b-6: Unit Tests
- [ ] ~25 unit tests pass covering all failure mechanics

---

## 13. Deliverable Checklist

### Domain Layer
- [ ] `FailureType.cs` - Enum for failure condition types
- [ ] `FailureCondition.cs` - Value object for failure conditions
- [ ] `QuestFailureResult.cs` - Value object for failure results
- [ ] Quest entity updates (TimeLimit, TurnsRemaining, FailureConditions, Fail methods)
- [ ] Player entity updates (FailedQuests, MoveFailed, HasFailedQuest)

### Application Layer
- [ ] IQuestService updates (ProcessQuestTimers, FailQuest, GetTimedQuests)
- [ ] QuestService implementation updates
- [ ] `QuestFailedDto.cs` - DTO for failure display
- [ ] `TimeWarningDto.cs` - DTO for time warnings
- [ ] `FailureConditionDto.cs` - DTO for condition display
- [ ] QuestDetailDto updates (time and failure fields)
- [ ] `FailureConditionConfigDto.cs` - Configuration DTO

### Infrastructure Layer
- [ ] quests.json updates with failure conditions
- [ ] quests.schema.json updates for failure condition validation
- [ ] Configuration loader updates for failure conditions

### Presentation Layer
- [ ] IGameRenderer updates for failure notifications
- [ ] Time warning rendering
- [ ] Failed quest journal section

### Tests
- [ ] `FailureConditionTests.cs` (~8 tests)
- [ ] `QuestTimeTests.cs` (~8 tests)
- [ ] `QuestFailureTests.cs` (~5 tests)
- [ ] `PlayerFailedQuestsTests.cs` (~4 tests)

### Documentation
- [ ] XML documentation on all new types
- [ ] Updated configuration schema documentation

---

## 14. Dependencies

### From v0.3.2a (Quest Chains)
| Component | Purpose for v0.3.2b |
|-----------|---------------------|
| Quest.ChainId | Check if failed quest was in chain |
| Quest.IsInChain | Display chain context in failure notification |
| QuestChainService | Potential chain failure handling (future) |

### From v0.3.1 (Quest Rewards & NPCs)
| Component | Purpose for v0.3.2b |
|-----------|---------------------|
| Quest entity | Base for time/failure extensions |
| Player.ActiveQuests | Source for quest timer processing |
| QuestStatus enum | Includes Failed status |
| QuestService | Base for failure detection |

### From v0.3.0 (Core Quest System)
| Component | Purpose for v0.3.2b |
|-----------|---------------------|
| QuestObjective | Condition evaluation context |
| Player.Inventory | ItemLost condition check |
| GameState | NPC death, entity tracking |

---

## 15. Future Considerations

### Deferred Features (Not in v0.3.2b Scope)
- **Escort Quest Mechanics** - NPC following behavior (future version)
- **Chain Failure Propagation** - Failing one quest fails entire chain (design decision needed)
- **Failure Recovery** - Restarting failed quests (v0.3.2c or later)
- **Partial Failure** - Failing specific objectives vs entire quest (complexity consideration)

### v0.3.2c Integration Points
- Quest abandonment may interact with failure (abandoned vs failed states)
- Quest categories may affect failure behavior (daily quests auto-reset)
- Quest filters should include failed quest filtering

### Extension Points
- Custom failure condition type for scripted scenarios
- Failure consequence system (reputation loss, item loss on failure)
- Grace period before failure (extra chance mechanics)
- Failure prevention items/abilities

### Dependency Tree

```
v0.3.2b Failure Conditions
    │
    ├── REQUIRES from v0.3.2a
    │   ├── Quest.ChainId (chain context)
    │   └── Quest.IsInChain (chain membership)
    │
    ├── REQUIRES from v0.3.1
    │   ├── Quest entity
    │   ├── Player.ActiveQuests
    │   └── QuestService
    │
    └── PROVIDES to v0.3.2c
        ├── Quest.Status = Failed
        ├── Player.FailedQuests
        ├── ProcessQuestTimers() method
        └── FailureCondition pattern
```

---

*This design specification provides a comprehensive implementation guide for v0.3.2b Failure Conditions. The failure system enables time-sensitive gameplay and meaningful quest consequences through turn-based time tracking and multiple failure condition types.*
