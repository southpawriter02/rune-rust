# Changelog: v0.3.2 - Rest & Recovery System (The Campfire, The Watch, The Dawn)

**Versions:** v0.3.2a through v0.3.2c
**Release Dates:** December 20, 2025

## Table of Contents

- [Overview](#overview)
- [Part A: The Campfire (Core Logic)](#part-a-the-campfire-core-logic)
  - [Summary](#summary)
  - [Feature: Rest System](#feature-rest-system)
  - [New Entities & Enums](#new-entities--enums)
  - [Entity Modifications](#entity-modifications)
  - [Service Layer](#service-layer)
  - [Repository Layer](#repository-layer)
  - [Loot Table Updates](#loot-table-updates)
  - [Database Migration](#database-migration)
  - [Unit Tests (20 tests)](#unit-tests-20-tests)
  - [Files Created](#files-created)
  - [Files Modified](#files-modified)
  - [Logging Matrix](#logging-matrix)
  - [Dependency Injection Registration](#dependency-injection-registration)
  - [Directory Structure After v0.3.2a](#directory-structure-after-v032a)
  - [Test Architecture Summary](#test-architecture-summary)
  - [Build Verification](#build-verification)
  - [Deferred to v0.3.2b (The Watch)](#deferred-to-v032b-the-watch)
  - [Deferred to v0.3.2c (The Dawn)](#deferred-to-v032c-the-dawn)
  - [Migration Instructions](#migration-instructions)
  - [API Usage Examples](#api-usage-examples)
  - [Dependencies](#dependencies)
- [Part B: The Watch (Ambush Mechanics)](#part-b-the-watch-ambush-mechanics)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details)
  - [Logging Matrix](#logging-matrix-1)
  - [Test Coverage](#test-coverage)
  - [Dependency Injection Registration](#dependency-injection-registration-1)
  - [Verification Results](#verification-results)
  - [Directory Structure After v0.3.2b](#directory-structure-after-v032b)
  - [Running Tests](#running-tests)
  - [API Usage Examples](#api-usage-examples-1)
  - [Technical Notes](#technical-notes)
  - [Design Decisions](#design-decisions)
  - [Known Limitations](#known-limitations)
  - [Next Steps (Deferred to v0.3.2c: The Dawn)](#next-steps-deferred-to-v032c-the-dawn)
  - [Dependencies](#dependencies-1)
  - [Migration Notes](#migration-notes)
  - [Performance Considerations](#performance-considerations)
  - [Changelog Metadata](#changelog-metadata)
- [Part C: The Dawn (Integration)](#part-c-the-dawn-integration)
  - [Summary](#summary-2)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-2)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Logging Matrix](#logging-matrix-2)
  - [Test Coverage](#test-coverage-1)
  - [DI Registration](#di-registration)
  - [Verification Results](#verification-results-1)
  - [Directory Structure After Release](#directory-structure-after-release)
  - [Running Tests](#running-tests-1)
  - [Next Steps (v0.3.3)](#next-steps-v033)

---

## Overview

Version 0.3.2 introduces the complete Rest & Recovery system to Rune & Rust, spanning three sub-releases that implement core mechanics (v0.3.2a), ambush risk calculations (v0.3.2b), and player-facing command integration (v0.3.2c). This milestone establishes resource management through supply consumption, probabilistic encounter spawning based on danger levels, and rich terminal UI feedback using Spectre.Console.

**Combined Features:**
- Two rest types (Sanctuary and Wilderness) with distinct recovery formulas
- Tag-based supply system for Rations and Water
- Ambush mechanics driven by Room.DangerLevel with Wits-based mitigation
- Budget-based enemy encounter generation with template prioritization
- Exhausted and Disoriented status effects
- Room feature system enabling Sanctuary rest at Runic Anchors
- Complete command integration (rest/camp/sleep) with phase validation
- 45 new unit tests (1753 → 1778 → 1788 total passing tests)

---

## Part A: The Campfire (Core Logic)

**Release Date:** December 20, 2025
**Total Tests:** 1753 (all passing)

### Summary

Version 0.3.2a implements the **core resting mechanics** for Rune & Rust. This is the first sub-version of the Rest & Recovery milestone (v0.3.2), establishing the mathematical foundation for resource management and recovery formulas.

Key additions:
- **RestService**: Handles rest transactions with supply consumption and recovery calculations
- **Two Rest Types**: Sanctuary (full recovery, safe) vs Wilderness (partial recovery, resource-dependent)
- **Supply System**: Tag-based item identification for Rations and Water
- **Exhausted Status**: New debuff applied when resting without supplies
- **New Items**: Waterskin variants added to loot tables

---

### Feature: Rest System

#### Rest Types

| Type | Supplies Required | HP Recovery | Stamina Recovery | Stress Recovery |
|------|-------------------|-------------|------------------|-----------------|
| **Sanctuary** | None | Full (MaxHP) | Full (MaxStamina) | Full (to 0) |
| **Wilderness** | Ration + Water | Partial (formula) | Full | Partial (formula) |
| **Wilderness (No Supplies)** | N/A | Halved | Halved | None |

#### Recovery Formulas (Wilderness)

```
HP Recovery     = 10 + (Sturdiness × 2)
Stress Recovery = Will × 5
Stamina         = MaxStamina (full)

If Exhausted:
  HP Recovery   = (10 + (Sturdiness × 2)) / 2
  Stamina       = MaxStamina / 2
  Stress        = 0 (no recovery)
```

#### Supply Consumption

Wilderness rest requires both:
- **1× Ration-tagged item** (e.g., Field Rations, Dvergr Iron-Bread)
- **1× Water-tagged item** (e.g., Waterskin, Dvergr Flask)

If either is missing:
- `[Exhausted]` status effect is applied
- Recovery values are halved
- No stress recovery occurs

---

### New Entities & Enums

#### RestType Enum

```csharp
public enum RestType
{
    Wilderness = 0,  // Requires supplies, partial heal, ambush risk (future)
    Sanctuary = 1    // Safe, full heal, no supplies needed
}
```

#### RestResult Record

```csharp
public record RestResult(
    int HpRecovered,
    int StaminaRecovered,
    int StressRecovered,
    bool SuppliesConsumed,
    bool IsExhausted,
    int TimeAdvancedMinutes = 480
);
```

#### StatusEffectType.Exhausted

Added to the debuffs section (value = 5):

```csharp
/// <summary>
/// Out-of-combat debuff from resting without supplies.
/// Halves all recovery from rest. Prevents running.
/// Cured by resting at a Sanctuary or consuming supplies.
/// </summary>
Exhausted = 5
```

---

### Entity Modifications

#### Item.Tags Property

New property for categorization and behavior filtering:

```csharp
/// <summary>
/// Tags for categorization and behavior filtering (e.g., "Ration", "Water").
/// Stored as JSONB in PostgreSQL.
/// </summary>
public List<string> Tags { get; set; } = new();

/// <summary>
/// Checks if this item has the specified tag (case-insensitive).
/// </summary>
public bool HasTag(string tag) =>
    Tags.Any(t => t.Equals(tag, StringComparison.OrdinalIgnoreCase));
```

#### Character.ActiveStatusEffects Property

New property for persistent out-of-combat status effects:

```csharp
/// <summary>
/// Persistent status effects active outside of combat.
/// Combat status effects are tracked separately on Combatant.
/// </summary>
public List<StatusEffectType> ActiveStatusEffects { get; set; } = new();

public bool HasStatusEffect(StatusEffectType effect);
public void AddStatusEffect(StatusEffectType effect);
public void RemoveStatusEffect(StatusEffectType effect);
```

---

### Service Layer

#### IRestService Interface

```csharp
public interface IRestService
{
    /// <summary>
    /// Performs a rest action, consuming supplies and applying recovery.
    /// </summary>
    Task<RestResult> PerformRestAsync(Character character, RestType type);

    /// <summary>
    /// Checks if the character has required supplies for wilderness rest.
    /// </summary>
    Task<bool> HasRequiredSuppliesAsync(Character character);
}
```

#### RestService Implementation

**Dependencies:**
- `IInventoryService` - For supply check and item removal
- `ILogger<RestService>` - For traceability

**Key Logic:**

```csharp
public async Task<RestResult> PerformRestAsync(Character character, RestType type)
{
    if (type == RestType.Sanctuary)
    {
        // Full recovery: HP=Max, Stamina=Max, Stress=0
        // Cures Exhausted status
        return await PerformSanctuaryRestAsync(character);
    }
    else
    {
        // Check supplies, consume or apply Exhausted
        // Apply partial recovery based on attributes
        return await PerformWildernessRestAsync(character);
    }
}
```

---

### Repository Layer

#### IInventoryRepository.FindByTagAsync

New method for tag-based item search:

```csharp
/// <summary>
/// Finds the first item in inventory that has the specified tag.
/// Uses case-insensitive matching.
/// </summary>
Task<InventoryItem?> FindByTagAsync(Guid characterId, string tag);
```

#### InventoryRepository Implementation

```csharp
public async Task<InventoryItem?> FindByTagAsync(Guid characterId, string tag)
{
    var normalizedTag = tag.Trim().ToLowerInvariant();

    // Load items and filter in memory (JSONB array queries are complex in EF Core)
    var items = await _dbSet
        .Include(ii => ii.Item)
        .Where(ii => ii.CharacterId == characterId)
        .ToListAsync();

    return items.FirstOrDefault(ii =>
        ii.Item.Tags.Any(t => t.Equals(normalizedTag, StringComparison.OrdinalIgnoreCase)));
}
```

#### IInventoryService.FindItemByTagAsync

```csharp
/// <summary>
/// Finds an item in inventory by tag (e.g., "Ration", "Water").
/// </summary>
Task<InventoryItem?> FindItemByTagAsync(Character character, string tag);
```

---

### Loot Table Updates

#### Consumable Template Enhancement

Added optional `Tags` parameter:

```csharp
public record ConsumableTemplate(
    string Name,
    string Description,
    string DetailedDescription,
    int Weight,
    int Value,
    List<string>? Tags = null  // NEW: Optional categorization tags
);
```

#### Ration Tags Added

| Item | Quality | Tags |
|------|---------|------|
| Questionable Rations | JuryRigged | `["Ration"]` |
| Field Rations | Scavenged | `["Ration"]` |
| Dvergr Iron-Bread | ClanForged | `["Ration"]` |

#### New Waterskin Items

| Item | Quality | Tags | Weight | Value |
|------|---------|------|--------|-------|
| Cracked Waterskin | JuryRigged | `["Water"]` | 200g | 4 Scrip |
| Waterskin | Scavenged | `["Water"]` | 250g | 10 Scrip |
| Dvergr Flask | ClanForged | `["Water"]` | 300g | 30 Scrip |

**Item Descriptions (AAM-VOICE compliant):**

```
Cracked Waterskin (JuryRigged)
"A patched container that leaks at the seams."
"Several repairs suggest long use. Contents remain drinkable, if not appetizing."

Waterskin (Scavenged)
"A leather container for carrying water."
"The stitching holds well. Sufficient for a day's hydration in the wastes."

Dvergr Flask (ClanForged)
"A metal-bound container of superior construction."
"The interior coating prevents contamination. Water stays fresh for extended periods."
```

---

### Database Migration

#### Migration: AddRestSystemColumns

```csharp
public partial class AddRestSystemColumns : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<string>(
            name: "Tags",
            table: "Items",
            type: "jsonb",
            nullable: false,
            defaultValue: "[]");

        migrationBuilder.AddColumn<string>(
            name: "ActiveStatusEffects",
            table: "Characters",
            type: "jsonb",
            nullable: false,
            defaultValue: "[]");
    }
}
```

#### DbContext Configuration

```csharp
// Item.Tags (v0.3.2a)
entity.Property(i => i.Tags)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<List<string>>(v, (JsonSerializerOptions?)null) ?? new List<string>()
    )
    .IsRequired();

// Character.ActiveStatusEffects (v0.3.2a)
entity.Property(c => c.ActiveStatusEffects)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<List<StatusEffectType>>(v, (JsonSerializerOptions?)null) ?? new List<StatusEffectType>()
    )
    .IsRequired();
```

---

### Unit Tests (20 tests)

#### RestServiceTests

| Category | Test | Validates |
|----------|------|-----------|
| **Sanctuary** | `Sanctuary_FullRecovery_RestoresAllStats` | HP/Stamina to max, stress to 0 |
| **Sanctuary** | `Sanctuary_RemovesExhausted_WhenPresent` | Cures Exhausted status |
| **Sanctuary** | `Sanctuary_DoesNotConsumeSupplies` | No inventory changes |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_ConsumesRationAndWater` | 1 of each consumed |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_HpRecovery_UsesSturdiness` | 10 + (STU × 2) formula |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_HpRecovery_CapsAtMaxHp` | No overheal |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_StressRecovery_UsesWill` | Will × 5 formula |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_StaminaRecovery_Full` | Stamina = Max |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_AppliesExhausted` | Status applied |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_HalvesHpRecovery` | Recovery / 2 |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_HalvesStaminaRecovery` | MaxStamina / 2 |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_NoStressRecovery` | Stress unchanged |
| **Wilderness (Partial)** | `Wilderness_MissingRationOnly_AppliesExhausted` | Water alone insufficient |
| **Wilderness (Partial)** | `Wilderness_MissingWaterOnly_AppliesExhausted` | Ration alone insufficient |
| **HasSupplies** | `HasRequiredSupplies_BothPresent_ReturnsTrue` | Validation passes |
| **HasSupplies** | `HasRequiredSupplies_MissingRation_ReturnsFalse` | Validation fails |
| **HasSupplies** | `HasRequiredSupplies_MissingWater_ReturnsFalse` | Validation fails |
| **Edge Cases** | `Wilderness_HighSturdiness_LargeHpRecovery` | STU=10 → 30 HP |
| **Edge Cases** | `Wilderness_StressAtZero_StaysAtZero` | No negative stress |
| **Edge Cases** | `Wilderness_AlreadyExhausted_StillAppliesPenalties` | Pre-existing status honored |

---

### Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/RestType.cs` | Rest type enum |
| `RuneAndRust.Core/Models/RestResult.cs` | Result record |
| `RuneAndRust.Core/Interfaces/IRestService.cs` | Service interface |
| `RuneAndRust.Engine/Services/RestService.cs` | Service implementation |
| `RuneAndRust.Tests/Engine/RestServiceTests.cs` | Unit tests (20) |
| `RuneAndRust.Persistence/Migrations/20251221014933_AddRestSystemColumns.cs` | DB migration |
| `docs/changelogs/v0.3.2a.md` | This changelog |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/StatusEffectType.cs` | Added `Exhausted = 5` |
| `RuneAndRust.Core/Entities/Item.cs` | Added `Tags` property and `HasTag()` method |
| `RuneAndRust.Core/Entities/Character.cs` | Added `ActiveStatusEffects` with helper methods |
| `RuneAndRust.Core/Interfaces/IInventoryRepository.cs` | Added `FindByTagAsync` method |
| `RuneAndRust.Persistence/Repositories/InventoryRepository.cs` | Implemented `FindByTagAsync` |
| `RuneAndRust.Core/Interfaces/IInventoryService.cs` | Added `FindItemByTagAsync` method |
| `RuneAndRust.Engine/Services/InventoryService.cs` | Implemented `FindItemByTagAsync` |
| `RuneAndRust.Engine/Services/LootTables.cs` | Added tags to rations, new Waterskin items |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | JSONB config for new columns |
| `RuneAndRust.Terminal/Program.cs` | Registered `IInventoryRepository`, `IRestService` |

---

### Logging Matrix

| System | Event | Level | Message Template |
|--------|-------|-------|------------------|
| Rest | Start | Info | `"{Name} initiating {Type} rest."` |
| Rest | Supplies Check | Debug | `"Supply check: Ration={HasRation}, Water={HasWater}."` |
| Rest | Supplies Consumed | Debug | `"Consumed 1x {RationName}, 1x {WaterName}."` |
| Rest | Exhaustion Applied | Warning | `"{Name} rests without supplies. Applying [Exhausted]."` |
| Rest | Exhaustion Cured | Info | `"{Name} cured of Exhausted at Sanctuary."` |
| Rest | Recovery | Info | `"Rest complete. HP+{HP}, Stress-{Stress}. Supplies used: {Used}."` |
| Rest | Sanctuary | Info | `"{Name} fully restored at Sanctuary."` |
| Inventory | Tag Search | Debug | `"Searching for item with tag '{Tag}' in {CharacterName}'s inventory"` |
| Inventory | Tag Found | Debug | `"Found item '{ItemName}' with tag '{Tag}'"` |
| Inventory | Tag Not Found | Debug | `"No item with tag '{Tag}' found in inventory"` |

---

### Dependency Injection Registration

```csharp
// Register Inventory Services
services.AddScoped<IInventoryRepository, InventoryRepository>();
services.AddScoped<IInventoryService, InventoryService>();

// Register Rest Services (v0.3.2a)
services.AddScoped<IRestService, RestService>();
```

---

### Directory Structure After v0.3.2a

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   ├── Character.cs                    [MODIFIED - ActiveStatusEffects]
│   │   └── Item.cs                         [MODIFIED - Tags]
│   ├── Enums/
│   │   ├── RestType.cs                     [NEW]
│   │   └── StatusEffectType.cs             [MODIFIED - Exhausted]
│   ├── Interfaces/
│   │   ├── IInventoryRepository.cs         [MODIFIED - FindByTagAsync]
│   │   ├── IInventoryService.cs            [MODIFIED - FindItemByTagAsync]
│   │   └── IRestService.cs                 [NEW]
│   └── Models/
│       └── RestResult.cs                   [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── InventoryService.cs             [MODIFIED - FindItemByTagAsync]
│       ├── LootTables.cs                   [MODIFIED - Tags, Waterskins]
│       └── RestService.cs                  [NEW]
├── RuneAndRust.Persistence/
│   ├── Data/
│   │   └── RuneAndRustDbContext.cs         [MODIFIED - JSONB configs]
│   ├── Migrations/
│   │   └── 20251221014933_AddRestSystemColumns.cs [NEW]
│   └── Repositories/
│       └── InventoryRepository.cs          [MODIFIED - FindByTagAsync]
├── RuneAndRust.Terminal/
│   └── Program.cs                          [MODIFIED - DI registrations]
├── RuneAndRust.Tests/
│   └── Engine/
│       └── RestServiceTests.cs             [NEW - 20 tests]
└── docs/
    └── changelogs/
        └── v0.3.2a.md                      [NEW]
```

---

### Test Architecture Summary

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1587 | Mocked dependencies |
| Integration Tests (InMemory) | 137 | EF Core InMemory provider |
| Integration Tests (PostgreSQL) | 29 | Real PostgreSQL via Docker |
| **Total** | **1753** | All passing |

---

### Build Verification

```
Build succeeded.
    0 Error(s)
    66 Warning(s) (pre-existing)

Test Results:
  Passed: 1753
  Failed: 0
  Skipped: 0

New Tests Added: 20 (RestServiceTests)
```

---

### Deferred to v0.3.2b (The Watch)

- Ambush check logic and Camp Craft skill integration
- Risk calculation based on biome danger level
- Encounter generation with "Ambush" tag

### Deferred to v0.3.2c (The Dawn)

- `rest` and `camp` command wiring in CommandParser
- RestScreenRenderer using Spectre.Console
- Sanctuary validation (Room feature check)
- Time advancement integration

---

### Migration Instructions

#### Apply Database Migration

```bash
# Ensure Docker container is running
docker-compose up -d

# Apply migration
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
```

#### Verify New Columns

```sql
-- Check Items table
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Items' AND column_name = 'Tags';

-- Check Characters table
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Characters' AND column_name = 'ActiveStatusEffects';
```

---

### API Usage Examples

#### Performing a Rest

```csharp
// Inject IRestService
public class GameService
{
    private readonly IRestService _restService;

    public async Task RestAtCampAsync(Character character)
    {
        // Check supplies first
        if (!await _restService.HasRequiredSuppliesAsync(character))
        {
            Console.WriteLine("Warning: You have no supplies. Resting will apply Exhausted.");
        }

        var result = await _restService.PerformRestAsync(character, RestType.Wilderness);

        Console.WriteLine($"Rest complete: HP+{result.HpRecovered}, Stress-{result.StressRecovered}");

        if (result.IsExhausted)
            Console.WriteLine("You are Exhausted from lack of supplies.");
    }

    public async Task RestAtSanctuaryAsync(Character character)
    {
        var result = await _restService.PerformRestAsync(character, RestType.Sanctuary);
        Console.WriteLine("You are fully restored at the Sanctuary.");
    }
}
```

#### Finding Items by Tag

```csharp
// Find any ration in inventory
var ration = await _inventoryService.FindItemByTagAsync(character, "Ration");
if (ration != null)
{
    Console.WriteLine($"Found ration: {ration.Item.Name}");
}
```

---

### Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Serilog | 3.x | Structured logging |
| FluentAssertions | 8.x | Test assertions |
| xUnit | 2.9.x | Test framework |
| Moq | 4.x | Mocking framework |

---

## Part B: The Watch (Ambush Mechanics)

**Release Date:** December 20, 2025
**Total Tests:** 1778 (all passing)

### Summary

Version 0.3.2b extends the Rest & Recovery system with ambush mechanics for wilderness rest. This release introduces risk-based encounter spawning driven by Room.DangerLevel, with character Wits providing mitigation through probabilistic dice pools. The ambush system integrates seamlessly with the existing RestService, consuming supplies even on failed rest attempts and applying the Disoriented status effect when caught off-guard.

Key additions:
- **AmbushService**: Calculates ambush probability using Room.DangerLevel and character Wits mitigation
- **Risk Calculation**: Base risk percentages (Safe=0%, Unstable=15%, Hostile=30%, Lethal=50%)
- **Wits Mitigation**: Dice pool rolls reduce risk by 5% per success, with 5% minimum floor
- **Encounter Generation**: Budget-based enemy selection prioritizing fast/stealthy ambush templates
- **Disoriented Status**: Applied to ambushed characters representing combat disadvantage
- **Supply Loss**: Supplies consumed even when rest is interrupted by ambush

This release touches the Engine Layer (service logic), Core Layer (models and interfaces), and Test Layer (25 new tests across 2 test classes).

---

### New Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/AmbushResult.cs` | Record containing ambush check results with risk percentages, roll values, and optional encounter definition |
| `RuneAndRust.Core/Models/EncounterDefinition.cs` | Record defining combat encounter to spawn with template IDs, budget, and ambush flag |
| `RuneAndRust.Core/Interfaces/IAmbushService.cs` | Service interface for ambush risk calculation and encounter generation |

#### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/AmbushService.cs` | Service implementation for ambush mechanics with dice-based mitigation and budget-based encounter spawning |

#### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/AmbushServiceTests.cs` | Unit tests (17) covering ambush risk calculation, mitigation, safe zones, minimum floor, triggers, and encounter generation |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Models/RestResult.cs` | Added `WasAmbushed` bool field (default false) and `AmbushDetails` nullable field for ambush result data |
| `RuneAndRust.Core/Interfaces/IRestService.cs` | Added overload `PerformRestAsync(Character, RestType, Room)` for ambush-aware wilderness rest |
| `RuneAndRust.Engine/Services/RestService.cs` | Integrated `IAmbushService` dependency, added Room overload, implemented ambush check before recovery, added `PerformAmbushedRestAsync` private method applying Disoriented status |
| `RuneAndRust.Terminal/Program.cs` | Registered `IAmbushService` in DI container as scoped service, updated version display to v0.3.2b |
| `RuneAndRust.Tests/Engine/RestServiceTests.cs` | Added 8 ambush integration tests (total 28 tests in file) |

---

### Code Implementation Details

#### AmbushResult Record

```csharp
public record AmbushResult(
    bool IsAmbush,                         // True if ambush was triggered
    string Message,                         // AAM-VOICE compliant narrative message
    int BaseRiskPercent,                    // Initial risk based on DangerLevel
    int MitigationPercent,                  // Risk reduction from Wits roll
    int FinalRiskPercent,                   // Final risk after mitigation (minimum 5% in dangerous zones)
    int RollValue,                          // The d100 roll result (1-100)
    int MitigationSuccesses,                // Number of successes on the Wits roll
    EncounterDefinition? Encounter = null   // Optional encounter if ambush triggered
);
```

**Purpose**: Captures complete ambush calculation state for UI display and combat initialization.

#### EncounterDefinition Record

```csharp
public record EncounterDefinition(
    IReadOnlyList<string> TemplateIds,    // List of enemy template IDs to spawn
    float Budget,                          // The encounter budget used for scaling
    bool IsAmbush,                         // Whether this is an ambush encounter (affects initiative)
    string EncounterType = "Ambush"        // Type classification for logging and loot tables
);
```

**Purpose**: Defines combat encounter structure. Future-proofed for random encounter generation beyond ambushes.

#### IAmbushService Interface

**Method Signatures:**
```csharp
Task<AmbushResult> CalculateAmbushAsync(Character character, Room room);
EncounterDefinition GenerateAmbushEncounter(Room room, int partyLevel = 1);
int GetBaseRisk(DangerLevel dangerLevel);
```

**Responsibilities:**
- Calculate ambush risk using Room.DangerLevel and character Wits
- Generate budget-appropriate enemy groups for ambush encounters
- Provide base risk lookup for danger level tiers

#### AmbushService Implementation

**Constants:**
```csharp
MitigationPerSuccess = 5      // 5% risk reduction per Wits success
MinimumRiskFloor = 5          // 5% minimum in dangerous zones (DangerLevel > Safe)
AmbushBudgetMultiplier = 0.8f // 80% of standard encounter budget
BaseEncounterBudget = 100f    // Base budget before level scaling
```

**Enemy Template Costs:**
```csharp
"bst_vargr_01" => 40f    // Ash-Vargr (GlassCannon, fast)
"mec_serv_01" => 25f     // Utility Servitor (Swarm, cheap)
"hum_raider_01" => 35f   // Rust-Clan Scav (Support, opportunistic)
```

**Base Risk by DangerLevel:**
- **Safe**: 0% (no ambush possible)
- **Unstable**: 15%
- **Hostile**: 30%
- **Lethal**: 50%

**Key Behaviors:**

1. **CalculateAmbushAsync(Character, Room)**:
   - Returns safe result immediately if DangerLevel.Safe (no dice rolls)
   - Rolls Wits dice pool for mitigation (successes × 5% reduction)
   - Applies minimum 5% floor in dangerous zones after mitigation
   - Rolls d100 against final risk (ambush if roll ≤ risk)
   - Generates encounter if ambush triggered

2. **GenerateAmbushEncounter(Room, int partyLevel)**:
   - Calculates budget: `100 × (1 + (level-1) × 0.1) × 0.8`
   - Prioritizes Ash-Vargr (cost 40) for ambush flavor
   - Fills remaining budget with Utility Servitors (cost 25)
   - Guarantees at least 1 enemy if budget too low

3. **GetBaseRisk(DangerLevel)**:
   - Simple switch expression mapping DangerLevel enum to percentages
   - Returns 15% for unknown DangerLevel values (default to Unstable)

#### RestService Integration

**New Dependency:**
```csharp
private readonly IAmbushService _ambushService;
```

**New Overload:**
```csharp
public async Task<RestResult> PerformRestAsync(Character character, RestType type, Room room)
{
    // Sanctuary rest - skip ambush check
    if (type == RestType.Sanctuary)
        return await PerformSanctuaryRestAsync(character);

    // Wilderness rest - check ambush first
    var ambushResult = await _ambushService.CalculateAmbushAsync(character, room);

    if (ambushResult.IsAmbush)
        return await PerformAmbushedRestAsync(character, ambushResult);

    // No ambush - normal recovery with ambush details attached
    var restResult = await PerformWildernessRestAsync(character);
    return restResult with { AmbushDetails = ambushResult };
}
```

**PerformAmbushedRestAsync(Character, AmbushResult) Behaviors:**
- Checks for supplies (Ration + Water)
- Consumes supplies if present (wasted/scattered during ambush)
- Applies `StatusEffectType.Disoriented` to character
- Returns RestResult with zero recovery (HP, Stamina, Stress all 0)
- Sets `WasAmbushed = true` and attaches `AmbushDetails`

---

### Logging Matrix

#### AmbushService Logs

| Event | Level | Template |
|-------|-------|----------|
| Ambush calculation start | Information | `"[Rest] Calculating ambush risk for {Character} in {Room} (DangerLevel: {Danger})"` |
| Safe zone bypass | Information | `"[Rest] Base Risk: 0% (Safe zone). No ambush possible."` |
| Risk calculation result | Information | `"[Rest] Base Risk: {Base}%, Mitigation: -{Mit}% (Successes: {S}), Final: {Final}%"` |
| Ambush roll result | Information | `"[Rest] Ambush Roll: {Roll} vs {Risk}. Result: {IsAmbush}"` |
| Ambush triggered | Warning | `"[Combat] Ambush triggered! Spawning {Count} enemies."` |
| Encounter generation start | Debug | `"[Encounter] Generating ambush: Budget={Budget:F0}, Biome={Biome}"` |
| Template selection complete | Debug | `"[Encounter] Selected {Count} enemies: [{Templates}]"` |

#### RestService Logs (Ambush Integration)

| Event | Level | Template |
|-------|-------|----------|
| Rest with room context | Information | `"{Name} initiating {Type} rest in {Room}."` |
| Ambush interruption | Warning | `"{Name} was ambushed during rest!"` |
| Supplies lost in ambush | Debug | `"Supplies lost in ambush: 1x {RationName}, 1x {WaterName}."` |
| Disoriented applied | Information | `"{Name} is [Disoriented] from the ambush."` |

---

### Test Coverage

#### Summary

```
AmbushServiceTests: 17 tests
RestServiceTests: 28 tests (8 new, 20 from v0.3.2a)
Total New Tests: 25
Duration: 52ms (AmbushServiceTests), 71ms (RestServiceTests)
All Passed: 1778/1778
```

#### AmbushServiceTests (17 tests)

##### GetBaseRisk Tests (4 tests)

| Test Name | Description |
|-----------|-------------|
| `GetBaseRisk_SafeZone_ReturnsZero` | Validates DangerLevel.Safe returns 0% risk |
| `GetBaseRisk_UnstableZone_ReturnsFifteen` | Validates DangerLevel.Unstable returns 15% risk |
| `GetBaseRisk_HostileZone_ReturnsThirty` | Validates DangerLevel.Hostile returns 30% risk |
| `GetBaseRisk_LethalZone_ReturnsFifty` | Validates DangerLevel.Lethal returns 50% risk |

##### Safe Zone Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `CalculateAmbush_SafeZone_AlwaysReturnsSafe` | Validates safe zones always return IsAmbush=false with 0% risk |
| `CalculateAmbush_SafeZone_NoRollPerformed` | Verifies no dice rolls occur in safe zones (performance optimization) |

##### Mitigation Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `CalculateAmbush_HighWits_ReducesRisk` | Validates Wits 8 rolling 4 successes reduces Hostile 30% to 10% (20% mitigation) |
| `CalculateAmbush_SuccessfulMitigation_AppliesFivePercentPerSuccess` | Validates 3 successes = 15% mitigation formula (3 × 5%) |

##### Minimum Risk Floor Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `CalculateAmbush_ExcessiveMitigation_ClampsToFivePercent` | Validates 8 successes (40% mitigation) on Unstable 15% clamps to 5% floor |
| `CalculateAmbush_DangerousZone_NeverBelowFivePercent` | Validates Lethal 50% with 10 successes (50% mitigation) clamps to 5% floor |

##### Ambush Trigger Tests (3 tests)

| Test Name | Description |
|-----------|-------------|
| `CalculateAmbush_RollBelowRisk_TriggersAmbush` | Validates d100 roll of 15 triggers ambush against 30% risk |
| `CalculateAmbush_RollAboveRisk_ReturnsSafe` | Validates d100 roll of 50 does not trigger ambush against 30% risk |
| `CalculateAmbush_RollEqualsRisk_TriggersAmbush` | Validates boundary condition (roll = risk) uses <= comparison |

##### Encounter Generation Tests (4 tests)

| Test Name | Description |
|-----------|-------------|
| `GenerateAmbushEncounter_UsesBudgetMultiplier` | Validates party level 1 produces budget of 80 (100 × 0.8) |
| `GenerateAmbushEncounter_AlwaysReturnsAtLeastOneEnemy` | Validates fallback ensures minimum 1 enemy even with low budget |
| `GenerateAmbushEncounter_HigherPartyLevel_ScalesBudget` | Validates party level 3 produces budget of 96 (100 × 1.2 × 0.8) |
| `GenerateAmbushEncounter_PrioritizesVargr` | Validates Ash-Vargr (bst_vargr_01) is always selected first for ambush encounters |

#### RestServiceTests - Ambush Integration (8 new tests)

| Test Name | Description |
|-----------|-------------|
| `Wilderness_WithRoom_CallsAmbushService` | Validates ambush service invoked when Room parameter provided |
| `Wilderness_AmbushTriggered_ReturnsWasAmbushed` | Validates RestResult.WasAmbushed=true and AmbushDetails populated when ambush occurs |
| `Wilderness_AmbushTriggered_ConsumesSupplies` | Validates supplies consumed even when rest interrupted by ambush |
| `Wilderness_AmbushTriggered_AppliesDisoriented` | Validates StatusEffectType.Disoriented applied to ambushed character |
| `Wilderness_NoAmbush_NoDisoriented` | Validates Disoriented not applied when ambush check passes |
| `Wilderness_AmbushTriggered_NoRecovery` | Validates HP and Stamina remain unchanged when ambushed (recovery = 0) |
| `Wilderness_AmbushTriggered_StressNotReduced` | Validates PsychicStress unchanged when ambushed |
| `Sanctuary_SkipsAmbushCheck` | Validates sanctuary rest never calls ambush service regardless of Room parameter |

---

### Dependency Injection Registration

#### Added Service (Program.cs)

```csharp
// Register Ambush Services (v0.3.2b)
services.AddScoped<IAmbushService, AmbushService>();

// Register Rest Services (v0.3.2a) - Already registered
services.AddScoped<IRestService, RestService>();
```

**Lifetime Justification:**
- `IAmbushService`: Scoped - stateless calculation service, no shared state required
- `IRestService`: Scoped - depends on scoped InventoryService for supply operations

---

### Verification Results

#### Build Output

```
Build succeeded.
    0 Error(s)
    1 Warning(s) (pre-existing dependency conflict)
```

#### Test Results

```
AmbushServiceTests:
  Passed:  17
  Failed:   0
  Duration: 52ms

RestServiceTests:
  Passed:  28
  Failed:   0
  Duration: 71ms

Total Project Tests: 1778/1778 passing
```

---

### Directory Structure After v0.3.2b

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Interfaces/
│   │   ├── IAmbushService.cs                [NEW]
│   │   └── IRestService.cs                  [MODIFIED - Room overload]
│   └── Models/
│       ├── AmbushResult.cs                  [NEW]
│       ├── EncounterDefinition.cs           [NEW]
│       └── RestResult.cs                    [MODIFIED - WasAmbushed, AmbushDetails]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── AmbushService.cs                 [NEW]
│       └── RestService.cs                   [MODIFIED - Ambush integration]
├── RuneAndRust.Terminal/
│   └── Program.cs                           [MODIFIED - IAmbushService registration, v0.3.2b]
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── AmbushServiceTests.cs            [NEW - 17 tests]
│       └── RestServiceTests.cs              [MODIFIED - +8 tests, total 28]
└── docs/
    └── changelogs/
        └── v0.3.2b.md                       [NEW - This file]
```

---

### Running Tests

#### Run All Rest & Ambush Tests

```bash
dotnet test --filter "FullyQualifiedName~AmbushServiceTests"
dotnet test --filter "FullyQualifiedName~RestServiceTests"
```

#### Run Specific Test Categories

```bash
# Base risk calculation tests
dotnet test --filter "FullyQualifiedName~GetBaseRisk"

# Ambush trigger tests
dotnet test --filter "DisplayName~Trigger"

# Encounter generation tests
dotnet test --filter "DisplayName~GenerateAmbush"

# Ambush integration tests
dotnet test --filter "DisplayName~Ambush"
```

---

### API Usage Examples

#### Performing Wilderness Rest with Ambush Check

```csharp
public class GameService
{
    private readonly IRestService _restService;
    private readonly ICombatService _combatService;

    public async Task AttemptWildernessRestAsync(Character character, Room currentRoom)
    {
        // Perform rest with ambush check
        var result = await _restService.PerformRestAsync(
            character,
            RestType.Wilderness,
            currentRoom);

        if (result.WasAmbushed)
        {
            Console.WriteLine(result.AmbushDetails!.Message);
            Console.WriteLine($"Final Risk: {result.AmbushDetails.FinalRiskPercent}%");
            Console.WriteLine($"Roll: {result.AmbushDetails.RollValue}");

            // Character is now Disoriented
            Debug.Assert(character.HasStatusEffect(StatusEffectType.Disoriented));

            // Initialize combat with ambush encounter
            var encounter = result.AmbushDetails.Encounter!;
            await _combatService.InitiateCombatAsync(
                character,
                encounter.TemplateIds.ToList(),
                isAmbush: true);
        }
        else
        {
            Console.WriteLine($"HP +{result.HpRecovered}, Stamina +{result.StaminaRecovered}");
            Console.WriteLine($"Stress -{result.StressRecovered}");

            if (result.AmbushDetails != null)
            {
                Console.WriteLine($"Your watch was successful (Risk: {result.AmbushDetails.FinalRiskPercent}%)");
            }
        }
    }
}
```

#### Generating Standalone Ambush Encounters

```csharp
// Generate ambush encounter without performing rest
var encounter = _ambushService.GenerateAmbushEncounter(
    room: currentRoom,
    partyLevel: character.Level);

Console.WriteLine($"Ambush Budget: {encounter.Budget}");
Console.WriteLine($"Enemies: {string.Join(", ", encounter.TemplateIds)}");

// Example Output for Level 1:
// Ambush Budget: 80
// Enemies: bst_vargr_01, mec_serv_01, mec_serv_01
```

#### Calculating Ambush Risk Without Rest

```csharp
// Preview ambush risk before committing to rest
var ambushCheck = await _ambushService.CalculateAmbushAsync(character, currentRoom);

Console.WriteLine($"Base Risk: {ambushCheck.BaseRiskPercent}%");
Console.WriteLine($"Your Wits reduces risk by {ambushCheck.MitigationPercent}%");
Console.WriteLine($"Final Risk: {ambushCheck.FinalRiskPercent}%");

// Player can now decide whether to rest or move to safer location
```

---

### Technical Notes

#### Risk Calculation Formula

```
BaseRisk = DangerLevel switch
{
    Safe     => 0%,
    Unstable => 15%,
    Hostile  => 30%,
    Lethal   => 50%
}

MitigationRoll = Roll Wits dice pool
MitigationPercent = MitigationRoll.Successes × 5

RawFinalRisk = BaseRisk - MitigationPercent
FinalRisk = DangerLevel > Safe
    ? Max(5, RawFinalRisk)  // Apply 5% floor in dangerous zones
    : RawFinalRisk          // No floor in safe zones (already 0%)

AmbushTriggered = RollSingle(d100) <= FinalRisk
```

#### Encounter Budget Calculation

```
ScaledBudget = 100 × (1 + (PartyLevel - 1) × 0.1)
AmbushBudget = ScaledBudget × 0.8

Examples:
  Level 1: 100 × 1.0 × 0.8 = 80
  Level 2: 100 × 1.1 × 0.8 = 88
  Level 3: 100 × 1.2 × 0.8 = 96
  Level 5: 100 × 1.4 × 0.8 = 112
```

#### Enemy Selection Algorithm

```csharp
1. Prioritize Ash-Vargr (cost 40) if budget allows
2. Fill remaining budget with Utility Servitors (cost 25)
3. Fallback: Guarantee at least 1 Servitor if budget insufficient
```

**Example Compositions:**
- Budget 80: 1× Vargr (40), 1× Servitor (25) = 65 used
- Budget 96: 1× Vargr (40), 2× Servitor (50) = 90 used
- Budget 112: 1× Vargr (40), 2× Servitor (50) = 90 used (future: add Raider)

#### Supply Consumption Edge Case

Supplies are consumed even when ambushed because:
1. Player had begun preparing camp (set out rations/water)
2. Ambush scatters/ruins prepared supplies
3. Creates meaningful risk (supply loss) even if rest interrupted
4. Prevents exploit of "free ambush checks" by attempting rest without consequence

---

### Design Decisions

#### Why 5% Minimum Risk Floor?

Prevents Wits-stacking characters from achieving absolute safety in dangerous zones. Even the most vigilant scout has a small chance of being caught off-guard in hostile territory. Safe zones (DangerLevel.Safe) remain truly safe at 0% risk.

#### Why 0.8× Budget Multiplier for Ambushes?

Ambush encounters are typically smaller, stealthier groups rather than full frontal assaults. The reduced budget reflects:
- Emphasis on speed/stealth over raw power
- Narrative appropriateness (not every enemy can ambush effectively)
- Mechanical balance (ambushes grant initiative disadvantage via Disoriented)

#### Why Prioritize Ash-Vargr?

Ash-Vargr are established as fast, pack-hunting creatures ideal for ambush tactics. The GlassCannon archetype (high damage, low HP) fits the "strike from shadows" narrative. Mechanically, their higher cost (40) ensures ambush encounters feel dangerous without overwhelming budget.

#### Why Apply Disoriented Instead of Surprised?

Surprised implies total loss of action (skipping turn). Disoriented (-2 to attack/defense pools) allows player agency while representing combat disadvantage. This matches the existing StatusEffectType enum without introducing new mechanics.

---

### Known Limitations

1. **Biome-Specific Enemies**: Currently ignores Room.BiomeType in enemy selection. All ambushes use Ruin-appropriate templates.
   - **Future**: v0.3.3 will add biome-specific enemy pools

2. **Skill System Integration**: Mitigation uses raw Wits attribute. No Camp Craft skill bonus yet.
   - **Future**: v0.4.0 Skills system will add skill-based bonuses

3. **Solo Encounters Only**: Encounter generation assumes single-character party.
   - **Future**: v0.5.0 Party system will scale budget by party size

4. **Static Template Costs**: Enemy costs are hardcoded constants.
   - **Future**: Consider moving to EnemyTemplate.AmbushCost property

---

### Next Steps (Deferred to v0.3.2c: The Dawn)

#### Command Wiring
- [ ] Add `rest` command to CommandParser with Room context
- [ ] Add `camp` alias as synonym for wilderness rest
- [ ] Implement RestScreenRenderer using Spectre.Console panels
- [ ] Display ambush risk preview before committing to rest

#### UI/UX
- [ ] Render AmbushResult in narrative format
- [ ] Show risk breakdown (Base → Mitigation → Final)
- [ ] Display enemy composition if ambushed
- [ ] Add "Your vigilance saved you" flavor text on successful mitigation

#### Time System Integration
- [ ] Advance world time by 480 minutes (8 hours) on rest
- [ ] Trigger time-based events (hunger, exhaustion timers)
- [ ] Update Room.LastVisited timestamp

#### Sanctuary Validation
- [ ] Add Room.Features enum with Sanctuary flag
- [ ] Validate Sanctuary rest only allowed in flagged rooms
- [ ] Add settlement/safe room discovery mechanics

---

### Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Serilog | 3.x | Structured logging for ambush calculations |
| FluentAssertions | 8.x | Test assertions for probability validation |
| xUnit | 2.9.x | Test framework |
| Moq | 4.x | Mocking framework for DiceService and InventoryService |

---

### Migration Notes

This release requires no database migrations. All changes are code-only.

**Recommended Testing Steps:**
1. Verify IAmbushService registered in DI container
2. Test wilderness rest in Hostile room with low-Wits character (should frequently ambush)
3. Test wilderness rest in Hostile room with high-Wits character (should rarely ambush)
4. Test wilderness rest in Safe room (should never ambush)
5. Verify supplies consumed even when ambushed
6. Verify Disoriented status applied when ambushed
7. Verify no recovery granted when ambushed

**Breaking Changes:** None. The original `PerformRestAsync(Character, RestType)` overload remains unchanged. New Room overload is additive.

---

### Performance Considerations

#### Optimization: Safe Zone Early Exit

Safe zones skip dice rolling entirely, returning immediately with 0% risk. This avoids unnecessary RNG overhead in settlements and sanctuaries.

```csharp
if (baseRisk == 0)
{
    return new AmbushResult(/* ... no dice rolls ... */);
}
```

#### Encounter Generation Complexity

Current implementation is O(n) where n = budget/cheapest_enemy. For typical budgets (80-120), this produces 1-5 enemies. Negligible performance impact.

Future biome-specific filtering may require O(m×n) where m = template pool size. Consider pre-filtering by biome if template count exceeds 50.

---

### Changelog Metadata

- **Version**: v0.3.2b
- **Codename**: The Watch
- **Release Type**: Feature Release (Rest & Recovery Milestone)
- **Parent Version**: v0.3.2a (The Campfire)
- **Next Version**: v0.3.2c (The Dawn)
- **Lines of Code Added**: ~500 (implementation + tests)
- **Test Coverage Increase**: +25 tests (17 AmbushServiceTests, 8 RestServiceTests integration)
- **Architecture Impact**: Introduced probabilistic encounter spawning pattern, established ambush template priority system

---

## Part C: The Dawn (Integration)

**Release Date:** 2025-12-20

### Summary

This release integrated the rest and ambush systems (v0.3.2a-b) into the player-facing command interface, completing the Rest & Recovery feature cycle. The Terminal Layer received a new RestScreenRenderer for rich TUI feedback using Spectre.Console, while CommandParser was extended to handle rest/camp/sleep commands with sanctuary detection and ambush transition logic. The Room entity gained a Features system to enable location-based rest types, and GameState was enhanced with PendingEncounter support for seamless ambush-to-combat flow. This release emphasizes integration testing with 10 dedicated CommandParserRestTests validating the full command-to-renderer pipeline and 7 edge-case tests ensuring phase-appropriate command handling.

---

### New Files Created

#### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Services/RestScreenRenderer.cs` | Spectre.Console-based rest result display with recovery tables, exhaustion warnings, and ambush alerts |

#### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/RoomFeature.cs` | Defines room features enabling gameplay mechanics (RunicAnchor, Workbench, AlchemyTable) |
| `RuneAndRust.Core/Interfaces/IRestScreenRenderer.cs` | Interface contract for rest result rendering with Render and RenderAmbushWarning methods |

#### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CommandParserRestTests.cs` | Integration tests for rest/camp command parsing with 10 test cases covering sanctuary logic, ambush handling, and error conditions |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Room.cs` | Added Features property (List<RoomFeature>) and HasFeature(RoomFeature) method for feature detection |
| `RuneAndRust.Core/Models/GameState.cs` | Added PendingEncounter property (JsonIgnore) for ambush-to-combat transition, reset in Reset() method |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added rest/camp/sleep command handling, HandleRestCommandAsync() method, constructor parameters for IRestService/IRestScreenRenderer/IRoomRepository |
| `RuneAndRust.Terminal/Program.cs` | Registered IRestScreenRenderer -> RestScreenRenderer as Singleton, updated version banner to v0.3.2c |
| `RuneAndRust.Tests/Engine/CommandParserTests.cs` | Added 7 tests for rest/camp command validation (service availability, phase restrictions) |

---

### Code Implementation Details

#### RestScreenRenderer (Spectre.Console)

**Constructor:**
```csharp
public RestScreenRenderer(ILogger<RestScreenRenderer> logger)
```

**Key Methods:**

**Render(RestResult result)**
- Displays yellow "Rest & Recovery" banner using Spectre.Console Rule
- Renders exhaustion warning panel (red, rounded border) if IsExhausted is true
- Creates recovery statistics table (40-width, rounded border):
  - Health: Green +HP or grey +0
  - Stamina: Cyan +Stamina or grey +0
  - Stress: Purple -Stress or grey -0
- Shows supply consumption message if SuppliesConsumed is true
- Calculates and displays time passage in hours (TimeAdvancedMinutes / 60)
- Blocks with Console.ReadKey(true) until player presses Enter
- Logs entry at Info level, debug for recovery deltas, trace for dismissal

**RenderAmbushWarning(AmbushResult ambushResult)**
- Displays red "AMBUSH!" banner using Spectre.Console Rule
- Shows escaped ambush message (protects against markup injection)
- Creates risk details table (40-width, rounded border):
  - Base Risk: Yellow percentage
  - Wits Mitigation: Green negative percentage
  - Final Risk: Red percentage
  - Roll: Grey d100 value
- Shows "Enemies approach..." and "Press Enter to engage." prompts
- Blocks with Console.ReadKey(true)
- Logs entry at Warning level with base/final risk and roll value

**Helper Methods:**
- RenderRestBanner(): Creates centered yellow Rule
- RenderAmbushBanner(): Creates centered red Rule
- RenderExhaustionWarning(): Creates red Panel with exhaustion text
- RenderRecoveryTable(RestResult): Builds attribute change table
- RenderSupplyConsumption(): Displays "Consumed: 1 Ration, 1 Water"
- RenderTimePassage(int minutes): Displays elapsed hours
- RenderRiskDetails(AmbushResult): Builds risk calculation table
- EscapeMarkup(string text): Replaces [ and ] with [[ and ]] for Spectre safety

#### CommandParser Rest Handling

**Constructor Addition:**
```csharp
public CommandParser(
    ILogger<CommandParser> logger,
    IInputHandler inputHandler,
    GameState gameState,
    IJournalService? journalService = null,
    ICombatService? combatService = null,
    IVictoryScreenRenderer? victoryRenderer = null,
    IRestService? restService = null,              // v0.3.2c
    IRestScreenRenderer? restRenderer = null,       // v0.3.2c
    IRoomRepository? roomRepository = null)         // v0.3.2c
```

**HandleRestCommandAsync(GameState state, bool preferSanctuary)**
- Validates required services (RestService, RestRenderer, RoomRepository) and displays error if null
- Validates CurrentCharacter exists or displays "No active character"
- Validates CurrentRoomId exists or displays "You are nowhere. This should not happen."
- Retrieves Room entity from repository
- Determines RestType based on preferSanctuary and room.HasFeature(RoomFeature.RunicAnchor):
  - preferSanctuary && hasAnchor -> RestType.Sanctuary, displays "You rest at the Runic Anchor..."
  - Otherwise -> RestType.Wilderness, displays "You set up camp in the wilderness..."
- Calls RestService.PerformRestAsync(character, restType, room)
- On ambush (WasAmbushed is true):
  - Calls RestRenderer.RenderAmbushWarning(ambushDetails)
  - Sets GameState.PendingEncounter to ambushDetails.Encounter
  - Sets GamePhase to Combat
  - Logs warning about combat transition
- On success:
  - Calls RestRenderer.Render(result)
  - Increments TurnCount
  - Logs recovery deltas at Info level

**Command Mapping:**
- "rest" -> HandleRestCommandAsync(state, preferSanctuary: true)
- "camp" -> HandleRestCommandAsync(state, preferSanctuary: false)
- "sleep" -> HandleRestCommandAsync(state, preferSanctuary: false)

**Help Text Addition (DisplayExplorationHelp):**
```
Rest & Recovery:
  rest             - Rest (Sanctuary at anchors, Wilderness elsewhere)
  camp             - Set up camp in the wilderness (ambush risk)
  sleep            - Same as camp
```

#### RoomFeature Enum

**Definition:**
```csharp
public enum RoomFeature
{
    None = 0,
    RunicAnchor = 1,    // Allows Sanctuary rest with full recovery
    Workbench = 2,      // Allows crafting activities
    AlchemyTable = 3    // Allows potion brewing
}
```

**Usage:**
- Room.Features is List<RoomFeature> (default empty list)
- Room.HasFeature(RoomFeature feature) returns Features.Contains(feature)

#### GameState.PendingEncounter

**Property:**
```csharp
[JsonIgnore]
public EncounterDefinition? PendingEncounter { get; set; }
```

**Behavior:**
- Not serialized to save files
- Set by CommandParser when ambush occurs during rest
- Consumed by GameService when entering Combat phase
- Reset to null in GameState.Reset() method

#### IRestScreenRenderer Interface

**Contract:**
```csharp
public interface IRestScreenRenderer
{
    void Render(RestResult result);
    void RenderAmbushWarning(AmbushResult ambushResult);
}
```

---

### Logging Matrix

#### RestScreenRenderer
| Event | Level | Template |
|-------|-------|----------|
| Rest screen entry | Info | `"Rendering rest screen. HP+{Hp}, Stamina+{Stamina}, Stress-{Stress}, Exhausted: {Exhausted}"` |
| Recovery table rendered | Debug | `"Rendered recovery: HP+{Hp}, Stamina+{Stamina}, Stress-{Stress}"` |
| Rest screen dismissed | Trace | `"Rest screen rendered and dismissed"` |
| Ambush warning entry | Warning | `"Rendering ambush warning. BaseRisk: {Base}%, Final: {Final}%, Roll: {Roll}"` |
| Ambush risk details rendered | Debug | `"Rendered ambush details: Base {Base}%, Mitigation -{Mit}%, Final {Final}%, Roll {Roll}"` |
| Ambush warning dismissed | Trace | `"Ambush warning rendered and dismissed"` |

#### CommandParser (Rest Commands)
| Event | Level | Template |
|-------|-------|----------|
| Rest command execution | Info | `"Player executed {Command} in {Room}."` |
| Rest type determination | Debug | `"Rest type determined: {RestType} (HasAnchor: {HasAnchor})"` |
| Ambush transition | Warning | `"Rest interrupted by ambush. Transitioning to Combat."` |
| Successful rest completion | Info | `"Rest complete. HP+{HP} Stamina+{Stamina} Stress-{Stress}."` |
| Missing services warning | Warning | `"Rest command attempted but required services are not configured."` |
| Missing room error | Error | `"Rest command attempted with null CurrentRoomId."` |
| Room not found error | Error | `"Room {RoomId} not found in database."` |

---

### Test Coverage

#### Build Verification
```
Build succeeded.
    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.79
```

#### Test Execution
```
Passed!  - Failed:     0, Passed:    10, Skipped:     0, Total:    10, Duration: 66 ms
```

#### CommandParserRestTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| Rest_AtRunicAnchor_UsesSanctuaryType | Room with RunicAnchor feature triggers RestType.Sanctuary |
| Rest_WithoutAnchor_UsesWildernessType | Room without RunicAnchor feature triggers RestType.Wilderness |
| Camp_AlwaysUsesWildernessType | Camp command ignores RunicAnchor and always uses Wilderness rest |
| Camp_AmbushTriggered_SetsGamePhaseCombat | Ambush result sets GamePhase.Combat |
| Camp_AmbushTriggered_StoresPendingEncounter | Ambush result stores encounter in GameState.PendingEncounter |
| Camp_AmbushTriggered_RendersAmbushWarning | Ambush result calls RenderAmbushWarning and not Render |
| Camp_NoAmbush_RendersCalled | Successful rest calls Render and not RenderAmbushWarning |
| Rest_IncrementsTurnCount | Successful rest increments GameState.TurnCount by 1 |
| Rest_WithoutCharacter_DisplaysError | Missing CurrentCharacter displays error containing "character" |
| Rest_WithoutRoom_DisplaysError | Null CurrentRoomId displays error containing "nowhere" |

#### CommandParserTests - Rest Region (7 tests)

| Test Name | Description |
|-----------|-------------|
| Rest_WithoutRequiredServices_DisplaysErrorMessage | Rest command without IRestService shows error containing "not available" |
| Camp_WithoutRequiredServices_DisplaysErrorMessage | Camp command without IRestService shows error containing "not available" |
| Sleep_WithoutRequiredServices_DisplaysErrorMessage | Sleep alias without IRestService shows error containing "not available" |
| Rest_InMainMenuPhase_DoesNotTriggerRestCommand | Rest command in MainMenu phase treated as unknown command |
| Camp_InMainMenuPhase_DoesNotTriggerCampCommand | Camp command in MainMenu phase treated as unknown command |
| Rest_InCombatPhase_DoesNotTriggerRestCommand | Rest command in Combat phase treated as unknown command |
| Camp_InCombatPhase_DoesNotTriggerCampCommand | Camp command in Combat phase treated as unknown command |

---

### DI Registration

**Added to RuneAndRust.Terminal/Program.cs:**
```csharp
// Register Rest Screen Renderer (v0.3.2c)
services.AddSingleton<IRestScreenRenderer, RestScreenRenderer>();
```

**Dependencies:**
- IRestScreenRenderer (Singleton) -> RestScreenRenderer
- CommandParser constructor accepts IRestService, IRestScreenRenderer, IRoomRepository (all optional)

---

### Verification Results

#### Build Output
```
RuneAndRust.Core -> .../bin/Debug/net9.0/RuneAndRust.Core.dll
RuneAndRust.Persistence -> .../bin/Debug/net9.0/RuneAndRust.Persistence.dll
RuneAndRust.Engine -> .../bin/Debug/net9.0/RuneAndRust.Engine.dll
RuneAndRust.Terminal -> .../bin/Debug/net9.0/RuneAndRust.Terminal.dll
RuneAndRust.Tests -> .../bin/Debug/net9.0/RuneAndRust.Tests.dll

Build succeeded.
```

#### Test Output
```
Test run for /Volumes/GitHub/github/southpawriter02/rune-rust/RuneAndRust.Tests/bin/Debug/net9.0/RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    10, Skipped:     0, Total:    10, Duration: 66 ms - RuneAndRust.Tests.dll (net9.0)
```

---

### Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   └── Room.cs                                         [MODIFIED]
│   ├── Enums/
│   │   └── RoomFeature.cs                                  [NEW]
│   ├── Interfaces/
│   │   └── IRestScreenRenderer.cs                          [NEW]
│   └── Models/
│       └── GameState.cs                                    [MODIFIED]
├── RuneAndRust.Engine/
│   └── Services/
│       └── CommandParser.cs                                [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Program.cs                                          [MODIFIED]
│   └── Services/
│       └── RestScreenRenderer.cs                           [NEW]
└── RuneAndRust.Tests/
    └── Engine/
        ├── CommandParserRestTests.cs                       [NEW]
        └── CommandParserTests.cs                           [MODIFIED]
```

---

### Running Tests

#### Run All CommandParserRestTests
```bash
dotnet test --filter "FullyQualifiedName~CommandParserRestTests"
```

#### Run Specific Test
```bash
dotnet test --filter "FullyQualifiedName~CommandParserRestTests.Rest_AtRunicAnchor_UsesSanctuaryType"
```

#### Run All Rest-Related Tests
```bash
dotnet test --filter "FullyQualifiedName~Rest"
```

---

### Next Steps (v0.3.3)

- **Time Advancement Integration**: Wire WorldTime into RestService for persistent day/night cycle tracking
- **Sanctuary Discovery Mechanics**: Implement RunicAnchor unlocking through exploration or quest completion
- **Camp Craft Skill Bonus**: Apply Camp Craft attribute to ambush mitigation percentage
- **Watch Rotation System**: Multi-character party rest with watch assignments to reduce ambush risk
- **Rest Interruption Events**: Non-combat interruptions (weather, noise, discoveries)
- **Long Rest System**: Multi-day rest for trauma recovery and major healing
