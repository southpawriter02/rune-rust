# v0.4.2c — "The Voice"

**Release Date:** 2025-12-30
**Theme:** DialogueService & Effects
**Depends On:** v0.4.2b (The Lexicon)

---

## Overview

This release implements the **DialogueService** — the runtime engine that drives branching conversations. Building on the data models and condition system from v0.4.2b, "The Voice" adds session management, effect execution, and event publishing to create a complete dialogue system.

**Key Features:**
- **Session Management:** Track active dialogue state with `DialogueSession`
- **Effect Execution:** Process `ModifyReputation`, `GiveItem`, and `SetFlag` effects
- **Event Publishing:** Notify game systems of dialogue lifecycle events
- **Result Types:** Rich return types with factory methods for all operations

---

## New Files (16)

### Enums (1 file)

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/DialogueEndReason.cs` | 5-value enum: PlayerExit, NpcExit, PlayerCancel, Interrupted, Error |

### Models (6 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/DialogueSession.cs` | Runtime session state with tree, node, character, and history tracking |
| `RuneAndRust.Core/Models/DialogueViewModel.cs` | UI rendering model with NPC info, dialogue text, and options |
| `RuneAndRust.Core/Models/DialogueOptionViewModel.cs` | Option display with availability, visibility, and lock reason |
| `RuneAndRust.Core/Models/DialogueStartResult.cs` | Start operation result with `Successful`/`Failed` factories |
| `RuneAndRust.Core/Models/DialogueStepResult.cs` | Step operation result with `Continue`/`End`/`Failed` factories |
| `RuneAndRust.Core/Models/DialogueEndResult.cs` | End operation result with session statistics |
| `RuneAndRust.Core/Models/DialogueEffectResult.cs` | Effect execution result with type and description |

### Events (3 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Events/DialogueStartedEvent.cs` | Published when dialogue session begins |
| `RuneAndRust.Core/Events/DialogueOptionSelectedEvent.cs` | Published when player selects an option |
| `RuneAndRust.Core/Events/DialogueEndedEvent.cs` | Published when dialogue session ends |

### Interfaces (2 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IDialogueService.cs` | Main service: Start, SelectOption, End, GetCurrent, IsInDialogue |
| `RuneAndRust.Core/Interfaces/IDialogueEffectExecutor.cs` | Effect execution: ExecuteEffect, ExecuteEffects |

### Services (2 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/DialogueEffectExecutor.cs` | Executes ModifyReputation, GiveItem, SetFlag effects |
| `RuneAndRust.Engine/Services/DialogueService.cs` | Manages dialogue flow, session state, and event publishing |

### Tests (2 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/DialogueEffectExecutorTests.cs` | 15 unit tests for effect execution |
| `RuneAndRust.Tests/Engine/DialogueServiceTests.cs` | 30 unit tests for dialogue flow |

---

## Modified Files (2)

### RuneAndRust.Core/Models/GameState.cs

Added `CurrentDialogueSession` property for tracking active dialogue:

```csharp
/// <summary>
/// Gets or sets the current dialogue session (v0.4.2c).
/// Null when not in dialogue.
/// Not serialized to save files.
/// </summary>
[JsonIgnore]
public DialogueSession? CurrentDialogueSession { get; set; }
```

Updated `Reset()` method to clear dialogue session:

```csharp
CurrentDialogueSession = null;
```

### RuneAndRust.Terminal/Program.cs

Added DI registrations for new services:

```csharp
services.AddScoped<IDialogueEffectExecutor, DialogueEffectExecutor>();
services.AddScoped<IDialogueService, DialogueService>();
```

---

## Implementation Details

### DialogueSession Model

Tracks runtime state of an active conversation:

```csharp
public class DialogueSession
{
    public Guid SessionId { get; set; } = Guid.NewGuid();
    public required DialogueTree Tree { get; set; }
    public required DialogueNode CurrentNode { get; set; }
    public required Guid CharacterId { get; set; }
    public DateTime StartedAt { get; set; } = DateTime.UtcNow;
    public List<string> VisitedNodeIds { get; set; } = new();
    public int OptionsSelectedCount { get; set; }
}
```

### DialogueService Flow

1. **StartDialogueAsync:** Validates no active session, loads tree, creates session, publishes event
2. **SelectOptionAsync:** Validates session/character, evaluates conditions, executes effects, navigates
3. **EndDialogueAsync:** Calculates statistics, publishes event, clears session

### Effect Execution

The `DialogueEffectExecutor` handles three effect types:

| Effect Type | Action | Dependencies |
|-------------|--------|--------------|
| `ModifyReputation` | Adjusts faction reputation | `IFactionService` |
| `GiveItem` | Adds item to inventory | `IItemRepository`, `IInventoryService` |
| `SetFlag` | Sets/clears game flag | `GameState.Flags` |

### Event Publishing

Three events notify game systems of dialogue state changes:

| Event | Trigger | Key Data |
|-------|---------|----------|
| `DialogueStartedEvent` | Session begins | SessionId, TreeId, NpcName, CharacterId |
| `DialogueOptionSelectedEvent` | Option selected | FromNodeId, ToNodeId, EffectsExecuted |
| `DialogueEndedEvent` | Session ends | Reason, Duration, NodesVisited, OptionsSelected |

### Result Type Pattern

All operations return rich result types with factory methods:

```csharp
// DialogueStartResult
DialogueStartResult.Successful(viewModel, session)
DialogueStartResult.Failed("Error message")

// DialogueStepResult
DialogueStepResult.Continue(viewModel, effects)
DialogueStepResult.End(reason, effects)
DialogueStepResult.Failed("Error message")

// DialogueEffectResult
DialogueEffectResult.Successful(type, "Description")
DialogueEffectResult.Failed(type, "Error message")
```

---

## Test Coverage (45 tests)

### DialogueEffectExecutorTests (15 tests)

| Category | Count | Coverage |
|----------|-------|----------|
| ModifyReputation | 5 | Positive, negative, service failure, before/after description, exception handling |
| GiveItem | 5 | Single item, multiple items, item not found, inventory full, exception handling |
| SetFlag | 3 | Set true, set false (clear), overwrite existing |
| ExecuteEffectsAsync | 2 | Multiple effects, partial failure continues |

### DialogueServiceTests (30 tests)

| Category | Count | Coverage |
|----------|-------|----------|
| StartDialogueAsync | 8 | Valid tree, tree not found, already in dialogue, session creation, event publishing, visited nodes, root not found, options in view model |
| SelectOptionAsync | 12 | Navigation, terminal option, no session, wrong character, option not found, unavailable option, effect execution, event publishing, increment count, next node not found, visited nodes tracking, terminal node NPC exit |
| EndDialogueAsync | 5 | Valid session, no session, clear session, event publishing, session statistics |
| GetCurrentDialogueAsync | 3 | No session, wrong character, valid session |
| IsInDialogue | 2 | No session, with session |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        DialogueService                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Start     │  │   Select    │  │         End             │  │
│  │  Dialogue   │──│   Option    │──│       Dialogue          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│         │                │                      │               │
│         ▼                ▼                      ▼               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    GameState                            │    │
│  │              CurrentDialogueSession                     │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
         │                │                      │
         ▼                ▼                      ▼
┌─────────────┐  ┌─────────────────┐  ┌─────────────────────────┐
│  Dialogue   │  │   Condition     │  │       Effect            │
│ Repository  │  │   Evaluator     │  │      Executor           │
│  (v0.4.2b)  │  │    (v0.4.2b)    │  │      (v0.4.2c)          │
└─────────────┘  └─────────────────┘  └─────────────────────────┘
                                               │
                        ┌──────────────────────┼──────────────────────┐
                        ▼                      ▼                      ▼
                ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
                │  Faction    │        │  Inventory  │        │  GameState  │
                │  Service    │        │   Service   │        │    Flags    │
                └─────────────┘        └─────────────┘        └─────────────┘
```

---

## Dialogue Flow Sequence

```
User Initiates Dialogue
        │
        ▼
┌─────────────────────┐
│  StartDialogueAsync │
│  ─────────────────  │
│  1. Check no active │
│  2. Load tree       │
│  3. Create session  │
│  4. Build view model│
│  5. Publish event   │
└─────────────────────┘
        │
        ▼
┌─────────────────────┐     ┌─────────────────────┐
│   Display Dialog    │────▶│  SelectOptionAsync  │
│   (UI Layer)        │     │  ─────────────────  │
└─────────────────────┘     │  1. Validate session│
        ▲                   │  2. Find option     │
        │                   │  3. Check conditions│
        │                   │  4. Execute effects │
        │                   │  5. Navigate/End    │
        │                   │  6. Publish event   │
        │                   └─────────────────────┘
        │                           │
        │    ┌──────────────────────┴──────────────────────┐
        │    │                                             │
        │    ▼                                             ▼
        │ [Continue]                                [End Dialogue]
        │    │                                             │
        └────┘                                             ▼
                                              ┌─────────────────────┐
                                              │   EndDialogueAsync  │
                                              │   ────────────────  │
                                              │   1. Calc statistics│
                                              │   2. Publish event  │
                                              │   3. Clear session  │
                                              └─────────────────────┘
```

---

## Usage Example

```csharp
// Start a dialogue
var startResult = await _dialogueService.StartDialogueAsync(
    character,
    "npc_old_scavenger",
    gameState);

if (startResult.Success)
{
    // Display the dialogue UI
    DisplayDialogue(startResult.ViewModel);
}

// Player selects an option
var stepResult = await _dialogueService.SelectOptionAsync(
    character,
    selectedOptionId,
    gameState);

if (stepResult.DialogueEnded)
{
    // Dialogue complete
    CloseDialogueUI();
}
else
{
    // Show next node
    DisplayDialogue(stepResult.ViewModel);
}

// Player cancels dialogue (e.g., presses Escape)
var endResult = await _dialogueService.EndDialogueAsync(
    DialogueEndReason.PlayerCancel,
    gameState);
```

---

## Dependencies

### Required Services (DI)

| Service | Purpose |
|---------|---------|
| `IDialogueRepository` | Load dialogue trees and nodes |
| `IDialogueConditionEvaluator` | Evaluate option availability |
| `IDialogueEffectExecutor` | Execute dialogue effects |
| `IEventBus` | Publish dialogue events |
| `IFactionService` | Modify reputation (effects) |
| `IInventoryService` | Give items (effects) |
| `IItemRepository` | Lookup items (effects) |

### From Previous Releases

- **v0.4.2b (The Lexicon):** DialogueTree, DialogueNode, DialogueOption, DialogueCondition types, DialogueRepository, DialogueConditionEvaluator
- **v0.4.2a (The Repute):** FactionService, ReputationChangeResult

---

## Verification

```bash
# Build verification
dotnet build  # 0 errors

# Unit test verification
dotnet test --filter "DialogueEffectExecutorTests|DialogueServiceTests"
# Passed: 45, Failed: 0

# Engine test suite (no regressions)
dotnet test --filter "FullyQualifiedName~Engine"
# Passed: 2286, Failed: 0
```

---

## What's Next

**v0.4.2d — "The Quill"** (Dialogue Content & Serialization)
- JSON dialogue tree authoring format
- Dialogue tree validation tooling
- Sample NPC dialogue content
- Dialogue editor integration hooks
