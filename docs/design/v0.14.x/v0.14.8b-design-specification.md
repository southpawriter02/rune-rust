# v0.14.8b Design Specification: Dice Mechanics Schema

**Version:** 0.14.8b
**Status:** Draft
**Created:** 2026-01-17
**Last Updated:** 2026-01-17
**Prerequisites:** v0.14.8a Complete (Dice Types Schema)
**Estimated Tests:** ~6 new tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [CriticalThresholds Schema Definition](#4-criticalthresholds-schema-definition)
5. [AdvantageRules Schema Definition](#5-advantagerules-schema-definition)
6. [ExplodingDiceRules Schema Definition](#6-explodingdicerules-schema-definition)
7. [KeepRules Schema Definition](#7-keeprules-schema-definition)
8. [RerollRules Schema Definition](#8-rerollrules-schema-definition)
9. [DefaultDice Schema Definition](#9-defaultdice-schema-definition)
10. [DifficultyClass Schema Definition](#10-difficultyclass-schema-definition)
11. [JSON Schema Specification](#11-json-schema-specification)
12. [Configuration File](#12-configuration-file)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)
19. [Appendix A: Validation Examples](#appendix-a-validation-examples)
20. [Appendix B: Mechanics Reference Tables](#appendix-b-mechanics-reference-tables)

---

## 1. Executive Summary

### Overview

Version 0.14.8b introduces the Dice Mechanics Schema, a comprehensive JSON schema for dice pool mechanics and roll rules. This schema enables full customization of critical thresholds, advantage/disadvantage mechanics, exploding dice, keep/drop rules, reroll conditions, default dice assignments, and difficulty class definitions—all without code changes.

### Key Deliverables

| Category | Deliverable | Description |
|----------|-------------|-------------|
| **Schema** | `dice-mechanics.schema.json` | JSON Schema Draft-07 for dice mechanics validation |
| **Configuration** | `dice-mechanics.json` | Default mechanics configuration |
| **Definitions** | 7 Schema Definitions | CriticalThresholds, AdvantageRules, ExplodingDiceRules, KeepRules, RerollRules, DefaultDice, DifficultyClass |
| **Tests** | ~6 Unit Tests | Schema validation and configuration tests |

### Architectural Significance

The Dice Mechanics Schema provides:

- **Centralized Roll Configuration**: Single source of truth for all dice roll mechanics
- **Critical Hit Customization**: Configurable thresholds, multipliers, and bonus dice
- **Advantage System**: Flexible advantage/disadvantage rules with optional stacking
- **Advanced Pool Mechanics**: Exploding dice, keep/drop rules, and reroll conditions
- **Difficulty Standards**: Predefined difficulty classes for consistent DC values
- **Modding Support**: Full customization of roll mechanics without code changes

### Relationship to v0.14.8a

This schema builds upon v0.14.8a (Dice Types Schema) which defines valid die types:

```
v0.14.8a (Dice Types)          v0.14.8b (Dice Mechanics)
├── DieType definitions   ───►  ├── References die types
├── DiceExpression pattern ───► │   in defaultDice expressions
└── dice-types.json            └── dice-mechanics.json
```

---

## 2. Feature Overview

```
v0.14.8b: Dice Mechanics Schema
├── Schema File
│   └── dice-mechanics.schema.json
│       ├── CriticalThresholds Definition
│       │   ├── naturalMin (critical failure value)
│       │   ├── naturalMax (critical success - "max" or integer)
│       │   ├── criticalMultiplier (damage multiplier)
│       │   ├── criticalBonusDice (extra dice on crit)
│       │   ├── autoFailOnNatMin (always fail on min)
│       │   └── autoSuccessOnNatMax (always succeed on max)
│       ├── AdvantageRules Definition
│       │   ├── advantageDice (extra dice count)
│       │   ├── advantageKeep (Highest/Lowest)
│       │   ├── disadvantageDice (extra dice count)
│       │   ├── disadvantageKeep (Highest/Lowest)
│       │   └── stackable (multiple advantages stack)
│       ├── ExplodingDiceRules Definition
│       │   ├── enabled (toggle exploding dice)
│       │   ├── explodeOn (Max/Threshold)
│       │   ├── threshold (value for Threshold mode)
│       │   ├── maxExplosions (prevent infinite loops)
│       │   └── appliesToTypes (which die types explode)
│       ├── KeepRules Definition
│       │   ├── keepHighest (keep N highest)
│       │   ├── keepLowest (keep N lowest)
│       │   └── dropHighest (drop N highest)
│       ├── RerollRules Definition
│       │   ├── rerollOnes (reroll natural 1s)
│       │   ├── rerollBelow (reroll below threshold)
│       │   ├── maxRerolls (limit reroll attempts)
│       │   └── keepOriginalOnReroll (keep original if worse)
│       ├── DefaultDice Definition
│       │   ├── skillCheck (default: "1d10")
│       │   ├── attackRoll (default: "1d20")
│       │   ├── saveRoll (default: "1d20")
│       │   ├── damageRoll (default: "1d6")
│       │   ├── initiativeRoll (default: "1d10")
│       │   └── healingRoll (default: "1d8")
│       └── DifficultyClass Definition
│           ├── id (kebab-case identifier)
│           ├── name (display name)
│           ├── dc (target number)
│           ├── description (optional)
│           └── sortOrder (display ordering)
├── Configuration File
│   └── dice-mechanics.json
│       ├── criticalThresholds (required)
│       ├── advantageRules (optional)
│       ├── explodingDice (optional)
│       ├── keepRules (optional)
│       ├── rerollRules (optional)
│       ├── defaultDice (required)
│       └── difficultyClasses (optional)
└── Unit Tests (~6)
    ├── DMS-001: Schema file loads and parses
    ├── DMS-002: Valid configuration passes validation
    ├── DMS-003: Invalid critical thresholds rejected
    ├── DMS-004: Invalid difficulty class rejected
    ├── DMS-005: Missing required fields rejected
    └── DMS-006: Exploding dice validation
```

---

## 3. Architecture Diagrams

### 3.1 Dice Mechanics Configuration Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                    dice-mechanics.json                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ criticalThresholds (REQUIRED)                            │   │
│  │ ├── naturalMin: 1                                        │   │
│  │ ├── naturalMax: "max"                                    │   │
│  │ ├── criticalMultiplier: 2                                │   │
│  │ ├── criticalBonusDice: null                              │   │
│  │ ├── autoFailOnNatMin: true                               │   │
│  │ └── autoSuccessOnNatMax: true                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ advantageRules (OPTIONAL)                                │   │
│  │ ├── advantageDice: 1                                     │   │
│  │ ├── advantageKeep: "Highest"                             │   │
│  │ ├── disadvantageDice: 1                                  │   │
│  │ ├── disadvantageKeep: "Lowest"                           │   │
│  │ └── stackable: false                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ explodingDice (OPTIONAL)                                 │   │
│  │ ├── enabled: false                                       │   │
│  │ ├── explodeOn: "Max"                                     │   │
│  │ ├── threshold: null                                      │   │
│  │ ├── maxExplosions: 10                                    │   │
│  │ └── appliesToTypes: []                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ keepRules (OPTIONAL)                                     │   │
│  │ ├── keepHighest: null                                    │   │
│  │ ├── keepLowest: null                                     │   │
│  │ └── dropHighest: null                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ rerollRules (OPTIONAL)                                   │   │
│  │ ├── rerollOnes: false                                    │   │
│  │ ├── rerollBelow: null                                    │   │
│  │ ├── maxRerolls: 1                                        │   │
│  │ └── keepOriginalOnReroll: false                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ defaultDice (REQUIRED)                                   │   │
│  │ ├── skillCheck: "1d10"                                   │   │
│  │ ├── attackRoll: "1d20"                                   │   │
│  │ ├── saveRoll: "1d20"                                     │   │
│  │ ├── damageRoll: "1d6"                                    │   │
│  │ ├── initiativeRoll: "1d10"                               │   │
│  │ └── healingRoll: "1d8"                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ difficultyClasses[] (OPTIONAL)                           │   │
│  │ ├── { id: "trivial", name: "Trivial", dc: 5 }            │   │
│  │ ├── { id: "easy", name: "Easy", dc: 8 }                  │   │
│  │ ├── { id: "moderate", name: "Moderate", dc: 12 }         │   │
│  │ ├── { id: "hard", name: "Hard", dc: 16 }                 │   │
│  │ ├── { id: "very-hard", name: "Very Hard", dc: 20 }       │   │
│  │ └── { id: "nearly-impossible", name: "Nearly...", dc: 25}│   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Roll Mechanics Flow

```
┌──────────────────┐
│   Roll Request   │
│ (skillCheck,     │
│  attackRoll,     │
│  saveRoll, etc.) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Load Default    │────►│    defaultDice      │
│  Dice Expression │     │ skillCheck: "1d10"  │
└────────┬─────────┘     │ attackRoll: "1d20"  │
         │               └─────────────────────┘
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Apply Advantage │────►│   advantageRules    │
│  /Disadvantage?  │     │ advantageDice: 1    │
└────────┬─────────┘     │ keepHighest/Lowest  │
         │               └─────────────────────┘
         ▼
┌──────────────────┐     ┌─────────────────────┐
│   Roll Dice      │────►│      keepRules      │
│   Apply Keep     │     │ keepHighest: N      │
│   Rules          │     │ dropHighest: N      │
└────────┬─────────┘     └─────────────────────┘
         │
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Apply Reroll    │────►│    rerollRules      │
│  Rules           │     │ rerollOnes: true    │
└────────┬─────────┘     │ rerollBelow: 3      │
         │               └─────────────────────┘
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Check Exploding │────►│   explodingDice     │
│  Dice            │     │ explodeOn: "Max"    │
└────────┬─────────┘     │ maxExplosions: 10   │
         │               └─────────────────────┘
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Check Critical  │────►│ criticalThresholds  │
│  Success/Failure │     │ naturalMin: 1       │
└────────┬─────────┘     │ naturalMax: "max"   │
         │               └─────────────────────┘
         ▼
┌──────────────────┐     ┌─────────────────────┐
│  Compare vs DC   │────►│ difficultyClasses   │
│  (if applicable) │     │ moderate: DC 12     │
└────────┬─────────┘     │ hard: DC 16         │
         │               └─────────────────────┘
         ▼
┌──────────────────┐
│   Roll Result    │
│ (success/failure │
│  + critical?)    │
└──────────────────┘
```

### 3.3 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      Configuration Layer                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                   dice-mechanics.json                      │ │
│  │   Concrete configuration with actual mechanics values      │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ validated by
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Schema Layer                             │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │               dice-mechanics.schema.json                   │ │
│  │   JSON Schema Draft-07 with definitions:                   │ │
│  │   ├── CriticalThresholds                                   │ │
│  │   ├── AdvantageRules                                       │ │
│  │   ├── ExplodingDiceRules                                   │ │
│  │   ├── KeepRules                                            │ │
│  │   ├── RerollRules                                          │ │
│  │   ├── DefaultDice                                          │ │
│  │   └── DifficultyClass                                      │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ references patterns from
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Dependency Layer (v0.14.8a)                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                 dice-types.schema.json                     │ │
│  │   Provides DiceExpression pattern for defaultDice          │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. CriticalThresholds Schema Definition

### 4.1 Overview

The `CriticalThresholds` definition specifies the rules for critical success and critical failure on dice rolls. This includes which values trigger criticals, damage multipliers, bonus dice, and automatic success/failure behavior.

### 4.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `naturalMin` | integer | No | 1 | minimum: 1 | The die value that triggers a critical failure |
| `naturalMax` | string\|integer | No | "max" | "max" or integer >= 1 | The die value that triggers a critical success |
| `criticalMultiplier` | number | No | 2 | minimum: 1 | Damage multiplier applied on critical hit |
| `criticalBonusDice` | string\|null | No | null | Dice expression or null | Extra dice rolled on critical hit |
| `autoFailOnNatMin` | boolean | No | true | - | Whether natural min always fails regardless of modifiers |
| `autoSuccessOnNatMax` | boolean | No | true | - | Whether natural max always succeeds regardless of DC |

### 4.3 Schema Definition

```json
{
  "CriticalThresholds": {
    "type": "object",
    "description": "Configuration for critical success and failure thresholds",
    "properties": {
      "naturalMin": {
        "type": "integer",
        "description": "The die value that triggers a critical failure",
        "minimum": 1,
        "default": 1
      },
      "naturalMax": {
        "oneOf": [
          {
            "type": "string",
            "const": "max",
            "description": "Use the die's maximum value for critical success"
          },
          {
            "type": "integer",
            "minimum": 1,
            "description": "Specific value that triggers critical success"
          }
        ],
        "description": "The die value that triggers a critical success",
        "default": "max"
      },
      "criticalMultiplier": {
        "type": "number",
        "description": "Damage multiplier applied on critical hit",
        "minimum": 1,
        "default": 2
      },
      "criticalBonusDice": {
        "oneOf": [
          {
            "type": "string",
            "pattern": "^\\d+d\\d+([+-]\\d+)?$",
            "description": "Dice expression for bonus dice on critical"
          },
          {
            "type": "null"
          }
        ],
        "description": "Extra dice rolled on critical hit (e.g., '1d6')",
        "default": null
      },
      "autoFailOnNatMin": {
        "type": "boolean",
        "description": "Whether rolling natural minimum always fails regardless of modifiers",
        "default": true
      },
      "autoSuccessOnNatMax": {
        "type": "boolean",
        "description": "Whether rolling natural maximum always succeeds regardless of DC",
        "default": true
      }
    },
    "additionalProperties": false
  }
}
```

### 4.4 Behavior Rules

| Rule | Condition | Effect |
|------|-----------|--------|
| **Critical Failure** | Roll equals `naturalMin` | Attack misses, action fails (if `autoFailOnNatMin`) |
| **Critical Success** | Roll equals die max (if "max") or specified value | Hit confirmed, apply `criticalMultiplier` to damage |
| **Bonus Dice** | On critical success with `criticalBonusDice` set | Roll and add bonus dice to damage |
| **Auto-Fail Override** | `autoFailOnNatMin: false` | Natural 1 can still succeed with high enough modifier |
| **Auto-Success Override** | `autoSuccessOnNatMax: false` | Natural max can still fail against high enough DC |

### 4.5 Configuration Examples

**Standard D20 System:**
```json
{
  "naturalMin": 1,
  "naturalMax": "max",
  "criticalMultiplier": 2,
  "criticalBonusDice": null,
  "autoFailOnNatMin": true,
  "autoSuccessOnNatMax": true
}
```

**Expanded Critical Range (19-20):**
```json
{
  "naturalMin": 1,
  "naturalMax": 19,
  "criticalMultiplier": 2,
  "criticalBonusDice": "1d6",
  "autoFailOnNatMin": true,
  "autoSuccessOnNatMax": false
}
```

---

## 5. AdvantageRules Schema Definition

### 5.1 Overview

The `AdvantageRules` definition specifies how advantage and disadvantage modify dice rolls. When a character has advantage, they roll extra dice and keep the best result; disadvantage works similarly but keeps the worst.

### 5.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `advantageDice` | integer | No | 1 | minimum: 1 | Number of extra dice rolled with advantage |
| `advantageKeep` | string | No | "Highest" | enum: Highest, Lowest | Which result to keep when rolling with advantage |
| `disadvantageDice` | integer | No | 1 | minimum: 1 | Number of extra dice rolled with disadvantage |
| `disadvantageKeep` | string | No | "Lowest" | enum: Highest, Lowest | Which result to keep when rolling with disadvantage |
| `stackable` | boolean | No | false | - | Whether multiple sources of advantage/disadvantage stack |

### 5.3 Schema Definition

```json
{
  "AdvantageRules": {
    "type": "object",
    "description": "Configuration for advantage and disadvantage mechanics",
    "properties": {
      "advantageDice": {
        "type": "integer",
        "description": "Number of extra dice rolled when the character has advantage",
        "minimum": 1,
        "default": 1
      },
      "advantageKeep": {
        "type": "string",
        "description": "Which result to keep when rolling with advantage",
        "enum": ["Highest", "Lowest"],
        "default": "Highest"
      },
      "disadvantageDice": {
        "type": "integer",
        "description": "Number of extra dice rolled when the character has disadvantage",
        "minimum": 1,
        "default": 1
      },
      "disadvantageKeep": {
        "type": "string",
        "description": "Which result to keep when rolling with disadvantage",
        "enum": ["Highest", "Lowest"],
        "default": "Lowest"
      },
      "stackable": {
        "type": "boolean",
        "description": "Whether multiple sources of advantage or disadvantage stack",
        "default": false
      }
    },
    "additionalProperties": false
  }
}
```

### 5.4 Behavior Rules

| Scenario | Dice Rolled | Result |
|----------|-------------|--------|
| **Normal Roll** | 1 die | Use the roll |
| **Advantage (default)** | 2 dice | Keep highest |
| **Disadvantage (default)** | 2 dice | Keep lowest |
| **Advantage + Disadvantage** | Cancel out (normal roll) | Use single roll |
| **Stackable Advantage x2** | 3 dice (if stackable: true) | Keep highest |

### 5.5 Configuration Examples

**Standard (D20-style):**
```json
{
  "advantageDice": 1,
  "advantageKeep": "Highest",
  "disadvantageDice": 1,
  "disadvantageKeep": "Lowest",
  "stackable": false
}
```

**Super Advantage (Roll 3, Keep Best):**
```json
{
  "advantageDice": 2,
  "advantageKeep": "Highest",
  "disadvantageDice": 2,
  "disadvantageKeep": "Lowest",
  "stackable": false
}
```

---

## 6. ExplodingDiceRules Schema Definition

### 6.1 Overview

The `ExplodingDiceRules` definition configures "exploding dice" mechanics where rolling the maximum value (or a threshold) allows rolling an additional die that adds to the total. This creates the possibility for exceptional results beyond the normal die range.

### 6.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `enabled` | boolean | No | false | - | Whether exploding dice are active |
| `explodeOn` | string | No | "Max" | enum: Max, Threshold | Trigger condition for explosion |
| `threshold` | integer\|null | No | null | minimum: 1 (when used) | Minimum value to trigger explosion (Threshold mode) |
| `maxExplosions` | integer | No | 10 | minimum: 1 | Maximum number of times a die can explode |
| `appliesToTypes` | array | No | [] | Array of die type IDs | Which die types can explode (empty = all) |

### 6.3 Schema Definition

```json
{
  "ExplodingDiceRules": {
    "type": "object",
    "description": "Configuration for exploding dice mechanics",
    "properties": {
      "enabled": {
        "type": "boolean",
        "description": "Whether exploding dice mechanics are active",
        "default": false
      },
      "explodeOn": {
        "type": "string",
        "description": "The condition that triggers a die to explode",
        "enum": ["Max", "Threshold"],
        "default": "Max"
      },
      "threshold": {
        "oneOf": [
          {
            "type": "integer",
            "minimum": 1,
            "description": "Minimum value that triggers explosion in Threshold mode"
          },
          {
            "type": "null"
          }
        ],
        "description": "The threshold value for Threshold mode (ignored if explodeOn is 'Max')",
        "default": null
      },
      "maxExplosions": {
        "type": "integer",
        "description": "Maximum number of times a single die can explode (prevents infinite loops)",
        "minimum": 1,
        "default": 10
      },
      "appliesToTypes": {
        "type": "array",
        "description": "Array of die type IDs that can explode (empty array means all die types)",
        "items": {
          "type": "string",
          "pattern": "^d\\d+$"
        },
        "default": []
      }
    },
    "additionalProperties": false
  }
}
```

### 6.4 Behavior Rules

| Mode | Trigger | Example (d6) |
|------|---------|--------------|
| **Max** | Roll equals die maximum | Roll 6 → explode |
| **Threshold** | Roll >= threshold | Threshold 5 → roll 5 or 6 explodes |
| **Disabled** | N/A | No explosions |

**Explosion Chain Example (d6, Max mode):**
```
Initial roll: 6 → explode!
Explosion 1:  6 → explode!
Explosion 2:  4 → stop
Total: 6 + 6 + 4 = 16
```

### 6.5 Configuration Examples

**Disabled (Default):**
```json
{
  "enabled": false,
  "explodeOn": "Max",
  "threshold": null,
  "maxExplosions": 10,
  "appliesToTypes": []
}
```

**Savage Worlds Style (Explode on Max):**
```json
{
  "enabled": true,
  "explodeOn": "Max",
  "threshold": null,
  "maxExplosions": 10,
  "appliesToTypes": []
}
```

**Threshold Explosion (d10 explodes on 9+):**
```json
{
  "enabled": true,
  "explodeOn": "Threshold",
  "threshold": 9,
  "maxExplosions": 5,
  "appliesToTypes": ["d10"]
}
```

---

## 7. KeepRules Schema Definition

### 7.1 Overview

The `KeepRules` definition configures which dice to keep or drop when rolling multiple dice. These rules modify the dice pool before calculating the final result.

### 7.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `keepHighest` | integer\|null | No | null | minimum: 1 (when used) | Keep only the N highest dice |
| `keepLowest` | integer\|null | No | null | minimum: 1 (when used) | Keep only the N lowest dice |
| `dropHighest` | integer\|null | No | null | minimum: 1 (when used) | Drop the N highest dice |

### 7.3 Schema Definition

```json
{
  "KeepRules": {
    "type": "object",
    "description": "Configuration for keeping or dropping dice from a roll",
    "properties": {
      "keepHighest": {
        "oneOf": [
          {
            "type": "integer",
            "minimum": 1,
            "description": "Number of highest dice to keep"
          },
          {
            "type": "null"
          }
        ],
        "description": "Keep only the N highest dice from the roll",
        "default": null
      },
      "keepLowest": {
        "oneOf": [
          {
            "type": "integer",
            "minimum": 1,
            "description": "Number of lowest dice to keep"
          },
          {
            "type": "null"
          }
        ],
        "description": "Keep only the N lowest dice from the roll",
        "default": null
      },
      "dropHighest": {
        "oneOf": [
          {
            "type": "integer",
            "minimum": 1,
            "description": "Number of highest dice to drop"
          },
          {
            "type": "null"
          }
        ],
        "description": "Drop the N highest dice from the roll",
        "default": null
      }
    },
    "additionalProperties": false
  }
}
```

### 7.4 Behavior Rules

| Rule | Example (4d6) | Result |
|------|---------------|--------|
| **keepHighest: 3** | Rolls: 2, 4, 5, 6 | Keep: 4, 5, 6 = 15 |
| **keepLowest: 2** | Rolls: 2, 4, 5, 6 | Keep: 2, 4 = 6 |
| **dropHighest: 1** | Rolls: 2, 4, 5, 6 | Keep: 2, 4, 5 = 11 |

**Note:** Only one keep/drop rule should be active at a time. If multiple are specified, `keepHighest` takes precedence, then `keepLowest`, then `dropHighest`.

### 7.5 Configuration Examples

**No Keep Rules (Default):**
```json
{
  "keepHighest": null,
  "keepLowest": null,
  "dropHighest": null
}
```

**D&D 5e Ability Score Generation (4d6 drop lowest):**
```json
{
  "keepHighest": 3,
  "keepLowest": null,
  "dropHighest": null
}
```

---

## 8. RerollRules Schema Definition

### 8.1 Overview

The `RerollRules` definition specifies conditions under which dice are automatically rerolled. This supports mechanics like "reroll 1s" or "reroll any die below 3".

### 8.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `rerollOnes` | boolean | No | false | - | Automatically reroll any die that shows 1 |
| `rerollBelow` | integer\|null | No | null | minimum: 1 (when used) | Reroll any die below this threshold |
| `maxRerolls` | integer | No | 1 | minimum: 1 | Maximum reroll attempts per die |
| `keepOriginalOnReroll` | boolean | No | false | - | Keep the original roll if reroll is worse |

### 8.3 Schema Definition

```json
{
  "RerollRules": {
    "type": "object",
    "description": "Configuration for automatic dice rerolling",
    "properties": {
      "rerollOnes": {
        "type": "boolean",
        "description": "Automatically reroll any die that shows a 1",
        "default": false
      },
      "rerollBelow": {
        "oneOf": [
          {
            "type": "integer",
            "minimum": 1,
            "description": "Threshold below which dice are rerolled"
          },
          {
            "type": "null"
          }
        ],
        "description": "Reroll any die that shows a value below this threshold",
        "default": null
      },
      "maxRerolls": {
        "type": "integer",
        "description": "Maximum number of times a single die can be rerolled",
        "minimum": 1,
        "default": 1
      },
      "keepOriginalOnReroll": {
        "type": "boolean",
        "description": "If true, keep the original roll if the reroll is worse",
        "default": false
      }
    },
    "additionalProperties": false
  }
}
```

### 8.4 Behavior Rules

| Rule | Initial Roll | Reroll | Final |
|------|--------------|--------|-------|
| **rerollOnes: true** | 1 | 4 | 4 |
| **rerollBelow: 3** | 2 | 5 | 5 |
| **keepOriginalOnReroll: true** | 2 → reroll → 1 | (original better) | 2 |
| **maxRerolls: 2** | 1 → 1 → 4 | (two rerolls) | 4 |

### 8.5 Configuration Examples

**No Rerolls (Default):**
```json
{
  "rerollOnes": false,
  "rerollBelow": null,
  "maxRerolls": 1,
  "keepOriginalOnReroll": false
}
```

**Great Weapon Fighting Style (Reroll 1s and 2s):**
```json
{
  "rerollOnes": false,
  "rerollBelow": 3,
  "maxRerolls": 1,
  "keepOriginalOnReroll": false
}
```

---

## 9. DefaultDice Schema Definition

### 9.1 Overview

The `DefaultDice` definition specifies which dice expressions are used by default for different roll categories. These can be overridden by specific abilities, weapons, or other game elements.

### 9.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `skillCheck` | string | No | "1d10" | Dice expression pattern | Default dice for skill checks |
| `attackRoll` | string | No | "1d20" | Dice expression pattern | Default dice for attack rolls |
| `saveRoll` | string | No | "1d20" | Dice expression pattern | Default dice for saving throws |
| `damageRoll` | string | No | "1d6" | Dice expression pattern | Default base damage dice |
| `initiativeRoll` | string | No | "1d10" | Dice expression pattern | Default dice for initiative |
| `healingRoll` | string | No | "1d8" | Dice expression pattern | Default base healing dice |

### 9.3 Schema Definition

```json
{
  "DefaultDice": {
    "type": "object",
    "description": "Default dice expressions for different roll categories",
    "properties": {
      "skillCheck": {
        "type": "string",
        "description": "Default dice expression for skill checks",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d10"
      },
      "attackRoll": {
        "type": "string",
        "description": "Default dice expression for attack rolls",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d20"
      },
      "saveRoll": {
        "type": "string",
        "description": "Default dice expression for saving throws",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d20"
      },
      "damageRoll": {
        "type": "string",
        "description": "Default dice expression for damage (typically overridden by weapon)",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d6"
      },
      "initiativeRoll": {
        "type": "string",
        "description": "Default dice expression for initiative rolls",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d10"
      },
      "healingRoll": {
        "type": "string",
        "description": "Default dice expression for healing (typically overridden by spell/ability)",
        "pattern": "^\\d+d\\d+([+-]\\d+)?$",
        "default": "1d8"
      }
    },
    "additionalProperties": false
  }
}
```

### 9.4 Roll Category Usage

| Category | When Used | Override Source |
|----------|-----------|-----------------|
| `skillCheck` | Skill-based actions against DC | Skill definition |
| `attackRoll` | Melee/ranged attacks to hit | Ability, weapon special |
| `saveRoll` | Resisting effects, avoiding hazards | Effect definition |
| `damageRoll` | Base damage when weapon not specified | Weapon damage |
| `initiativeRoll` | Determining turn order | Character abilities |
| `healingRoll` | Base healing when spell not specified | Spell/ability healing |

### 9.5 Configuration Examples

**Standard Configuration:**
```json
{
  "skillCheck": "1d10",
  "attackRoll": "1d20",
  "saveRoll": "1d20",
  "damageRoll": "1d6",
  "initiativeRoll": "1d10",
  "healingRoll": "1d8"
}
```

**D20-Only System:**
```json
{
  "skillCheck": "1d20",
  "attackRoll": "1d20",
  "saveRoll": "1d20",
  "damageRoll": "1d6",
  "initiativeRoll": "1d20",
  "healingRoll": "1d8"
}
```

---

## 10. DifficultyClass Schema Definition

### 10.1 Overview

The `DifficultyClass` definition provides named difficulty levels with associated target numbers. These serve as reference points for setting check DCs throughout the game.

### 10.2 Property Specifications

| Property | Type | Required | Default | Constraints | Description |
|----------|------|----------|---------|-------------|-------------|
| `id` | string | Yes | - | Pattern: `^[a-z][a-z0-9-]*$` | Unique identifier (kebab-case) |
| `name` | string | Yes | - | minLength: 1 | Display name for the difficulty |
| `dc` | integer | Yes | - | minimum: 1 | Target number to meet or exceed |
| `description` | string | No | - | - | Optional description of when to use |
| `sortOrder` | integer | No | 0 | minimum: 0 | Display ordering |

### 10.3 Schema Definition

```json
{
  "DifficultyClass": {
    "type": "object",
    "description": "A named difficulty level with target number",
    "properties": {
      "id": {
        "type": "string",
        "description": "Unique identifier for the difficulty class",
        "pattern": "^[a-z][a-z0-9-]*$"
      },
      "name": {
        "type": "string",
        "description": "Display name for the difficulty level",
        "minLength": 1
      },
      "dc": {
        "type": "integer",
        "description": "Target number that must be met or exceeded",
        "minimum": 1
      },
      "description": {
        "type": "string",
        "description": "Optional description of when this difficulty applies"
      },
      "sortOrder": {
        "type": "integer",
        "description": "Display ordering (lower numbers appear first)",
        "minimum": 0,
        "default": 0
      }
    },
    "required": ["id", "name", "dc"],
    "additionalProperties": false
  }
}
```

### 10.4 Standard Difficulty Classes

| ID | Name | DC | Description | Sort Order |
|----|------|-----|-------------|------------|
| `trivial` | Trivial | 5 | Almost automatic success | 0 |
| `easy` | Easy | 8 | Simple tasks most can accomplish | 1 |
| `moderate` | Moderate | 12 | Average difficulty requiring skill | 2 |
| `hard` | Hard | 16 | Challenging tasks requiring expertise | 3 |
| `very-hard` | Very Hard | 20 | Expert-level difficulty | 4 |
| `nearly-impossible` | Nearly Impossible | 25 | Legendary feats | 5 |

### 10.5 Configuration Example

```json
{
  "difficultyClasses": [
    {
      "id": "trivial",
      "name": "Trivial",
      "dc": 5,
      "description": "Almost automatic success for any trained character",
      "sortOrder": 0
    },
    {
      "id": "easy",
      "name": "Easy",
      "dc": 8,
      "description": "Simple tasks that most characters can accomplish",
      "sortOrder": 1
    },
    {
      "id": "moderate",
      "name": "Moderate",
      "dc": 12,
      "description": "Tasks requiring some skill or focus",
      "sortOrder": 2
    },
    {
      "id": "hard",
      "name": "Hard",
      "dc": 16,
      "description": "Challenging tasks requiring significant expertise",
      "sortOrder": 3
    },
    {
      "id": "very-hard",
      "name": "Very Hard",
      "dc": 20,
      "description": "Expert-level challenges that test masters",
      "sortOrder": 4
    },
    {
      "id": "nearly-impossible",
      "name": "Nearly Impossible",
      "dc": 25,
      "description": "Legendary feats that few can achieve",
      "sortOrder": 5
    }
  ]
}
```

---

## 11. JSON Schema Specification

### Complete Schema: `dice-mechanics.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-rust.dev/schemas/dice-mechanics.schema.json",
  "title": "Dice Mechanics Configuration",
  "description": "Schema for dice pool mechanics, roll modifiers, and difficulty classes",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to the JSON schema for validation"
    },
    "version": {
      "type": "string",
      "description": "Schema version for compatibility tracking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "criticalThresholds": {
      "$ref": "#/definitions/CriticalThresholds"
    },
    "advantageRules": {
      "$ref": "#/definitions/AdvantageRules"
    },
    "explodingDice": {
      "$ref": "#/definitions/ExplodingDiceRules"
    },
    "keepRules": {
      "$ref": "#/definitions/KeepRules"
    },
    "rerollRules": {
      "$ref": "#/definitions/RerollRules"
    },
    "defaultDice": {
      "$ref": "#/definitions/DefaultDice"
    },
    "difficultyClasses": {
      "type": "array",
      "description": "Array of difficulty class definitions",
      "items": {
        "$ref": "#/definitions/DifficultyClass"
      },
      "uniqueItems": true
    }
  },
  "required": ["criticalThresholds", "defaultDice"],
  "additionalProperties": false,
  "definitions": {
    "CriticalThresholds": {
      "type": "object",
      "description": "Configuration for critical success and failure thresholds",
      "properties": {
        "naturalMin": {
          "type": "integer",
          "description": "The die value that triggers a critical failure",
          "minimum": 1,
          "default": 1
        },
        "naturalMax": {
          "oneOf": [
            {
              "type": "string",
              "const": "max",
              "description": "Use the die's maximum value for critical success"
            },
            {
              "type": "integer",
              "minimum": 1,
              "description": "Specific value that triggers critical success"
            }
          ],
          "description": "The die value that triggers a critical success",
          "default": "max"
        },
        "criticalMultiplier": {
          "type": "number",
          "description": "Damage multiplier applied on critical hit",
          "minimum": 1,
          "default": 2
        },
        "criticalBonusDice": {
          "oneOf": [
            {
              "type": "string",
              "pattern": "^\\d+d\\d+([+-]\\d+)?$",
              "description": "Dice expression for bonus dice on critical"
            },
            {
              "type": "null"
            }
          ],
          "description": "Extra dice rolled on critical hit (e.g., '1d6')",
          "default": null
        },
        "autoFailOnNatMin": {
          "type": "boolean",
          "description": "Whether rolling natural minimum always fails regardless of modifiers",
          "default": true
        },
        "autoSuccessOnNatMax": {
          "type": "boolean",
          "description": "Whether rolling natural maximum always succeeds regardless of DC",
          "default": true
        }
      },
      "additionalProperties": false
    },
    "AdvantageRules": {
      "type": "object",
      "description": "Configuration for advantage and disadvantage mechanics",
      "properties": {
        "advantageDice": {
          "type": "integer",
          "description": "Number of extra dice rolled when the character has advantage",
          "minimum": 1,
          "default": 1
        },
        "advantageKeep": {
          "type": "string",
          "description": "Which result to keep when rolling with advantage",
          "enum": ["Highest", "Lowest"],
          "default": "Highest"
        },
        "disadvantageDice": {
          "type": "integer",
          "description": "Number of extra dice rolled when the character has disadvantage",
          "minimum": 1,
          "default": 1
        },
        "disadvantageKeep": {
          "type": "string",
          "description": "Which result to keep when rolling with disadvantage",
          "enum": ["Highest", "Lowest"],
          "default": "Lowest"
        },
        "stackable": {
          "type": "boolean",
          "description": "Whether multiple sources of advantage or disadvantage stack",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "ExplodingDiceRules": {
      "type": "object",
      "description": "Configuration for exploding dice mechanics",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether exploding dice mechanics are active",
          "default": false
        },
        "explodeOn": {
          "type": "string",
          "description": "The condition that triggers a die to explode",
          "enum": ["Max", "Threshold"],
          "default": "Max"
        },
        "threshold": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "description": "Minimum value that triggers explosion in Threshold mode"
            },
            {
              "type": "null"
            }
          ],
          "description": "The threshold value for Threshold mode (ignored if explodeOn is 'Max')",
          "default": null
        },
        "maxExplosions": {
          "type": "integer",
          "description": "Maximum number of times a single die can explode (prevents infinite loops)",
          "minimum": 1,
          "default": 10
        },
        "appliesToTypes": {
          "type": "array",
          "description": "Array of die type IDs that can explode (empty array means all die types)",
          "items": {
            "type": "string",
            "pattern": "^d\\d+$"
          },
          "default": []
        }
      },
      "additionalProperties": false
    },
    "KeepRules": {
      "type": "object",
      "description": "Configuration for keeping or dropping dice from a roll",
      "properties": {
        "keepHighest": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "description": "Number of highest dice to keep"
            },
            {
              "type": "null"
            }
          ],
          "description": "Keep only the N highest dice from the roll",
          "default": null
        },
        "keepLowest": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "description": "Number of lowest dice to keep"
            },
            {
              "type": "null"
            }
          ],
          "description": "Keep only the N lowest dice from the roll",
          "default": null
        },
        "dropHighest": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "description": "Number of highest dice to drop"
            },
            {
              "type": "null"
            }
          ],
          "description": "Drop the N highest dice from the roll",
          "default": null
        }
      },
      "additionalProperties": false
    },
    "RerollRules": {
      "type": "object",
      "description": "Configuration for automatic dice rerolling",
      "properties": {
        "rerollOnes": {
          "type": "boolean",
          "description": "Automatically reroll any die that shows a 1",
          "default": false
        },
        "rerollBelow": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 1,
              "description": "Threshold below which dice are rerolled"
            },
            {
              "type": "null"
            }
          ],
          "description": "Reroll any die that shows a value below this threshold",
          "default": null
        },
        "maxRerolls": {
          "type": "integer",
          "description": "Maximum number of times a single die can be rerolled",
          "minimum": 1,
          "default": 1
        },
        "keepOriginalOnReroll": {
          "type": "boolean",
          "description": "If true, keep the original roll if the reroll is worse",
          "default": false
        }
      },
      "additionalProperties": false
    },
    "DefaultDice": {
      "type": "object",
      "description": "Default dice expressions for different roll categories",
      "properties": {
        "skillCheck": {
          "type": "string",
          "description": "Default dice expression for skill checks",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d10"
        },
        "attackRoll": {
          "type": "string",
          "description": "Default dice expression for attack rolls",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d20"
        },
        "saveRoll": {
          "type": "string",
          "description": "Default dice expression for saving throws",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d20"
        },
        "damageRoll": {
          "type": "string",
          "description": "Default dice expression for damage (typically overridden by weapon)",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d6"
        },
        "initiativeRoll": {
          "type": "string",
          "description": "Default dice expression for initiative rolls",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d10"
        },
        "healingRoll": {
          "type": "string",
          "description": "Default dice expression for healing (typically overridden by spell/ability)",
          "pattern": "^\\d+d\\d+([+-]\\d+)?$",
          "default": "1d8"
        }
      },
      "additionalProperties": false
    },
    "DifficultyClass": {
      "type": "object",
      "description": "A named difficulty level with target number",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the difficulty class",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "name": {
          "type": "string",
          "description": "Display name for the difficulty level",
          "minLength": 1
        },
        "dc": {
          "type": "integer",
          "description": "Target number that must be met or exceeded",
          "minimum": 1
        },
        "description": {
          "type": "string",
          "description": "Optional description of when this difficulty applies"
        },
        "sortOrder": {
          "type": "integer",
          "description": "Display ordering (lower numbers appear first)",
          "minimum": 0,
          "default": 0
        }
      },
      "required": ["id", "name", "dc"],
      "additionalProperties": false
    }
  }
}
```

---

## 12. Configuration File

### Complete Configuration: `dice-mechanics.json`

```json
{
  "$schema": "./schemas/dice-mechanics.schema.json",
  "version": "0.14.8",
  "criticalThresholds": {
    "naturalMin": 1,
    "naturalMax": "max",
    "criticalMultiplier": 2,
    "criticalBonusDice": null,
    "autoFailOnNatMin": true,
    "autoSuccessOnNatMax": true
  },
  "advantageRules": {
    "advantageDice": 1,
    "advantageKeep": "Highest",
    "disadvantageDice": 1,
    "disadvantageKeep": "Lowest",
    "stackable": false
  },
  "explodingDice": {
    "enabled": false,
    "explodeOn": "Max",
    "threshold": null,
    "maxExplosions": 10,
    "appliesToTypes": []
  },
  "keepRules": {
    "keepHighest": null,
    "keepLowest": null,
    "dropHighest": null
  },
  "rerollRules": {
    "rerollOnes": false,
    "rerollBelow": null,
    "maxRerolls": 1,
    "keepOriginalOnReroll": false
  },
  "defaultDice": {
    "skillCheck": "1d10",
    "attackRoll": "1d20",
    "saveRoll": "1d20",
    "damageRoll": "1d6",
    "initiativeRoll": "1d10",
    "healingRoll": "1d8"
  },
  "difficultyClasses": [
    {
      "id": "trivial",
      "name": "Trivial",
      "dc": 5,
      "description": "Almost automatic success for any trained character",
      "sortOrder": 0
    },
    {
      "id": "easy",
      "name": "Easy",
      "dc": 8,
      "description": "Simple tasks that most characters can accomplish",
      "sortOrder": 1
    },
    {
      "id": "moderate",
      "name": "Moderate",
      "dc": 12,
      "description": "Tasks requiring some skill or focus",
      "sortOrder": 2
    },
    {
      "id": "hard",
      "name": "Hard",
      "dc": 16,
      "description": "Challenging tasks requiring significant expertise",
      "sortOrder": 3
    },
    {
      "id": "very-hard",
      "name": "Very Hard",
      "dc": 20,
      "description": "Expert-level challenges that test masters",
      "sortOrder": 4
    },
    {
      "id": "nearly-impossible",
      "name": "Nearly Impossible",
      "dc": 25,
      "description": "Legendary feats that few can achieve",
      "sortOrder": 5
    }
  ]
}
```

---

## 13. Unit Testing Requirements

### Test Specifications

| Test ID | Test Name | Description | Expected Result |
|---------|-----------|-------------|-----------------|
| **DMS-001** | Schema File Loads | Verify `dice-mechanics.schema.json` loads and parses as valid JSON | Schema parses without errors |
| **DMS-002** | Valid Configuration Passes | Validate complete `dice-mechanics.json` against schema | Validation passes |
| **DMS-003** | Invalid Critical Thresholds Rejected | Submit config with `criticalMultiplier: 0` | Validation fails with multiplier error |
| **DMS-004** | Invalid Difficulty Class Rejected | Submit DC with invalid ID pattern ("Easy" instead of "easy") | Validation fails with pattern error |
| **DMS-005** | Missing Required Fields Rejected | Submit config without `criticalThresholds` | Validation fails with required field error |
| **DMS-006** | Exploding Dice Validation | Validate `maxExplosions: 0` is rejected | Validation fails with minimum value error |

### Test Implementation Notes

```
Tests/Infrastructure/Configuration/
└── DiceMechanicsSchemaTests.cs
    ├── DMS_001_Schema_File_Loads_And_Parses()
    ├── DMS_002_Valid_Configuration_Passes_Validation()
    ├── DMS_003_Invalid_Critical_Multiplier_Rejected()
    ├── DMS_004_Invalid_Difficulty_Class_Id_Rejected()
    ├── DMS_005_Missing_Required_Fields_Rejected()
    └── DMS_006_Invalid_Max_Explosions_Rejected()
```

### Test Data Examples

**DMS-003: Invalid Critical Multiplier**
```json
{
  "criticalThresholds": {
    "naturalMin": 1,
    "naturalMax": "max",
    "criticalMultiplier": 0
  },
  "defaultDice": {
    "skillCheck": "1d10"
  }
}
```
*Expected Error:* `criticalMultiplier must be >= 1`

**DMS-004: Invalid Difficulty Class ID**
```json
{
  "criticalThresholds": { "naturalMin": 1 },
  "defaultDice": { "skillCheck": "1d10" },
  "difficultyClasses": [
    { "id": "Easy", "name": "Easy", "dc": 8 }
  ]
}
```
*Expected Error:* `id does not match pattern ^[a-z][a-z0-9-]*$`

**DMS-005: Missing Required Field**
```json
{
  "defaultDice": {
    "skillCheck": "1d10"
  }
}
```
*Expected Error:* `required property 'criticalThresholds' not found`

**DMS-006: Invalid Max Explosions**
```json
{
  "criticalThresholds": { "naturalMin": 1 },
  "defaultDice": { "skillCheck": "1d10" },
  "explodingDice": {
    "enabled": true,
    "maxExplosions": 0
  }
}
```
*Expected Error:* `maxExplosions must be >= 1`

---

## 14. Use Cases

### UC-001: Load Dice Mechanics Configuration

**Actor:** Game System
**Precondition:** `dice-mechanics.json` exists in config directory
**Flow:**
1. System reads `dice-mechanics.json` file
2. System validates against `dice-mechanics.schema.json`
3. System parses critical thresholds, default dice, and optional rules
4. System stores mechanics configuration for runtime use

**Postcondition:** Dice mechanics available for roll resolution

---

### UC-002: Resolve Attack Roll with Critical

**Actor:** Combat System
**Precondition:** Mechanics loaded, character attacks
**Flow:**
1. System retrieves `defaultDice.attackRoll` (1d20)
2. System rolls the die
3. System checks result against `criticalThresholds.naturalMax`
4. If critical, system applies `criticalMultiplier` and `criticalBonusDice`

**Postcondition:** Attack resolved with critical damage if applicable

---

### UC-003: Roll with Advantage

**Actor:** Combat System
**Precondition:** Character has advantage on roll
**Flow:**
1. System retrieves `advantageRules`
2. System rolls base die + `advantageDice` extra dice
3. System keeps result based on `advantageKeep` (Highest/Lowest)
4. System continues with kept result

**Postcondition:** Roll uses best of multiple dice

---

### UC-004: Lookup Difficulty Class

**Actor:** Skill System
**Precondition:** Check requires DC
**Flow:**
1. Designer specifies difficulty level (e.g., "hard")
2. System looks up DC from `difficultyClasses` by ID
3. System retrieves `dc` value (16 for "hard")
4. System compares roll result to DC

**Postcondition:** Check resolved against named difficulty

---

### UC-005: Apply Exploding Dice

**Actor:** Dice Rolling System
**Precondition:** `explodingDice.enabled` is true
**Flow:**
1. System rolls initial die
2. If result matches `explodeOn` condition (Max or Threshold)
3. System rolls additional die and adds to total
4. Process repeats up to `maxExplosions` times
5. Final total calculated

**Postcondition:** Exploding dice total calculated with safety limit

---

## 15. Deliverable Checklist

### Schema Files

- [ ] `config/schemas/dice-mechanics.schema.json` created
- [ ] Schema uses JSON Schema Draft-07 format
- [ ] Schema includes all 7 definitions
- [ ] Schema validates required fields
- [ ] Schema documents all properties

### Configuration Files

- [ ] `config/dice-mechanics.json` created
- [ ] Configuration references schema
- [ ] All required fields present
- [ ] Default values appropriate
- [ ] 6 difficulty classes defined

### Documentation

- [ ] Design specification complete (this document)
- [ ] Schema definitions documented
- [ ] Behavior rules documented
- [ ] Configuration examples provided

### Unit Tests

- [ ] DMS-001: Schema file loads
- [ ] DMS-002: Valid configuration passes
- [ ] DMS-003: Invalid critical thresholds rejected
- [ ] DMS-004: Invalid difficulty class rejected
- [ ] DMS-005: Missing required fields rejected
- [ ] DMS-006: Exploding dice validation

---

## 16. Acceptance Criteria

### Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-01 | Schema file loads and parses as valid JSON | Unit test DMS-001 |
| AC-02 | Valid configuration passes schema validation | Unit test DMS-002 |
| AC-03 | Critical threshold multiplier validated >= 1 | Unit test DMS-003 |
| AC-04 | Difficulty class ID pattern validated | Unit test DMS-004 |
| AC-05 | Required fields (criticalThresholds, defaultDice) enforced | Unit test DMS-005 |
| AC-06 | Exploding dice maxExplosions validated >= 1 | Unit test DMS-006 |
| AC-07 | Default dice expressions validated against pattern | Schema pattern check |
| AC-08 | Advantage keep enum validated (Highest/Lowest) | Schema enum check |
| AC-09 | Explode on enum validated (Max/Threshold) | Schema enum check |
| AC-10 | Difficulty classes have unique IDs | Schema uniqueItems |

### Quality Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| QC-01 | Schema follows Draft-07 specification | Schema validator |
| QC-02 | All properties have descriptions | Schema review |
| QC-03 | Default values documented | Schema defaults |
| QC-04 | Configuration file properly formatted | JSON linter |
| QC-05 | ~6 unit tests implemented | Test count |
| QC-06 | No additionalProperties allowed | Schema review |

---

## 17. Dependencies

### Required From

| Version | Component | Usage |
|---------|-----------|-------|
| v0.14.8a | `dice-types.schema.json` | Die type ID pattern for `appliesToTypes` |
| v0.14.8a | Dice expression pattern | Used in `defaultDice` and `criticalBonusDice` |

### Provides To

| Version | Component | Usage |
|---------|-----------|-------|
| Future | Combat System | Critical thresholds, advantage rules |
| Future | Skill System | Default dice, difficulty classes |
| Future | Roll Resolution | All mechanics rules |

### Schema Integration

```
v0.14.8a                          v0.14.8b
┌─────────────────────┐           ┌─────────────────────┐
│ dice-types.schema   │           │ dice-mechanics      │
│ ├── DieType         │◄──────────│ ├── appliesToTypes  │
│ └── DiceExpression  │◄──────────│ ├── defaultDice.*   │
│     pattern         │           │ └── criticalBonus   │
└─────────────────────┘           │     Dice            │
                                  └─────────────────────┘
```

---

## 18. Future Considerations

### Deferred to Later Versions

| Feature | Reason | Potential Version |
|---------|--------|-------------------|
| Roll execution logic | Runtime implementation | v0.15+ |
| Probability calculations | Runtime concern | v0.15+ |
| Custom roll formulas | Requires expression parser | v0.15+ |
| Roll history tracking | Runtime feature | v0.16+ |

### Potential Extensions

| Extension | Description |
|-----------|-------------|
| **Conditional Criticals** | Critical range expansion based on character abilities |
| **Situational Advantage** | Context-specific advantage/disadvantage rules |
| **Roll Macros** | Predefined roll combinations for common actions |
| **DC Scaling** | Level-based difficulty class adjustments |

### Backward Compatibility

- Schema changes should maintain backward compatibility
- New optional fields can be added without breaking existing configs
- Existing dice expressions in other configs remain valid

---

## Appendix A: Validation Examples

### Valid Configuration (Minimal)

```json
{
  "$schema": "./schemas/dice-mechanics.schema.json",
  "criticalThresholds": {
    "naturalMin": 1,
    "naturalMax": "max"
  },
  "defaultDice": {
    "skillCheck": "1d10",
    "attackRoll": "1d20"
  }
}
```
*Result:* ✅ Validation passes (other defaultDice fields use schema defaults)

### Invalid: Critical Multiplier Below Minimum

```json
{
  "criticalThresholds": {
    "criticalMultiplier": 0.5
  },
  "defaultDice": {
    "skillCheck": "1d10"
  }
}
```
*Result:* ❌ `criticalMultiplier must be >= 1`

### Invalid: Bad Dice Expression Pattern

```json
{
  "criticalThresholds": {},
  "defaultDice": {
    "skillCheck": "d10"
  }
}
```
*Result:* ❌ `skillCheck does not match pattern ^\d+d\d+([+-]\d+)?$`

### Invalid: Exploding Dice Type Pattern

```json
{
  "criticalThresholds": {},
  "defaultDice": { "skillCheck": "1d10" },
  "explodingDice": {
    "appliesToTypes": ["D6", "six-sided"]
  }
}
```
*Result:* ❌ `appliesToTypes items must match pattern ^d\d+$`

### Invalid: Difficulty Class Missing Required Field

```json
{
  "criticalThresholds": {},
  "defaultDice": { "skillCheck": "1d10" },
  "difficultyClasses": [
    { "id": "easy", "name": "Easy" }
  ]
}
```
*Result:* ❌ `required property 'dc' not found`

---

## Appendix B: Mechanics Reference Tables

### B.1 Critical Threshold Defaults

| Property | Default | Description |
|----------|---------|-------------|
| naturalMin | 1 | Natural 1 is critical failure |
| naturalMax | "max" | Die maximum is critical success |
| criticalMultiplier | 2 | Double damage on crit |
| criticalBonusDice | null | No extra dice |
| autoFailOnNatMin | true | Natural 1 always fails |
| autoSuccessOnNatMax | true | Natural max always succeeds |

### B.2 Advantage Rule Defaults

| Property | Default | Description |
|----------|---------|-------------|
| advantageDice | 1 | Roll 1 extra die |
| advantageKeep | "Highest" | Keep best result |
| disadvantageDice | 1 | Roll 1 extra die |
| disadvantageKeep | "Lowest" | Keep worst result |
| stackable | false | Multiple sources don't stack |

### B.3 Default Dice Assignments

| Category | Default | Typical Use |
|----------|---------|-------------|
| skillCheck | 1d10 | Skills vs DC |
| attackRoll | 1d20 | Attack vs AC |
| saveRoll | 1d20 | Saves vs DC |
| damageRoll | 1d6 | Unarmed/base damage |
| initiativeRoll | 1d10 | Turn order |
| healingRoll | 1d8 | Base healing |

### B.4 Standard Difficulty Classes

| ID | Name | DC | Probability (1d20) |
|----|------|-----|-------------------|
| trivial | Trivial | 5 | 80% |
| easy | Easy | 8 | 65% |
| moderate | Moderate | 12 | 45% |
| hard | Hard | 16 | 25% |
| very-hard | Very Hard | 20 | 5% |
| nearly-impossible | Nearly Impossible | 25 | 0% (requires bonuses) |

---

*This design specification provides a complete blueprint for implementing v0.14.8b Dice Mechanics Schema. The schema enables full customization of dice roll mechanics including criticals, advantage/disadvantage, exploding dice, keep/drop rules, rerolls, default dice, and difficulty classes—all configurable without code changes.*
