# v0.18.5d Design Specification: Turn-Based Integration

**Version:** 0.18.5d
**Parent:** v0.18.5 (Resource Integration / Trauma Economy Integration)
**Prerequisites:** v0.18.5a (TraumaEconomyState), All v0.18.0-4
**Status:** Design Complete
**Estimated Unit Tests:** ~4

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [TurnIntegrationResult Value Object](#5-turnintegrationresult-value-object)
6. [UnifiedTurnHandler Service](#6-unifiedturnhandler-service)
7. [Turn-Based Effects](#7-turn-based-effects)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Deliverable Checklist](#10-deliverable-checklist)
11. [Acceptance Criteria](#11-acceptance-criteria)
12. [Dependencies](#12-dependencies)
13. [Future Considerations](#13-future-considerations)

---

## 1. Executive Summary

This design specification defines the **unified per-turn processing layer** that coordinates ongoing effects across all trauma economy systems during combat and exploration.

v0.18.5d establishes **Turn-Based Integration** by defining:

- `TurnIntegrationResult` value object — comprehensive turn outcome
- `UnifiedTurnHandler` service — coordinates per-turn effects
- Combat vs. non-combat resource decay (Rage, Momentum)
- Apotheosis stress cost and auto-exit mechanics
- Panic Table triggers and environmental effects

### Key Deliverables

| Category            | Items                                         |
| ------------------- | --------------------------------------------- |
| **Value Objects**   | `TurnIntegrationResult`                       |
| **Services**        | `UnifiedTurnHandler`                          |
| **Tests**           | ~4 unit tests                                 |

### Turn Flow Overview

```
Turn Start → Apply Effects → Check Conditions → Turn End → Result
```

---

## 2. Feature Overview

```
v0.18.5d Features
└── Unified Turn-Based Processing
    │
    ├── TurnIntegrationResult Value Object
    │   ├── TurnNumber & IsInCombat
    │   ├── StressChanges (net change)
    │   ├── RageDecay (if out of combat)
    │   ├── MomentumDecay (if idle)
    │   ├── ApotheosisStressCost
    │   ├── ApotheosisEnded
    │   ├── CpsEffectsApplied
    │   ├── EnvironmentalStress
    │   ├── TraumaTriggersChecked
    │   └── TurnMessages
    │
    └── UnifiedTurnHandler Service
        ├── ProcessTurnStart() orchestration
        ├── ProcessTurnEnd() orchestration
        ├── ApplyResourceDecay() (combat vs. idle)
        ├── ApplyApotheosisStress()
        ├── CheckCpsThresholds()
        ├── CheckTraumaTriggers()
        └── BuildResultObject()
```

---

## 3. Architecture Diagrams

### 3.1 Turn Processing Pipeline (Start Phase)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   TURN START PROCESSING                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│     ┌─────────────────────────────────────────────────────────────────┐ │
│     │  1. CHECK COMBAT STATUS                                         │ │
│     ├─────────────────────────────────────────────────────────────────┤ │
│     │  • In combat: No resource decay                                 │ │
│     │  • Out of combat: Apply decay                                   │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  2. APPLY RESOURCE DECAY                                        │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  Berserker (out of combat): Rage -10/turn                      │ │
│     │  Storm Blade (idle):         Momentum -15/turn                 │ │
│     │  Arcanist (idle):            Coherence mediatable              │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  3. APPLY APOTHEOSIS STRESS                                     │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  If in Apotheosis: +10 stress per turn                         │ │
│     │  Check auto-exit at stress ≥ 100                               │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  4. RECORD RESULT                                               │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • Store stress changes                                        │ │
│     │  • Store resource decay                                        │ │
│     │  • Generate turn messages                                      │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│                        ▼                                                 │
│            TurnIntegrationResult returned                                │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Turn Processing Pipeline (End Phase)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    TURN END PROCESSING                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│     ┌─────────────────────────────────────────────────────────────────┐ │
│     │  1. CHECK STRESS THRESHOLDS                                     │ │
│     ├─────────────────────────────────────────────────────────────────┤ │
│     │  • If Stress ≥ 60 (RuinMadness): Check Panic Table             │ │
│     │  • Roll d10 for panic effect                                    │ │
│     │  • Apply panic effect to character                             │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  2. APPLY CPS EFFECTS                                           │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • If Stage ≥ WeightOfKnowing: UI distortions                  │ │
│     │  • If Stage ≥ GlimmerMadness: Perception unreliable            │ │
│     │  • If Stage ≥ RuinMadness: Panic table active                  │ │
│     │  • If Stage == HollowShell: Critical situation                  │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  3. CHECK TRAUMA TRIGGERS                                       │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • Environmental trauma (hazard exposure)                       │ │
│     │  • Witnessing trauma (ally affected events)                     │ │
│     │  • Accumulation trauma (too many active)                        │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  4. APPLY ENVIRONMENTAL EFFECTS                                 │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • Environmental stress (+1 to +5 per turn)                     │ │
│     │  • Hazard effects (poison, bleeding, cursed)                    │ │
│     │  • Location effects (cursed ground, corruption)                 │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  5. RECORD RESULT                                               │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • Store all threshold crossings                               │ │
│     │  • Generate end-of-turn messages                               │ │
│     │  • Return result                                               │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│                        ▼                                                 │
│            TurnIntegrationResult returned                                │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Resource Decay Decision Tree

```
                    START OF TURN
                         │
                ┌────────┴────────┐
                │                 │
                ▼                 ▼
          In Combat           Out of Combat
                │                 │
        ┌───────┼───────┐        │
        │       │       │        │
        ▼       ▼       ▼        ▼
    Rage   Momentum Coherence  Apply Decay
      │       │        │        │
      │       │        │    ┌───┼────┬─────────┐
      ▼       ▼        ▼    │   │    │         │
   No Change No Change No   │   ▼    ▼         ▼
              Idle Check   Rage   Momentum  Coherence
                           -10    -15       (no decay,
                           /turn  /turn      meditate)
                           │       │
                           └───┬───┘
                               │
                               ▼
                    Record in Result
```

### 3.4 Apotheosis Stress Escalation

```
                Apotheosis Active
                        │
           ┌────────────┴─────────────┐
           │                          │
        Turn 1                     Turn N
           │                          │
           ▼                          ▼
      +10 Stress                 +10 Stress
           │                          │
           ├─ Total: 10              ├─ Total: 10N
           │                          │
           └──────────────┬───────────┘
                          │
              ┌───────────┼───────────┐
              │           │           │
              ▼           ▼           ▼
         Stress <100 Stress =100  Stress >100
         Continue    Auto-Exit    Auto-Exit
         Apotheosis  + Message    + Message
                     (should not
                      happen)
```

---

## 4. User Stories

### US-18.5d-1: Process Unified Turn Start

**As a** combat system
**I want to** process turn start effects through all trauma economy systems
**So that** ongoing costs are applied and resources decay appropriately

**Acceptance Criteria:**

- Resource decay applied only when out of combat
- Apotheosis stress cost applied each turn
- Result records all changes
- Decay rates consistent with specialization rules
- Message generated for each effect

### US-18.5d-2: Process Unified Turn End

**As a** combat system
**I want to** process turn end effects through all trauma economy systems
**So that** threshold checks occur and ongoing damage applies

**Acceptance Criteria:**

- Panic Table triggers at RuinMadness
- CPS effects applied based on stage
- Environmental stress accumulates
- Trauma triggers checked
- Result records all threshold crossings

### US-18.5d-3: Apply Resource Decay

**As a** specialization system
**I want to** decay resources naturally over time when not in use
**So that** Rage/Momentum/Coherence don't persist indefinitely

**Acceptance Criteria:**

- Rage decays 10/turn outside combat
- Momentum decays 15/turn when idle
- Decay only occurs out of combat
- Decay recorded in result
- Decay can't reduce below 0

### US-18.5d-4: Manage Apotheosis Stress Cost

**As a** Arcanist power system
**I want to** impose growing stress cost for Apotheosis usage
**So that** maintaining the form is progressively difficult

**Acceptance Criteria:**

- Apotheosis costs 10 stress per turn
- Cost applied at turn start
- Cost accumulates each turn in Apotheosis
- Auto-exit triggers at 100 stress
- Auto-exit generates narrative message

---

## 5. TurnIntegrationResult Value Object

### 5.1 Purpose

Comprehensive record of all per-turn effects processed across all trauma economy systems.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TurnIntegrationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Immutable value object representing the complete outcome of turn processing.
/// </summary>
/// <remarks>
/// <para>
/// Captures all per-turn effects across trauma economy systems:
/// resource decay, Apotheosis costs, CPS effects, and trauma checks.
/// </para>
/// <para>
/// Used for:
/// • Tracking combat/exploration progression
/// • Logging per-turn state changes
/// • Generating turn-specific narratives
/// • Creating save/replay data
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var result = handler.ProcessTurnStart(characterId, isInCombat: true);
/// if (result.ApotheosisEnded)
/// {
///     logger.LogInformation("Apotheosis ended: {Message}", result.TurnMessages[0]);
/// }
/// </code>
/// </example>
public readonly record struct TurnIntegrationResult(
    int TurnNumber,
    bool IsInCombat,
    int StressChanges,
    int? RageDecay,
    int? MomentumDecay,
    int? ApotheosisStressCost,
    bool ApotheosisEnded,
    IReadOnlyList<string>? CpsEffectsApplied,
    int? EnvironmentalStress,
    IReadOnlyList<string>? TraumaTriggersChecked,
    IReadOnlyList<string> TurnMessages)
{
    #region Computed Properties

    /// <summary>
    /// Gets the total resource loss for this turn (Rage + Momentum combined).
    /// </summary>
    public int TotalResourceLoss =>
        (RageDecay ?? 0) + (MomentumDecay ?? 0);

    /// <summary>
    /// Gets whether any CPS effects were triggered this turn.
    /// </summary>
    public bool CpsEffectsTriggered =>
        CpsEffectsApplied?.Count > 0;

    /// <summary>
    /// Gets whether any trauma triggers were checked.
    /// </summary>
    public bool TraumaChecksPending =>
        TraumaTriggersChecked?.Count > 0;

    /// <summary>
    /// Gets the net stress change direction.
    /// </summary>
    public string StressDirection =>
        StressChanges switch
        {
            > 0 => "increasing",
            < 0 => "decreasing",
            _ => "stable"
        };

    #endregion

    #region Validation

    /// <summary>
    /// Validates result for consistency.
    /// </summary>
    public bool IsValid()
    {
        // Turn number should be positive
        if (TurnNumber < 1)
            return false;

        // Stress changes should not exceed reasonable bounds
        if (Math.Abs(StressChanges) > 50)
            return false;

        // Resource decays should be non-negative if present
        if (RageDecay.HasValue && RageDecay < 0)
            return false;
        if (MomentumDecay.HasValue && MomentumDecay < 0)
            return false;

        // Apotheosis cost should be positive if present
        if (ApotheosisStressCost.HasValue && ApotheosisStressCost <= 0)
            return false;

        // Environmental stress should be non-negative if present
        if (EnvironmentalStress.HasValue && EnvironmentalStress < 0)
            return false;

        // If Apotheosis ended, cost should be present
        if (ApotheosisEnded && !ApotheosisStressCost.HasValue)
            return false;

        return true;
    }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new TurnIntegrationResult from components.
    /// </summary>
    public static TurnIntegrationResult Create(
        int turnNumber,
        bool isInCombat,
        int stressChanges = 0,
        int? rageDecay = null,
        int? momentumDecay = null,
        int? apotheosisStressCost = null,
        bool apotheosisEnded = false,
        IReadOnlyList<string>? cpsEffectsApplied = null,
        int? environmentalStress = null,
        IReadOnlyList<string>? traumaTriggersChecked = null,
        IReadOnlyList<string>? turnMessages = null)
    {
        return new TurnIntegrationResult(
            TurnNumber: turnNumber,
            IsInCombat: isInCombat,
            StressChanges: stressChanges,
            RageDecay: rageDecay,
            MomentumDecay: momentumDecay,
            ApotheosisStressCost: apotheosisStressCost,
            ApotheosisEnded: apotheosisEnded,
            CpsEffectsApplied: cpsEffectsApplied ?? new List<string>().AsReadOnly(),
            EnvironmentalStress: environmentalStress,
            TraumaTriggersChecked: traumaTriggersChecked ?? new List<string>().AsReadOnly(),
            TurnMessages: turnMessages ?? new List<string>().AsReadOnly()
        );
    }

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"Turn {TurnNumber} [{(IsInCombat ? "Combat" : "Exploration")}]: " +
        $"Stress {StressDirection} {Math.Abs(StressChanges)}" +
        (RageDecay.HasValue ? $", Rage -{RageDecay}" : "") +
        (MomentumDecay.HasValue ? $", Momentum -{MomentumDecay}" : "") +
        (ApotheosisStressCost.HasValue ? $", Apotheosis -{ApotheosisStressCost}" : "");

    #endregion
}
```

---

## 6. UnifiedTurnHandler Service

### 6.1 Purpose

Application service that orchestrates per-turn effects across all trauma economy systems.

### 6.2 Definition

**File:** `src/Application/RuneAndRust.Application/Services/UnifiedTurnHandler.cs`

```csharp
namespace RuneAndRust.Application.Services;

using RuneAndRust.Domain.ValueObjects;
using RuneAndRust.Domain.Enums;
using Microsoft.Extensions.Logging;

/// <summary>
/// Coordinates per-turn processing across all trauma economy systems.
/// </summary>
/// <remarks>
/// <para>
/// Orchestrates per-turn effects:
/// 1. Apply resource decay (if out of combat)
/// 2. Apply Apotheosis stress cost
/// 3. Check CPS thresholds and trigger Panic Table
/// 4. Apply environmental effects
/// 5. Check trauma triggers
/// 6. Aggregate result
/// </para>
/// </remarks>
public class UnifiedTurnHandler
{
    private readonly IStressService _stressService;
    private readonly IRageService? _rageService;
    private readonly IMomentumService? _momentumService;
    private readonly ICoherenceService? _coherenceService;
    private readonly ITraumaService _traumaService;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IDiceService _diceService;
    private readonly ILogger<UnifiedTurnHandler> _logger;

    public UnifiedTurnHandler(
        IStressService stressService,
        ITraumaService traumaService,
        ISpecializationProvider specializationProvider,
        IDiceService diceService,
        IRageService? rageService = null,
        IMomentumService? momentumService = null,
        ICoherenceService? coherenceService = null,
        ILogger<UnifiedTurnHandler>? logger = null)
    {
        _stressService = stressService;
        _traumaService = traumaService;
        _specializationProvider = specializationProvider;
        _diceService = diceService;
        _rageService = rageService;
        _momentumService = momentumService;
        _coherenceService = coherenceService;
        _logger = logger ?? NullLogger<UnifiedTurnHandler>.Instance;
    }

    /// <summary>
    /// Processes turn start effects for all trauma economy systems.
    /// </summary>
    /// <param name="characterId">The character taking a turn.</param>
    /// <param name="turnNumber">The current turn number.</param>
    /// <param name="isInCombat">Whether the character is in combat.</param>
    /// <returns>Complete turn integration result.</returns>
    public TurnIntegrationResult ProcessTurnStart(
        Guid characterId,
        int turnNumber,
        bool isInCombat)
    {
        _logger.LogDebug("Processing turn start for {CharacterId}: Turn {Turn}, Combat={Combat}",
            characterId, turnNumber, isInCombat);

        var messages = new List<string>();
        int? rageDecay = null;
        int? momentumDecay = null;

        // 1. Apply resource decay (only outside combat)
        if (!isInCombat)
        {
            rageDecay = ApplyRageDecay(characterId);
            if (rageDecay.HasValue && rageDecay > 0)
                messages.Add($"Rage subsides ({-rageDecay}/turn).");

            momentumDecay = ApplyMomentumDecay(characterId);
            if (momentumDecay.HasValue && momentumDecay > 0)
                messages.Add($"Momentum slips away ({-momentumDecay}/turn).");
        }

        // 2. Apply Apotheosis stress cost
        var (apotheosisStressCost, apotheosisEnded) = ApplyApotheosisStress(characterId);
        if (apotheosisStressCost.HasValue)
        {
            if (apotheosisEnded)
            {
                messages.Add("Apotheosis shatters—reality reasserts itself!");
            }
            else
            {
                messages.Add($"Apotheosis strains your mind ({apotheosisStressCost} stress).");
            }
        }

        var result = TurnIntegrationResult.Create(
            turnNumber: turnNumber,
            isInCombat: isInCombat,
            stressChanges: apotheosisStressCost ?? 0,
            rageDecay: rageDecay,
            momentumDecay: momentumDecay,
            apotheosisStressCost: apotheosisStressCost,
            apotheosisEnded: apotheosisEnded,
            turnMessages: messages.AsReadOnly()
        );

        _logger.LogDebug("Turn start processed: {@Result}", result);
        return result;
    }

    /// <summary>
    /// Processes turn end effects for all trauma economy systems.
    /// </summary>
    /// <param name="characterId">The character completing a turn.</param>
    /// <param name="turnNumber">The current turn number.</param>
    /// <param name="isInCombat">Whether the character is in combat.</param>
    /// <param name="environmentalStress">Optional environmental stress this turn (0-5).</param>
    /// <returns>Complete turn integration result.</returns>
    public TurnIntegrationResult ProcessTurnEnd(
        Guid characterId,
        int turnNumber,
        bool isInCombat,
        int? environmentalStress = null)
    {
        _logger.LogDebug("Processing turn end for {CharacterId}: Turn {Turn}, Env Stress={Env}",
            characterId, turnNumber, environmentalStress ?? 0);

        var messages = new List<string>();
        var cpsEffects = new List<string>();
        var traumaTriggers = new List<string>();

        // 1. Check stress thresholds and panic
        var panicEffect = CheckPanicTable(characterId);
        if (panicEffect != PanicEffect.None)
        {
            messages.Add($"Panic grips you: {panicEffect}");
            cpsEffects.Add(panicEffect.ToString());
        }

        // 2. Apply CPS effects
        var cpsStageEffects = ApplyCpsEffects(characterId);
        cpsEffects.AddRange(cpsStageEffects);

        // 3. Apply environmental stress
        var totalEnvironmentalStress = ApplyEnvironmentalStress(characterId, environmentalStress ?? 0);
        if (totalEnvironmentalStress > 0)
            messages.Add($"The environment grinds at your sanity (+{totalEnvironmentalStress} stress).");

        // 4. Check trauma triggers
        var traumasTriggered = CheckTraumaTriggers(characterId, isInCombat);
        traumaTriggers.AddRange(traumasTriggered);

        var result = TurnIntegrationResult.Create(
            turnNumber: turnNumber,
            isInCombat: isInCombat,
            stressChanges: totalEnvironmentalStress,
            cpsEffectsApplied: cpsEffects.AsReadOnly(),
            environmentalStress: totalEnvironmentalStress,
            traumaTriggersChecked: traumaTriggers.AsReadOnly(),
            turnMessages: messages.AsReadOnly()
        );

        _logger.LogDebug("Turn end processed: {@Result}", result);
        return result;
    }

    /// <summary>
    /// Applies Rage decay outside of combat.
    /// </summary>
    /// <remarks>
    /// Berserker loses 10 rage per turn outside combat.
    /// </remarks>
    private int? ApplyRageDecay(Guid characterId)
    {
        if (_rageService == null)
            return null;

        var rageState = _rageService.GetRage(characterId);
        if (!rageState.IsActive || rageState.CurrentRage == 0)
            return null;

        var decayAmount = 10;
        var newRage = Math.Max(0, rageState.CurrentRage - decayAmount);
        _rageService.SetRage(characterId, newRage);

        return decayAmount;
    }

    /// <summary>
    /// Applies Momentum decay when idle.
    /// </summary>
    /// <remarks>
    /// Storm Blade loses 15 momentum per turn when not in combat or active.
    /// </remarks>
    private int? ApplyMomentumDecay(Guid characterId)
    {
        if (_momentumService == null)
            return null;

        var momentumState = _momentumService.GetMomentum(characterId);
        if (!momentumState.IsActive || momentumState.CurrentMomentum == 0)
            return null;

        var decayAmount = 15;
        var newMomentum = Math.Max(0, momentumState.CurrentMomentum - decayAmount);
        _momentumService.SetMomentum(characterId, newMomentum);

        return decayAmount;
    }

    /// <summary>
    /// Applies Apotheosis stress cost and checks for auto-exit.
    /// </summary>
    /// <remarks>
    /// Arcanist in Apotheosis pays 10 stress per turn.
    /// Auto-exits if stress reaches 100.
    /// </remarks>
    private (int? stressCost, bool apotheosisEnded) ApplyApotheosisStress(Guid characterId)
    {
        if (_coherenceService == null)
            return (null, false);

        var coherenceState = _coherenceService.GetCoherence(characterId);
        if (!coherenceState.InApotheosis)
            return (null, false);

        const int apotheosisStressCost = 10;

        // Apply stress
        var stressResult = _stressService.AddStress(
            characterId,
            apotheosisStressCost,
            StressSource.ApotheosisStrain
        );

        // Check for auto-exit
        bool apotheosisEnded = false;
        if (stressResult.NewStress >= 100)
        {
            _coherenceService.ForceExitApotheosis(
                characterId,
                "Stress overflow—Apotheosis shattered");
            apotheosisEnded = true;
        }

        return (apotheosisStressCost, apotheosisEnded);
    }

    /// <summary>
    /// Checks if Panic Table should trigger and rolls effect.
    /// </summary>
    /// <remarks>
    /// Panic Table triggers when character in RuinMadness stage (Stress 60-79)
    /// at turn end.
    /// </remarks>
    private PanicEffect CheckPanicTable(Guid characterId)
    {
        var stressState = _stressService.GetStress(characterId);
        var cpsState = CpsState.Create(stressState.CurrentStress);

        if (cpsState.Stage != CpsStage.RuinMadness)
            return PanicEffect.None;

        // Roll d10 for panic effect
        var roll = _diceService.Roll(10, 1);
        return roll switch
        {
            1 => PanicEffect.Frozen,
            2 => PanicEffect.Scream,
            3 => PanicEffect.Flee,
            4 => PanicEffect.Fetal,
            5 => PanicEffect.Blackout,
            6 => PanicEffect.Denial,
            7 => PanicEffect.Violence,
            8 => PanicEffect.Catatonia,
            9 => PanicEffect.Dissociation,
            _ => PanicEffect.None
        };
    }

    /// <summary>
    /// Applies effects based on CPS stage.
    /// </summary>
    private List<string> ApplyCpsEffects(Guid characterId)
    {
        var stressState = _stressService.GetStress(characterId);
        var cpsState = CpsState.Create(stressState.CurrentStress);

        var effects = new List<string>();

        if (cpsState.Stage >= CpsStage.WeightOfKnowing)
            effects.Add("UI_Distortion_Minor");

        if (cpsState.Stage >= CpsStage.GlimmerMadness)
            effects.Add("Perception_Unreliable");

        if (cpsState.Stage >= CpsStage.RuinMadness)
            effects.Add("PanicTableActive");

        if (cpsState.Stage == CpsStage.HollowShell)
            effects.Add("Terminal_CPS");

        return effects;
    }

    /// <summary>
    /// Applies environmental stress accumulation.
    /// </summary>
    private int ApplyEnvironmentalStress(Guid characterId, int environmentalStress)
    {
        if (environmentalStress <= 0)
            return 0;

        var clamped = Math.Clamp(environmentalStress, 0, 5);
        _stressService.AddStress(characterId, clamped, StressSource.Environmental);

        return clamped;
    }

    /// <summary>
    /// Checks for trauma triggers from ongoing exposure.
    /// </summary>
    private List<string> CheckTraumaTriggers(Guid characterId, bool isInCombat)
    {
        var triggers = new List<string>();

        // TODO: Implement environmental trauma triggers
        // - Hazard exposure
        // - Witnessing events
        // - Accumulation checks

        return triggers;
    }
}
```

---

## 7. Turn-Based Effects

### 7.1 Turn Start Effects

| System     | Combat Start       | Non-Combat Start |
| ---------- | ------------------ | ---------------- |
| Stress     | No change          | No change        |
| Rage       | No decay           | -10 per turn     |
| Momentum   | No decay           | -15 per turn     |
| Coherence  | No change          | No change        |
| Apotheosis | -10 stress per turn (always) |

### 7.2 Turn End Effects

| System     | Combat End                | Non-Combat End       |
| ---------- | ------------------------- | -------------------- |
| Stress     | Check thresholds          | Check thresholds     |
| CPS        | Effects apply             | Effects apply        |
| Panic      | Roll if RuinMadness       | Roll if RuinMadness  |
| Trauma     | Check triggers            | Check triggers       |
| Environment | No standard change        | Apply environmental  |

### 7.3 Resource Decay Rates

| Resource  | Combat | Non-Combat | Min Value |
| --------- | ------ | ---------- | --------- |
| Rage      | 0      | -10/turn   | 0         |
| Momentum  | 0      | -15/turn   | 0         |
| Coherence | 0      | 0          | 0         |

### 7.4 Apotheosis Mechanics

```
Turn Start: If in Apotheosis
  │
  ├─ Apply +10 stress
  │
  ├─ Check if Stress >= 100
  │   ├─ Yes: Force exit, set message
  │   └─ No: Continue Apotheosis
  │
  └─ Record in result
```

---

## 8. Logging Specifications

### 8.1 Application Layer Logging

| Event                        | Level       | Template                                                   |
| ---------------------------- | ----------- | ---------------------------------------------------------- |
| Turn Start Processing        | Debug       | `"Processing turn start: Turn {Turn}, Combat={Combat}"`    |
| Resource Decay Applied       | Debug       | `"Rage -{R}/turn, Momentum -{M}/turn"`                     |
| Apotheosis Stress Applied    | Debug       | `"Apotheosis stress: -{Cost}"`                             |
| Apotheosis Auto-Exit         | Warning     | `"Apotheosis ended: Stress overflow"`                      |
| Turn End Processing          | Debug       | `"Processing turn end: Turn {Turn}"`                       |
| Panic Table Triggered        | Information | `"Panic effect triggered: {Effect}"`                       |
| Environmental Stress Applied | Debug       | `"Environmental stress: +{Amount}"`                        |
| Turn Processing Complete     | Information | `"Turn {Turn} complete: {@Result}"`                        |

---

## 9. Unit Testing Requirements

### 9.1 Test File Location

**File:** `tests/RuneAndRust.Application.UnitTests/Services/UnifiedTurnHandlerTests.cs`

### 9.2 Required Tests

| Test Name                                              | Description                         |
| ------------------------------------------------------ | ----------------------------------- |
| `ProcessTurnStart_OutOfCombat_AppliesResourceDecay`    | Rage/Momentum decay applied         |
| `ProcessTurnStart_Apotheosis_AppliesStressCost`        | Apotheosis costs 10 stress          |
| `ProcessTurnStart_ApotheosisAtCapacity_TriggersExit`   | Auto-exit at 100 stress             |
| `ProcessTurnEnd_RuinMadness_TriggersPanicTable`        | Panic table rolls correctly          |

### 9.3 Example Test

```csharp
[TestFixture]
public class UnifiedTurnHandlerTests
{
    private UnifiedTurnHandler _handler;
    private IRageService _rageService;
    private IStressService _stressService;

    [SetUp]
    public void SetUp()
    {
        _rageService = Substitute.For<IRageService>();
        _stressService = Substitute.For<IStressService>();
        var traumaService = Substitute.For<ITraumaService>();
        var specializationProvider = Substitute.For<ISpecializationProvider>();
        var diceService = Substitute.For<IDiceService>();

        var rageState = new RageState { CurrentRage = 50, IsActive = true };
        _rageService.GetRage(Arg.Any<Guid>()).Returns(rageState);

        _handler = new UnifiedTurnHandler(
            _stressService,
            traumaService,
            specializationProvider,
            diceService,
            rageService: _rageService
        );
    }

    [Test]
    public void ProcessTurnStart_OutOfCombat_DecaysRage()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var result = _handler.ProcessTurnStart(characterId, 1, isInCombat: false);

        // Assert
        result.RageDecay.Should().Be(10);
        result.TurnMessages.Should().Contain(m => m.Contains("subsides"));
    }

    [Test]
    public void ProcessTurnStart_ValidResult_PassesValidation()
    {
        // Act
        var result = _handler.ProcessTurnStart(Guid.NewGuid(), 1, isInCombat: true);

        // Assert
        result.IsValid().Should().BeTrue();
    }
}
```

---

## 10. Deliverable Checklist

### 10.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/TurnIntegrationResult.cs`

### 10.2 Application Layer

- [ ] `src/Application/RuneAndRust.Application/Services/UnifiedTurnHandler.cs`

### 10.3 Tests

- [ ] `tests/RuneAndRust.Application.UnitTests/Services/UnifiedTurnHandlerTests.cs`

### 10.4 Documentation

- [ ] Update scope breakdown (mark v0.18.5d complete)
- [ ] Create changelog for v0.18.5d

---

## 11. Acceptance Criteria

### 11.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 11.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 11.3 Functional Verification

- [ ] Rage decays 10/turn outside combat
- [ ] Momentum decays 15/turn when idle
- [ ] Rage doesn't decay in combat
- [ ] Momentum doesn't decay in combat
- [ ] Apotheosis costs 10 stress per turn
- [ ] Apotheosis auto-exits at 100 stress
- [ ] Panic Table triggers at RuinMadness
- [ ] Panic effect correctly rolled (d10)
- [ ] CPS effects applied based on stage
- [ ] Environmental stress accumulates
- [ ] Trauma triggers checked appropriately
- [ ] TurnIntegrationResult validates correctly
- [ ] All turn messages generated appropriately

---

## 12. Dependencies

### 12.1 Required Prerequisites

| Dependency                | Version | Status   | Notes                                  |
| ------------------------- | ------- | -------- | -------------------------------------- |
| Psychic Stress System     | v0.18.0 | Required | Check panic thresholds, apply stress   |
| Specialization Resources  | v0.18.4 | Required | Rage/Momentum decay, Apotheosis costs  |
| Trauma System             | v0.18.3 | Required | Trigger trauma checks                  |
| Dice Service              | v0.6.x  | Required | Panic table rolls, trauma checks       |

### 12.2 Provides to v0.18.5e

| Type                     | Usage                                      |
| ------------------------ | ------------------------------------------ |
| `TurnIntegrationResult`  | Base turn result for logging               |
| `UnifiedTurnHandler`     | Used by orchestration service              |

---

## 13. Future Considerations

### 13.1 Enhanced Environmental Effects

- Location-specific trauma triggers
- Hazard accumulation damage
- Corruption spreading in environment

### 13.2 Advanced Decay Mechanics

- Talent/feat modifications to decay rates
- Status effects modifying decay
- Sanctuary locations preventing decay

### 13.3 Multi-Turn Effects

- Stun/incapacitation duration tracking
- Status effect progression
- Long-term psychological scarring

---

_This design specification provides the detailed blueprint for implementing v0.18.5d Turn-Based Integration. It forms the foundation for per-turn processing across the trauma economy._

---

## Changelog

| Version | Date       | Changes                          |
| ------- | ---------- | -------------------------------- |
| 1.0     | 2026-01-28 | Initial design specification     |
