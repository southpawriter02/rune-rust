# v0.4.1c Changelog: Environmental Hazards

**Release Date:** 2026-01-13  
**Parent:** v0.4.1 (Traps & Environmental Hazards)  
**Prerequisites:** v0.4.1b (Trap Mechanics)

---

## Summary

v0.4.1c implements Environmental Hazards: persistent hazard zones that deal damage and apply status effects to players who remain in or pass through dangerous areas. Features include entry damage, per-turn damage, saving throws to halve/negate effects, and duration-based hazard expiration.

---

## New Features

### HazardType Enum
Nine environmental hazard types for categorization:
- `PoisonGas` - Toxic clouds (Fortitude saves)
- `Fire` - Flames and heat (Agility saves)
- `Ice` - Extreme cold (Fortitude saves)
- `Spikes` - Physical hazards (entry damage)
- `AcidPool` - Corrosive pools
- `Darkness` - Vision obscuring (no damage)
- `Electricity` - Shocking hazards
- `Radiant` - Holy energy (damages undead)
- `Necrotic` - Life-draining energy

### SavingThrow Value Object
Configuration for saving throw mechanics:
- `Attribute` - Fortitude, Agility, or Will
- `DC` - Difficulty Class
- `Negates` - Whether success negates (true) or halves (false) damage
- Factory methods: `Fortitude()`, `Agility()`, `Will()`

### HazardEffectResult Value Object
Captures hazard effect outcomes:
- `DamageDealt`, `DamageType`, `DamageRolls`
- `SaveAttempted`, `SaveSucceeded`, `SaveRoll`, `SaveDC`
- `StatusEffectsApplied`, `WasNegated`, `Message`
- Factory methods: `DamageOnly()`, `DamageWithSave()`, `Negated()`, `Combined()`, `NoEffect()`

### HazardDefinition Class
JSON configuration model:
- Basic: `Id`, `Name`, `Description`, `HazardType`
- Damage: `DamagePerTurn`, `EntryDamage` (dice, type, bonus)
- Effects: `StatusEffects`, `StatusDuration`
- Save: `Attribute`, `DC`, `Negates`
- Zone: `AffectsWholeRoom`, `Duration` (-1 = permanent), `Keywords`

### HazardZone Entity
Core entity for persistent environmental hazards:

**Properties:**
- `Id`, `DefinitionId`, `Name`, `Description`, `HazardType`
- `DamagePerTurnDice`, `EntryDamageDice`, `DamageType`
- `StatusEffects`, `StatusDuration`, `Save`
- `AffectsWholeRoom`, `Duration`, `Keywords`, `EffectMessage`
- `IsActive`, `IsPermanent`, `IsExpired`

**Methods:**
- `FromDefinition(HazardDefinition)` - Factory from config
- `Create(...)` - Explicit parameter factory
- `ProcessTurnTick()` - Duration countdown
- `Deactivate()` - Manual deactivation
- `MatchesKeyword(string)` - Keyword matching
- `GetHazardTypeDescription()` - Thematic description

### Room.HazardZones Collection
New methods on Room entity:
- `HazardZones` - Read-only collection
- `HasHazards`, `HasActiveHazards` - Boolean properties
- `AddHazardZone(HazardZone)` - Add hazard
- `RemoveHazardZone(HazardZone)` - Remove hazard
- `GetActiveHazards()` - Filter to active only
- `GetHazardByKeyword(string)` - Find by keyword
- `GetHazardsByType(HazardType)` - Filter by type
- `RemoveExpiredHazards()` - Cleanup expired

### IHazardZoneService Interface
Service interface for hazard zone management:
- `GetRoomHazardsDescription(Room)` - Room description
- `FindHazard(Room, string)` - Keyword lookup
- `ExamineHazard(HazardZone)` - Detailed description
- `ProcessEntryHazards(Room, Player)` - Entry damage
- `ProcessTurnHazards(Room, Player)` - Per-turn damage
- `ApplyHazardEffect(HazardZone, Player, bool)` - Effect application
- `ProcessHazardTurnTicks(Room)` - Duration countdown
- `GetRoomHazardSummary(Room)` - Summary stats
- `PerformSavingThrow(Player, SavingThrow)` - Save roll

### HazardZoneService Implementation
~430 lines with comprehensive logging:
- Entry hazard processing on room entry
- Per-turn hazard processing during turns
- Saving throw rolls: 1d20 + attribute modifier vs DC
- Damage halving on successful save (negates=false)
- Damage negation on successful save (negates=true)
- Status effect tracking (full integration deferred)
- Duration countdown and hazard expiration

---

## Modified Files

### Domain Layer
| File | Change |
|------|--------|
| `Domain/Enums/HazardType.cs` | [NEW] 9 hazard types |
| `Domain/ValueObjects/SavingThrow.cs` | [NEW] Save configuration |
| `Domain/ValueObjects/HazardEffectResult.cs` | [NEW] Effect results |
| `Domain/Definitions/HazardDefinition.cs` | [NEW] JSON config model |
| `Domain/Entities/HazardZone.cs` | [NEW] Core entity |
| `Domain/Entities/Room.cs` | [MODIFIED] +75 lines HazardZones |

### Application Layer
| File | Change |
|------|--------|
| `Application/Interfaces/IHazardZoneService.cs` | [NEW] Service interface |
| `Application/Services/HazardZoneService.cs` | [NEW] Implementation |

### Configuration
| File | Change |
|------|--------|
| `config/hazards.json` | [EXISTING] 11 definitions already compatible |

### Tests
| File | Tests |
|------|-------|
| `Domain.UnitTests/Enums/HazardTypeTests.cs` | [NEW] 2 tests |
| `Domain.UnitTests/ValueObjects/SavingThrowTests.cs` | [NEW] 7 tests |
| `Domain.UnitTests/Entities/HazardZoneTests.cs` | [NEW] 10 tests |
| `Domain.UnitTests/Entities/RoomHazardTests.cs` | [NEW] 7 tests |

---

## Test Results

```
Passed! - Failed: 0, Passed: 1026, Skipped: 0 - RuneAndRust.Domain.UnitTests.dll
Passed! - Failed: 0, Passed:  454, Skipped: 0 - RuneAndRust.Application.UnitTests.dll
Passed! - Failed: 0, Passed:    8, Skipped: 0 - RuneAndRust.Architecture.Tests.dll

Total: 1,488 tests passed
New tests added: ~26
```

---

## Usage Examples

### Creating Hazards from Configuration
```csharp
var definition = new HazardDefinition
{
    Id = "poison-gas-cloud",
    Name = "Poison Gas Cloud",
    HazardType = HazardType.PoisonGas,
    DamagePerTurn = new HazardDamageDefinition { Dice = "1d6", DamageType = "poison" },
    StatusEffects = new List<string> { "poisoned" },
    Save = new HazardSaveDefinition { Attribute = "Fortitude", DC = 13, Negates = false }
};

var hazard = HazardZone.FromDefinition(definition);
room.AddHazardZone(hazard);
```

### Processing Entry Hazards
```csharp
// Called when player enters a room
var results = hazardZoneService.ProcessEntryHazards(room, player);

foreach (var result in results)
{
    Console.WriteLine(result.Message);
    // "[ENVIRONMENTAL HAZARD: Spike Floor]
    //  Sharp spikes pierce your feet!
    //  Saving Throw (Agility): [14] + 2 = 16 vs DC 12
    //  Save successful! You avoid the hazard's effects."
}
```

### Processing Per-Turn Hazards
```csharp
// Called at start of player's turn
var results = hazardZoneService.ProcessTurnHazards(room, player);

foreach (var result in results)
{
    Console.WriteLine(result.Message);
    // "[ENVIRONMENTAL HAZARD: Poison Gas Cloud]
    //  The poison gas burns your lungs.
    //  Saving Throw (Fortitude): [8] + 1 = 9 vs DC 13
    //  Save failed!
    //  Damage: [4] = 4 poison damage
    //  You are afflicted with: poisoned"
}
```

### Hazard Duration Expiration
```csharp
// Called at end of each turn
var expiredMessages = hazardZoneService.ProcessHazardTurnTicks(room);

foreach (var message in expiredMessages)
{
    Console.WriteLine(message);
    // "The Dissipating Poison Cloud dissipates."
}
```

---

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Service naming | `HazardZoneService` | Distinct from existing `HazardService` (BiomeHazard) |
| Save formula | 1d20 + attr mod vs DC | Standard RPG pattern |
| Halve vs Negate | Configurable per hazard | Flexibility for severity |
| Duration | -1 = permanent | Intuitive configuration |
| Status integration | Deferred | Player doesn't implement IEffectTarget |

---

## Logging Strategy

| Operation | Level | Template |
|-----------|-------|----------|
| Hazard damage | Information | `"Hazard {HazardName} dealt {Damage} {DamageType} damage to {PlayerName}"` |
| Save success | Information | `"Player saved against {HazardName} (rolled {Roll} vs DC {DC})"` |
| Save failure | Information | `"Player failed save against {HazardName} (rolled {Roll} vs DC {DC})"` |
| Status applied | Information | `"Hazard {HazardName} applied {Effects} to player"` |
| Hazard expired | Debug | `"Hazard {HazardName} in room {RoomName} expired after duration countdown"` |
| Save roll | Debug | `"Saving throw {Attribute}: rolled {Roll} + {Modifier} = {Total} vs DC {DC}"` |

---

## Metrics Summary

| Category | Before | After |
|----------|--------|-------|
| Domain Enums | - | +1 (HazardType) |
| Domain ValueObjects | 75 | 77 |
| Domain Entities | - | +1 (HazardZone) |
| Room methods | ~30 | ~37 |
| Application Interfaces | 28 | 29 |
| Application Services | - | +1 (HazardZoneService) |
| Unit Tests | ~1,462 | ~1,488 |

---

## v0.4.1 Milestone Progress

| Sub-Version | Focus | Status |
|-------------|-------|--------|
| v0.4.1a | Core Trap System | ✅ Complete |
| v0.4.1b | Trap Mechanics | ✅ Complete |
| v0.4.1c | Environmental Hazards | ✅ Complete |

---

## Remaining Integration Work

- **GameSessionService**: Integrate `ProcessEntryHazards()` on room change
- **TurnProcessingService**: Integrate `ProcessTurnHazards()` and `ProcessHazardTurnTicks()`
- **DependencyInjection**: Register `HazardZoneService`
- **StatusEffectService**: Full integration when Player implements IEffectTarget

---

## Future Work

- **v0.4.2**: Puzzles & Secrets
- **v0.4.3**: Light-based hazards, weather effects
- **Future**: Spreading hazards, player-created hazards, hazard interaction with NPCs/monsters
