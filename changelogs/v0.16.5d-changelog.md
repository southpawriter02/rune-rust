# v0.16.5d Changelog — Myth-Forged Drop Integration

**Version:** 0.16.5d  
**Date:** 2026-01-29  
**Phase:** Unique Items & Myth-Forged System

---

## Summary

Implements the Myth-Forged drop integration system, providing the service interface, generation context, and result types for integrating unique item generation into the loot system. Includes configuration for drop chances by source type and class affinity filtering.

---

## Added

### Domain Layer - Enum

- **`FallbackReason`** enum — Reasons why Myth-Forged generation failed:
    - `None = 0` — Successful generation (no fallback)
    - `PoolExhausted = 1` — All unique items already dropped
    - `NoMatchingSource = 2` — No unique items for this source
    - `DropChanceFailed = 3` — RNG drop check failed
    - `TierTooLow = 4` — Quality tier below minimum (must be Tier 4)
    - Full XML documentation with examples

---

### Domain Layer - Value Objects

- **`MythForgedContext`** value object — Generation context parameters:
    - `SourceType` — `DropSourceType` indicating drop origin
    - `SourceId` — Specific source identifier (normalized to lowercase)
    - `PlayerClassId` — Optional class for affinity filtering (nullable)
    - `PlayerLevel` — Player level for requirement filtering (default 1)
    - `RandomSeed` — Optional seed for deterministic testing (nullable)
    - `Create()` factory method with validation and ID normalization
    - `ToString()` for debugging output
    - Full XML documentation with examples

- **`MythForgedResult`** value object — Generation result:
    - `Success` — Whether generation succeeded
    - `Item` — Generated `UniqueItem` (null if failed)
    - `FallbackReason` — Reason for failure (None if success)
    - `AffinityApplied` — Whether class affinity filtering was used
    - `PoolSize` — Available pool size before selection
    - `Succeeded()` factory method — Creates success result
    - `Failed()` factory method — Creates failure result, rejects `FallbackReason.None`
    - `ToString()` for debugging output
    - Full XML documentation with examples

---

### Application Layer - Interface

- **`IMythForgedService`** interface — Myth-Forged generation operations:
    - `TryGenerateMythForged(context)` — Attempts generation, returns result
    - `GetDropChance(sourceType)` — Gets drop chance for source type
    - `ShouldAttemptMythForged(sourceType, tier)` — Checks if attempt warranted
    - `GetAvailableForSource(sourceType, sourceId, classId?)` — Gets pool
    - `AffinityBiasPercent` property — Configured affinity bias (0-100)
    - Full XML documentation with usage examples

---

### Configuration Layer

- **`myth-forged-config.json`** — Myth-Forged configuration:
    - `dropChances` — Drop probabilities by source type (0.0-1.0):
        - `boss`: 70%, `elite`: 10%, `bossChest`: 50%
        - `hiddenCache`: 15%, `questReward`: 100%
        - `monster`: 1%, `container`: 2%, `vendor`: 0%
    - `affinityBiasPercent`: 60 — Class affinity filter probability
    - `fallbackTier`: 3 — Tier to fall back on failure (Optimized)
    - `minimumTierForMythForged`: 4 — Required tier for attempt
    - `requiresLegendaryRoll`: true — Must be Tier 4 to trigger

- **`myth-forged-config.schema.json`** — JSON Schema validation:
    - Drop chance range validation (0.0-1.0)
    - Affinity percentage range (0-100)
    - Tier range validation with defaults

---

### Unit Tests

- **`FallbackReasonTests`** — 2 tests:
    - `FallbackReason_ContainsAllExpectedValues`
    - `FallbackReason_HasExplicitIntValues`

- **`MythForgedContextTests`** — 14 tests:
    - `Create_WithValidData_CreatesContext`
    - `Create_NormalizesIds`
    - `Create_WithNullPlayerClass_Allowed`
    - `Create_WithInvalidLevel_ThrowsArgumentOutOfRangeException`
    - `Create_WithNullSourceId_ThrowsArgumentException`
    - `Create_WithEmptySourceId_ThrowsArgumentException`
    - `Create_WithWhitespaceSourceId_ThrowsArgumentException`
    - `Create_WithRandomSeed_StoresValue`
    - `ToString_ReturnsFormattedString`
    - `ToString_WithNullClass_ShowsNone`
    - `Equality_WithSameValues_AreEqual`
    - `Equality_WithDifferentValues_AreNotEqual`
    - `Create_WithDifferentSourceTypes_CapturesCorrectly` (parameterized, 5 cases)

- **`MythForgedResultTests`** — 14 tests:
    - `Succeeded_WithItem_CreatesSuccessResult`
    - `Succeeded_WithoutAffinity_SetsAffinityAppliedFalse`
    - `Failed_WithReason_CreatesFailedResult`
    - `Failed_WithPoolSize_RecordsPoolSize`
    - `Failed_WithNoneReason_ThrowsArgumentException`
    - `Succeeded_WithNullItem_ThrowsArgumentNullException`
    - `ToString_ForSuccessResult_ContainsItemIdAndAffinity`
    - `ToString_ForFailedResult_ContainsReason`
    - `Failed_WithDifferentReasons_CreatesFailed` (parameterized, 4 cases)
    - `Equality_SuccessWithSameValues_AreEqual`
    - `Equality_FailedWithSameValues_AreEqual`
    - `Equality_DifferentSuccessStates_AreNotEqual`

---

## Design Decisions

| Decision                          | Rationale                                              |
| --------------------------------- | ------------------------------------------------------ |
| `readonly record struct` for VOs  | Immutability and built-in equality for value semantics |
| Factory methods with validation   | Ensures invariants are enforced at creation time       |
| ID normalization to lowercase     | Case-insensitive matching across config and runtime    |
| `Failed()` rejects `None` reason  | Enforces correct result construction semantics         |
| Optional `RandomSeed` for testing | Enables deterministic unit test scenarios              |
| Interface-only for service        | Implementation provided in v0.16.5e or later phase     |

---

## Dependencies

| Dependency | Description           | Status      |
| ---------- | --------------------- | ----------- |
| v0.16.5a   | `DropSourceType` enum | ✅ Complete |
| v0.16.5a   | `UniqueItem` entity   | ✅ Complete |
| v0.16.5a   | `DropSource` VO       | ✅ Complete |
| v0.16.5c   | `IUniqueItemRegistry` | ✅ Complete |

---

## Provides To

| Consumer | Description                        |
| -------- | ---------------------------------- |
| v0.16.5e | `MythForgedService` implementation |
| v0.16.5f | Set bonus system                   |
| v0.16.4d | Container loot integration         |

---

## File Summary

| File                             | Type         | Lines |
| -------------------------------- | ------------ | ----- |
| `FallbackReason.cs`              | Enum         | ~100  |
| `MythForgedContext.cs`           | Value Object | ~185  |
| `MythForgedResult.cs`            | Value Object | ~200  |
| `IMythForgedService.cs`          | Interface    | ~260  |
| `myth-forged-config.json`        | Config       | ~20   |
| `myth-forged-config.schema.json` | Schema       | ~80   |
| `FallbackReasonTests.cs`         | Unit Tests   | ~55   |
| `MythForgedContextTests.cs`      | Unit Tests   | ~210  |
| `MythForgedResultTests.cs`       | Unit Tests   | ~190  |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 34/34 passed (2 + 14 + 14 + 4 parameterized)
- **Test Coverage:** All factory methods, validation, ID normalization, equality, ToString
