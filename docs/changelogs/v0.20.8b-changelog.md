# v0.20.8b Changelog — Seiðkona (Seeress) Tier 2 Discipline Abilities

## Version: 0.20.8b

## Date: 2026-02-17

## Focus: Seiðkona Tier 2 Abilities — Fate's Thread, Weave Disruption, Resonance Cascade

---

## Added

### Domain Layer — Value Objects

- **`FatesThreadResult`** — Init-only sealed record capturing Fate's Thread (divination) execution outcome: `ResonanceBefore`/`ResonanceAfter`/`ResonanceGained` (+2 per cast), `CorruptionCheckPerformed`/`CorruptionTriggered`/`CorruptionReason`/`CorruptionRoll`/`CorruptionRiskPercent`, `ApCostPaid` (tracks actual AP spent after Cascade reduction), `CascadeApplied` (whether Resonance Cascade reduced the cost). Display: `GetDescription()` (includes Cascade/Corruption tags), `GetResonanceChange()` (formatted "Resonance: X → Y (+Z)"). No damage properties — Fate's Thread is pure divination.
- **`WeaveDisruptionResult`** — Init-only sealed record capturing Weave Disruption (dispel) execution outcome: `DispelRoll` (d20), `ResonanceBonus` (current Resonance added to roll), `TotalRoll` (d20 + Resonance), `ResonanceBefore`/`ResonanceAfter`/`ResonanceGained` (+1 per cast), all Corruption tracking fields, `ApCostPaid`, `CascadeApplied`. Display: `GetDispelBreakdown()` (formatted "d20 = X + Resonance Y = Z (total)"), `GetDescription()` (includes Cascade/Corruption tags), `GetResonanceChange()`. No damage properties — dispel effect resolution deferred to combat system.
- **`ResonanceCascadeState`** — Init-only sealed record tracking Resonance Cascade passive state: `IsActive` (Resonance ≥ 5 AND unlocked), `CostReduction` (1 when active, 0 when inactive), `MinimumApCost` (1), `CurrentResonance`, `IsUnlocked`. Static factory: `Evaluate(int currentResonance, bool cascadeUnlocked)`. `GetReducedCost(int baseCost)` — returns `Math.Max(baseCost - CostReduction, MinimumApCost)` when active, baseCost otherwise. Display: `GetDescription()` (locked/inactive/active states), `GetStatusString()` (compact UI format). 3 private constants: `CascadeActivationThreshold = 5`, `CascadeReduction = 1`, `MinCost = 1`.

### Unit Tests

- **`FatesThreadResultTests`** — 10 domain tests: factory defaults (all zeroed), Resonance change tracking, Corruption triggered (all fields), Corruption safe with roll (check but not triggered), Cascade applied (reduced cost), without Cascade (base cost), display methods (GetDescription with Cascade+Corruption tags, GetDescription safe with roll includes d100 and "safe", GetResonanceChange formatted string)
- **`WeaveDisruptionResultTests`** — 10 domain tests: factory defaults (all zeroed), dispel roll tracking (d20 + Resonance = total), Resonance change tracking, Corruption triggered, Cascade applied, without Cascade, display methods (GetDispelBreakdown formatted string, GetDescription with Cascade+Corruption tags, GetResonanceChange)
- **`ResonanceCascadeStateTests`** — 15 domain tests (including parameterized): Evaluate not unlocked (inactive), Evaluate unlocked at Resonance 0 (inactive), Evaluate unlocked at Resonance 4 (inactive, below threshold), Evaluate unlocked at Resonance 5 (active, reduction = 1), Evaluate unlocked at Resonance 7 (active), Evaluate unlocked at Resonance 10 (active), GetReducedCost when inactive (returns base cost), GetReducedCost when active (parameterized: 1→1, 2→1, 3→2, 5→4), GetReducedCost not unlocked (returns base cost), display methods (GetDescription locked/inactive/active, GetStatusString active/locked)

## Modified

### Application Layer — Interface

- **`ISeidkonaAbilityService`** — Extended with 4 new Tier 2 method signatures:
  - `ExecuteFatesThread(Player, Guid)` → `FatesThreadResult?` — Active divination, +2 Resonance, 2 AP (1 with Cascade)
  - `ExecuteWeaveDisruption(Player, Guid)` → `WeaveDisruptionResult?` — Active dispel, d20 + Resonance, +1 Resonance, 3 AP (2 with Cascade)
  - `GetResonanceCascadeState(Player)` → `ResonanceCascadeState` — Query Cascade activation status
  - `GetEffectiveApCost(Player, SeidkonaAbilityId)` → `int` — Get AP cost after Cascade reduction
  - Updated class-level XML docs to cover Tier 1 and Tier 2

### Application Layer — Services

- **`SeidkonaAbilityService`** — Extended with Tier 2 ability implementations:
  - 7 new Tier 2 constants: `FatesThreadApCost = 2`, `FatesThreadResonanceGain = 2`, `WeaveDisruptionApCost = 3`, `WeaveDisruptionResonanceGain = 1`, `CascadeActivationThreshold = 5`, `CascadeReduction = 1`, `MinimumApCost = 1`
  - `ExecuteFatesThread()`: Guard chain (null → spec → ability → AP w/ Cascade → Corruption eval BEFORE spending → spend AP → build Resonance +2 → apply Corruption → return result). No damage roll, no accumulated damage.
  - `ExecuteWeaveDisruption()`: Guard chain (same as Fate's Thread) → spend AP → `RollD20()` → compute total = d20 + Resonance → build Resonance +1 → apply Corruption → return result. No accumulated damage.
  - `GetResonanceCascadeState()`: Query method delegating to `ResonanceCascadeState.Evaluate()`
  - `GetEffectiveApCost()`: Delegates to `GetBaseApCost()` + `GetEffectiveApCostInternal()`
  - `GetAbilityReadiness()`: Updated to include FatesThread, WeaveDisruption, and ResonanceCascade with Cascade-aware AP costs
  - `internal virtual int RollD20()` — New dice method for Weave Disruption, `internal virtual` for test overriding
  - Private helpers: `GetBaseApCost(SeidkonaAbilityId)` (switch over all abilities), `GetEffectiveApCostInternal(Player, int)` (checks Cascade unlock + Resonance threshold)
  - Existing Seiðr Bolt and Wyrd Sight updated to use `GetEffectiveApCostInternal()` for Cascade-aware AP checking
  - Exhaustive structured logging: `LogInformation` for success with Cascade/Corruption details, `LogWarning` for failures
- **`SeidkonaCorruptionService`** — Fixed Resonance Cascade routing:
  - Moved `SeidkonaAbilityId.ResonanceCascade` from `EvaluateGenericCastingRisk()` group to `CreateSafe()` branch — passive abilities never trigger Corruption
  - FatesThread and WeaveDisruption routed to `EvaluateGenericCastingRisk()` with `CastingAtHighResonance` trigger

### Application Layer — Tests

- **`SeidkonaAbilityServiceTests`** — Extended from 27 to 61 tests (+34):
  - `TestSeidkonaAbilityService` subclass: Added `FixedD20` property and `RollD20()` override alongside existing `Fixed2D6`/`Roll2D6()`
  - Fate's Thread tests (9): valid execution (Resonance change, AP cost, no Cascade), insufficient AP, wrong specialization, ability not unlocked, builds Resonance +2 (mock verify), does NOT accumulate damage (mock verify Never), low Resonance no Corruption check, mid Resonance Corruption triggered, with Cascade active reduced AP cost (2→1)
  - Weave Disruption tests (9): valid execution (d20 roll = 14, Resonance bonus = 3, total = 17, AP cost, no Cascade), insufficient AP, wrong specialization, ability not unlocked, builds Resonance +1 (mock verify), does NOT accumulate damage (mock verify Never), low Resonance no Corruption check, mid Resonance Corruption safe with roll, with Cascade active reduced AP cost (3→2)
  - Resonance Cascade state tests (4): not unlocked returns inactive, unlocked at Resonance 4 returns inactive, unlocked at Resonance 5 returns active, wrong specialization returns inactive
  - GetEffectiveApCost tests (5): without Cascade returns base cost, with Cascade active returns reduced cost, passive ability returns 0, SeidrBolt with Cascade stays at minimum (1→1), WeaveDisruption with Cascade reduces (3→2)
  - GetAbilityReadiness tests (3): T2 abilities included, Cascade-active uses reduced costs, existing T1 test preserved
  - Corruption service direct tests (4): ResonanceCascade always safe (passive), FatesThread at high Resonance triggers with CastingAtHighResonance, WeaveDisruption at high Resonance triggers with correct tier, FatesThread below threshold returns safe

### Configuration

- **`config/abilities.json`** — Added 3 Tier 2 ability entries:
  - `fates-thread`: Active Divination, 2 AP (1 with Cascade), +2 Resonance, range 12, ppCost 4. Divination/precognition with Corruption risk at Resonance 5+.
  - `weave-disruption`: Active Counterspell, 3 AP (2 with Cascade), d20 + Resonance dispel roll, +1 Resonance, range 10, ppCost 4. Dispel with Corruption risk at Resonance 5+.
  - `resonance-cascade`: Passive Modifier, 0 AP, ppCost 4. Reduces all Seiðkona ability AP costs by 1 (min 1) when Resonance ≥ 5. Does NOT affect Unraveling capstone. Cascade trigger configuration included (threshold: 5, reduction: 1, min: 1).

## Design Decisions

- **Resonance Cascade as feedback loop**: The Cascade creates a strategic tension at the heart of Seiðkona gameplay — higher Resonance means cheaper abilities (Cascade reduces by 1 AP), which enables more casts per turn, which builds more Resonance, which increases Corruption risk. The -1 AP reduction (min 1) is intentionally modest to maintain balance; even with Cascade active, the Seiðkona still pays meaningful AP costs. The Cascade does NOT affect the Unraveling capstone (to be handled in v0.20.8c).
- **Cascade applies to AP guard check**: The effective AP cost (after Cascade reduction) is used in the AP sufficiency guard, meaning Cascade genuinely enables casts that would otherwise be impossible. For example, with 2 AP available, Weave Disruption (base 3 AP) becomes castable when Cascade reduces it to 2 AP. This is reflected in `GetAbilityReadiness()` and tested explicitly.
- **Cascade routing to CreateSafe**: Resonance Cascade was originally routed to `EvaluateGenericCastingRisk()` in the Corruption service, which would have performed d100 checks on a passive ability. Fixed by routing to `CreateSafe()` — passive abilities that don't channel Aether should never trigger Corruption risk.
- **Fate's Thread builds +2 Resonance**: Higher than Tier 1's +1 (Seiðr Bolt), representing the increased Aetheric channeling of Tier 2 abilities. This means Fate's Thread is the fastest path to Resonance 5 (the Cascade activation threshold), creating a natural "ramp up" pattern: cast Fate's Thread to build Resonance → Cascade activates → cheaper abilities from Cascade → more aggressive play.
- **Weave Disruption d20 + Resonance**: The dispel roll uses d20 plus current Resonance as a bonus, creating a synergy where high Resonance improves dispel effectiveness at the cost of increased Corruption risk. The actual effect resolution (what happens to the target spell) is deferred to the combat system, which doesn't exist yet — the service stores the roll result in the VO for future use.
- **No damage, no accumulated damage for T2**: Neither Fate's Thread (divination) nor Weave Disruption (dispel) deal damage. Tests explicitly verify that `AddAccumulatedDamage` is never called (`Times.Never`). This distinguishes them from Seiðr Bolt and preserves the Accumulated Aetheric Damage tracker for damage-dealing abilities only.
- **PP cost = 4 per T2 ability**: Follows the established codebase pattern (T1=0, T2=4, T3=5, Capstone=6) consistent with `Player.GetSeidkonaPPInvested()` implementation from v0.20.8a.
- **Synchronous implementation**: The design specification proposed async methods, but the entire codebase uses synchronous patterns. Maintained consistency with existing code.
- **Single service, not separate services**: The design specification proposed separate `IPrecognitionService`, `IDispelService`, and `ICascadeModifierService`. Maintained the established single `ISeidkonaAbilityService` pattern consistent with all other specializations.

## Test Results

```
Seiðkona tests: 99
     Passed: 99
     Failed: 0

Breakdown:
  SeidkonaAbilityServiceTests:            61 application tests (27 T1 + 34 T2)
    includes 12 Corruption service direct tests (8 T1 + 4 T2)
  FatesThreadResultTests:                 10 domain tests
  WeaveDisruptionResultTests:             10 domain tests
  ResonanceCascadeStateTests:             15 domain tests (including parameterized)
  (v0.20.8a domain VOs unchanged:         18 + 9 = 27 domain tests)
```

## Files Changed

### New Files (4)
| File | Layer | Type |
|------|-------|------|
| `src/Core/RuneAndRust.Domain/ValueObjects/FatesThreadResult.cs` | Domain | Value Object |
| `src/Core/RuneAndRust.Domain/ValueObjects/WeaveDisruptionResult.cs` | Domain | Value Object |
| `src/Core/RuneAndRust.Domain/ValueObjects/ResonanceCascadeState.cs` | Domain | Value Object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/FatesThreadResultTests.cs` | Tests | Domain VO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/WeaveDisruptionResultTests.cs` | Tests | Domain VO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ResonanceCascadeStateTests.cs` | Tests | Domain VO |
| `docs/changelogs/v0.20.8b-changelog.md` | Docs | Changelog |

### Modified Files (4)
| File | Change |
|------|--------|
| `src/Core/RuneAndRust.Application/Interfaces/ISeidkonaAbilityService.cs` | Added 4 Tier 2 method signatures |
| `src/Core/RuneAndRust.Application/Services/SeidkonaAbilityService.cs` | Added T2 implementations, RollD20, Cascade logic, updated GetAbilityReadiness |
| `src/Core/RuneAndRust.Application/Services/SeidkonaCorruptionService.cs` | Fixed ResonanceCascade routing to CreateSafe |
| `config/abilities.json` | Added 3 Tier 2 ability entries |
| `tests/RuneAndRust.Application.UnitTests/Services/SeidkonaAbilityServiceTests.cs` | Extended from 27 to 61 tests with T2 coverage |
