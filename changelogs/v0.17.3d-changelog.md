# Changelog: v0.17.3d - Available Specializations

**Release Date:** 2026-01-30
**Phase:** Archetype System (4/6)
**Status:** Complete

---

## Overview

Implements the `ArchetypeSpecializationMapping` value object that maps archetypes to their available specializations. Each archetype has access to a curated subset of specializations, with one recommended as the player's first choice. This mapping establishes the archetype-to-specialization gating pattern used during character creation Step 5.

The available specializations per archetype are:

| Archetype  | Count | Available Specializations                                                  | Recommended First |
| ---------- | ----- | -------------------------------------------------------------------------- | ----------------- |
| Warrior    | 6     | Guardian, Berserker, Weapon Master, Vanguard, Juggernaut, Battle Commander | Guardian          |
| Skirmisher | 4     | Shadow Dancer, Duelist, Ranger, Acrobat                                    | Shadow Dancer     |
| Mystic     | 2     | Elementalist, Void Weaver                                                  | Elementalist      |
| Adept      | 5     | Alchemist, Artificer, Tactician, Herbalist, Chronicler                     | Alchemist         |

The Warrior has the most specializations (6), reflecting its versatility as the primary Tank / Melee DPS archetype. The Mystic has the fewest (2), reflecting deep mastery focus. The Adept (5) and Skirmisher (4) fall between these extremes.

The value object is an immutable `readonly record struct` following the established codebase pattern (matching `ArchetypeAbilityGrant`, `ArchetypeResourceBonuses`, `ArchetypeSpecialBonus`). It includes static archetype properties, a validated `Create()` factory method, specialization availability checking, display formatting, and a `GetForArchetype()` lookup method.

---

## Added

### Domain Layer

#### Value Objects

- **`ArchetypeSpecializationMapping`** (`ValueObjects/ArchetypeSpecializationMapping.cs`)
    - `readonly record struct` with primary constructor `(Archetype ArchetypeId, IReadOnlyList<string> AvailableSpecializations, string RecommendedFirst)`
    - File header with `═══` borders, Version: 0.17.3d
    - Section separators: PRIVATE FIELDS, COMPUTED PROPERTIES, STATIC PROPERTIES, FACTORY METHODS, HELPER METHODS, PRIVATE HELPERS, DEBUGGING
    - Static `ILogger<ArchetypeSpecializationMapping>?` field for diagnostic output
    - Computed properties: `Count`, `HasSpecializations`
    - Static properties: `Warrior` (6 specs), `Skirmisher` (4 specs), `Mystic` (2 specs), `Adept` (5 specs)
    - `Create()` factory method with:
        - 3 required parameters + optional logger
        - `ArgumentNullException.ThrowIfNull` for specializations collection
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for recommendedFirst
        - Empty collection validation with descriptive error message
        - Recommended-in-list validation with descriptive error message
        - All specialization IDs normalized to lowercase via `ToLowerInvariant()`
        - RecommendedFirst normalized to lowercase
        - Debug logging on entry, after validation
        - Warning logging on validation failures
        - Information logging on successful creation with all properties
    - `GetForArchetype()`: Static lookup method using switch expression for all 4 archetypes with `ArgumentOutOfRangeException` for invalid values
    - `IsSpecializationAvailable()`: Case-insensitive check with null/whitespace safety (returns false, no throw)
    - `GetAvailableIds()`: Returns specialization IDs as enumerable
    - `GetDisplayList(bool highlightRecommended)`: UI-formatted list with ★ marker and "(Recommended)" suffix for recommended first; converts kebab-case to Title Case
    - `FormatForDisplay()`: Private helper for kebab-case to Title Case conversion
    - `ToString()`: Returns `"{ArchetypeId}: {Count} specializations (recommended: {RecommendedFirst})"`
    - Full XML documentation on every member with `<summary>`, `<value>`, `<remarks>`, `<param>`, `<returns>`, `<exception>`, `<example>`, `<seealso>`

### Unit Tests

- **`ArchetypeSpecializationMappingTests`** (`ValueObjects/ArchetypeSpecializationMappingTests.cs`) — 24 tests
    - `Warrior_HasSixSpecializations`: Count=6, all 6 IDs verified, recommended=guardian
    - `Skirmisher_HasFourSpecializations`: Count=4, all 4 IDs verified, recommended=shadow-dancer
    - `Mystic_HasTwoSpecializations`: Count=2, both IDs verified, recommended=elementalist
    - `Adept_HasFiveSpecializations`: Count=5, all 5 IDs verified, recommended=alchemist
    - `AllArchetypes_HaveSpecializations`: All 4 HasSpecializations=true
    - `AllArchetypes_HaveCorrectCounts`: Warrior=6, Skirmisher=4, Mystic=2, Adept=5
    - `Create_WithValidData_CreatesMapping`: Factory creates correct properties
    - `Create_NormalizesSpecializationIdsToLowercase`: Mixed case → lowercase
    - `Create_NormalizesRecommendedFirstToLowercase`: PascalCase → lowercase
    - `Create_WithNullSpecializations_ThrowsArgumentNullException`
    - `Create_WithEmptySpecializations_ThrowsArgumentException`
    - `Create_WithNullRecommendedFirst_ThrowsArgumentException`
    - `Create_WithWhitespaceRecommendedFirst_ThrowsArgumentException`
    - `Create_WithRecommendedNotInList_ThrowsArgumentException`
    - `IsSpecializationAvailable_WithValidSpec_ReturnsTrue`: All 6 Warrior specs
    - `IsSpecializationAvailable_WithInvalidSpec_ReturnsFalse`: Cross-archetype specs
    - `IsSpecializationAvailable_CaseInsensitive_ReturnsTrue`: Mixed case matching
    - `IsSpecializationAvailable_WithNullOrWhitespace_ReturnsFalse`: Null, empty, whitespace
    - `IsSpecializationAvailable_CrossArchetype_ReturnsFalse`: Mystic specs unavailable to Warrior and vice versa
    - `GetForArchetype_ReturnsCorrectMapping_ForEachArchetype`: All 4 archetypes verified
    - `GetForArchetype_WithInvalidArchetype_ThrowsArgumentOutOfRangeException`
    - `GetAvailableIds_ReturnsAllIds`: Mystic returns 2 IDs
    - `GetDisplayList_WithHighlight_MarksRecommended`: ★ marker and "(Recommended)" suffix
    - `GetDisplayList_WithoutHighlight_NoMarker`: Plain Title Case names
    - `GetDisplayList_ConvertsKebabCaseToTitleCase`: "weapon-master" → "Weapon Master"
    - `GetDisplayList_DefaultHighlight_MarksRecommended`: Default parameter verification
    - `ToString_ReturnsFormattedString`: "Warrior: 6 specializations (recommended: guardian)"
    - `ToString_Mystic_ReturnsFormattedString`: "Mystic: 2 specializations (recommended: elementalist)"

### Glossary

- **`config/glossary.json`** — Added 1 glossary entry
    - `archetype-specialization-mapping`: Mapping of archetypes to available specializations and recommended first choice (sortOrder: 31)

---

## Changed

### Configuration Files

- **`config/archetypes.json`** — Added `availableSpecializations` section to all 4 archetypes
    - Each archetype entry now includes an `availableSpecializations` object with `specializations` (array of kebab-case IDs) and `recommendedFirst` (string ID)
    - Warrior: 6 specializations (guardian, berserker, weapon-master, vanguard, juggernaut, battle-commander), recommended: guardian
    - Skirmisher: 4 specializations (shadow-dancer, duelist, ranger, acrobat), recommended: shadow-dancer
    - Mystic: 2 specializations (elementalist, void-weaver), recommended: elementalist
    - Adept: 5 specializations (alchemist, artificer, tactician, herbalist, chronicler), recommended: alchemist

- **`config/schemas/archetypes.schema.json`** — Extended with available specializations definition
    - Added `availableSpecializations` as required property in `archetypeDefinition`
    - Added `availableSpecializations` definition with `specializations` (array, kebab-case pattern `^[a-z][a-z0-9-]*$`, minLength: 3, maxLength: 50, minItems: 1, uniqueItems: true) and `recommendedFirst` (string, kebab-case pattern)
    - All definitions use `additionalProperties: false`
    - Updated top-level and archetype definition descriptions to include "available specializations"

### Documentation

- **`docs/design/v0.17.x/v0.17.3-scope-breakdown.md`** — Checked off v0.17.3d unit test items
    - `[x] Warrior has 6 available specializations`
    - `[x] Mystic has 2 available specializations`

---

## Design Decisions

### readonly record struct Pattern

`ArchetypeSpecializationMapping` uses the `readonly record struct` pattern, matching `ArchetypeAbilityGrant` (v0.17.3c), `ArchetypeSpecialBonus` (v0.17.3b), `ArchetypeResourceBonuses` (v0.17.3b), `DerivedStats` (v0.17.2d), and `PointBuyCost` (v0.17.2c). This provides value equality semantics, immutability, and zero-allocation access for frequently-used mapping lookups during character creation.

### Specialization Names: Design Spec vs. Scope Breakdown

The v0.17.3d design specification uses different specialization names (Guardian, Berserker, Weapon Master, etc.) compared to the scope breakdown document (Berserkr, Skjaldmaer, Skar-Horde, etc.). Following established precedent from v0.17.3c (which chose design spec ability names over scope breakdown names), the **design specification was treated as authoritative** since it is the more detailed and recent document. The scope breakdown checkboxes were checked off as-is per convention.

### JSON Schema Draft-07 Consistency

The schema extension uses Draft-07 with `definitions` (not `$defs`) matching the existing v0.17.3a/b/c schema and all other schemas in the codebase (`backgrounds.schema.json`, `lineages.schema.json`, `attributes.schema.json`).

### availableSpecializations as Nested Object

The configuration uses a nested object `{ "specializations": [...], "recommendedFirst": "..." }` rather than a flat array, matching the design specification. This structure groups the specialization list with its recommended first choice, keeping related data together.

### Case-Insensitive IsSpecializationAvailable

`IsSpecializationAvailable()` performs case-insensitive matching and returns `false` for null/whitespace input rather than throwing exceptions. This design makes it safe for direct use in UI validation without additional null checks, following a principle of graceful degradation at system boundaries.

### ID Normalization to Lowercase

All specialization IDs are normalized to lowercase via `ToLowerInvariant()` during `Create()`, matching the `ArchetypeAbilityGrant.Create()` pattern for AbilityId normalization. This ensures consistent lookups regardless of casing in configuration files.

### Static Properties with Canonical Data

The four static properties (`Warrior`, `Skirmisher`, `Mystic`, `Adept`) provide compile-time discoverable canonical data, matching the pattern from `ArchetypeResourceBonuses`. The `GetForArchetype()` method provides enum-based lookup for runtime access.

---

## Dependencies

### Prerequisites

| Type                  | Phase    | Usage                            |
| --------------------- | -------- | -------------------------------- |
| `Archetype`           | v0.17.3a | Archetype identification         |
| `ArchetypeDefinition` | v0.17.3a | Will compose with spec mapping   |

### Provides to Future Phases

| Type                             | Phase    | Usage                                 |
| -------------------------------- | -------- | ------------------------------------- |
| `ArchetypeSpecializationMapping` | v0.17.3e | Provider returns mappings             |
| `ArchetypeSpecializationMapping` | v0.17.3f | Application service validates choice  |
| `ArchetypeSpecializationMapping` | v0.17.4  | Specialization System uses for gating |
| `ArchetypeSpecializationMapping` | v0.17.5  | Creation workflow validates selection |

---

## Logging Strategy

| Level       | When                                                                           |
|-------------|--------------------------------------------------------------------------------|
| Debug       | Factory method entry with archetype ID and recommended first                   |
| Debug       | Validation passed with specialization count and recommended first              |
| Warning     | Validation failed: empty specializations list or recommended not in list       |
| Information | Successful creation with all property values and available specialization list |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/ArchetypeSpecializationMapping.cs` | Specialization mapping value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ArchetypeSpecializationMappingTests.cs` | Specialization mapping unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/archetypes.json` | Added availableSpecializations section to all 4 archetypes |
| `config/schemas/archetypes.schema.json` | Added availableSpecializations definition and property |
| `config/glossary.json` | Added 1 glossary entry (archetype-specialization-mapping) |
| `docs/design/v0.17.x/v0.17.3-scope-breakdown.md` | Checked off v0.17.3d deliverables |

---

## Notes

- Total unit tests for v0.17.3d: 24 tests
- The design specification estimated ~6 tests; 24 were implemented for comprehensive coverage of all static profiles, factory validation paths, specialization availability checks, cross-archetype exclusion, display formatting, and lookup methods
- Warrior has the most specializations (6) while Mystic has the fewest (2), reflecting design intent for versatility vs. focused mastery
- Specialization IDs use kebab-case format (e.g., "shadow-dancer", "weapon-master") matching the design specification convention
- The scope breakdown document uses Norse-themed names (Berserkr, Skjaldmaer, Skar-Horde, etc.) while the design specification uses English names (Guardian, Berserker, Weapon Master, etc.); the design specification was treated as authoritative following v0.17.3c precedent
- The `availableSpecializations` configuration uses a nested object structure per the design specification, not a flat array
- Provider service and application service integration are deferred to v0.17.3e-f
