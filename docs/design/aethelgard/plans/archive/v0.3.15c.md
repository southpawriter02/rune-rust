> **Archived** - This plan has been consolidated. See the complete version at [v0.3.15](../v0.3.x/v0.3.15.md).

# v0.3.15c: The Polyglot (UI Integration)

Goal: Integrate language selection into the OptionsController, persist the choice in GameSettings, and implement a "Pseudo-Locale" (qps-ploc) to stress-test the UI layout.

This version connects the backend localization infrastructure (built in v0.3.15b) to the user interface. It introduces the Language selector in the Options menu and implements Pseudo-Localization—a critical QA tool that programmatically garbles text to test for UI overflow and identify hardcoded strings that were missed during extraction.

1. Architecture & Data Flow
The Language Switch Pipeline
	1	Input: User changes "Language" in the Options Menu.
	2	Validation: OptionsController validates the locale code (e.g., "en-US", "qps-ploc").
	3	Loading: Calls LocalizationService.LoadLocaleAsync(newCode).
	◦	If Pseudo-Loc: The service enters generation mode (no file needed).
	◦	If Standard: The service loads JSON from disk.
	4	Persistence: Updates GameSettings.Language.
	5	Refresh: Triggers a re-render of the Options UI immediately to show the new language in effect.

2. Logic Decision Trees
A. Pseudo-Localization Logic (Runtime Generation) Input: Original String ("Start Game")
	1	Wrapper: Enclose in brackets to detect clipping. [ ... ]
	2	Expansion: Pad string length by 30-50% to test UI overflow.
	◦	Method: Repeat vowels or append exclamation marks.
	3	Diacritics: Replace standard ASCII chars with extended characters to test font rendering.
	◦	a -> à, e -> é, o -> ô.
	4	Output: [!!! Stàrt Gámé !!!]
B. Options Menu Update Logic Input: Setting Change Event
	1	Is setting Language?
	◦	Yes:
	1	Await _localization.LoadLocaleAsync(newValue).
	2	Re-build OptionsViewModel (Labels must update to new language).
	3	Call _renderer.Render(newViewModel).
	◦	No: Proceed with standard update.

3. Deliverable Checklist
	•	Core:
	◦	[ ] Add Language property to GameSettings (default "en-US").
	◦	[ ] Add Language to SettingsDto for persistence.
	◦	[ ] Add PseudoLocalization helper class.
	•	Engine:
	◦	[ ] Update LocalizationService.Get() to intercept "qps-ploc" and apply pseudo-logic.
	◦	[ ] Add GetAvailableLocales() method to LocalizationService.
	•	Terminal:
	◦	[ ] Update OptionsViewModel to include Language dropdown.
	◦	[ ] Update OptionsController to handle language switching triggers.
	•	Tests:
	◦	[ ] PseudoLocalization_ExpandsLength: Verify string is longer than input.
	◦	[ ] Options_LanguageSwitch_Persists: Verify settings save correctly.

4. Code Implementation
A. Pseudo-Localizer Helper (RuneAndRust.Engine/Services/PseudoLocalizer.cs)
public static class PseudoLocalizer
{
    private static readonly Dictionary<char, char> _replacements = new()
    {
        {'a', 'à'}, {'e', 'é'}, {'i', 'î'}, {'o', 'ô'}, {'u', 'ü'},
        {'A', 'À'}, {'E', 'É'}, {'I', 'Î'}, {'O', 'Ô'}, {'U', 'Ü'}
    };

    public static string Localize(string input)
    {
        var sb = new StringBuilder();
        sb.Append("[!!"); // Start wrapper

        foreach (var c in input)
        {
            sb.Append(_replacements.TryGetValue(c, out var r) ? r : c);
        }

        // 30% expansion padding
        int pad = (int)(input.Length * 0.3);
        sb.Append(new string('!', pad));

        sb.Append("!!]"); // End wrapper
        return sb.ToString();
    }
}
B. Service Update (LocalizationService.cs)
public string Get(string key, params object[] args)
{
    // 1. Handle Pseudo-Localization Mode
    if (_currentCulture == "qps-ploc")
    {
        // Get English base, then mangle it
        var baseStr = _fallbackTranslations.GetValueOrDefault(key, key);
        var formatted = string.Format(baseStr, args);
        return PseudoLocalizer.Localize(formatted);
    }

    // 2. Standard Lookup (Existing Logic)
    // ...
}
C. Options Integration (OptionsController.cs)
private void BuildLanguageOption(OptionsViewModel vm)
{
    var languages = new List<string> { "en-US", "es-ES", "qps-ploc" }; // Discovery logic later

    vm.CurrentItems.Add(new SettingItemView(
        Name: _loc.Get(LocKeys.UI_Options_Language), // Localized Label!
        ValueDisplay: _currentLanguage,
        Type: SettingType.Enum,
        IsSelected: index == vm.SelectedIndex,
        PropertyName: "Language",
        EnumValues: languages
    ));
}

5. Logging Requirements
System
Event
Level
Message Template
Properties
Loc
Switch
Info
"Language switched to {Culture}"
Culture
Loc
Pseudo
Debug
"Pseudo-loc generated: {Input} -> {Output}"
Input, Output
Options
Refresh
Info
"UI Refreshed due to locale change."
-

6. Testing Strategy
Unit Tests (LocalizationServiceTests.cs):
	•	Pseudo_TransformsText:
	◦	Arr: Set locale to "qps-ploc".
	◦	Act: Get("Test").
	◦	Assert: Returns "[!!Tést!!]" (approx).
	•	Pseudo_ExpandsLength:
	◦	Act: Get("Short").
	◦	Assert: Length > Original Length (checks for overflow simulation).
Integration Tests:
	•	Switch_Updates_UI:
	◦	Arr: Open Options. Select "qps-ploc".
	◦	Act: Confirm selection.
	◦	Assert: OptionsViewModel.Name is now garbled (e.g., [!!Óptîôns!!]). This confirms the UI re-rendered using the new service state.

7. Draft Changelog (v0.3.15)
# v0.3.15 Changelog: The Scribe
**Release Date:** 2026-02-28

## Summary
This release implements the complete localization infrastructure ("The Scribe"). The game engine is no longer hardcoded to English; all UI text is now loaded dynamically from resource files. We have also added a "Pseudo-Localization" mode to help developers identify UI layout issues and untranslated strings.

## New Features
*   **Localization Support:** The game can now load language packs from `data/locales/`.
*   **Language Selector:** Added a Language option to the Settings menu.
*   **Pseudo-Localization:** A "Test Language" (qps-ploc) that garbles text (e.g., `[!!Sêttîngs!!]`) to test font rendering and UI expansion.

## Technical Changes
*   **LocalizationService:** Implemented JSON-based string loading and caching.
*   **String Extraction:** Migrated over 200 hardcoded UI strings to `en-US.json`.
*   **Settings Persistence:** Added `Language` key to `options.json`.
