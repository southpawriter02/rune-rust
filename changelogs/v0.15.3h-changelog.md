# v0.15.3h Changelog - Extended Influence System

## Summary

Implements the **Extended Influence System** subsystem of the Rhetoric skill. Enables players to gradually change NPC beliefs over multiple interactions through cumulative influence mechanics. Features five conviction levels (WeakOpinion DC 10 to Fanatical DC 18) with escalating difficulty and resistance mechanics. Influence attempts accumulate successes into an Influence Pool that must reach a conviction-based threshold (5-25 points) to change the belief. Failed attempts build Resistance (0 to +2 per failure depending on conviction level) that increases effective DC. System supports Active, Successful, Failed, and Stalled states with full state machine mechanics including resume from stall with resistance reduction.

## Added

### Domain Layer - Enums (2 files)

| File | Description |
|------|-------------|
| `ConvictionLevel.cs` | 5-level enum: WeakOpinion (DC 10, 5 pool, 0 resistance), ModerateBelief (DC 12, 10 pool, 0 resistance), StrongConviction (DC 14, 15 pool, +0.5 resistance/failure), CoreBelief (DC 16, 20 pool, +1 resistance/failure), Fanatical (DC 18, 25 pool, +2 resistance/failure). Represents how deeply an NPC holds a belief. |
| `InfluenceStatus.cs` | 4-state enum: Active (in progress), Successful (belief changed), Failed (permanently blocked), Stalled (awaiting external event). Terminal states: Successful, Failed. Resumable: Stalled only. |

### Domain Layer - Extensions (2 files)

| File | Description |
|------|-------------|
| `ConvictionLevelExtensions.cs` | `GetBaseDc()`, `GetPoolThreshold()`, `GetResistancePerFailure()`, `GetDisplayName()`, `GetDescription()`, `GetNarrativeDescription()`, `GetExampleBeliefs()`, `GetColorHint()`, `GetDifficultyIndicator()`, `GetMechanicsSummary()`, `GetEstimatedAttempts()`, `IsHighDifficulty()`, `GetWarningText()` |
| `InfluenceStatusExtensions.cs` | `IsTerminal()`, `IsSuccess()`, `IsFailure()`, `CanContinue()`, `CanResume()`, `IsRelevant()`, `IsPaused()`, `GetDisplayName()`, `GetDescription()`, `GetStatusIndicator()`, `GetColorHint()`, `GetNextStepHint()`, `ShowsProgress()`, `ToLogString()`, `GetSortOrder()` |

### Domain Layer - Value Objects (1 file)

| File | Description |
|------|-------------|
| `InfluenceAttemptResult.cs` | Readonly record struct capturing single influence attempt outcome. Properties: SkillCheckSucceeded, NetSuccesses, PoolChange, NewPoolTotal, ThresholdRequired, ResistanceChange, NewResistanceTotal, IsConvictionChanged, Status, TargetConviction, InteractionNumber, BaseDc, EffectiveDc, DiceRolled, SuccessesRolled, StallReason, ResumeCondition, NarrativeDescription, Timestamp. Computed: ProgressRatio, ProgressPercentage, RemainingPool, IsBreakthrough. Factory methods: `Success()`, `Failure()`, `Stalled()` |

### Domain Layer - Entities (1 file)

| File | Description |
|------|-------------|
| `ExtendedInfluence.cs` | Sealed class aggregate root for influence tracking: Id (Guid), CharacterId, TargetId, TargetName, BeliefId, BeliefDescription, TargetConviction, InfluencePool, ResistanceModifier, MaxResistance, InteractionCount, SuccessfulInteractions, Status, CreatedAt, LastInteractionAt, ConvictionChangedAt, StallReason, ResumeCondition, History. Methods: `Create()`, `AddToPool()`, `IncrementResistance()`, `RecordAttempt()`, `GetThreshold()`, `GetBaseDc()`, `GetEffectiveDc()`, `IsThresholdReached()`, `Stall()`, `Resume()`, `Fail()`, `GetStateSummary()`, `ToProgressDisplay()`, `CanSucceed()`, `GetEstimatedAttemptsRemaining()` |

### Domain Layer - Interfaces (1 file)

| File | Description |
|------|-------------|
| `IExtendedInfluenceRepository.cs` | Repository interface: `Add()`, `GetById()`, `GetByCharacterTargetAndBelief()`, `GetByCharacterAndTarget()`, `GetByCharacter()`, `GetActiveByCharacter()`, `GetByTarget()`, `GetByStatus()`, `GetStalledByCharacter()`, `GetSuccessfulByCharacter()`, `Update()`, `Save()`, `Delete()`, `DeleteByCharacter()`, `DeleteByTarget()`, `Count()`, `CountByStatus()`, `Exists()` |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `IExtendedInfluenceService.cs` | Service interface: `AttemptInfluence()` (sync and async), `GetInfluenceProgress()` (2 overloads), `GetInfluenceProgressByTarget()`, `GetActiveInfluences()`, `GetInfluencesOnTarget()`, `GetSuccessfulInfluences()`, `GetStalledInfluences()`, `ResumeInfluence()`, `StallInfluence()`, `FailInfluence()`, `CheckConvictionThreshold()`, `InitializeInfluence()`, `GetOrCreateInfluence()`, `GetTacticalAdvice()`, `GetInfluenceSummary()`, `CalculateEffectiveDc()`, `CalculateResistanceIncrease()`, `RemoveInfluence()`, `GetStatistics()`. Includes `InfluenceStatistics` record struct. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `ExtendedInfluenceService.cs` | Full implementation with ILogger<ExtendedInfluenceService> and IExtendedInfluenceRepository dependencies. Constants: MaxResistance=6, StallResistanceThreshold=4, DefaultResumeResistanceReduction=2, SuccessThreshold=6 (6+ on d10). Implements success-counting dice mechanics, conviction-based resistance accumulation, fractional resistance tracking for StrongConviction, automatic stall detection, failure detection, tactical advice generation, narrative description generation. |

### Infrastructure Layer - Repository (1 file)

| File | Description |
|------|-------------|
| `InMemoryExtendedInfluenceRepository.cs` | ConcurrentDictionary-based implementation with thread-safe CRUD operations. Efficient O(1) lookup by ID, O(n) scans for character/target/status queries. Includes `Clear()` and `GetAll()` for testing/admin purposes. |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/social/conviction-levels.json` | Conviction level definitions: id, displayName, description, poolRequired, baseDc, resistancePerFailure, colorHint, difficultyIndicator, examples, mechanicsSummary, narrativeDescription, warningText. GlobalSettings: maxResistance (6), stallThreshold (4), resumeResistanceReduction (2), successCountingThreshold (6), diceType (d10). Includes resistanceMechanics, statusDescriptions, progressDisplay, tacticalAdvice, narrativeTemplates. |
| `config/schemas/conviction-levels.schema.json` | JSON Schema for conviction-levels.json validation. Defines ConvictionLevel, GlobalSettings, ResistanceMechanics, StatusDescriptions, StatusInfo, ProgressDisplay, ProgressBand, NarrativeTemplates definitions. |

### Unit Tests (1 test file, 50+ tests)

| File | Tests |
|------|-------|
| `ExtendedInfluenceSystemTests.cs` | ConvictionLevel GetBaseDc (10/12/14/16/18), GetPoolThreshold (5/10/15/20/25), GetResistancePerFailure (0/0/0.5/1/2), GetDisplayName non-empty, DC/threshold increase with level, IsHighDifficulty (CoreBelief/Fanatical). InfluenceStatus IsTerminal (Successful/Failed=true), IsSuccess, IsFailure, CanContinue (Active only), CanResume (Stalled only), IsPaused, IsRelevant, GetSortOrder. ExtendedInfluence Create state, GetThreshold/GetBaseDc/GetEffectiveDc, AddToPool accumulation, threshold triggers conviction change, throws when not active. IncrementResistance no accumulation for lower convictions, +0.5/failure for StrongConviction, +1/failure for CoreBelief, +2/failure for Fanatical, capped at MaxResistance, failure when max resistance with low pool. Stall/Resume mechanics, Fail mechanics. InfluenceAttemptResult factory methods, progress calculations. GetStateSummary/ToProgressDisplay, CanSucceed/GetEstimatedAttemptsRemaining. |

## Key Features

### Conviction Levels

| Level | Base DC | Pool Threshold | Resistance/Failure | Typical Examples |
|-------|:-------:|:--------------:|:------------------:|------------------|
| WeakOpinion | 10 | 5 | 0 | Casual preferences, passing opinions |
| ModerateBelief | 12 | 10 | 0 | Political alignment, professional opinions |
| StrongConviction | 14 | 15 | +0.5 | Religious practices, personal loyalties |
| CoreBelief | 16 | 20 | +1 | Family devotion, absolute faith |
| Fanatical | 18 | 25 | +2 | Identity-defining devotion, prophecy fulfillment |

### Influence Status State Machine

| Status | Terminal | Can Continue | Can Resume | Description |
|--------|:--------:|:------------:|:----------:|-------------|
| Active | No | Yes | No | Influence attempt is ongoing |
| Successful | Yes | No | No | Belief has been changed |
| Failed | Yes | No | No | Permanently blocked |
| Stalled | No | No | Yes | Awaiting external event |

### Influence Pool Mechanics

```
On Successful Rhetoric Check:
  Influence Pool += Net Successes (successes - DC requirement)
  If Pool >= Threshold: Status → Successful, Conviction Changed

On Failed Rhetoric Check:
  Resistance += ConvictionLevel.ResistancePerFailure
  If Resistance >= MaxResistance AND Pool < 50% Threshold:
    Status → Failed
  If Resistance >= StallThreshold:
    Status → Stalled (requires external event)
```

### Effective DC Calculation

```
Effective DC = Base DC (from Conviction Level)
             + Resistance Modifier (0-6)
             + Any contextual modifiers
```

### Stall and Resume Mechanics

| Trigger | Stall Condition | Resume Requirement | Resistance Reduction |
|---------|-----------------|--------------------|--------------------|
| High Resistance | Resistance ≥ 4 | 24+ hours game time | -2 |
| Fumble Consequence | Critical failure | Complete related quest | -2 |
| Evidence Contradicted | NPC witnesses contrary evidence | Find counter-evidence | -2 |
| Emotional State | NPC emotional shutdown | Wait for mood change | -2 |

## Files Changed

| File | Change |
|------|--------|
| `src/Core/RuneAndRust.Domain/Enums/ConvictionLevel.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/InfluenceStatus.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/ConvictionLevelExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/InfluenceStatusExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/InfluenceAttemptResult.cs` | Added |
| `src/Core/RuneAndRust.Domain/Entities/ExtendedInfluence.cs` | Added |
| `src/Core/RuneAndRust.Domain/Interfaces/IExtendedInfluenceRepository.cs` | Added |
| `src/Core/RuneAndRust.Application/Interfaces/IExtendedInfluenceService.cs` | Added |
| `src/Core/RuneAndRust.Application/Services/ExtendedInfluenceService.cs` | Added |
| `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryExtendedInfluenceRepository.cs` | Added |
| `config/social/conviction-levels.json` | Added |
| `config/schemas/conviction-levels.schema.json` | Added |
| `tests/RuneAndRust.Domain.UnitTests/Services/ExtendedInfluenceSystemTests.cs` | Added |
| `changelogs/v0.15.3h-changelog.md` | Added |

## Test Results

```
Total tests: 85
     Passed: 85
     Failed: 0
Build succeeded with 0 warnings, 0 errors
Test execution time: 0.42 seconds
```

## Dependencies

- **v0.15.3g:** `CulturalProtocolService` patterns for cultural modifiers integration
- **v0.15.3f:** `InterrogationService` patterns for multi-round state tracking
- **v0.15.3e:** `NegotiationService` patterns for outcome accumulation
- **v0.15.3c:** `DeceptionService` patterns for skill check mechanics
- **v0.15.3b:** `PersuasionService` patterns for target resistance
- **v0.15.3a:** `SocialContext`, `SocialContextBuilder`, `SocialModifier`
- **v0.15.1b:** `SkillOutcome`, dice pool calculation patterns
- **v0.15.0:** `DiceRollResult`, `IDiceRollerService`

## Integration Points

### Previous Subsystems (v0.15.3a-g)

- **Persuasion:** Extended influence builds on persuasion check results
- **Intimidation:** Can be used to build influence pool through fear
- **Deception:** Failed deception may stall influence attempts
- **Negotiation:** Successful negotiation can add to influence pool
- **Interrogation:** Information gained may support influence arguments
- **Cultural Protocols:** Proper protocol compliance affects influence DC

### v0.15.3i (Specialization Abilities)

- Kupmaðr specialization grants bonuses to extended influence attempts
- Skald specialization abilities may provide pool bonuses
- Character backgrounds may grant starting pool with specific NPCs

### Future Integration

- Quest system can trigger automatic influence success/failure
- Reputation system affects starting resistance
- Time passage can reduce resistance naturally
- NPC schedules affect availability for influence attempts

## Notes

- Influence is tracked per-character, per-NPC, per-belief (unique combination)
- An NPC may have multiple beliefs at different conviction levels
- Fanatical beliefs may require extraordinary circumstances (quest events) to change
- Resistance builds only for StrongConviction and higher conviction levels
- StrongConviction uses fractional resistance (+0.5/failure, tracked internally)
- Maximum resistance of 6 represents NPC becoming closed to further influence
- Stall at resistance ≥ 4 prevents "brute force" influence attempts
- Resume reduces resistance by 2, rewarding patience and quest completion
- Pool is never lost - progress is preserved even through stalls
- Success-counting dice: roll d10 pool, count 6+ as successes
- Net successes = successes rolled - effective DC
- Service uses in-memory tracking; production requires persistence
- Repository interface supports efficient queries for UI display
- Configuration JSON includes narrative templates for dynamic text generation
- Status indicators use Unicode characters: ◐ (Active), ✓ (Successful), ✗ (Failed), ⏸ (Stalled)
