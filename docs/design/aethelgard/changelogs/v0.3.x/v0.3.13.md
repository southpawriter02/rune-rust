# Changelog: v0.3.13 - The Audit Suite

**Versions:** v0.3.13a through v0.3.13b
**Release Dates:** 2025-12-24 (both parts)

## Table of Contents

- [Overview](#overview)
- [Key Metrics](#key-metrics)
- [Part A: The Loot Audit (Monte Carlo Loot Simulation)](#part-a-the-loot-audit-monte-carlo-loot-simulation)
  - [Summary](#summary)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Test Coverage](#test-coverage)
- [Part B: The Combat Simulator (Headless Combat Testing)](#part-b-the-combat-simulator-headless-combat-testing)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Test Coverage](#test-coverage-1)
- [CLI Usage Guide](#cli-usage-guide)
- [Breaking Changes](#breaking-changes)
- [Migration Notes](#migration-notes)
- [Related Specifications](#related-specifications)
- [Documentation Additions](#documentation-additions)

---

## Overview

The **v0.3.13 Audit Suite** is a major 2-phase implementation introducing **Monte Carlo simulation tools** for validating game economy and combat balance. Developers can now run thousands of loot generation cycles or combat encounters instantly to ensure drop rates and win rates match design intentions before players encounter them.

**Architecture Established:**
- **Monte Carlo Simulation Pattern** - Run N iterations, accumulate statistics, analyze distributions
- **Variance Flagging System** - Compare actual vs expected rates, classify severity (OK/Warning/Critical)
- **Statistics Accumulator Models** - `LootStatistics`, `CombatStatistics` with derived metrics
- **Simulated Player Agent** - Heuristic AI for headless combat simulation
- **CLI Integration Pattern** - Generic argument parsing helpers (`ParseIntArg`, `ParseEnumArg`, `ParseStringArg`)
- **Markdown Report Generation** - Structured reports with tables and anomaly sections

**Layers Touched:**
- **Core Layer:** `LootStatistics`, `CombatStatistics`, `ILootAuditService`, `ICombatAuditService`, `VarianceSeverity`
- **Engine Layer:** `LootAuditService`, `CombatAuditService`, `SimulatedPlayerAgent`
- **Terminal Layer:** CLI argument handling for `--audit-loot` and `--audit-combat`
- **Test Layer:** 67 tests across 4 test files (100% passing)

---

## Key Metrics

| Metric | Value |
|--------|-------|
| New Files Created | 12 |
| Files Modified | 4 |
| Total Tests | 67 (27 loot + 40 combat) |
| Test Pass Rate | 100% |
| Loot Audit Performance | ~500ms for 10,000 iterations |
| Combat Audit Performance | ~2s for 1,000 iterations |
| Regressions | 0 |

---

## Part A: The Loot Audit (Monte Carlo Loot Simulation)

**Release Date:** 2025-12-24
**Theme:** Economy validation through Monte Carlo simulation

### Summary

Version 0.3.13a introduces the **Loot Audit Tool**, a Monte Carlo simulation engine for validating the game's economy. Developers can now run thousands of loot generation cycles instantly to ensure drop rates match design intentions before players encounter them.

**Patterns Introduced:**
- **Monte Carlo Simulation Pattern:** Run N iterations of loot generation, accumulate statistics
- **Variance Flagging Pattern:** Compare actual vs expected rates, classify severity (OK/WARN/CRIT)
- **CLI Argument Parsing Pattern:** Generic `ParseIntArg()` and `ParseEnumArg<T>()` helper methods
- **Markdown Report Generation Pattern:** Structured report with tables, headers, anomaly sections

### New Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/Analysis/LootStatistics.cs` | Statistics accumulator model for Monte Carlo analysis |
| `RuneAndRust.Core/Interfaces/ILootAuditService.cs` | Service interface with configuration, report, and variance records |
| `RuneAndRust.Engine/Services/LootAuditService.cs` | Monte Carlo simulation service |
| `RuneAndRust.Tests/Engine/LootStatisticsTests.cs` | 15 unit tests for statistics model |
| `RuneAndRust.Tests/Integration/LootAuditIntegrationTests.cs` | 12 integration tests for audit service |
| `docs/audits/.gitkeep` | Creates output directory for audit reports |

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added DI registration, CLI handling for `--audit-loot` |

### Code Implementation Details

**LootStatistics Model:**
- Tracks: TotalIterations, TotalItemsDropped, TotalScripValue, TotalWeight
- Distributions: QualityTierCounts, ItemTypeCounts
- Derived Metrics: AverageScripPerIteration, AverageItemsPerIteration, SuccessRate

**Variance Classification (Loot):**
- OK: |Variance| ≤ 1%
- Warning: 1% < |Variance| ≤ 5%
- Critical: |Variance| > 5%

**LootAuditConfiguration:**
```csharp
public record LootAuditConfiguration(
    int Iterations,      // Number of loot cycles to run
    BiomeType Biome,     // Affects item type distribution
    DangerLevel DangerLevel, // Affects quality tier weights
    int WitsBonus = 0);  // Optional WITS bonus for quality upgrade
```

### Test Coverage

- **LootStatisticsTests:** 15 tests (accumulation, distributions, derived metrics)
- **LootAuditIntegrationTests:** 12 tests (sanity checks, variance flags, biome distributions)
- **All passing:** 27/27 (100%)

---

## Part B: The Combat Simulator (Headless Combat Testing)

**Release Date:** 2025-12-24
**Theme:** Combat balance validation through headless simulation

### Summary

Version 0.3.13b introduces the **Combat Audit Tool**, a Monte Carlo simulation engine for validating combat balance. Developers can now run thousands of simulated battles instantly to measure win rates, TTK (Time-To-Kill), hit rates, and resource consumption before players encounter them.

**Patterns Introduced:**
- **Headless Combat Loop Pattern:** Run combat without TUI rendering or UX delays
- **Simulated Player Agent Pattern:** Heuristic AI that makes "reasonable" resource-aware attack decisions
- **Synchronous Turn Processing Pattern:** `ProcessEnemyTurnSync()` variant without 750ms UX delay
- **Combat Statistics Accumulator Pattern:** Track wins, hits, damage, rounds across thousands of matches
- **Fresh DI Scope Per Match:** Isolated state for each simulation

### New Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/Analysis/CombatStatistics.cs` | Statistics accumulator for combat analysis |
| `RuneAndRust.Core/Interfaces/ICombatAuditService.cs` | Service interface with configuration, report, and variance records |
| `RuneAndRust.Engine/Services/CombatAuditService.cs` | Monte Carlo combat simulation service |
| `RuneAndRust.Engine/Simulation/SimulatedPlayerAgent.cs` | Heuristic AI for simulated player decisions |
| `RuneAndRust.Tests/Engine/CombatStatisticsTests.cs` | 24 unit tests for statistics model |
| `RuneAndRust.Tests/Integration/CombatAuditIntegrationTests.cs` | 16 integration tests for audit service |

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `ProcessEnemyTurnSync()` method signature |
| `RuneAndRust.Engine/Services/CombatService.cs` | Implemented `ProcessEnemyTurnSync()` without delay |
| `RuneAndRust.Terminal/Program.cs` | Added DI registration, CLI handling for `--audit-combat` |
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added service registrations for audit tests |

### Code Implementation Details

**CombatStatistics Model:**
- Aggregate: TotalEncounters, PlayerWins, EnemyWins, TotalRounds
- Damage: TotalPlayerDamageDealt/Received, PlayerHits/Misses, EnemyDamageDealt, EnemyHits/Misses
- Resources: TotalPlayerStaminaSpent, TotalPlayerHPRemaining
- Derived: WinRate, AvgRoundsPerEncounter, PlayerHitRate, EnemyHitRate, AvgDamagePerHit

**Variance Classification (Combat):**
- OK: Actual value within [ExpectedMin, ExpectedMax]
- Warning: 5% outside expected bounds
- Critical: 15% outside expected bounds

**Expected Combat Bounds:**
| Metric | Min | Max |
|--------|-----|-----|
| Win Rate | 70% | 90% |
| Avg Rounds | 3 | 8 |
| Hit Rate | 65% | 85% |

**SimulatedPlayerAgent Strategy:**
1. **Finisher:** Heavy Attack if enemy HP ≤ 2× weapon die AND stamina ≥ 40
2. **Resource-Aware:** Heavy (≥40 stamina) → Standard (≥20) → Light (<20)

**CombatAuditConfiguration:**
```csharp
public record CombatAuditConfiguration(
    int Iterations,              // Number of matches
    ArchetypeType PlayerArchetype, // Warrior, Skirmisher, Adept
    string EnemyTemplateId,      // e.g., "und_draugr_01"
    int PlayerLevel = 1,         // Level for stat scaling
    int? Seed = null);           // Optional RNG seed
```

### Test Coverage

- **CombatStatisticsTests:** 24 tests (encounter recording, attacks, derived metrics)
- **CombatAuditIntegrationTests:** 16 tests (sanity checks, archetypes, enemies, variance)
- **All passing:** 40/40 (100%)

---

## CLI Usage Guide

### Loot Audit

```bash
# Default: 10000 iterations, Ruin biome, Safe danger
dotnet run --project RuneAndRust.Terminal -- --audit-loot

# Custom configuration
dotnet run --project RuneAndRust.Terminal -- --audit-loot --iterations=50000 --biome=Industrial --danger=Hostile --wits=5
```

**Parameters:**

| Parameter | Default | Values | Description |
|-----------|---------|--------|-------------|
| `--iterations` | 10000 | Positive int | Loot generation cycles |
| `--biome` | Ruin | Ruin, Industrial, Organic, Void | Item type distribution |
| `--danger` | Safe | Safe, Unstable, Hostile, Lethal | Quality tier weights |
| `--wits` | 0 | 0-10 | WITS bonus for quality upgrade |

### Combat Audit

```bash
# Default: 1000 matches, Warrior vs Rusted Draugr, Level 1
dotnet run --project RuneAndRust.Terminal -- --audit-combat

# Custom configuration
dotnet run --project RuneAndRust.Terminal -- --audit-combat --iterations=5000 --archetype=Skirmisher --enemy=bst_vargr_01 --level=3
```

**Parameters:**

| Parameter | Default | Values | Description |
|-----------|---------|--------|-------------|
| `--iterations` | 1000 | Positive int | Combat simulations |
| `--archetype` | Warrior | Warrior, Skirmisher, Adept | Player archetype |
| `--enemy` | und_draugr_01 | Template ID | Enemy template |
| `--level` | 1 | 1-10 | Enemy scaling level |

### Available Enemy Templates

| Template ID | Name | Tier |
|-------------|------|------|
| `und_draugr_01` | Rusted Draugr | Standard |
| `und_haug_01` | Haugbui Laborer | Standard |
| `mec_serv_01` | Utility Servitor | Minion |
| `bst_vargr_01` | Ash-Vargr | Standard |
| `hum_raider_01` | Rust-Clan Scav | Standard |

### Output Location

Reports are written to: `docs/audits/{type}_audit_YYYYMMDD_HHMMSS.md`

---

## Breaking Changes

### ProcessEnemyTurnSync Added to ICombatService (v0.3.13b)

**Change:** New method added to `ICombatService` interface.

```csharp
void ProcessEnemyTurnSync(Combatant enemy);
```

**Impact:** Any mock implementations of `ICombatService` must add this method.

**Migration:** Add empty or stubbed implementation in test mocks.

---

## Migration Notes

### For Existing Installations

**Automatic:** No data migration required. Audit tools are additive.

### For Developers

**Running Audits:**
1. Build the solution: `dotnet build`
2. Run loot audit: `dotnet run --project RuneAndRust.Terminal -- --audit-loot`
3. Run combat audit: `dotnet run --project RuneAndRust.Terminal -- --audit-combat`
4. Review reports in `docs/audits/`

**Interpreting Reports:**
- **OK:** Metric is within acceptable bounds
- **WARNING:** Notable deviation, investigate design/implementation
- **CRITICAL:** Significant imbalance, requires immediate attention

---

## Related Specifications

- **SPEC-AUDIT-001:** Audit Framework (created with this changelog)
- **SPEC-LOOT-001:** Loot Generation System (audited by loot audit)
- **SPEC-COMBAT-001:** Combat System (audited by combat audit)

---

## Documentation Additions

**Date:** 2025-12-25

The following documentation was created or updated to support v0.3.13:

### New Documentation Created

| File | Description |
|------|-------------|
| `docs/specs/tools/SPEC-AUDIT-001.md` | Comprehensive specification for the Audit Framework |
| `docs/changelogs/v0.3.x/v0.3.13.md` | Consolidated changelog (this file) |

### Files Updated

| File | Changes |
|------|---------|
| `docs/specs/README.md` | Added Developer Tools section with SPEC-AUDIT-001; updated spec count (46 → 47); bumped version to 0.4.4 |

### SPEC-AUDIT-001 Contents

The new specification documents:
- **Overview:** Monte Carlo simulation framework for game validation
- **Core Concepts:** Simulation pattern, variance flagging, statistics accumulators
- **Interfaces:** `ILootAuditService`, `ICombatAuditService` contracts
- **Data Models:** `LootStatistics`, `CombatStatistics`, configuration records
- **SimulatedPlayerAgent:** Heuristic decision-making for combat simulation
- **CLI Integration:** `--audit-loot`, `--audit-combat` with parameters
- **Testing:** 67 tests across 4 test files (100% passing)

---

## Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.13a | The Loot Audit | Monte Carlo loot simulation, variance flagging |
| v0.3.13b | The Combat Simulator | Headless combat testing, SimulatedPlayerAgent |

---

**Release Signature:**
```
Version: v0.3.13 - The Audit Suite
Date: 2025-12-24
Architect: The Chronicle-Smith (Claude Opus 4.5)
Tests: 67/67 Passed (100%)
Build: Success
Coverage: All features tested
Regressions: 0
```

---

**For detailed implementation notes, see individual part changelogs in archive:**
- `archive/v0.3.13a.md`
- `archive/v0.3.13b.md`
