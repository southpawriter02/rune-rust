# Changelog: v0.3.19c - The Soundscape

**Release Date:** 2025-12-26

---

## Summary

This release introduced a **turn-based procedural ambient soundscape system** to enhance environmental immersion during exploration. The `AmbienceService` generates biome-specific atmospheric audio cues at randomized intervals (2-5 turns), creating dynamic atmosphere without overwhelming gameplay. Each of the four biome types (Ruin, Industrial, Organic, Void) has distinct frequency and duration ranges that reflect their thematic characteristics. Players can toggle ambient soundscape on/off via the Options menu Audio tab, with settings persisting to `data/options.json`.

**Architecture Focus:** This release extends the audio system (Engine Layer) by adding ambient soundscape generation, integrates it into the game loop for turn-based triggering, and expands the Options UI to support the new setting.

**Key Patterns:** Service-Repository pattern with scoped repository access, dependency injection with optional service parameters, turn-based event triggering with randomized intervals.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IAmbienceService.cs` | Service contract for ambient soundscape generation with `IsEnabled`, `UpdateAsync(Guid roomId)`, and `Reset()` methods |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/AmbienceService.cs` | Turn-based ambience service implementing biome-specific audio profiles with randomized frequency/duration generation |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/AmbienceServiceTests.cs` | 13 unit tests validating ambience service behavior across all biomes, turn intervals, and edge cases |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Settings/GameSettings.cs` | Added `AmbienceEnabled` static property (bool, default: true) |
| `RuneAndRust.Core/Models/SettingsDto.cs` | Added `AmbienceEnabled` record property for settings serialization |
| `RuneAndRust.Core/ViewModels/OptionsViewModel.cs` | Added `AmbienceEnabled` property to support UI binding |
| `RuneAndRust.Core/Constants/LocKeys.cs` | Added `UI_Options_Setting_AmbienceEnabled` localization key constant |
| `data/locales/en-US.json` | Added "AmbienceEnabled": "Ambient Soundscape" in Settings section (line 43) |
| `RuneAndRust.Engine/Services/SettingsService.cs` | Added AmbienceEnabled to SaveAsync(), ResetToDefaultsAsync(), and ApplyDtoToSettings() methods |
| `RuneAndRust.Engine/Services/GameService.cs` | Added `_ambienceService` field (IAmbienceService?, nullable), updated constructor to accept optional parameter, integrated turn-based soundscape ticking after exploration commands (lines 115-119) |
| `RuneAndRust.Terminal/Program.cs` | Registered `IAmbienceService` as singleton in DI container (line 237) |
| `RuneAndRust.Terminal/Services/OptionsController.cs` | Added AmbienceEnabled to CreateViewModelFromSettings(), RefreshItems() Audio tab toggle, ToggleSetting() switch case, ResetToDefaultsAsync(), and ApplyToGameSettings() |

---

## Code Implementation Details

### IAmbienceService Interface

```csharp
public interface IAmbienceService
{
    /// <summary>
    /// Gets whether ambient soundscape is currently enabled.
    /// Reflects GameSettings.AmbienceEnabled value.
    /// </summary>
    bool IsEnabled { get; }

    /// <summary>
    /// Updates the ambience system for the current turn.
    /// May trigger an ambient sound cue based on turn interval and room biome.
    /// </summary>
    /// <param name="roomId">The current room's unique identifier.</param>
    Task UpdateAsync(Guid roomId);

    /// <summary>
    /// Resets the turn counter and randomizes the next trigger threshold.
    /// Call when entering a new room or starting a new game.
    /// </summary>
    void Reset();
}
```

### AmbienceService Constants

```csharp
private const int MinTurnInterval = 2;
private const int MaxTurnInterval = 5;
private const float AmbienceVolumeMultiplier = 0.6f;
```

**Behaviors:**
- Turn interval randomized between 2-5 turns after each ambient cue
- Ambient sounds play at 60% volume (quieter than combat/UI sounds)
- Turn counter increments on each `UpdateAsync()` call when enabled
- Skips sound generation if `GameSettings.AmbienceEnabled` is false

### Biome Audio Profiles

```csharp
private static readonly Dictionary<BiomeType, BiomeAudioProfile> BiomeProfiles = new()
{
    // Ruin: Wind whistling, stone shifting (mid-range, medium duration)
    [BiomeType.Ruin] = new BiomeAudioProfile(400, 600, 300, 600),

    // Industrial: Machine rumbles, pipe groans (low frequency, long duration)
    [BiomeType.Industrial] = new BiomeAudioProfile(100, 300, 500, 1000),

    // Organic: Skittering, rustling, dripping (high frequency, short duration)
    [BiomeType.Organic] = new BiomeAudioProfile(600, 900, 150, 400),

    // Void: Deep drones, eerie resonance (low-mid frequency, very long duration)
    [BiomeType.Void] = new BiomeAudioProfile(200, 250, 800, 1500)
};

private record BiomeAudioProfile(
    int MinFrequency,
    int MaxFrequency,
    int MinDurationMs,
    int MaxDurationMs);
```

**Profile Details:**
- **Ruin:** 400-600 Hz, 300-600 ms (mid-range tones for wind/stone)
- **Industrial:** 100-300 Hz, 500-1000 ms (low rumbles for machinery)
- **Organic:** 600-900 Hz, 150-400 ms (high tones for creatures/dripping)
- **Void:** 200-250 Hz, 800-1500 ms (narrow low-mid range for eerie drones)

### Key Methods

#### `UpdateAsync(Guid roomId)`

**Signature:** `public async Task UpdateAsync(Guid roomId)`

**Behaviors:**
- Returns immediately if `IsEnabled` is false (respects GameSettings)
- Increments internal turn counter
- Compares counter to randomized threshold (2-5 turns)
- Triggers ambient cue if threshold reached
- Resets counter and randomizes new threshold after each cue
- Logs trace events at entry, skip, waiting, and trigger points
- Uses `IServiceScopeFactory` to access scoped `IRoomRepository`
- Logs warning if room not found by ID
- Generates randomized SoundCue within biome's frequency/duration range
- Plays cue via `IAudioService.PlayAsync()`

#### `GenerateBiomeCue(BiomeType biome)`

**Signature:** `private SoundCue GenerateBiomeCue(BiomeType biome)`

**Behaviors:**
- Retrieves BiomeAudioProfile from dictionary (defaults to Ruin if not found)
- Randomizes frequency within profile's min/max range (inclusive)
- Randomizes duration within profile's min/max range (inclusive)
- Constructs SoundCue with ID `"ambience_{biometype}"` (lowercase)
- Sets SoundCategory to `SoundCategory.Ambience` (enum value: 2)
- Applies volume multiplier (0.6f)

#### `Reset()`

**Signature:** `public void Reset()`

**Behaviors:**
- Resets `_turnCounter` to 0
- Randomizes `_nextTriggerThreshold` between MinTurnInterval and MaxTurnInterval (inclusive)
- Logs debug event with new threshold value

### GameService Integration

```csharp
// Added in constructor (line ~67):
private readonly IAmbienceService? _ambienceService;

// Constructor parameter (optional for backwards compatibility):
public GameService(
    // ... existing parameters
    IAmbienceService? ambienceService = null)
{
    // ...
    _ambienceService = ambienceService;
}

// Game loop integration (lines 115-119):
// 5. Tick ambient soundscape after exploration commands (v0.3.19c)
if (_state.Phase == GamePhase.Exploration && _state.CurrentRoomId.HasValue && _ambienceService != null)
{
    await _ambienceService.UpdateAsync(_state.CurrentRoomId.Value);
}
```

**Integration Details:**
- Ambience service is optional (nullable) to support backwards compatibility
- Only ticks during Exploration phase (not Combat, Menu, etc.)
- Only ticks if CurrentRoomId has a value
- Only ticks if service is injected (not null)
- Executes after command parsing but before phase transition

### OptionsController Integration

**Methods Modified:**
1. **CreateViewModelFromSettings()** - Line 133: Maps `GameSettings.AmbienceEnabled` to ViewModel
2. **RefreshItems() Audio Tab** - Lines 250-256: Adds toggle setting to Audio tab UI
3. **ToggleSetting()** - Lines 510-512: Handles "AmbienceEnabled" case to toggle boolean
4. **ResetToDefaultsAsync()** - Line 529: Resets to default value (true)
5. **ApplyToGameSettings()** - Line 549: Persists ViewModel value to GameSettings

**UI Presentation:**
- Tab: Audio
- Label: "Ambient Soundscape" (localized via `LocKeys.UI_Options_Setting_AmbienceEnabled`)
- Value Display: "ON" or "OFF" (localized toggle format)
- Type: `SettingType.Toggle`
- Property Name: "AmbienceEnabled"

---

## Logging Matrix

### AmbienceService Events

| Event | Level | Template |
|-------|-------|----------|
| Service initialization | Information | `"[Ambience] AmbienceService initialized (Enabled: {IsEnabled})"` |
| UpdateAsync entry | Trace | `"[Ambience] UpdateAsync called (Enabled: {IsEnabled}, Turn: {Turn}/{Threshold})"` |
| Skipped (disabled) | Trace | `"[Ambience] Skipped - ambience disabled"` |
| Waiting for threshold | Trace | `"[Ambience] Waiting ({Turn}/{Threshold} turns)"` |
| Reset called | Debug | `"[Ambience] Reset - next trigger at {Threshold} turns"` |
| Room not found | Warning | `"[Ambience] Room not found: {RoomId}"` |
| Playing ambient cue | Debug | `"[Ambience] Playing {Biome} ambience: {Freq}Hz/{Dur}ms"` |
| Counter reset | Trace | `"[Ambience] Counter reset - next trigger at {Threshold} turns"` |

### OptionsController Events

| Event | Level | Template |
|-------|-------|----------|
| AmbienceEnabled toggle | Debug | `"[Options] AmbienceEnabled changed to {Value}"` |

---

## Test Coverage

**Summary:**
```
Total: 13 | Passed: 13 | Failed: 0 | Duration: <1000ms
```

### AmbienceServiceTests (13 tests)

| Test Name | Description |
|-----------|-------------|
| `IsEnabled_ReturnsTrue_WhenGameSettingsAmbienceEnabled` | Verifies IsEnabled property returns true when GameSettings.AmbienceEnabled is true |
| `IsEnabled_ReturnsFalse_WhenGameSettingsAmbienceDisabled` | Verifies IsEnabled property returns false when GameSettings.AmbienceEnabled is false |
| `UpdateAsync_WhenDisabled_DoesNotPlaySound` | Verifies no sound plays after 10 calls when ambience disabled |
| `UpdateAsync_WhenEnabled_EventuallyPlaysSound` | Verifies sound plays at least once after 6 calls when enabled (max interval is 5) |
| `UpdateAsync_WhenRoomNotFound_DoesNotPlaySound` | Verifies no sound plays after 10 calls when repository returns null room |
| `UpdateAsync_BiomeProfile_UsesCorrectFrequencyRange(biome: Ruin, minFreq: 400, maxFreq: 600)` | Verifies Ruin biome generates frequencies between 400-600 Hz |
| `UpdateAsync_BiomeProfile_UsesCorrectFrequencyRange(biome: Industrial, minFreq: 100, maxFreq: 300)` | Verifies Industrial biome generates frequencies between 100-300 Hz |
| `UpdateAsync_BiomeProfile_UsesCorrectFrequencyRange(biome: Organic, minFreq: 600, maxFreq: 900)` | Verifies Organic biome generates frequencies between 600-900 Hz |
| `UpdateAsync_BiomeProfile_UsesCorrectFrequencyRange(biome: Void, minFreq: 200, maxFreq: 250)` | Verifies Void biome generates frequencies between 200-250 Hz |
| `Reset_ResetsCounterAndDelaysTrigger` | Verifies Reset() restarts turn counter and prevents immediate trigger |
| `UpdateAsync_DoesNotTrigger_BeforeMinimumTurns` | Verifies sound does not play after 1 call (minimum interval is 2 turns) |
| `UpdateAsync_SoundCue_HasAmbienceCategory` | Verifies generated SoundCue has SoundCategory.Ambience category |
| `UpdateAsync_SoundCue_HasReducedVolume` | Verifies generated SoundCue VolumeMultiplier is less than 1.0 (actual: 0.6) |

**Test Patterns:**
- Uses Moq for IAudioService, IRoomRepository, ILogger mocking
- Uses IServiceScopeFactory mock to provide scoped IRoomRepository access
- Stores and restores original GameSettings.AmbienceEnabled value in Dispose()
- Uses FluentAssertions for readable assertions
- Uses Theory + InlineData for parameterized biome profile tests

---

## DI Registration

### Program.cs (Terminal Layer)

```csharp
// Line 237 in ConfigureServices():
services.AddSingleton<IAmbienceService, AmbienceService>();
```

**Lifetime:** Singleton (same instance shared across all requests)

**Dependencies:**
- `IAudioService` (injected via constructor)
- `IServiceScopeFactory` (injected via constructor for scoped repository access)
- `ILogger<AmbienceService>` (injected via constructor)

**Notes:**
- Service is registered as singleton because it maintains turn counter state
- Uses `IServiceScopeFactory` to create scoped `IRoomRepository` instances per call
- This pattern is necessary because singleton cannot directly consume scoped services

---

## Verification Results

### Build Output

```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:01.01
```

**Projects Built:**
- RuneAndRust.Core
- RuneAndRust.Persistence
- RuneAndRust.Engine
- RuneAndRust.Terminal

### Test Output

```
Passed! - Failed: 0, Passed: 13, Skipped: 0, Total: 13, Duration: <1000ms
```

**All AmbienceServiceTests passed successfully:**
- IsEnabled property tests: 2/2
- UpdateAsync behavior tests: 6/6
- Biome profile tests: 4/4
- SoundCue property tests: 2/2

---

## Directory Structure After Release

```
/Volumes/GitHub/github/southpawriter02/rune-rust/
├── data/
│   └── locales/
│       └── en-US.json [MODIFIED]
├── docs/
│   └── changelogs/
│       └── v0.3.x/
│           ├── v0.3.19a.md
│           ├── v0.3.19b.md
│           └── v0.3.19c.md [NEW]
├── RuneAndRust.Core/
│   ├── Constants/
│   │   └── LocKeys.cs [MODIFIED]
│   ├── Interfaces/
│   │   └── IAmbienceService.cs [NEW]
│   ├── Models/
│   │   └── SettingsDto.cs [MODIFIED]
│   ├── Settings/
│   │   └── GameSettings.cs [MODIFIED]
│   └── ViewModels/
│       └── OptionsViewModel.cs [MODIFIED]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── AmbienceService.cs [NEW]
│       ├── GameService.cs [MODIFIED]
│       └── SettingsService.cs [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Program.cs [MODIFIED]
│   └── Services/
│       └── OptionsController.cs [MODIFIED]
└── RuneAndRust.Tests/
    └── Engine/
        └── AmbienceServiceTests.cs [NEW]
```

---

## Running Tests

### Run All AmbienceService Tests

```bash
dotnet test --filter "FullyQualifiedName~AmbienceServiceTests"
```

### Run Specific Biome Profile Tests

```bash
dotnet test --filter "FullyQualifiedName~AmbienceServiceTests.UpdateAsync_BiomeProfile"
```

### Run All Audio-Related Tests

```bash
dotnet test --filter "FullyQualifiedName~Audio"
```

---

## Dependencies

This release builds upon audio system infrastructure from previous releases:

- **v0.3.19a:** `SoundCategory.Ambience` enum value (value: 2)
- **v0.3.19a:** `IAudioService.PlayAsync(SoundCue)` method
- **v0.3.19a:** `SoundCue` record with Category, Frequency, DurationMs, VolumeMultiplier properties
- **Existing:** `IRoomRepository.GetByIdAsync(Guid)` for biome lookup
- **Existing:** `BiomeType` enum with Ruin, Industrial, Organic, Void values
- **v0.3.15c:** `ILocalizationService` and `LocKeys` for UI strings
- **v0.3.10a:** `SettingsService` infrastructure for JSON persistence

---

## Next Steps

Planned for **v0.3.20** and beyond:

- **Extended Ambience Profiles:** Add variant sound profiles per biome (e.g., Ruin_Windy vs Ruin_Crumbling)
- **Contextual Ambience:** Trigger specific sounds based on room features (e.g., water dripping near pools)
- **Adaptive Volume:** Adjust ambience volume based on danger level or combat proximity
- **Ambient Music Layers:** Add low-volume biome-specific musical drones
- **Event-Triggered Ambience:** Override turn-based system for narrative moments
- **Debug Visualization:** Add debug console command to display current ambience state
- **Accessibility Option:** Add "Ambience Interval" slider to customize turn frequency
- **Audio Analysis Tools:** Implement spectral analysis for biome-specific frequency distribution validation

---

**END OF CHANGELOG v0.3.19c**
