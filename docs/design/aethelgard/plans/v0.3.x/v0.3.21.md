# v0.3.21: The Steward (Save Management)

## Overview

This milestone professionalizes the persistence layer. Currently, players only see basic info (Name/Date) when loading. This update adds rich metadata "snapshots" to save files and implements a safety net against soft-locks (saving immediately before a death spiral) via rolling autosaves.

### Sub-Version Breakdown

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.21a | The Preview | Save Metadata - Schema expansion to store and display game state summaries |
| v0.3.21b | The Vault | Rolling Backups - Logic to rotate autosaves and manage backup slots |

---

## v0.3.21a: The Preview (Save Metadata)

**Goal:** Enhance the `SaveGame` entity to store a lightweight "Snapshot" of the character's status (HP, Location, Level, Total Playtime). Update the Load Menu to render this rich preview.

### 1. Architecture & Data Flow

- **Schema Update:** Add a `Metadata` JSONB column to the `SaveGames` table. This prevents the need to deserialize the massive `SerializedState` blob just to show the HP bar in the menu.
- **Extraction:** During `SaveManager.SaveGameAsync`, extract key metrics from `GameState` and populate the `Metadata` object.
- **Presentation:** Update `TitleScreenService` (Load Game menu) to fetch and display `Metadata`.

#### Data Flow: The Save Pipeline

1. **Trigger:** Autosave or Manual Save initiated.
2. **Extraction:** `SaveManager` creates `SaveMetadata` from `GameState.CurrentCharacter` and `GameState.CurrentRoom`.
3. **Serialization:**
   - Full State → `SerializedState` column (Heavy)
   - Metadata → `Metadata` column (Light)
4. **Persist:** `SaveGameRepository` updates the DB.
5. **View:** Load Menu queries `GetAllOrderedByLastPlayedAsync` (projected to include `Metadata`) to render the preview.

### 2. Logic Decision Trees

#### A. Metadata Extraction Logic

**Input:** `GameState`

1. **Locate Character:** Is `CurrentCharacter` null?
   - **Yes:** `Metadata = "Empty/Corrupt"`
   - **No:**
     - Get `Name`, `Archetype`, `Level`
     - Get `CurrentHP`, `MaxHP`
     - Get `CurrentRoom.Name`
     - Calculate `TotalPlaytime` (`CurrentTime - StartTime`)
2. **Output:** Return `SaveMetadata` object.

#### B. Load Menu Rendering Logic

**Input:** `List<SaveGame>`

1. **Iterate Slots**
2. **Check Metadata:**
   - **Null:** Render "Corrupted Save"
   - **Valid:** Render Format:
     ```
     [Slot 1] Ragnar (Lvl 5 Warrior)
     Location: The Deep Shaft | HP: [Green]██░░░[/] (10/50)
     Played: 4h 23m
     ```

### 3. Code Implementation

#### A. Metadata Model

**File:** `RuneAndRust.Core/Models/SaveMetadata.cs`

```csharp
public class SaveMetadata
{
    public string CharacterName { get; set; } = string.Empty;
    public string Archetype { get; set; } = string.Empty;
    public int Level { get; set; }
    public int CurrentHp { get; set; }
    public int MaxHp { get; set; }
    public string LocationName { get; set; } = "Unknown";
    public TimeSpan TotalPlaytime { get; set; }
    public DateTime SaveTimestamp { get; set; }
}
```

#### B. SaveManager Update

**File:** `RuneAndRust.Engine/Services/SaveManager.cs`

```csharp
public async Task SaveGameAsync(int slot, GameState state)
{
    // ... existing serialization ...

    var metadata = new SaveMetadata
    {
        CharacterName = state.CurrentCharacter?.Name ?? "Unknown",
        Archetype = state.CurrentCharacter?.Archetype.ToString() ?? "None",
        Level = state.CurrentCharacter?.Level ?? 1,
        CurrentHp = state.CurrentCharacter?.CurrentHP ?? 0,
        MaxHp = state.CurrentCharacter?.MaxHP ?? 1,
        LocationName = state.CurrentRoom?.Name ?? "Void",
        SaveTimestamp = DateTime.UtcNow
        // Playtime tracking logic would go here
    };

    var saveGame = new SaveGame
    {
        SlotNumber = slot,
        Metadata = metadata, // New JSONB property
        SerializedState = jsonString,
        // ...
    };

    await _repository.SaveSlotAsync(saveGame);
}
```

### 4. Deliverable Checklist (v0.3.21a)

#### Persistence
- [ ] Create `SaveMetadata` class
- [ ] Update `SaveGame` entity with `Metadata` (JSONB)
- [ ] Create EF Core Migration (`AddSaveMetadata`)

#### Engine
- [ ] Update `SaveManager` to populate metadata

#### UI
- [ ] Update LoadGame menu to render HP bars and Location names

---

## v0.3.21b: The Vault (Rolling Backups)

**Goal:** Implement a rolling autosave system (Auto, Backup 1, Backup 2) to prevent soft-locks.

### 1. Architecture & Data Flow

#### Slot Reservation

| Slot | Purpose |
|------|---------|
| 0 | Primary Autosave |
| -1 | Backup 1 |
| -2 | Backup 2 |

#### Rotation Logic

Whenever an autosave triggers, shift existing saves down the chain before writing the new one. This ensures the player can always revert to a state from ~10-20 minutes ago.

### 2. Logic Decision Trees

#### A. Autosave Rotation Logic

**Input:** Trigger Autosave

1. **Delete Oldest:** Delete Slot -2 (if exists)
2. **Shift Backup:** Move Slot -1 to Slot -2 (Update `SlotNumber` in DB)
3. **Shift Primary:** Move Slot 0 to Slot -1
4. **Write New:** Save current state to Slot 0
5. **Commit:** Execute as a single Transaction to prevent data loss

#### B. Load Menu Integration

**Input:** Load Menu Request

1. **Fetch Standard:** Get Slots 1-3 (Manual)
2. **Fetch Auto:** Get Slot 0
3. **Fetch Backups:** Get Slots -1, -2
4. **Render:**
   - Display Auto/Manual normally
   - Add "History / Recover" submenu to access Backups

### 3. Code Implementation

#### A. Repository Rotation Method

**File:** `RuneAndRust.Persistence/Repositories/SaveGameRepository.cs`

```csharp
public async Task RotateAutosavesAsync()
{
    using var transaction = _context.Database.BeginTransaction();
    try
    {
        // 1. Delete oldest backup (-2)
        var oldBackup = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == -2);
        if (oldBackup != null) _dbSet.Remove(oldBackup);
        await _context.SaveChangesAsync();

        // 2. Rotate Backup 1 -> 2
        var midBackup = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == -1);
        if (midBackup != null) midBackup.SlotNumber = -2;

        // 3. Rotate Current Auto -> Backup 1
        var currentAuto = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == 0);
        if (currentAuto != null) currentAuto.SlotNumber = -1;

        await _context.SaveChangesAsync();
        await transaction.CommitAsync();
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

### 4. Deliverable Checklist (v0.3.21b)

#### Engine
- [ ] Implement `SaveManager.RotateAutosavesAsync`
- [ ] Update GameLoop to call Rotation before Autosaving

#### UI
- [ ] Add "Show Backups" toggle to Load Menu
- [ ] Render negative slots as "Backup [TimeAgo]"

---

## Logging Requirements

*Reference: logging.md*

| System | Event | Level | Message Template | Properties |
|--------|-------|-------|------------------|------------|
| Save | Rotation | Debug | `[Save] Rotated autosaves. Deleted slot -2.` | - |
| Save | Metadata | Trace | `[Save] Generated metadata for {Char}. Loc: {Loc}.` | `Char`, `Loc` |
| Persistence | Transaction | Verbose | `[DB] Autosave rotation transaction committed.` | - |

---

## Testing Strategy

### Unit Tests (`SaveManagerTests.cs`)

- **Metadata_Populated:**
  - Create `GameState`
  - Call Save
  - Assert `SaveGame.Metadata.CurrentHp` matches

- **Rotation_Order:**
  - Mock Repo with Slots 0, -1
  - Call Rotation
  - Assert 0 is now -1, -1 is now -2

### Integration Tests (`PersistenceJourneyTests.cs`)

- **Rolling_Backup:**
  - Save Auto (Time A)
  - Save Auto (Time B)
  - Load Slot -1
  - Verify loaded state matches Time A

---

## Draft Changelog (v0.3.21)

```markdown
# Changelog: v0.3.21 - The Steward

**Release Date:** 2026-02-XX

## Summary

"The Steward" modernizes the save system. Players can now see exactly who, where, and when they are loading with rich metadata previews. Additionally, a rolling backup system for autosaves ensures that a bad decision or a glitch doesn't cost an entire run.

## Changes

- **Persistence:** Added Metadata snapshots to save files. You can now see HP, Level, and Location on the load screen.
- **System:** Implemented Rolling Autosaves. The game now keeps the last 2 autosaves as backups (accessible via the Load menu).
- **UI:** Overhauled the Load Game menu to display character vitals and location.
```

---

## Next Milestone

Proceed to **v0.3.22: The Tactician II (Combat Polish)**?
