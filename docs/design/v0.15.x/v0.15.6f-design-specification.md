# v0.15.6f Design Specification: Search Command Enhancement

**Version:** 0.15.6f
**Parent:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.6e Complete (Puzzle Hint Integration)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#1-overview)
2. [Scope](#2-scope)
3. [Data Model](#3-data-model)
4. [Services](#4-services)
5. [Command Changes](#5-command-changes)
6. [Rendering Changes](#6-rendering-changes)
7. [Configuration](#7-configuration)
8. [Integration with Existing Systems](#8-integration-with-existing-systems)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Test Specifications](#10-test-specifications)
11. [Dependencies](#11-dependencies)
12. [Implementation Notes](#12-implementation-notes)
13. [Design Decisions](#13-design-decisions)
14. [Future Considerations](#14-future-considerations)
15. [Appendix A: Search Mechanics Examples](#appendix-a-search-mechanics-examples)
16. [Appendix B: Perception Method Comparison](#appendix-b-perception-method-comparison)

---

## 1. Overview

### 1.1 Purpose

This phase enhances the search command to provide active perception capabilities that exceed passive perception limits. When players actively search a room or container, they receive a +2 bonus to their effective perception, allowing them to discover hidden elements that would be missed by passive perception alone. Active searching takes time (varying by room size) and performs a comprehensive sweep of the search area, including all containers within it.

### 1.2 Key Changes

| Area | Current State (v0.15.6e) | Target State (v0.15.6f) |
|------|--------------------------|------------------------|
| Search Command | Basic item listing | Active perception check with +2 bonus |
| Hidden Discovery | Passive only | Active search reveals above passive threshold |
| Time Cost | Instant | Takes time based on room size |
| Container Search | Individual containers | Batch search includes all containers |
| Search Results | Simple list | Comprehensive SearchResult with full details |

### 1.3 Design Principles

1. **Active Advantage**: Active searching rewards player initiative with perception bonuses
2. **Time Investment**: Thorough searching requires time, creating tactical decisions
3. **Comprehensive Results**: Search provides detailed feedback on what was found and where
4. **Layered Discovery**: Search complements passive perception and examination
5. **Skill Integration**: Wits attribute directly affects search effectiveness

---

## 2. Scope

### 2.1 In Scope

- SearchResult value object with comprehensive discovery data
- FoundItem value object for discovered items
- ISearchService interface for active search operations
- Search command enhancement with +2 perception bonus
- Time cost calculation based on room size
- Container batch searching within rooms
- Integration with hidden element system from v0.15.6a
- Integration with puzzle hint discovery from v0.15.6e
- Configuration for search time and bonuses

### 2.2 Out of Scope (Future Phases)

- Investigation command for clue deduction (v0.15.6g)
- Specialization bonuses for perception (v0.15.6h)
- Room entry integration flow (v0.15.6i)
- Trap detection during search (future consideration)
- Party-assisted search mechanics (future consideration)
- Search skill specialization (future consideration)

---

## 3. Data Model

### 3.1 SearchResult Value Object

```csharp
/// <summary>
/// Represents the comprehensive results of an active search operation,
/// including all items found, hidden elements revealed, and containers searched.
/// </summary>
/// <remarks>
/// <para>
/// SearchResult encapsulates the complete outcome of a search command,
/// providing detailed information about what was discovered, where it was
/// found, and how long the search took. This enables rich feedback to
/// players about their search effectiveness.
/// </para>
/// <para>
/// The WitsCheckResult represents the total successes from the perception
/// check, including the +2 active search bonus. Elements are revealed
/// based on this enhanced check result.
/// </para>
/// </remarks>
public sealed record SearchResult
{
    /// <summary>
    /// The unique identifier of the room that was searched.
    /// </summary>
    public required string RoomId { get; init; }

    /// <summary>
    /// The unique identifier of the character performing the search.
    /// </summary>
    public required string CharacterId { get; init; }

    /// <summary>
    /// The total number of successes from the Wits check (including +2 bonus).
    /// </summary>
    /// <remarks>
    /// This value includes:
    /// - Base Wits dice pool successes (8-10 = success, 1 = botch)
    /// - Active search bonus (+2 to effective perception)
    /// - Any applicable modifiers (equipment, conditions, specializations)
    /// </remarks>
    public required int WitsCheckResult { get; init; }

    /// <summary>
    /// Collection of items discovered during the search.
    /// </summary>
    public required IReadOnlyList<FoundItem> ItemsFound { get; init; }

    /// <summary>
    /// Collection of hidden elements revealed by the search.
    /// </summary>
    /// <remarks>
    /// Hidden elements include secret doors, concealed compartments,
    /// hidden mechanisms, and other elements with discovery DCs.
    /// </remarks>
    public required IReadOnlyList<HiddenElement> HiddenElementsRevealed { get; init; }

    /// <summary>
    /// Collection of container identifiers that were searched.
    /// </summary>
    public required IReadOnlyList<string> ContainersSearched { get; init; }

    /// <summary>
    /// The time spent searching, in minutes.
    /// </summary>
    /// <remarks>
    /// Time cost varies by room size:
    /// - Small room: 5 minutes
    /// - Medium room: 10 minutes
    /// - Large room: 15 minutes
    /// - Huge room: 20 minutes
    /// </remarks>
    public required int TimeSpent { get; init; }

    /// <summary>
    /// Collection of puzzle hints discovered during the search.
    /// </summary>
    /// <remarks>
    /// Active searching can reveal puzzle hints from objects within the room,
    /// similar to expert examination but applied broadly.
    /// </remarks>
    public required IReadOnlyList<string> HintsDiscovered { get; init; }

    /// <summary>
    /// Indicates whether the search was interrupted or completed fully.
    /// </summary>
    public bool WasCompleted { get; init; } = true;

    /// <summary>
    /// Gets the total count of all discoveries (items + elements + hints).
    /// </summary>
    public int TotalDiscoveries =>
        ItemsFound.Count + HiddenElementsRevealed.Count + HintsDiscovered.Count;

    /// <summary>
    /// Gets whether the search yielded any discoveries.
    /// </summary>
    public bool HasDiscoveries => TotalDiscoveries > 0;
}
```

### 3.2 FoundItem Value Object

```csharp
/// <summary>
/// Represents an item discovered during an active search operation,
/// including location details and discovery information.
/// </summary>
/// <remarks>
/// <para>
/// FoundItem captures not just what was found but where it was found and
/// how difficult it was to discover. This enables contextual descriptions
/// and appropriate reward for player perception investment.
/// </para>
/// </remarks>
public sealed record FoundItem
{
    /// <summary>
    /// The unique identifier of the discovered item.
    /// </summary>
    public required string ItemId { get; init; }

    /// <summary>
    /// The display name of the item for rendering purposes.
    /// </summary>
    public required string ItemName { get; init; }

    /// <summary>
    /// Description of where the item was found within the search area.
    /// </summary>
    /// <remarks>
    /// Examples: "hidden under the console", "inside a false-bottom drawer",
    /// "wedged behind the shelving unit"
    /// </remarks>
    public required string Location { get; init; }

    /// <summary>
    /// The difficulty class required to discover this item.
    /// </summary>
    /// <remarks>
    /// Items with higher DCs are more difficult to find and typically
    /// represent more valuable or deliberately hidden objects.
    /// </remarks>
    public required int DiscoveryDc { get; init; }

    /// <summary>
    /// Flavor text describing the discovery moment.
    /// </summary>
    /// <remarks>
    /// This text is displayed when the item is found, providing atmospheric
    /// description of the discovery. Should be written in second person.
    /// Example: "You notice a glint of metal beneath the debris..."
    /// </remarks>
    public required string DiscoveryText { get; init; }

    /// <summary>
    /// Optional container identifier if the item was found in a container.
    /// </summary>
    public string? ContainerId { get; init; }

    /// <summary>
    /// Indicates whether this item was hidden (required active search).
    /// </summary>
    public bool WasHidden { get; init; }
}
```

### 3.3 SearchTarget Enum

```csharp
/// <summary>
/// Defines the type of target being searched.
/// </summary>
public enum SearchTarget
{
    /// <summary>
    /// Search the entire room including all accessible containers.
    /// </summary>
    Room,

    /// <summary>
    /// Search a specific container within the current room.
    /// </summary>
    Container,

    /// <summary>
    /// Search a specific object or area within the room.
    /// </summary>
    Object
}
```

### 3.4 RoomSize Enum

```csharp
/// <summary>
/// Defines room size categories for search time calculation.
/// </summary>
public enum RoomSize
{
    /// <summary>
    /// Small room (closet, alcove, small chamber). Search time: 5 minutes.
    /// </summary>
    Small,

    /// <summary>
    /// Medium room (standard living quarters, office). Search time: 10 minutes.
    /// </summary>
    Medium,

    /// <summary>
    /// Large room (great hall, warehouse section). Search time: 15 minutes.
    /// </summary>
    Large,

    /// <summary>
    /// Huge room (hangar bay, cavern). Search time: 20 minutes.
    /// </summary>
    Huge
}
```

### 3.5 SearchParameters Value Object

```csharp
/// <summary>
/// Parameters controlling how a search operation is performed.
/// </summary>
public sealed record SearchParameters
{
    /// <summary>
    /// The character performing the search.
    /// </summary>
    public required string CharacterId { get; init; }

    /// <summary>
    /// The type of target being searched.
    /// </summary>
    public required SearchTarget TargetType { get; init; }

    /// <summary>
    /// The identifier of the target (room, container, or object).
    /// </summary>
    public required string TargetId { get; init; }

    /// <summary>
    /// Whether to include containers in the room search.
    /// </summary>
    /// <remarks>
    /// Defaults to true for room searches. Set to false to only search
    /// the room itself without opening containers.
    /// </remarks>
    public bool IncludeContainers { get; init; } = true;

    /// <summary>
    /// Whether to apply the active search bonus (+2).
    /// </summary>
    /// <remarks>
    /// Always true for standard search commands. May be false for
    /// quick searches or special circumstances.
    /// </remarks>
    public bool ApplyActiveBonus { get; init; } = true;
}
```

---

## 4. Services

### 4.1 ISearchService Interface

```csharp
/// <summary>
/// Provides active search functionality for rooms and containers,
/// discovering hidden items and elements beyond passive perception.
/// </summary>
/// <remarks>
/// <para>
/// The search service implements active perception mechanics where players
/// deliberately spend time searching an area. Active searching grants a +2
/// bonus to effective perception, allowing discovery of elements that
/// would be missed by passive perception alone.
/// </para>
/// <para>
/// Search operations take time based on area size and include comprehensive
/// coverage of all containers and hidden elements within the search target.
/// </para>
/// </remarks>
public interface ISearchService
{
    /// <summary>
    /// Performs an active search of the specified target.
    /// </summary>
    /// <param name="parameters">Parameters controlling the search operation.</param>
    /// <returns>Comprehensive results of the search including all discoveries.</returns>
    /// <remarks>
    /// The search process:
    /// 1. Performs Wits check with active search bonus (+2)
    /// 2. Calculates time cost based on area size
    /// 3. Compares enhanced perception against hidden element DCs
    /// 4. Reveals elements/items above passive threshold but at/below active threshold
    /// 5. Searches all containers within the target area
    /// 6. Checks for applicable puzzle hints
    /// 7. Returns comprehensive SearchResult
    /// </remarks>
    Task<SearchResult> SearchAsync(SearchParameters parameters);

    /// <summary>
    /// Calculates the time required to search a specific area.
    /// </summary>
    /// <param name="roomId">The room to calculate search time for.</param>
    /// <returns>Time in minutes required to complete the search.</returns>
    int CalculateSearchTime(string roomId);

    /// <summary>
    /// Gets the effective perception value for a character during active search.
    /// </summary>
    /// <param name="characterId">The character performing the search.</param>
    /// <returns>The effective perception including active bonus.</returns>
    /// <remarks>
    /// Effective perception = Passive Perception + Active Search Bonus (+2)
    /// This may also include equipment bonuses and condition modifiers.
    /// </remarks>
    int GetActivePerceptionValue(string characterId);

    /// <summary>
    /// Determines what elements would be revealed by a search at a given perception level.
    /// </summary>
    /// <param name="roomId">The room to analyze.</param>
    /// <param name="passivePerception">The character's passive perception.</param>
    /// <param name="activePerception">The character's active perception (with bonus).</param>
    /// <returns>List of hidden elements that would be revealed by active search but not passive.</returns>
    IReadOnlyList<HiddenElement> GetRevealableElements(
        string roomId,
        int passivePerception,
        int activePerception);

    /// <summary>
    /// Checks if a specific container has been searched in the current session.
    /// </summary>
    /// <param name="containerId">The container identifier.</param>
    /// <returns>True if the container has already been searched.</returns>
    bool HasBeenSearched(string containerId);
}
```

### 4.2 SearchService Implementation Notes

```csharp
/// <summary>
/// Implementation of the search service providing active perception mechanics.
/// </summary>
public sealed class SearchService : ISearchService
{
    private readonly IPassivePerceptionService _passivePerceptionService;
    private readonly IWitsCheckService _witsCheckService;
    private readonly IRoomService _roomService;
    private readonly IContainerService _containerService;
    private readonly IPuzzleHintService _puzzleHintService;
    private readonly ITimeService _timeService;
    private readonly ISearchConfiguration _configuration;
    private readonly HashSet<string> _searchedContainers = new();

    private const int ActiveSearchBonus = 2;

    public async Task<SearchResult> SearchAsync(SearchParameters parameters)
    {
        // 1. Get room data
        var room = await _roomService.GetRoomAsync(parameters.TargetId);

        // 2. Calculate passive perception for comparison
        var passivePerception = _passivePerceptionService
            .CalculatePassivePerception(parameters.CharacterId);

        // 3. Perform active Wits check
        var witsResult = await _witsCheckService.PerformCheckAsync(
            parameters.CharacterId,
            parameters.ApplyActiveBonus ? ActiveSearchBonus : 0);

        var activePerception = witsResult.TotalSuccesses;

        // 4. Calculate search time
        var timeSpent = CalculateSearchTime(parameters.TargetId);

        // 5. Advance game time
        await _timeService.AdvanceMinutesAsync(timeSpent);

        // 6. Find hidden elements above passive but at/below active threshold
        var revealedElements = GetRevealableElements(
            parameters.TargetId,
            passivePerception,
            activePerception);

        // 7. Search containers and collect items
        var (items, containers) = await SearchContainersAsync(
            parameters,
            activePerception);

        // 8. Check for puzzle hints
        var hints = await DiscoverSearchHintsAsync(
            parameters.TargetId,
            activePerception);

        return new SearchResult
        {
            RoomId = parameters.TargetId,
            CharacterId = parameters.CharacterId,
            WitsCheckResult = activePerception,
            ItemsFound = items,
            HiddenElementsRevealed = revealedElements.ToList(),
            ContainersSearched = containers,
            TimeSpent = timeSpent,
            HintsDiscovered = hints
        };
    }

    public int CalculateSearchTime(string roomId)
    {
        var roomSize = _roomService.GetRoomSize(roomId);
        return roomSize switch
        {
            RoomSize.Small => _configuration.SmallRoomSearchTime,  // 5 minutes
            RoomSize.Medium => _configuration.MediumRoomSearchTime, // 10 minutes
            RoomSize.Large => _configuration.LargeRoomSearchTime,   // 15 minutes
            RoomSize.Huge => _configuration.HugeRoomSearchTime,     // 20 minutes
            _ => _configuration.MediumRoomSearchTime
        };
    }

    public int GetActivePerceptionValue(string characterId)
    {
        var passive = _passivePerceptionService.CalculatePassivePerception(characterId);
        return passive + ActiveSearchBonus;
    }

    public IReadOnlyList<HiddenElement> GetRevealableElements(
        string roomId,
        int passivePerception,
        int activePerception)
    {
        var allHidden = _roomService.GetHiddenElements(roomId);

        // Return elements that:
        // - Have DC above passive perception (wouldn't be auto-revealed)
        // - Have DC at or below active perception (can be found with active search)
        return allHidden
            .Where(e => e.DiscoveryDc > passivePerception &&
                       e.DiscoveryDc <= activePerception)
            .ToList();
    }
}
```

### 4.3 ISearchConfiguration Interface

```csharp
/// <summary>
/// Configuration settings for search operations.
/// </summary>
public interface ISearchConfiguration
{
    /// <summary>
    /// The bonus applied to perception during active searching.
    /// </summary>
    int ActiveSearchBonus { get; }

    /// <summary>
    /// Time in minutes to search a small room.
    /// </summary>
    int SmallRoomSearchTime { get; }

    /// <summary>
    /// Time in minutes to search a medium room.
    /// </summary>
    int MediumRoomSearchTime { get; }

    /// <summary>
    /// Time in minutes to search a large room.
    /// </summary>
    int LargeRoomSearchTime { get; }

    /// <summary>
    /// Time in minutes to search a huge room.
    /// </summary>
    int HugeRoomSearchTime { get; }

    /// <summary>
    /// Whether searching the same area again yields different results.
    /// </summary>
    bool AllowRepeatedSearches { get; }

    /// <summary>
    /// Cooldown in minutes before the same area can be searched again.
    /// </summary>
    int SearchCooldownMinutes { get; }
}
```

---

## 5. Command Changes

### 5.1 Search Command Enhancement

```csharp
/// <summary>
/// Handles the 'search' command for active perception checks.
/// </summary>
/// <remarks>
/// <para>
/// The search command allows players to actively search the current room
/// or a specific container. Active searching grants a +2 bonus to perception,
/// enabling discovery of hidden elements that passive perception would miss.
/// </para>
/// <para>
/// Syntax:
/// - search (searches entire room)
/// - search [container] (searches specific container)
/// - search carefully (takes extra time for +1 additional bonus - future)
/// </para>
/// </remarks>
public class SearchCommand : ICommand
{
    public string Name => "search";
    public string[] Aliases => new[] { "look around", "search room" };
    public string Description => "Actively search the area for hidden items and secrets.";

    private readonly ISearchService _searchService;
    private readonly ISearchRenderer _searchRenderer;
    private readonly IGameStateService _gameStateService;

    public async Task<CommandResult> ExecuteAsync(CommandContext context)
    {
        var characterId = context.CurrentCharacterId;
        var roomId = _gameStateService.GetCurrentRoomId(characterId);

        // Parse target from arguments
        var targetType = SearchTarget.Room;
        var targetId = roomId;

        if (context.Arguments.Length > 0)
        {
            var containerResult = TryParseContainer(context.Arguments, roomId);
            if (containerResult.Success)
            {
                targetType = SearchTarget.Container;
                targetId = containerResult.ContainerId;
            }
        }

        var parameters = new SearchParameters
        {
            CharacterId = characterId,
            TargetType = targetType,
            TargetId = targetId,
            IncludeContainers = targetType == SearchTarget.Room,
            ApplyActiveBonus = true
        };

        // Perform the search
        var result = await _searchService.SearchAsync(parameters);

        // Render the results
        var output = _searchRenderer.Render(result);

        return CommandResult.Success(output);
    }
}
```

### 5.2 Command Syntax Reference

| Command | Description | Time Cost |
|---------|-------------|-----------|
| `search` | Search the entire room including containers | Varies by room size |
| `search <container>` | Search a specific container | 2 minutes |
| `search room` | Explicitly search room only, no containers | Varies by room size |

### 5.3 Command Flow Diagram

```
search command
    │
    ▼
┌─────────────────────────────────┐
│ Parse target (room/container)   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Calculate passive perception    │
│ (for comparison baseline)       │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Perform Wits check              │
│ + Active Search Bonus (+2)      │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Calculate time cost             │
│ (based on room size)            │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Advance game time               │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Find elements:                  │
│ DC > passive AND DC <= active   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Search containers in target     │
│ (if room search)                │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Check for puzzle hints          │
│ (from v0.15.6e integration)     │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Build and return SearchResult   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ Render comprehensive output     │
└─────────────────────────────────┘
```

---

## 6. Rendering Changes

### 6.1 ISearchRenderer Interface

```csharp
/// <summary>
/// Renders search results for display to the player.
/// </summary>
public interface ISearchRenderer
{
    /// <summary>
    /// Renders a complete search result with all discoveries.
    /// </summary>
    /// <param name="result">The search result to render.</param>
    /// <returns>Formatted output for display.</returns>
    string Render(SearchResult result);

    /// <summary>
    /// Renders a summary of a search with no discoveries.
    /// </summary>
    /// <param name="result">The search result with no findings.</param>
    /// <returns>Formatted output indicating thorough but empty search.</returns>
    string RenderEmptySearch(SearchResult result);

    /// <summary>
    /// Renders individual item discovery text.
    /// </summary>
    /// <param name="item">The found item to render.</param>
    /// <returns>Formatted discovery text for a single item.</returns>
    string RenderItemDiscovery(FoundItem item);
}
```

### 6.2 Search Result Output Format

```
> search

[WITS Check with +2 Active Search Bonus]
Rolling 5d10... 3, 7, 8, 9, 1
Successes: 3 (8, 9) | Botch: 1 | Net: 2
Active Perception: 2 + 2 = 4

[Searching the Abandoned Laboratory... 10 minutes]

─── Hidden Elements Revealed ───
• Secret Compartment (DC 3)
  A cleverly concealed panel in the wall slides open, revealing a small
  storage space behind the console.

• Concealed Ventilation Grate (DC 4)
  Beneath the debris, you notice a ventilation grate that could potentially
  be removed to access the ductwork.

─── Items Found ───
• Data Crystal (DC 2) - inside the secret compartment
  "You notice a glint of blue light from within the compartment..."

• Ancient Keycard (DC 3) - wedged behind the shelving unit
  "As you move the shelving, something clatters to the floor..."

─── Containers Searched ───
• Storage Locker Alpha (empty)
• Specimen Cabinet (1 item visible)
• Equipment Crate (2 items visible)

─── Puzzle Hints ───
[Hint Discovered: Ventilation Access]
The grate appears large enough for a person to crawl through...
[New command available: remove grate]

Time elapsed: 10 minutes
Total discoveries: 4 (2 elements, 2 items, 1 hint)
```

### 6.3 Empty Search Output Format

```
> search

[WITS Check with +2 Active Search Bonus]
Rolling 5d10... 2, 4, 5, 6, 7
Successes: 0 | Active Perception: 2

[Searching the Storage Closet... 5 minutes]

You conduct a thorough search of the area but find nothing of note
beyond what is already visible. The search takes 5 minutes.

Time elapsed: 5 minutes
```

### 6.4 Comparison: Passive vs Active vs Examine

```
╔════════════════════════════════════════════════════════════════════╗
║                    PERCEPTION METHOD COMPARISON                     ║
╠═══════════════╦═══════════════╦═══════════════╦════════════════════╣
║ Aspect        ║ Passive       ║ Search        ║ Examine            ║
╠═══════════════╬═══════════════╬═══════════════╬════════════════════╣
║ Trigger       ║ Room entry    ║ 'search' cmd  ║ 'examine' cmd      ║
║ Target        ║ All hidden    ║ Room/container║ Single object      ║
║ Bonus         ║ None          ║ +2 perception ║ Varies by layer    ║
║ Time Cost     ║ None          ║ 5-20 minutes  ║ 1-5 minutes        ║
║ Result        ║ Auto-reveal   ║ Active reveal ║ Layered detail     ║
║ Can Repeat    ║ No            ║ Yes (cooldown)║ Yes (different DC) ║
╚═══════════════╩═══════════════╩═══════════════╩════════════════════╝
```

---

## 7. Configuration

### 7.1 Search Configuration File

**File:** `data/config/search-config.json`

```json
{
  "searchSettings": {
    "activeSearchBonus": 2,
    "searchTimes": {
      "small": 5,
      "medium": 10,
      "large": 15,
      "huge": 20,
      "containerOnly": 2
    },
    "allowRepeatedSearches": true,
    "searchCooldownMinutes": 30,
    "includeContainersByDefault": true
  },
  "displaySettings": {
    "showDiceRoll": true,
    "showPerceptionCalculation": true,
    "showTimeElapsed": true,
    "showDiscoverySummary": true,
    "groupByDiscoveryType": true
  },
  "hintIntegration": {
    "revealHintsOnSearch": true,
    "searchHintDcBonus": 0,
    "maxHintsPerSearch": 3
  }
}
```

### 7.2 Room Size Configuration

Room size is determined by room data and affects search time:

```json
{
  "roomId": "abandoned-laboratory",
  "name": "Abandoned Laboratory",
  "size": "medium",
  "hiddenElements": [
    {
      "elementId": "secret-compartment",
      "discoveryDc": 3,
      "type": "container"
    },
    {
      "elementId": "concealed-vent",
      "discoveryDc": 4,
      "type": "passage"
    }
  ]
}
```

---

## 8. Integration with Existing Systems

### 8.1 Passive Perception Integration (v0.15.6a)

The search system builds directly on passive perception:

```csharp
// Passive perception from v0.15.6a
var passivePerception = _passivePerceptionService.CalculatePassivePerception(characterId);

// Active perception = Passive + Active Bonus
var activePerception = passivePerception + ActiveSearchBonus;

// Elements revealed by search but not passive
var searchRevealedElements = hiddenElements
    .Where(e => e.DiscoveryDc > passivePerception &&
                e.DiscoveryDc <= activePerception);
```

### 8.2 Three-Layer Examination Integration (v0.15.6b)

Search differs from examination but complements it:

| System | Purpose | Depth |
|--------|---------|-------|
| Search | Find hidden elements in an area | Breadth-first |
| Examine | Get details about a specific object | Depth-first |

A player might:
1. Enter room → Passive perception reveals DC 0-2 elements
2. Search → Reveals DC 3-4 elements with active bonus
3. Examine specific object → Gets Layer 1-3 descriptions

### 8.3 Puzzle Hint Integration (v0.15.6e)

Active searching can reveal puzzle hints associated with objects in the room:

```csharp
private async Task<IReadOnlyList<string>> DiscoverSearchHintsAsync(
    string roomId,
    int activePerception)
{
    var discoveredHints = new List<string>();

    // Get all objects in the room
    var roomObjects = await _roomService.GetObjectsInRoomAsync(roomId);

    foreach (var obj in roomObjects)
    {
        // Check for hints associated with this object
        var hints = await _puzzleHintService.GetHintsForObjectAsync(obj.ObjectId);

        foreach (var hint in hints)
        {
            // Search can reveal hints if perception is sufficient
            if (hint.RequiredPerception <= activePerception &&
                !_playerHintTracker.HasDiscoveredHint(hint.HintId))
            {
                await _playerHintTracker.RecordHintDiscoveryAsync(hint.HintId);
                discoveredHints.Add(hint.HintId);
            }
        }
    }

    return discoveredHints;
}
```

### 8.4 Time System Integration

Search operations consume game time:

```csharp
public interface ITimeService
{
    /// <summary>
    /// Advances game time by the specified number of minutes.
    /// </summary>
    /// <param name="minutes">Minutes to advance.</param>
    /// <returns>Task representing the time advancement.</returns>
    /// <remarks>
    /// Time advancement may trigger:
    /// - NPC schedule changes
    /// - Environmental changes (lighting, patrols)
    /// - Status effect duration updates
    /// - Quest timer updates
    /// </remarks>
    Task AdvanceMinutesAsync(int minutes);
}
```

---

## 9. Acceptance Criteria

### 9.1 Core Search Functionality

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-1 | `search` command performs Wits check with +2 bonus | Must |
| AC-2 | Search reveals hidden elements above passive threshold | Must |
| AC-3 | Search consumes time based on room size | Must |
| AC-4 | Search includes all containers in room by default | Must |
| AC-5 | `search <container>` searches specific container | Must |
| AC-6 | Search results display all discoveries clearly | Must |

### 9.2 Discovery Mechanics

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-7 | Elements with DC > passive but ≤ active are revealed | Must |
| AC-8 | Items found include location and discovery text | Must |
| AC-9 | Hidden elements revealed include description | Must |
| AC-10 | Puzzle hints can be discovered during search | Should |

### 9.3 Time and State

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-11 | Time advances by search duration | Must |
| AC-12 | Searched containers are tracked | Should |
| AC-13 | Search cooldown prevents immediate re-search | Should |
| AC-14 | Search results show time elapsed | Must |

### 9.4 User Experience

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-15 | Dice roll and calculation shown to player | Should |
| AC-16 | Empty search provides appropriate feedback | Must |
| AC-17 | Discovery summary shows totals | Should |
| AC-18 | Results grouped by discovery type | Should |

---

## 10. Test Specifications

### 10.1 Unit Tests

#### Test Suite: SearchServiceTests

```csharp
[TestClass]
public class SearchServiceTests
{
    /// <summary>
    /// Verifies that active search reveals elements above passive threshold.
    /// </summary>
    /// <remarks>
    /// Given: Character with passive perception 2, room with elements at DC 3 and 4
    /// When: Character performs active search (perception becomes 4 with +2 bonus)
    /// Then: Elements at DC 3 and DC 4 are revealed
    /// </remarks>
    [TestMethod]
    public async Task SearchAsync_WithActiveBonus_RevealsElementsAbovePassiveThreshold()
    {
        // Arrange
        var passivePerception = 2;
        var activeBonus = 2;
        var effectivePerception = passivePerception + activeBonus; // = 4

        var hiddenElements = new[]
        {
            new HiddenElement { ElementId = "elem-1", DiscoveryDc = 1 }, // Below passive
            new HiddenElement { ElementId = "elem-2", DiscoveryDc = 2 }, // At passive
            new HiddenElement { ElementId = "elem-3", DiscoveryDc = 3 }, // Above passive, at active
            new HiddenElement { ElementId = "elem-4", DiscoveryDc = 4 }, // Above passive, at active
            new HiddenElement { ElementId = "elem-5", DiscoveryDc = 5 }  // Above active
        };

        _roomServiceMock.Setup(r => r.GetHiddenElements("test-room"))
            .Returns(hiddenElements);
        _passivePerceptionMock.Setup(p => p.CalculatePassivePerception("char-1"))
            .Returns(passivePerception);
        _witsCheckMock.Setup(w => w.PerformCheckAsync("char-1", activeBonus))
            .ReturnsAsync(new WitsCheckResult { TotalSuccesses = effectivePerception });

        var parameters = new SearchParameters
        {
            CharacterId = "char-1",
            TargetType = SearchTarget.Room,
            TargetId = "test-room",
            ApplyActiveBonus = true
        };

        // Act
        var result = await _searchService.SearchAsync(parameters);

        // Assert
        Assert.AreEqual(2, result.HiddenElementsRevealed.Count);
        Assert.IsTrue(result.HiddenElementsRevealed.Any(e => e.ElementId == "elem-3"));
        Assert.IsTrue(result.HiddenElementsRevealed.Any(e => e.ElementId == "elem-4"));
        Assert.IsFalse(result.HiddenElementsRevealed.Any(e => e.ElementId == "elem-1"));
        Assert.IsFalse(result.HiddenElementsRevealed.Any(e => e.ElementId == "elem-2"));
        Assert.IsFalse(result.HiddenElementsRevealed.Any(e => e.ElementId == "elem-5"));
    }

    /// <summary>
    /// Verifies that search includes appropriate time cost based on room size.
    /// </summary>
    /// <remarks>
    /// Given: Rooms of different sizes
    /// When: Search is performed on each
    /// Then: Time spent matches configured values (5/10/15/20 minutes)
    /// </remarks>
    [TestMethod]
    public async Task SearchAsync_IncludesTimeCost_BasedOnRoomSize()
    {
        // Arrange
        var testCases = new[]
        {
            (RoomSize.Small, 5),
            (RoomSize.Medium, 10),
            (RoomSize.Large, 15),
            (RoomSize.Huge, 20)
        };

        foreach (var (roomSize, expectedTime) in testCases)
        {
            var roomId = $"room-{roomSize}";
            _roomServiceMock.Setup(r => r.GetRoomSize(roomId)).Returns(roomSize);

            var parameters = new SearchParameters
            {
                CharacterId = "char-1",
                TargetType = SearchTarget.Room,
                TargetId = roomId
            };

            // Act
            var result = await _searchService.SearchAsync(parameters);

            // Assert
            Assert.AreEqual(expectedTime, result.TimeSpent,
                $"Room size {roomSize} should take {expectedTime} minutes");
        }
    }
}
```

### 10.2 Integration Tests

```csharp
[TestClass]
public class SearchIntegrationTests
{
    /// <summary>
    /// Verifies complete search flow from command to result.
    /// </summary>
    [TestMethod]
    public async Task SearchCommand_CompletesFullFlow_ReturnsCorrectResults()
    {
        // Arrange
        var room = CreateTestRoom(size: RoomSize.Medium, hiddenElementCount: 3);
        var character = CreateTestCharacter(wits: 3);

        // Act
        var commandResult = await ExecuteCommand("search", character);

        // Assert
        Assert.IsTrue(commandResult.Success);
        Assert.IsTrue(commandResult.Output.Contains("10 minutes"));
        Assert.IsTrue(commandResult.Output.Contains("WITS Check"));
    }

    /// <summary>
    /// Verifies that puzzle hints are discovered during search.
    /// </summary>
    [TestMethod]
    public async Task SearchAsync_DiscoversPuzzleHints_WhenPerceptionSufficient()
    {
        // Arrange
        var hintId = "hint-secret-passage";
        var hint = new PuzzleHint
        {
            HintId = hintId,
            RequiredPerception = 3,
            HintText = "You notice a draft coming from behind the bookshelf..."
        };

        SetupRoomWithHint("test-room", hint);
        SetupCharacterWithPerception("char-1", passivePerception: 2);

        // Act - Search gives +2, so effective = 4, hint DC 3 is revealed
        var result = await _searchService.SearchAsync(new SearchParameters
        {
            CharacterId = "char-1",
            TargetType = SearchTarget.Room,
            TargetId = "test-room"
        });

        // Assert
        Assert.IsTrue(result.HintsDiscovered.Contains(hintId));
    }
}
```

### 10.3 Test Coverage Requirements

| Area | Minimum Coverage | Priority |
|------|------------------|----------|
| SearchService | 90% | Critical |
| SearchResult value object | 95% | Critical |
| FoundItem value object | 95% | Critical |
| SearchCommand | 85% | High |
| SearchRenderer | 80% | Medium |
| Time calculation | 100% | Critical |

---

## 11. Dependencies

### 11.1 Upstream Dependencies

| Dependency | Source | Usage |
|------------|--------|-------|
| IPassivePerceptionService | v0.15.6a | Baseline perception calculation |
| IWitsCheckService | v0.15.6a | Dice rolling mechanics |
| HiddenElement | v0.15.6a | Hidden element data model |
| IPuzzleHintService | v0.15.6e | Hint discovery during search |
| IPlayerHintTracker | v0.15.6e | Tracking discovered hints |

### 11.2 External Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| IRoomService | Core | Room data and element access |
| IContainerService | Core | Container contents and state |
| ITimeService | Core | Game time advancement |
| IConfigurationService | Core | Search configuration loading |

### 11.3 Downstream Dependencies

This phase provides to future phases:

| Provides To | Interface/Component | Purpose |
|-------------|---------------------|---------|
| v0.15.6g | ISearchService | Investigation uses search as base |
| v0.15.6h | SearchParameters | Specialization bonuses modify search |
| v0.15.6i | SearchResult | Room entry can trigger partial search |

### 11.4 Dependency Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         v0.15.6f Search                              │
├─────────────────────────────────────────────────────────────────────┤
│  ISearchService    SearchResult    FoundItem    SearchParameters    │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │     Depends On        │
                    ▼                       ▼
    ┌───────────────────────────┐   ┌───────────────────────────┐
    │  v0.15.6a Passive         │   │  v0.15.6e Puzzle Hints    │
    │  Perception               │   │                           │
    │  ─────────────────────    │   │  ─────────────────────    │
    │  IPassivePerceptionService│   │  IPuzzleHintService       │
    │  IWitsCheckService        │   │  IPlayerHintTracker       │
    │  HiddenElement            │   │  PuzzleHint               │
    └───────────────────────────┘   └───────────────────────────┘
                    │                       │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │     Core Services     │
                    ▼                       ▼
    ┌───────────────────────────────────────────────────────────────┐
    │  IRoomService  │  IContainerService  │  ITimeService          │
    └───────────────────────────────────────────────────────────────┘
```

---

## 12. Implementation Notes

### 12.1 Architecture Layers

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Presentation Layer                                │
├─────────────────────────────────────────────────────────────────────┤
│  SearchCommand              SearchRenderer                          │
│  - Parses 'search' input    - Formats search results                │
│  - Validates target         - Displays dice rolls                   │
│  - Returns CommandResult    - Groups discoveries by type            │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Application Layer                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ISearchService             ISearchConfiguration                    │
│  - Orchestrates search      - Provides timing config                │
│  - Coordinates subsystems   - Manages search settings               │
│  - Returns SearchResult     - Hint integration settings             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Domain Layer                                    │
├─────────────────────────────────────────────────────────────────────┤
│  SearchResult               FoundItem                               │
│  SearchParameters           SearchTarget                            │
│  RoomSize                                                           │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│  SearchConfigurationLoader  RoomDataProvider                        │
│  ContainerDataProvider      TimeServiceAdapter                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 12.2 Implementation Order

1. **Domain Models** (~Day 1)
   - SearchResult value object
   - FoundItem value object
   - SearchTarget and RoomSize enums
   - SearchParameters value object

2. **Configuration** (~Day 1)
   - ISearchConfiguration interface
   - search-config.json data file
   - Configuration loading

3. **Search Service** (~Day 2)
   - ISearchService interface
   - SearchService implementation
   - Time calculation logic
   - Integration with passive perception

4. **Puzzle Hint Integration** (~Day 2)
   - Search-based hint discovery
   - Integration with IPlayerHintTracker

5. **Command and Rendering** (~Day 3)
   - SearchCommand implementation
   - ISearchRenderer interface
   - Result formatting

6. **Testing** (~Day 3)
   - SearchServiceTests
   - Integration tests

### 12.3 Error Handling

```csharp
public sealed class SearchException : Exception
{
    public SearchErrorCode ErrorCode { get; }

    public SearchException(SearchErrorCode code, string message)
        : base(message)
    {
        ErrorCode = code;
    }
}

public enum SearchErrorCode
{
    InvalidTarget,
    ContainerNotAccessible,
    RoomNotSearchable,
    SearchInProgress,
    CooldownActive
}
```

---

## 13. Design Decisions

### 13.1 Active Search Bonus Value

**Decision:** Set active search bonus to +2 (not +1 or +3).

**Rationale:**
- +2 provides meaningful advantage over passive without making passive obsolete
- Matches the scale of DC increments (0, 3, 6, etc.)
- Allows characters with low Wits to still benefit noticeably
- Consistent with tabletop RPG conventions for active vs passive checks

### 13.2 Time Cost Model

**Decision:** Use room size categories for time costs rather than continuous calculation.

**Rationale:**
- Simpler for players to understand and predict
- Allows content designers to categorize rooms easily
- Four categories (small/medium/large/huge) cover most scenarios
- Specific container searches use fixed time (2 minutes)

### 13.3 Container Inclusion by Default

**Decision:** Include all containers when searching a room by default.

**Rationale:**
- Players expect "search room" to be thorough
- Reduces command verbosity for common case
- Explicit `search <container>` available for targeted searches
- Matches player intuition about searching

### 13.4 Repeated Search Handling

**Decision:** Allow repeated searches with cooldown rather than preventing entirely.

**Rationale:**
- Players may want to re-search after gaining perception bonuses
- Cooldown prevents trivial re-searching
- Some hidden elements might only appear after triggers
- Respects player agency while maintaining balance

---

## 14. Future Considerations

### 14.1 Planned Enhancements (v0.15.6g+)

- **Investigation Command:** Deep analysis of specific targets using Wits + Investigation
- **Specialization Bonuses:** Ruin-Stalker trap sense, Veiðimaðr keen senses
- **Room Entry Flow:** Automatic passive perception on room entry

### 14.2 Post-v0.15.6 Potential Features

- **Trap Detection:** Active search might trigger or reveal traps
- **Party Search:** Multiple characters searching together
- **Search Skill:** Dedicated search skill for specialization
- **Environmental Modifiers:** Lighting, weather affecting search
- **Interrupt Mechanics:** Search can be interrupted by events
- **Quick Search:** Faster search with reduced bonus

---

## Appendix A: Search Mechanics Examples

### A.1 Example Search Scenarios

**Scenario 1: Basic Room Search**

```
Character: Eirik (Wits 3, Passive Perception 3)
Room: Abandoned Storage (Medium, DC 2, 4, 6 hidden elements)

> search

[WITS Check with +2 Active Search Bonus]
Rolling 3d10... 5, 8, 10
Successes: 2 (8, 10)
Active Perception: 2 + 2 = 4

Passive Perception: 3 (DC 2 element auto-revealed on entry)
Active Perception: 4 (DC 4 element revealed by search)
DC 6 element remains hidden

[Searching the Abandoned Storage... 10 minutes]

─── Hidden Elements Revealed ───
• Loose Floor Panel (DC 4)
  One of the floor panels wobbles slightly underfoot, suggesting it might
  be removable.

Time elapsed: 10 minutes
Total discoveries: 1
```

**Scenario 2: Container-Specific Search**

```
Character: Sigrid (Wits 4, Passive Perception 4)
Container: Locked Cabinet (requires search after unlock)

> search cabinet

[WITS Check with +2 Active Search Bonus]
Rolling 4d10... 3, 7, 9, 9
Successes: 2 (9, 9)
Active Perception: 2 + 2 = 4

[Searching the Locked Cabinet... 2 minutes]

─── Items Found ───
• Research Notes (visible)
• Hidden Compartment Key (DC 3) - behind false back
  "Feeling along the back panel, your fingers find a slight gap..."

Time elapsed: 2 minutes
Total discoveries: 1 hidden item
```

### A.2 Perception Threshold Examples

| Character Wits | Passive Perception | Active Perception | Reveals DC |
|----------------|-------------------|-------------------|------------|
| 1 | 1 | 3 | 2-3 (above passive) |
| 2 | 2 | 4 | 3-4 (above passive) |
| 3 | 3 | 5 | 4-5 (above passive) |
| 4 | 4 | 6 | 5-6 (above passive) |
| 5 | 5 | 7 | 6-7 (above passive) |

---

## Appendix B: Perception Method Comparison

### B.1 Complete Comparison Table

| Aspect | Passive Perception | Active Search | Examine |
|--------|-------------------|---------------|---------|
| **Trigger** | Automatic on room entry | `search` command | `examine <object>` |
| **Target** | All hidden elements | Room or container | Single object |
| **Check Type** | No roll (static value) | Wits roll + bonus | Wits roll vs DC tiers |
| **Bonus** | None | +2 to perception | Layer-based DCs |
| **Time Cost** | None | 5-20 minutes | 1-5 minutes |
| **Result** | Auto-reveal ≤ DC | Reveal ≤ active DC | Layered description |
| **Repeatability** | Once per entry | Cooldown-limited | Multiple layers |
| **Exhaustive** | Yes (within DC) | Yes (searches all) | No (one object) |
| **Hints** | No | Yes (search-discoverable) | Yes (Layer 3) |

### B.2 When to Use Each Method

**Passive Perception:**
- Happens automatically, no player action required
- Reveals obvious hidden elements
- Sets baseline for what's already noticed

**Active Search:**
- When player suspects hidden items/passages
- When passive perception might have missed something
- When time investment is acceptable
- For thorough room exploration

**Examine:**
- To get details about specific objects
- To reveal object-specific information
- To discover puzzle hints on specific items
- For deep inspection of noticed elements

### B.3 Discovery Flow Example

```
1. Enter "Ancient Study" room
   └─ Passive Perception (3) reveals: Dusty Bookshelf (DC 2)

2. Player: "search"
   └─ Active Perception (3 + 2 = 5) reveals: Hidden Drawer (DC 4)
   └─ Time: 10 minutes

3. Player: "examine bookshelf"
   └─ Layer 1 (DC 0): General description
   └─ Layer 2 (DC 12): History and markings
   └─ Layer 3 (DC 18): Puzzle hint for secret passage
```

---

*This design specification provides the detailed blueprint for implementing v0.15.6f Search Command Enhancement. See the scope breakdown for integration context with other v0.15.6 sub-phases.*
