# v0.20.8c Changelog — Seiðkona (Seeress) Tier 3 Mastery & Capstone Abilities

## Version: 0.20.8c

## Date: 2026-02-17

## Focus: Seiðkona Tier 3 Abilities — Völva's Vision, Aether Storm, The Unraveling (Capstone)

---

## Added

### Domain Layer — Value Objects

- **`VolvasVisionResult`** — Init-only sealed record capturing Völva's Vision (mass detection) execution outcome: `RevealRadius` (default 15), `ResonanceBefore`/`ResonanceAfter`/`ResonanceGained` (+2 per cast), `CorruptionCheckPerformed`/`CorruptionTriggered`/`CorruptionReason`/`CorruptionRoll`/`CorruptionRiskPercent`, `ApCostPaid` (tracks actual AP spent after Cascade reduction), `CascadeApplied` (whether Resonance Cascade reduced the cost). Display: `GetDescription()` (includes Cascade/Corruption tags, reveal radius), `GetResonanceChange()` (formatted "Resonance: X → Y (+Z)"). No damage properties — Völva's Vision is pure detection.
- **`AetherStormResult`** — Init-only sealed record capturing Aether Storm (4d6 AoE) execution outcome: `DamageRoll` (4d6), `TotalDamage`, `ResonanceBefore`/`ResonanceAfter`/`ResonanceGained` (+2 per cast), all Corruption tracking fields, `ApCostPaid`, `CascadeApplied`. Display: `GetDamageBreakdown()` (formatted "Aether Storm: 4d6 = X Aetheric damage (Total: Y)"), `GetDescription()` (includes Cascade/Corruption tags), `GetResonanceChange()`. Damage-dealing ability that contributes to Accumulated Aetheric Damage.
- **`UnravelingResult`** — Init-only sealed record capturing The Unraveling (capstone) execution outcome: `AccumulatedDamageConsumed`, `TotalDamage`, `ResonanceBefore` (always 10), `ResonanceAfter` (always 0), `CorruptionCheckPerformed` (always true), `CorruptionTriggered`, `CorruptionReason`, `CorruptionRoll`, `CorruptionRiskPercent` (always 20), `ApCostPaid` (always 5), `CooldownActivated` (always true). Display: `GetDamageBreakdown()` ("The Unraveling: X accumulated Aetheric damage released"), `GetDescription()` (includes CORRUPTION +2 tag, Resonance reset, cooldown), `GetResonanceChange()` ("Resonance: 10 → 0 (reset)").

### Domain Layer — Player Entity Extension

- **`Player.HasUsedUnravelingThisCombat`** — Per-combat cooldown flag for the Unraveling capstone. Uses per-specialization naming (not generic `HasUsedCapstoneThisCombat`) to avoid cross-specialization coupling.
- **`Player.ResetUnravelingCooldown()`** — Resets the per-combat cooldown flag, called at combat end.

### Unit Tests

- **`VolvasVisionResultTests`** — 10 domain tests: factory defaults (all zeroed, radius=15), Resonance change tracking, Corruption triggered/safe-with-roll, Cascade applied/not, default reveal radius, display methods (GetDescription with Cascade+Corruption+radius tags, GetDescription safe with d100, GetResonanceChange formatted string)
- **`AetherStormResultTests`** — 11 domain tests: factory defaults (all zeroed), damage roll tracking, Resonance change tracking, Corruption triggered/safe-with-roll, Cascade applied/not, display methods (GetDamageBreakdown "4d6" format, GetDescription with Cascade+Corruption tags, GetDescription safe with d100, GetResonanceChange formatted string)
- **`UnravelingResultTests`** — 12 domain tests: factory defaults (all zeroed), accumulated damage tracking, Resonance 10→0 reset, Corruption triggered/safe (always checked), AP cost always 5, cooldown always activated, risk percent always 20, display methods (GetDamageBreakdown "accumulated" wording, GetDescription with CORRUPTION +2 tag, GetDescription safe with d100, GetResonanceChange "reset" format)

## Modified

### Application Layer — Interface

- **`ISeidkonaAbilityService`** — Extended with 3 new Tier 3/Capstone method signatures:
  - `ExecuteVolvasVision(Player)` → `VolvasVisionResult?` — Active mass detection, +2 Resonance, 3 AP (2 with Cascade)
  - `ExecuteAetherStorm(Player, Guid)` → `AetherStormResult?` — Active 4d6 AoE damage, +2 Resonance, 5 AP (4 with Cascade), accumulates damage
  - `ExecuteUnraveling(Player)` → `UnravelingResult?` — Capstone: releases all Accumulated Damage, 5 AP (Cascade immune), requires Resonance 10, once per combat
  - Updated class-level XML docs to cover all tiers

### Application Layer — Services

- **`SeidkonaAbilityService`** — Extended with Tier 3 and Capstone ability implementations:
  - 7 new constants: `VolvasVisionApCost = 3`, `VolvasVisionResonanceGain = 2`, `VolvasVisionRevealRadius = 15`, `AetherStormApCost = 5`, `AetherStormResonanceGain = 2`, `UnravelingApCost = 5`, `UnravelingRequiredResonance = 10`
  - `ExecuteVolvasVision()`: Guard chain (null → spec → ability → AP w/ Cascade → Corruption eval BEFORE spending → spend AP → build Resonance +2 → NO accumulated damage → apply Corruption → return result). Non-damage ability following Fate's Thread pattern.
  - `ExecuteAetherStorm()`: Guard chain (same as Völva's Vision through Corruption eval) → spend AP → `Roll4D6()` → build Resonance +2 → `AddAccumulatedDamage(player, damageRoll)` YES → apply Corruption → return result. Damage-dealing ability following Seiðr Bolt pattern + Cascade.
  - `ExecuteUnraveling()`: Guard chain (null → spec → ability → HasUsedUnravelingThisCombat → AP check [raw 5, NO Cascade] → Resonance == 10 → AccumulatedDamage > 0 → Corruption eval BEFORE → spend AP → capture damage → ResetResonance → ResetAccumulatedDamage → set cooldown → apply Corruption → return result). Unique capstone flow.
  - `GetEffectiveApCost()`: Added early return for Unraveling (bypass Cascade): always returns 5 AP
  - `GetBaseApCost()`: Added VolvasVision → 3, AetherStorm → 5, Unraveling → 5
  - `GetAbilityReadiness()`: Added T3 abilities (Cascade-aware AP) and Unraveling (AP + Resonance==10 + AccumulatedDamage>0 + !HasUsedUnravelingThisCombat)
  - `internal virtual int Roll4D6()` — New dice method for Aether Storm, `internal virtual` for test overriding
  - Updated class-level XML docs to cover all tiers
  - Exhaustive structured logging: `LogInformation` for success with Cascade/Corruption/damage details, `LogWarning` for failures
- **`SeidkonaCorruptionService`** — Replaced deferred Unraveling routing:
  - 2 new constants: `CapstoneRiskPercent = 20`, `CapstoneCorruption = 2`
  - Replaced `CreateSafe("deferred to v0.20.8c")` with `EvaluateUnravelingRisk()` — guaranteed 20% d100 check, +2 Corruption if triggered, using `CapstoneActivation` trigger
  - Updated T3 comment from "Future T3 abilities" to "T3 active abilities"
  - VolvasVision and AetherStorm routing already correct (EvaluateGenericCastingRisk)

### Application Layer — Tests

- **`SeidkonaAbilityServiceTests`** — Extended from 61 to 98 tests (+37):
  - `TestSeidkonaAbilityService` subclass: Added `Fixed4D6 = 16` property and `Roll4D6()` override alongside existing `Fixed2D6`/`Roll2D6()` and `FixedD20`/`RollD20()`
  - Völva's Vision tests (9): valid execution (reveal radius, Resonance change, AP cost, no Cascade), insufficient AP, wrong specialization, ability not unlocked, builds Resonance +2 (mock verify), does NOT accumulate damage (mock verify Never), low Resonance no Corruption check, mid Resonance Corruption triggered, with Cascade active reduced AP cost (3→2)
  - Aether Storm tests (10): valid execution (DamageRoll=16, AP cost, no Cascade), insufficient AP, wrong specialization, ability not unlocked, builds Resonance +2 (mock verify), accumulates damage (16) (mock verify Once), low Resonance no Corruption check, high Resonance Corruption triggered, high Resonance Corruption safe-with-roll, with Cascade active reduced AP cost (5→4)
  - Unraveling tests (12): valid execution (AccumulatedDamage consumed, Resonance 10→0, cooldown, AP=5), insufficient AP, wrong specialization, ability not unlocked, Resonance≠10 → null, no accumulated damage → null, already used this combat → null, resets Resonance to 0 (mock verify), resets accumulated damage (mock verify), sets cooldown flag, guaranteed Corruption check with +2, no Cascade reduction (always 5 AP even with Cascade active)
  - Corruption service direct tests (3): Unraveling d100≤20 triggers (+2, CapstoneActivation, 20%), Unraveling d100>20 safe-with-roll (20%), VolvasVision at high Resonance → CastingAtHighResonance
  - GetEffectiveApCost tests (2): Unraveling ignores Cascade (always 5), AetherStorm with Cascade reduces (5→4)
  - GetAbilityReadiness tests (2): T3 abilities included with correct AP checks, Unraveling checks all preconditions (AP + Resonance==10 + AccumulatedDamage>0 + !HasUsedUnravelingThisCombat)

### Configuration

- **`config/abilities.json`** — Added 3 Tier 3/Capstone ability entries:
  - `volvas-vision`: T3 active Detection, 3 AP (2 with Cascade), +2 Resonance, radius 15, ppCost 5, ppPrerequisite 16. Mass revelation of hidden/invisible/concealed enemies. Corruption risk at Resonance 5+.
  - `aether-storm`: T3 active Damage, 5 AP (4 with Cascade), 4d6 Aetheric (cone AoE), +2 Resonance, ppCost 5, ppPrerequisite 16. Highest damage ability before capstone. Accumulates damage for Unraveling. Corruption risk at Resonance 5+.
  - `unraveling`: Capstone active, 5 AP (Cascade immune), ppCost 6, ppPrerequisite 24. Once per combat. Requires Resonance 10 and Accumulated Damage > 0. Releases 100% accumulated damage, resets Resonance and Accumulated Damage. Guaranteed 20% Corruption check (+2 if triggered).

## Design Decisions

- **Unraveling immune to Cascade**: Enforced at `GetEffectiveApCost` level with early return and by using raw `UnravelingApCost` in `ExecuteUnraveling` (never calls `GetEffectiveApCostInternal`). This prevents the feedback loop from trivializing the capstone's AP cost.
- **Per-specialization cooldown naming**: `HasUsedUnravelingThisCombat` (not generic `HasUsedCapstoneThisCombat`) to avoid cross-specialization coupling, consistent with the naming convention established in v0.20.7c.
- **Capstone Corruption = +2 at 20%**: The guaranteed 20% check is actually lower than the standard 25% at Resonance 10, rewarding bold capstone use. However, the elevated +2 Corruption (vs standard +1) reflects the magnitude of Aether channeled during a full cycle release. Uses the `CapstoneActivation` trigger already defined in v0.20.8a.
- **Resonance requirement == 10 (exact equality)**: Functionally equivalent to ≥10 since the cap is 10, but more semantically clear — the Unraveling can only be unleashed when Resonance is at its absolute maximum.
- **Corruption eval BEFORE spending**: Consistent with all prior abilities in this specialization. The player sees the risk assessment before committing to the action.
- **Völva's Vision builds +2 Resonance**: Same as Aether Storm and matching Tier 3's higher Aetheric channeling. A single cast can cross from Safe (0-4) into Risky (5-7) or from Risky into Dangerous (8-9) territory, creating meaningful strategic tension.
- **Aether Storm accumulates damage, Völva's Vision does not**: Only damage-dealing abilities contribute to the Accumulated Aetheric Damage tracker. This preserves the tracker for abilities that actually deal damage, preventing non-combat abilities from inflating the Unraveling payload.
- **PP cost = 5 per T3 ability, 6 for Capstone**: Follows the established codebase pattern (T1=0, T2=4, T3=5, Capstone=6) consistent with `Player.GetSeidkonaPPInvested()`.
- **Roll4D6 dice method**: Follows the `internal virtual` pattern established by `Roll2D6` and `RollD20` for deterministic test overriding.

## Test Results

```
Seiðkona tests: 212
     Passed: 212
     Failed: 0

Breakdown:
  SeidkonaAbilityServiceTests:            98 application tests (27 T1 + 34 T2 + 37 T3/Cap)
    includes 15 Corruption service direct tests (8 T1 + 4 T2 + 3 T3/Cap)
  VolvasVisionResultTests:                10 domain tests
  AetherStormResultTests:                 11 domain tests
  UnravelingResultTests:                  12 domain tests
  (v0.20.8a+b domain VOs unchanged:       83 domain tests)
```

## Files Changed

### New Files (7)
| File | Layer | Type |
|------|-------|------|
| `src/Core/RuneAndRust.Domain/ValueObjects/VolvasVisionResult.cs` | Domain | Value Object |
| `src/Core/RuneAndRust.Domain/ValueObjects/AetherStormResult.cs` | Domain | Value Object |
| `src/Core/RuneAndRust.Domain/ValueObjects/UnravelingResult.cs` | Domain | Value Object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/VolvasVisionResultTests.cs` | Tests | Domain VO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/AetherStormResultTests.cs` | Tests | Domain VO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/UnravelingResultTests.cs` | Tests | Domain VO |
| `docs/changelogs/v0.20.8c-changelog.md` | Docs | Changelog |

### Modified Files (5)
| File | Change |
|------|--------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Added HasUsedUnravelingThisCombat property and ResetUnravelingCooldown method |
| `src/Core/RuneAndRust.Application/Interfaces/ISeidkonaAbilityService.cs` | Added 3 Tier 3/Capstone method signatures, updated class docs |
| `src/Core/RuneAndRust.Application/Services/SeidkonaAbilityService.cs` | Added T3/Capstone implementations, Roll4D6, constants, updated GetAbilityReadiness/GetEffectiveApCost/GetBaseApCost |
| `src/Core/RuneAndRust.Application/Services/SeidkonaCorruptionService.cs` | Replaced deferred Unraveling routing with EvaluateUnravelingRisk, added capstone constants |
| `config/abilities.json` | Added 3 Tier 3/Capstone ability entries |
| `tests/RuneAndRust.Application.UnitTests/Services/SeidkonaAbilityServiceTests.cs` | Extended from 61 to 98 tests with T3/Capstone coverage |
