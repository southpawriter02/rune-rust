# v0.9.1 Ambient Soundscapes - Scope Breakdown

**Version:** 0.9.1
**Theme:** Music System
**Prerequisites:** v0.9.0c Complete (Audio Foundation - TUI Bell Service)
**Total Estimated Tests:** ~20 new tests

---

## Executive Summary

The Music System sub-version implements background music with context-aware themes that change based on game state. Music smoothly transitions between exploration, combat, boss encounters, and safe areas using crossfade effects. The system supports looping tracks, stingers for special events, and respects the music volume setting.

Key focus areas:
- **Music Service**: IMusicService with theme management
- **Music Themes**: Exploration, combat, boss, safe area tracks
- **Transitions**: Crossfade between themes, stingers for events

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.9.1a | Music Service Core | IMusicService, MusicService, playback control | ~8 |
| v0.9.1b | Music Themes | Theme definitions, configuration, track selection | ~6 |
| v0.9.0c | Theme Transitions | Crossfade, stingers, game state triggers | ~6 |

---

## Existing Infrastructure

### Already Implemented (from v0.9.1)

| Feature | Location | Notes |
|---------|----------|-------|
| IAudioService | `Application/Interfaces/IAudioService.cs` | Core playback |
| AudioService | `Infrastructure/Services/AudioService.cs` | Audio player |
| AudioSettingsViewModel | `ViewModels/AudioSettingsViewModel.cs` | Volume settings |
| AudioChannel enum | `Application/Enums/AudioChannel.cs` | Music channel |

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| GameStateService | `Application/Services/GameStateService.cs` | State tracking |
| CombatStateService | `Application/Services/CombatStateService.cs` | Combat detection |
| RoomService | `Application/Services/RoomService.cs` | Room transitions |
| EventBus | `Application/Services/EventBus.cs` | Event system |

### Needs Implementation (v0.9.1)

| Feature | Part | Notes |
|---------|------|-------|
| IMusicService | v0.9.1a | Music interface |
| MusicService | v0.9.1a | Music player |
| MusicTheme enum | v0.9.1b | Theme types |
| MusicThemeConfig | v0.9.1b | Theme definitions |
| CrossfadeManager | v0.9.0c | Transition handling |
| MusicEventHandler | v0.9.0c | State triggers |

---

## Feature Analysis & Categorization

### Core Music Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Music playback | Medium | AudioService | **v0.9.1a** |
| Loop handling | Low | AudioService | **v0.9.1a** |
| Pause/resume | Low | AudioService | **v0.9.1a** |
| Volume control | Low | AudioService | **v0.9.1a** |
| Track management | Medium | File system | **v0.9.1a** |

### Theme Definition Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Theme enum | Low | None | **v0.9.1b** |
| Theme configuration | Medium | JSON config | **v0.9.1b** |
| Track lists per theme | Low | Config | **v0.9.1b** |
| Shuffle/sequential | Low | Config | **v0.9.1b** |
| Intro tracks | Medium | Track timing | **v0.9.1b** |

### Transition Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Crossfade | High | Audio mixing | **v0.9.0c** |
| Stingers | Medium | Track layering | **v0.9.0c** |
| State triggers | Medium | EventBus | **v0.9.0c** |
| Combat detection | Low | CombatState | **v0.9.0c** |
| Boss detection | Low | CombatState | **v0.9.0c** |

---

## Part Definitions

---

## v0.9.1a: Music Service Core

[v0.9.1a Design Specification](v0.9.1a-design-specification.md)

### Overview

Implement the core music service that manages background music playback. This includes the IMusicService interface, MusicService implementation using the underlying AudioService, track looping, pause/resume on game pause, and volume integration with settings.

### Scope

**In Scope:**
- `IMusicService` interface definition
- `MusicService` implementation
- Play music track
- Stop music
- Pause music
- Resume music
- Loop continuously
- Volume control (respects AudioService)
- Current track/theme tracking
- Playlist management (queue next)
- Game pause integration
- Preload tracks for performance

**Out of Scope:**
- Theme definitions (v0.9.1b)
- Crossfade transitions (v0.9.0c)
- Game state triggers (v0.9.0c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Interfaces | 1 | `IMusicService` |
| Services | 1 | `MusicService` |
| Support Classes | 1 | `MusicPlayback` |
| Unit Tests | ~8 | Playback, loop, pause tests |

### Music Service Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                       MUSIC SERVICE ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────────┘

                        ┌───────────────────────────┐
                        │      Game Systems          │
                        │  (Combat, Exploration)     │
                        └─────────────┬─────────────┘
                                      │
                                      ▼
                        ┌───────────────────────────┐
                        │      IMusicService         │
                        │  - SetTheme(theme)         │
                        │  - PlayStinger(name)       │
                        │  - Pause() / Resume()      │
                        │  - SetVolume(vol)          │
                        └─────────────┬─────────────┘
                                      │
                        ┌─────────────┴─────────────┐
                        │       MusicService         │
                        ├───────────────────────────┤
                        │ + CurrentTheme            │
                        │ + CurrentTrack            │
                        │ + IsPlaying               │
                        │                           │
                        │ + CrossfadeManager        │
                        │   (v0.9.0c)               │
                        │                           │
                        │ + ThemeConfig             │
                        │   (v0.9.1b)               │
                        └─────────────┬─────────────┘
                                      │
                                      ▼
                        ┌───────────────────────────┐
                        │      IAudioService         │
                        │      (v0.9.1a)            │
                        └───────────────────────────┘
```

### IMusicService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages background music playback with theme support.
/// </summary>
public interface IMusicService : IDisposable
{
    /// <summary>Gets the currently playing theme.</summary>
    MusicTheme CurrentTheme { get; }
    
    /// <summary>Gets the currently playing track path.</summary>
    string? CurrentTrack { get; }
    
    /// <summary>Gets whether music is currently playing.</summary>
    bool IsPlaying { get; }
    
    /// <summary>Gets whether music is paused.</summary>
    bool IsPaused { get; }
    
    /// <summary>Plays a specific track.</summary>
    /// <param name="trackPath">Path to the music file.</param>
    /// <param name="loop">Whether to loop the track.</param>
    void PlayTrack(string trackPath, bool loop = true);
    
    /// <summary>Stops the current music.</summary>
    void Stop();
    
    /// <summary>Pauses the current music.</summary>
    void Pause();
    
    /// <summary>Resumes paused music.</summary>
    void Resume();
    
    /// <summary>Sets the music volume (0.0 to 1.0).</summary>
    void SetVolume(float volume);
    
    /// <summary>Gets the current music volume.</summary>
    float GetVolume();
    
    /// <summary>Sets the current theme (triggers transition in v0.9.0c).</summary>
    void SetTheme(MusicTheme theme);
    
    /// <summary>Plays a one-shot stinger track.</summary>
    /// <param name="stingerName">Name of the stinger to play.</param>
    /// <param name="onComplete">Callback when stinger finishes.</param>
    void PlayStinger(string stingerName, Action? onComplete = null);
    
    /// <summary>Preloads music tracks for a theme.</summary>
    Task PreloadThemeAsync(MusicTheme theme, CancellationToken ct = default);
    
    /// <summary>Event fired when track changes.</summary>
    event Action<string>? OnTrackChanged;
    
    /// <summary>Event fired when theme changes.</summary>
    event Action<MusicTheme>? OnThemeChanged;
}
```

### MusicService Implementation

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class MusicService : IMusicService
{
    private readonly IAudioService _audioService;
    private readonly IMusicThemeConfig _themeConfig;
    private readonly ILogger<MusicService> _logger;
    
    private Guid _currentPlaybackId;
    private MusicTheme _currentTheme = MusicTheme.None;
    private string? _currentTrack;
    private bool _isPaused;
    
    public MusicTheme CurrentTheme => _currentTheme;
    public string? CurrentTrack => _currentTrack;
    public bool IsPlaying => _currentPlaybackId != Guid.Empty && !_isPaused;
    public bool IsPaused => _isPaused;
    
    public event Action<string>? OnTrackChanged;
    public event Action<MusicTheme>? OnThemeChanged;
    
    public MusicService(IAudioService audioService, IMusicThemeConfig themeConfig, ILogger<MusicService> logger)
    {
        _audioService = audioService;
        _themeConfig = themeConfig;
        _logger = logger;
    }
    
    public void PlayTrack(string trackPath, bool loop = true)
    {
        // Stop current music
        if (_currentPlaybackId != Guid.Empty)
        {
            _audioService.Stop(_currentPlaybackId);
        }
        
        // Start new track
        _currentPlaybackId = _audioService.Play(trackPath, AudioChannel.Music, 1.0f, loop);
        _currentTrack = trackPath;
        _isPaused = false;
        
        _logger.LogInformation("Playing music: {Track}, Loop: {Loop}", trackPath, loop);
        OnTrackChanged?.Invoke(trackPath);
    }
    
    public void Stop()
    {
        if (_currentPlaybackId != Guid.Empty)
        {
            _audioService.Stop(_currentPlaybackId);
            _currentPlaybackId = Guid.Empty;
            _currentTrack = null;
            _isPaused = false;
        }
        
        _logger.LogDebug("Music stopped");
    }
    
    public void Pause()
    {
        if (_currentPlaybackId != Guid.Empty && !_isPaused)
        {
            _audioService.Pause(_currentPlaybackId);
            _isPaused = true;
            _logger.LogDebug("Music paused");
        }
    }
    
    public void Resume()
    {
        if (_currentPlaybackId != Guid.Empty && _isPaused)
        {
            _audioService.Resume(_currentPlaybackId);
            _isPaused = false;
            _logger.LogDebug("Music resumed");
        }
    }
    
    public void SetVolume(float volume)
    {
        _audioService.SetChannelVolume(AudioChannel.Music, Math.Clamp(volume, 0f, 1f));
    }
    
    public float GetVolume()
    {
        return _audioService.GetChannelVolume(AudioChannel.Music);
    }
    
    public void SetTheme(MusicTheme theme)
    {
        if (theme == _currentTheme) return;
        
        var previousTheme = _currentTheme;
        _currentTheme = theme;
        
        // Get track for new theme
        var trackPath = _themeConfig.GetTrackForTheme(theme);
        if (trackPath is not null)
        {
            PlayTrack(trackPath, loop: true);
        }
        else
        {
            Stop();
        }
        
        _logger.LogInformation("Theme changed: {From} -> {To}", previousTheme, theme);
        OnThemeChanged?.Invoke(theme);
    }
    
    public async Task PreloadThemeAsync(MusicTheme theme, CancellationToken ct = default)
    {
        var tracks = _themeConfig.GetAllTracksForTheme(theme);
        await _audioService.PreloadAsync(tracks, ct);
        _logger.LogDebug("Preloaded {Count} tracks for theme {Theme}", tracks.Count, theme);
    }
    
    public void Dispose()
    {
        Stop();
    }
}
```

### Acceptance Criteria

- [ ] MusicService can play tracks
- [ ] Tracks loop continuously
- [ ] Stop stops playback
- [ ] Pause pauses playback
- [ ] Resume continues playback
- [ ] Volume control works
- [ ] CurrentTrack reports correctly
- [ ] IsPlaying reports correctly
- [ ] SetTheme plays theme track
- [ ] Events fire on changes
- [ ] PreloadTheme caches tracks
- [ ] ~8 unit tests pass

---

## v0.9.1b: Music Themes

[v0.9.1b Design Specification](v0.9.1b-design-specification.md)

### Overview

Define music themes with their associated tracks and configuration. Each theme can have multiple tracks (for variety), optional intro tracks, shuffle settings, and volume adjustments. Themes are loaded from JSON configuration.

### Scope

**In Scope:**
- `MusicTheme` enum definition
- `IMusicThemeConfig` interface
- `MusicThemeConfig` implementation
- `music-themes.json` configuration
- Theme track lists
- Shuffle vs sequential playback
- Intro track support
- Volume per theme
- Stinger definitions
- Default theme fallback

**Out of Scope:**
- Core music service (v0.9.1a)
- Crossfade transitions (v0.9.0c)
- Game state detection (v0.9.0c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 1 | `MusicTheme` |
| Interfaces | 1 | `IMusicThemeConfig` |
| Services | 1 | `MusicThemeConfig` |
| Configuration | 1 | `music-themes.json` |
| Unit Tests | ~6 | Theme config, track selection tests |

### Music Theme Definitions

```
┌─────────────────────────────────────────────────────────────────────┐
│                       MUSIC THEME DEFINITIONS                        │
└─────────────────────────────────────────────────────────────────────┘

  THEME              TRACKS                        SETTINGS
  ─────              ──────                        ────────

  MainMenu      ──▶  • menu_theme.ogg              Volume: 0.7
                                                   Loop: true

  Exploration   ──▶  • dungeon_ambient_01.ogg      Volume: 0.6
                     • dungeon_ambient_02.ogg      Loop: true
                     • dungeon_ambient_03.ogg      Shuffle: true

  Combat        ──▶  • combat_intro.ogg (intro)    Volume: 0.8
                     • combat_intense.ogg          Loop: true
                                                   IntroOnce: true

  BossCombat    ──▶  • boss_intro.ogg (intro)      Volume: 0.9
                     • boss_epic.ogg               Loop: true
                     • boss_epic_phase2.ogg        PhaseChange: true

  SafeArea      ──▶  • town_peaceful.ogg           Volume: 0.5
                     • tavern_music.ogg            Loop: true
                                                   Shuffle: true

  STINGERS (One-shot, no loop):

  Victory       ──▶  • victory_fanfare.ogg         Volume: 1.0
  Defeat        ──▶  • defeat_somber.ogg           Volume: 0.8
  LevelUp       ──▶  • levelup_jingle.ogg          Volume: 1.0
  QuestComplete ──▶  • quest_complete.ogg          Volume: 0.9
```

### MusicTheme Enum

```csharp
namespace RuneAndRust.Application.Enums;

/// <summary>
/// Music themes that change based on game context.
/// </summary>
public enum MusicTheme
{
    /// <summary>No music playing.</summary>
    None,
    
    /// <summary>Main menu music.</summary>
    MainMenu,
    
    /// <summary>Dungeon exploration ambient music.</summary>
    Exploration,
    
    /// <summary>Standard combat music.</summary>
    Combat,
    
    /// <summary>Boss encounter music.</summary>
    BossCombat,
    
    /// <summary>Town/safe area peaceful music.</summary>
    SafeArea,
    
    /// <summary>Victory celebration (stinger).</summary>
    Victory,
    
    /// <summary>Defeat/death (stinger).</summary>
    Defeat
}
```

### IMusicThemeConfig Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Configuration for music themes and track selection.
/// </summary>
public interface IMusicThemeConfig
{
    /// <summary>Gets a track path for a theme.</summary>
    /// <param name="theme">The music theme.</param>
    /// <returns>Path to a track, or null if no tracks.</returns>
    string? GetTrackForTheme(MusicTheme theme);
    
    /// <summary>Gets all tracks for a theme.</summary>
    IReadOnlyList<string> GetAllTracksForTheme(MusicTheme theme);
    
    /// <summary>Gets the intro track for a theme, if any.</summary>
    string? GetIntroTrack(MusicTheme theme);
    
    /// <summary>Gets the volume multiplier for a theme.</summary>
    float GetThemeVolume(MusicTheme theme);
    
    /// <summary>Gets whether a theme should shuffle tracks.</summary>
    bool ShouldShuffle(MusicTheme theme);
    
    /// <summary>Gets a stinger track path.</summary>
    string? GetStingerTrack(string stingerName);
    
    /// <summary>Gets all available stingers.</summary>
    IReadOnlyList<string> GetAvailableStingers();
}
```

### MusicThemeConfig Implementation

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class MusicThemeConfig : IMusicThemeConfig
{
    private readonly Dictionary<MusicTheme, ThemeDefinition> _themes;
    private readonly Dictionary<string, StingerDefinition> _stingers;
    private readonly Random _random = new();
    private readonly Dictionary<MusicTheme, int> _trackIndices = new();
    
    public MusicThemeConfig(IConfigurationProvider configProvider)
    {
        var config = configProvider.LoadConfig<MusicThemesJson>("music-themes.json");
        _themes = config.Themes.ToDictionary(t => t.Theme, t => t);
        _stingers = config.Stingers.ToDictionary(s => s.Name, s => s);
    }
    
    public string? GetTrackForTheme(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def) || def.Tracks.Count == 0)
            return null;
        
        if (def.Shuffle)
        {
            return def.Tracks[_random.Next(def.Tracks.Count)];
        }
        else
        {
            // Sequential
            if (!_trackIndices.TryGetValue(theme, out var index))
            {
                index = 0;
            }
            
            var track = def.Tracks[index % def.Tracks.Count];
            _trackIndices[theme] = index + 1;
            return track;
        }
    }
    
    public IReadOnlyList<string> GetAllTracksForTheme(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return Array.Empty<string>();
        
        return def.Tracks;
    }
    
    public string? GetIntroTrack(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return null;
        
        return def.IntroTrack;
    }
    
    public float GetThemeVolume(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return 1.0f;
        
        return def.Volume;
    }
    
    public bool ShouldShuffle(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return false;
        
        return def.Shuffle;
    }
    
    public string? GetStingerTrack(string stingerName)
    {
        if (!_stingers.TryGetValue(stingerName, out var def))
            return null;
        
        return def.Track;
    }
}
```

### Music Themes Configuration

```json
{
  "$schema": "./schemas/music-themes.schema.json",
  "themes": [
    {
      "theme": "MainMenu",
      "tracks": ["audio/music/menu_theme.ogg"],
      "volume": 0.7,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "Exploration",
      "tracks": [
        "audio/music/dungeon_ambient_01.ogg",
        "audio/music/dungeon_ambient_02.ogg",
        "audio/music/dungeon_ambient_03.ogg"
      ],
      "volume": 0.6,
      "loop": true,
      "shuffle": true
    },
    {
      "theme": "Combat",
      "tracks": ["audio/music/combat_intense.ogg"],
      "introTrack": "audio/music/combat_intro.ogg",
      "volume": 0.8,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "BossCombat",
      "tracks": [
        "audio/music/boss_epic.ogg",
        "audio/music/boss_epic_phase2.ogg"
      ],
      "introTrack": "audio/music/boss_intro.ogg",
      "volume": 0.9,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "SafeArea",
      "tracks": [
        "audio/music/town_peaceful.ogg",
        "audio/music/tavern_music.ogg"
      ],
      "volume": 0.5,
      "loop": true,
      "shuffle": true
    }
  ],
  "stingers": [
    {
      "name": "victory",
      "track": "audio/music/victory_fanfare.ogg",
      "volume": 1.0
    },
    {
      "name": "defeat",
      "track": "audio/music/defeat_somber.ogg",
      "volume": 0.8
    },
    {
      "name": "level-up",
      "track": "audio/music/levelup_jingle.ogg",
      "volume": 1.0
    },
    {
      "name": "quest-complete",
      "track": "audio/music/quest_complete.ogg",
      "volume": 0.9
    }
  ],
  "transitions": {
    "defaultCrossfade": 2.0,
    "combatCrossfade": 0.5,
    "stingerFadeOut": 1.0,
    "stingerResumeDelay": 0.5
  }
}
```

### Acceptance Criteria

- [ ] MusicTheme enum has all themes
- [ ] Themes load from JSON config
- [ ] GetTrackForTheme returns tracks
- [ ] Shuffle mode randomizes selection
- [ ] Sequential mode cycles tracks
- [ ] Intro tracks return correctly
- [ ] Theme volumes are configurable
- [ ] Stingers are defined
- [ ] GetStingerTrack works
- [ ] Missing themes return null
- [ ] ~6 unit tests pass

---

## v0.9.0c: Theme Transitions

[v0.9.0c Design Specification](v0.9.0c-design-specification.md)

### Overview

Implement smooth theme transitions with crossfade effects and game state triggers. Music automatically changes based on game context (entering combat, boss encounter, safe area). Stingers interrupt and resume normal music.

### Scope

**In Scope:**
- `ICrossfadeManager` interface
- `CrossfadeManager` implementation
- Crossfade between tracks
- Configurable fade duration
- Stinger with background duck
- Resume after stinger
- `MusicEventHandler` for triggers
- Combat start → Combat theme
- Boss detected → Boss theme
- Combat end → Victory/exploration
- Enter safe area → Safe theme
- Leave safe area → Exploration
- Pause game → Pause music
- Resume game → Resume music

**Out of Scope:**
- Core music service (v0.9.1a)
- Theme definitions (v0.9.1b)
- Sound effects (v0.9.2)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Interfaces | 1 | `ICrossfadeManager` |
| Services | 1 | `CrossfadeManager` |
| Event Handlers | 1 | `MusicEventHandler` |
| Unit Tests | ~6 | Crossfade, trigger tests |

### Theme Transition Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       THEME TRANSITION FLOW                          │
└─────────────────────────────────────────────────────────────────────┘

     Game Events                   Transitions              Result
     ───────────                   ───────────              ──────

     [Enter Dungeon] ───────▶  Fade In (2s) ──────────▶ Exploration
           │
           │ (enemy spotted)
           ▼
     [Combat Start] ────────▶  Quick Fade (0.5s) ─────▶ Combat Theme
           │                   (+ Combat Intro)
           │ (boss detected)
           ▼
     [Boss Encounter] ──────▶  Quick Fade (0.5s) ─────▶ Boss Theme
           │                   (+ Boss Intro)
           │ (boss defeated)
           ▼
     [Victory] ─────────────▶  Duck + Stinger ────────▶ Victory Fanfare
           │                                                  │
           │                                            (stinger ends)
           │                                                  ▼
           └──────────────────────────────────────────▶ Resume Exploration
           
     [Enter Town] ──────────▶  Crossfade (2s) ────────▶ Safe Theme

     [Game Pause] ──────────▶  Fade Out (0.5s) ───────▶ Music Paused

     [Game Resume] ─────────▶  Fade In (0.5s) ────────▶ Music Resumed


CROSSFADE VISUALIZATION:
Time:    0.0s      0.5s      1.0s      1.5s      2.0s
         │         │         │         │         │
Old:     ████████  ██████░░  ████░░░░  ██░░░░░░  ░░░░░░░░
New:     ░░░░░░░░  ░░██████  ░░░░████  ░░░░░░██  ████████
         │         │         │         │         │
         100%      75%       50%       25%       0% (old)
         0%        25%       50%       75%       100% (new)


STINGER WITH DUCK:
Time:    0.0s              2.0s              4.0s
         │                 │                 │
Main:    ████████  ██░░░░  ░░░░░░░░░  ░░░░██  ████████
         (100%)    (duck)  (ducked)   (fade)  (resume)
                     │         │
Stinger:             █████████████████████░░░
                     (play)              (end)
```

### ICrossfadeManager Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages smooth transitions between music tracks.
/// </summary>
public interface ICrossfadeManager
{
    /// <summary>Gets whether a transition is in progress.</summary>
    bool IsTransitioning { get; }
    
    /// <summary>Crossfades from current track to a new track.</summary>
    /// <param name="newTrackPath">Path to the new track.</param>
    /// <param name="duration">Crossfade duration.</param>
    /// <param name="loop">Whether to loop the new track.</param>
    Task CrossfadeToAsync(string newTrackPath, TimeSpan duration, bool loop = true);
    
    /// <summary>Plays a stinger, ducking the main music.</summary>
    /// <param name="stingerPath">Path to the stinger audio.</param>
    /// <param name="onComplete">Callback when stinger completes.</param>
    Task PlayStingerAsync(string stingerPath, Action? onComplete = null);
    
    /// <summary>Fades out the current music.</summary>
    Task FadeOutAsync(TimeSpan duration);
    
    /// <summary>Fades in music from silence.</summary>
    Task FadeInAsync(string trackPath, TimeSpan duration, bool loop = true);
}
```

### CrossfadeManager Implementation

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class CrossfadeManager : ICrossfadeManager
{
    private readonly IAudioService _audioService;
    private readonly ILogger<CrossfadeManager> _logger;
    
    private Guid _currentPlaybackId;
    private Guid _fadingOutPlaybackId;
    
    public bool IsTransitioning { get; private set; }
    
    public CrossfadeManager(IAudioService audioService, ILogger<CrossfadeManager> logger)
    {
        _audioService = audioService;
        _logger = logger;
    }
    
    public async Task CrossfadeToAsync(string newTrackPath, TimeSpan duration, bool loop = true)
    {
        if (IsTransitioning) return;
        IsTransitioning = true;
        
        var oldPlaybackId = _currentPlaybackId;
        
        // Start new track at zero volume
        var newPlaybackId = _audioService.Play(newTrackPath, AudioChannel.Music, 0f, loop);
        _currentPlaybackId = newPlaybackId;
        
        // Gradually adjust volumes
        var steps = (int)(duration.TotalMilliseconds / 50);
        for (int i = 0; i <= steps; i++)
        {
            var progress = (float)i / steps;
            
            // Fade out old track
            if (oldPlaybackId != Guid.Empty)
            {
                _audioService.SetPlaybackVolume(oldPlaybackId, 1f - progress);
            }
            
            // Fade in new track
            _audioService.SetPlaybackVolume(newPlaybackId, progress);
            
            await Task.Delay(50);
        }
        
        // Clean up old playback
        if (oldPlaybackId != Guid.Empty)
        {
            _audioService.Stop(oldPlaybackId);
        }
        
        IsTransitioning = false;
        _logger.LogDebug("Crossfaded to: {Track} over {Duration}ms", newTrackPath, duration.TotalMilliseconds);
    }
    
    public async Task PlayStingerAsync(string stingerPath, Action? onComplete = null)
    {
        // Duck the main music
        var mainVolume = _audioService.GetChannelVolume(AudioChannel.Music);
        _audioService.SetChannelVolume(AudioChannel.Music, mainVolume * 0.3f);
        
        // Play stinger
        var stingerId = _audioService.Play(stingerPath, AudioChannel.Effects, 1.0f, loop: false);
        
        // Wait for stinger to complete (approximate)
        await Task.Delay(GetStingerDuration(stingerPath));
        
        // Restore main music volume
        _audioService.SetChannelVolume(AudioChannel.Music, mainVolume);
        
        _logger.LogDebug("Played stinger: {Path}", stingerPath);
        onComplete?.Invoke();
    }
    
    public async Task FadeOutAsync(TimeSpan duration)
    {
        var steps = (int)(duration.TotalMilliseconds / 50);
        for (int i = steps; i >= 0; i--)
        {
            var volume = (float)i / steps;
            _audioService.SetPlaybackVolume(_currentPlaybackId, volume);
            await Task.Delay(50);
        }
        
        _audioService.Stop(_currentPlaybackId);
        _currentPlaybackId = Guid.Empty;
    }
}
```

### MusicEventHandler

```csharp
namespace RuneAndRust.Application.EventHandlers;

/// <summary>
/// Subscribes to game events and triggers music theme changes.
/// </summary>
public class MusicEventHandler : IDisposable
{
    private readonly IMusicService _musicService;
    private readonly IEventBus _eventBus;
    private readonly ICrossfadeManager _crossfade;
    private readonly IMusicThemeConfig _themeConfig;
    private readonly List<IDisposable> _subscriptions = new();
    
    public MusicEventHandler(
        IMusicService musicService,
        IEventBus eventBus,
        ICrossfadeManager crossfade,
        IMusicThemeConfig themeConfig)
    {
        _musicService = musicService;
        _eventBus = eventBus;
        _crossfade = crossfade;
        _themeConfig = themeConfig;
        
        RegisterSubscriptions();
    }
    
    private void RegisterSubscriptions()
    {
        // Combat start
        _subscriptions.Add(_eventBus.Subscribe<CombatStartedEvent>(async e =>
        {
            var theme = e.IsBossEncounter ? MusicTheme.BossCombat : MusicTheme.Combat;
            var track = _themeConfig.GetTrackForTheme(theme);
            if (track is not null)
            {
                var intro = _themeConfig.GetIntroTrack(theme);
                if (intro is not null)
                {
                    // Play intro then main track
                    _musicService.PlayTrack(intro, loop: false);
                    // Queue main track after intro
                }
                else
                {
                    await _crossfade.CrossfadeToAsync(track, TimeSpan.FromSeconds(0.5));
                }
            }
        }));
        
        // Combat end
        _subscriptions.Add(_eventBus.Subscribe<CombatEndedEvent>(async e =>
        {
            if (e.IsVictory)
            {
                // Play victory stinger, then return to exploration
                var stinger = _themeConfig.GetStingerTrack("victory");
                if (stinger is not null)
                {
                    await _crossfade.PlayStingerAsync(stinger, () => 
                        _musicService.SetTheme(MusicTheme.Exploration));
                }
            }
            else
            {
                // Play defeat stinger
                var stinger = _themeConfig.GetStingerTrack("defeat");
                if (stinger is not null)
                {
                    await _crossfade.PlayStingerAsync(stinger);
                }
            }
        }));
        
        // Room change
        _subscriptions.Add(_eventBus.Subscribe<RoomChangedEvent>(e =>
        {
            if (e.Room.IsSafeArea)
            {
                _musicService.SetTheme(MusicTheme.SafeArea);
            }
            else if (_musicService.CurrentTheme == MusicTheme.SafeArea)
            {
                _musicService.SetTheme(MusicTheme.Exploration);
            }
        }));
        
        // Level up
        _subscriptions.Add(_eventBus.Subscribe<LevelUpEvent>(async e =>
        {
            var stinger = _themeConfig.GetStingerTrack("level-up");
            if (stinger is not null)
            {
                await _crossfade.PlayStingerAsync(stinger);
            }
        }));
        
        // Game pause/resume
        _subscriptions.Add(_eventBus.Subscribe<GamePausedEvent>(_ => _musicService.Pause()));
        _subscriptions.Add(_eventBus.Subscribe<GameResumedEvent>(_ => _musicService.Resume()));
    }
    
    public void Dispose()
    {
        foreach (var sub in _subscriptions)
        {
            sub.Dispose();
        }
    }
}
```

### Acceptance Criteria

- [ ] Crossfade transitions smoothly
- [ ] Configurable fade duration works
- [ ] Stingers duck background music
- [ ] Stingers resume normal music
- [ ] Combat start triggers combat theme
- [ ] Boss detected triggers boss theme
- [ ] Victory plays stinger then exploration
- [ ] Safe area triggers safe theme
- [ ] Leaving safe area returns exploration
- [ ] Game pause pauses music
- [ ] Game resume resumes music
- [ ] ~6 unit tests pass

---

## Dependencies & Prerequisites

```
v0.9.0c (TUI Bell Service) - REQUIRED
    │
    └── Audio Foundation complete ────────────────────────────────────────┐
                                                                          │
v0.9.1 (Music System)                                                     │
    │                                                                     │
    ├── v0.9.1a: Music Service Core ──────────────────────────────────────┤
    │       Dependencies: IAudioService (v0.9.1a)                         │
    │       Provides: IMusicService, basic playback                       │
    │                                                                     │
    ├── v0.9.1b: Music Themes ────────────────────────────────────────────┤
    │       Dependencies: v0.9.1a (music service)                         │
    │       Provides: MusicTheme, IMusicThemeConfig, JSON config          │
    │                                                                     │
    └── v0.9.0c: Theme Transitions ───────────────────────────────────────┘
            Dependencies: v0.9.1a, v0.9.1b, EventBus
            Provides: ICrossfadeManager, MusicEventHandler
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.9.1a | ~3 | ~1 | ~8 | Medium |
| v0.9.1b | ~3 | ~0 | ~6 | Low-Medium |
| v0.9.0c | ~3 | ~1 | ~6 | High |
| **Total** | **~9** | **~2** | **~20** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Crossfade audio artifacts | Medium | Medium | Test with real audio files |
| Theme timing issues | Low | Low | Careful event ordering |
| Missing audio files | Low | Medium | Graceful fallback to silence |
| Memory from cached tracks | Low | Low | Limit cache size |

---

## Design Decisions (Confirmed)

### Music Service

| Decision | Value | Notes |
|----------|-------|-------|
| **Looping** | True by default | Background music loops |
| **Events** | OnTrackChanged, OnThemeChanged | Observable state |
| **Preload** | Per theme | Efficient loading |

### Theme Configuration

| Decision | Value | Notes |
|----------|-------|-------|
| **Format** | JSON config | Data-driven |
| **Shuffle** | Per theme setting | Variety option |
| **Stingers** | Named, one-shot | Victory, defeat, etc. |

### Transitions

| Decision | Value | Notes |
|----------|-------|-------|
| **Default Crossfade** | 2 seconds | Smooth transition |
| **Combat Crossfade** | 0.5 seconds | Quick response |
| **Stinger Duck** | 30% volume | Background audible |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.9.1a Design Spec** - Create detailed design for Music Service Core
3. **v0.9.1a Implementation** - Build music playback
4. **v0.9.1b Design Spec** - Create specification for Music Themes
5. **v0.9.1b Implementation** - Build theme configuration
6. **v0.9.0c Design Spec** - Create specification for Theme Transitions
7. **v0.9.0c Implementation** - Build crossfade and triggers

---

*This scope breakdown provides a structured approach to implementing v0.9.1 Music System. Context-aware music themes enhance game atmosphere, with smooth transitions that respond to gameplay events.*
