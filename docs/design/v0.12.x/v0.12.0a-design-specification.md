# v0.12.0a Design Specification: Core Statistics

**Version:** 0.12.0a
**Parent:** v0.12.0 (Statistics System)
**Prerequisites:** v0.11.2c Complete (Quality System)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [PlayerStatistics Entity](#4-playerstatistics-entity)
5. [StatisticCategory Enum](#5-statisticcategory-enum)
6. [StatisticsMetrics Record](#6-statisticsmetrics-record)
7. [IStatisticsService Interface](#7-istatisticsservice-interface)
8. [StatisticsService Implementation](#8-statisticsservice-implementation)
9. [StatisticsEventHandler](#9-statisticseventhandler)
10. [Configuration Schema](#10-configuration-schema)
11. [Configuration File](#11-configuration-file)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.12.0a implements the core statistics tracking infrastructure for the game. This includes the `PlayerStatistics` entity that tracks comprehensive game statistics across combat, exploration, and progression categories. Statistics are updated automatically via event handlers that respond to game events such as monster kills, damage dealt, rooms discovered, and items crafted. This foundational system enables detailed player performance tracking and provides data for the Statistics View in v0.12.0c.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | PlayerStatistics |
| **Domain Enums** | StatisticCategory |
| **Application Records** | StatisticsMetrics, CombatRating |
| **Interfaces** | IStatisticsService |
| **Services** | StatisticsService |
| **Event Handlers** | StatisticsEventHandler |
| **Configuration** | statistics.json, statistics.schema.json |
| **Tests** | ~12 new unit tests |

### Architectural Significance

This version establishes the **Event-Driven Statistics Pattern** that will be used throughout the game:
- Automatic statistic updates via domain events
- Category-based statistic organization
- Calculated metrics derived from raw statistics
- Session and total playtime tracking
- Monster kill tracking by type

---

## 2. Feature Overview

```
v0.12.0a Core Statistics Features
├── PlayerStatistics Entity
│   ├── Combat Statistics
│   │   ├── Monsters killed (total and by type)
│   │   ├── Bosses killed
│   │   ├── Damage dealt / received
│   │   ├── Critical hits / misses
│   │   ├── Abilities used
│   │   └── Death count
│   ├── Exploration Statistics
│   │   ├── Rooms discovered
│   │   ├── Secrets found
│   │   ├── Traps triggered / avoided
│   │   ├── Doors opened
│   │   └── Chests opened
│   ├── Progression Statistics
│   │   ├── XP earned
│   │   ├── Levels gained
│   │   ├── Items found / crafted
│   │   ├── Gold earned / spent
│   │   ├── Quests completed
│   │   ├── Puzzles solved
│   │   └── Resources gathered
│   └── Time Statistics
│       ├── Total playtime
│       ├── Session count
│       ├── First played
│       └── Last played
├── StatisticCategory Enum
│   ├── Combat
│   ├── Exploration
│   ├── Progression
│   ├── Time
│   └── Dice (placeholder for v0.12.0b)
├── IStatisticsService Interface
│   ├── IncrementStat method
│   ├── RecordMonsterKill method
│   ├── RecordDamageDealt method
│   ├── RecordDamageReceived method
│   ├── RecordRoomDiscovered method
│   ├── RecordPlaytime method
│   ├── GetStatistic method
│   ├── GetCategoryStatistics method
│   ├── GetPlayerStatistics method
│   └── GetMetrics method
├── StatisticsService Implementation
│   ├── Statistic increment logic
│   ├── Monster kill by type tracking
│   ├── Damage recording
│   ├── Playtime accumulation
│   ├── Category grouping
│   └── Metrics calculation
├── StatisticsEventHandler
│   ├── MonsterKilledEvent handler
│   ├── DamageDealtEvent handler
│   ├── DamageReceivedEvent handler
│   ├── RoomDiscoveredEvent handler
│   ├── ItemPickedUpEvent handler
│   ├── ItemCraftedEvent handler
│   ├── QuestCompletedEvent handler
│   ├── AbilityUsedEvent handler
│   ├── PlayerDeathEvent handler
│   └── ResourceGatheredEvent handler
└── Configuration
    ├── statistics.json
    └── statistics.schema.json
```

---

## 3. Architecture Diagrams

### 3.1 Core Statistics Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                    CORE STATISTICS ARCHITECTURE                      │
└─────────────────────────────────────────────────────────────────────┘

                          PRESENTATION LAYER
                          ──────────────────

                   (Statistics View - v0.12.0c)


                          APPLICATION LAYER
                          ─────────────────

     Game Events                           Event Handler
     ───────────                           ─────────────

     [MonsterKilledEvent] ───────┐
     [DamageDealtEvent]   ───────┤     ┌───────────────────────────────┐
     [DamageReceivedEvent]───────┤     │   StatisticsEventHandler      │
     [ItemPickedUpEvent]  ───────┼────▶├───────────────────────────────┤
     [RoomDiscoveredEvent]───────┤     │ + Handle(MonsterKilledEvent)  │
     [QuestCompletedEvent]───────┤     │ + Handle(DamageDealtEvent)    │
     [ItemCraftedEvent]   ───────┤     │ + Handle(DamageReceivedEvent) │
     [AbilityUsedEvent]   ───────┤     │ + Handle(ItemPickedUpEvent)   │
     [PlayerDeathEvent]   ───────┤     │ + Handle(RoomDiscoveredEvent) │
     [ResourceGatheredEvent]─────┘     │ + Handle(QuestCompletedEvent) │
                                       │ + Handle(ItemCraftedEvent)    │
                                       │ + Handle(AbilityUsedEvent)    │
                                       │ + Handle(PlayerDeathEvent)    │
                                       │ + Handle(ResourceGatheredEvent)│
                                       └───────────────┬───────────────┘
                                                       │ calls
                                                       ▼
                          ┌───────────────────────────────────────────┐
                          │           IStatisticsService              │
                          ├───────────────────────────────────────────┤
                          │ + IncrementStat(player, name, amount)     │
                          │ + RecordMonsterKill(player, type, isBoss) │
                          │ + RecordDamageDealt(player, amt, crit)    │
                          │ + RecordDamageReceived(player, amount)    │
                          │ + RecordRoomDiscovered(player)            │
                          │ + RecordPlaytime(player, sessionTime)     │
                          │ + GetStatistic(player, statName)          │
                          │ + GetCategoryStatistics(player, category) │
                          │ + GetPlayerStatistics(player)             │
                          │ + GetMetrics(player)                      │
                          └───────────────────┬───────────────────────┘
                                              │
                          ┌───────────────────┴───────────────────────┐
                          │           StatisticsService               │
                          ├───────────────────────────────────────────┤
                          │ Dependencies:                             │
                          │ - IPlayerRepository                       │
                          │ - ILogger<StatisticsService>              │
                          │                                           │
                          │ Methods:                                  │
                          │ + IncrementStat()                         │
                          │ + RecordMonsterKill()                     │
                          │ + RecordDamageDealt()                     │
                          │ + CalculateMetrics()                      │
                          │ + GroupByCategory()                       │
                          └───────────────────────────────────────────┘


                            DOMAIN LAYER
                            ────────────

    ┌─────────────────────────────────────────────────────────────────┐
    │                      PlayerStatistics                            │
    ├─────────────────────────────────────────────────────────────────┤
    │ Combat Stats:              │ Exploration Stats:                  │
    │ - MonstersKilled           │ - RoomsDiscovered                   │
    │ - MonstersByType (dict)    │ - SecretsFound                      │
    │ - TotalDamageDealt         │ - TrapsTriggered                    │
    │ - TotalDamageReceived      │ - TrapsAvoided                      │
    │ - CriticalHits             │ - DoorsOpened                       │
    │ - AttacksMissed            │ - ChestsOpened                      │
    │ - AbilitiesUsed            │                                     │
    │ - DeathCount               │ Progression Stats:                  │
    │ - BossesKilled             │ - TotalXPEarned                     │
    │                            │ - LevelsGained                      │
    │ Time Stats:                │ - ItemsFound                        │
    │ - TotalPlaytime            │ - ItemsCrafted                      │
    │ - FirstPlayed              │ - GoldEarned / GoldSpent            │
    │ - LastPlayed               │ - QuestsCompleted                   │
    │ - SessionCount             │ - PuzzlesSolved                     │
    │                            │ - ResourcesGathered                 │
    ├─────────────────────────────────────────────────────────────────┤
    │ + IncrementStat(name, amount)                                   │
    │ + RecordMonsterKill(monsterType)                                │
    │ + RecordPlaytime(sessionTime)                                   │
    │ + StartNewSession()                                             │
    │ + GetStatistic(statName)                                        │
    └─────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────┐     ┌─────────────────────────────────┐
    │   StatisticCategory     │     │       StatisticsMetrics          │
    ├─────────────────────────┤     ├─────────────────────────────────┤
    │ Combat                  │     │ + AverageDamagePerHit            │
    │ Exploration             │     │ + AverageDamageReceived          │
    │ Progression             │     │ + CriticalHitRate                │
    │ Time                    │     │ + MissRate                       │
    │ Dice                    │     │ + TrapAvoidanceRate              │
    └─────────────────────────┘     │ + GoldBalance                    │
                                    │ + AverageSessionLength           │
    ┌─────────────────────────┐     │ + CombatRating                   │
    │      CombatRating       │     └─────────────────────────────────┘
    ├─────────────────────────┤
    │ Novice                  │
    │ Apprentice              │
    │ Journeyman              │
    │ Skilled                 │
    │ Veteran                 │
    │ Master                  │
    │ Legend                  │
    └─────────────────────────┘
```

### 3.2 Event-Driven Statistics Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  EVENT-DRIVEN STATISTICS FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Player Action: Kill Monster
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 1: COMBAT SERVICE                            │
├─────────────────────────────────────────────────────────────────────┤
│  CombatService.ProcessAttack()                                      │
│  - Monster HP reaches 0                                             │
│  - Publishes MonsterKilledEvent                                     │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 2: EVENT BUS                                 │
├─────────────────────────────────────────────────────────────────────┤
│  EventBus.Publish(MonsterKilledEvent)                               │
│  - Routes to registered handlers                                    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 3: STATISTICS EVENT HANDLER                  │
├─────────────────────────────────────────────────────────────────────┤
│  StatisticsEventHandler.Handle(MonsterKilledEvent)                  │
│  - Retrieves player from repository                                 │
│  - Calls StatisticsService methods                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 4: STATISTICS SERVICE                        │
├─────────────────────────────────────────────────────────────────────┤
│  StatisticsService.RecordMonsterKill(player, "goblin", false)       │
│  StatisticsService.IncrementStat(player, "xpEarned", 50)            │
│  - Updates PlayerStatistics entity                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 5: PLAYER STATISTICS ENTITY                  │
├─────────────────────────────────────────────────────────────────────┤
│  PlayerStatistics.RecordMonsterKill("goblin")                       │
│  - MonstersKilled: 126 → 127                                        │
│  - MonstersByType["goblin"]: 44 → 45                                │
│                                                                      │
│  PlayerStatistics.IncrementStat("xpEarned", 50)                     │
│  - TotalXPEarned: 15290 → 15340                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Statistic Categories Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                       STATISTIC CATEGORIES                           │
└─────────────────────────────────────────────────────────────────────┘

    COMBAT                    EXPLORATION              PROGRESSION
    ──────                    ───────────              ───────────

    ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
    │    COMBAT       │      │   EXPLORATION   │      │   PROGRESSION   │
    ├─────────────────┤      ├─────────────────┤      ├─────────────────┤
    │ MonstersKilled  │      │ RoomsDiscovered │      │ TotalXPEarned   │
    │ BossesKilled    │      │ SecretsFound    │      │ LevelsGained    │
    │ TotalDamageDealt│      │ TrapsTriggered  │      │ ItemsFound      │
    │ TotalDamageRecv │      │ TrapsAvoided    │      │ ItemsCrafted    │
    │ CriticalHits    │      │ DoorsOpened     │      │ GoldEarned      │
    │ AttacksMissed   │      │ ChestsOpened    │      │ GoldSpent       │
    │ AbilitiesUsed   │      │                 │      │ QuestsCompleted │
    │ DeathCount      │      │                 │      │ PuzzlesSolved   │
    │                 │      │                 │      │ ResourcesGatherd│
    └─────────────────┘      └─────────────────┘      └─────────────────┘


    TIME                      CALCULATED METRICS
    ────                      ──────────────────

    ┌─────────────────┐      ┌─────────────────────────────────────────┐
    │      TIME       │      │           METRICS (derived)             │
    ├─────────────────┤      ├─────────────────────────────────────────┤
    │ TotalPlaytime   │      │ AverageDamagePerHit = Dealt / Hits      │
    │ SessionCount    │      │ CriticalHitRate = Crits / TotalAttacks  │
    │ FirstPlayed     │      │ MissRate = Misses / TotalAttacks        │
    │ LastPlayed      │      │ TrapAvoidanceRate = Avoided / Total     │
    │                 │      │ GoldBalance = Earned - Spent            │
    │                 │      │ AvgSessionLen = Playtime / Sessions     │
    └─────────────────┘      │ CombatRating = f(kills, deaths, crits)  │
                             └─────────────────────────────────────────┘
```

### 3.4 Clean Architecture Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CLEAN ARCHITECTURE LAYERS                       │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                      PRESENTATION LAYER                          │
    │                                                                  │
    │  (Statistics View - v0.12.0c)                                    │
    │  - Renders statistics to player                                  │
    │  - Formats numbers and percentages                               │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      APPLICATION LAYER                           │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │   IStatisticsService    │  │  StatisticsEventHandler     │   │
    │  │   • IncrementStat()     │  │  • Handle(MonsterKilled)    │   │
    │  │   • RecordMonsterKill() │  │  • Handle(DamageDealt)      │   │
    │  │   • RecordPlaytime()    │  │  • Handle(RoomDiscovered)   │   │
    │  │   • GetMetrics()        │  │  • Handle(ItemCrafted)      │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │   StatisticsService     │  │    StatisticsMetrics        │   │
    │  │   (implementation)      │  │    (record)                 │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                        DOMAIN LAYER                              │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │    PlayerStatistics     │  │    StatisticCategory        │   │
    │  │    (entity)             │  │    (enum)                   │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    │                                                                  │
    │  ┌─────────────────────────┐                                    │
    │  │      CombatRating       │                                    │
    │  │      (enum)             │                                    │
    │  └─────────────────────────┘                                    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    INFRASTRUCTURE LAYER                          │
    │                                                                  │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                  Configuration Files                     │    │
    │  │  config/statistics.json                                  │    │
    │  │  config/schemas/statistics.schema.json                   │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. PlayerStatistics Entity

### 4.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/PlayerStatistics.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Interfaces;

/// <summary>
/// Tracks comprehensive game statistics for a player.
/// </summary>
/// <remarks>
/// <para>Statistics are organized into categories:</para>
/// <list type="bullet">
///   <item><description>Combat: Kills, damage, critical hits, deaths</description></item>
///   <item><description>Exploration: Rooms, secrets, traps, doors</description></item>
///   <item><description>Progression: XP, levels, items, gold, quests</description></item>
///   <item><description>Time: Playtime, sessions, dates</description></item>
/// </list>
/// <para>Statistics are updated via event handlers in response to game events.</para>
/// </remarks>
public class PlayerStatistics : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this statistics record.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the player ID these statistics belong to.
    /// </summary>
    public Guid PlayerId { get; private set; }

    // ═══════════════════════════════════════════════════════════════════
    // COMBAT STATISTICS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the total number of monsters killed.
    /// </summary>
    public int MonstersKilled { get; private set; }

    /// <summary>
    /// Gets the count of monsters killed by type.
    /// </summary>
    private readonly Dictionary<string, int> _monstersByType = new();

    /// <summary>
    /// Gets a read-only view of monsters killed by type.
    /// </summary>
    public IReadOnlyDictionary<string, int> MonstersByType => _monstersByType;

    /// <summary>
    /// Gets the total damage dealt to enemies.
    /// </summary>
    public long TotalDamageDealt { get; private set; }

    /// <summary>
    /// Gets the total damage received from enemies.
    /// </summary>
    public long TotalDamageReceived { get; private set; }

    /// <summary>
    /// Gets the number of critical hits landed.
    /// </summary>
    public int CriticalHits { get; private set; }

    /// <summary>
    /// Gets the number of attacks that missed.
    /// </summary>
    public int AttacksMissed { get; private set; }

    /// <summary>
    /// Gets the number of abilities used.
    /// </summary>
    public int AbilitiesUsed { get; private set; }

    /// <summary>
    /// Gets the number of times the player has died.
    /// </summary>
    public int DeathCount { get; private set; }

    /// <summary>
    /// Gets the number of bosses killed.
    /// </summary>
    public int BossesKilled { get; private set; }

    /// <summary>
    /// Gets the total number of attacks made (for rate calculations).
    /// </summary>
    public int TotalAttacks { get; private set; }

    // ═══════════════════════════════════════════════════════════════════
    // EXPLORATION STATISTICS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the number of rooms discovered.
    /// </summary>
    public int RoomsDiscovered { get; private set; }

    /// <summary>
    /// Gets the number of secrets found.
    /// </summary>
    public int SecretsFound { get; private set; }

    /// <summary>
    /// Gets the number of traps triggered.
    /// </summary>
    public int TrapsTriggered { get; private set; }

    /// <summary>
    /// Gets the number of traps successfully avoided.
    /// </summary>
    public int TrapsAvoided { get; private set; }

    /// <summary>
    /// Gets the number of doors opened.
    /// </summary>
    public int DoorsOpened { get; private set; }

    /// <summary>
    /// Gets the number of chests opened.
    /// </summary>
    public int ChestsOpened { get; private set; }

    // ═══════════════════════════════════════════════════════════════════
    // PROGRESSION STATISTICS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the total XP earned.
    /// </summary>
    public long TotalXPEarned { get; private set; }

    /// <summary>
    /// Gets the number of levels gained.
    /// </summary>
    public int LevelsGained { get; private set; }

    /// <summary>
    /// Gets the number of items found (picked up).
    /// </summary>
    public int ItemsFound { get; private set; }

    /// <summary>
    /// Gets the number of items crafted.
    /// </summary>
    public int ItemsCrafted { get; private set; }

    /// <summary>
    /// Gets the total gold earned.
    /// </summary>
    public long GoldEarned { get; private set; }

    /// <summary>
    /// Gets the total gold spent.
    /// </summary>
    public long GoldSpent { get; private set; }

    /// <summary>
    /// Gets the number of quests completed.
    /// </summary>
    public int QuestsCompleted { get; private set; }

    /// <summary>
    /// Gets the number of puzzles solved.
    /// </summary>
    public int PuzzlesSolved { get; private set; }

    /// <summary>
    /// Gets the number of resources gathered.
    /// </summary>
    public int ResourcesGathered { get; private set; }

    // ═══════════════════════════════════════════════════════════════════
    // TIME STATISTICS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the total playtime across all sessions.
    /// </summary>
    public TimeSpan TotalPlaytime { get; private set; }

    /// <summary>
    /// Gets the date and time the player first played.
    /// </summary>
    public DateTime FirstPlayed { get; private set; }

    /// <summary>
    /// Gets the date and time the player last played.
    /// </summary>
    public DateTime LastPlayed { get; private set; }

    /// <summary>
    /// Gets the total number of play sessions.
    /// </summary>
    public int SessionCount { get; private set; }

    // ═══════════════════════════════════════════════════════════════════
    // CONSTRUCTORS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Private constructor for EF Core and factory method.
    /// </summary>
    private PlayerStatistics() { }

    /// <summary>
    /// Creates a new PlayerStatistics instance for a player.
    /// </summary>
    /// <param name="playerId">The ID of the player these statistics belong to.</param>
    /// <returns>A new PlayerStatistics instance with initialized values.</returns>
    public static PlayerStatistics Create(Guid playerId)
    {
        return new PlayerStatistics
        {
            Id = Guid.NewGuid(),
            PlayerId = playerId,
            FirstPlayed = DateTime.UtcNow,
            LastPlayed = DateTime.UtcNow,
            SessionCount = 1
        };
    }

    // ═══════════════════════════════════════════════════════════════════
    // METHODS
    // ═══════════════════════════════════════════════════════════════════

    /// <summary>
    /// Increments a named statistic by the specified amount.
    /// </summary>
    /// <param name="statName">The name of the statistic to increment.</param>
    /// <param name="amount">The amount to increment by (must be non-negative).</param>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when amount is negative.</exception>
    /// <exception cref="ArgumentException">Thrown when statName is unknown.</exception>
    public void IncrementStat(string statName, int amount = 1)
    {
        ArgumentOutOfRangeException.ThrowIfNegative(amount);

        switch (statName.ToLowerInvariant())
        {
            // Combat
            case "monsterskilled": MonstersKilled += amount; break;
            case "damagedealt": TotalDamageDealt += amount; break;
            case "damagereceived": TotalDamageReceived += amount; break;
            case "criticalhits": CriticalHits += amount; break;
            case "attacksmissed": AttacksMissed += amount; break;
            case "abilitiesused": AbilitiesUsed += amount; break;
            case "deathcount": DeathCount += amount; break;
            case "bosseskilled": BossesKilled += amount; break;
            case "totalattacks": TotalAttacks += amount; break;

            // Exploration
            case "roomsdiscovered": RoomsDiscovered += amount; break;
            case "secretsfound": SecretsFound += amount; break;
            case "trapstriggered": TrapsTriggered += amount; break;
            case "trapsavoided": TrapsAvoided += amount; break;
            case "doorsopened": DoorsOpened += amount; break;
            case "chestsopened": ChestsOpened += amount; break;

            // Progression
            case "xpearned": TotalXPEarned += amount; break;
            case "levelsgained": LevelsGained += amount; break;
            case "itemsfound": ItemsFound += amount; break;
            case "itemscrafted": ItemsCrafted += amount; break;
            case "goldearned": GoldEarned += amount; break;
            case "goldspent": GoldSpent += amount; break;
            case "questscompleted": QuestsCompleted += amount; break;
            case "puzzlessolved": PuzzlesSolved += amount; break;
            case "resourcesgathered": ResourcesGathered += amount; break;

            default:
                throw new ArgumentException($"Unknown statistic: {statName}", nameof(statName));
        }
    }

    /// <summary>
    /// Records a monster kill, tracking both total and by type.
    /// </summary>
    /// <param name="monsterType">The type/name of the monster killed.</param>
    public void RecordMonsterKill(string monsterType)
    {
        MonstersKilled++;
        var normalizedType = monsterType.ToLowerInvariant();
        _monstersByType.TryGetValue(normalizedType, out var count);
        _monstersByType[normalizedType] = count + 1;
    }

    /// <summary>
    /// Records session playtime.
    /// </summary>
    /// <param name="sessionTime">The duration of the session to add.</param>
    public void RecordPlaytime(TimeSpan sessionTime)
    {
        TotalPlaytime += sessionTime;
        LastPlayed = DateTime.UtcNow;
    }

    /// <summary>
    /// Starts a new play session, incrementing the session count.
    /// </summary>
    public void StartNewSession()
    {
        SessionCount++;
        LastPlayed = DateTime.UtcNow;
    }

    /// <summary>
    /// Gets a statistic value by name.
    /// </summary>
    /// <param name="statName">The name of the statistic to retrieve.</param>
    /// <returns>The statistic value, or 0 if not found.</returns>
    public long GetStatistic(string statName)
    {
        return statName.ToLowerInvariant() switch
        {
            // Combat
            "monsterskilled" => MonstersKilled,
            "damagedealt" => TotalDamageDealt,
            "damagereceived" => TotalDamageReceived,
            "criticalhits" => CriticalHits,
            "attacksmissed" => AttacksMissed,
            "abilitiesused" => AbilitiesUsed,
            "deathcount" => DeathCount,
            "bosseskilled" => BossesKilled,
            "totalattacks" => TotalAttacks,

            // Exploration
            "roomsdiscovered" => RoomsDiscovered,
            "secretsfound" => SecretsFound,
            "trapstriggered" => TrapsTriggered,
            "trapsavoided" => TrapsAvoided,
            "doorsopened" => DoorsOpened,
            "chestsopened" => ChestsOpened,

            // Progression
            "xpearned" => TotalXPEarned,
            "levelsgained" => LevelsGained,
            "itemsfound" => ItemsFound,
            "itemscrafted" => ItemsCrafted,
            "goldearned" => GoldEarned,
            "goldspent" => GoldSpent,
            "questscompleted" => QuestsCompleted,
            "puzzlessolved" => PuzzlesSolved,
            "resourcesgathered" => ResourcesGathered,

            // Time
            "playtimeseconds" => (long)TotalPlaytime.TotalSeconds,
            "sessioncount" => SessionCount,

            _ => 0
        };
    }
}
```

---

## 5. StatisticCategory Enum

### 5.1 Enum Definition

**File:** `src/Core/RuneAndRust.Domain/Enums/StatisticCategory.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories of tracked statistics.
/// </summary>
/// <remarks>
/// Statistics are grouped into categories for organized display
/// and filtering in the statistics view.
/// </remarks>
public enum StatisticCategory
{
    /// <summary>
    /// Combat-related statistics: kills, damage, critical hits, deaths.
    /// </summary>
    Combat,

    /// <summary>
    /// Exploration-related statistics: rooms, secrets, traps, doors.
    /// </summary>
    Exploration,

    /// <summary>
    /// Progression-related statistics: XP, levels, items, gold, quests.
    /// </summary>
    Progression,

    /// <summary>
    /// Time-related statistics: playtime, sessions, dates.
    /// </summary>
    Time,

    /// <summary>
    /// Dice roll statistics: rolls, natural 20s/1s, streaks.
    /// Implemented in v0.12.0b.
    /// </summary>
    Dice
}
```

---

## 6. StatisticsMetrics Record

### 6.1 Metrics Record Definition

**File:** `src/Core/RuneAndRust.Application/Models/StatisticsMetrics.cs`

```csharp
namespace RuneAndRust.Application.Models;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Calculated statistics metrics derived from raw statistics.
/// </summary>
/// <remarks>
/// These metrics provide meaningful averages and rates calculated
/// from the raw statistics stored in <see cref="PlayerStatistics"/>.
/// </remarks>
/// <param name="AverageDamagePerHit">Average damage dealt per successful attack.</param>
/// <param name="AverageDamageReceived">Average damage received per hit taken.</param>
/// <param name="CriticalHitRate">Percentage of attacks that were critical hits.</param>
/// <param name="MissRate">Percentage of attacks that missed.</param>
/// <param name="TrapAvoidanceRate">Percentage of traps successfully avoided.</param>
/// <param name="GoldBalance">Net gold (earned minus spent).</param>
/// <param name="AverageSessionLength">Average duration of play sessions.</param>
/// <param name="CombatRating">Calculated combat performance rating.</param>
public record StatisticsMetrics(
    double AverageDamagePerHit,
    double AverageDamageReceived,
    double CriticalHitRate,
    double MissRate,
    double TrapAvoidanceRate,
    long GoldBalance,
    TimeSpan AverageSessionLength,
    CombatRating CombatRating);
```

### 6.2 CombatRating Enum

**File:** `src/Core/RuneAndRust.Application/Models/CombatRating.cs`

```csharp
namespace RuneAndRust.Application.Models;

/// <summary>
/// Combat performance rating tiers.
/// </summary>
/// <remarks>
/// <para>Rating is calculated based on multiple factors:</para>
/// <list type="bullet">
///   <item><description>Kill/death ratio</description></item>
///   <item><description>Critical hit rate</description></item>
///   <item><description>Miss rate</description></item>
///   <item><description>Boss kills</description></item>
/// </list>
/// </remarks>
public enum CombatRating
{
    /// <summary>
    /// Novice: Low kills, high deaths. Just starting out.
    /// </summary>
    Novice,

    /// <summary>
    /// Apprentice: Learning the ropes. Some improvement shown.
    /// </summary>
    Apprentice,

    /// <summary>
    /// Journeyman: Average performance. Competent combatant.
    /// </summary>
    Journeyman,

    /// <summary>
    /// Skilled: Good kill/death ratio. Above average fighter.
    /// </summary>
    Skilled,

    /// <summary>
    /// Veteran: High kill count, experienced warrior.
    /// </summary>
    Veteran,

    /// <summary>
    /// Master: Excellent stats across the board.
    /// </summary>
    Master,

    /// <summary>
    /// Legend: Near-perfect combat performance.
    /// </summary>
    Legend
}
```

---

## 7. IStatisticsService Interface

### 7.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IStatisticsService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.Models;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Service for tracking and querying player statistics.
/// </summary>
/// <remarks>
/// <para>This service provides methods for:</para>
/// <list type="bullet">
///   <item><description>Recording statistic updates (via event handlers)</description></item>
///   <item><description>Querying individual statistics</description></item>
///   <item><description>Retrieving statistics by category</description></item>
///   <item><description>Calculating derived metrics</description></item>
/// </list>
/// </remarks>
public interface IStatisticsService
{
    /// <summary>
    /// Increments a named statistic by the specified amount.
    /// </summary>
    /// <param name="player">The player whose statistics to update.</param>
    /// <param name="statName">The name of the statistic to increment.</param>
    /// <param name="amount">The amount to increment by (default 1).</param>
    void IncrementStat(Player player, string statName, int amount = 1);

    /// <summary>
    /// Records a monster kill with type tracking.
    /// </summary>
    /// <param name="player">The player who killed the monster.</param>
    /// <param name="monsterType">The type/name of the monster killed.</param>
    /// <param name="isBoss">Whether the monster was a boss.</param>
    void RecordMonsterKill(Player player, string monsterType, bool isBoss = false);

    /// <summary>
    /// Records damage dealt by the player.
    /// </summary>
    /// <param name="player">The player who dealt damage.</param>
    /// <param name="amount">The amount of damage dealt.</param>
    /// <param name="wasCritical">Whether the hit was a critical hit.</param>
    void RecordDamageDealt(Player player, int amount, bool wasCritical);

    /// <summary>
    /// Records damage received by the player.
    /// </summary>
    /// <param name="player">The player who received damage.</param>
    /// <param name="amount">The amount of damage received.</param>
    void RecordDamageReceived(Player player, int amount);

    /// <summary>
    /// Records that the player discovered a room.
    /// </summary>
    /// <param name="player">The player who discovered the room.</param>
    void RecordRoomDiscovered(Player player);

    /// <summary>
    /// Records session playtime.
    /// </summary>
    /// <param name="player">The player whose playtime to record.</param>
    /// <param name="sessionTime">The duration of the play session.</param>
    void RecordPlaytime(Player player, TimeSpan sessionTime);

    /// <summary>
    /// Gets a specific statistic value.
    /// </summary>
    /// <param name="player">The player whose statistic to retrieve.</param>
    /// <param name="statName">The name of the statistic.</param>
    /// <returns>The statistic value.</returns>
    long GetStatistic(Player player, string statName);

    /// <summary>
    /// Gets all statistics for a specific category.
    /// </summary>
    /// <param name="player">The player whose statistics to retrieve.</param>
    /// <param name="category">The category to filter by.</param>
    /// <returns>A dictionary of statistic names to values.</returns>
    IReadOnlyDictionary<string, long> GetCategoryStatistics(
        Player player,
        StatisticCategory category);

    /// <summary>
    /// Gets the player's statistics entity.
    /// </summary>
    /// <param name="player">The player whose statistics to retrieve.</param>
    /// <returns>The PlayerStatistics entity.</returns>
    PlayerStatistics GetPlayerStatistics(Player player);

    /// <summary>
    /// Gets calculated metrics derived from raw statistics.
    /// </summary>
    /// <param name="player">The player whose metrics to calculate.</param>
    /// <returns>The calculated statistics metrics.</returns>
    StatisticsMetrics GetMetrics(Player player);
}
```

---

## 8. StatisticsService Implementation

### 8.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/StatisticsService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Models;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Service for tracking and querying player statistics.
/// </summary>
/// <remarks>
/// <para>This service:</para>
/// <list type="bullet">
///   <item><description>Updates statistics on the PlayerStatistics entity</description></item>
///   <item><description>Groups statistics by category</description></item>
///   <item><description>Calculates derived metrics</description></item>
/// </list>
/// </remarks>
public class StatisticsService : IStatisticsService
{
    private readonly ILogger<StatisticsService> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="StatisticsService"/> class.
    /// </summary>
    /// <param name="logger">Logger instance for diagnostics.</param>
    public StatisticsService(ILogger<StatisticsService> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public void IncrementStat(Player player, string statName, int amount = 1)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogDebug(
            "Incrementing {StatName} by {Amount} for player {PlayerId}",
            statName,
            amount,
            player.Id);

        stats.IncrementStat(statName, amount);
    }

    /// <inheritdoc />
    public void RecordMonsterKill(Player player, string monsterType, bool isBoss = false)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogDebug(
            "Recording monster kill: {MonsterType} (boss: {IsBoss}) for player {PlayerId}",
            monsterType,
            isBoss,
            player.Id);

        stats.RecordMonsterKill(monsterType);

        if (isBoss)
        {
            stats.IncrementStat("bossesKilled");
        }
    }

    /// <inheritdoc />
    public void RecordDamageDealt(Player player, int amount, bool wasCritical)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogDebug(
            "Recording damage dealt: {Amount} (critical: {WasCritical}) for player {PlayerId}",
            amount,
            wasCritical,
            player.Id);

        stats.IncrementStat("damageDealt", amount);
        stats.IncrementStat("totalAttacks");

        if (wasCritical)
        {
            stats.IncrementStat("criticalHits");
        }
    }

    /// <inheritdoc />
    public void RecordDamageReceived(Player player, int amount)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogDebug(
            "Recording damage received: {Amount} for player {PlayerId}",
            amount,
            player.Id);

        stats.IncrementStat("damageReceived", amount);
    }

    /// <inheritdoc />
    public void RecordRoomDiscovered(Player player)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogDebug(
            "Recording room discovered for player {PlayerId}",
            player.Id);

        stats.IncrementStat("roomsDiscovered");
    }

    /// <inheritdoc />
    public void RecordPlaytime(Player player, TimeSpan sessionTime)
    {
        var stats = GetOrCreateStatistics(player);

        _logger.LogInformation(
            "Recording playtime: {SessionTime} for player {PlayerId}",
            sessionTime,
            player.Id);

        stats.RecordPlaytime(sessionTime);
    }

    /// <inheritdoc />
    public long GetStatistic(Player player, string statName)
    {
        var stats = GetOrCreateStatistics(player);
        return stats.GetStatistic(statName);
    }

    /// <inheritdoc />
    public IReadOnlyDictionary<string, long> GetCategoryStatistics(
        Player player,
        StatisticCategory category)
    {
        var stats = GetOrCreateStatistics(player);
        var result = new Dictionary<string, long>();

        var statNames = GetStatNamesForCategory(category);
        foreach (var statName in statNames)
        {
            result[statName] = stats.GetStatistic(statName);
        }

        return result;
    }

    /// <inheritdoc />
    public PlayerStatistics GetPlayerStatistics(Player player)
    {
        return GetOrCreateStatistics(player);
    }

    /// <inheritdoc />
    public StatisticsMetrics GetMetrics(Player player)
    {
        var stats = GetOrCreateStatistics(player);

        // Calculate averages (avoid division by zero)
        var avgDamagePerHit = stats.TotalAttacks > 0
            ? (double)stats.TotalDamageDealt / stats.TotalAttacks
            : 0;

        var avgDamageReceived = stats.TotalDamageReceived > 0
            ? (double)stats.TotalDamageReceived / Math.Max(1, stats.DeathCount * 10)
            : 0;

        var critRate = stats.TotalAttacks > 0
            ? (double)stats.CriticalHits / stats.TotalAttacks
            : 0;

        var missRate = stats.TotalAttacks > 0
            ? (double)stats.AttacksMissed / stats.TotalAttacks
            : 0;

        var totalTraps = stats.TrapsTriggered + stats.TrapsAvoided;
        var trapAvoidRate = totalTraps > 0
            ? (double)stats.TrapsAvoided / totalTraps
            : 0;

        var goldBalance = stats.GoldEarned - stats.GoldSpent;

        var avgSessionLength = stats.SessionCount > 0
            ? TimeSpan.FromTicks(stats.TotalPlaytime.Ticks / stats.SessionCount)
            : TimeSpan.Zero;

        var combatRating = CalculateCombatRating(stats);

        return new StatisticsMetrics(
            AverageDamagePerHit: avgDamagePerHit,
            AverageDamageReceived: avgDamageReceived,
            CriticalHitRate: critRate,
            MissRate: missRate,
            TrapAvoidanceRate: trapAvoidRate,
            GoldBalance: goldBalance,
            AverageSessionLength: avgSessionLength,
            CombatRating: combatRating);
    }

    /// <summary>
    /// Gets or creates the statistics entity for a player.
    /// </summary>
    private static PlayerStatistics GetOrCreateStatistics(Player player)
    {
        if (player.Statistics is null)
        {
            player.InitializeStatistics(PlayerStatistics.Create(player.Id));
        }

        return player.Statistics!;
    }

    /// <summary>
    /// Gets the statistic names for a category.
    /// </summary>
    private static IReadOnlyList<string> GetStatNamesForCategory(StatisticCategory category)
    {
        return category switch
        {
            StatisticCategory.Combat => new[]
            {
                "monstersKilled", "bossesKilled", "damageDealt", "damageReceived",
                "criticalHits", "attacksMissed", "abilitiesUsed", "deathCount", "totalAttacks"
            },
            StatisticCategory.Exploration => new[]
            {
                "roomsDiscovered", "secretsFound", "trapsTriggered",
                "trapsAvoided", "doorsOpened", "chestsOpened"
            },
            StatisticCategory.Progression => new[]
            {
                "xpEarned", "levelsGained", "itemsFound", "itemsCrafted",
                "goldEarned", "goldSpent", "questsCompleted", "puzzlesSolved", "resourcesGathered"
            },
            StatisticCategory.Time => new[]
            {
                "playtimeSeconds", "sessionCount"
            },
            _ => Array.Empty<string>()
        };
    }

    /// <summary>
    /// Calculates the combat rating based on statistics.
    /// </summary>
    private static CombatRating CalculateCombatRating(PlayerStatistics stats)
    {
        // Calculate kill/death ratio (avoid div by zero)
        var kdRatio = stats.DeathCount > 0
            ? (double)stats.MonstersKilled / stats.DeathCount
            : stats.MonstersKilled;

        var critRate = stats.TotalAttacks > 0
            ? (double)stats.CriticalHits / stats.TotalAttacks
            : 0;

        var missRate = stats.TotalAttacks > 0
            ? (double)stats.AttacksMissed / stats.TotalAttacks
            : 1;

        // Calculate score (0-100)
        var score = 0.0;

        // K/D ratio contribution (up to 40 points)
        score += Math.Min(40, kdRatio * 4);

        // Crit rate contribution (up to 20 points, expect ~5-10%)
        score += Math.Min(20, critRate * 200);

        // Miss rate penalty (subtract up to 20 points)
        score -= Math.Min(20, missRate * 100);

        // Boss kills contribution (up to 20 points)
        score += Math.Min(20, stats.BossesKilled * 5);

        // Clamp score
        score = Math.Clamp(score, 0, 100);

        return score switch
        {
            >= 90 => CombatRating.Legend,
            >= 75 => CombatRating.Master,
            >= 60 => CombatRating.Veteran,
            >= 45 => CombatRating.Skilled,
            >= 30 => CombatRating.Journeyman,
            >= 15 => CombatRating.Apprentice,
            _ => CombatRating.Novice
        };
    }
}
```

---

## 9. StatisticsEventHandler

### 9.1 Event Handler Implementation

**File:** `src/Core/RuneAndRust.Application/EventHandlers/StatisticsEventHandler.cs`

```csharp
namespace RuneAndRust.Application.EventHandlers;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Events;

/// <summary>
/// Handles game events to update player statistics automatically.
/// </summary>
/// <remarks>
/// <para>This handler responds to the following events:</para>
/// <list type="bullet">
///   <item><description>MonsterKilledEvent: Updates kills, XP</description></item>
///   <item><description>DamageDealtEvent: Updates damage dealt, crits</description></item>
///   <item><description>DamageReceivedEvent: Updates damage received</description></item>
///   <item><description>RoomDiscoveredEvent: Updates rooms, secrets</description></item>
///   <item><description>ItemPickedUpEvent: Updates items found, gold</description></item>
///   <item><description>ItemCraftedEvent: Updates items crafted</description></item>
///   <item><description>QuestCompletedEvent: Updates quests completed</description></item>
///   <item><description>AbilityUsedEvent: Updates abilities used</description></item>
///   <item><description>PlayerDeathEvent: Updates death count</description></item>
///   <item><description>ResourceGatheredEvent: Updates resources gathered</description></item>
/// </list>
/// </remarks>
public class StatisticsEventHandler :
    IEventHandler<MonsterKilledEvent>,
    IEventHandler<DamageDealtEvent>,
    IEventHandler<DamageReceivedEvent>,
    IEventHandler<RoomDiscoveredEvent>,
    IEventHandler<ItemPickedUpEvent>,
    IEventHandler<ItemCraftedEvent>,
    IEventHandler<QuestCompletedEvent>,
    IEventHandler<AbilityUsedEvent>,
    IEventHandler<PlayerDeathEvent>,
    IEventHandler<ResourceGatheredEvent>
{
    private readonly IStatisticsService _statisticsService;
    private readonly IPlayerRepository _playerRepository;
    private readonly ILogger<StatisticsEventHandler> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="StatisticsEventHandler"/> class.
    /// </summary>
    /// <param name="statisticsService">The statistics service.</param>
    /// <param name="playerRepository">The player repository.</param>
    /// <param name="logger">Logger instance for diagnostics.</param>
    public StatisticsEventHandler(
        IStatisticsService statisticsService,
        IPlayerRepository playerRepository,
        ILogger<StatisticsEventHandler> logger)
    {
        _statisticsService = statisticsService ?? throw new ArgumentNullException(nameof(statisticsService));
        _playerRepository = playerRepository ?? throw new ArgumentNullException(nameof(playerRepository));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Handles the MonsterKilledEvent.
    /// </summary>
    public Task Handle(MonsterKilledEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.RecordMonsterKill(player, @event.MonsterType, @event.IsBoss);
        _statisticsService.IncrementStat(player, "xpEarned", @event.XPAwarded);

        _logger.LogDebug(
            "Recorded monster kill: {Type} for {Player}",
            @event.MonsterType,
            player.Name);

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the DamageDealtEvent.
    /// </summary>
    public Task Handle(DamageDealtEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.RecordDamageDealt(player, @event.Amount, @event.WasCritical);

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the DamageReceivedEvent.
    /// </summary>
    public Task Handle(DamageReceivedEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.RecordDamageReceived(player, @event.Amount);

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the RoomDiscoveredEvent.
    /// </summary>
    public Task Handle(RoomDiscoveredEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.RecordRoomDiscovered(player);

        if (@event.HasSecret)
        {
            _statisticsService.IncrementStat(player, "secretsFound");
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the ItemPickedUpEvent.
    /// </summary>
    public Task Handle(ItemPickedUpEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "itemsFound");

        if (@event.ItemType.Equals("gold", StringComparison.OrdinalIgnoreCase))
        {
            _statisticsService.IncrementStat(player, "goldEarned", @event.Amount);
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the ItemCraftedEvent.
    /// </summary>
    public Task Handle(ItemCraftedEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "itemsCrafted");

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the QuestCompletedEvent.
    /// </summary>
    public Task Handle(QuestCompletedEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "questsCompleted");

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the AbilityUsedEvent.
    /// </summary>
    public Task Handle(AbilityUsedEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "abilitiesUsed");

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the PlayerDeathEvent.
    /// </summary>
    public Task Handle(PlayerDeathEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "deathCount");

        _logger.LogInformation(
            "Player {Player} died (death #{Count})",
            player.Name,
            _statisticsService.GetStatistic(player, "deathCount"));

        return Task.CompletedTask;
    }

    /// <summary>
    /// Handles the ResourceGatheredEvent.
    /// </summary>
    public Task Handle(ResourceGatheredEvent @event, CancellationToken ct)
    {
        var player = _playerRepository.GetById(@event.PlayerId);
        if (player is null) return Task.CompletedTask;

        _statisticsService.IncrementStat(player, "resourcesGathered", @event.Quantity);

        return Task.CompletedTask;
    }
}
```

---

## 10. Configuration Schema

### 10.1 JSON Schema

**File:** `config/schemas/statistics.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://runeandrust.game/schemas/statistics.schema.json",
  "title": "Statistics Configuration",
  "description": "Schema for configuring statistics tracking and combat rating thresholds.",
  "type": "object",
  "required": ["combatRating", "categories"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file."
    },
    "combatRating": {
      "type": "object",
      "description": "Combat rating threshold configuration.",
      "required": ["thresholds"],
      "properties": {
        "thresholds": {
          "type": "array",
          "description": "Score thresholds for each rating tier.",
          "minItems": 7,
          "maxItems": 7,
          "items": {
            "type": "object",
            "required": ["rating", "minScore"],
            "properties": {
              "rating": {
                "type": "string",
                "enum": ["Novice", "Apprentice", "Journeyman", "Skilled", "Veteran", "Master", "Legend"],
                "description": "The combat rating tier."
              },
              "minScore": {
                "type": "integer",
                "minimum": 0,
                "maximum": 100,
                "description": "Minimum score required for this rating."
              },
              "displayName": {
                "type": "string",
                "description": "Display name for the rating tier."
              }
            }
          }
        },
        "weights": {
          "type": "object",
          "description": "Weights for score calculation components.",
          "properties": {
            "kdRatio": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Weight for kill/death ratio (max points)."
            },
            "critRate": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Weight for critical hit rate (max points)."
            },
            "missRatePenalty": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Penalty for miss rate (max points subtracted)."
            },
            "bossKills": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Weight for boss kills (max points)."
            }
          }
        }
      }
    },
    "categories": {
      "type": "object",
      "description": "Statistics category definitions.",
      "properties": {
        "combat": {
          "type": "array",
          "description": "Combat category statistic names.",
          "items": { "type": "string" }
        },
        "exploration": {
          "type": "array",
          "description": "Exploration category statistic names.",
          "items": { "type": "string" }
        },
        "progression": {
          "type": "array",
          "description": "Progression category statistic names.",
          "items": { "type": "string" }
        },
        "time": {
          "type": "array",
          "description": "Time category statistic names.",
          "items": { "type": "string" }
        }
      }
    }
  },
  "additionalProperties": false
}
```

---

## 11. Configuration File

### 11.1 Statistics Configuration

**File:** `config/statistics.json`

```json
{
  "$schema": "./schemas/statistics.schema.json",
  "combatRating": {
    "thresholds": [
      { "rating": "Novice", "minScore": 0, "displayName": "Novice Fighter" },
      { "rating": "Apprentice", "minScore": 15, "displayName": "Apprentice Warrior" },
      { "rating": "Journeyman", "minScore": 30, "displayName": "Journeyman Combatant" },
      { "rating": "Skilled", "minScore": 45, "displayName": "Skilled Warrior" },
      { "rating": "Veteran", "minScore": 60, "displayName": "Veteran Fighter" },
      { "rating": "Master", "minScore": 75, "displayName": "Master Combatant" },
      { "rating": "Legend", "minScore": 90, "displayName": "Legendary Warrior" }
    ],
    "weights": {
      "kdRatio": 40,
      "critRate": 20,
      "missRatePenalty": 20,
      "bossKills": 20
    }
  },
  "categories": {
    "combat": [
      "monstersKilled",
      "bossesKilled",
      "damageDealt",
      "damageReceived",
      "criticalHits",
      "attacksMissed",
      "abilitiesUsed",
      "deathCount",
      "totalAttacks"
    ],
    "exploration": [
      "roomsDiscovered",
      "secretsFound",
      "trapsTriggered",
      "trapsAvoided",
      "doorsOpened",
      "chestsOpened"
    ],
    "progression": [
      "xpEarned",
      "levelsGained",
      "itemsFound",
      "itemsCrafted",
      "goldEarned",
      "goldSpent",
      "questsCompleted",
      "puzzlesSolved",
      "resourcesGathered"
    ],
    "time": [
      "playtimeSeconds",
      "sessionCount"
    ]
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `StatisticsService` | Information | Playtime recording |
| `StatisticsService` | Debug | Statistic increments, damage recording |
| `StatisticsEventHandler` | Information | Player death events |
| `StatisticsEventHandler` | Debug | All other event handling |

### 12.2 Log Message Examples

```csharp
// StatisticsService - Information
_logger.LogInformation(
    "Recording playtime: {SessionTime} for player {PlayerId}",
    sessionTime, player.Id);

// StatisticsService - Debug
_logger.LogDebug(
    "Incrementing {StatName} by {Amount} for player {PlayerId}",
    statName, amount, player.Id);

_logger.LogDebug(
    "Recording monster kill: {MonsterType} (boss: {IsBoss}) for player {PlayerId}",
    monsterType, isBoss, player.Id);

_logger.LogDebug(
    "Recording damage dealt: {Amount} (critical: {WasCritical}) for player {PlayerId}",
    amount, wasCritical, player.Id);

// StatisticsEventHandler - Information
_logger.LogInformation(
    "Player {Player} died (death #{Count})",
    player.Name, deathCount);

// StatisticsEventHandler - Debug
_logger.LogDebug(
    "Recorded monster kill: {Type} for {Player}",
    @event.MonsterType, player.Name);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| PlayerStatistics Entity | 4 |
| StatisticsService | 4 |
| StatisticsEventHandler | 3 |
| StatisticsMetrics Calculation | 1 |
| **Total** | **~12** |

### 13.2 Test Specifications

**File:** `tests/RuneAndRust.Tests/Domain/PlayerStatisticsTests.cs`

```csharp
[TestFixture]
public class PlayerStatisticsTests
{
    [Test]
    public void IncrementStat_ValidStat_IncrementsCorrectly();

    [Test]
    public void IncrementStat_UnknownStat_ThrowsArgumentException();

    [Test]
    public void RecordMonsterKill_TracksTypeCorrectly();

    [Test]
    public void GetStatistic_ReturnsCorrectValue();
}
```

**File:** `tests/RuneAndRust.Tests/Application/StatisticsServiceTests.cs`

```csharp
[TestFixture]
public class StatisticsServiceTests
{
    [Test]
    public void RecordMonsterKill_IncrementsKillsAndTracksType();

    [Test]
    public void RecordDamageDealt_UpdatesDamageAndCrits();

    [Test]
    public void GetCategoryStatistics_GroupsCorrectly();

    [Test]
    public void GetMetrics_CalculatesAveragesCorrectly();
}
```

**File:** `tests/RuneAndRust.Tests/Application/StatisticsEventHandlerTests.cs`

```csharp
[TestFixture]
public class StatisticsEventHandlerTests
{
    [Test]
    public void Handle_MonsterKilledEvent_RecordsKill();

    [Test]
    public void Handle_DamageDealtEvent_RecordsDamage();

    [Test]
    public void Handle_PlayerDeathEvent_IncrementsDeathCount();
}
```

**File:** `tests/RuneAndRust.Tests/Application/CombatRatingTests.cs`

```csharp
[TestFixture]
public class CombatRatingTests
{
    [Test]
    [TestCase(0, CombatRating.Novice)]
    [TestCase(20, CombatRating.Apprentice)]
    [TestCase(35, CombatRating.Journeyman)]
    [TestCase(50, CombatRating.Skilled)]
    [TestCase(65, CombatRating.Veteran)]
    [TestCase(80, CombatRating.Master)]
    [TestCase(95, CombatRating.Legend)]
    public void CalculateCombatRating_ReturnsCorrectRating(int score, CombatRating expected);
}
```

---

## 14. Use Cases

### UC-001: Record Monster Kill

**Actor:** System (CombatService)
**Flow:** Monster dies → MonsterKilledEvent published → StatisticsEventHandler receives → RecordMonsterKill called → MonstersKilled incremented → MonstersByType updated

### UC-002: Record Damage Dealt

**Actor:** System (CombatService)
**Flow:** Player attacks → DamageDealtEvent published → StatisticsEventHandler receives → RecordDamageDealt called → TotalDamageDealt incremented → CriticalHits incremented if critical

### UC-003: Record Room Discovery

**Actor:** System (ExplorationService)
**Flow:** Player enters new room → RoomDiscoveredEvent published → StatisticsEventHandler receives → RecordRoomDiscovered called → RoomsDiscovered incremented → SecretsFound incremented if secret

### UC-004: Record Playtime

**Actor:** System (GameSessionService)
**Flow:** Session ends → RecordPlaytime called → TotalPlaytime updated → LastPlayed updated

### UC-005: Get Combat Metrics

**Actor:** System (StatisticsView)
**Flow:** Stats command issued → GetMetrics called → Averages calculated → CombatRating determined → StatisticsMetrics returned

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `PlayerStatistics` entity created
- [ ] `StatisticCategory` enum created

### Application Layer
- [ ] `IStatisticsService` interface created
- [ ] `StatisticsService` implementation created
- [ ] `StatisticsEventHandler` implementation created
- [ ] `StatisticsMetrics` record created
- [ ] `CombatRating` enum created

### Infrastructure Layer
- [ ] Player entity updated with Statistics property

### Configuration Files
- [ ] `config/statistics.json` created
- [ ] `config/schemas/statistics.schema.json` created

### Testing
- [ ] ~12 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional
- [ ] PlayerStatistics tracks all combat statistics
- [ ] PlayerStatistics tracks all exploration statistics
- [ ] PlayerStatistics tracks all progression statistics
- [ ] PlayerStatistics tracks all time statistics
- [ ] IncrementStat updates correct statistic
- [ ] IncrementStat throws for unknown stat name
- [ ] RecordMonsterKill tracks total and by type
- [ ] Combat stats update on DamageDealtEvent
- [ ] Combat stats update on MonsterKilledEvent
- [ ] Exploration stats update on RoomDiscoveredEvent
- [ ] Progression stats update on ItemCraftedEvent
- [ ] Playtime accumulates correctly via RecordPlaytime
- [ ] Session count increments via StartNewSession
- [ ] Event handlers process all 10 event types
- [ ] GetCategoryStatistics groups statistics correctly
- [ ] GetMetrics calculates averages and rates correctly
- [ ] CombatRating calculates based on multiple factors

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~12 unit tests pass
- [ ] Configuration validates against schema
- [ ] XML documentation complete on all public members

---

## 17. Dependencies

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | Domain/Entities | Statistics owner |
| `IEventHandler<T>` | Application/Interfaces | Event handling |
| `EventBus` | Application/Services | Event routing |
| `IPlayerRepository` | Application/Interfaces | Player lookup |

### Provides to v0.12.0b

| Type | Usage |
|------|-------|
| `PlayerStatistics` | Extended with DiceRollHistory reference |
| `IStatisticsService` | Used by DiceHistoryService |
| `StatisticCategory` | Dice category used |

### Provides to v0.12.0c

| Type | Usage |
|------|-------|
| `PlayerStatistics` | Displayed in StatisticsView |
| `IStatisticsService` | Queried by StatisticsView |
| `StatisticsMetrics` | Displayed in metrics panels |
| `CombatRating` | Displayed in combat stats |

---

## 18. Future Considerations

### Deferred to v0.12.0b
- **Dice Roll History**: Roll tracking with streak detection (next phase)

### Deferred to v0.12.0c
- **Statistics View UI**: Rendering statistics to player
- **Statistics Persistence**: Save file integration

### Out of Scope
- **Leaderboards**: Comparing statistics across players (multiplayer feature)
- **Achievements**: Unlocking rewards based on statistics (v0.12.1)
- **Statistics Reset**: Ability to reset individual statistics

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
