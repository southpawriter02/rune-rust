# v0.18.4b Design Specification: Momentum System (Storm Blade)

**Version:** 0.18.4b
**Parent:** v0.18.4 (Specialization-Specific Resources)
**Prerequisites:** v0.17.4 (Specialization System), v0.18.0 (Psychic Stress System)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Model](#5-domain-model)
6. [Data Model](#6-data-model)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Deliverable Checklist](#9-deliverable-checklist)
10. [Acceptance Criteria](#10-acceptance-criteria)
11. [Dependencies](#11-dependencies)
12. [Future Considerations](#12-future-considerations)

---

## 1. Executive Summary

This design specification defines the **Momentum System** for the Storm Blade specialization — a flow-state resource that rewards sustained aggression but penalizes interruption through hit chains and decay mechanics.

v0.18.4b establishes the **Domain Layer Foundation** for Momentum by defining:

- `MomentumThreshold` enum — 5 tiers of escalating flow
- `MomentumSource` enum — 4 sources of momentum generation
- `MomentumState` entity — immutable snapshot of momentum status
- `MomentumGainResult` and `MomentumDecayResult` value objects — transaction records

### Key Deliverables

| Category              | Items                                            |
| --------------------- | ----------------------------------------------- |
| **Domain Enums**      | `MomentumThreshold`, `MomentumSource`           |
| **Domain Entities**   | `MomentumState`                                 |
| **Value Objects**     | `MomentumGainResult`, `MomentumDecayResult`     |
| **Tests**             | ~5 unit tests                                   |

### Momentum Threshold Overview

| Threshold   | Momentum | Bonus Attacks | Defense | Attack | Special Effects              |
| ----------- | -------- | ------------- | ------- | ------ | ---------------------------- |
| Stationary  | 0-20     | 0             | +0      | +0     | None                         |
| Moving      | 21-40    | 0             | +1      | +1     | Movement +1                  |
| Flowing     | 41-60    | 1             | +2      | +2     | Chain attacks enabled        |
| Surging     | 61-80    | 1             | +3      | +3     | Reduced recovery time        |
| Unstoppable | 81+      | 2             | +4      | +4     | +10% crit, Full heal on kill |

---

## 2. Feature Overview

```
v0.18.4b Features
└── Momentum System (Domain Layer)
    │
    ├── MomentumThreshold Enum
    │   ├── Stationary (0-20 momentum)
    │   ├── Moving (21-40 momentum)
    │   ├── Flowing (41-60 momentum)
    │   ├── Surging (61-80 momentum)
    │   └── Unstoppable (81-100 momentum)
    │
    ├── MomentumSource Enum
    │   ├── SuccessfulAttack - Basic momentum from hits
    │   ├── KillingBlow - Bonus momentum from kills
    │   ├── ChainAttack - Momentum from sequential attacks
    │   └── MovementAction - Momentum from repositioning
    │
    ├── MomentumState Entity
    │   ├── CharacterId: Guid
    │   ├── CurrentMomentum: int (0-100)
    │   ├── Threshold: MomentumThreshold (computed)
    │   ├── BonusAttacks: int (by threshold: 0/0/1/1/2)
    │   ├── MovementBonus: int (floor(Momentum/20))
    │   ├── DefenseBonus: int (by threshold)
    │   ├── AttackBonus: int (by threshold)
    │   ├── CriticalChance: int? (at Unstoppable: +10%)
    │   ├── ConsecutiveHits: int (tracking chain)
    │   ├── DecayOnMissedAttack: int (25 flat)
    │   ├── DecayOnStunned: int (full reset)
    │   └── LastActionTime: DateTime?
    │
    ├── MomentumGainResult Record
    │   ├── PreviousMomentum: int
    │   ├── NewMomentum: int
    │   ├── AmountGained: int
    │   ├── Source: MomentumSource
    │   ├── ChainBonus: int?
    │   ├── ThresholdChanged: bool
    │   └── NewThreshold: MomentumThreshold?
    │
    └── MomentumDecayResult Record
        ├── PreviousMomentum: int
        ├── NewMomentum: int
        ├── AmountDecayed: int
        ├── DecayReason: string
        ├── ChainBroken: bool
        ├── ThresholdChanged: bool
        └── NewThreshold: MomentumThreshold?
```

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                          ENUMS                                   │    │
│  ├──────────────────────────────────┬──────────────────────────────┤    │
│  │      MomentumThreshold           │       MomentumSource         │    │
│  ├──────────────────────────────────┼──────────────────────────────┤    │
│  │ Stationary = 0                   │ SuccessfulAttack = 0         │    │
│  │ Moving = 1                       │ KillingBlow = 1              │    │
│  │ Flowing = 2                      │ ChainAttack = 2              │    │
│  │ Surging = 3                      │ MovementAction = 3           │    │
│  │ Unstoppable = 4                  │                              │    │
│  └──────────────────────────────────┴──────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                  MomentumState (Entity)                          │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Properties:                                                     │    │
│  │  + CharacterId: Guid                                            │    │
│  │  + CurrentMomentum: int (0-100, from events)                   │    │
│  │  + Threshold: MomentumThreshold (computed)                     │    │
│  │  + BonusAttacks: int (by threshold: 0/0/1/1/2)                │    │
│  │  + MovementBonus: int (floor(Momentum / 20))                  │    │
│  │  + DefenseBonus: int (by threshold: 0/1/2/3/4)               │    │
│  │  + AttackBonus: int (by threshold: 0/1/2/3/4)                │    │
│  │  + CriticalChance: int? (+10% at Unstoppable)                │    │
│  │  + ConsecutiveHits: int (chain tracking)                      │    │
│  │  + LastActionTime: DateTime? (decay tracking)                 │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Constants:                                                      │    │
│  │  + MinMomentum = 0                                              │    │
│  │  + MaxMomentum = 100                                            │    │
│  │  + MovingThreshold = 20                                         │    │
│  │  + FlowingThreshold = 40                                        │    │
│  │  + SurgingThreshold = 60                                        │    │
│  │  + UnstoppableThreshold = 80                                    │    │
│  │  + DecayOnMiss = 25                                             │    │
│  │  + DecayOnStun = 100 (full reset)                              │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Factory:                                                        │    │
│  │  + Create(Guid characterId): MomentumState                     │    │
│  │  + DetermineThreshold(int momentum): MomentumThreshold        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │   MomentumGainResult & MomentumDecayResult (Records)            │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Records: Immutable snapshots of momentum transactions          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Momentum Threshold Determination Flowchart

```
                    ┌────────────────────────────┐
                    │ Current Momentum Value      │
                    └───────────┬────────────────┘
                                │
           ┌────────────────────┼────────────────────┐
           │                    │                    │
           ▼                    ▼                    ▼
    ┌─────────────┐     ┌─────────────┐      ┌─────────────┐
    │ momentum≤20 │     │  21 ≤ m ≤ 40│      │ 41 ≤ m ≤ 60│
    │             │     │             │      │             │
    │ = Stationary│     │   = Moving  │      │  = Flowing  │
    └─────────────┘     └─────────────┘      └─────────────┘
           │                    │                    │
           │                    │                    │
           │                    ▼                    │
           │            ┌─────────────┐              │
           │            │ 61 ≤ m ≤ 80 │              │
           │            │             │              │
           │            │   = Surging │◄─────────────┘
           │            │             │
           │            └─────────────┘
           │                    │
           │                    ▼
           │            ┌─────────────┐
           │            │  momentum≥81│
           │            │             │
           └───────────►│ = Unstoppable
                        │             │
                        └─────────────┘
```

### 3.3 Decay Mechanics Decision Tree

```
                ┌──────────────────────────────┐
                │   Momentum Decay Trigger     │
                └───────────┬──────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │Missed   │         │ Stunned │         │ No Atk  │
   │Attack   │         │/Frozen  │         │for Nturn│
   └────┬────┘         └────┬────┘         └────┬────┘
        │                   │                   │
        ▼                   ▼                   ▼
   Decay -25           Full Reset           Decay -15
   Chain Broken        (100%)               Per Turn
   Threshold Check     Threshold Check      (Stacking)
```

### 3.4 Chain Attack Bonus Calculation

```
Consecutive Hits Track:

Attack 1 Hit ──► ConsecutiveHits = 1 ──► ChainBonus = 0
                                              │
                                              ▼
Attack 2 Hit ──► ConsecutiveHits = 2 ──► ChainBonus = +5
                                              │
                                              ▼
Attack 3 Hit ──► ConsecutiveHits = 3 ──► ChainBonus = +10
                                              │
                                              ▼
Attack 4 Hit ──► ConsecutiveHits = 4 ──► ChainBonus = +15
                                              │
                                              ▼
   Miss/Stun ──► ConsecutiveHits = 0 ──► ChainBonus = 0
                 (Reset)
```

---

## 4. User Stories

### US-18.4b-1: Determine Momentum Threshold from Current Momentum

**As a** momentum system developer
**I want to** determine the momentum threshold from current momentum value
**So that** threshold-appropriate bonuses can be applied

**Acceptance Criteria:**
- Threshold correctly determined for all momentum ranges
- Boundary values handled correctly (20 → Stationary, 21 → Moving)
- Momentum clamped to 0-100 range
- Computed properties reflect correct threshold

### US-18.4b-2: Calculate Attack and Defense Bonuses from Momentum

**As a** combat system developer
**I want to** calculate attack and defense bonuses based on momentum
**So that** higher momentum grants combat advantages

**Acceptance Criteria:**
- Attack and defense bonuses scale 0-4 with threshold
- Movement bonus = floor(Momentum / 20)
- Bonus attacks scale 0/0/1/1/2 with threshold
- Critical chance +10% only at Unstoppable

### US-18.4b-3: Track Consecutive Hit Chain

**As a** a momentum system developer
**I want to** track consecutive successful attacks
**So that** chain bonuses can be calculated and chain-breaking can reset momentum

**Acceptance Criteria:**
- ConsecutiveHits incremented on successful attack
- ConsecutiveHits reset to 0 on miss
- ConsecutiveHits reset to 0 when stunned
- ChainBonus per hit = ConsecutiveHits * 5

### US-18.4b-4: Record Momentum Transactions with Decay Reasons

**As a** an event logging system
**I want to** record momentum gain and decay with decay reasons
**So that** I can audit momentum changes and trigger appropriate effects

**Acceptance Criteria:**
- MomentumGainResult captures source and chain bonus
- MomentumDecayResult captures decay reason and chain break status
- Threshold change flag set when crossing threshold
- Chain broken flag set on miss/stun decay

---

## 5. Domain Model

### 5.1 MomentumThreshold Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/MomentumThreshold.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the stages of Momentum for the Storm Blade specialization.
/// </summary>
/// <remarks>
/// <para>
/// Momentum is a flow-state resource that rewards sustained aggression
/// and punishes interruption. It requires maintaining attack chains to
/// stay high, but provides increasing bonuses with each threshold.
/// </para>
/// <para>
/// Threshold Ranges (based on Momentum 0-100):
/// <list type="bullet">
/// <item>Stationary: 0-20 momentum — No flow, no bonuses</item>
/// <item>Moving: 21-40 momentum — Building flow</item>
/// <item>Flowing: 41-60 momentum — Active chain attacks</item>
/// <item>Surging: 61-80 momentum — High momentum with reduced recovery</item>
/// <item>Unstoppable: 81-100 momentum — Ultimate flow state with crit bonus</item>
/// </list>
/// </para>
/// </remarks>
public enum MomentumThreshold
{
    /// <summary>
    /// Stationary state (0-20 momentum).
    /// </summary>
    /// <remarks>
    /// No flow state. No combat bonuses.
    /// </remarks>
    Stationary = 0,

    /// <summary>
    /// Moving state (21-40 momentum).
    /// </summary>
    /// <remarks>
    /// Building momentum. Small attack and defense bonuses.
    /// </remarks>
    Moving = 1,

    /// <summary>
    /// Flowing state (41-60 momentum).
    /// </summary>
    /// <remarks>
    /// Active flow state. Enables chain attacks with 1 bonus attack.
    /// </remarks>
    Flowing = 2,

    /// <summary>
    /// Surging state (61-80 momentum).
    /// </summary>
    /// <remarks>
    /// High momentum. Bonus attack and strong bonuses to offense/defense.
    /// </remarks>
    Surging = 3,

    /// <summary>
    /// Unstoppable state (81-100 momentum).
    /// </summary>
    /// <remarks>
    /// Maximum flow state. 2 bonus attacks, +10% crit, full heal on kill.
    /// </remarks>
    Unstoppable = 4
}
```

### 5.2 MomentumSource Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/MomentumSource.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the sources of Momentum generation.
/// </summary>
/// <remarks>
/// Each source determines how momentum is gained and may have
/// different multipliers or flat values.
/// </remarks>
public enum MomentumSource
{
    /// <summary>
    /// Momentum from a successful attack hit.
    /// </summary>
    /// <remarks>
    /// Flat: 10 momentum per successful attack.
    /// Core mechanic for momentum generation.
    /// </remarks>
    SuccessfulAttack = 0,

    /// <summary>
    /// Bonus momentum from defeating an enemy.
    /// </summary>
    /// <remarks>
    /// Flat: 20 momentum per kill.
    /// Significantly faster momentum generation.
    /// </remarks>
    KillingBlow = 1,

    /// <summary>
    /// Momentum from consecutive successful attacks.
    /// </summary>
    /// <remarks>
    /// Formula: floor(ConsecutiveHits * 5)
    /// Encourages attack chains.
    /// </remarks>
    ChainAttack = 2,

    /// <summary>
    /// Momentum from movement/repositioning actions.
    /// </summary>
    /// <remarks>
    /// Formula: floor(DistanceMoved / 2)
    /// Encourages mobile combat style.
    /// </remarks>
    MovementAction = 3
}
```

### 5.3 MomentumState Entity

**File:** `src/Core/RuneAndRust.Domain/Entities/MomentumState.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the momentum state of a Storm Blade character.
/// </summary>
/// <remarks>
/// <para>
/// MomentumState is the core domain entity for the Momentum system.
/// It represents a flow-state resource earned through successful attacks
/// and lost through misses, stuns, or lack of action.
/// </para>
/// <para>
/// Key Properties:
/// - CurrentMomentum: 0-100 integer
/// - Threshold: Computed from CurrentMomentum
/// - BonusAttacks: 0/0/1/1/2 depending on threshold
/// - AttackBonus & DefenseBonus: 0-4 by threshold
/// - MovementBonus: floor(CurrentMomentum / 20)
/// - ConsecutiveHits: Tracks chain for bonus calculation
/// - CriticalChance: +10% only at Unstoppable
/// </para>
/// </remarks>
public class MomentumState
{
    #region Constants

    /// <summary>Minimum momentum value.</summary>
    public const int MinMomentum = 0;

    /// <summary>Maximum momentum value.</summary>
    public const int MaxMomentum = 100;

    /// <summary>Momentum threshold for Moving state.</summary>
    public const int MovingThreshold = 20;

    /// <summary>Momentum threshold for Flowing state.</summary>
    public const int FlowingThreshold = 40;

    /// <summary>Momentum threshold for Surging state.</summary>
    public const int SurgingThreshold = 60;

    /// <summary>Momentum threshold for Unstoppable state.</summary>
    public const int UnstoppableThreshold = 80;

    /// <summary>Momentum decay on missed attack.</summary>
    public const int DecayOnMiss = 25;

    /// <summary>Momentum decay on stun (full reset).</summary>
    public const int DecayOnStun = 100;

    /// <summary>Momentum decay on idle turn.</summary>
    public const int DecayOnIdleTurn = 15;

    /// <summary>Momentum gain from successful attack.</summary>
    public const int GainPerSuccessfulAttack = 10;

    /// <summary>Momentum gain from killing blow.</summary>
    public const int GainPerKill = 20;

    /// <summary>Chain bonus per consecutive hit (multiplier * ConsecutiveHits).</summary>
    public const int ChainBonusPerHit = 5;

    #endregion

    #region Properties

    /// <summary>
    /// Gets the character ID this momentum state belongs to.
    /// </summary>
    public Guid CharacterId { get; private init; }

    /// <summary>
    /// Gets the current momentum level (0-100).
    /// </summary>
    public int CurrentMomentum { get; private init; }

    /// <summary>
    /// Gets the current momentum threshold.
    /// </summary>
    public MomentumThreshold Threshold { get; private init; }

    /// <summary>
    /// Gets the number of bonus attacks from momentum.
    /// </summary>
    /// <remarks>
    /// Ranges: Stationary/Moving (0), Flowing/Surging (1), Unstoppable (2)
    /// </remarks>
    public int BonusAttacks { get; private init; }

    /// <summary>
    /// Gets the movement bonus from momentum.
    /// </summary>
    /// <remarks>
    /// Calculated as floor(CurrentMomentum / 20).
    /// Ranges from 0 to 5 extra squares of movement.
    /// </remarks>
    public int MovementBonus { get; private init; }

    /// <summary>
    /// Gets the defense bonus from momentum.
    /// </summary>
    /// <remarks>
    /// Scales with threshold: 0/1/2/3/4
    /// </remarks>
    public int DefenseBonus { get; private init; }

    /// <summary>
    /// Gets the attack bonus from momentum.
    /// </summary>
    /// <remarks>
    /// Scales with threshold: 0/1/2/3/4
    /// </remarks>
    public int AttackBonus { get; private init; }

    /// <summary>
    /// Gets the critical hit chance bonus.
    /// </summary>
    /// <remarks>
    /// +10% (1000 basis points) only at Unstoppable threshold.
    /// Null otherwise.
    /// </remarks>
    public int? CriticalChance { get; private init; }

    /// <summary>
    /// Gets the count of consecutive successful attacks.
    /// </summary>
    /// <remarks>
    /// Resets to 0 on miss, stun, or end of turn with no attack.
    /// Used to calculate chain bonuses.
    /// </remarks>
    public int ConsecutiveHits { get; private init; }

    /// <summary>
    /// Gets the time of last action (attack or movement).
    /// </summary>
    /// <remarks>
    /// Used to determine idle decay eligibility.
    /// </remarks>
    public DateTime? LastActionTime { get; private init; }

    #endregion

    #region Constructors

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private MomentumState() { }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new MomentumState for a character.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="initialMomentum">Initial momentum value (default 0).</param>
    /// <returns>A new MomentumState instance.</returns>
    public static MomentumState Create(Guid characterId, int initialMomentum = 0)
    {
        var clampedMomentum = Math.Clamp(initialMomentum, MinMomentum, MaxMomentum);
        var threshold = DetermineThreshold(clampedMomentum);

        return new MomentumState
        {
            CharacterId = characterId,
            CurrentMomentum = clampedMomentum,
            Threshold = threshold,
            BonusAttacks = CalculateBonusAttacks(threshold),
            MovementBonus = CalculateMovementBonus(clampedMomentum),
            DefenseBonus = CalculateDefenseBonus(threshold),
            AttackBonus = CalculateAttackBonus(threshold),
            CriticalChance = threshold == MomentumThreshold.Unstoppable ? 10 : null,
            ConsecutiveHits = 0,
            LastActionTime = null
        };
    }

    /// <summary>
    /// Determines the momentum threshold for a given momentum value.
    /// </summary>
    /// <param name="momentum">The momentum value (0-100).</param>
    /// <returns>The corresponding MomentumThreshold.</returns>
    public static MomentumThreshold DetermineThreshold(int momentum) =>
        momentum switch
        {
            > UnstoppableThreshold => MomentumThreshold.Unstoppable,
            > SurgingThreshold => MomentumThreshold.Surging,
            > FlowingThreshold => MomentumThreshold.Flowing,
            > MovingThreshold => MomentumThreshold.Moving,
            _ => MomentumThreshold.Stationary
        };

    #endregion

    #region Private Calculation Methods

    /// <summary>
    /// Calculates bonus attacks from threshold.
    /// </summary>
    private static int CalculateBonusAttacks(MomentumThreshold threshold) =>
        threshold switch
        {
            MomentumThreshold.Stationary => 0,
            MomentumThreshold.Moving => 0,
            MomentumThreshold.Flowing => 1,
            MomentumThreshold.Surging => 1,
            MomentumThreshold.Unstoppable => 2,
            _ => 0
        };

    /// <summary>
    /// Calculates movement bonus from momentum.
    /// </summary>
    private static int CalculateMovementBonus(int momentum) =>
        momentum / 20;

    /// <summary>
    /// Calculates defense bonus from threshold.
    /// </summary>
    private static int CalculateDefenseBonus(MomentumThreshold threshold) =>
        threshold switch
        {
            MomentumThreshold.Stationary => 0,
            MomentumThreshold.Moving => 1,
            MomentumThreshold.Flowing => 2,
            MomentumThreshold.Surging => 3,
            MomentumThreshold.Unstoppable => 4,
            _ => 0
        };

    /// <summary>
    /// Calculates attack bonus from threshold.
    /// </summary>
    private static int CalculateAttackBonus(MomentumThreshold threshold) =>
        threshold switch
        {
            MomentumThreshold.Stationary => 0,
            MomentumThreshold.Moving => 1,
            MomentumThreshold.Flowing => 2,
            MomentumThreshold.Surging => 3,
            MomentumThreshold.Unstoppable => 4,
            _ => 0
        };

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"Momentum[{Threshold}]: {CurrentMomentum}/100 " +
        $"(ATK +{AttackBonus}, DEF +{DefenseBonus}, Extra Atks {BonusAttacks})" +
        (CriticalChance.HasValue ? $" [+{CriticalChance}% CRIT]" : "") +
        (ConsecutiveHits > 0 ? $" [Chain x{ConsecutiveHits}]" : "");

    #endregion
}
```

### 5.4 MomentumGainResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/MomentumGainResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a momentum gain operation.
/// </summary>
/// <param name="PreviousMomentum">Momentum value before gain.</param>
/// <param name="NewMomentum">Momentum value after gain.</param>
/// <param name="AmountGained">Amount of momentum gained.</param>
/// <param name="Source">Source of momentum generation.</param>
/// <param name="ChainBonus">Bonus from consecutive hits, if any.</param>
/// <param name="ThresholdChanged">Whether threshold changed.</param>
/// <param name="NewThreshold">New threshold if changed.</param>
public record MomentumGainResult(
    int PreviousMomentum,
    int NewMomentum,
    int AmountGained,
    MomentumSource Source,
    int? ChainBonus,
    bool ThresholdChanged,
    MomentumThreshold? NewThreshold)
{
    /// <summary>
    /// Gets whether momentum reached maximum (100).
    /// </summary>
    public bool CappedAtMaximum => NewMomentum == 100;

    /// <summary>
    /// Gets whether this gain triggered Unstoppable threshold.
    /// </summary>
    public bool IsUnstoppableGain =>
        ThresholdChanged && NewThreshold == MomentumThreshold.Unstoppable;

    /// <summary>
    /// Creates a display string for this momentum gain.
    /// </summary>
    public string ToDisplayString()
    {
        var result = $"Momentum +{AmountGained} from {Source} ({PreviousMomentum} → {NewMomentum})";
        if (ChainBonus.HasValue)
            result += $" [+{ChainBonus} chain]";
        if (ThresholdChanged)
            result += $" [Threshold: {NewThreshold}]";
        return result;
    }
}
```

### 5.5 MomentumDecayResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/MomentumDecayResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a momentum decay operation.
/// </summary>
/// <param name="PreviousMomentum">Momentum value before decay.</param>
/// <param name="NewMomentum">Momentum value after decay.</param>
/// <param name="AmountDecayed">Amount of momentum decayed.</param>
/// <param name="DecayReason">Reason for decay (e.g., "Missed Attack", "Stunned").</param>
/// <param name="ChainBroken">Whether the consecutive hit chain was broken.</param>
/// <param name="ThresholdChanged">Whether threshold changed.</param>
/// <param name="NewThreshold">New threshold if changed.</param>
public record MomentumDecayResult(
    int PreviousMomentum,
    int NewMomentum,
    int AmountDecayed,
    string DecayReason,
    bool ChainBroken,
    bool ThresholdChanged,
    MomentumThreshold? NewThreshold)
{
    /// <summary>
    /// Gets whether momentum fell to zero.
    /// </summary>
    public bool ZeroedOut => NewMomentum == 0;

    /// <summary>
    /// Gets whether this is a full reset (decay reason: Stunned/Frozen).
    /// </summary>
    public bool IsFullReset => AmountDecayed == 100;

    /// <summary>
    /// Creates a display string for this momentum decay.
    /// </summary>
    public string ToDisplayString()
    {
        var result = $"Momentum -{AmountDecayed} ({DecayReason}) ({PreviousMomentum} → {NewMomentum})";
        if (ChainBroken)
            result += " [Chain Broken!]";
        if (ThresholdChanged)
            result += $" [Threshold: {NewThreshold}]";
        return result;
    }
}
```

---

## 6. Data Model

### 6.1 Momentum Entity Relationships

```csharp
// Add to Character entity:

/// <summary>
/// Gets the character's momentum state.
/// </summary>
public MomentumState? MomentumState { get; private set; }
```

### 6.2 Database Schema (for v0.18.4f)

```sql
CREATE TABLE IF NOT EXISTS character_momentum (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_momentum INT NOT NULL DEFAULT 0
        CONSTRAINT chk_momentum_range CHECK (current_momentum >= 0 AND current_momentum <= 100),
    consecutive_hits INT NOT NULL DEFAULT 0,
    last_action_time TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_character_momentum_action_time
    ON character_momentum(character_id, last_action_time);
```

---

## 7. Logging Specifications

### 7.1 Domain Layer Logging

> **Note:** Enums and value objects do not log directly.
> All logging occurs in Application Layer services (v0.18.4e).

### 7.2 Expected Log Events (Future Implementation in v0.18.4e)

| Event                      | Level       | Template                                                          |
| -------------------------- | ----------- | ----------------------------------------------------------------- |
| Momentum Threshold Changed | Information | `"Momentum threshold changed: {CharacterId} {Old} → {New}"`       |
| Momentum Capped            | Debug       | `"Momentum capped at 100 for {CharacterId}: {Source}"`            |
| Chain Broken               | Debug       | `"Momentum chain broken: {CharacterId} {Reason}"`                 |
| Unstoppable Reached        | Warning     | `"UNSTOPPABLE: {CharacterId} reached Unstoppable threshold"`      |

---

## 8. Unit Testing Requirements

### 8.1 Test File Location

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/MomentumStateTests.cs`

### 8.2 Required Tests

| Test Name                                                | Description                                                        |
| -------------------------------------------------------- | ------------------------------------------------------------------ |
| `Create_WithZeroMomentum_ReturnsStationaryThreshold`     | Verify Stationary threshold at 0 momentum                          |
| `Create_AtBoundaryValues_ReturnsCorrectThresholds`       | Verify all threshold boundaries (20→Moving, 40→Flowing, etc.)      |
| `Create_WithMaxMomentum_ReturnsUnstoppableState`         | Verify Unstoppable and bonuses at 100 momentum                     |
| `BonusAttacks_ScalesCorrectly_WithThreshold`             | Verify bonus attacks 0/0/1/1/2 with thresholds                    |
| `MovementBonus_CalculatedCorrectly_ForAllRanges`         | Verify movement bonus = floor(momentum / 20)                      |

### 8.3 Example Tests

```csharp
[TestFixture]
public class MomentumStateTests
{
    [Test]
    public void Create_WithZeroMomentum_ReturnsStationaryThreshold()
    {
        // Arrange & Act
        var momentumState = MomentumState.Create(Guid.NewGuid(), initialMomentum: 0);

        // Assert
        momentumState.Threshold.Should().Be(MomentumThreshold.Stationary);
        momentumState.CurrentMomentum.Should().Be(0);
        momentumState.BonusAttacks.Should().Be(0);
        momentumState.AttackBonus.Should().Be(0);
        momentumState.DefenseBonus.Should().Be(0);
        momentumState.CriticalChance.Should().BeNull();
    }

    [TestCase(0, MomentumThreshold.Stationary)]
    [TestCase(20, MomentumThreshold.Stationary)]
    [TestCase(21, MomentumThreshold.Moving)]
    [TestCase(40, MomentumThreshold.Moving)]
    [TestCase(41, MomentumThreshold.Flowing)]
    [TestCase(60, MomentumThreshold.Flowing)]
    [TestCase(61, MomentumThreshold.Surging)]
    [TestCase(80, MomentumThreshold.Surging)]
    [TestCase(81, MomentumThreshold.Unstoppable)]
    [TestCase(100, MomentumThreshold.Unstoppable)]
    public void Create_AtBoundaryValues_ReturnsCorrectThresholds(int momentum, MomentumThreshold expected)
    {
        // Arrange & Act
        var momentumState = MomentumState.Create(Guid.NewGuid(), initialMomentum: momentum);

        // Assert
        momentumState.Threshold.Should().Be(expected);
    }

    [TestCase(MomentumThreshold.Stationary, 0)]
    [TestCase(MomentumThreshold.Moving, 0)]
    [TestCase(MomentumThreshold.Flowing, 1)]
    [TestCase(MomentumThreshold.Surging, 1)]
    [TestCase(MomentumThreshold.Unstoppable, 2)]
    public void BonusAttacks_ScalesCorrectly_WithThreshold(MomentumThreshold threshold, int expectedAttacks)
    {
        // Arrange
        var momentum = threshold switch
        {
            MomentumThreshold.Stationary => 10,
            MomentumThreshold.Moving => 30,
            MomentumThreshold.Flowing => 50,
            MomentumThreshold.Surging => 70,
            MomentumThreshold.Unstoppable => 90,
            _ => 0
        };

        // Act
        var momentumState = MomentumState.Create(Guid.NewGuid(), initialMomentum: momentum);

        // Assert
        momentumState.BonusAttacks.Should().Be(expectedAttacks);
    }

    [TestCase(0, 0)]
    [TestCase(10, 0)]
    [TestCase(20, 1)]
    [TestCase(40, 2)]
    [TestCase(80, 4)]
    [TestCase(100, 5)]
    public void MovementBonus_CalculatedCorrectly_ForAllRanges(int momentum, int expectedBonus)
    {
        // Arrange & Act
        var momentumState = MomentumState.Create(Guid.NewGuid(), initialMomentum: momentum);

        // Assert
        momentumState.MovementBonus.Should().Be(expectedBonus);
    }
}
```

---

## 9. Deliverable Checklist

### 9.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/Enums/MomentumThreshold.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/MomentumSource.cs`
- [ ] `src/Core/RuneAndRust.Domain/Entities/MomentumState.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/MomentumGainResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/MomentumDecayResult.cs`

### 9.2 Tests

- [ ] `tests/RuneAndRust.Domain.UnitTests/Entities/MomentumStateTests.cs`

### 9.3 Documentation

- [ ] Create `docs/design/v0.18.x/v0.18.4b-design-specification.md`
- [ ] Update `docs/design/v0.18.x/v0.18.4-scope-breakdown.md` (mark v0.18.4b complete)

---

## 10. Acceptance Criteria

### 10.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 10.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 10.3 Functional Verification

- [ ] `MomentumThreshold` enum contains all 5 thresholds
- [ ] `MomentumSource` enum contains all 4 sources
- [ ] `MomentumState.Create()` correctly determines threshold from momentum
- [ ] `MomentumState.DetermineThreshold()` handles all boundary values
- [ ] Bonus attacks correctly scale 0/0/1/1/2 with threshold
- [ ] Movement bonus correctly calculated as floor(momentum / 20)
- [ ] Attack and defense bonuses correctly scale 0-4 with threshold
- [ ] Critical chance is +10% only at Unstoppable
- [ ] ConsecutiveHits initialized to 0
- [ ] `MomentumGainResult` and `MomentumDecayResult` records serialize correctly
- [ ] Chain bonus formula works (ConsecutiveHits * 5)

---

## 11. Dependencies

### 11.1 Required Prerequisites

| Dependency           | Version | Status   | Notes                              |
| -------------------- | ------- | -------- | ---------------------------------- |
| Specialization Sys   | v0.17.4 | Required | For Storm Blade specialization     |
| Psychic Stress Sys   | v0.18.0 | Required | For potential stress interactions |
| Character Domain     | v0.6.x+ | Required | MomentumState belongs to Character |

### 11.2 Deferred to Later Phases

| Item                             | Deferred To | Reason                      |
| -------------------------------- | ----------- | --------------------------- |
| `IMomentumService` interface     | v0.18.4d    | Service contract separately |
| `MomentumService` implementation | v0.18.4e    | Service logic separately    |
| Configuration loading            | v0.18.4f    | Centralized in config phase |
| Database persistence             | v0.18.4f    | Persistence layer separate  |

---

## 12. Future Considerations

### 12.1 v0.18.4c (Coherence System)

- Similar structure for Arcanist specialization
- Different mechanics focused on spell power and stability

### 12.2 v0.18.4d-e (Services)

- Service interfaces and implementations
- Cross-system interactions (attack resolution, decay timing, etc.)

### 12.3 v0.18.4f (Configuration & Persistence)

- JSON configuration for all three resource systems
- Database persistence layer with migration

---

## Changelog

| Version | Date       | Changes                  |
| ------- | ---------- | ------------------------ |
| 1.0     | 2026-01-28 | Initial design complete  |
