# v0.17.0e Design Specification: LineageProvider Service

**Version:** 0.17.0e  
**Phase Name:** LineageProvider Service  
**Parent Version:** v0.17.0 (Lineage System)  
**Prerequisites:** v0.17.0d Complete (Trauma Economy Baseline)  
**Estimated Tests:** ~6 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ILineageProvider Interface](#4-ilineageprovider-interface)
5. [LineageProvider Implementation](#5-lineageprovider-implementation)
6. [Configuration Loading](#6-configuration-loading)
7. [Data Model Changes](#7-data-model-changes)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the LineageProvider service that provides access to all lineage data. The provider loads lineage definitions from configuration, caches them for efficient access, validates configuration on startup, and exposes typed methods for retrieving lineage data.

The LineageProvider serves as the central access point for lineage information throughout the application:

- **Configuration Loading**: Reads `lineages.json` and deserializes to `LineageDefinition` entities
- **Caching**: Maintains an in-memory dictionary keyed by `Lineage` enum for fast lookups
- **Validation**: Ensures all 4 lineages are defined and configuration is valid
- **Typed Access**: Provides strongly-typed methods for each lineage component

### 1.2 Key Deliverables

| Category       | Items                                     |
| -------------- | ----------------------------------------- |
| **Interfaces** | `ILineageProvider`                        |
| **Services**   | `LineageProvider`                         |
| **DTOs**       | `LineageConfigurationDto`, component DTOs |
| **Tests**      | ~6 unit tests                             |

### 1.3 Architectural Significance

This version establishes the **Provider Pattern** for lineage data:

- **Interface Abstraction**: `ILineageProvider` enables testing and alternative implementations
- **Lazy Initialization**: Configuration loaded on first access or startup
- **Immutable Cache**: Lineage definitions are immutable after loading
- **Component Access**: Direct access to individual components (attributes, bonuses, traits, etc.)
- **Dependency Injection**: Provider registered in DI container for application-wide access

---

## 2. Feature Overview

```
v0.17.0e LineageProvider Service
├── ILineageProvider Interface
│   ├── GetAllLineages(): IReadOnlyList<LineageDefinition>
│   ├── GetLineage(Lineage): LineageDefinition?
│   ├── GetAttributeModifiers(Lineage): LineageAttributeModifiers
│   ├── GetPassiveBonuses(Lineage): LineagePassiveBonuses
│   ├── GetUniqueTrait(Lineage): LineageTrait
│   └── GetTraumaBaseline(Lineage): LineageTraumaBaseline
├── LineageProvider Implementation
│   ├── Configuration loading from lineages.json
│   ├── In-memory caching by Lineage enum
│   ├── Startup validation
│   └── Logging infrastructure
└── Configuration DTOs
    ├── LineageConfigurationDto (root)
    ├── LineageDefinitionDto
    ├── AttributeModifiersDto
    ├── PassiveBonusesDto
    ├── UniqueTraitDto
    └── TraumaBaselineDto
```

### 2.1 Scope Alignment

**In Scope:**

- `ILineageProvider` interface with 6 methods
- `LineageProvider` implementation with caching
- Configuration DTOs for JSON deserialization
- Startup validation ensuring all lineages defined
- Error handling for missing/invalid configuration
- Logging for configuration loading and access

**Out of Scope:**

- LineageApplicationService → v0.17.0f
- Character creation integration → v0.17.5
- Runtime configuration reload → Future enhancement
- Database persistence → Future enhancement

---

## 3. Architecture Diagrams

### 3.1 LineageProvider System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  LINEAGEPROVIDER SYSTEM OVERVIEW                     │
└─────────────────────────────────────────────────────────────────────┘

    config/lineages.json
           │
           │  Read on startup/first access
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Configuration Loading                           │
├─────────────────────────────────────────────────────────────────────┤
│  1. Read JSON file                                                   │
│  2. Deserialize to LineageConfigurationDto                          │
│  3. Validate all 4 lineages present                                  │
│  4. Convert DTOs to domain entities                                  │
│  5. Cache by Lineage enum key                                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Cached in memory
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LineageProvider Cache                             │
├─────────────────────────────────────────────────────────────────────┤
│  Dictionary<Lineage, LineageDefinition>                              │
│  ├── [ClanBorn] → LineageDefinition { ... }                         │
│  ├── [RuneMarked] → LineageDefinition { ... }                       │
│  ├── [IronBlooded] → LineageDefinition { ... }                      │
│  └── [VargrKin] → LineageDefinition { ... }                         │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Accessed via interface
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     ILineageProvider                                 │
├─────────────────────────────────────────────────────────────────────┤
│  + GetAllLineages(): IReadOnlyList<LineageDefinition>               │
│  + GetLineage(Lineage): LineageDefinition?                          │
│  + GetAttributeModifiers(Lineage): LineageAttributeModifiers        │
│  + GetPassiveBonuses(Lineage): LineagePassiveBonuses                │
│  + GetUniqueTrait(Lineage): LineageTrait                            │
│  + GetTraumaBaseline(Lineage): LineageTraumaBaseline                │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Injects ILineageProvider to display lineage options             │
│                                                                      │
│  CharacterSheetView                                                   │
│  └── Uses ILineageProvider to get lineage details                    │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │               ILineageProvider (Interface)                    │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetAllLineages(): IReadOnlyList<LineageDefinition>         │  │
│  │  + GetLineage(Lineage): LineageDefinition?                    │  │
│  │  + GetAttributeModifiers(Lineage): LineageAttributeModifiers  │  │
│  │  + GetPassiveBonuses(Lineage): LineagePassiveBonuses          │  │
│  │  + GetUniqueTrait(Lineage): LineageTrait                      │  │
│  │  + GetTraumaBaseline(Lineage): LineageTraumaBaseline          │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                          ▲                                           │
│                          │ implements                                │
│  ┌───────────────────────┴───────────────────────────────────────┐  │
│  │               LineageProvider (Implementation)                │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  - _cache: Dictionary<Lineage, LineageDefinition>             │  │
│  │  - _logger: ILogger<LineageProvider>                          │  │
│  │  - _configPath: string                                        │  │
│  │  - _isInitialized: bool                                       │  │
│  │  + EnsureInitialized(): void                                  │  │
│  │  + ValidateConfiguration(): void                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ILineageApplicationService (v0.17.0f)                               │
│  └── Uses ILineageProvider internally                                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  LineageDefinition (Entity) ─────────────────────────────────────┐  │
│  ├── AttributeModifiers: LineageAttributeModifiers               │  │
│  ├── PassiveBonuses: LineagePassiveBonuses                       │  │
│  ├── UniqueTrait: LineageTrait                                   │  │
│  └── TraumaBaseline: LineageTraumaBaseline                       │  │
│                                                                      │
│  Lineage (Enum): ClanBorn, RuneMarked, IronBlooded, VargrKin        │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Configuration Loading Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                   CONFIGURATION LOADING FLOW                         │
└─────────────────────────────────────────────────────────────────────┘

    Application Startup / First Access
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CHECK INITIALIZATION                              │
├─────────────────────────────────────────────────────────────────────┤
│  if (!_isInitialized)                                                │
│  {                                                                   │
│      EnsureInitialized();                                            │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    READ CONFIGURATION FILE                           │
├─────────────────────────────────────────────────────────────────────┤
│  Path: config/lineages.json                                          │
│                                                                      │
│  try                                                                 │
│  {                                                                   │
│      var json = File.ReadAllText(_configPath);                       │
│      var config = JsonSerializer.Deserialize<LineageConfigDto>(json);│
│  }                                                                   │
│  catch (FileNotFoundException)                                       │
│  {                                                                   │
│      _logger.LogError("Configuration file not found: {Path}");      │
│      throw new LineageConfigurationException(...);                   │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    VALIDATE CONFIGURATION                            │
├─────────────────────────────────────────────────────────────────────┤
│  - Ensure exactly 4 lineages defined                                 │
│  - Validate each lineage has required properties                     │
│  - Check for duplicate lineage IDs                                   │
│  - Validate enum values are parseable                                │
│                                                                      │
│  if (config.Lineages.Count != 4)                                     │
│  {                                                                   │
│      _logger.LogError("Expected 4 lineages, found {Count}");        │
│      throw new LineageConfigurationException(...);                   │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CONVERT TO DOMAIN ENTITIES                        │
├─────────────────────────────────────────────────────────────────────┤
│  foreach (var dto in config.Lineages)                                │
│  {                                                                   │
│      var lineageId = Enum.Parse<Lineage>(dto.LineageId);            │
│      var definition = MapToLineageDefinition(dto);                   │
│      _cache[lineageId] = definition;                                 │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MARK INITIALIZED                                  │
├─────────────────────────────────────────────────────────────────────┤
│  _isInitialized = true;                                              │
│  _logger.LogInformation(                                             │
│      "Loaded {Count} lineage definitions",                           │
│      _cache.Count);                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Lineage Lookup Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      LINEAGE LOOKUP FLOW                             │
└─────────────────────────────────────────────────────────────────────┘

    Consumer requests lineage data
    e.g., GetLineage(Lineage.RuneMarked)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    ENSURE INITIALIZED                                │
├─────────────────────────────────────────────────────────────────────┤
│  EnsureInitialized();  // Thread-safe, loads if needed              │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────┐
    │ Check cache for key  │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       Found      Not Found
        │              │
        ▼              ▼
┌───────────────┐  ┌───────────────────────────────────────────────┐
│ Return cached │  │ Log warning and return null                    │
│ LineageDef    │  │ _logger.LogWarning(                            │
│               │  │     "Lineage {Lineage} not found in cache");  │
│               │  │ return null;                                   │
└───────────────┘  └───────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LOG ACCESS                                        │
├─────────────────────────────────────────────────────────────────────┤
│  _logger.LogDebug(                                                   │
│      "Retrieved lineage definition. Lineage={Lineage}",             │
│      lineage);                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 Component Access Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                   COMPONENT ACCESS DECISION TREE                     │
└─────────────────────────────────────────────────────────────────────┘

    Consumer needs lineage data
           │
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │              What data does consumer need?                    │
    └──────────────────────────┬───────────────────────────────────┘
               ┌───────────────┼───────────────┬───────────────┐
               ▼               ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Full         │ │ Just         │ │ Just         │ │ All lineages │
    │ Definition   │ │ Attributes   │ │ Trait        │ │ for display  │
    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
           │                │                │                │
           ▼                ▼                ▼                ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ GetLineage   │ │GetAttribute- │ │GetUniqueTrait│ │GetAllLineages│
    │ (Lineage)    │ │ Modifiers()  │ │ (Lineage)    │ │ ()           │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
           │                │                │                │
           ▼                ▼                ▼                ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Returns:     │ │ Returns:     │ │ Returns:     │ │ Returns:     │
    │ LineageDef?  │ │ AttributeMods│ │ LineageTrait │ │ IReadOnlyList│
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

### 3.6 DTO to Entity Mapping Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DTO TO ENTITY MAPPING FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    LineageDefinitionDto (from JSON)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    PARSE LINEAGE ENUM                                │
├─────────────────────────────────────────────────────────────────────┤
│  var lineageId = Enum.Parse<Lineage>(dto.LineageId);                │
│  // "RuneMarked" → Lineage.RuneMarked                               │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MAP ATTRIBUTE MODIFIERS                           │
├─────────────────────────────────────────────────────────────────────┤
│  var mods = new LineageAttributeModifiers(                           │
│      dto.AttributeModifiers.MightModifier,                          │
│      dto.AttributeModifiers.FinesseModifier,                        │
│      dto.AttributeModifiers.WitsModifier,                           │
│      dto.AttributeModifiers.WillModifier,                           │
│      dto.AttributeModifiers.SturdinessModifier,                     │
│      dto.AttributeModifiers.HasFlexibleBonus,                       │
│      dto.AttributeModifiers.FlexibleBonusAmount);                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MAP PASSIVE BONUSES                               │
├─────────────────────────────────────────────────────────────────────┤
│  var skillBonuses = dto.PassiveBonuses.SkillBonuses                 │
│      .Select(sb => SkillBonus.Create(sb.SkillId, sb.BonusAmount))   │
│      .ToList();                                                      │
│                                                                      │
│  var bonuses = LineagePassiveBonuses.Create(                         │
│      dto.PassiveBonuses.MaxHpBonus,                                 │
│      dto.PassiveBonuses.MaxApBonus,                                 │
│      dto.PassiveBonuses.SoakBonus,                                  │
│      dto.PassiveBonuses.MovementBonus,                              │
│      skillBonuses);                                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MAP UNIQUE TRAIT                                  │
├─────────────────────────────────────────────────────────────────────┤
│  var effectType = Enum.Parse<LineageTraitEffectType>(               │
│      dto.UniqueTrait.EffectType);                                   │
│                                                                      │
│  var trait = LineageTrait.Create(                                    │
│      dto.UniqueTrait.TraitId,                                       │
│      dto.UniqueTrait.TraitName,                                     │
│      dto.UniqueTrait.Description,                                   │
│      effectType,                                                     │
│      dto.UniqueTrait.TriggerCondition,                              │
│      dto.UniqueTrait.BonusDice,                                     │
│      dto.UniqueTrait.PercentModifier,                               │
│      dto.UniqueTrait.TargetCheck,                                   │
│      dto.UniqueTrait.TargetCondition);                              │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MAP TRAUMA BASELINE                               │
├─────────────────────────────────────────────────────────────────────┤
│  var baseline = LineageTraumaBaseline.Create(                        │
│      dto.TraumaBaseline.StartingCorruption,                         │
│      dto.TraumaBaseline.StartingStress,                             │
│      dto.TraumaBaseline.CorruptionResistanceModifier,               │
│      dto.TraumaBaseline.StressResistanceModifier);                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CREATE LINEAGE DEFINITION                         │
├─────────────────────────────────────────────────────────────────────┤
│  return LineageDefinition.Create(                                    │
│      lineageId,                                                      │
│      dto.DisplayName,                                                │
│      dto.Description,                                                │
│      dto.SelectionText,                                              │
│      mods,                                                           │
│      bonuses,                                                        │
│      trait,                                                          │
│      baseline,                                                       │
│      dto.AppearanceNotes,                                            │
│      dto.SocialRole);                                                │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ILineageProvider Interface

### 4.1 Purpose

The `ILineageProvider` interface defines the contract for accessing lineage data throughout the application. It provides methods for retrieving complete lineage definitions as well as individual components.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/ILineageProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to lineage definitions and their components.
/// </summary>
/// <remarks>
/// <para>
/// ILineageProvider is the primary interface for accessing lineage data.
/// Implementations load lineage definitions from configuration and cache
/// them for efficient access. All methods are synchronous as the data
/// is loaded once and cached in memory.
/// </para>
/// <para>
/// The provider exposes both full LineageDefinition access and convenience
/// methods for accessing individual components (attributes, bonuses, traits,
/// trauma baseline).
/// </para>
/// <para>
/// Thread Safety: Implementations should be thread-safe for concurrent reads.
/// Configuration is loaded once on first access and never modified.
/// </para>
/// </remarks>
public interface ILineageProvider
{
    /// <summary>
    /// Gets all available lineage definitions.
    /// </summary>
    /// <returns>
    /// A read-only list of all lineage definitions, one for each Lineage enum value.
    /// </returns>
    /// <exception cref="LineageConfigurationException">
    /// Thrown if configuration cannot be loaded or validated.
    /// </exception>
    IReadOnlyList<LineageDefinition> GetAllLineages();

    /// <summary>
    /// Gets the lineage definition for a specific lineage.
    /// </summary>
    /// <param name="lineage">The lineage to retrieve.</param>
    /// <returns>
    /// The lineage definition, or null if not found (should not happen in
    /// normal operation as configuration is validated on startup).
    /// </returns>
    LineageDefinition? GetLineage(Lineage lineage);

    /// <summary>
    /// Gets the attribute modifiers for a specific lineage.
    /// </summary>
    /// <param name="lineage">The lineage to get modifiers for.</param>
    /// <returns>The attribute modifiers for the lineage.</returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if the lineage is not found in the cache.
    /// </exception>
    LineageAttributeModifiers GetAttributeModifiers(Lineage lineage);

    /// <summary>
    /// Gets the passive bonuses for a specific lineage.
    /// </summary>
    /// <param name="lineage">The lineage to get bonuses for.</param>
    /// <returns>The passive bonuses for the lineage.</returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if the lineage is not found in the cache.
    /// </exception>
    LineagePassiveBonuses GetPassiveBonuses(Lineage lineage);

    /// <summary>
    /// Gets the unique trait for a specific lineage.
    /// </summary>
    /// <param name="lineage">The lineage to get the trait for.</param>
    /// <returns>The unique trait for the lineage.</returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if the lineage is not found in the cache.
    /// </exception>
    LineageTrait GetUniqueTrait(Lineage lineage);

    /// <summary>
    /// Gets the trauma baseline for a specific lineage.
    /// </summary>
    /// <param name="lineage">The lineage to get the baseline for.</param>
    /// <returns>The trauma baseline for the lineage.</returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if the lineage is not found in the cache.
    /// </exception>
    LineageTraumaBaseline GetTraumaBaseline(Lineage lineage);
}
```

### 4.3 Method Summary

| Method                    | Return Type                        | Description                     |
| ------------------------- | ---------------------------------- | ------------------------------- |
| `GetAllLineages()`        | `IReadOnlyList<LineageDefinition>` | All 4 lineage definitions       |
| `GetLineage()`            | `LineageDefinition?`               | Single lineage by enum value    |
| `GetAttributeModifiers()` | `LineageAttributeModifiers`        | Attribute modifiers for lineage |
| `GetPassiveBonuses()`     | `LineagePassiveBonuses`            | Passive bonuses for lineage     |
| `GetUniqueTrait()`        | `LineageTrait`                     | Unique trait for lineage        |
| `GetTraumaBaseline()`     | `LineageTraumaBaseline`            | Trauma baseline for lineage     |

---

## 5. LineageProvider Implementation

### 5.1 Purpose

The `LineageProvider` class implements `ILineageProvider`, loading lineage definitions from the configuration file and caching them for efficient access.

### 5.2 Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/LineageProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

using System.Text.Json;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to lineage definitions loaded from configuration.
/// </summary>
/// <remarks>
/// <para>
/// LineageProvider loads lineage definitions from config/lineages.json
/// on first access, validates the configuration, and caches the results
/// in an internal dictionary keyed by Lineage enum.
/// </para>
/// <para>
/// Thread Safety: Uses lazy initialization with locking to ensure
/// thread-safe loading. Once initialized, the cache is read-only.
/// </para>
/// </remarks>
public class LineageProvider : ILineageProvider
{
    private readonly ILogger<LineageProvider> _logger;
    private readonly string _configPath;
    private readonly object _initLock = new();
    private Dictionary<Lineage, LineageDefinition>? _cache;
    private bool _isInitialized;

    /// <summary>
    /// Initializes a new instance of the LineageProvider.
    /// </summary>
    /// <param name="logger">Logger for diagnostic output.</param>
    /// <param name="configPath">
    /// Optional path to lineages.json. Defaults to config/lineages.json.
    /// </param>
    public LineageProvider(
        ILogger<LineageProvider> logger,
        string? configPath = null)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _configPath = configPath ?? Path.Combine("config", "lineages.json");
    }

    /// <inheritdoc />
    public IReadOnlyList<LineageDefinition> GetAllLineages()
    {
        EnsureInitialized();
        return _cache!.Values.ToList().AsReadOnly();
    }

    /// <inheritdoc />
    public LineageDefinition? GetLineage(Lineage lineage)
    {
        EnsureInitialized();

        if (_cache!.TryGetValue(lineage, out var definition))
        {
            _logger.LogDebug(
                "Retrieved lineage definition. Lineage={Lineage}",
                lineage);
            return definition;
        }

        _logger.LogWarning(
            "Lineage not found in cache. Lineage={Lineage}",
            lineage);
        return null;
    }

    /// <inheritdoc />
    public LineageAttributeModifiers GetAttributeModifiers(Lineage lineage)
    {
        var definition = GetLineageOrThrow(lineage);
        return definition.AttributeModifiers;
    }

    /// <inheritdoc />
    public LineagePassiveBonuses GetPassiveBonuses(Lineage lineage)
    {
        var definition = GetLineageOrThrow(lineage);
        return definition.PassiveBonuses;
    }

    /// <inheritdoc />
    public LineageTrait GetUniqueTrait(Lineage lineage)
    {
        var definition = GetLineageOrThrow(lineage);
        return definition.UniqueTrait;
    }

    /// <inheritdoc />
    public LineageTraumaBaseline GetTraumaBaseline(Lineage lineage)
    {
        var definition = GetLineageOrThrow(lineage);
        return definition.TraumaBaseline;
    }

    /// <summary>
    /// Ensures the provider is initialized, loading configuration if needed.
    /// </summary>
    private void EnsureInitialized()
    {
        if (_isInitialized) return;

        lock (_initLock)
        {
            if (_isInitialized) return;

            _logger.LogInformation(
                "Initializing LineageProvider from {Path}",
                _configPath);

            var config = LoadConfiguration();
            ValidateConfiguration(config);
            _cache = BuildCache(config);
            _isInitialized = true;

            _logger.LogInformation(
                "LineageProvider initialized. Loaded {Count} lineages",
                _cache.Count);
        }
    }

    /// <summary>
    /// Loads the configuration from the JSON file.
    /// </summary>
    private LineageConfigurationDto LoadConfiguration()
    {
        if (!File.Exists(_configPath))
        {
            _logger.LogError(
                "Lineage configuration file not found. Path={Path}",
                _configPath);
            throw new LineageConfigurationException(
                $"Configuration file not found: {_configPath}");
        }

        try
        {
            var json = File.ReadAllText(_configPath);
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };

            var config = JsonSerializer.Deserialize<LineageConfigurationDto>(
                json, options);

            if (config == null)
            {
                throw new LineageConfigurationException(
                    "Failed to deserialize lineage configuration");
            }

            return config;
        }
        catch (JsonException ex)
        {
            _logger.LogError(ex,
                "Failed to parse lineage configuration. Path={Path}",
                _configPath);
            throw new LineageConfigurationException(
                "Invalid JSON in lineage configuration", ex);
        }
    }

    /// <summary>
    /// Validates the loaded configuration.
    /// </summary>
    private void ValidateConfiguration(LineageConfigurationDto config)
    {
        if (config.Lineages == null || config.Lineages.Count == 0)
        {
            throw new LineageConfigurationException(
                "No lineages defined in configuration");
        }

        if (config.Lineages.Count != 4)
        {
            _logger.LogError(
                "Expected 4 lineages, found {Count}",
                config.Lineages.Count);
            throw new LineageConfigurationException(
                $"Expected 4 lineages, found {config.Lineages.Count}");
        }

        var lineageIds = new HashSet<string>();
        foreach (var dto in config.Lineages)
        {
            if (string.IsNullOrWhiteSpace(dto.LineageId))
            {
                throw new LineageConfigurationException(
                    "Lineage definition missing LineageId");
            }

            if (!lineageIds.Add(dto.LineageId))
            {
                throw new LineageConfigurationException(
                    $"Duplicate lineage ID: {dto.LineageId}");
            }

            if (!Enum.TryParse<Lineage>(dto.LineageId, out _))
            {
                throw new LineageConfigurationException(
                    $"Invalid lineage ID: {dto.LineageId}");
            }
        }

        _logger.LogDebug("Lineage configuration validated successfully");
    }

    /// <summary>
    /// Builds the cache from the configuration DTOs.
    /// </summary>
    private Dictionary<Lineage, LineageDefinition> BuildCache(
        LineageConfigurationDto config)
    {
        var cache = new Dictionary<Lineage, LineageDefinition>();

        foreach (var dto in config.Lineages)
        {
            var lineageId = Enum.Parse<Lineage>(dto.LineageId);
            var definition = MapToLineageDefinition(dto);
            cache[lineageId] = definition;

            _logger.LogDebug(
                "Cached lineage definition. Lineage={Lineage}, Name={Name}",
                lineageId,
                definition.DisplayName);
        }

        return cache;
    }

    /// <summary>
    /// Maps a DTO to a domain entity.
    /// </summary>
    private LineageDefinition MapToLineageDefinition(LineageDefinitionDto dto)
    {
        var lineageId = Enum.Parse<Lineage>(dto.LineageId);

        var attributeModifiers = new LineageAttributeModifiers(
            dto.AttributeModifiers.MightModifier,
            dto.AttributeModifiers.FinesseModifier,
            dto.AttributeModifiers.WitsModifier,
            dto.AttributeModifiers.WillModifier,
            dto.AttributeModifiers.SturdinessModifier,
            dto.AttributeModifiers.HasFlexibleBonus,
            dto.AttributeModifiers.FlexibleBonusAmount);

        var skillBonuses = dto.PassiveBonuses.SkillBonuses
            .Select(sb => SkillBonus.Create(sb.SkillId, sb.BonusAmount))
            .ToList();

        var passiveBonuses = LineagePassiveBonuses.Create(
            dto.PassiveBonuses.MaxHpBonus,
            dto.PassiveBonuses.MaxApBonus,
            dto.PassiveBonuses.SoakBonus,
            dto.PassiveBonuses.MovementBonus,
            skillBonuses);

        var effectType = Enum.Parse<LineageTraitEffectType>(
            dto.UniqueTrait.EffectType);

        var uniqueTrait = LineageTrait.Create(
            dto.UniqueTrait.TraitId,
            dto.UniqueTrait.TraitName,
            dto.UniqueTrait.Description,
            effectType,
            dto.UniqueTrait.TriggerCondition,
            dto.UniqueTrait.BonusDice,
            dto.UniqueTrait.PercentModifier,
            dto.UniqueTrait.TargetCheck,
            dto.UniqueTrait.TargetCondition);

        var traumaBaseline = LineageTraumaBaseline.Create(
            dto.TraumaBaseline.StartingCorruption,
            dto.TraumaBaseline.StartingStress,
            dto.TraumaBaseline.CorruptionResistanceModifier,
            dto.TraumaBaseline.StressResistanceModifier);

        return LineageDefinition.Create(
            lineageId,
            dto.DisplayName,
            dto.Description,
            dto.SelectionText,
            attributeModifiers,
            passiveBonuses,
            uniqueTrait,
            traumaBaseline,
            dto.AppearanceNotes,
            dto.SocialRole);
    }

    /// <summary>
    /// Gets a lineage or throws if not found.
    /// </summary>
    private LineageDefinition GetLineageOrThrow(Lineage lineage)
    {
        var definition = GetLineage(lineage);
        if (definition == null)
        {
            throw new InvalidOperationException(
                $"Lineage {lineage} not found in cache");
        }
        return definition;
    }
}
```

---

## 6. Configuration Loading

### 6.1 Configuration DTOs

**File:** `src/Core/RuneAndRust.Application/DTOs/LineageConfigurationDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Root DTO for lineages.json configuration file.
/// </summary>
public class LineageConfigurationDto
{
    /// <summary>
    /// Gets or sets the list of lineage definitions.
    /// </summary>
    public List<LineageDefinitionDto> Lineages { get; set; } = new();
}

/// <summary>
/// DTO for a single lineage definition.
/// </summary>
public class LineageDefinitionDto
{
    public string LineageId { get; set; } = string.Empty;
    public string DisplayName { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string SelectionText { get; set; } = string.Empty;
    public AttributeModifiersDto AttributeModifiers { get; set; } = new();
    public PassiveBonusesDto PassiveBonuses { get; set; } = new();
    public UniqueTraitDto UniqueTrait { get; set; } = new();
    public TraumaBaselineDto TraumaBaseline { get; set; } = new();
    public string AppearanceNotes { get; set; } = string.Empty;
    public string SocialRole { get; set; } = string.Empty;
}

/// <summary>
/// DTO for attribute modifiers.
/// </summary>
public class AttributeModifiersDto
{
    public int MightModifier { get; set; }
    public int FinesseModifier { get; set; }
    public int WitsModifier { get; set; }
    public int WillModifier { get; set; }
    public int SturdinessModifier { get; set; }
    public bool HasFlexibleBonus { get; set; }
    public int FlexibleBonusAmount { get; set; }
}

/// <summary>
/// DTO for passive bonuses.
/// </summary>
public class PassiveBonusesDto
{
    public int MaxHpBonus { get; set; }
    public int MaxApBonus { get; set; }
    public int SoakBonus { get; set; }
    public int MovementBonus { get; set; }
    public List<SkillBonusDto> SkillBonuses { get; set; } = new();
}

/// <summary>
/// DTO for a skill bonus.
/// </summary>
public class SkillBonusDto
{
    public string SkillId { get; set; } = string.Empty;
    public int BonusAmount { get; set; }
}

/// <summary>
/// DTO for unique trait.
/// </summary>
public class UniqueTraitDto
{
    public string TraitId { get; set; } = string.Empty;
    public string TraitName { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string EffectType { get; set; } = string.Empty;
    public string? TriggerCondition { get; set; }
    public int? BonusDice { get; set; }
    public float? PercentModifier { get; set; }
    public string? TargetCheck { get; set; }
    public string? TargetCondition { get; set; }
}

/// <summary>
/// DTO for trauma baseline.
/// </summary>
public class TraumaBaselineDto
{
    public int StartingCorruption { get; set; }
    public int StartingStress { get; set; }
    public int CorruptionResistanceModifier { get; set; }
    public int StressResistanceModifier { get; set; }
}
```

### 6.2 Exception Types

**File:** `src/Core/RuneAndRust.Application/Exceptions/LineageConfigurationException.cs`

```csharp
namespace RuneAndRust.Application.Exceptions;

/// <summary>
/// Exception thrown when lineage configuration is invalid.
/// </summary>
public class LineageConfigurationException : Exception
{
    public LineageConfigurationException(string message)
        : base(message) { }

    public LineageConfigurationException(string message, Exception innerException)
        : base(message, innerException) { }
}
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                            | Layer          | Category  | Description                          |
| ------------------------------- | -------------- | --------- | ------------------------------------ |
| `ILineageProvider`              | Application    | Interface | Lineage data access contract         |
| `LineageProvider`               | Infrastructure | Service   | Configuration-loading implementation |
| `LineageConfigurationDto`       | Application    | DTO       | Root configuration DTO               |
| `LineageDefinitionDto`          | Application    | DTO       | Single lineage DTO                   |
| `AttributeModifiersDto`         | Application    | DTO       | Attribute modifiers DTO              |
| `PassiveBonusesDto`             | Application    | DTO       | Passive bonuses DTO                  |
| `SkillBonusDto`                 | Application    | DTO       | Skill bonus DTO                      |
| `UniqueTraitDto`                | Application    | DTO       | Unique trait DTO                     |
| `TraumaBaselineDto`             | Application    | DTO       | Trauma baseline DTO                  |
| `LineageConfigurationException` | Application    | Exception | Configuration error                  |

### 7.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── ILineageProvider.cs              ← NEW
├── DTOs/
│   └── LineageConfigurationDto.cs       ← NEW (contains all DTOs)
└── Exceptions/
    └── LineageConfigurationException.cs ← NEW

src/Infrastructure/RuneAndRust.Infrastructure/
└── Services/
    └── LineageProvider.cs               ← NEW
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component         | Level       | Events                                                 |
| ----------------- | ----------- | ------------------------------------------------------ |
| `LineageProvider` | Information | Provider initialized, lineage count loaded             |
| `LineageProvider` | Debug       | Individual lineage cached, lineage retrieved           |
| `LineageProvider` | Warning     | Lineage not found in cache                             |
| `LineageProvider` | Error       | Config file not found, invalid JSON, validation failed |

### 8.2 Structured Logging Templates

```csharp
// Information - Provider initializing
_logger.LogInformation(
    "Initializing LineageProvider from {Path}",
    _configPath);

// Information - Provider initialized
_logger.LogInformation(
    "LineageProvider initialized. Loaded {Count} lineages",
    _cache.Count);

// Debug - Lineage cached
_logger.LogDebug(
    "Cached lineage definition. Lineage={Lineage}, Name={Name}",
    lineageId,
    definition.DisplayName);

// Debug - Lineage retrieved
_logger.LogDebug(
    "Retrieved lineage definition. Lineage={Lineage}",
    lineage);

// Warning - Lineage not found
_logger.LogWarning(
    "Lineage not found in cache. Lineage={Lineage}",
    lineage);

// Error - Config file not found
_logger.LogError(
    "Lineage configuration file not found. Path={Path}",
    _configPath);

// Error - Validation failed
_logger.LogError(
    "Expected 4 lineages, found {Count}",
    config.Lineages.Count);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                    | Test Count |
| -------------------------- | ---------- |
| ILineageProvider interface | ~1         |
| LineageProvider loading    | ~3         |
| LineageProvider access     | ~2         |
| **Total**                  | **~6**     |

### 9.2 Test Specifications

#### LineageProviderTests.cs

**File:** `tests/RuneAndRust.Infrastructure.UnitTests/Services/LineageProviderTests.cs`

```csharp
[TestFixture]
public class LineageProviderTests
{
    [Test]
    public void GetAllLineages_ReturnsAllFourLineages();

    [Test]
    public void GetLineage_WithValidLineage_ReturnsDefinition();

    [Test]
    public void GetLineage_WithInvalidConfiguration_ThrowsException();

    [Test]
    public void GetAttributeModifiers_ForRuneMarked_ReturnsCorrectModifiers();

    [Test]
    public void GetPassiveBonuses_ForClanBorn_ReturnsCorrectBonuses();

    [Test]
    public void GetUniqueTrait_ForIronBlooded_ReturnsHazardAcclimation();

    [Test]
    public void GetTraumaBaseline_ForRuneMarked_ReturnsPermanentCorruption();

    [Test]
    public void Initialize_WithMissingFile_ThrowsLineageConfigurationException();

    [Test]
    public void Initialize_WithInvalidJson_ThrowsLineageConfigurationException();

    [Test]
    public void Initialize_WithDuplicateLineages_ThrowsLineageConfigurationException();

    [Test]
    public void Initialize_WithMissingLineage_ThrowsLineageConfigurationException();

    [Test]
    public void GetLineage_IsCachedAfterFirstAccess();
}
```

---

## 10. Use Cases

### UC-001: Load Lineages on Startup

**Actor:** Application Startup  
**Flow:** App starts → DI resolves ILineageProvider → First access triggers load → Config loaded and validated → Lineages cached

### UC-002: Display Lineage Options

**Actor:** Character Creation UI  
**Flow:** UI initializes → Calls GetAllLineages() → Receives list of 4 definitions → Displays selection cards

### UC-003: Get Specific Lineage Details

**Actor:** Character Creation Service  
**Flow:** Player selects lineage → Service calls GetLineage(Lineage) → Returns full definition → Display detailed info

### UC-004: Access Lineage Components

**Actor:** Various Application Services  
**Flow:** Service needs specific data → Calls GetAttributeModifiers() / GetPassiveBonuses() → Receives only needed component

---

## 11. User Stories

### US-001: Access Lineage Data

**As a** character creation service  
**I want to** retrieve lineage definitions from a central provider  
**So that** I have consistent access to lineage data throughout the app

**Acceptance Criteria:**

- Single ILineageProvider interface for all lineage access
- All 4 lineages available
- Component-specific access methods available

### US-002: Handle Configuration Errors

**As a** game administrator  
**I want to** receive clear error messages when configuration is invalid  
**So that** I can fix configuration issues quickly

**Acceptance Criteria:**

- Clear error message for missing config file
- Clear error message for invalid JSON
- Clear error message for missing lineages

### US-003: Efficient Lineage Access

**As the** application  
**I want** lineage data to be loaded once and cached  
**So that** subsequent access is fast

**Acceptance Criteria:**

- Configuration loaded only on first access
- All subsequent calls use cached data
- No file I/O after initial load

---

## 12. Deliverable Checklist

### Application Layer

- [ ] `ILineageProvider.cs` interface created in `Interfaces/`
- [ ] `LineageConfigurationDto.cs` created in `DTOs/`
- [ ] `LineageConfigurationException.cs` created in `Exceptions/`
- [ ] All types have complete XML documentation

### Infrastructure Layer

- [ ] `LineageProvider.cs` implementation created in `Services/`
- [ ] Configuration loading implemented
- [ ] Validation logic implemented
- [ ] Caching implemented

### Testing

- [ ] `LineageProviderTests.cs` created
- [ ] ~6 unit tests passing

### DI Registration

- [ ] ILineageProvider registered as singleton in DI container

### Documentation

- [ ] `v0.17.0e-changelog.md` created
- [ ] Inline code comments complete

---

## 13. Acceptance Criteria

### Functional

- [ ] `ILineageProvider` interface defines 6 methods
- [ ] `LineageProvider` loads configuration from lineages.json
- [ ] Configuration is validated (4 lineages, no duplicates, valid enum values)
- [ ] Lineage definitions are cached after first load
- [ ] `GetAllLineages()` returns all 4 lineages
- [ ] `GetLineage(Lineage)` returns correct definition
- [ ] Component access methods return correct data
- [ ] Invalid configuration throws `LineageConfigurationException`

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~6 unit tests pass
- [ ] Thread-safe initialization
- [ ] All public types have XML documentation

---

## 14. Dependencies

### Required from v0.17.0a-d

| Type                        | Location                           | Usage                    |
| --------------------------- | ---------------------------------- | ------------------------ |
| `Lineage`                   | `RuneAndRust.Domain/Enums/`        | Key for cache dictionary |
| `LineageDefinition`         | `RuneAndRust.Domain/Entities/`     | Returned by provider     |
| `LineageAttributeModifiers` | `RuneAndRust.Domain/ValueObjects/` | Component access return  |
| `LineagePassiveBonuses`     | `RuneAndRust.Domain/ValueObjects/` | Component access return  |
| `LineageTrait`              | `RuneAndRust.Domain/ValueObjects/` | Component access return  |
| `LineageTraumaBaseline`     | `RuneAndRust.Domain/ValueObjects/` | Component access return  |
| `lineages.json`             | `config/`                          | Source configuration     |

### Provides to v0.17.0f

| Type               | Usage                             |
| ------------------ | --------------------------------- |
| `ILineageProvider` | Used by LineageApplicationService |

### Provides to v0.17.5

| Type               | Usage                                        |
| ------------------ | -------------------------------------------- |
| `ILineageProvider` | Injected into Character Creation UI/Services |

---

## 15. Future Considerations

### Deferred to v0.17.0f

- **ILineageApplicationService**: Service that applies lineage to characters

### Deferred to v0.17.5

- **Character Creation UI Integration**: Using provider in UI components
- **Character Factory Integration**: Applying lineage during character creation

### Deferred to Future Enhancements

- **Configuration Hot Reload**: Reloading configuration without restart
- **Database Persistence**: Loading lineages from database instead of JSON
- **Custom Lineages**: User-defined lineage support
- **Modding Support**: External lineage definition files

### Out of Scope

- **Async Loading**: Configuration small enough for synchronous load
- **Configuration Editing**: Provider is read-only
- **Lineage Modification**: Definitions are immutable

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
