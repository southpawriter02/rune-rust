# v0.14.4c Design Specification: Terrain Schema Expansion

**Version:** 0.14.4c
**Parent:** v0.14.4 (Environment Configuration Schemas)
**Prerequisites:** v0.14.3 Complete (Monster Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [TerrainDefinition Schema Expansion](#4-terraindefinition-schema-expansion)
   - 4.1 [Existing Properties](#41-existing-properties)
   - 4.2 [New Properties](#42-new-properties)
5. [Cover Level Configuration](#5-cover-level-configuration)
   - 5.1 [Cover Level Enum](#51-cover-level-enum)
   - 5.2 [Defense Bonus Effects](#52-defense-bonus-effects)
6. [Visibility Configuration](#6-visibility-configuration)
   - 6.1 [Visibility Modifier](#61-visibility-modifier)
   - 6.2 [Concealment System](#62-concealment-system)
7. [Hazard Effect Configuration](#7-hazard-effect-configuration)
   - 7.1 [HazardEffect Definition](#71-hazardeffect-definition)
   - 7.2 [Trigger Types](#72-trigger-types)
   - 7.3 [Saving Throw Configuration](#73-saving-throw-configuration)
8. [Status Effect Application](#8-status-effect-application)
   - 8.1 [Status Effect Reference](#81-status-effect-reference)
   - 8.2 [Application Chance](#82-application-chance)
9. [Terrain Tags and Biome Associations](#9-terrain-tags-and-biome-associations)
   - 9.1 [Terrain Tags](#91-terrain-tags)
   - 9.2 [Biome Associations](#92-biome-associations)
10. [Enhanced Movement Cost Validation](#10-enhanced-movement-cost-validation)
11. [Validation Rules](#11-validation-rules)
    - 11.1 [ID Pattern Validation](#111-id-pattern-validation)
    - 11.2 [Range Validation](#112-range-validation)
    - 11.3 [Enum Validation](#113-enum-validation)
    - 11.4 [Required Fields](#114-required-fields)
12. [Configuration Schema](#12-configuration-schema)
13. [Configuration File Updates](#13-configuration-file-updates)
14. [Data Model Changes](#14-data-model-changes)
15. [Logging Specifications](#15-logging-specifications)
16. [Unit Testing Requirements](#16-unit-testing-requirements)
17. [Use Cases](#17-use-cases)
18. [Deliverable Checklist](#18-deliverable-checklist)
19. [Acceptance Criteria](#19-acceptance-criteria)
20. [Dependencies](#20-dependencies)
21. [Future Considerations](#21-future-considerations)

---

## 1. Executive Summary

Version 0.14.4c expands the existing **Terrain Schema** (`terrain.schema.json`) to add cover associations, visibility modifiers, hazard triggers, status effect application, terrain tags, and biome associations. This schema expansion enhances the terrain system to support tactical combat mechanics like cover bonuses, line-of-sight modifiers, and sophisticated hazard behaviors without code changes.

The expanded Terrain Schema validates the existing `terrain.json` configuration file which currently defines 10 terrain types (normal-floor, rubble, shallow-water, mud, pit, wall, fire, acid-pool, spike-trap, lava). The schema expansion is fully backward compatible with existing terrain definitions while enabling new tactical features.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | Update `terrain.schema.json` |
| **Schema Definitions** | Expand `TerrainDefinition`, add `HazardEffect`, add `SavingThrow` |
| **Configuration Files** | Existing `terrain.json` validated (no changes required) |
| **Tests** | ~5 new unit tests |

### Architectural Significance

This version provides:
- **Cover level validation** - None, Half, ThreeQuarters, Full cover positions
- **Visibility modifier validation** - Partial LOS blocking (0.0-1.0 range)
- **Concealment validation** - Terrain that provides stealth benefits
- **Hazard trigger validation** - OnEntry, PerTurn, OnExit timing
- **Saving throw validation** - Attribute-based damage reduction
- **Status effect application validation** - Burning, freezing, poison effects
- **Terrain tags validation** - Categorical filtering for terrain types
- **Biome associations validation** - Terrain-biome relationships

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  v0.14.4 ENVIRONMENT CONFIGURATION SCHEMAS                   │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.4a: biomes.schema.json                                           │
  │  v0.14.4b: room-types.schema.json                                       │
  │  v0.14.4c: terrain.schema.json (expansion) ◀── THIS VERSION             │
  │  v0.14.4d: interactive-objects.schema.json                              │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • terrain.json → biomeAssociations references biomes.json
  • terrain.json → appliesStatusEffect references status-effects.json
  • terrain.json → hazardEffect.damageType references damage-types

  Shared definitions:
  • ID pattern: ^[a-z][a-z0-9-]*$ (lowercase kebab-case)
  • Schema location: config/schemas/
  • Dice expression pattern: ^[0-9]+d[0-9]+([+-][0-9]+)?$
  • Terrain types: Normal, Difficult, Impassable, Hazardous
```

---

## 2. Feature Overview

```
v0.14.4c Terrain Schema Expansion Features
├── terrain.schema.json (EXPANDED)
│   ├── Existing Properties
│   │   ├── id (string, kebab-case pattern, required)
│   │   ├── name (string, required)
│   │   ├── type (enum: Normal, Difficult, Impassable, Hazardous, required)
│   │   ├── movementCostMultiplier (number, minimum: 0, default: 1.0)
│   │   ├── damageOnEntry (string, dice expression)
│   │   ├── damageType (string, damage type id)
│   │   ├── blocksLOS (boolean, default: false)
│   │   ├── displayChar (string, length: 1, default: ".")
│   │   └── description (string)
│   ├── New Properties
│   │   ├── coverLevel (enum: None, Half, ThreeQuarters, Full, default: None)
│   │   ├── visibilityModifier (number, 0-1, default: 1.0)
│   │   ├── providesConcealment (boolean, default: false)
│   │   ├── hazardEffect (HazardEffect, optional)
│   │   ├── appliesStatusEffect (string, status effect id, optional)
│   │   ├── statusEffectChance (number, 0-1, default: 1.0)
│   │   ├── tags (array of string, optional)
│   │   └── biomeAssociations (array of string, biome ids, optional)
│   └── New Definitions
│       ├── HazardEffect
│       │   ├── triggerType (enum: OnEntry, PerTurn, OnExit, required)
│       │   ├── damage (string, dice expression, required)
│       │   ├── damageType (string, damage type id, required)
│       │   ├── savingThrow (SavingThrow, optional)
│       │   └── description (string, optional)
│       └── SavingThrow
│           ├── attribute (enum: might, fortitude, will, wits, finesse, required)
│           ├── dc (integer, minimum: 1, required)
│           └── halfOnSuccess (boolean, default: true)
├── Validation Rules
│   ├── Cover Level Enum Validation (4 values)
│   ├── Visibility Modifier Range Validation (0-1)
│   ├── Hazard Trigger Type Enum Validation (3 values)
│   ├── Saving Throw Attribute Enum Validation (5 values)
│   ├── Status Effect Chance Range Validation (0-1)
│   ├── Movement Cost Multiplier Enhanced Validation (minimum: 0)
│   ├── Dice Expression Pattern Validation
│   └── Required Fields Enforced
└── Configuration Updates
    └── terrain.json validated with expanded schema (backward compatible)
```

---

## 3. Architecture Diagrams

### 3.1 Terrain Definition Structure Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TERRAIN DEFINITION STRUCTURE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    TERRAIN DEFINITION                                │    │
│  │                                                                      │    │
│  │  id: "fire"                                                          │    │
│  │  name: "Fire"                                                        │    │
│  │  type: "Hazardous"                                                   │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  MOVEMENT CONFIGURATION                                        │  │    │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │    │
│  │  │  │ movementCostMultiplier: 1.0  (normal movement cost)     │  │  │    │
│  │  │  │ displayChar: "▲"             (grid character)           │  │  │    │
│  │  │  │ description: "Flames - 1d6 fire damage on entry"        │  │  │    │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  COVER & VISIBILITY (NEW)                                      │  │    │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │    │
│  │  │  │ coverLevel: "None"          (no cover provided)         │  │  │    │
│  │  │  │ visibilityModifier: 0.8     (flames obscure slightly)   │  │  │    │
│  │  │  │ providesConcealment: false  (cannot hide in flames)     │  │  │    │
│  │  │  │ blocksLOS: false            (can see through)           │  │  │    │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  HAZARD EFFECT (NEW - replaces damageOnEntry)                  │  │    │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │    │
│  │  │  │ hazardEffect: {                                         │  │  │    │
│  │  │  │   triggerType: "OnEntry"     // When to apply damage    │  │  │    │
│  │  │  │   damage: "1d6"              // Dice expression         │  │  │    │
│  │  │  │   damageType: "fire"         // Damage type ID          │  │  │    │
│  │  │  │   savingThrow: {             // Optional save           │  │  │    │
│  │  │  │     attribute: "finesse"                                │  │  │    │
│  │  │  │     dc: 12                                              │  │  │    │
│  │  │  │     halfOnSuccess: true                                 │  │  │    │
│  │  │  │   }                                                     │  │  │    │
│  │  │  │   description: "The flames sear your flesh"             │  │  │    │
│  │  │  │ }                                                       │  │  │    │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  STATUS EFFECTS (NEW)                                          │  │    │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │    │
│  │  │  │ appliesStatusEffect: "burning"                          │  │  │    │
│  │  │  │ statusEffectChance: 0.5       // 50% chance to apply    │  │  │    │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  TAGS & ASSOCIATIONS (NEW)                                     │  │    │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │    │
│  │  │  │ tags: ["hazardous", "fire", "light-source"]             │  │  │    │
│  │  │  │ biomeAssociations: ["volcanic", "dungeon"]              │  │  │    │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Schema Validation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SCHEMA VALIDATION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    User edits terrain.json
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          IDE/EDITOR                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Reads $schema property from config file                                  │
│  2. Loads terrain.schema.json from config/schemas/                           │
│  3. Validates content against expanded schema                                │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ├─── Valid ───▶ Green checkmark, autocomplete works
           │               (includes new properties: coverLevel, hazardEffect, etc.)
           │
           └─── Invalid ─▶ Error underlines with messages:
                           • "coverLevel must be one of: None, Half, ThreeQuarters, Full"
                           • "visibilityModifier must be between 0 and 1"
                           • "savingThrow.attribute must be one of: might, fortitude, ..."
                           • "statusEffectChance must be between 0 and 1"
```

### 3.3 Cover Level System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          COVER LEVEL SYSTEM                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  COVER LEVELS                                                                │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Cover Level    │ Defense │ Visual Representation                      │ │
│  │  ───────────────┼─────────┼───────────────────────────────────────    │ │
│  │  None           │   +0    │  ░ ░ ░ (open ground)                       │ │
│  │  Half           │   +2    │  ▄▄▄░░ (low wall, crates)                  │ │
│  │  ThreeQuarters  │   +4    │  ██▄░░ (pillar, corner)                    │ │
│  │  Full           │   +6    │  █████ (solid wall)                        │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  COVER BY TERRAIN TYPE                                                       │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Terrain         │ Cover Level      │ Rationale                        │ │
│  │  ────────────────┼──────────────────┼──────────────────────────────    │ │
│  │  normal-floor    │ None             │ Open ground                      │ │
│  │  rubble          │ Half             │ Debris provides partial cover    │ │
│  │  shallow-water   │ None             │ Water offers no cover            │ │
│  │  mud             │ None             │ Flat surface                     │ │
│  │  pit             │ ThreeQuarters    │ Below ground level               │ │
│  │  wall            │ Full             │ Solid barrier                    │ │
│  │  fire            │ None             │ Can't hide in flames             │ │
│  │  acid-pool       │ None             │ Liquid offers no cover           │ │
│  │  spike-trap      │ None             │ Flat trap                        │ │
│  │  lava            │ None             │ Liquid offers no cover           │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  COMBAT EXAMPLE                                                              │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │   Attacker → → → → → → →┐                                              │ │
│  │                          ▼                                              │ │
│  │   ┌─────────┐    ┌─────────┐    ┌─────────┐                            │ │
│  │   │ RUBBLE  │    │  WALL   │    │  PIT    │                            │ │
│  │   │ Half    │    │  Full   │    │ 3/4     │                            │ │
│  │   │  +2 AC  │    │ Blocked │    │  +4 AC  │                            │ │
│  │   └─────────┘    └─────────┘    └─────────┘                            │ │
│  │                                                                        │ │
│  │   Attack roll must beat: Base AC + Cover Bonus                         │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Visibility Modifier System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       VISIBILITY MODIFIER SYSTEM                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  VISIBILITY LEVELS                                                           │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │     1.0                0.5               0.0                           │ │
│  │      │                  │                 │                            │ │
│  │  Full Visibility ──────────────────── No Visibility                    │ │
│  │      │                  │                 │                            │ │
│  │  Clear Floor       Smoke/Mist        Solid Wall                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  VISIBILITY VS BLOCKS LOS                                                    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  blocksLOS: true  → visibilityModifier ignored (0.0 effective)         │ │
│  │  blocksLOS: false → visibilityModifier applies (0.0 to 1.0)            │ │
│  │                                                                        │ │
│  │  Examples:                                                             │ │
│  │  • Wall: blocksLOS = true, visibility = 0.0 (completely blocked)       │ │
│  │  • Fire: blocksLOS = false, visibility = 0.8 (slight obscuring)        │ │
│  │  • Smoke: blocksLOS = false, visibility = 0.3 (heavy obscuring)        │ │
│  │  • Floor: blocksLOS = false, visibility = 1.0 (fully visible)          │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  LINE OF SIGHT CALCULATION                                                   │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │   Observer ───▶ Tile 1 ───▶ Tile 2 ───▶ Tile 3 ───▶ Target             │ │
│  │                  (1.0)      (0.8)       (0.5)                          │ │
│  │                                                                        │ │
│  │   Final Visibility = 1.0 × 0.8 × 0.5 = 0.4 (40% visibility)            │ │
│  │                                                                        │ │
│  │   Perception Check DC = Base DC + (10 × (1 - visibility))              │ │
│  │   Example: DC 10 + (10 × 0.6) = DC 16 to spot target                   │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  CONCEALMENT BONUS                                                           │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  providesConcealment: true                                             │ │
│  │  • Character can attempt to hide in this terrain                       │ │
│  │  • Stealth checks enabled                                              │ │
│  │  • Miss chance against concealed targets                               │ │
│  │                                                                        │ │
│  │  providesConcealment: false                                            │ │
│  │  • Cannot hide in this terrain                                         │ │
│  │  • Stealth requires cover or other concealment                         │ │
│  │                                                                        │ │
│  │  Examples:                                                             │ │
│  │  • Dense Foliage: visibility = 0.6, providesConcealment = true         │ │
│  │  • Fire: visibility = 0.8, providesConcealment = false                 │ │
│  │  • Smoke: visibility = 0.3, providesConcealment = true                 │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Hazard Trigger System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         HAZARD TRIGGER SYSTEM                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TRIGGER TYPES                                                               │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  OnEntry ──────────▶ PerTurn ──────────▶ OnExit                        │ │
│  │      │                   │                  │                          │ │
│  │  Stepping onto      Each turn while      Leaving                       │ │
│  │  the tile           on the tile          the tile                      │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  TRIGGER BY TERRAIN TYPE                                                     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Terrain       │ Trigger   │ Damage │ Rationale                        │ │
│  │  ──────────────┼───────────┼────────┼────────────────────────────────  │ │
│  │  fire          │ OnEntry   │ 1d6    │ Burn when walking through        │ │
│  │  acid-pool     │ PerTurn   │ 1d4    │ Continuous acid damage           │ │
│  │  spike-trap    │ OnEntry   │ 1d8    │ Spikes activate on step          │ │
│  │  lava          │ PerTurn   │ 2d6    │ Continuous extreme heat          │ │
│  │  tar-pit       │ OnExit    │ 1d4    │ Resistance when leaving          │ │
│  │  web           │ OnExit    │ none   │ Slows when leaving               │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  TIMING DIAGRAM                                                              │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Turn 1                 Turn 2                 Turn 3                  │ │
│  │  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐        │ │
│  │  │ Enter Lava    │     │ Stand in Lava │     │ Exit Lava     │        │ │
│  │  │   ▼           │     │   ▼           │     │   ▼           │        │ │
│  │  │ [PerTurn]     │     │ [PerTurn]     │     │ No damage     │        │ │
│  │  │  2d6 fire     │     │  2d6 fire     │     │ (on exit)     │        │ │
│  │  └───────────────┘     └───────────────┘     └───────────────┘        │ │
│  │                                                                        │ │
│  │  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐        │ │
│  │  │ Enter Fire    │     │ Move through  │     │ Already left  │        │ │
│  │  │   ▼           │     │   ▼           │     │   ▼           │        │ │
│  │  │ [OnEntry]     │     │ [OnEntry]     │     │ No damage     │        │ │
│  │  │  1d6 fire     │     │  1d6 fire     │     │               │        │ │
│  │  └───────────────┘     └───────────────┘     └───────────────┘        │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  SAVING THROW INTEGRATION                                                    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Hazard Triggers ──▶ Saving Throw Roll ──▶ Damage Calculation          │ │
│  │                              │                     │                   │ │
│  │                      ┌───────┴───────┐             │                   │ │
│  │                      │               │             │                   │ │
│  │                   Success         Failure          │                   │ │
│  │                      │               │             │                   │ │
│  │                      ▼               ▼             │                   │ │
│  │              Half Damage     Full Damage          │                   │ │
│  │              (if halfOnSuccess)                    │                   │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 Status Effect Application

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     STATUS EFFECT APPLICATION                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STATUS EFFECT CONFIGURATION                                                 │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  appliesStatusEffect: "burning"                                        │ │
│  │  statusEffectChance: 0.5    // 50% chance to apply burning             │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  TERRAIN → STATUS EFFECT MAPPING                                             │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Terrain       │ Status Effect  │ Chance │ Description                 │ │
│  │  ──────────────┼────────────────┼────────┼──────────────────────────── │ │
│  │  fire          │ burning        │ 50%    │ Ongoing fire damage         │ │
│  │  lava          │ burning        │ 100%   │ Always catch fire           │ │
│  │  acid-pool     │ corroding      │ 75%    │ Armor/equipment damage      │ │
│  │  frozen-ground │ chilled        │ 40%    │ Slowed movement             │ │
│  │  poison-gas    │ poisoned       │ 80%    │ Ongoing poison damage       │ │
│  │  mud           │ slowed         │ 30%    │ Reduced movement speed      │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  APPLICATION FLOW                                                            │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Character enters terrain                                               │ │
│  │         │                                                               │ │
│  │         ▼                                                               │ │
│  │  Has appliesStatusEffect?                                               │ │
│  │         │                                                               │ │
│  │    Yes  │  No                                                           │ │
│  │    │    └──▶ No effect applied                                          │ │
│  │    ▼                                                                    │ │
│  │  Roll vs statusEffectChance                                             │ │
│  │         │                                                               │ │
│  │   Pass  │  Fail                                                         │ │
│  │    │    └──▶ Status effect applied                                      │ │
│  │    ▼                                                                    │ │
│  │  Status effect NOT applied (lucky)                                      │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 Terrain Tags and Biome Associations

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   TERRAIN TAGS AND BIOME ASSOCIATIONS                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TERRAIN TAGS                                                                │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  tags: ["hazardous", "fire", "light-source", "warm"]                   │ │
│  │                                                                        │ │
│  │  Common Tags:                                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Type Tags       │ Material Tags   │ Effect Tags                 │  │ │
│  │  │ ───────────────┼─────────────────┼───────────────────────────  │  │ │
│  │  │ hazardous       │ stone           │ light-source                │  │ │
│  │  │ difficult       │ water           │ warm                        │  │ │
│  │  │ impassable      │ ice             │ cold                        │  │ │
│  │  │ normal          │ wood            │ slippery                    │  │ │
│  │  │ trap            │ metal           │ sticky                      │  │ │
│  │  │ natural         │ earth           │ flammable                   │  │ │
│  │  │ constructed     │ lava            │ conductive                  │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  BIOME ASSOCIATIONS                                                          │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  biomeAssociations: ["volcanic", "dungeon"]                            │ │
│  │                                                                        │ │
│  │  Terrain → Biome Mapping:                                              │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │ Terrain       │ Associated Biomes                               │  │ │
│  │  │ ──────────────┼───────────────────────────────────────────────  │  │ │
│  │  │ fire          │ volcanic, dungeon                               │  │ │
│  │  │ lava          │ volcanic                                        │  │ │
│  │  │ shallow-water │ swamp, cave                                     │  │ │
│  │  │ mud           │ swamp, forest                                   │  │ │
│  │  │ rubble        │ ruins, dungeon, cave                            │  │ │
│  │  │ ice-floor     │ frozen                                          │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  │  Use Case: Biome-specific terrain filtering during level generation    │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  FILTERING EXAMPLE                                                           │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │  Query: Get all hazardous terrain for volcanic biome                   │ │
│  │                                                                        │ │
│  │  Filter 1: tags.contains("hazardous")                                  │ │
│  │    ├── fire ✓                                                          │ │
│  │    ├── lava ✓                                                          │ │
│  │    ├── acid-pool ✓                                                     │ │
│  │    └── spike-trap ✓                                                    │ │
│  │                                                                        │ │
│  │  Filter 2: biomeAssociations.contains("volcanic")                      │ │
│  │    ├── fire ✓                                                          │ │
│  │    ├── lava ✓                                                          │ │
│  │    ├── acid-pool ✗                                                     │ │
│  │    └── spike-trap ✗                                                    │ │
│  │                                                                        │ │
│  │  Result: [fire, lava]                                                  │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.8 File Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIG LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  config/                                                                     │
│  ├── terrain.json ◀───────────────────────────┐                              │
│  │   {                                         │ references                   │
│  │     "$schema": "./schemas/terrain.schema.json",                           │
│  │     "terrainDefinitions": [                 │                              │
│  │       {                                     │                              │
│  │         "id": "fire",                       │                              │
│  │         "name": "Fire",                     │                              │
│  │         "type": "Hazardous",                │                              │
│  │         "movementCostMultiplier": 1.0,      │                              │
│  │         "damageOnEntry": "1d6",             │ (legacy - still supported)   │
│  │         "damageType": "fire",               │                              │
│  │         "displayChar": "▲",                 │                              │
│  │         "description": "..."                │                              │
│  │         // NEW optional fields:             │                              │
│  │         // "coverLevel": "None",            │                              │
│  │         // "hazardEffect": {...},           │                              │
│  │         // "appliesStatusEffect": "burning" │                              │
│  │       },                                    │                              │
│  │       ...                                   │                              │
│  │     ]                                       │                              │
│  │   }                                         │                              │
│  │                                             │                              │
│  ├── biomes.json (provides biome IDs for associations)                       │
│  │                                             │                              │
│  ├── status-effects.json (provides effect IDs)  │                             │
│  │                                             │                              │
│  └── schemas/                                  │                              │
│      └── terrain.schema.json ─────────────────┘                              │
│          {                                                                   │
│            "$schema": "http://json-schema.org/draft-07/schema#",            │
│            "definitions": {                                                  │
│              "TerrainDefinition": {...},    // EXPANDED                      │
│              "HazardEffect": {...},         // NEW                           │
│              "SavingThrow": {...}           // NEW                           │
│            }                                                                 │
│          }                                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. TerrainDefinition Schema Expansion

### 4.1 Existing Properties

The existing `TerrainDefinition` schema contains these properties which remain unchanged:

```json
"TerrainDefinition": {
    "type": "object",
    "description": "A single terrain type definition",
    "properties": {
        "id": {
            "type": "string",
            "description": "Unique identifier for this terrain (lowercase kebab-case)",
            "pattern": "^[a-z][a-z0-9-]*$"
        },
        "name": {
            "type": "string",
            "description": "Display name for the terrain"
        },
        "type": {
            "type": "string",
            "description": "Base terrain category",
            "enum": ["Normal", "Difficult", "Impassable", "Hazardous"]
        },
        "movementCostMultiplier": {
            "type": "number",
            "description": "Movement cost multiplier (1.0 = normal)",
            "minimum": 0,
            "default": 1.0
        },
        "damageOnEntry": {
            "type": "string",
            "description": "Dice expression for hazard damage (e.g., '1d6')"
        },
        "damageType": {
            "type": "string",
            "description": "Damage type ID for hazardous terrain"
        },
        "blocksLOS": {
            "type": "boolean",
            "description": "Whether this terrain blocks line of sight",
            "default": false
        },
        "displayChar": {
            "type": "string",
            "description": "ASCII character for grid display",
            "minLength": 1,
            "maxLength": 1,
            "default": "."
        },
        "description": {
            "type": "string",
            "description": "Description for legends and tooltips"
        }
    },
    "required": ["id", "name", "type"]
}
```

### 4.2 New Properties

The following new properties are added to `TerrainDefinition`:

```json
{
    "coverLevel": {
        "type": "string",
        "description": "Level of cover provided by this terrain",
        "enum": ["None", "Half", "ThreeQuarters", "Full"],
        "default": "None"
    },
    "visibilityModifier": {
        "type": "number",
        "description": "Visibility through this terrain (0.0 = opaque, 1.0 = clear)",
        "minimum": 0,
        "maximum": 1,
        "default": 1.0
    },
    "providesConcealment": {
        "type": "boolean",
        "description": "Whether this terrain allows characters to hide",
        "default": false
    },
    "hazardEffect": {
        "$ref": "#/definitions/HazardEffect",
        "description": "Detailed hazard configuration (alternative to damageOnEntry)"
    },
    "appliesStatusEffect": {
        "type": "string",
        "description": "Status effect ID applied when entering this terrain",
        "pattern": "^[a-z][a-z0-9-]*$"
    },
    "statusEffectChance": {
        "type": "number",
        "description": "Probability of applying status effect (0.0 to 1.0)",
        "minimum": 0,
        "maximum": 1,
        "default": 1.0
    },
    "tags": {
        "type": "array",
        "description": "Categorical tags for filtering terrain types",
        "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
        }
    },
    "biomeAssociations": {
        "type": "array",
        "description": "Biome IDs where this terrain commonly appears",
        "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
        }
    }
}
```

---

## 5. Cover Level Configuration

### 5.1 Cover Level Enum

The `coverLevel` field defines the defensive cover provided by terrain.

```json
"coverLevel": {
    "type": "string",
    "description": "Level of cover provided by this terrain",
    "enum": ["None", "Half", "ThreeQuarters", "Full"],
    "default": "None"
}
```

| Cover Level | Description | Example Terrain |
|-------------|-------------|-----------------|
| `None` | No cover provided | Open floor, water, fire |
| `Half` | Partial cover (+2 defense) | Low wall, rubble, crates |
| `ThreeQuarters` | Significant cover (+4 defense) | Pillar, deep pit, corner |
| `Full` | Complete cover (+6 defense) | Solid wall, closed door |

### 5.2 Defense Bonus Effects

| Cover Level | Defense Bonus | To-Hit Penalty |
|-------------|---------------|----------------|
| `None` | +0 | +0 |
| `Half` | +2 | -2 |
| `ThreeQuarters` | +4 | -4 |
| `Full` | +6 / Blocked | -6 / Cannot target |

**Usage:**
- Cover bonuses apply when the defender is adjacent to or on covered terrain
- Ranged attacks suffer penalties based on target's cover
- Full cover typically blocks targeting entirely
- Melee attacks may ignore cover (DM discretion)

---

## 6. Visibility Configuration

### 6.1 Visibility Modifier

The `visibilityModifier` field controls how much the terrain obscures vision.

```json
"visibilityModifier": {
    "type": "number",
    "description": "Visibility through this terrain (0.0 = opaque, 1.0 = clear)",
    "minimum": 0,
    "maximum": 1,
    "default": 1.0
}
```

| Value | Effect | Example |
|-------|--------|---------|
| `1.0` | Full visibility | Clear floor, shallow water |
| `0.8` | Slight obscuring | Fire, light mist |
| `0.5` | 50% visibility | Heavy mist, smoke |
| `0.3` | Heavy obscuring | Dense fog, thick smoke |
| `0.0` | No visibility | Solid wall (use blocksLOS) |

**Relationship to blocksLOS:**
- If `blocksLOS: true`, visibility is effectively 0.0
- If `blocksLOS: false`, `visibilityModifier` applies
- For partial obscuring, use `blocksLOS: false` with low `visibilityModifier`

### 6.2 Concealment System

The `providesConcealment` field determines if characters can hide in this terrain.

```json
"providesConcealment": {
    "type": "boolean",
    "description": "Whether this terrain allows characters to hide",
    "default": false
}
```

**Examples:**
| Terrain | Visibility | Concealment | Rationale |
|---------|------------|-------------|-----------|
| Dense foliage | 0.6 | true | Can hide in bushes |
| Fire | 0.8 | false | Cannot hide in flames |
| Smoke | 0.3 | true | Can hide in smoke |
| Open floor | 1.0 | false | No hiding on open ground |
| Shadow | 0.5 | true | Can hide in shadows |

**Mechanics:**
- `providesConcealment: true` enables Stealth checks
- Stealth DC based on visibility modifier
- Miss chance may apply for concealed targets

---

## 7. Hazard Effect Configuration

### 7.1 HazardEffect Definition

The `HazardEffect` object provides detailed hazard configuration as an alternative to the simpler `damageOnEntry` field.

```json
"HazardEffect": {
    "type": "object",
    "description": "Detailed configuration for hazardous terrain effects",
    "properties": {
        "triggerType": {
            "type": "string",
            "description": "When the hazard effect triggers",
            "enum": ["OnEntry", "PerTurn", "OnExit"]
        },
        "damage": {
            "type": "string",
            "description": "Dice expression for damage (e.g., '1d6', '2d4+2')",
            "pattern": "^[0-9]+d[0-9]+([+-][0-9]+)?$"
        },
        "damageType": {
            "type": "string",
            "description": "Damage type ID (e.g., 'fire', 'acid', 'piercing')",
            "pattern": "^[a-z][a-z0-9-]*$"
        },
        "savingThrow": {
            "$ref": "#/definitions/SavingThrow",
            "description": "Optional saving throw to reduce or avoid damage"
        },
        "description": {
            "type": "string",
            "description": "Flavor text displayed when hazard triggers"
        }
    },
    "required": ["triggerType", "damage", "damageType"]
}
```

**Example Configurations:**
```json
{
    "hazardEffect": {
        "triggerType": "OnEntry",
        "damage": "1d6",
        "damageType": "fire",
        "savingThrow": {
            "attribute": "finesse",
            "dc": 12,
            "halfOnSuccess": true
        },
        "description": "The flames sear your flesh."
    }
}
```

### 7.2 Trigger Types

| Trigger | When Applied | Examples |
|---------|--------------|----------|
| `OnEntry` | When stepping onto tile | Spike trap, fire, caltrops |
| `PerTurn` | Each turn while on tile | Lava, acid pool, poison gas |
| `OnExit` | When leaving tile | Tar pit, sticky web, quicksand |

**Behavior Notes:**
- `OnEntry` triggers once per movement into tile
- `PerTurn` triggers at start of turn if character is on tile
- `OnExit` triggers when character attempts to leave tile
- Multiple hazards can apply if terrain has multiple effects

### 7.3 Saving Throw Configuration

The `SavingThrow` object defines an optional check to reduce or avoid damage.

```json
"SavingThrow": {
    "type": "object",
    "description": "Saving throw configuration for hazard avoidance",
    "properties": {
        "attribute": {
            "type": "string",
            "description": "Attribute used for the saving throw",
            "enum": ["might", "fortitude", "will", "wits", "finesse"]
        },
        "dc": {
            "type": "integer",
            "description": "Difficulty class for the saving throw",
            "minimum": 1
        },
        "halfOnSuccess": {
            "type": "boolean",
            "description": "Whether success reduces damage to half instead of negating it",
            "default": true
        }
    },
    "required": ["attribute", "dc"]
}
```

| Attribute | Use Case |
|-----------|----------|
| `might` | Physical hazards requiring brute force to escape |
| `fortitude` | Resisting poison, disease, extreme temperatures |
| `will` | Mental effects, fear, psychic damage |
| `wits` | Noticing traps, quick reactions to danger |
| `finesse` | Dodging, acrobatic avoidance |

**Behavior:**
- Roll >= DC: Success (half damage if `halfOnSuccess: true`, no damage if false)
- Roll < DC: Failure (full damage)
- Omit `savingThrow` for unavoidable hazards

---

## 8. Status Effect Application

### 8.1 Status Effect Reference

The `appliesStatusEffect` field references a status effect ID from status effects configuration.

```json
"appliesStatusEffect": {
    "type": "string",
    "description": "Status effect ID applied when entering this terrain",
    "pattern": "^[a-z][a-z0-9-]*$"
}
```

**Example Status Effects:**
| Effect ID | Description | Typical Source |
|-----------|-------------|----------------|
| `burning` | Ongoing fire damage | Fire, lava terrain |
| `poisoned` | Ongoing poison damage | Poison gas, toxic pools |
| `chilled` | Reduced movement speed | Frozen ground, cold areas |
| `corroding` | Equipment damage | Acid pools |
| `slowed` | Movement penalty | Mud, tar, webs |
| `blinded` | Cannot see | Bright light, darkness |

### 8.2 Application Chance

The `statusEffectChance` field controls the probability of status effect application.

```json
"statusEffectChance": {
    "type": "number",
    "description": "Probability of applying status effect (0.0 to 1.0)",
    "minimum": 0,
    "maximum": 1,
    "default": 1.0
}
```

| Value | Probability | Typical Usage |
|-------|-------------|---------------|
| `1.0` | 100% | Guaranteed effect (lava → burning) |
| `0.75` | 75% | High chance (acid → corroding) |
| `0.50` | 50% | Moderate chance (fire → burning) |
| `0.25` | 25% | Low chance (mud → slowed) |
| `0.0` | Never | Effect disabled |

**Application Logic:**
1. Character enters terrain
2. If `appliesStatusEffect` is defined
3. Roll random 0.0-1.0
4. If roll < `statusEffectChance`, apply status effect
5. Status effect duration defined in status-effects.json

---

## 9. Terrain Tags and Biome Associations

### 9.1 Terrain Tags

The `tags` array enables categorical filtering of terrain types.

```json
"tags": {
    "type": "array",
    "description": "Categorical tags for filtering terrain types",
    "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]*$"
    }
}
```

**Standard Tags:**

| Category | Tags |
|----------|------|
| Type | `hazardous`, `difficult`, `impassable`, `normal`, `trap` |
| Material | `stone`, `water`, `ice`, `wood`, `metal`, `earth`, `lava` |
| Effect | `light-source`, `warm`, `cold`, `slippery`, `sticky`, `flammable` |
| Origin | `natural`, `constructed`, `magical` |

**Example Configuration:**
```json
{
    "id": "fire",
    "tags": ["hazardous", "fire", "light-source", "warm", "natural"]
}
```

**Usage:**
- Filter terrain for level generation
- Query terrain by properties
- Determine environmental interactions

### 9.2 Biome Associations

The `biomeAssociations` array defines which biomes commonly feature this terrain.

```json
"biomeAssociations": {
    "type": "array",
    "description": "Biome IDs where this terrain commonly appears",
    "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]*$"
    }
}
```

**Example Associations:**

| Terrain | Associated Biomes |
|---------|-------------------|
| `fire` | volcanic, dungeon |
| `lava` | volcanic |
| `shallow-water` | swamp, cave |
| `mud` | swamp, forest |
| `rubble` | ruins, dungeon, cave |
| `ice-floor` | frozen |
| `sand` | desert |

**Usage:**
- Level generator selects terrain appropriate for biome
- Validates terrain placement during map creation
- Enables biome-specific terrain pools

---

## 10. Enhanced Movement Cost Validation

The existing `movementCostMultiplier` field is enhanced with additional validation context.

```json
"movementCostMultiplier": {
    "type": "number",
    "description": "Movement cost multiplier (1.0 = normal, 2.0 = difficult, higher = harder)",
    "minimum": 0,
    "default": 1.0
}
```

**Movement Cost Guidelines:**

| Multiplier | Effect | Examples |
|------------|--------|----------|
| `0.0` | Impassable (use type: Impassable) | Walls, solid objects |
| `0.5` | Easy terrain (rare) | Magical speed boost |
| `1.0` | Normal movement | Stone floor, grass |
| `1.5` | Slightly difficult | Tall grass, light rubble |
| `2.0` | Difficult terrain | Rubble, shallow water, mud |
| `3.0` | Very difficult | Deep water, heavy debris |
| `4.0+` | Extremely difficult | Quicksand, dense vegetation |

**Calculation:**
```
Movement Points Required = Base Cost × movementCostMultiplier
```

**Note:** The schema validates `minimum: 0` but the type field (`Impassable`) is the preferred way to indicate impassable terrain rather than setting `movementCostMultiplier: 0`.

---

## 11. Validation Rules

### 11.1 ID Pattern Validation

| Property | Pattern | Description |
|----------|---------|-------------|
| `TerrainDefinition.id` | `^[a-z][a-z0-9-]*$` | Lowercase kebab-case |
| `appliesStatusEffect` | `^[a-z][a-z0-9-]*$` | Status effect reference |
| `hazardEffect.damageType` | `^[a-z][a-z0-9-]*$` | Damage type reference |
| `tags[]` | `^[a-z][a-z0-9-]*$` | Tag identifiers |
| `biomeAssociations[]` | `^[a-z][a-z0-9-]*$` | Biome references |

### 11.2 Range Validation

| Property | Range | Validation Error |
|----------|-------|------------------|
| `movementCostMultiplier` | >= 0 | "movementCostMultiplier must be >= 0" |
| `visibilityModifier` | 0-1 | "visibilityModifier must be between 0 and 1" |
| `statusEffectChance` | 0-1 | "statusEffectChance must be between 0 and 1" |
| `savingThrow.dc` | >= 1 | "dc must be >= 1" |

### 11.3 Enum Validation

| Enum | Values |
|------|--------|
| `type` | Normal, Difficult, Impassable, Hazardous |
| `coverLevel` | None, Half, ThreeQuarters, Full |
| `hazardEffect.triggerType` | OnEntry, PerTurn, OnExit |
| `savingThrow.attribute` | might, fortitude, will, wits, finesse |

### 11.4 Required Fields

| Definition | Required Fields |
|------------|-----------------|
| `TerrainDefinition` | id, name, type |
| `HazardEffect` | triggerType, damage, damageType |
| `SavingThrow` | attribute, dc |

---

## 12. Configuration Schema

### Complete Expanded Terrain Schema File

**File:** `config/schemas/terrain.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Terrain Configuration",
    "description": "Configuration schema for terrain definitions with cover, visibility, hazards, and status effects",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "terrainDefinitions": {
            "type": "array",
            "description": "List of terrain type definitions",
            "items": {
                "$ref": "#/definitions/TerrainDefinition"
            }
        }
    },
    "required": ["terrainDefinitions"],
    "definitions": {
        "TerrainDefinition": {
            "type": "object",
            "description": "A single terrain type definition with optional tactical properties",
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier for this terrain (lowercase kebab-case)",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "name": {
                    "type": "string",
                    "description": "Display name for the terrain"
                },
                "type": {
                    "type": "string",
                    "description": "Base terrain category",
                    "enum": ["Normal", "Difficult", "Impassable", "Hazardous"]
                },
                "movementCostMultiplier": {
                    "type": "number",
                    "description": "Movement cost multiplier (1.0 = normal)",
                    "minimum": 0,
                    "default": 1.0
                },
                "damageOnEntry": {
                    "type": "string",
                    "description": "Dice expression for hazard damage (legacy field, prefer hazardEffect)",
                    "pattern": "^[0-9]+d[0-9]+([+-][0-9]+)?$"
                },
                "damageType": {
                    "type": "string",
                    "description": "Damage type ID for hazardous terrain (legacy field)",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "blocksLOS": {
                    "type": "boolean",
                    "description": "Whether this terrain blocks line of sight completely",
                    "default": false
                },
                "displayChar": {
                    "type": "string",
                    "description": "ASCII character for grid display",
                    "minLength": 1,
                    "maxLength": 1,
                    "default": "."
                },
                "description": {
                    "type": "string",
                    "description": "Description for legends and tooltips"
                },
                "coverLevel": {
                    "type": "string",
                    "description": "Level of cover provided by this terrain",
                    "enum": ["None", "Half", "ThreeQuarters", "Full"],
                    "default": "None"
                },
                "visibilityModifier": {
                    "type": "number",
                    "description": "Visibility through this terrain (0.0 = opaque, 1.0 = clear)",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 1.0
                },
                "providesConcealment": {
                    "type": "boolean",
                    "description": "Whether this terrain allows characters to hide",
                    "default": false
                },
                "hazardEffect": {
                    "$ref": "#/definitions/HazardEffect",
                    "description": "Detailed hazard configuration (alternative to damageOnEntry)"
                },
                "appliesStatusEffect": {
                    "type": "string",
                    "description": "Status effect ID applied when entering this terrain",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "statusEffectChance": {
                    "type": "number",
                    "description": "Probability of applying status effect (0.0 to 1.0)",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 1.0
                },
                "tags": {
                    "type": "array",
                    "description": "Categorical tags for filtering terrain types",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    }
                },
                "biomeAssociations": {
                    "type": "array",
                    "description": "Biome IDs where this terrain commonly appears",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    }
                }
            },
            "required": ["id", "name", "type"],
            "additionalProperties": false
        },
        "HazardEffect": {
            "type": "object",
            "description": "Detailed configuration for hazardous terrain effects",
            "properties": {
                "triggerType": {
                    "type": "string",
                    "description": "When the hazard effect triggers",
                    "enum": ["OnEntry", "PerTurn", "OnExit"]
                },
                "damage": {
                    "type": "string",
                    "description": "Dice expression for damage (e.g., '1d6', '2d4+2')",
                    "pattern": "^[0-9]+d[0-9]+([+-][0-9]+)?$"
                },
                "damageType": {
                    "type": "string",
                    "description": "Damage type ID (e.g., 'fire', 'acid', 'piercing')",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "savingThrow": {
                    "$ref": "#/definitions/SavingThrow",
                    "description": "Optional saving throw to reduce or avoid damage"
                },
                "description": {
                    "type": "string",
                    "description": "Flavor text displayed when hazard triggers"
                }
            },
            "required": ["triggerType", "damage", "damageType"],
            "additionalProperties": false
        },
        "SavingThrow": {
            "type": "object",
            "description": "Saving throw configuration for hazard avoidance",
            "properties": {
                "attribute": {
                    "type": "string",
                    "description": "Attribute used for the saving throw",
                    "enum": ["might", "fortitude", "will", "wits", "finesse"]
                },
                "dc": {
                    "type": "integer",
                    "description": "Difficulty class for the saving throw",
                    "minimum": 1
                },
                "halfOnSuccess": {
                    "type": "boolean",
                    "description": "Whether success reduces damage to half instead of negating it",
                    "default": true
                }
            },
            "required": ["attribute", "dc"],
            "additionalProperties": false
        }
    }
}
```

---

## 13. Configuration File Updates

### Existing terrain.json (No Changes Required)

The existing `terrain.json` remains valid because all new properties are optional. The schema expansion is fully backward compatible.

**File:** `config/terrain.json` (current state)

```json
{
    "$schema": "./schemas/terrain.schema.json",
    "terrainDefinitions": [
        {
            "id": "normal-floor",
            "name": "Stone Floor",
            "type": "Normal",
            "movementCostMultiplier": 1.0,
            "displayChar": ".",
            "description": "Normal stone floor"
        },
        {
            "id": "rubble",
            "name": "Rubble",
            "type": "Difficult",
            "movementCostMultiplier": 2.0,
            "displayChar": "~",
            "description": "Difficult terrain - 2x movement cost"
        },
        {
            "id": "shallow-water",
            "name": "Shallow Water",
            "type": "Difficult",
            "movementCostMultiplier": 2.0,
            "displayChar": "≈",
            "description": "Shallow water - 2x movement cost"
        },
        {
            "id": "mud",
            "name": "Thick Mud",
            "type": "Difficult",
            "movementCostMultiplier": 2.0,
            "displayChar": "~",
            "description": "Thick mud - 2x movement cost"
        },
        {
            "id": "pit",
            "name": "Pit",
            "type": "Impassable",
            "displayChar": "○",
            "description": "Deep pit - impassable"
        },
        {
            "id": "wall",
            "name": "Wall",
            "type": "Impassable",
            "blocksLOS": true,
            "displayChar": "#",
            "description": "Solid wall - impassable, blocks LOS"
        },
        {
            "id": "fire",
            "name": "Fire",
            "type": "Hazardous",
            "movementCostMultiplier": 1.0,
            "damageOnEntry": "1d6",
            "damageType": "fire",
            "displayChar": "▲",
            "description": "Flames - 1d6 fire damage on entry"
        },
        {
            "id": "acid-pool",
            "name": "Acid Pool",
            "type": "Hazardous",
            "movementCostMultiplier": 1.5,
            "damageOnEntry": "1d4",
            "damageType": "acid",
            "displayChar": "●",
            "description": "Acid pool - 1d4 acid damage on entry"
        },
        {
            "id": "spike-trap",
            "name": "Spike Trap",
            "type": "Hazardous",
            "movementCostMultiplier": 1.0,
            "damageOnEntry": "1d8",
            "damageType": "piercing",
            "displayChar": "^",
            "description": "Spike trap - 1d8 piercing damage on entry"
        },
        {
            "id": "lava",
            "name": "Lava",
            "type": "Hazardous",
            "movementCostMultiplier": 1.0,
            "damageOnEntry": "2d6",
            "damageType": "fire",
            "displayChar": "▓",
            "description": "Molten lava - 2d6 fire damage on entry"
        }
    ]
}
```

### Example Enhanced terrain.json (Optional Update)

If users choose to utilize the new features, terrain definitions can be enhanced:

```json
{
    "id": "fire",
    "name": "Fire",
    "type": "Hazardous",
    "movementCostMultiplier": 1.0,
    "displayChar": "▲",
    "description": "Flames - 1d6 fire damage on entry",
    "coverLevel": "None",
    "visibilityModifier": 0.8,
    "providesConcealment": false,
    "hazardEffect": {
        "triggerType": "OnEntry",
        "damage": "1d6",
        "damageType": "fire",
        "savingThrow": {
            "attribute": "finesse",
            "dc": 12,
            "halfOnSuccess": true
        },
        "description": "The flames sear your flesh."
    },
    "appliesStatusEffect": "burning",
    "statusEffectChance": 0.5,
    "tags": ["hazardous", "fire", "light-source", "warm"],
    "biomeAssociations": ["volcanic", "dungeon"]
}
```

---

## 14. Data Model Changes

### No Domain Changes Required

This phase expands only the JSON Schema file. The existing configuration file remains valid. No changes to domain entities, services, or application layer are required.

| Layer | Changes |
|-------|---------|
| Domain | None |
| Application | None |
| Infrastructure | None |
| Configuration | One schema file expanded |

### Schema as Documentation

The expanded schema serves as:
- **Validation contract** for terrain configuration
- **IDE documentation** via description fields
- **Modding reference** for custom terrain creation
- **Design specification** for tactical terrain mechanics

---

## 15. Logging Specifications

### No Runtime Logging Required

Schema validation occurs at design-time in IDE/editors, not at runtime. No logging infrastructure changes are needed for this phase.

| Component | Level | Events |
|-----------|-------|--------|
| N/A | N/A | Schema validation is IDE-based |

---

## 16. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Schema Valid Structure | ~1 |
| Cover Level Enum Validation | ~1 |
| Visibility Modifier Range Validation | ~1 |
| Hazard Effect Validation | ~1 |
| Existing Configuration Validation | ~1 |
| **Total** | **~5** |

### Test Descriptions

#### TerrainSchemaTests.cs

```csharp
[TestFixture]
public class TerrainSchemaTests
{
    /// <summary>
    /// Verifies the expanded schema file is valid JSON Schema Draft-07.
    /// </summary>
    [Test]
    public void Schema_IsValidJsonSchemaDraft07();

    /// <summary>
    /// Verifies the existing terrain.json validates against the expanded schema
    /// without errors (backward compatibility).
    /// </summary>
    [Test]
    public void TerrainJson_ValidatesAgainstExpandedSchema();

    /// <summary>
    /// Verifies coverLevel must be one of the valid enum values.
    /// </summary>
    [Test]
    public void CoverLevel_InvalidEnum_FailsValidation();

    /// <summary>
    /// Verifies visibilityModifier must be between 0 and 1.
    /// </summary>
    [Test]
    public void VisibilityModifier_OutOfRange_FailsValidation();

    /// <summary>
    /// Verifies hazardEffect.triggerType must be one of the valid enum values.
    /// </summary>
    [Test]
    public void HazardEffectTriggerType_InvalidEnum_FailsValidation();
}
```

### Test Implementation Notes

Tests should use a JSON Schema validation library (e.g., `NJsonSchema` for C#) to:
1. Load the expanded schema file
2. Validate test JSON documents
3. Assert expected validation results
4. Verify backward compatibility with existing terrain.json

---

## 17. Use Cases

### UC-001: Load Terrain Configuration

**Actor:** Game System
**Flow:** System starts -> Loads `terrain.json` -> Schema validates content -> Terrain types available for level generation

### UC-002: Edit Terrain in IDE

**Actor:** Developer/Modder
**Flow:** Opens `terrain.json` in VS Code -> IDE loads schema -> Autocomplete suggests new properties (coverLevel, hazardEffect, etc.) -> Validation errors shown inline

### UC-003: Add Cover to Terrain

**Actor:** Modder
**Flow:** Adds `coverLevel: "Half"` to rubble terrain -> IDE validates enum -> Terrain provides defensive cover in combat

### UC-004: Configure Hazard Effect

**Actor:** Modder
**Flow:** Adds `hazardEffect` object to fire terrain -> Sets triggerType, damage, damageType -> Optionally adds savingThrow -> IDE validates structure

### UC-005: Apply Status Effect

**Actor:** Modder
**Flow:** Adds `appliesStatusEffect: "burning"` to fire terrain -> Sets `statusEffectChance: 0.5` -> Entering fire has 50% chance to apply burning status

### UC-006: Invalid Visibility Modifier

**Actor:** Modder
**Flow:** Sets `visibilityModifier: 1.5` (invalid, > 1.0) -> IDE shows error "visibilityModifier must be between 0 and 1" -> Modder corrects to valid value

---

## 18. Deliverable Checklist

### Schema Files
- [ ] `config/schemas/terrain.schema.json` expanded
- [ ] Schema follows JSON Schema Draft-07 format
- [ ] Schema includes 3 definitions (TerrainDefinition expanded, HazardEffect, SavingThrow)

### Validation Rules
- [ ] Cover level enum validation: None, Half, ThreeQuarters, Full
- [ ] Visibility modifier range validation: 0-1
- [ ] Hazard trigger type enum validation: OnEntry, PerTurn, OnExit
- [ ] Saving throw attribute enum validation: 5 values
- [ ] Status effect chance range validation: 0-1
- [ ] Dice expression pattern validation
- [ ] ID pattern validation for all references

### Configuration Files
- [ ] Existing `terrain.json` validates against expanded schema (backward compatible)
- [ ] All 10 existing terrain types remain valid

### Testing
- [ ] ~5 unit tests implemented
- [ ] All tests passing
- [ ] Tests cover enum validation and range validation

### Documentation
- [ ] Schema properties have descriptions
- [ ] This design specification complete

---

## 19. Acceptance Criteria

### Functional
- [ ] `terrain.schema.json` expanded in `config/schemas/` directory
- [ ] Schema validates existing `terrain.json` without errors
- [ ] Cover level enum validated (None, Half, ThreeQuarters, Full)
- [ ] Visibility modifier validated (0.0 to 1.0)
- [ ] Provides concealment validated as boolean
- [ ] Hazard effect validated with trigger types
- [ ] Damage dice expression validated
- [ ] Saving throw validated with attribute enum
- [ ] Status effect reference validated as string
- [ ] Status effect chance validated (0.0 to 1.0)
- [ ] Tags validated as string array
- [ ] Biome associations validated as string array
- [ ] Backward compatible with existing terrain definitions
- [ ] VS Code provides autocomplete for new properties

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~5 unit tests pass
- [ ] Schema file is valid JSON
- [ ] All schema properties have descriptions

---

## 20. Dependencies

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `terrain.schema.json` | `config/schemas/` | Base schema to expand |
| `terrain.json` | `config/` | Existing config for backward compatibility testing |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| Expanded `terrain.schema.json` | Validates terrain configuration with tactical features |
| Cover level enum | Used by combat system for defense bonuses |
| Visibility modifier | Used by LOS calculations |
| HazardEffect definition | Referenced by hazard processing |
| SavingThrow definition | Potentially shared with other schemas |
| Terrain tags | Used for terrain filtering and queries |
| Biome associations | Used by level generator for terrain selection |

### Implementation Order Note

**v0.14.4c can be implemented in parallel with v0.14.4a, v0.14.4b, and v0.14.4d** as they have no internal dependencies within v0.14.4.

---

## 21. Future Considerations

### Deferred to Future Versions

- **Cross-reference validation**: Validating biomeAssociations exist in biomes.json
- **Cross-reference validation**: Validating appliesStatusEffect exists in status-effects.json
- **Cross-reference validation**: Validating damageType exists in damage-types configuration
- **Cover calculation logic**: Runtime defense bonus application (domain logic)
- **Visibility calculation logic**: Runtime LOS computation (domain logic)
- **Hazard processing logic**: Runtime hazard trigger execution (domain logic)
- **Status effect application logic**: Runtime status application (domain logic)

### Out of Scope

- **Biome schema** (v0.14.4a) - Biomes referenced by associations
- **Room type schema** (v0.14.4b) - Room types that may contain terrain
- **Interactive object schema** (v0.14.4d) - Objects placed on terrain
- **Runtime terrain processing**: Application-level terrain mechanics
- **Terrain balance tuning**: Specific multiplier and damage values

### Potential Future Enhancements

If the terrain system expands, consider adding to the schema:

**Terrain Transformation:**
```json
"transformsTo": {
    "type": "object",
    "description": "Terrain transformation after trigger",
    "properties": {
        "terrainId": { "type": "string" },
        "triggerCondition": { "type": "string" },
        "delay": { "type": "integer" }
    }
}
```

**Environmental Sounds:**
```json
"ambientSound": {
    "type": "string",
    "description": "Sound effect ID for this terrain type",
    "pattern": "^[a-z][a-z0-9-]*$"
}
```

**Movement Sound:**
```json
"movementSound": {
    "type": "string",
    "description": "Sound effect ID when moving on this terrain",
    "pattern": "^[a-z][a-z0-9-]*$"
}
```

**Terrain Elevation:**
```json
"elevation": {
    "type": "integer",
    "description": "Height level for multi-level terrain",
    "minimum": -10,
    "maximum": 10,
    "default": 0
}
```

**Passability Conditions:**
```json
"passableBy": {
    "type": "array",
    "description": "Entity types that can pass through impassable terrain",
    "items": {
        "type": "string",
        "enum": ["flying", "ethereal", "swimming", "climbing"]
    }
}
```

**Weather Interaction:**
```json
"weatherInteraction": {
    "type": "object",
    "description": "How weather affects this terrain",
    "properties": {
        "rain": { "type": "string" },
        "snow": { "type": "string" },
        "heat": { "type": "string" }
    }
}
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-17*
*Author: Claude*
