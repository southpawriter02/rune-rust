# v0.19.6 Scope Breakdown: Biome Integration & Transitions

## Overview

v0.19.6 completes the biome system by implementing **cross-biome integration mechanics**:

- Transition zone generation between adjacent biomes
- Environmental property interpolation
- Multi-biome sector assignment
- Route classification and travel time calculations
- Biome validation services

This version ensures seamless transitions between all implemented realms.

---

## In Scope

### Transition Zone Generation

| Component | Purpose |
|-----------|---------|
| `TransitionZone` entity | Blended biome room properties |
| `ITransitionGenerator` | Creates transition room sequences |
| Blend ratio interpolation | Smooth property gradients |
| Transition theme descriptions | Narrative text for transitions |

### Environmental Property Interpolation

| Component | Purpose |
|-----------|---------|
| `InterpolatedProperties` | Calculated blended properties |
| `IPropertyInterpolator` | Linear interpolation service |
| Zone modifier application | DC/damage adjustments |
| Multi-condition handling | Blended hazard effects |

### Multi-Biome Sector Generation

| Component | Purpose |
|-----------|---------|
| `SectorBiomeAssignment` | Biome assignment per sector |
| `IBiomeSectorService` | Validates and assigns biomes to sectors |
| Z-level boundary calculation | Vertical biome boundaries |
| Adjacency enforcement | Prevents invalid combinations |

### Route Classification

| Component | Purpose |
|-----------|---------|
| `RouteClassification` | B/C/D class routes |
| `IRouteCalculator` | Travel time and hazard calculation |
| Choke point definitions | Critical navigation points |
| Inter-realm connections | Cross-biome travel paths |

---

## Out of Scope (Deferred)

- Dynamic biome boundary shifting
- Weather system integration
- Seasonal biome changes
- Player-caused biome alterations

---

## Transition Zone Specifications

### TransitionZone Entity

| Property | Description |
|----------|-------------|
| Primary Biome | Source biome for transition |
| Secondary Biome | Target biome for transition |
| Blend Ratio | 0.0 (primary) to 1.0 (secondary) |
| Room Count | Number of rooms in transition |
| Theme | Narrative description |

### Blend Ratio Distribution

| Room Position | Blend Ratio |
|---------------|-------------|
| First room | 0.25 |
| Middle room | 0.50 |
| Last room | 0.75 |
| Next room | 1.0 (full secondary) |

### Transition Themes (from biomes-overview.md)

| From → To | Theme |
|-----------|-------|
| Midgard → Vanaheim | "Up-river ferries... canopy shadows deepen... golden spores drift" |
| Midgard → Niflheim | "Ice gives way to hardy scrubland... Ridge Hold watch-fires visible" |
| Svartalfheim → Muspelheim | "Volcanic heat fades into geothermal stability... Dvergr trade routes" |
| Svartalfheim → Helheim | "The elevator descends... decontamination airlocks seal" |
| Jötunheim → Vanaheim | "Titanic machinery yields to titanic vegetation" |
| Alfheim → Asgard | "Reality distortion stabilizes into pristine perfection" |

---

## Domain Layer Specifications

### TransitionZone Entity

```csharp
/// <summary>
/// Represents a transition zone between two biomes.
/// </summary>
public sealed class TransitionZone
{
    /// <summary>Unique transition zone identifier.</summary>
    public required Guid Id { get; init; }

    /// <summary>Primary (source) biome.</summary>
    public required RealmId PrimaryBiome { get; init; }

    /// <summary>Secondary (target) biome.</summary>
    public required RealmId SecondaryBiome { get; init; }

    /// <summary>Blend ratio (0.0 = primary, 1.0 = secondary).</summary>
    public required float BlendRatio { get; init; }

    /// <summary>Interpolated environmental properties.</summary>
    public required BiomeProperties InterpolatedProperties { get; init; }

    /// <summary>Active environmental conditions (may be blended).</summary>
    public IReadOnlyList<EnvironmentalConditionType> ActiveConditions { get; init; } = [];

    /// <summary>Narrative theme description.</summary>
    public string? ThemeDescription { get; init; }
}
```

### TransitionSequence Value Object

```csharp
/// <summary>
/// Sequence of transition rooms between biomes.
/// </summary>
public sealed record TransitionSequence
{
    /// <summary>Source biome.</summary>
    public required RealmId FromBiome { get; init; }

    /// <summary>Target biome.</summary>
    public required RealmId ToBiome { get; init; }

    /// <summary>Ordered list of transition zones.</summary>
    public required IReadOnlyList<TransitionZone> Zones { get; init; }

    /// <summary>Total room count in sequence.</summary>
    public int RoomCount => Zones.Count;

    /// <summary>Transition theme narrative.</summary>
    public required string TransitionTheme { get; init; }
}
```

### InterpolatedProperties Value Object

```csharp
/// <summary>
/// Interpolated biome properties at a specific blend ratio.
/// </summary>
public sealed record InterpolatedProperties
{
    /// <summary>Blend ratio used for interpolation.</summary>
    public required float BlendRatio { get; init; }

    /// <summary>Interpolated temperature.</summary>
    public required int TemperatureCelsius { get; init; }

    /// <summary>Interpolated aetheric intensity.</summary>
    public required float AethericIntensity { get; init; }

    /// <summary>Interpolated humidity.</summary>
    public required int HumidityPercent { get; init; }

    /// <summary>Interpolated light level.</summary>
    public required float LightLevel { get; init; }

    /// <summary>Interpolated scale factor.</summary>
    public required float ScaleFactor { get; init; }

    /// <summary>Interpolated corrosion rate.</summary>
    public required float CorrosionRate { get; init; }
}
```

### RouteClassification Enum

```csharp
/// <summary>
/// Route classification for inter-realm travel.
/// </summary>
public enum RouteClassification
{
    /// <summary>Class B — Maintained routes; fast travel; minimal hazard.</summary>
    B,

    /// <summary>Class C — Known routes; moderate speed; some hazard.</summary>
    C,

    /// <summary>Class D — Extreme hazard corridors; slow; high danger.</summary>
    D
}
```

### InterRealmRoute Value Object

```csharp
/// <summary>
/// Defines a route between two realms.
/// </summary>
public sealed record InterRealmRoute
{
    /// <summary>Source realm.</summary>
    public required RealmId FromRealm { get; init; }

    /// <summary>Destination realm.</summary>
    public required RealmId ToRealm { get; init; }

    /// <summary>Route classification.</summary>
    public required RouteClassification Classification { get; init; }

    /// <summary>Base travel time in days.</summary>
    public required int BaseTravelDays { get; init; }

    /// <summary>Maximum travel time in days.</summary>
    public required int MaxTravelDays { get; init; }

    /// <summary>Route description.</summary>
    public required string Description { get; init; }

    /// <summary>Special requirements (e.g., "Safe-conduct writ required").</summary>
    public IReadOnlyList<string> Requirements { get; init; } = [];

    /// <summary>Whether this route is currently accessible.</summary>
    public bool IsAccessible { get; init; } = true;
}
```

### ChokePoint Value Object

```csharp
/// <summary>
/// Critical navigation point between realms.
/// </summary>
public sealed record ChokePoint
{
    /// <summary>Choke point identifier (e.g., "CP-HEL-001").</summary>
    public required string Id { get; init; }

    /// <summary>Location name.</summary>
    public required string Name { get; init; }

    /// <summary>Associated realm.</summary>
    public required RealmId Realm { get; init; }

    /// <summary>Connected realms via this choke point.</summary>
    public required IReadOnlyList<RealmId> ConnectedRealms { get; init; }

    /// <summary>Controlling faction (if any).</summary>
    public string? ControllingFaction { get; init; }

    /// <summary>Required processing (e.g., "Decontamination").</summary>
    public IReadOnlyList<string> RequiredProcessing { get; init; } = [];
}
```

### SectorBiomeAssignment Value Object

```csharp
/// <summary>
/// Biome assignment for a dungeon sector.
/// </summary>
public sealed record SectorBiomeAssignment
{
    /// <summary>Sector identifier.</summary>
    public required Guid SectorId { get; init; }

    /// <summary>Primary biome for the sector.</summary>
    public required RealmId PrimaryBiome { get; init; }

    /// <summary>Secondary biome (if multi-biome sector).</summary>
    public RealmId? SecondaryBiome { get; init; }

    /// <summary>Z-level where biome transition occurs.</summary>
    public int? TransitionZLevel { get; init; }

    /// <summary>Generated transition sequence (if applicable).</summary>
    public TransitionSequence? TransitionSequence { get; init; }

    /// <summary>Whether this is a valid configuration.</summary>
    public bool IsValid { get; init; } = true;

    /// <summary>Validation errors (if any).</summary>
    public IReadOnlyList<string> ValidationErrors { get; init; } = [];
}
```

---

## Application Layer Specifications

### ITransitionGenerator Interface

```csharp
/// <summary>
/// Generates transition zones between biomes.
/// </summary>
public interface ITransitionGenerator
{
    /// <summary>Generates a transition sequence between two biomes.</summary>
    TransitionSequence GenerateTransition(
        RealmId fromBiome,
        RealmId toBiome,
        int roomCount,
        Random? rng = null);

    /// <summary>Creates a single transition zone at a specific blend ratio.</summary>
    TransitionZone CreateTransitionZone(
        RealmId primaryBiome,
        RealmId secondaryBiome,
        float blendRatio);

    /// <summary>Gets the transition theme for a biome pair.</summary>
    string GetTransitionTheme(RealmId fromBiome, RealmId toBiome);

    /// <summary>Calculates recommended room count for a transition.</summary>
    int CalculateTransitionRoomCount(RealmId fromBiome, RealmId toBiome);
}
```

### IPropertyInterpolator Interface

```csharp
/// <summary>
/// Interpolates environmental properties between biomes.
/// </summary>
public interface IPropertyInterpolator
{
    /// <summary>Interpolates properties at a specific blend ratio.</summary>
    InterpolatedProperties Interpolate(
        BiomeProperties primary,
        BiomeProperties secondary,
        float blendRatio);

    /// <summary>Interpolates a single property value.</summary>
    float InterpolateValue(float primaryValue, float secondaryValue, float blendRatio);

    /// <summary>Determines active conditions in a blended zone.</summary>
    IReadOnlyList<EnvironmentalConditionType> GetBlendedConditions(
        EnvironmentalConditionType? primaryCondition,
        EnvironmentalConditionType? secondaryCondition,
        float blendRatio);
}
```

### IBiomeSectorService Interface

```csharp
/// <summary>
/// Manages biome assignment for dungeon sectors.
/// </summary>
public interface IBiomeSectorService
{
    /// <summary>Assigns biomes to a sector.</summary>
    SectorBiomeAssignment AssignBiomes(
        Guid sectorId,
        RealmId primaryBiome,
        RealmId? secondaryBiome = null,
        int? transitionZLevel = null);

    /// <summary>Validates a sector's biome configuration.</summary>
    bool ValidateSectorConfiguration(SectorBiomeAssignment assignment);

    /// <summary>Gets rooms that should be in transition zones.</summary>
    IReadOnlyList<Guid> GetTransitionRoomIds(
        SectorBiomeAssignment assignment,
        IReadOnlyList<(Guid RoomId, int ZLevel)> rooms);

    /// <summary>Calculates Z-level boundary for multi-biome sectors.</summary>
    int CalculateTransitionBoundary(
        RealmId primaryBiome,
        RealmId secondaryBiome,
        int minZLevel,
        int maxZLevel);
}
```

### IRouteCalculator Interface

```csharp
/// <summary>
/// Calculates travel routes and times between realms.
/// </summary>
public interface IRouteCalculator
{
    /// <summary>Gets available routes from a realm.</summary>
    IReadOnlyList<InterRealmRoute> GetRoutesFrom(RealmId realm);

    /// <summary>Gets a specific route between realms.</summary>
    InterRealmRoute? GetRoute(RealmId from, RealmId to);

    /// <summary>Calculates actual travel time with modifiers.</summary>
    TravelTimeResult CalculateTravelTime(
        RealmId from,
        RealmId to,
        IReadOnlyList<string> modifiers);

    /// <summary>Gets all choke points for a realm.</summary>
    IReadOnlyList<ChokePoint> GetChokePoints(RealmId realm);

    /// <summary>Validates that a travel path is accessible.</summary>
    bool ValidatePath(IReadOnlyList<RealmId> path);
}
```

### TravelTimeResult Record

```csharp
/// <summary>
/// Result of travel time calculation.
/// </summary>
public sealed record TravelTimeResult
{
    /// <summary>Source realm.</summary>
    public required RealmId FromRealm { get; init; }

    /// <summary>Destination realm.</summary>
    public required RealmId ToRealm { get; init; }

    /// <summary>Route classification.</summary>
    public required RouteClassification Classification { get; init; }

    /// <summary>Calculated travel time in days.</summary>
    public required int TravelDays { get; init; }

    /// <summary>Applied modifiers.</summary>
    public IReadOnlyList<string> AppliedModifiers { get; init; } = [];

    /// <summary>Hazards encountered on route.</summary>
    public IReadOnlyList<string> RouteHazards { get; init; } = [];

    /// <summary>Choke points along the route.</summary>
    public IReadOnlyList<ChokePoint> ChokePoints { get; init; } = [];
}
```

---

## Configuration Specifications

### routes.json

```json
{
  "routes": [
    {
      "fromRealm": "Midgard",
      "toRealm": "Vanaheim",
      "classification": "B",
      "baseTravelDays": 6,
      "maxTravelDays": 9,
      "description": "Up-River Ferry through the Greatwood",
      "requirements": []
    },
    {
      "fromRealm": "Midgard",
      "toRealm": "Jotunheim",
      "classification": "C",
      "baseTravelDays": 4,
      "maxTravelDays": 7,
      "description": "Utgard Gates industrial access",
      "requirements": []
    },
    {
      "fromRealm": "Midgard",
      "toRealm": "Asgard",
      "classification": "D",
      "baseTravelDays": 3,
      "maxTravelDays": 5,
      "description": "Scar Rim Lifts to orbital structure",
      "requirements": ["Safe-conduct writ at Perimeter Gate"]
    },
    {
      "fromRealm": "Svartalfheim",
      "toRealm": "Helheim",
      "classification": "B",
      "baseTravelDays": 1,
      "maxTravelDays": 2,
      "description": "Garm's Watch elevator shaft",
      "requirements": ["Decontamination processing"]
    },
    {
      "fromRealm": "Svartalfheim",
      "toRealm": "Muspelheim",
      "classification": "C",
      "baseTravelDays": 4,
      "maxTravelDays": 6,
      "description": "Geothermal link to Hearth-Clans",
      "requirements": []
    },
    {
      "fromRealm": "Svartalfheim",
      "toRealm": "Jotunheim",
      "classification": "C",
      "baseTravelDays": 6,
      "maxTravelDays": 8,
      "description": "Trade routes through industrial corridors",
      "requirements": []
    }
  ],
  "chokePoints": [
    {
      "id": "CP-HEL-001",
      "name": "Garm's Watch",
      "realm": "Helheim",
      "connectedRealms": ["Svartalfheim"],
      "controllingFaction": "Dvergr",
      "requiredProcessing": ["Decontamination"]
    },
    {
      "id": "CP-ASG-001",
      "name": "Scar Rim Lifts",
      "realm": "Asgard",
      "connectedRealms": ["Midgard"],
      "controllingFaction": "Iron-Banes",
      "requiredProcessing": ["Safe-conduct writ"]
    },
    {
      "id": "CP-MID-001",
      "name": "Utgard Gates",
      "realm": "Midgard",
      "connectedRealms": ["Jotunheim"],
      "controllingFaction": null,
      "requiredProcessing": []
    }
  ]
}
```

### transition_themes.json

```json
{
  "themes": [
    {
      "from": "Midgard",
      "to": "Vanaheim",
      "theme": "Up-river ferries carry you deeper into shadow. Canopy shadows deepen overhead. Golden spores drift on humid wind.",
      "minRooms": 1,
      "maxRooms": 2
    },
    {
      "from": "Midgard",
      "to": "Niflheim",
      "theme": "Ice gives way to hardy scrubland. Ridge Hold watch-fires flicker in the distance below. The cold deepens.",
      "minRooms": 2,
      "maxRooms": 3
    },
    {
      "from": "Svartalfheim",
      "to": "Muspelheim",
      "theme": "Volcanic heat fades into geothermal stability. Dvergr trade routes begin. The clang of forges grows louder.",
      "minRooms": 1,
      "maxRooms": 2
    },
    {
      "from": "Svartalfheim",
      "to": "Helheim",
      "theme": "The elevator descends. Decontamination airlocks seal behind you. Garm's Watch looms in the toxic mist.",
      "minRooms": 1,
      "maxRooms": 2
    },
    {
      "from": "Jotunheim",
      "to": "Vanaheim",
      "theme": "Titanic machinery yields to titanic vegetation. Vines thick as corridors wind through rusted gears.",
      "minRooms": 2,
      "maxRooms": 3
    },
    {
      "from": "Alfheim",
      "to": "Asgard",
      "theme": "Reality distortion stabilizes into pristine perfection. The Glimmer fades. The silence of the Spire begins.",
      "minRooms": 2,
      "maxRooms": 3
    }
  ]
}
```

---

## Unit Testing Requirements

### Transition Generator Tests (~5 tests)

| Test | Description |
|------|-------------|
| `GenerateTransition_ValidBiomes_ReturnsSequence` | Creates transition sequence |
| `GenerateTransition_IncompatibleBiomes_ThrowsException` | Rejects Muspelheim→Niflheim |
| `CreateTransitionZone_BlendRatio50_InterpolatesCorrectly` | Midpoint interpolation |
| `GetTransitionTheme_MidgardVanaheim_ReturnsTheme` | Theme retrieval |
| `CalculateTransitionRoomCount_RequiresTransition_ReturnsRange` | Room count calculation |

### Property Interpolator Tests (~4 tests)

| Test | Description |
|------|-------------|
| `Interpolate_BlendRatio0_ReturnsPrimary` | 0.0 = full primary |
| `Interpolate_BlendRatio1_ReturnsSecondary` | 1.0 = full secondary |
| `InterpolateValue_Midpoint_ReturnsAverage` | Linear interpolation |
| `GetBlendedConditions_DifferentConditions_ReturnsBoth` | Condition blending |

### Sector Service Tests (~4 tests)

| Test | Description |
|------|-------------|
| `AssignBiomes_SingleBiome_ReturnsValid` | Single biome assignment |
| `AssignBiomes_MultiBiome_CreatesTransition` | Multi-biome with transition |
| `ValidateSectorConfiguration_InvalidPair_ReturnsFalse` | Rejects invalid configs |
| `CalculateTransitionBoundary_ReturnsValidZLevel` | Z-level calculation |

### Route Calculator Tests (~4 tests)

| Test | Description |
|------|-------------|
| `GetRoutesFrom_Midgard_ReturnsMultipleRoutes` | Available routes |
| `GetRoute_MidgardAsgard_ReturnsClassD` | Route classification |
| `CalculateTravelTime_WithModifiers_AdjustsTime` | Modifier application |
| `GetChokePoints_Helheim_ReturnsGarmsWatch` | Choke point retrieval |

**Total: ~15 tests** (17 noted but adjusted for actual scope)

---

## Acceptance Criteria

### Functional Requirements

- [ ] Transition zones generate between compatible biomes
- [ ] Incompatible biomes (Muspelheim↔Niflheim) reject transition generation
- [ ] Properties interpolate linearly at specified blend ratios
- [ ] Transition themes load and display correctly
- [ ] Multi-biome sectors calculate valid Z-level boundaries
- [ ] Route classification returns correct travel times
- [ ] Choke points list associated requirements
- [ ] Sector validation rejects invalid biome combinations

### Quality Requirements

- [ ] All public members have XML documentation
- [ ] Configuration validates against schema
- [ ] ~15 unit tests pass
- [ ] Integration with all v0.19.x realms verified

---

## Dependencies

### Required From v0.19.0-v0.19.5

| Dependency | Usage |
|------------|-------|
| `RealmId` enum | All realm identifiers |
| `BiomeDefinition` entities | All 9 realms |
| `BiomeProperties` value object | Interpolation source |
| `IBiomeAdjacencyService` | Compatibility checks |
| `EnvironmentalConditionType` | Condition blending |

### Provides To Future Versions

| Provides | Consumer |
|----------|----------|
| `TransitionSequence` | Room generation |
| `SectorBiomeAssignment` | Dungeon sector creation |
| `InterRealmRoute` | Travel system |
| `ChokePoint` | Navigation encounters |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│               v0.19.6 Biome Integration Layer                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                  Transition Generation                    │  │
│  │                                                           │  │
│  │   [Biome A] ──────────────────────────────▶ [Biome B]   │  │
│  │              │         │         │                        │  │
│  │         Blend 0.25  0.50     0.75                        │  │
│  │              │         │         │                        │  │
│  │         [Trans 1] [Trans 2] [Trans 3]                    │  │
│  │              │         │         │                        │  │
│  │         Interpolated Properties                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                 Sector Biome Assignment                   │  │
│  │                                                           │  │
│  │     Z=+1  │ Midgard (entry area)                         │  │
│  │     Z=0   │ Midgard                                      │  │
│  │     Z=-1  │ Midgard → Svartalfheim (TRANSITION)          │  │
│  │     Z=-2  │ Svartalfheim (Guild-Lands)                   │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Route Classification                    │  │
│  │                                                           │  │
│  │   Class B: Maintained (fast, safe)                       │  │
│  │   Class C: Known (moderate speed/hazard)                 │  │
│  │   Class D: Extreme (slow, dangerous)                     │  │
│  │                                                           │  │
│  │   Midgard ──(B 6-9d)──▶ Vanaheim                        │  │
│  │   Midgard ──(C 4-7d)──▶ Jötunheim                       │  │
│  │   Midgard ──(D 3-5d)──▶ Asgard [writ required]          │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     Choke Points                          │  │
│  │                                                           │  │
│  │   CP-HEL-001: Garm's Watch (Svartalfheim↔Helheim)       │  │
│  │   CP-ASG-001: Scar Rim Lifts (Midgard↔Asgard)           │  │
│  │   CP-MID-001: Utgard Gates (Midgard↔Jötunheim)          │  │
│  │                                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Deliverable Checklist

### Domain Layer

- [ ] `TransitionZone` entity
- [ ] `TransitionSequence` value object
- [ ] `InterpolatedProperties` value object
- [ ] `RouteClassification` enum (3 values)
- [ ] `InterRealmRoute` value object
- [ ] `ChokePoint` value object
- [ ] `SectorBiomeAssignment` value object

### Application Layer

- [ ] `ITransitionGenerator` interface
- [ ] `IPropertyInterpolator` interface
- [ ] `IBiomeSectorService` interface
- [ ] `IRouteCalculator` interface
- [ ] `TravelTimeResult` record

### Configuration

- [ ] `routes.json` inter-realm routes
- [ ] `transition_themes.json` narrative themes

### Tests

- [ ] Transition generator tests (~5)
- [ ] Property interpolator tests (~4)
- [ ] Sector service tests (~4)
- [ ] Route calculator tests (~4)

---

## v0.19.x Completion Summary

With v0.19.6 complete, the full biome system includes:

| Version | Content | Tests |
|---------|---------|-------|
| v0.19.0 | Core infrastructure | ~20 |
| v0.19.1 | Midgard | ~18 |
| v0.19.2 | Svartalfheim & Helheim | ~22 |
| v0.19.3 | Muspelheim & Niflheim | ~20 |
| v0.19.4 | Jötunheim & Vanaheim | ~20 |
| v0.19.5 | Alfheim & Asgard | ~18 |
| v0.19.6 | Integration | ~15 |
| **Total** | **9 Realms + Integration** | **~133** |

All nine canonical realms of Aethelgard are now fully specified with environmental mechanics, zone structures, and seamless transitions.
