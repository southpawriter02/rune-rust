# v0.3.25a: The Schema (JSON Format Definition) - Expanded Implementation Plan

## Overview

Define the JSON schema, file structure, and validation rules for externalized capture templates. This sub-plan establishes the data format that content authors will use to add new lore fragments without modifying C# code.

**Parent Plan:** [v0.3.25](./v0.3.25.md)
**Status:** Planned
**Dependencies:** None (first in sequence)

---

## Related Specifications

| Specification | Relationship | Path |
|---------------|--------------|------|
| **SPEC-CODEX-001** | CaptureType enum definition, system architecture | [docs/specs/knowledge/SPEC-CODEX-001.md](../../specs/knowledge/SPEC-CODEX-001.md) |
| **Sample Codex Entries** | Lore content examples, voice guidance | [docs/design/09-data/sample-codex-entries.md](../../design/09-data/sample-codex-entries.md) |
| **CaptureType.cs** | Source of truth for type enum values | `RuneAndRust.Core/Enums/CaptureType.cs` |
| **CaptureTemplates.cs** | Current hardcoded templates (to be replaced) | `RuneAndRust.Engine/Services/CaptureTemplates.cs` |

## Architecture Summary

### Key Deliverables

1. **JSON Schema** - Complete `capture-template.schema.json` with validation rules
2. **Directory Structure** - Organized file layout under `data/capture-templates/`
3. **Template Migration** - All 19 existing templates converted to JSON
4. **Validation Tooling** - Scripts to validate templates against schema
5. **Domain 4 Compliance** - Content guidelines embedded in schema

### Template Inventory (From `CaptureTemplates.cs`)

| Category | Count | Keywords |
|----------|-------|----------|
| RustedServitor | 4 | servitor, automaton, machine |
| GenericContainer | 3 | container, chest, crate |
| BlightedCreature | 3 | blight, corrupted, infected |
| IndustrialSite | 3 | industrial, forge, foundry |
| AncientRuin | 3 | ruin, ancient, inscription |
| FieldGuideTriggers | 3 | psychic, combat, burden |
| **Total** | **19** | |

---

## Directory Structure

```
data/
└── capture-templates/
    ├── schema/
    │   └── capture-template.schema.json    # JSON Schema definition
    │
    ├── categories/
    │   ├── rusted-servitor.json            # 4 templates
    │   ├── generic-container.json          # 3 templates
    │   ├── blighted-creature.json          # 3 templates
    │   ├── industrial-site.json            # 3 templates
    │   ├── ancient-ruin.json               # 3 templates
    │   └── field-guide-triggers.json       # 3 templates
    │
    └── README.md                           # Quick reference for authors
```

---

## JSON Schema Definition

### File: `data/capture-templates/schema/capture-template.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://runeandrust.game/schemas/capture-template.schema.json",
  "title": "Capture Template Collection",
  "description": "Schema for Data Capture template files in Rune & Rust",
  "type": "object",
  "required": ["$schema", "category", "version", "templates"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file"
    },
    "category": {
      "type": "string",
      "description": "Category identifier matching the filename",
      "pattern": "^[a-z][a-z0-9-]*$",
      "examples": ["rusted-servitor", "blighted-creature"]
    },
    "version": {
      "type": "string",
      "description": "Schema version for migration tracking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": ["1.0.0"]
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of this category"
    },
    "matchKeywords": {
      "type": "array",
      "description": "Default keywords for all templates in this category",
      "items": { "type": "string" },
      "minItems": 1
    },
    "templates": {
      "type": "array",
      "description": "Array of capture templates",
      "items": { "$ref": "#/$defs/captureTemplate" },
      "minItems": 1
    }
  },
  "$defs": {
    "captureTemplate": {
      "type": "object",
      "required": ["id", "type", "fragmentContent", "source"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique template identifier",
          "pattern": "^[a-z][a-z0-9-]*$",
          "examples": ["servitor-fungal-infection", "container-note-fragment"]
        },
        "type": {
          "type": "string",
          "description": "Capture type classification",
          "enum": [
            "TextFragment",
            "EchoRecording",
            "VisualRecord",
            "Specimen",
            "OralHistory",
            "RunicTrace"
          ]
        },
        "fragmentContent": {
          "type": "string",
          "description": "The lore text content of this fragment",
          "minLength": 20,
          "maxLength": 1000
        },
        "source": {
          "type": "string",
          "description": "Description of where/how the fragment was discovered",
          "minLength": 5,
          "maxLength": 100,
          "examples": ["Servitor examination", "Found in container"]
        },
        "matchKeywords": {
          "type": "array",
          "description": "Keywords for Codex auto-assignment (overrides category default)",
          "items": { "type": "string", "minLength": 2 },
          "minItems": 1
        },
        "quality": {
          "type": "integer",
          "description": "Quality value affecting Legend rewards (default: 15)",
          "minimum": 1,
          "maximum": 100,
          "default": 15
        },
        "tags": {
          "type": "array",
          "description": "Optional metadata tags for filtering",
          "items": { "type": "string" },
          "examples": [["aesir", "pre-glitch"], ["blight", "creature"]]
        },
        "domain4Notes": {
          "type": "string",
          "description": "Author notes on Domain 4 compliance (not displayed in-game)"
        }
      }
    }
  }
}
```

---

## CaptureType Enum Values

> **Source:** [`RuneAndRust.Core/Enums/CaptureType.cs`](../../../RuneAndRust.Core/Enums/CaptureType.cs)
> **Documented in:** [SPEC-CODEX-001](../../specs/knowledge/SPEC-CODEX-001.md)

For reference, these are the valid `type` values from `CaptureType.cs`:

| Enum Value | Int | Description | Voice Style (from Writer's Guide) |
|------------|-----|-------------|-----------------------------------|
| `TextFragment` | 0 | Written records, notes, torn pages | Scholarly, formal, historical |
| `EchoRecording` | 1 | Audio logs, transcribed recordings | Personal, urgent, often corrupted |
| `VisualRecord` | 2 | Schematics, diagrams, images | Descriptive, technical, observational |
| `Specimen` | 3 | Biological samples, tissue analysis | Analytical, clinical, scientific |
| `OralHistory` | 4 | Dialogue fragments, rumors, oral traditions | Conversational, dialectal, personal |
| `RunicTrace` | 5 | Magical/technological trace analysis | Mystical, precise, layered |

---

## Example Template File

### File: `data/capture-templates/categories/rusted-servitor.json`

```json
{
  "$schema": "../schema/capture-template.schema.json",
  "category": "rusted-servitor",
  "version": "1.0.0",
  "description": "Templates for Rusted Servitor encounters and automaton examinations",
  "matchKeywords": ["servitor", "automaton", "machine", "mechanical"],
  "templates": [
    {
      "id": "servitor-fungal-infection",
      "type": "Specimen",
      "fragmentContent": "The servo-motor shows signs of organic fungal infiltration. Mycelial threads have woven through the mechanical joints, creating an unsettling fusion of rust and growth.",
      "source": "Servitor examination",
      "quality": 15,
      "tags": ["servitor", "fungal", "blight-adjacent"]
    },
    {
      "id": "servitor-maintenance-log",
      "type": "TextFragment",
      "fragmentContent": "Recovered maintenance logs, partially corrupted: '...Unit 7-Alpha reporting nominal function. Awaiting directives from Central. Note: Unusual signal interference detected in lower sectors...'",
      "source": "Recovered data-slate",
      "matchKeywords": ["servitor", "automaton", "aesir"],
      "quality": 15,
      "tags": ["aesir", "pre-glitch", "log"]
    },
    {
      "id": "servitor-crystal-growth",
      "type": "VisualRecord",
      "fragmentContent": "Crystalline growths cluster around the primary actuator joints. The formations pulse with a faint amber luminescence when the unit attempts movement, suggesting some form of energy harvesting.",
      "source": "Visual inspection",
      "matchKeywords": ["servitor", "automaton", "crystal"],
      "quality": 15,
      "tags": ["crystal", "energy"]
    },
    {
      "id": "servitor-aetheric-resonance",
      "type": "RunicTrace",
      "fragmentContent": "Faint Aetheric resonance detected in the power coupling. The signature matches pre-Glitch Aesir manufacturing standards, though degradation patterns suggest centuries of dormancy.",
      "source": "Runic analysis",
      "matchKeywords": ["servitor", "aesir", "rune", "aetheric"],
      "quality": 15,
      "tags": ["aetheric", "pre-glitch", "runic"]
    }
  ]
}
```

---

## Full Template Migration

### All 19 Templates to Migrate

#### rusted-servitor.json (4 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `servitor-fungal-infection` | Specimen | Servitor examination | 15 |
| `servitor-maintenance-log` | TextFragment | Recovered data-slate | 15 |
| `servitor-crystal-growth` | VisualRecord | Visual inspection | 15 |
| `servitor-aetheric-resonance` | RunicTrace | Runic analysis | 15 |

#### generic-container.json (3 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `container-eastern-tunnels` | TextFragment | Found in container | 15 |
| `container-old-tormund` | OralHistory | Local knowledge | 15 |
| `container-inventory-records` | TextFragment | Container markings | 15 |

#### blighted-creature.json (3 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `blight-tissue-mutation` | Specimen | Biological analysis | 15 |
| `blight-awareness-retained` | VisualRecord | Field observation | 15 |
| `blight-deliberate-exposure` | RunicTrace | Aetheric analysis | 15 |

#### industrial-site.json (3 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `industrial-echo-stone` | EchoRecording | Echo-stone playback | 15 |
| `industrial-schematics` | VisualRecord | Technical schematic | 15 |
| `industrial-safety-notice` | TextFragment | Warning placard | 15 |

#### ancient-ruin.json (3 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `ruin-wall-inscription` | TextFragment | Wall inscription | 15 |
| `ruin-wanderers-tales` | OralHistory | Historical correlation | 15 |
| `ruin-defaced-murals` | VisualRecord | Artistic record | 15 |

#### field-guide-triggers.json (3 templates)

| ID | Type | Source | Quality |
|----|------|--------|---------|
| `guide-psychic-stress` | OralHistory | Veteran's warning | 15 |
| `guide-combat-training` | TextFragment | Combat manual | 15 |
| `guide-encumbrance` | OralHistory | Pack-master's lesson | 15 |

---

## Files to Create (9 new files)

| File | Purpose |
|------|---------|
| `data/capture-templates/schema/capture-template.schema.json` | JSON Schema definition |
| `data/capture-templates/categories/rusted-servitor.json` | 4 templates |
| `data/capture-templates/categories/generic-container.json` | 3 templates |
| `data/capture-templates/categories/blighted-creature.json` | 3 templates |
| `data/capture-templates/categories/industrial-site.json` | 3 templates |
| `data/capture-templates/categories/ancient-ruin.json` | 3 templates |
| `data/capture-templates/categories/field-guide-triggers.json` | 3 templates |
| `data/capture-templates/README.md` | Quick reference for authors |
| `scripts/validate-templates.ps1` | PowerShell validation script |

---

## Validation Tooling

### PowerShell Validation Script

**File:** `scripts/validate-templates.ps1`

```powershell
#!/usr/bin/env pwsh
# Validates all capture template JSON files against the schema

param(
    [string]$SchemaPath = "data/capture-templates/schema/capture-template.schema.json",
    [string]$TemplatesPath = "data/capture-templates/categories"
)

Write-Host "=== Capture Template Validator ===" -ForegroundColor Cyan

# Check if schema exists
if (-not (Test-Path $SchemaPath)) {
    Write-Error "Schema not found: $SchemaPath"
    exit 1
}

$schema = Get-Content $SchemaPath -Raw | ConvertFrom-Json
Write-Host "Loaded schema: $SchemaPath" -ForegroundColor Green

# Get all template files
$templateFiles = Get-ChildItem -Path $TemplatesPath -Filter "*.json"
$errors = @()
$templateCount = 0

foreach ($file in $templateFiles) {
    Write-Host "`nValidating: $($file.Name)" -ForegroundColor Yellow
    
    try {
        $content = Get-Content $file.FullName -Raw | ConvertFrom-Json
        
        # Basic structure checks
        if (-not $content.category) {
            $errors += "$($file.Name): Missing 'category' field"
        }
        if (-not $content.templates -or $content.templates.Count -eq 0) {
            $errors += "$($file.Name): Missing or empty 'templates' array"
        }
        
        # Check each template
        foreach ($template in $content.templates) {
            $templateCount++
            
            if (-not $template.id) {
                $errors += "$($file.Name): Template missing 'id'"
            }
            if (-not $template.type) {
                $errors += "$($file.Name): Template '$($template.id)' missing 'type'"
            }
            if (-not $template.fragmentContent) {
                $errors += "$($file.Name): Template '$($template.id)' missing 'fragmentContent'"
            }
            if ($template.fragmentContent.Length -lt 20) {
                $errors += "$($file.Name): Template '$($template.id)' fragmentContent too short (<20 chars)"
            }
            
            # Domain 4 check (no percentages or precise measurements)
            if ($template.fragmentContent -match '\d+%|\d+\.\d+|\d+ meters|\d+ km') {
                $errors += "$($file.Name): Template '$($template.id)' may violate Domain 4 (precision measurements)"
            }
        }
        
        Write-Host "  ✓ $($content.templates.Count) templates found" -ForegroundColor Green
        
    } catch {
        $errors += "$($file.Name): JSON parse error - $($_.Exception.Message)"
    }
}

Write-Host "`n=== Summary ===" -ForegroundColor Cyan
Write-Host "Total template files: $($templateFiles.Count)"
Write-Host "Total templates: $templateCount"

if ($errors.Count -gt 0) {
    Write-Host "`nErrors found: $($errors.Count)" -ForegroundColor Red
    foreach ($err in $errors) {
        Write-Host "  ✗ $err" -ForegroundColor Red
    }
    exit 1
} else {
    Write-Host "`n✓ All templates valid!" -ForegroundColor Green
    exit 0
}
```

### Usage

```bash
# Run validation
pwsh scripts/validate-templates.ps1

# Expected output (success):
# === Capture Template Validator ===
# Loaded schema: data/capture-templates/schema/capture-template.schema.json
# 
# Validating: rusted-servitor.json
#   ✓ 4 templates found
# ...
# 
# === Summary ===
# Total template files: 6
# Total templates: 19
# 
# ✓ All templates valid!
```

---

## Domain 4 Compliance Rules

Templates must NOT contain:

| Violation | Example | Correction |
|-----------|---------|------------|
| Exact percentages | "95% casualties" | "nearly all perished" |
| Decimal precision | "18.5°C temperature" | "uncomfortably warm" |
| Metric measurements | "800 meters away" | "beyond bowshot" |
| Population counts | "10,000 residents" | "a thriving settlement" |
| Technical specifications | "H₂S 6-12 ppm" | "air thick with sulfurous stench" |

The validation script includes a regex check for common violations.

---

## Implementation Order

1. Create `data/capture-templates/` directory structure
2. Create JSON Schema file
3. Create README.md with quick reference
4. Migrate `rusted-servitor` templates (test case)
5. Validate first file with script
6. Migrate remaining 5 category files
7. Run full validation
8. Compare template count (must equal 19)

---

## Testing Strategy

### Schema Validation Tests

| Test | Expected Result |
|------|-----------------|
| Valid template file | Passes validation |
| Missing required field (`id`) | Error reported |
| Invalid `type` enum value | Error reported |
| `fragmentContent` under 20 chars | Error reported |
| Domain 4 violation (percentage) | Warning reported |
| Empty `templates` array | Error reported |
| Malformed JSON | Parse error reported |

### Migration Verification

1. **Count Match:** 19 templates in JSON = 19 templates in C#
2. **Content Match:** Spot-check 5 random templates for exact text
3. **Keyword Match:** Verify `matchKeywords` arrays match C# `MatchingKeywords`
4. **Type Match:** All `type` values are valid enum strings

---

## Work Breakdown

### Phase 1: Directory & Schema
- [ ] Create `data/capture-templates/` directory
- [ ] Create `schema/` subdirectory
- [ ] Create `categories/` subdirectory
- [ ] Write `capture-template.schema.json`
- [ ] Write `README.md` quick reference

### Phase 2: Template Migration
- [ ] Migrate `rusted-servitor.json` (4 templates)
- [ ] Migrate `generic-container.json` (3 templates)
- [ ] Migrate `blighted-creature.json` (3 templates)
- [ ] Migrate `industrial-site.json` (3 templates)
- [ ] Migrate `ancient-ruin.json` (3 templates)
- [ ] Migrate `field-guide-triggers.json` (3 templates)

### Phase 3: Validation
- [ ] Create `validate-templates.ps1` script
- [ ] Run validation on all files
- [ ] Fix any errors
- [ ] Verify 19 template count

---

## Estimated Metrics

| Metric | Value |
|--------|-------|
| New Files | 9 |
| New Directories | 3 |
| JSON Lines | ~400 |
| Schema Lines | ~130 |
| Script Lines | ~80 |

---

## Pre-Commit Checks

- [ ] All 6 category files exist
- [ ] All 6 category files pass validation
- [ ] Template count equals 19
- [ ] No Domain 4 violations in content
- [ ] README.md provides clear guidance
- [ ] Schema validates correctly

**End of Plan**

