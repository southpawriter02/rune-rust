# Changelog: v0.3.24b - The Golden Master (Alpha Packaging)
**Release Date:** 2025-12-27

---

## Summary

Version 0.3.24b establishes production-ready release infrastructure for the v0.4.0-alpha distribution. This release introduces centralized version management via the `BuildInfo` static class, implements environment-aware Serilog configuration using preprocessor directives, and consolidates six individual EF Core migrations into a single canonical schema migration. Changes span the **Core Layer** (constants), **Persistence Layer** (migration consolidation), and **Terminal Layer** (startup configuration and version display). Key architectural patterns include compile-time configuration detection, conditional logging levels, and runtime property computation from constants.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Constants/BuildInfo.cs` | Centralized build information with compile-time constants for version, codename, build date, and configuration detection |

### Persistence Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Migrations/20251227175431_Initial_v0_4_0.cs` | Consolidated EF Core migration replacing six individual migrations with complete v0.4.0-alpha schema |
| `RuneAndRust.Persistence/Migrations/20251227175431_Initial_v0_4_0.Designer.cs` | EF Core migration metadata for consolidated schema |

---

## Files Deleted

### Persistence Layer

| File | Reason |
|------|--------|
| `RuneAndRust.Persistence/Migrations/20251220231703_InitialCreate.cs` | Replaced by consolidated `Initial_v0_4_0` migration |
| `RuneAndRust.Persistence/Migrations/20251221014933_AddRestSystemColumns.cs` | Replaced by consolidated migration |
| `RuneAndRust.Persistence/Migrations/20251222025251_AddEnvironmentEcosystemTables.cs` | Replaced by consolidated migration |
| `RuneAndRust.Persistence/Migrations/20251223022458_MakeActiveAbilityArchetypeNullable.cs` | Replaced by consolidated migration |
| `RuneAndRust.Persistence/Migrations/20251225183547_v0318a_CoordinateStruct.cs` | Replaced by consolidated migration |
| `RuneAndRust.Persistence/Migrations/20251227000000_v0321_AddSaveMetadata.cs` | Replaced by consolidated migration |

---

## Files Modified

### Terminal Layer

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Implemented environment-aware Serilog configuration with `#if DEBUG` directives; integrated `BuildInfo` for version logging in startup sequence |
| `RuneAndRust.Terminal/Controllers/MainMenuController.cs` | Refactored `GetVersionString()` method to use `BuildInfo` constants instead of localization service |

### Persistence Layer

| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Migrations/RuneAndRustDbContextModelSnapshot.cs` | Regenerated to reflect consolidated migration schema |

---

## Code Implementation Details

### BuildInfo Class (Core Layer)

**File:** `RuneAndRust.Core/Constants/BuildInfo.cs`

**Complete Implementation:**
```csharp
namespace RuneAndRust.Core.Constants;

/// <summary>
/// Centralized build information for Rune & Rust.
/// v0.3.24b: Introduced to standardize version display and configuration detection.
/// </summary>
public static class BuildInfo
{
    /// <summary>
    /// Semantic version string (e.g., "0.4.0-alpha").
    /// </summary>
    public const string Version = "0.4.0-alpha";

    /// <summary>
    /// Release codename (e.g., "The Saga").
    /// </summary>
    public const string Codename = "The Saga";

    /// <summary>
    /// Build date in ISO 8601 format (YYYY-MM-DD).
    /// </summary>
    public const string BuildDate = "2025-12-27";

    /// <summary>
    /// Target runtime version (e.g., "net8.0").
    /// </summary>
    public const string RuntimeVersion = "net8.0";

    /// <summary>
    /// Full version string including codename: "v0.4.0-alpha \"The Saga\"".
    /// </summary>
    public static string FullVersionString => $"v{Version} \"{Codename}\"";

    /// <summary>
    /// Short version string without codename: "v0.4.0-alpha".
    /// </summary>
    public static string ShortVersionString => $"v{Version}";

    /// <summary>
    /// Indicates if this is a pre-release version (contains '-').
    /// </summary>
    public static bool IsPreRelease => Version.Contains('-');

#if DEBUG
    /// <summary>
    /// True if compiled in Debug configuration.
    /// </summary>
    public static bool IsDebugBuild => true;

    /// <summary>
    /// Build configuration name: "Debug" or "Release".
    /// </summary>
    public const string Configuration = "Debug";
#else
    /// <summary>
    /// True if compiled in Debug configuration.
    /// </summary>
    public static bool IsDebugBuild => false;

    /// <summary>
    /// Build configuration name: "Debug" or "Release".
    /// </summary>
    public const string Configuration = "Release";
#endif
}
```

**Key Properties:**
- `Version`: Compile-time constant semantic version string
- `Codename`: Human-readable release identifier
- `BuildDate`: ISO 8601 build timestamp
- `FullVersionString`: Computed property combining version and codename
- `IsPreRelease`: Boolean computed from version string presence of hyphen
- `IsDebugBuild`: Compile-time computed via preprocessor directive
- `Configuration`: Compile-time string constant ("Debug" or "Release")

**Behaviors:**
- All constants are `const` for compile-time embedding
- Properties use expression-bodied members for runtime computation
- `#if DEBUG` preprocessor directive determines configuration-specific values
- No runtime overhead for configuration detection (compile-time resolution)

---

### Program.cs Modifications (Terminal Layer)

**File:** `RuneAndRust.Terminal/Program.cs`

**Environment-Aware Serilog Configuration (Lines 28-50):**
```csharp
// 1. Configure Serilog (v0.3.24b: Environment-aware configuration)
#if DEBUG
    // Debug: Verbose logging to console and file
    Log.Logger = new LoggerConfiguration()
        .MinimumLevel.Debug()
        .WriteTo.Console(restrictedToMinimumLevel: LogEventLevel.Debug)
        .WriteTo.File("logs/runeandrust.log",
            rollingInterval: RollingInterval.Day,
            restrictedToMinimumLevel: LogEventLevel.Debug)
        .CreateLogger();
#else
    // Release: Minimal console output, info+ to file
    Log.Logger = new LoggerConfiguration()
        .MinimumLevel.Information()
        .WriteTo.Console(restrictedToMinimumLevel: LogEventLevel.Warning)
        .WriteTo.File("logs/runeandrust.log",
            rollingInterval: RollingInterval.Day,
            restrictedToMinimumLevel: LogEventLevel.Information)
        .CreateLogger();
#endif

Log.Information("[Startup] Rune & Rust {Version} ({Config}) starting...",
    BuildInfo.FullVersionString, BuildInfo.Configuration);
```

**Configuration Behaviors:**
- **Debug Build:**
  - Global minimum level: `Debug`
  - Console sink: Accepts `Debug` and above
  - File sink: Accepts `Debug` and above
  - Rolling interval: Daily
  - Startup message includes "(Debug)" configuration marker

- **Release Build:**
  - Global minimum level: `Information`
  - Console sink: Accepts `Warning` and above only (reduces noise)
  - File sink: Accepts `Information` and above
  - Rolling interval: Daily
  - Startup message includes "(Release)" configuration marker

**UI Handover Version Update (Lines 405-406):**
```csharp
// 6. UI Handover (v0.3.24b: Uses BuildInfo for version)
AnsiConsole.MarkupLine($"[green]Rune & Rust {BuildInfo.FullVersionString} Booting...[/]");
```

**Behaviors:**
- Replaces hardcoded version string with `BuildInfo.FullVersionString`
- Displays as: `Rune & Rust v0.4.0-alpha "The Saga" Booting...`
- Consistent version display across startup log and UI output

---

### MainMenuController Modifications (Terminal Layer)

**File:** `RuneAndRust.Terminal/Controllers/MainMenuController.cs`

**Refactored GetVersionString() Method:**
```csharp
/// <summary>
/// Gets the version string for display on the title screen.
/// v0.3.24b: Uses BuildInfo for version data instead of localization.
/// </summary>
/// <returns>The version string with build configuration.</returns>
public string GetVersionString()
{
    var config = BuildInfo.IsDebugBuild ? " [DEBUG]" : "";
    return $"{BuildInfo.FullVersionString}{config}";
}
```

**Behaviors:**
- Checks `BuildInfo.IsDebugBuild` to append `[DEBUG]` suffix
- Returns full version string with codename
- **Debug output:** `v0.4.0-alpha "The Saga" [DEBUG]`
- **Release output:** `v0.4.0-alpha "The Saga"`
- Bypasses localization service for version consistency across locales

---

### Consolidated Migration (Persistence Layer)

**File:** `RuneAndRust.Persistence/Migrations/20251227175431_Initial_v0_4_0.cs`

**Migration Scope:**
This migration creates the complete v0.4.0-alpha database schema, consolidating the following previously separate migrations:
1. `InitialCreate` - Core game tables (Characters, Abilities, Items, Combat)
2. `AddRestSystemColumns` - Rest system state tracking
3. `AddEnvironmentEcosystemTables` - Environmental hazards and conditions
4. `MakeActiveAbilityArchetypeNullable` - Schema correction for optional archetype
5. `v0318a_CoordinateStruct` - Coordinate value object implementation
6. `v0321_AddSaveMetadata` - Save game metadata columns

**Commands Executed:**
```bash
# 1. Remove all existing migrations
$ rm /Volumes/GitHub/github/southpawriter02/rune-rust/RuneAndRust.Persistence/Migrations/*.cs

# 2. Drop existing database
$ dotnet ef database drop --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal --force

# 3. Create consolidated migration
$ dotnet ef migrations add Initial_v0_4_0 --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal

# 4. Apply migration to database
$ dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal
```

---

## Logging Matrix

### Startup Sequence

| Event | Level | Template | Build Config |
|-------|-------|----------|--------------|
| Serilog initialization | Information | `"[Startup] Rune & Rust {Version} ({Config}) starting..."` | Both |
| Version logged value | N/A | Debug: `v0.4.0-alpha "The Saga" (Debug)` | Debug |
| Version logged value | N/A | Release: `v0.4.0-alpha "The Saga" (Release)` | Release |

### Configuration-Specific Logging Levels

| Build Config | Global Min Level | Console Min Level | File Min Level | Rolling Interval |
|--------------|------------------|-------------------|----------------|------------------|
| Debug | Debug | Debug | Debug | Daily |
| Release | Information | Warning | Information | Daily |

### Version Display Contexts

| Context | Debug Build Output | Release Build Output |
|---------|-------------------|---------------------|
| Startup Log | `[Startup] Rune & Rust v0.4.0-alpha "The Saga" (Debug) starting...` | `[Startup] Rune & Rust v0.4.0-alpha "The Saga" (Release) starting...` |
| UI Handover | `Rune & Rust v0.4.0-alpha "The Saga" Booting...` | `Rune & Rust v0.4.0-alpha "The Saga" Booting...` |
| Title Screen | `v0.4.0-alpha "The Saga" [DEBUG]` | `v0.4.0-alpha "The Saga"` |

---

## Test Coverage

**Status:** No new tests added in this release (infrastructure-focused release).

**Existing Test Suite:**
- **Total Tests:** 2,949
- **Passed:** 2,946
- **Failed:** 3 (pre-existing failures unrelated to v0.3.24b changes)

**Verification:**
- Debug build: All tests executed successfully (2,946 passed)
- Release build: Compiled successfully, debug services excluded via `#if DEBUG` directives

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Constants/
│   ├── BuildInfo.cs [NEW]
│   └── ... (other enums)

RuneAndRust.Persistence/
├── Migrations/
│   ├── 20251227175431_Initial_v0_4_0.cs [NEW]
│   ├── 20251227175431_Initial_v0_4_0.Designer.cs [NEW]
│   └── RuneAndRustDbContextModelSnapshot.cs [MODIFIED]

RuneAndRust.Terminal/
├── Controllers/
│   └── MainMenuController.cs [MODIFIED]
└── Program.cs [MODIFIED]
```

---

## Migration Consolidation Analysis

### Before Consolidation (6 Migrations)

| Migration | Purpose |
|-----------|---------|
| `20251220231703_InitialCreate` | Core game tables (13 tables) |
| `20251221014933_AddRestSystemColumns` | Added Rest system state columns |
| `20251222025251_AddEnvironmentEcosystemTables` | Added EnvironmentalHazards and EnvironmentalConditions |
| `20251223022458_MakeActiveAbilityArchetypeNullable` | Schema fix for optional archetype |
| `20251225183547_v0318a_CoordinateStruct` | Coordinate value object implementation |
| `20251227000000_v0321_AddSaveMetadata` | Save game metadata columns |

### After Consolidation (1 Migration)

| Migration | Purpose |
|-----------|---------|
| `20251227175431_Initial_v0_4_0` | Complete v0.4.0-alpha schema (all tables) |

**Benefits:**
- **Simplified history:** Single canonical migration for v0.4.0-alpha
- **Clean slate:** EF Core `__EFMigrationsHistory` contains only one entry
- **Reduced complexity:** No incremental schema evolution to track
- **Production-ready:** Clean migration baseline for alpha distribution

---

## Technical Implementation Notes

### 1. Preprocessor Directive Strategy

The `#if DEBUG` preprocessor directive is used to create compile-time configuration detection:

```csharp
#if DEBUG
    public static bool IsDebugBuild => true;
    public const string Configuration = "Debug";
#else
    public static bool IsDebugBuild => false;
    public const string Configuration = "Release";
#endif
```

**Rationale:**
- Compile-time resolution eliminates runtime overhead
- No reflection or `Debugger.IsAttached` checks required
- Values are embedded during compilation, not computed at runtime

### 2. Localization Bypass for Version Display

Previously, the version string was sourced from the localization service. The new pattern uses `BuildInfo` directly:

**Rationale:**
- Version numbers are technical metadata, not user-facing content requiring translation
- Single source of truth (`BuildInfo.Version` constant)
- Version bumps now require editing only one constant

### 3. Migration Baseline Establishment

The consolidated migration establishes a canonical schema baseline for v0.4.0-alpha. Future migrations will be incremental from this point.

**Alpha Distribution Implications:**
- New developers clone repo → Run `dotnet ef database update` → Get complete v0.4.0 schema
- No incremental migration execution during initial setup
- Simplified onboarding and environment setup

---

## Verification Results

### Build Verification

```
$ dotnet build -c Debug
Build succeeded. 0 Warning(s) 0 Error(s)

$ dotnet build -c Release
Build succeeded. 0 Warning(s) 0 Error(s)
```

### Test Execution

```
$ dotnet test -c Debug --filter "FullyQualifiedName!~Integration"
Passed!  - Failed: 3, Passed: 2946, Skipped: 0, Total: 2949
```

---

## Related Releases

### Predecessor
- **v0.3.24a "The Broom"** (Deprecation Cleanup) - Removed legacy `GenerateTestMapAsync`, wrapped debug services in `#if DEBUG`

### Parent Plan
- **v0.3.24 "The Forge Keeper"** (Release Infrastructure)

---

**End of Changelog v0.3.24b**
