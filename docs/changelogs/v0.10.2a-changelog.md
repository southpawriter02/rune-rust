# v0.10.2a Changelog: Tree Definitions

**Version:** 0.10.2a
**Phase:** Tree Definitions (Ability Tree Structure)
**Date:** 2026-01-18
**Status:** Complete

---

## Summary

Implements the ability tree structure with trees per class, branches for specialization, and nodes for individual talents. Trees are loaded from JSON configuration and provide the template for player progression. Each class has a dedicated ability tree with multiple branches containing nodes organized by tiers, supporting multi-rank abilities and prerequisite systems.

---

## Added

### Domain Layer - Value Objects

| Value Object | Properties | Description |
|--------------|------------|-------------|
| `NodePosition` | X, Y | UI layout coordinates for positioning tree nodes in the interface |
| `StatPrerequisite` | StatId, MinValue | Stat requirements for unlocking ability tree nodes |

**NodePosition Features:**
- Immutable record struct for efficient value semantics
- `Origin` static property for (0, 0) position
- `At(x, y)` factory method for creating positions
- `DistanceTo()` method for calculating Manhattan distance between positions

**StatPrerequisite Features:**
- Immutable record struct for stat requirements
- `IsMet(actualValue)` method for checking if requirement is satisfied
- Case-insensitive stat ID comparison
- String formatting for display (e.g., "strength >= 14")

### Domain Layer - Definitions

| Definition | Description |
|------------|-------------|
| `AbilityTreeNode` | Individual talent node with tier, cost, rank, prerequisites |
| `AbilityTreeBranch` | Specialization path containing related nodes |
| `AbilityTreeDefinition` | Root tree entity for a class with branches |

**AbilityTreeNode Properties:**
- `NodeId` - Unique identifier for the node (case-insensitive)
- `AbilityId` - The ability this node grants
- `Name` - Display name
- `Description` - Talent description
- `Tier` - Tier level (1 = base, 2 = advanced, etc.)
- `PointCost` - Point cost per rank
- `MaxRank` - Maximum ranks for this talent (1 for single-rank)
- `PrerequisiteNodeIds` - Node IDs that must be unlocked first
- `StatPrerequisites` - Stat requirements for this node
- `Position` - UI layout position
- `IconPath` - Optional icon path

**AbilityTreeNode Computed Properties:**
- `HasPrerequisites` - Whether node has any prerequisites
- `IsMultiRank` - Whether node has multiple ranks (MaxRank > 1)
- `IsTierOne` - Whether node is tier 1 (base talent)

**AbilityTreeNode Methods:**
- `GetTotalPointsToMax()` - Total points to fully rank this node
- `RequiresNode(nodeId)` - Checks if specific node is a prerequisite
- `MeetsStatRequirement(statId, value)` - Checks if stat requirement is met

**AbilityTreeBranch Properties:**
- `BranchId` - Unique identifier for the branch
- `Name` - Display name
- `Description` - Specialization description
- `Nodes` - Collection of nodes in this branch
- `IconPath` - Optional icon path

**AbilityTreeBranch Methods:**
- `GetNodesAtTier(tier)` - Gets nodes at specific tier
- `GetMaxTier()` - Gets highest tier in branch
- `GetNodeCount()` - Gets total node count
- `GetTotalPointsRequired()` - Points to fully unlock branch
- `FindNode(nodeId)` - Finds node by ID
- `ContainsNode(nodeId)` - Checks if node exists in branch

**AbilityTreeDefinition Properties:**
- `Id` - Entity GUID
- `TreeId` - Unique tree identifier
- `ClassId` - Class this tree belongs to
- `Name` - Display name
- `Description` - Tree description
- `PointsPerLevel` - Talent points per level
- `Branches` - Collection of specialization branches
- `IconPath` - Optional icon path

**AbilityTreeDefinition Factory Method:**
- `Create(treeId, classId, name, description, pointsPerLevel, iconPath)` - Creates new tree definition

**AbilityTreeDefinition Methods:**
- `SetBranches(branches)` - Sets the branches collection
- `GetAllNodes()` - Gets all nodes across all branches
- `FindNode(nodeId)` - Finds node by ID across branches
- `GetTotalPointsRequired()` - Total points to fully unlock tree
- `GetNodesAtTier(tier)` - Gets nodes at tier across branches
- `GetMaxTier()` - Gets highest tier across all branches
- `GetBranchCount()` - Gets number of branches
- `GetTotalNodeCount()` - Gets total nodes across branches
- `GetBranchContainingNode(nodeId)` - Finds branch containing node

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IAbilityTreeProvider` | GetTreeForClass, GetTree, GetAllTrees, FindNode, GetTreeContainingNode, GetBranchContainingNode, GetClassesWithTrees, HasTreeForClass, NodeExists |

**IAbilityTreeProvider Properties:**
- `TreeCount` - Number of loaded trees
- `TotalNodeCount` - Total nodes across all trees

### Infrastructure Layer - Provider

| Provider | Description |
|----------|-------------|
| `JsonAbilityTreeProvider` | Loads ability tree definitions from JSON configuration with indexed lookups |

**JsonAbilityTreeProvider Features:**
- Loads from `ability-trees.json` configuration file
- Creates multiple indexes for O(1) lookup:
  - `_treesByTreeId` - TreeId → AbilityTreeDefinition
  - `_treesByClassId` - ClassId → AbilityTreeDefinition
  - `_nodesById` - NodeId → AbilityTreeNode
  - `_branchesByNodeId` - NodeId → AbilityTreeBranch
  - `_treesByNodeId` - NodeId → AbilityTreeDefinition
- Case-insensitive lookups using `StringComparer.OrdinalIgnoreCase`
- Comprehensive logging during load
- Duplicate node detection with warnings

### Configuration

| File | Description |
|------|-------------|
| `config/ability-trees.json` | Ability tree definitions (Warrior tree with 3 branches, 10 nodes) |
| `config/schemas/ability-trees.schema.json` | JSON schema for ability tree configuration validation |

---

## Tree Structure

### Warrior Ability Tree

```
WARRIOR ABILITY TREE
════════════════════════════════════════════════════════════════

                            ┌───────────────┐
                            │   WARRIOR     │
                            │    (Base)     │
                            └───────┬───────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌───────────┐   ┌───────────┐   ┌───────────┐
            │BERSERKER  │   │ GUARDIAN  │   │ CHAMPION  │
            │ (Branch)  │   │ (Branch)  │   │ (Branch)  │
            └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
                  │               │               │
            ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐
            │           │   │           │   │           │
            ▼           ▼   ▼           ▼   ▼           ▼
        ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
        │Frenzy │ │Blood- │ │Shield │ │Taunt  │ │Rallying│ │Battle │
        │ (T1)  │ │lust   │ │Wall   │ │ (T1)  │ │Cry(T1)│ │Master │
        │ R1-3  │ │ (T1)  │ │ (T1)  │ │ R1    │ │ R1-3  │ │ (T1)  │
        └───┬───┘ │ R1    │ │ R1-3  │ └───┬───┘ └───┬───┘ │ R1    │
            │     └───────┘ └───┬───┘     │         │     └───────┘
            │                   │         │         │
            ▼                   ▼         ▼         ▼
        ┌───────┐         ┌───────┐ ┌───────┐ ┌───────┐
        │Rage   │         │Iron   │ │Aura of│ │Inspire│
        │ (T2)  │         │Skin   │ │Defense│ │ (T2)  │
        │req:STR│         │ (T2)  │ │ (T2)  │ │req:CHA│
        └───────┘         └───────┘ └───────┘ └───────┘

T1 = Tier 1 (1 point)   T2 = Tier 2 (2 points)   R = Max Rank
```

### Node Definitions

| Branch | Node | Tier | Cost | MaxRank | Prerequisites | Stat Req |
|--------|------|------|------|---------|---------------|----------|
| **Berserker** | Frenzy | 1 | 1 | 3 | - | - |
| | Bloodlust | 1 | 1 | 1 | - | - |
| | Rage | 2 | 2 | 1 | frenzy | STR >= 14 |
| **Guardian** | Shield Wall | 1 | 1 | 3 | - | - |
| | Taunt | 1 | 1 | 1 | - | - |
| | Iron Skin | 2 | 2 | 1 | shield-wall | - |
| | Aura of Defense | 2 | 2 | 1 | taunt | - |
| **Champion** | Rallying Cry | 1 | 1 | 3 | - | - |
| | Battle Master | 1 | 1 | 1 | - | - |
| | Inspire | 2 | 2 | 1 | rallying-cry | CHA >= 12 |

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Loading trees | Debug | `"Loading ability tree definitions from {ConfigPath}"` |
| Config read | Debug | `"Read {Length} bytes from ability tree configuration"` |
| Tree loaded | Debug | `"Loaded ability tree: {TreeName} for {ClassId} ({BranchCount} branches, {NodeCount} nodes)"` |
| Branch loaded | Debug | `"Loaded branch: {BranchName} ({NodeCount} nodes, max tier {MaxTier})"` |
| Node loaded | Debug | `"Loaded node: {NodeName} (T{Tier}, {PointCost}pt, {MaxRank} rank(s))"` |
| Provider initialized | Information | `"JsonAbilityTreeProvider loaded {TreeCount} trees with {NodeCount} total nodes"` |
| Duplicate node | Warning | `"Duplicate node ID detected: {NodeId} - overwriting previous entry"` |
| Tree not found | Debug | `"No ability tree found for class: {ClassId}"` |
| Node not found | Debug | `"No ability tree node found with ID: {NodeId}"` |
| Null/empty input | Warning | `"GetTreeForClass called with null or empty classId"` |
| Config not found | Error | `"Ability tree configuration file not found: {Path}"` |
| Empty config | Warning | `"Ability tree configuration is empty or invalid - no trees loaded"` |
| Load failure | Error | `"Failed to load ability tree '{TreeId}': {Error}"` |

---

## Unit Tests

**39 tests** covering:

### AbilityTreeDefinition Tests (25 tests)

| Test | Description |
|------|-------------|
| Create_ValidInputs_CreatesTree | Factory creates tree with valid inputs |
| Create_NullTreeId_ThrowsArgumentException | Validates treeId required |
| Create_NullClassId_ThrowsArgumentException | Validates classId required |
| Create_NullName_ThrowsArgumentException | Validates name required |
| TreeId_IsLowerCase | TreeId normalized to lowercase |
| ClassId_IsLowerCase | ClassId normalized to lowercase |
| SetBranches_StoresBranches | Branches collection set correctly |
| GetAllNodes_ReturnsAllNodes | Returns nodes across all branches |
| GetAllNodes_EmptyBranches_ReturnsEmpty | Empty tree returns empty |
| FindNode_ExistingNode_ReturnsNode | Finds node by ID |
| FindNode_CaseInsensitive_ReturnsNode | Case-insensitive node lookup |
| FindNode_UnknownNode_ReturnsNull | Unknown node returns null |
| GetTotalPointsRequired_CalculatesCorrectly | Point calculation correct |
| GetNodesAtTier_FiltersCorrectly | Tier filtering works |
| GetNodesAtTier_NoMatchingTier_ReturnsEmpty | No matches returns empty |
| GetMaxTier_ReturnsHighestTier | Max tier calculation |
| GetMaxTier_EmptyTree_ReturnsZero | Empty tree returns 0 |
| GetBranchCount_ReturnsCorrectCount | Branch count accurate |
| GetTotalNodeCount_ReturnsCorrectCount | Node count accurate |
| GetBranchContainingNode_FindsCorrectBranch | Finds parent branch |
| GetBranchContainingNode_UnknownNode_ReturnsNull | Unknown returns null |
| AbilityTreeNode_HasPrerequisites_True | Detects prerequisites |
| AbilityTreeNode_HasPrerequisites_False | No prerequisites returns false |
| AbilityTreeNode_IsMultiRank_True | Detects multi-rank |
| AbilityTreeNode_GetTotalPointsToMax | Total points calculation |

### JsonAbilityTreeProvider Tests (14 tests)

| Test | Description |
|------|-------------|
| Constructor_ValidConfig_LoadsTreesSuccessfully | Provider loads from config |
| Constructor_MissingConfigFile_ThrowsFileNotFoundException | Missing file throws |
| GetTreeForClass_ExistingClass_ReturnsCorrectTree | Returns tree for class |
| GetTreeForClass_UnknownClass_ReturnsNull | Unknown class returns null |
| GetTreeForClass_CaseInsensitive_FindsTree | Case-insensitive lookup |
| GetTree_ExistingTreeId_ReturnsCorrectTree | Returns tree by ID |
| FindNode_ExistingNode_ReturnsCorrectNode | Finds node across trees |
| FindNode_UnknownNode_ReturnsNull | Unknown node returns null |
| GetTreeContainingNode_ExistingNode_ReturnsCorrectTree | Finds containing tree |
| GetBranchContainingNode_ExistingNode_ReturnsCorrectBranch | Finds containing branch |
| GetBranchContainingNode_UnknownNode_ReturnsNull | Unknown returns null |
| GetClassesWithTrees_ReturnsAllClasses | Returns all class IDs |
| HasTreeForClass_ExistingClass_ReturnsTrue | Checks tree existence |
| NodeExists_ExistingNode_ReturnsTrue | Checks node existence |

---

## Files Changed

| Path | Change |
|------|--------|
| `src/Core/RuneAndRust.Domain/ValueObjects/NodePosition.cs` | NEW |
| `src/Core/RuneAndRust.Domain/ValueObjects/StatPrerequisite.cs` | NEW |
| `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeNode.cs` | NEW |
| `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeBranch.cs` | NEW |
| `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeDefinition.cs` | NEW |
| `src/Core/RuneAndRust.Application/Interfaces/IAbilityTreeProvider.cs` | NEW |
| `src/Infrastructure/RuneAndRust.Infrastructure/Providers/JsonAbilityTreeProvider.cs` | NEW |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | MODIFIED - Added ability tree provider DI registration |
| `config/ability-trees.json` | NEW |
| `config/schemas/ability-trees.schema.json` | NEW |
| `tests/RuneAndRust.Domain.UnitTests/Definitions/AbilityTreeDefinitionTests.cs` | NEW |
| `tests/RuneAndRust.Application.UnitTests/Providers/JsonAbilityTreeProviderTests.cs` | NEW |

---

## DI Registration

```csharp
// Infrastructure (AddInfrastructure)
services.AddSingleton<IAbilityTreeProvider>(sp =>
{
    var treesPath = Path.Combine(configPath, "ability-trees.json");
    var logger = sp.GetRequiredService<ILogger<JsonAbilityTreeProvider>>();
    return new JsonAbilityTreeProvider(treesPath, logger);
});
```

---

## v0.10.2 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.10.2a | Tree Definitions | Complete |
| v0.10.2b | Unlock System | Pending |
| v0.10.2c | Point Allocation | Pending |

---

## Dependencies

| Dependency | Purpose |
|------------|---------|
| `IEntity` | Base entity interface for AbilityTreeDefinition |
| `ILogger<T>` | Logging infrastructure |
| `System.Text.Json` | JSON deserialization |

---

## Integration Notes

### Loading a Tree for a Class

```csharp
// Get tree for a class
var tree = _abilityTreeProvider.GetTreeForClass("warrior");
if (tree != null)
{
    Console.WriteLine($"Tree: {tree.Name} ({tree.GetTotalNodeCount()} nodes)");

    foreach (var branch in tree.Branches)
    {
        Console.WriteLine($"  Branch: {branch.Name}");
        foreach (var node in branch.Nodes)
        {
            Console.WriteLine($"    - {node.Name} (T{node.Tier}, {node.MaxRank} ranks)");
        }
    }
}
```

### Finding a Specific Node

```csharp
// Find a node across all trees
var node = _abilityTreeProvider.FindNode("frenzy");
if (node != null)
{
    Console.WriteLine($"Node: {node.Name}");
    Console.WriteLine($"  Tier: {node.Tier}");
    Console.WriteLine($"  Cost: {node.PointCost} per rank");
    Console.WriteLine($"  Max Rank: {node.MaxRank}");
    Console.WriteLine($"  Total to Max: {node.GetTotalPointsToMax()} points");

    if (node.HasPrerequisites)
    {
        Console.WriteLine($"  Prerequisites: {string.Join(", ", node.PrerequisiteNodeIds)}");
    }
}
```

### Checking Prerequisites

```csharp
// Check if a node's prerequisites are met
var node = _abilityTreeProvider.FindNode("rage");
if (node != null)
{
    // Check node prerequisites
    foreach (var prereqId in node.PrerequisiteNodeIds)
    {
        bool unlocked = CheckIfNodeUnlocked(prereqId); // Your unlock tracking
        Console.WriteLine($"  {prereqId}: {(unlocked ? "Unlocked" : "Locked")}");
    }

    // Check stat prerequisites
    foreach (var statReq in node.StatPrerequisites)
    {
        int currentValue = GetStatValue(statReq.StatId); // Your stat system
        bool met = statReq.IsMet(currentValue);
        Console.WriteLine($"  {statReq.StatId} >= {statReq.MinValue}: {(met ? "Met" : "Not Met")}");
    }
}
```

### Getting Nodes by Tier

```csharp
// Get all tier 1 nodes (entry points)
var tree = _abilityTreeProvider.GetTreeForClass("warrior");
var tierOneNodes = tree.GetNodesAtTier(1);

Console.WriteLine("Available starting talents:");
foreach (var node in tierOneNodes)
{
    Console.WriteLine($"  - {node.Name} ({node.PointCost} point(s))");
}
```

---

*Document Version: 1.0 | Last Updated: 2026-01-18*
