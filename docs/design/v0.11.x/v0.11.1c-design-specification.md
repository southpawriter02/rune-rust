# v0.11.1c Design Specification: Recipe Discovery

**Version:** 0.11.1c
**Parent:** v0.11.1 (Recipes & Discovery)
**Prerequisites:** v0.11.1b Complete (Recipe Book)
**Status:** Design In Progress

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [RecipeScrollItem Entity](#4-recipescrollitem-entity)
5. [Recipe Scroll Use Handler](#5-recipe-scroll-use-handler)
6. [Loot Integration](#6-loot-integration)
7. [Domain Events](#7-domain-events)
8. [Configuration Schema](#8-configuration-schema)
9. [Configuration File](#9-configuration-file)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.11.1c implements the Recipe Discovery system, enabling players to find recipe scrolls as loot throughout the dungeon. When used, scrolls teach new crafting recipes to players, expanding their crafting capabilities. The system integrates with the loot service to generate scrolls based on dungeon level and loot source.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | RecipeScrollItem |
| **Use Handlers** | RecipeScrollUseHandler |
| **Domain Events** | RecipeDiscoveredEvent |
| **Loot Integration** | Recipe scroll generation |
| **Configuration** | recipe-scrolls.json, recipe-scrolls.schema.json |
| **Tests** | ~8 new unit tests |

### Architectural Significance

This version establishes the **Item Discovery Pattern** that will be used for other learnable content:
- Items that teach knowledge when consumed
- Loot source-aware item generation
- Already-known validation before consumption
- Scroll preservation when knowledge exists

---

## 2. Feature Overview

```
v0.11.1c Recipe Discovery Features
â”œâ”€â”€ RecipeScrollItem Entity
â”‚   â”œâ”€â”€ RecipeId property
â”‚   â”œâ”€â”€ Item type integration
â”‚   â””â”€â”€ Factory method
â”œâ”€â”€ Recipe Scroll Use Handler
â”‚   â”œâ”€â”€ Already-known check
â”‚   â”œâ”€â”€ Learn recipe flow
â”‚   â”œâ”€â”€ Scroll consumption
â”‚   â””â”€â”€ Player feedback
â”œâ”€â”€ Loot Integration
â”‚   â”œâ”€â”€ Scroll drop configuration
â”‚   â”œâ”€â”€ Source-based drop chances
â”‚   â”œâ”€â”€ Level-gated recipes
â”‚   â””â”€â”€ Drop weight system
â””â”€â”€ Domain Events
    â””â”€â”€ RecipeDiscoveredEvent
```

---

## 3. Architecture Diagrams

### 3.1 Recipe Discovery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RECIPE DISCOVERY ARCHITECTURE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    LOOT GENERATION                     INVENTORY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Loot Source   â”‚               â”‚                             â”‚
    â”‚  â”œâ”€ Chest       â”‚               â”‚  Player Inventory           â”‚
    â”‚  â”œâ”€ Boss Drop   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚  â”œâ”€ Gold: 150               â”‚
    â”‚  â”œâ”€ Monster     â”‚               â”‚  â”œâ”€ Healing Potion x3       â”‚
    â”‚  â””â”€ Quest       â”‚               â”‚  â””â”€ ğŸ“œ Recipe: Steel Sword  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                             â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    USE SCROLL FLOW
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    > use recipe-scroll-steel-sword
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. Validate scroll item              â”‚
    â”‚    â†’ Is RecipeScrollItem? âœ“          â”‚
    â”‚    â†’ Has valid RecipeId? âœ“           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Check recipe existence            â”‚
    â”‚    â†’ RecipeProvider.GetRecipe()      â”‚
    â”‚    â†’ Recipe found? âœ“                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Check if already known            â”‚
    â”‚    â†’ RecipeBook.IsKnown()            â”‚
    â”‚    â†’ Already known? âœ—               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Already Known                            â”‚
           â”‚                                          â–¼
           â”‚                               â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
           â”‚                               â•‘  Already Known!          â•‘
           â”‚                               â•‘  Scroll preserved.       â•‘
           â”‚                               â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â”‚
           â–¼ Not Known
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. Learn the recipe                  â”‚
    â”‚    â†’ RecipeService.LearnRecipe()     â”‚
    â”‚    â†’ Add to RecipeBook               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. Fire discovery event              â”‚
    â”‚    â†’ RecipeDiscoveredEvent           â”‚
    â”‚    â†’ Source: "scroll"                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. Consume scroll                    â”‚
    â”‚    â†’ Remove from inventory           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Recipe Learned: Steel Sword!        â•‘
    â•‘  The scroll crumbles to dust.        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 3.2 Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PRESENTATION LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UseCommand                                                          â”‚
â”‚  â””â”€â”€ Dispatches item use to appropriate handler                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPLICATION LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RecipeScrollUseHandler                 LootService (Extended)       â”‚
â”‚  â”œâ”€â”€ IItemUseHandler                    â”œâ”€â”€ GenerateRecipeScroll()   â”‚
â”‚  â”œâ”€â”€ Handle(player, item)               â”œâ”€â”€ SelectWeightedRecipe()   â”‚
â”‚  â””â”€â”€ Validates, learns, consumes        â””â”€â”€ CanDropScroll()          â”‚
â”‚                                                                      â”‚
â”‚  IRecipeScrollProvider                  RecipeScrollProvider         â”‚
â”‚  â”œâ”€â”€ GetScrollConfig()                  â”œâ”€â”€ Loads recipe-scrolls.jsonâ”‚
â”‚  â”œâ”€â”€ GetDropChance()                    â”œâ”€â”€ Validates configuration  â”‚
â”‚  â””â”€â”€ GetScrollsForLevel()               â””â”€â”€ Returns scroll configs   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DOMAIN LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RecipeScrollItem                       RecipeDiscoveredEvent        â”‚
â”‚  â”œâ”€â”€ RecipeId: string                   â”œâ”€â”€ PlayerId: Guid           â”‚
â”‚  â”œâ”€â”€ Extends Item                       â”œâ”€â”€ RecipeId: string         â”‚
â”‚  â””â”€â”€ GetUseAction()                     â”œâ”€â”€ RecipeName: string       â”‚
â”‚                                         â””â”€â”€ DiscoverySource: string  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      INFRASTRUCTURE LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RecipeScrollProvider                                                â”‚
â”‚  â””â”€â”€ config/recipe-scrolls.json                                     â”‚
â”‚  â””â”€â”€ config/schemas/recipe-scrolls.schema.json                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Loot Generation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SCROLL LOOT GENERATION                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    LOOT CONTEXT                    SCROLL ELIGIBILITY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ LootContext     â”‚            â”‚  Eligible Recipe Scrolls         â”‚
    â”‚ â”œâ”€ Source: boss â”‚            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
    â”‚ â”œâ”€ Level: 5     â”‚  â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  1. Filter by min dungeon level â”‚
    â”‚ â””â”€ Player       â”‚            â”‚  2. Filter by loot source       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  3. Exclude already-known       â”‚
                                   â”‚  4. Apply drop weights          â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
    WEIGHTED SELECTION              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚  WEIGHTED POOL                   â”‚
                                    â”‚  â”œâ”€ Steel Sword      (w: 10)    â”‚
    Roll random value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚  â”œâ”€ Fire Resist Pot  (w: 8)     â”‚
    against total weight            â”‚  â””â”€ Mithril Blade    (w: 2)     â”‚
                                    â”‚      Total: 20                   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
    SCROLL CREATION                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚  Create RecipeScrollItem         â”‚
                                    â”‚  â”œâ”€ ItemId: recipe-scroll-...   â”‚
                                    â”‚  â”œâ”€ Name: Recipe Scroll: ...    â”‚
                                    â”‚  â”œâ”€ RecipeId: steel-sword       â”‚
                                    â”‚  â””â”€ Stackable: false            â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    DROP CHANCE BY SOURCE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Source    â”‚              Drop Chance Visualization             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   Quest     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  50% â”‚
    â”‚   Boss      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ               30% â”‚
    â”‚   Chest     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                               15% â”‚
    â”‚   Monster   â”‚ â–ˆâ–ˆ                                              2% â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. RecipeScrollItem Entity

### 4.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Items/RecipeScrollItem.cs`

```csharp
namespace RuneAndRust.Domain.Items;

/// <summary>
/// An item that teaches a recipe when used by the player.
/// </summary>
/// <remarks>
/// Recipe scrolls are consumable items found as loot throughout the dungeon.
/// When used, they teach the player a new crafting recipe if not already known.
/// If the player already knows the recipe, the scroll is preserved.
/// </remarks>
public sealed class RecipeScrollItem : Item
{
    /// <summary>
    /// Gets the ID of the recipe this scroll teaches.
    /// </summary>
    public string RecipeId { get; private set; } = null!;

    /// <summary>
    /// Private constructor for factory pattern and serialization.
    /// </summary>
    private RecipeScrollItem() : base() { }

    /// <summary>
    /// Creates a new recipe scroll item.
    /// </summary>
    /// <param name="recipeId">The ID of the recipe this scroll teaches.</param>
    /// <param name="recipeName">The display name of the recipe.</param>
    /// <returns>A new RecipeScrollItem instance.</returns>
    /// <exception cref="ArgumentException">
    /// Thrown when recipeId or recipeName is null or whitespace.
    /// </exception>
    public static RecipeScrollItem Create(string recipeId, string recipeName)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeName, nameof(recipeName));

        var normalizedId = recipeId.ToLowerInvariant();

        return new RecipeScrollItem
        {
            Id = Guid.NewGuid(),
            ItemId = $"recipe-scroll-{normalizedId}",
            Name = $"Recipe Scroll: {recipeName}",
            Description = $"An ancient scroll containing the recipe for {recipeName}. " +
                          "Use this item to learn the recipe.",
            RecipeId = normalizedId,
            ItemType = ItemType.Consumable,
            Rarity = ItemRarity.Uncommon,
            IsUsable = true,
            IsStackable = false,
            MaxStackSize = 1,
            BaseValue = 100,
            Weight = 0.1m
        };
    }

    /// <summary>
    /// Creates a recipe scroll with custom item properties.
    /// </summary>
    /// <param name="recipeId">The ID of the recipe this scroll teaches.</param>
    /// <param name="recipeName">The display name of the recipe.</param>
    /// <param name="rarity">The rarity of the scroll item.</param>
    /// <param name="baseValue">The base gold value of the scroll.</param>
    /// <returns>A new RecipeScrollItem instance with custom properties.</returns>
    public static RecipeScrollItem Create(
        string recipeId,
        string recipeName,
        ItemRarity rarity,
        int baseValue)
    {
        var scroll = Create(recipeId, recipeName);
        scroll.Rarity = rarity;
        scroll.BaseValue = baseValue;
        return scroll;
    }

    /// <summary>
    /// Gets the use action for this scroll item.
    /// </summary>
    /// <returns>The LearnRecipe item use action.</returns>
    public override ItemUseAction GetUseAction() => ItemUseAction.LearnRecipe;

    /// <summary>
    /// Gets a descriptive string for the scroll's contents.
    /// </summary>
    /// <returns>A string describing what recipe the scroll contains.</returns>
    public string GetScrollContents()
    {
        return $"This scroll contains the recipe for crafting. " +
               $"Recipe ID: {RecipeId}";
    }
}
```

### 4.2 ItemUseAction Enum Extension

**File:** `src/Core/RuneAndRust.Domain/Enums/ItemUseAction.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the action performed when an item is used.
/// </summary>
public enum ItemUseAction
{
    /// <summary>No action - item cannot be used.</summary>
    None = 0,

    /// <summary>Consume for healing effect.</summary>
    Heal,

    /// <summary>Consume for mana restoration.</summary>
    RestoreMana,

    /// <summary>Apply a buff effect.</summary>
    ApplyBuff,

    /// <summary>Learn a recipe from a scroll.</summary>
    LearnRecipe,

    /// <summary>Equip the item.</summary>
    Equip,

    /// <summary>Read for information (books, notes).</summary>
    Read
}
```

### 4.3 RecipeScrollItem Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique instance identifier |
| `ItemId` | `string` | Item template ID (recipe-scroll-{recipeId}) |
| `Name` | `string` | Display name (Recipe Scroll: {recipeName}) |
| `Description` | `string` | Flavor text describing the scroll |
| `RecipeId` | `string` | The recipe this scroll teaches |
| `ItemType` | `ItemType` | Always Consumable |
| `Rarity` | `ItemRarity` | Varies by recipe difficulty |
| `IsUsable` | `bool` | Always true |
| `IsStackable` | `bool` | Always false |
| `BaseValue` | `int` | Gold value (varies by recipe) |

---

## 5. Recipe Scroll Use Handler

### 5.1 Handler Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IItemUseHandler.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Handles the use of items with specific use actions.
/// </summary>
public interface IItemUseHandler
{
    /// <summary>
    /// Gets the item use action this handler processes.
    /// </summary>
    ItemUseAction HandledAction { get; }

    /// <summary>
    /// Handles using an item.
    /// </summary>
    /// <param name="player">The player using the item.</param>
    /// <param name="item">The item being used.</param>
    /// <returns>The result of using the item.</returns>
    ItemUseResult Handle(Player player, Item item);
}
```

### 5.2 Handler Implementation

**File:** `src/Core/RuneAndRust.Application/Handlers/RecipeScrollUseHandler.cs`

```csharp
namespace RuneAndRust.Application.Handlers;

/// <summary>
/// Handles using recipe scroll items to learn new recipes.
/// </summary>
/// <remarks>
/// When a player uses a recipe scroll:
/// 1. Validates the scroll has a valid recipe reference
/// 2. Checks if the player already knows the recipe
/// 3. If known, preserves the scroll and notifies the player
/// 4. If not known, teaches the recipe and consumes the scroll
/// 5. Fires RecipeDiscoveredEvent for statistics tracking
/// </remarks>
public sealed class RecipeScrollUseHandler : IItemUseHandler
{
    private readonly IRecipeService _recipeService;
    private readonly IRecipeProvider _recipeProvider;
    private readonly IInventoryService _inventoryService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<RecipeScrollUseHandler> _logger;

    /// <summary>
    /// Gets the item use action this handler processes.
    /// </summary>
    public ItemUseAction HandledAction => ItemUseAction.LearnRecipe;

    /// <summary>
    /// Initializes a new instance of the RecipeScrollUseHandler.
    /// </summary>
    public RecipeScrollUseHandler(
        IRecipeService recipeService,
        IRecipeProvider recipeProvider,
        IInventoryService inventoryService,
        IEventBus eventBus,
        ILogger<RecipeScrollUseHandler> logger)
    {
        _recipeService = recipeService ?? throw new ArgumentNullException(nameof(recipeService));
        _recipeProvider = recipeProvider ?? throw new ArgumentNullException(nameof(recipeProvider));
        _inventoryService = inventoryService ?? throw new ArgumentNullException(nameof(inventoryService));
        _eventBus = eventBus ?? throw new ArgumentNullException(nameof(eventBus));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Handles using a recipe scroll item.
    /// </summary>
    /// <param name="player">The player using the scroll.</param>
    /// <param name="item">The recipe scroll item.</param>
    /// <returns>The result of using the scroll.</returns>
    public ItemUseResult Handle(Player player, Item item)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(item);

        // Validate item is a recipe scroll
        if (item is not RecipeScrollItem scroll)
        {
            _logger.LogWarning(
                "RecipeScrollUseHandler received non-scroll item: {ItemType}",
                item.GetType().Name);
            return ItemUseResult.Failed("This item is not a recipe scroll.");
        }

        _logger.LogDebug(
            "Player {PlayerName} attempting to use recipe scroll for {RecipeId}",
            player.Name,
            scroll.RecipeId);

        // Validate recipe exists
        var recipe = _recipeProvider.GetRecipe(scroll.RecipeId);
        if (recipe is null)
        {
            _logger.LogWarning(
                "Recipe scroll references unknown recipe: {RecipeId}",
                scroll.RecipeId);
            return ItemUseResult.Failed(
                "The scroll contains an unknown recipe. It crumbles to dust uselessly.");
        }

        // Check if player already knows this recipe
        if (_recipeService.IsRecipeKnown(player, scroll.RecipeId))
        {
            _logger.LogDebug(
                "Player {PlayerName} already knows recipe {RecipeId}",
                player.Name,
                scroll.RecipeId);

            return ItemUseResult.Preserved(
                $"You already know the recipe for {recipe.Name}.\n" +
                "The scroll remains intact in your inventory.");
        }

        // Learn the recipe
        var learnResult = _recipeService.LearnRecipe(player, scroll.RecipeId);
        if (!learnResult.IsSuccess)
        {
            _logger.LogWarning(
                "Failed to learn recipe {RecipeId}: {Reason}",
                scroll.RecipeId,
                learnResult.FailureReason);
            return ItemUseResult.Failed(learnResult.FailureReason!);
        }

        // Consume the scroll
        var removeResult = _inventoryService.RemoveItem(player.Inventory, item.Id, 1);
        if (!removeResult)
        {
            _logger.LogError(
                "Failed to remove recipe scroll {ItemId} from inventory after learning",
                item.Id);
            // Recipe was still learned, so this is a partial success
        }

        // Fire discovery event
        _eventBus.Publish(new RecipeDiscoveredEvent(
            player.Id,
            scroll.RecipeId,
            recipe.Name,
            DiscoverySource.Scroll));

        _logger.LogInformation(
            "Player {PlayerName} learned recipe {RecipeName} from scroll",
            player.Name,
            recipe.Name);

        return ItemUseResult.ConsumedWithMessage(
            $"You carefully study the ancient scroll...\n\n" +
            $"Recipe Learned: {recipe.Name}!\n\n" +
            "The scroll crumbles to dust after you memorize its contents.");
    }
}
```

### 5.3 ItemUseResult Record

**File:** `src/Core/RuneAndRust.Application/Results/ItemUseResult.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Result of using an item.
/// </summary>
/// <param name="IsSuccess">Whether the use action succeeded.</param>
/// <param name="WasConsumed">Whether the item was consumed.</param>
/// <param name="Message">Message to display to the player.</param>
/// <param name="ResultType">The type of result.</param>
public sealed record ItemUseResult(
    bool IsSuccess,
    bool WasConsumed,
    string Message,
    ItemUseResultType ResultType)
{
    /// <summary>
    /// Creates a successful result where the item was consumed.
    /// </summary>
    public static ItemUseResult ConsumedWithMessage(string message)
        => new(true, true, message, ItemUseResultType.Consumed);

    /// <summary>
    /// Creates a successful result where the item was preserved.
    /// </summary>
    public static ItemUseResult Preserved(string message)
        => new(true, false, message, ItemUseResultType.Preserved);

    /// <summary>
    /// Creates a failed result.
    /// </summary>
    public static ItemUseResult Failed(string message)
        => new(false, false, message, ItemUseResultType.Failed);
}

/// <summary>
/// Types of item use results.
/// </summary>
public enum ItemUseResultType
{
    /// <summary>Item was used and consumed.</summary>
    Consumed,

    /// <summary>Item was used but preserved.</summary>
    Preserved,

    /// <summary>Item use failed.</summary>
    Failed
}
```

### 5.4 Use Handler Decision Tree

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  RECIPE SCROLL USE DECISION TREE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Handle(player, item)
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Is item RecipeScrollItem?   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚           â”‚
    No          Yes
     â”‚           â”‚
     â–¼           â–¼
  â•”â•â•â•â•â•â•â•â•—  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â•‘ FAIL  â•‘  â”‚ Get recipe from provider    â”‚
  â•‘ Not a â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â•‘scroll â•‘         â”‚
  â•šâ•â•â•â•â•â•â•â•   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
              â”‚           â”‚
           Recipe      Recipe
           Not Found   Found
              â”‚           â”‚
              â–¼           â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•—  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â•‘   FAIL    â•‘  â”‚ Check if player knows recipe â”‚
        â•‘ Unknown   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â•‘  recipe   â•‘         â”‚
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                        â”‚           â”‚
                     Known       Unknown
                        â”‚           â”‚
                        â–¼           â–¼
               â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â•‘   PRESERVED   â•‘  â”‚ Learn recipe            â”‚
               â•‘ Already known â•‘  â”‚ RecipeService.LearnRecipe
               â•‘ Scroll intact â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                                   â”‚           â”‚
                                Failed      Success
                                   â”‚           â”‚
                                   â–¼           â–¼
                            â•”â•â•â•â•â•â•â•â•â•â•â•â•—  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â•‘   FAIL    â•‘  â”‚ Remove scroll       â”‚
                            â•‘Learn fail â•‘  â”‚ Fire discovery eventâ”‚
                            â•šâ•â•â•â•â•â•â•â•â•â•â•â•  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â–¼
                                           â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                                           â•‘   CONSUMED    â•‘
                                           â•‘ Recipe learnedâ•‘
                                           â•‘ Scroll gone   â•‘
                                           â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 6. Loot Integration

### 6.1 IRecipeScrollProvider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IRecipeScrollProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides recipe scroll configuration for loot generation.
/// </summary>
public interface IRecipeScrollProvider
{
    /// <summary>
    /// Gets the scroll configuration for a specific recipe.
    /// </summary>
    /// <param name="recipeId">The recipe ID.</param>
    /// <returns>The scroll configuration, or null if not found.</returns>
    RecipeScrollConfig? GetScrollConfig(string recipeId);

    /// <summary>
    /// Gets all scroll configurations.
    /// </summary>
    /// <returns>All recipe scroll configurations.</returns>
    IReadOnlyList<RecipeScrollConfig> GetAllScrollConfigs();

    /// <summary>
    /// Gets scrolls eligible to drop at a specific dungeon level.
    /// </summary>
    /// <param name="dungeonLevel">The current dungeon level.</param>
    /// <returns>Scrolls that can drop at this level.</returns>
    IReadOnlyList<RecipeScrollConfig> GetScrollsForLevel(int dungeonLevel);

    /// <summary>
    /// Gets scrolls that can drop from a specific loot source.
    /// </summary>
    /// <param name="source">The loot source type.</param>
    /// <returns>Scrolls that can drop from this source.</returns>
    IReadOnlyList<RecipeScrollConfig> GetScrollsForSource(LootSourceType source);

    /// <summary>
    /// Gets the drop chance for recipe scrolls from a specific source.
    /// </summary>
    /// <param name="source">The loot source type.</param>
    /// <returns>The drop chance as a decimal (0.0 to 1.0).</returns>
    decimal GetDropChance(LootSourceType source);

    /// <summary>
    /// Checks if a recipe has a scroll configuration.
    /// </summary>
    /// <param name="recipeId">The recipe ID.</param>
    /// <returns>True if a scroll config exists for this recipe.</returns>
    bool HasScrollConfig(string recipeId);
}
```

### 6.2 RecipeScrollConfig Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/RecipeScrollConfig.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Configuration for a recipe scroll's drop behavior.
/// </summary>
/// <param name="RecipeId">The ID of the recipe this scroll teaches.</param>
/// <param name="DropWeight">Relative weight for weighted random selection.</param>
/// <param name="MinDungeonLevel">Minimum dungeon level for this scroll to drop.</param>
/// <param name="MaxDungeonLevel">Maximum dungeon level (null for no limit).</param>
/// <param name="LootSources">Which loot sources can drop this scroll.</param>
/// <param name="ScrollRarity">The item rarity of the generated scroll.</param>
/// <param name="BaseValue">The base gold value of the scroll.</param>
public sealed record RecipeScrollConfig(
    string RecipeId,
    int DropWeight,
    int MinDungeonLevel,
    int? MaxDungeonLevel,
    IReadOnlyList<LootSourceType> LootSources,
    ItemRarity ScrollRarity,
    int BaseValue)
{
    /// <summary>
    /// Checks if this scroll can drop at the specified dungeon level.
    /// </summary>
    /// <param name="level">The dungeon level to check.</param>
    /// <returns>True if the scroll can drop at this level.</returns>
    public bool CanDropAtLevel(int level)
    {
        if (level < MinDungeonLevel)
            return false;

        if (MaxDungeonLevel.HasValue && level > MaxDungeonLevel.Value)
            return false;

        return true;
    }

    /// <summary>
    /// Checks if this scroll can drop from the specified source.
    /// </summary>
    /// <param name="source">The loot source to check.</param>
    /// <returns>True if the scroll can drop from this source.</returns>
    public bool CanDropFromSource(LootSourceType source)
    {
        return LootSources.Contains(source);
    }
}
```

### 6.3 LootSourceType Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/LootSourceType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of sources that can generate loot.
/// </summary>
public enum LootSourceType
{
    /// <summary>Treasure chests in the dungeon.</summary>
    Chest,

    /// <summary>Boss monster drops.</summary>
    Boss,

    /// <summary>Regular monster drops.</summary>
    Monster,

    /// <summary>Quest rewards.</summary>
    Quest,

    /// <summary>Shop purchases.</summary>
    Shop,

    /// <summary>Crafting output.</summary>
    Crafting
}
```

### 6.4 RecipeScrollProvider Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Providers/RecipeScrollProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

/// <summary>
/// Provides recipe scroll configuration from JSON configuration.
/// </summary>
public sealed class RecipeScrollProvider : IRecipeScrollProvider
{
    private readonly Dictionary<string, RecipeScrollConfig> _scrollConfigs;
    private readonly Dictionary<LootSourceType, decimal> _dropChances;
    private readonly ILogger<RecipeScrollProvider> _logger;

    /// <summary>
    /// Initializes a new instance of RecipeScrollProvider.
    /// </summary>
    public RecipeScrollProvider(
        IOptions<RecipeScrollSettings> settings,
        ILogger<RecipeScrollProvider> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));

        var config = settings?.Value ?? throw new ArgumentNullException(nameof(settings));

        _scrollConfigs = config.RecipeScrolls
            .ToDictionary(
                s => s.RecipeId.ToLowerInvariant(),
                s => s,
                StringComparer.OrdinalIgnoreCase);

        _dropChances = config.ScrollDropChances;

        _logger.LogInformation(
            "Loaded {Count} recipe scroll configurations",
            _scrollConfigs.Count);
    }

    /// <inheritdoc />
    public RecipeScrollConfig? GetScrollConfig(string recipeId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId);
        return _scrollConfigs.GetValueOrDefault(recipeId.ToLowerInvariant());
    }

    /// <inheritdoc />
    public IReadOnlyList<RecipeScrollConfig> GetAllScrollConfigs()
    {
        return _scrollConfigs.Values.ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<RecipeScrollConfig> GetScrollsForLevel(int dungeonLevel)
    {
        return _scrollConfigs.Values
            .Where(s => s.CanDropAtLevel(dungeonLevel))
            .ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<RecipeScrollConfig> GetScrollsForSource(LootSourceType source)
    {
        return _scrollConfigs.Values
            .Where(s => s.CanDropFromSource(source))
            .ToList();
    }

    /// <inheritdoc />
    public decimal GetDropChance(LootSourceType source)
    {
        return _dropChances.GetValueOrDefault(source, 0m);
    }

    /// <inheritdoc />
    public bool HasScrollConfig(string recipeId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId);
        return _scrollConfigs.ContainsKey(recipeId.ToLowerInvariant());
    }
}
```

### 6.5 LootService Extension

**File:** `src/Core/RuneAndRust.Application/Services/LootService.cs` (Extension)

```csharp
namespace RuneAndRust.Application.Services;

public partial class LootService
{
    private readonly IRecipeScrollProvider _recipeScrollProvider;
    private readonly IRecipeProvider _recipeProvider;
    private readonly IRecipeService _recipeService;
    private readonly Random _random = new();

    /// <summary>
    /// Attempts to generate a recipe scroll for the given loot context.
    /// </summary>
    /// <param name="context">The loot generation context.</param>
    /// <returns>A recipe scroll item, or null if no scroll should drop.</returns>
    public RecipeScrollItem? TryGenerateRecipeScroll(LootContext context)
    {
        ArgumentNullException.ThrowIfNull(context);

        // Check if a scroll should drop based on source drop chance
        var dropChance = _recipeScrollProvider.GetDropChance(context.Source);
        if (_random.NextDouble() > (double)dropChance)
        {
            _logger.LogDebug(
                "Recipe scroll drop check failed for source {Source} (chance: {Chance:P0})",
                context.Source,
                dropChance);
            return null;
        }

        // Get eligible scrolls for this context
        var eligibleScrolls = GetEligibleScrolls(context);
        if (eligibleScrolls.Count == 0)
        {
            _logger.LogDebug(
                "No eligible recipe scrolls for level {Level} and source {Source}",
                context.DungeonLevel,
                context.Source);
            return null;
        }

        // Select a scroll using weighted random selection
        var selectedConfig = SelectWeightedScroll(eligibleScrolls);
        if (selectedConfig is null)
        {
            return null;
        }

        // Get the recipe details
        var recipe = _recipeProvider.GetRecipe(selectedConfig.RecipeId);
        if (recipe is null)
        {
            _logger.LogWarning(
                "Scroll config references missing recipe: {RecipeId}",
                selectedConfig.RecipeId);
            return null;
        }

        // Create the scroll item
        var scroll = RecipeScrollItem.Create(
            selectedConfig.RecipeId,
            recipe.Name,
            selectedConfig.ScrollRarity,
            selectedConfig.BaseValue);

        _logger.LogInformation(
            "Generated recipe scroll for {RecipeName} from {Source}",
            recipe.Name,
            context.Source);

        return scroll;
    }

    /// <summary>
    /// Gets scrolls eligible to drop for the given context.
    /// </summary>
    private IReadOnlyList<RecipeScrollConfig> GetEligibleScrolls(LootContext context)
    {
        var levelScrolls = _recipeScrollProvider.GetScrollsForLevel(context.DungeonLevel);
        var sourceScrolls = _recipeScrollProvider.GetScrollsForSource(context.Source);

        // Intersection of level-appropriate and source-appropriate scrolls
        var eligible = levelScrolls
            .Where(s => sourceScrolls.Contains(s))
            .ToList();

        // Optionally exclude already-known recipes
        if (context.Player is not null && context.ExcludeKnownRecipes)
        {
            eligible = eligible
                .Where(s => !_recipeService.IsRecipeKnown(context.Player, s.RecipeId))
                .ToList();
        }

        return eligible;
    }

    /// <summary>
    /// Selects a scroll using weighted random selection.
    /// </summary>
    private RecipeScrollConfig? SelectWeightedScroll(IReadOnlyList<RecipeScrollConfig> scrolls)
    {
        if (scrolls.Count == 0)
            return null;

        var totalWeight = scrolls.Sum(s => s.DropWeight);
        if (totalWeight <= 0)
            return null;

        var roll = _random.Next(totalWeight);
        var cumulative = 0;

        foreach (var scroll in scrolls)
        {
            cumulative += scroll.DropWeight;
            if (roll < cumulative)
            {
                return scroll;
            }
        }

        // Fallback (should not reach here)
        return scrolls[^1];
    }
}
```

### 6.6 LootContext Record

**File:** `src/Core/RuneAndRust.Application/Models/LootContext.cs`

```csharp
namespace RuneAndRust.Application.Models;

/// <summary>
/// Context for loot generation decisions.
/// </summary>
/// <param name="Source">The source of the loot.</param>
/// <param name="DungeonLevel">The current dungeon level.</param>
/// <param name="Player">The player receiving the loot (optional).</param>
/// <param name="ExcludeKnownRecipes">Whether to exclude recipes the player already knows.</param>
public sealed record LootContext(
    LootSourceType Source,
    int DungeonLevel,
    Player? Player = null,
    bool ExcludeKnownRecipes = false)
{
    /// <summary>
    /// Creates a loot context for a chest.
    /// </summary>
    public static LootContext Chest(int level, Player? player = null)
        => new(LootSourceType.Chest, level, player);

    /// <summary>
    /// Creates a loot context for a boss drop.
    /// </summary>
    public static LootContext Boss(int level, Player? player = null)
        => new(LootSourceType.Boss, level, player);

    /// <summary>
    /// Creates a loot context for a monster drop.
    /// </summary>
    public static LootContext Monster(int level, Player? player = null)
        => new(LootSourceType.Monster, level, player);

    /// <summary>
    /// Creates a loot context for a quest reward.
    /// </summary>
    public static LootContext Quest(int level, Player? player = null)
        => new(LootSourceType.Quest, level, player);
}
```

---

## 7. Domain Events

### 7.1 RecipeDiscoveredEvent

**File:** `src/Core/RuneAndRust.Domain/Events/RecipeDiscoveredEvent.cs`

```csharp
namespace RuneAndRust.Domain.Events;

/// <summary>
/// Event raised when a player discovers a new recipe.
/// </summary>
/// <remarks>
/// This event is used for:
/// - Statistics tracking (recipes discovered)
/// - Achievement unlocks (discover X recipes)
/// - UI notifications (toast messages)
/// </remarks>
/// <param name="PlayerId">The ID of the player who discovered the recipe.</param>
/// <param name="RecipeId">The ID of the discovered recipe.</param>
/// <param name="RecipeName">The display name of the recipe.</param>
/// <param name="DiscoverySource">How the recipe was discovered.</param>
public sealed record RecipeDiscoveredEvent(
    Guid PlayerId,
    string RecipeId,
    string RecipeName,
    DiscoverySource DiscoverySource) : IDomainEvent
{
    /// <summary>
    /// Gets the timestamp when the recipe was discovered.
    /// </summary>
    public DateTime DiscoveredAt { get; init; } = DateTime.UtcNow;
}
```

### 7.2 DiscoverySource Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/DiscoverySource.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// How a recipe or knowledge was discovered.
/// </summary>
public enum DiscoverySource
{
    /// <summary>Learned from a recipe scroll item.</summary>
    Scroll,

    /// <summary>Taught by an NPC trainer.</summary>
    Trainer,

    /// <summary>Unlocked through quest completion.</summary>
    Quest,

    /// <summary>Discovered through experimentation.</summary>
    Experimentation,

    /// <summary>Known by default at character creation.</summary>
    Default
}
```

---

## 8. Configuration Schema

### 8.1 Recipe Scrolls Schema

**File:** `config/schemas/recipe-scrolls.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://runeandrust.game/schemas/recipe-scrolls.schema.json",
  "title": "Recipe Scrolls Configuration",
  "description": "Configuration for recipe scroll drop behavior and loot generation",
  "type": "object",
  "required": ["recipeScrolls", "scrollDropChances"],
  "properties": {
    "recipeScrolls": {
      "type": "array",
      "description": "List of recipe scroll configurations",
      "items": {
        "$ref": "#/$defs/recipeScrollConfig"
      },
      "minItems": 0
    },
    "scrollDropChances": {
      "type": "object",
      "description": "Drop chances by loot source type",
      "properties": {
        "chest": {
          "type": "number",
          "description": "Chance for scrolls to drop from chests",
          "minimum": 0,
          "maximum": 1
        },
        "boss": {
          "type": "number",
          "description": "Chance for scrolls to drop from bosses",
          "minimum": 0,
          "maximum": 1
        },
        "monster": {
          "type": "number",
          "description": "Chance for scrolls to drop from regular monsters",
          "minimum": 0,
          "maximum": 1
        },
        "quest": {
          "type": "number",
          "description": "Chance for scrolls to be quest rewards",
          "minimum": 0,
          "maximum": 1
        }
      },
      "required": ["chest", "boss", "monster", "quest"]
    }
  },
  "$defs": {
    "recipeScrollConfig": {
      "type": "object",
      "description": "Configuration for a single recipe scroll",
      "required": ["recipeId", "dropWeight", "minDungeonLevel", "lootSources"],
      "properties": {
        "recipeId": {
          "type": "string",
          "description": "The ID of the recipe this scroll teaches",
          "minLength": 1,
          "pattern": "^[a-z0-9-]+$"
        },
        "dropWeight": {
          "type": "integer",
          "description": "Relative weight for weighted random selection",
          "minimum": 1,
          "maximum": 100
        },
        "minDungeonLevel": {
          "type": "integer",
          "description": "Minimum dungeon level for this scroll to drop",
          "minimum": 1
        },
        "maxDungeonLevel": {
          "type": "integer",
          "description": "Maximum dungeon level (optional, null for no limit)",
          "minimum": 1
        },
        "lootSources": {
          "type": "array",
          "description": "Which loot sources can drop this scroll",
          "items": {
            "type": "string",
            "enum": ["chest", "boss", "monster", "quest"]
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "scrollRarity": {
          "type": "string",
          "description": "The item rarity of the generated scroll",
          "enum": ["Common", "Uncommon", "Rare", "Epic", "Legendary"],
          "default": "Uncommon"
        },
        "baseValue": {
          "type": "integer",
          "description": "Base gold value of the scroll",
          "minimum": 1,
          "default": 100
        }
      }
    }
  }
}
```

---

## 9. Configuration File

### 9.1 Recipe Scrolls Configuration

**File:** `config/recipe-scrolls.json`

```json
{
  "$schema": "./schemas/recipe-scrolls.schema.json",
  "recipeScrolls": [
    {
      "recipeId": "steel-sword",
      "dropWeight": 10,
      "minDungeonLevel": 3,
      "maxDungeonLevel": 8,
      "lootSources": ["chest", "boss"],
      "scrollRarity": "Uncommon",
      "baseValue": 150
    },
    {
      "recipeId": "mithril-blade",
      "dropWeight": 2,
      "minDungeonLevel": 8,
      "maxDungeonLevel": null,
      "lootSources": ["boss", "quest"],
      "scrollRarity": "Epic",
      "baseValue": 500
    },
    {
      "recipeId": "fire-resistance-potion",
      "dropWeight": 8,
      "minDungeonLevel": 5,
      "maxDungeonLevel": 12,
      "lootSources": ["chest", "monster", "boss"],
      "scrollRarity": "Uncommon",
      "baseValue": 120
    },
    {
      "recipeId": "steel-armor",
      "dropWeight": 8,
      "minDungeonLevel": 4,
      "maxDungeonLevel": 10,
      "lootSources": ["chest", "boss"],
      "scrollRarity": "Uncommon",
      "baseValue": 180
    },
    {
      "recipeId": "greater-healing-potion",
      "dropWeight": 12,
      "minDungeonLevel": 4,
      "maxDungeonLevel": null,
      "lootSources": ["chest", "monster", "boss"],
      "scrollRarity": "Uncommon",
      "baseValue": 100
    },
    {
      "recipeId": "enchanted-ring",
      "dropWeight": 5,
      "minDungeonLevel": 6,
      "maxDungeonLevel": null,
      "lootSources": ["boss", "quest"],
      "scrollRarity": "Rare",
      "baseValue": 300
    },
    {
      "recipeId": "mana-restoration-potion",
      "dropWeight": 10,
      "minDungeonLevel": 3,
      "maxDungeonLevel": null,
      "lootSources": ["chest", "monster"],
      "scrollRarity": "Uncommon",
      "baseValue": 110
    },
    {
      "recipeId": "shadow-cloak",
      "dropWeight": 3,
      "minDungeonLevel": 7,
      "maxDungeonLevel": null,
      "lootSources": ["boss"],
      "scrollRarity": "Rare",
      "baseValue": 350
    }
  ],
  "scrollDropChances": {
    "chest": 0.15,
    "boss": 0.30,
    "monster": 0.02,
    "quest": 0.50
  }
}
```

### 9.2 Configuration Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `recipeId` | string | Required | ID of recipe the scroll teaches |
| `dropWeight` | int | Required | Relative weight for random selection |
| `minDungeonLevel` | int | Required | Minimum level for scroll to drop |
| `maxDungeonLevel` | int? | null | Maximum level (null = no limit) |
| `lootSources` | string[] | Required | Valid sources for this scroll |
| `scrollRarity` | string | Uncommon | Item rarity of generated scroll |
| `baseValue` | int | 100 | Gold value of the scroll |

### 9.3 Drop Chance Properties

| Source | Chance | Description |
|--------|--------|-------------|
| `chest` | 15% | Standard dungeon chest |
| `boss` | 30% | Boss monster defeat |
| `monster` | 2% | Regular monster kill |
| `quest` | 50% | Quest completion reward |

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `RecipeScrollUseHandler` | Information | Recipe learned from scroll |
| `RecipeScrollUseHandler` | Debug | Use attempt started, already-known check |
| `RecipeScrollUseHandler` | Warning | Non-scroll item passed, unknown recipe reference |
| `RecipeScrollUseHandler` | Error | Failed to remove consumed scroll |
| `RecipeScrollProvider` | Information | Configuration loaded (count) |
| `RecipeScrollProvider` | Warning | Missing recipe reference in config |
| `LootService` | Information | Recipe scroll generated |
| `LootService` | Debug | Drop check result, eligible scroll count |
| `LootService` | Warning | Scroll config references missing recipe |

### 10.2 Log Message Templates

```csharp
// RecipeScrollUseHandler
_logger.LogInformation(
    "Player {PlayerName} learned recipe {RecipeName} from scroll",
    player.Name, recipe.Name);

_logger.LogDebug(
    "Player {PlayerName} attempting to use recipe scroll for {RecipeId}",
    player.Name, scroll.RecipeId);

_logger.LogDebug(
    "Player {PlayerName} already knows recipe {RecipeId}",
    player.Name, scroll.RecipeId);

_logger.LogWarning(
    "RecipeScrollUseHandler received non-scroll item: {ItemType}",
    item.GetType().Name);

_logger.LogWarning(
    "Recipe scroll references unknown recipe: {RecipeId}",
    scroll.RecipeId);

_logger.LogError(
    "Failed to remove recipe scroll {ItemId} from inventory after learning",
    item.Id);

// RecipeScrollProvider
_logger.LogInformation(
    "Loaded {Count} recipe scroll configurations",
    _scrollConfigs.Count);

// LootService
_logger.LogInformation(
    "Generated recipe scroll for {RecipeName} from {Source}",
    recipe.Name, context.Source);

_logger.LogDebug(
    "Recipe scroll drop check failed for source {Source} (chance: {Chance:P0})",
    context.Source, dropChance);

_logger.LogDebug(
    "No eligible recipe scrolls for level {Level} and source {Source}",
    context.DungeonLevel, context.Source);
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| RecipeScrollItem | ~2 |
| RecipeScrollUseHandler | ~3 |
| RecipeScrollProvider | ~2 |
| LootService (scroll generation) | ~1 |
| **Total** | **~8** |

### 11.2 RecipeScrollItemTests

**File:** `tests/RuneAndRust.Tests/Domain/Items/RecipeScrollItemTests.cs`

```csharp
[TestFixture]
public class RecipeScrollItemTests
{
    [Test]
    public void Create_WithValidParameters_ReturnsScrollWithCorrectProperties()
    {
        // Arrange
        var recipeId = "steel-sword";
        var recipeName = "Steel Sword";

        // Act
        var scroll = RecipeScrollItem.Create(recipeId, recipeName);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(scroll.RecipeId, Is.EqualTo("steel-sword"));
            Assert.That(scroll.ItemId, Is.EqualTo("recipe-scroll-steel-sword"));
            Assert.That(scroll.Name, Is.EqualTo("Recipe Scroll: Steel Sword"));
            Assert.That(scroll.ItemType, Is.EqualTo(ItemType.Consumable));
            Assert.That(scroll.IsUsable, Is.True);
            Assert.That(scroll.IsStackable, Is.False);
            Assert.That(scroll.GetUseAction(), Is.EqualTo(ItemUseAction.LearnRecipe));
        });
    }

    [Test]
    public void Create_WithNullRecipeId_ThrowsArgumentException()
    {
        // Act & Assert
        Assert.Throws<ArgumentException>(() =>
            RecipeScrollItem.Create(null!, "Test Recipe"));
    }

    [Test]
    public void Create_NormalizesRecipeIdToLowercase()
    {
        // Arrange & Act
        var scroll = RecipeScrollItem.Create("Steel-Sword", "Steel Sword");

        // Assert
        Assert.That(scroll.RecipeId, Is.EqualTo("steel-sword"));
    }
}
```

### 11.3 RecipeScrollUseHandlerTests

**File:** `tests/RuneAndRust.Tests/Application/Handlers/RecipeScrollUseHandlerTests.cs`

```csharp
[TestFixture]
public class RecipeScrollUseHandlerTests
{
    private Mock<IRecipeService> _recipeServiceMock;
    private Mock<IRecipeProvider> _recipeProviderMock;
    private Mock<IInventoryService> _inventoryServiceMock;
    private Mock<IEventBus> _eventBusMock;
    private Mock<ILogger<RecipeScrollUseHandler>> _loggerMock;
    private RecipeScrollUseHandler _handler;

    [SetUp]
    public void SetUp()
    {
        _recipeServiceMock = new Mock<IRecipeService>();
        _recipeProviderMock = new Mock<IRecipeProvider>();
        _inventoryServiceMock = new Mock<IInventoryService>();
        _eventBusMock = new Mock<IEventBus>();
        _loggerMock = new Mock<ILogger<RecipeScrollUseHandler>>();

        _handler = new RecipeScrollUseHandler(
            _recipeServiceMock.Object,
            _recipeProviderMock.Object,
            _inventoryServiceMock.Object,
            _eventBusMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void Handle_WithValidScroll_LearnsRecipeAndConsumesScroll()
    {
        // Arrange
        var player = CreateTestPlayer();
        var scroll = RecipeScrollItem.Create("steel-sword", "Steel Sword");
        var recipe = CreateTestRecipe("steel-sword", "Steel Sword");

        _recipeProviderMock.Setup(p => p.GetRecipe("steel-sword"))
            .Returns(recipe);
        _recipeServiceMock.Setup(s => s.IsRecipeKnown(player, "steel-sword"))
            .Returns(false);
        _recipeServiceMock.Setup(s => s.LearnRecipe(player, "steel-sword"))
            .Returns(LearnRecipeResult.Success("steel-sword", "Steel Sword"));
        _inventoryServiceMock.Setup(i => i.RemoveItem(player.Inventory, scroll.Id, 1))
            .Returns(true);

        // Act
        var result = _handler.Handle(player, scroll);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.True);
            Assert.That(result.WasConsumed, Is.True);
            Assert.That(result.Message, Does.Contain("Recipe Learned"));
        });
        _eventBusMock.Verify(e =>
            e.Publish(It.Is<RecipeDiscoveredEvent>(ev =>
                ev.RecipeId == "steel-sword" &&
                ev.DiscoverySource == DiscoverySource.Scroll)),
            Times.Once);
    }

    [Test]
    public void Handle_WhenRecipeAlreadyKnown_PreservesScrollAndReturnsMessage()
    {
        // Arrange
        var player = CreateTestPlayer();
        var scroll = RecipeScrollItem.Create("steel-sword", "Steel Sword");
        var recipe = CreateTestRecipe("steel-sword", "Steel Sword");

        _recipeProviderMock.Setup(p => p.GetRecipe("steel-sword"))
            .Returns(recipe);
        _recipeServiceMock.Setup(s => s.IsRecipeKnown(player, "steel-sword"))
            .Returns(true);

        // Act
        var result = _handler.Handle(player, scroll);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.True);
            Assert.That(result.WasConsumed, Is.False);
            Assert.That(result.Message, Does.Contain("already know"));
            Assert.That(result.Message, Does.Contain("remains intact"));
        });
        _inventoryServiceMock.Verify(i =>
            i.RemoveItem(It.IsAny<Inventory>(), It.IsAny<Guid>(), It.IsAny<int>()),
            Times.Never);
    }

    [Test]
    public void Handle_WhenRecipeNotFound_ReturnsFailure()
    {
        // Arrange
        var player = CreateTestPlayer();
        var scroll = RecipeScrollItem.Create("unknown-recipe", "Unknown");

        _recipeProviderMock.Setup(p => p.GetRecipe("unknown-recipe"))
            .Returns((RecipeDefinition?)null);

        // Act
        var result = _handler.Handle(player, scroll);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.False);
            Assert.That(result.WasConsumed, Is.False);
            Assert.That(result.Message, Does.Contain("unknown recipe"));
        });
    }

    private static Player CreateTestPlayer() => Player.Create("TestPlayer");
    private static RecipeDefinition CreateTestRecipe(string id, string name) => /* ... */;
}
```

### 11.4 RecipeScrollProviderTests

**File:** `tests/RuneAndRust.Tests/Infrastructure/Providers/RecipeScrollProviderTests.cs`

```csharp
[TestFixture]
public class RecipeScrollProviderTests
{
    [Test]
    public void GetScrollsForLevel_ReturnsOnlyEligibleScrolls()
    {
        // Arrange
        var settings = CreateTestSettings();
        var provider = new RecipeScrollProvider(
            Options.Create(settings),
            Mock.Of<ILogger<RecipeScrollProvider>>());

        // Act
        var scrolls = provider.GetScrollsForLevel(5);

        // Assert
        Assert.That(scrolls, Has.All.Matches<RecipeScrollConfig>(s =>
            s.MinDungeonLevel <= 5 &&
            (!s.MaxDungeonLevel.HasValue || s.MaxDungeonLevel.Value >= 5)));
    }

    [Test]
    public void GetDropChance_ReturnsConfiguredChance()
    {
        // Arrange
        var settings = CreateTestSettings();
        var provider = new RecipeScrollProvider(
            Options.Create(settings),
            Mock.Of<ILogger<RecipeScrollProvider>>());

        // Act
        var chestChance = provider.GetDropChance(LootSourceType.Chest);
        var bossChance = provider.GetDropChance(LootSourceType.Boss);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(chestChance, Is.EqualTo(0.15m));
            Assert.That(bossChance, Is.EqualTo(0.30m));
        });
    }

    private static RecipeScrollSettings CreateTestSettings() => /* ... */;
}
```

### 11.5 LootService Scroll Generation Tests

**File:** `tests/RuneAndRust.Tests/Application/Services/LootServiceScrollTests.cs`

```csharp
[TestFixture]
public class LootServiceScrollTests
{
    [Test]
    public void TryGenerateRecipeScroll_WithEligibleScrolls_ReturnsScroll()
    {
        // Arrange
        var service = CreateLootServiceWithMocks();
        var context = LootContext.Boss(level: 5);

        // Act
        var scroll = service.TryGenerateRecipeScroll(context);

        // Assert (may be null due to random, so test the type when not null)
        if (scroll is not null)
        {
            Assert.That(scroll, Is.InstanceOf<RecipeScrollItem>());
        }
    }
}
```

---

## 12. Use Cases

### 12.1 UC-001: Use Recipe Scroll

**Actor:** Player
**Preconditions:** Player has a recipe scroll in inventory
**Flow:**
1. Player issues `use recipe-scroll-steel-sword` command
2. System validates item is a recipe scroll
3. System checks if player already knows the recipe
4. If unknown, system teaches recipe to player
5. System consumes the scroll
6. System fires RecipeDiscoveredEvent
7. System displays success message

**Outcome:** Player learns new recipe, scroll is consumed

```
    > use recipe-scroll-steel-sword
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  You carefully study the ancient scroll...                       â•‘
    â•‘                                                                  â•‘
    â•‘  Recipe Learned: Steel Sword!                                    â•‘
    â•‘                                                                  â•‘
    â•‘  The scroll crumbles to dust after you memorize its contents.    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 12.2 UC-002: Use Scroll for Known Recipe

**Actor:** Player
**Preconditions:** Player has a scroll for a recipe they already know
**Flow:**
1. Player issues `use recipe-scroll-iron-sword` command
2. System validates item is a recipe scroll
3. System checks if player already knows the recipe
4. System detects recipe is already known
5. System preserves the scroll in inventory
6. System displays informative message

**Outcome:** Scroll is preserved, player notified

```
    > use recipe-scroll-iron-sword
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  You already know the recipe for Iron Sword.                     â•‘
    â•‘                                                                  â•‘
    â•‘  The scroll remains intact in your inventory.                    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 12.3 UC-003: Find Recipe Scroll in Chest

**Actor:** System (Loot Generation)
**Preconditions:** Player opens a chest on dungeon level 5
**Flow:**
1. System generates loot for chest
2. System rolls against scroll drop chance (15%)
3. If successful, system gets eligible scrolls for level 5
4. System selects scroll using weighted random
5. System creates RecipeScrollItem
6. System adds scroll to loot results

**Outcome:** Recipe scroll added to chest loot

```
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  CHEST CONTENTS                                                  â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                  â•‘
    â•‘  â€¢ 75 Gold                                                       â•‘
    â•‘  â€¢ Healing Potion x2                                             â•‘
    â•‘  â€¢ ğŸ“œ Recipe Scroll: Steel Sword                                 â•‘
    â•‘                                                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 12.4 UC-004: Boss Drops Recipe Scroll

**Actor:** System (Loot Generation)
**Preconditions:** Player defeats a boss on dungeon level 8
**Flow:**
1. System generates loot for boss
2. System rolls against boss scroll drop chance (30%)
3. If successful, system gets eligible scrolls for level 8
4. System may include rare/epic scrolls at this level
5. System selects scroll using weighted random
6. System creates RecipeScrollItem with appropriate rarity

**Outcome:** Rare recipe scroll added to boss loot

```
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  BOSS DEFEATED: Shadow Lord                                      â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                  â•‘
    â•‘  LOOT OBTAINED:                                                  â•‘
    â•‘  â€¢ 500 Gold                                                      â•‘
    â•‘  â€¢ Shadow Essence x3                                             â•‘
    â•‘  â€¢ ğŸ“œ Recipe Scroll: Mithril Blade  [EPIC]                       â•‘
    â•‘                                                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 12.5 UC-005: View Recipe Scroll Details

**Actor:** Player
**Preconditions:** Player has a recipe scroll in inventory
**Flow:**
1. Player issues `examine recipe-scroll-steel-sword` command
2. System retrieves scroll details
3. System retrieves linked recipe information
4. System displays scroll information

**Outcome:** Player sees scroll and recipe details

```
    > examine recipe-scroll-steel-sword
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  RECIPE SCROLL: Steel Sword                                      â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  Rarity: Uncommon                        Value: 150 gold         â•‘
    â•‘                                                                  â•‘
    â•‘  An ancient scroll containing the recipe for Steel Sword.        â•‘
    â•‘  Use this item to learn the recipe.                              â•‘
    â•‘                                                                  â•‘
    â•‘  RECIPE PREVIEW:                                                 â•‘
    â•‘  â”œâ”€ Category: Weapon                                             â•‘
    â•‘  â”œâ”€ Station: Anvil                                               â•‘
    â•‘  â””â”€ Difficulty: DC 14                                            â•‘
    â•‘                                                                  â•‘
    â•‘  [USE] to learn this recipe                                      â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `RecipeScrollItem` entity in `Domain/Items/`
- [ ] `ItemUseAction.LearnRecipe` enum value added
- [ ] `RecipeDiscoveredEvent` domain event
- [ ] `DiscoverySource` enum
- [ ] `RecipeScrollConfig` value object
- [ ] `LootSourceType` enum

### Application Layer

- [ ] `IItemUseHandler` interface
- [ ] `RecipeScrollUseHandler` implementation
- [ ] `ItemUseResult` result record
- [ ] `ItemUseResultType` enum
- [ ] `IRecipeScrollProvider` interface
- [ ] `LootContext` record
- [ ] `LootService.TryGenerateRecipeScroll()` method

### Infrastructure Layer

- [ ] `RecipeScrollProvider` implementation
- [ ] `RecipeScrollSettings` configuration class

### Configuration Files

- [ ] `config/recipe-scrolls.json` created
- [ ] `config/schemas/recipe-scrolls.schema.json` created
- [ ] Schema validates against configuration

### Testing

- [ ] `RecipeScrollItemTests` (~2 tests)
- [ ] `RecipeScrollUseHandlerTests` (~3 tests)
- [ ] `RecipeScrollProviderTests` (~2 tests)
- [ ] `LootServiceScrollTests` (~1 test)
- [ ] All ~8 unit tests passing

---

## 14. Acceptance Criteria

### Functional

- [ ] RecipeScrollItem can be created with valid recipe ID
- [ ] RecipeScrollItem.GetUseAction() returns LearnRecipe
- [ ] Using a scroll for unknown recipe teaches the recipe
- [ ] Using a scroll for unknown recipe consumes the scroll
- [ ] Using a scroll for known recipe preserves the scroll
- [ ] Using a scroll for known recipe displays appropriate message
- [ ] RecipeDiscoveredEvent fires when recipe is learned
- [ ] Scrolls generate in loot based on configured drop chances
- [ ] Scroll generation respects minimum dungeon level
- [ ] Scroll generation respects loot source restrictions
- [ ] Weighted random selection works correctly

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~8 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete for all public types
- [ ] Logging follows established patterns

### Integration

- [ ] Scroll use integrates with existing `use` command
- [ ] Scroll generation integrates with LootService
- [ ] RecipeDiscoveredEvent can be subscribed to by other systems

---

## 15. Dependencies

### 15.1 Required from v0.11.1b

| Type | Location | Usage |
|------|----------|-------|
| `RecipeBook` | `Domain/Entities/RecipeBook.cs` | Stores learned recipes |
| `IRecipeService` | `Application/Interfaces/IRecipeService.cs` | Learn recipes, check known |
| `RecipeService` | `Application/Services/RecipeService.cs` | Recipe management |
| `LearnRecipeResult` | `Application/Results/LearnRecipeResult.cs` | Learn operation result |

### 15.2 Required from v0.11.1a

| Type | Location | Usage |
|------|----------|-------|
| `RecipeDefinition` | `Domain/Definitions/RecipeDefinition.cs` | Recipe templates |
| `IRecipeProvider` | `Application/Interfaces/IRecipeProvider.cs` | Get recipe details |

### 15.3 Required from Prior Versions

| Type | Location | Usage |
|------|----------|-------|
| `Item` | `Domain/Entities/Item.cs` | Base class for RecipeScrollItem |
| `Inventory` | `Domain/Entities/Inventory.cs` | Store/remove scrolls |
| `Player` | `Domain/Entities/Player.cs` | Player entity |
| `IInventoryService` | `Application/Interfaces/IInventoryService.cs` | Remove consumed scroll |
| `IEventBus` | `Application/Interfaces/IEventBus.cs` | Publish events |
| `LootService` | `Application/Services/LootService.cs` | Loot generation |

### 15.4 Provides to v0.11.2

| Type | Usage |
|------|-------|
| `RecipeScrollItem` | Item type for crafting UI |
| `RecipeDiscoveredEvent` | Statistics and achievements |
| `LootContext` | Extended loot generation |

---

## 16. Future Considerations

### Deferred to v0.11.2 (Crafting Execution)

- **Crafting Station Interaction**: Actually crafting items at stations
- **Ingredient Consumption**: Removing ingredients from inventory
- **Craft Success/Failure**: Rolling against difficulty class
- **Quality Determination**: Using quality formulas for output

### Deferred to Later Versions

- **Recipe Trading**: Trading recipe scrolls between players
- **Recipe Achievements**: "Learn X recipes" achievements
- **Recipe Categories UI**: Filter scrolls by recipe category
- **Scroll Identification**: Unidentified scrolls that need identification
- **Scroll Crafting**: Crafting scrolls from blank scrolls + recipes

### Out of Scope

- **Automatic Recipe Learning**: Learning recipes without scrolls
- **Recipe Forgetting**: Removing recipes from recipe book
- **Recipe Prerequisites**: Requiring other recipes before learning

---

*Document Version: 1.0*
*Last Updated: 2025-01-16*
*Author: Claude (AI Assistant)*
