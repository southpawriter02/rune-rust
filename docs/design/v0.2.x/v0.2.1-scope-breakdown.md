# v0.2.1 Codex & Lore Discovery - Scope Breakdown

**Version:** 0.2.1
**Theme:** Codex & Lore Discovery
**Prerequisites:** v0.2.0 Complete (NPCs & Dialogue)
**Total Estimated Tests:** ~100 new tests

---

## Executive Summary

The Codex & Lore Discovery version introduces an in-game encyclopedia system that players unlock through exploration, combat, dialogue, and investigation. The codex transforms the dungeon from a series of encounters into a discoverable world with rich lore, monster weaknesses, faction histories, and collectible knowledge fragments. Players are rewarded for thorough exploration and careful observation with valuable information that enhances gameplay.

Key focus areas:
- **Codex System**: Core encyclopedia with categories, entries, and search
- **Discovery Mechanics**: Multiple ways to unlock entries (combat, dialogue, examination, documents)
- **Partial Entries & Fragments**: Progressive revelation of information
- **Cross-References**: Interconnected lore creating a web of knowledge
- **Progress Tracking**: Completion percentages and discovery milestones

The work is divided into **four sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.2.1a | Codex Foundation | CodexEntry entity, categories, codex command, basic viewing | ~25 |
| v0.2.1b | Discovery Mechanics | Unlock triggers, examination integration, combat reveals | ~30 |
| v0.2.1c | Fragments & Cross-References | Lore fragments, entry linking, partial reveals | ~25 |
| v0.2.1d | Progress & UI | Completion tracking, search, hints, TUI interface | ~20 |

---

## Existing Infrastructure

### Already Implemented (from v0.2.0)

| Feature | Location | Notes |
|---------|----------|-------|
| NPC entity | `Domain/Entities/NPC.cs` | Dialogue unlocks entries |
| DialogueOutcome | `Domain/ValueObjects/DialogueOutcome.cs` | Trigger for unlocks |
| FactionDefinition | `Domain/Definitions/FactionDefinition.cs` | Faction codex entries |
| MonsterDefinition | `Domain/Definitions/MonsterDefinition.cs` | Bestiary source |
| Item entity | `Domain/Entities/Item.cs` | Item lore source |
| Room entity | `Domain/Entities/Room.cs` | Location entries |
| Player entity | `Domain/Entities/Player.cs` | Progress owner |
| GameSessionService | `Application/Services/GameSessionService.cs` | Command handling |
| IConfigurationProvider | `Application/Interfaces/IConfigurationProvider.cs` | JSON loading |
| CombatEncounter | `Domain/Entities/CombatEncounter.cs` | Combat discovery trigger |

### Needs Implementation (v0.2.1)

| Feature | Phase | Notes |
|---------|-------|-------|
| CodexEntry | v0.2.1a | Core entry entity |
| CodexCategory | v0.2.1a | Category organization |
| CodexService | v0.2.1a | Entry management |
| DiscoveryTrigger | v0.2.1b | Unlock conditions |
| CodexFragment | v0.2.1c | Partial lore pieces |
| CodexReference | v0.2.1c | Cross-linking |
| CodexProgress | v0.2.1d | Player tracking |
| CodexSearchService | v0.2.1d | Search functionality |

---

## Feature Analysis & Categorization

### Codex Foundation Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| CodexEntry entity | High | None | **v0.2.1a** |
| CodexCategory enum | Low | None | **v0.2.1a** |
| CodexEntryDefinition configuration | Medium | IConfigurationProvider | **v0.2.1a** |
| CodexService | High | CodexEntry | **v0.2.1a** |
| `codex` command | Medium | CodexService | **v0.2.1a** |
| `codex <topic>` command | Medium | CodexService | **v0.2.1a** |
| Basic TUI display | Medium | IGameRenderer | **v0.2.1a** |

### Discovery Mechanics Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| DiscoveryTrigger value object | Medium | CodexEntry | **v0.2.1b** |
| DiscoveryType enum | Low | None | **v0.2.1b** |
| Combat discovery integration | Medium | CombatEncounter | **v0.2.1b** |
| Examination discovery | Medium | Item, Monster, Room | **v0.2.1b** |
| Dialogue discovery | Medium | DialogueOutcome | **v0.2.1b** |
| Document discovery | Medium | Item (documents) | **v0.2.1b** |
| DiscoveryService | High | All triggers | **v0.2.1b** |

### Fragment & Reference Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| CodexFragment entity | Medium | CodexEntry | **v0.2.1c** |
| Fragment collection mechanics | Medium | CodexFragment | **v0.2.1c** |
| CodexReference value object | Low | CodexEntry | **v0.2.1c** |
| Cross-reference display | Medium | CodexReference | **v0.2.1c** |
| Partial entry reveal | Medium | CodexEntry | **v0.2.1c** |
| Fragment location hints | Medium | CodexFragment | **v0.2.1c** |

### Progress & UI Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| CodexProgress entity | Medium | Player | **v0.2.1d** |
| Category completion tracking | Medium | CodexProgress | **v0.2.1d** |
| `codex search <term>` command | Medium | CodexService | **v0.2.1d** |
| Search functionality | Medium | CodexEntry | **v0.2.1d** |
| Discovery hints | Medium | CodexEntry | **v0.2.1d** |
| TUI codex interface | Medium | IGameRenderer | **v0.2.1d** |

---

## Phase Definitions

---

## v0.2.1a: Codex Foundation

### Overview

Establish the core codex system including the entry entity, category organization, and basic viewing commands. This phase enables players to view codex entries and navigate by category.

### Scope

**In Scope:**
- `CodexEntry` entity with content, category, and unlock state
- `CodexCategory` enum for organization
- `CodexEntryDefinition` configuration for entry templates
- `CodexService` for entry retrieval and management
- `codex` command to list categories and entries
- `codex <topic>` command to view specific entries
- Basic entry display in TUI
- Entry unlock tracking per player

**Out of Scope:**
- Discovery triggers (v0.2.1b)
- Fragment system (v0.2.1c)
- Cross-references (v0.2.1c)
- Search functionality (v0.2.1d)
- Progress percentages (v0.2.1d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Entities | 1 | `CodexEntry` |
| Definitions | 1 | `CodexEntryDefinition` |
| Enums | 2 | `CodexCategory`, `EntryRevealLevel` |
| Value Objects | 1 | `CodexContent` |
| Services | 1 | `CodexService` |
| Commands | 2 | `codex`, `codex <topic>` |
| Configuration | 1 | `codex-entries.json` |
| Unit Tests | ~25 | Entity, service, command tests |

### CodexEntry Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents an entry in the player's codex/encyclopedia.
/// </summary>
public class CodexEntry : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the entry's definition ID for configuration lookup.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the entry's display title.
    /// </summary>
    public string Title { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the category this entry belongs to.
    /// </summary>
    public CodexCategory Category { get; private set; }

    /// <summary>
    /// Gets the content at different reveal levels.
    /// </summary>
    public IReadOnlyDictionary<EntryRevealLevel, CodexContent> Content { get; private set; }
        = new Dictionary<EntryRevealLevel, CodexContent>();

    /// <summary>
    /// Gets the current reveal level for this entry.
    /// </summary>
    public EntryRevealLevel RevealLevel { get; private set; }

    /// <summary>
    /// Gets whether this entry has been discovered.
    /// </summary>
    public bool IsDiscovered { get; private set; }

    /// <summary>
    /// Gets when this entry was first discovered.
    /// </summary>
    public DateTime? DiscoveredAt { get; private set; }

    /// <summary>
    /// Gets the player who owns this entry instance.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets related entry IDs for cross-referencing.
    /// </summary>
    public IReadOnlyList<string> RelatedEntryIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets tags for categorization and searching.
    /// </summary>
    public IReadOnlyList<string> Tags { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the source that unlocked this entry.
    /// </summary>
    public string? UnlockSource { get; private set; }

    private CodexEntry() { /* EF Core */ }

    /// <summary>
    /// Creates a new codex entry from a definition.
    /// </summary>
    public static CodexEntry Create(
        CodexEntryDefinition definition,
        Guid playerId)
    {
        ArgumentNullException.ThrowIfNull(definition);

        return new CodexEntry
        {
            Id = Guid.NewGuid(),
            DefinitionId = definition.Id,
            Title = definition.Title,
            Category = definition.Category,
            Content = definition.Content,
            RevealLevel = EntryRevealLevel.Hidden,
            IsDiscovered = false,
            PlayerId = playerId,
            RelatedEntryIds = definition.RelatedEntryIds,
            Tags = definition.Tags
        };
    }

    /// <summary>
    /// Discovers this entry at the specified reveal level.
    /// </summary>
    public void Discover(EntryRevealLevel level, string source)
    {
        if (!IsDiscovered)
        {
            IsDiscovered = true;
            DiscoveredAt = DateTime.UtcNow;
        }

        if (level > RevealLevel)
        {
            RevealLevel = level;
            UnlockSource = source;
        }
    }

    /// <summary>
    /// Increases the reveal level of this entry.
    /// </summary>
    public void RevealMore(EntryRevealLevel newLevel)
    {
        if (newLevel > RevealLevel)
        {
            RevealLevel = newLevel;
        }
    }

    /// <summary>
    /// Gets the currently visible content.
    /// </summary>
    public CodexContent? GetVisibleContent()
    {
        if (!IsDiscovered) return null;

        // Return content for current level or highest available below it
        for (var level = RevealLevel; level >= EntryRevealLevel.Basic; level--)
        {
            if (Content.TryGetValue(level, out var content))
                return content;
        }

        return null;
    }

    /// <summary>
    /// Checks if there is more content to reveal.
    /// </summary>
    public bool HasMoreToReveal()
    {
        return Content.Keys.Any(level => level > RevealLevel);
    }
}
```

### CodexCategory Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories for organizing codex entries.
/// </summary>
public enum CodexCategory
{
    /// <summary>Monster entries with stats, weaknesses, and lore.</summary>
    Bestiary,

    /// <summary>Region and dungeon lore.</summary>
    Locations,

    /// <summary>Detailed item descriptions and histories.</summary>
    ItemsAndArtifacts,

    /// <summary>NPC backgrounds and histories.</summary>
    Characters,

    /// <summary>Groups, guilds, and organizations.</summary>
    Factions,

    /// <summary>World events and timeline.</summary>
    History,

    /// <summary>Myths, prophecies, and tales.</summary>
    Legends,

    /// <summary>Material properties and recipe hints.</summary>
    CraftingKnowledge
}
```

### EntryRevealLevel Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Levels of information revealed in a codex entry.
/// </summary>
public enum EntryRevealLevel
{
    /// <summary>Entry not yet discovered.</summary>
    Hidden = 0,

    /// <summary>Basic information revealed.</summary>
    Basic = 1,

    /// <summary>Standard details revealed.</summary>
    Standard = 2,

    /// <summary>Detailed information revealed.</summary>
    Detailed = 3,

    /// <summary>Complete entry with all information.</summary>
    Complete = 4
}
```

### CodexContent Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Content for a codex entry at a specific reveal level.
/// </summary>
public readonly record struct CodexContent
{
    /// <summary>
    /// Gets the main text content.
    /// </summary>
    public string Text { get; init; }

    /// <summary>
    /// Gets optional stat information (for bestiary).
    /// </summary>
    public string? Stats { get; init; }

    /// <summary>
    /// Gets optional weakness information (for bestiary).
    /// </summary>
    public string? Weaknesses { get; init; }

    /// <summary>
    /// Gets optional location hints.
    /// </summary>
    public string? LocationHint { get; init; }

    /// <summary>
    /// Gets optional historical context.
    /// </summary>
    public string? History { get; init; }

    /// <summary>
    /// Gets optional tactical tips.
    /// </summary>
    public string? Tips { get; init; }

    /// <summary>
    /// Creates content with just text.
    /// </summary>
    public static CodexContent FromText(string text) => new() { Text = text };
}
```

### CodexEntryDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for codex entries.
/// </summary>
public class CodexEntryDefinition
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the entry's display title.
    /// </summary>
    public string Title { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the category.
    /// </summary>
    public CodexCategory Category { get; private set; }

    /// <summary>
    /// Gets content at each reveal level.
    /// </summary>
    public IReadOnlyDictionary<EntryRevealLevel, CodexContent> Content { get; private set; }
        = new Dictionary<EntryRevealLevel, CodexContent>();

    /// <summary>
    /// Gets related entry IDs.
    /// </summary>
    public IReadOnlyList<string> RelatedEntryIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets searchable tags.
    /// </summary>
    public IReadOnlyList<string> Tags { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the source entity ID that unlocks this entry.
    /// </summary>
    public string? UnlockSourceId { get; private set; }

    /// <summary>
    /// Gets the discovery type required to unlock.
    /// </summary>
    public DiscoveryType UnlockType { get; private set; }

    /// <summary>
    /// Gets fragment IDs if this entry requires fragments.
    /// </summary>
    public IReadOnlyList<string> FragmentIds { get; private set; } = Array.Empty<string>();

    private CodexEntryDefinition() { }

    /// <summary>
    /// Creates a codex entry definition.
    /// </summary>
    public static CodexEntryDefinition Create(
        string id,
        string title,
        CodexCategory category,
        Dictionary<EntryRevealLevel, CodexContent> content,
        IEnumerable<string>? relatedEntryIds = null,
        IEnumerable<string>? tags = null,
        string? unlockSourceId = null,
        DiscoveryType unlockType = DiscoveryType.Examine,
        IEnumerable<string>? fragmentIds = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(title);

        return new CodexEntryDefinition
        {
            Id = id,
            Title = title,
            Category = category,
            Content = content,
            RelatedEntryIds = relatedEntryIds?.ToList() ?? new List<string>(),
            Tags = tags?.ToList() ?? new List<string>(),
            UnlockSourceId = unlockSourceId,
            UnlockType = unlockType,
            FragmentIds = fragmentIds?.ToList() ?? new List<string>()
        };
    }
}
```

### CodexService Interface

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Manages codex entries and discovery.
/// </summary>
public interface ICodexService
{
    /// <summary>
    /// Gets all entries for a player.
    /// </summary>
    IEnumerable<CodexEntry> GetAllEntries(Guid playerId);

    /// <summary>
    /// Gets discovered entries for a player.
    /// </summary>
    IEnumerable<CodexEntry> GetDiscoveredEntries(Guid playerId);

    /// <summary>
    /// Gets entries by category.
    /// </summary>
    IEnumerable<CodexEntry> GetEntriesByCategory(Guid playerId, CodexCategory category);

    /// <summary>
    /// Gets a specific entry by ID.
    /// </summary>
    CodexEntry? GetEntry(Guid playerId, string entryId);

    /// <summary>
    /// Gets a specific entry by title (case-insensitive).
    /// </summary>
    CodexEntry? GetEntryByTitle(Guid playerId, string title);

    /// <summary>
    /// Discovers an entry for a player.
    /// </summary>
    CodexEntry? DiscoverEntry(Guid playerId, string entryId, EntryRevealLevel level, string source);

    /// <summary>
    /// Increases the reveal level of an entry.
    /// </summary>
    bool RevealMore(Guid playerId, string entryId, EntryRevealLevel newLevel);

    /// <summary>
    /// Initializes codex entries for a new player.
    /// </summary>
    void InitializePlayerCodex(Guid playerId);
}
```

### User-Facing Changes

**Commands:**
```
> codex                   # List all categories with entry counts
> codex bestiary          # List entries in Bestiary category
> codex goblin            # View "Goblin" entry
> codex "Iron Sword"      # View entry with spaces in name
```

**Output Example:**
```
> codex
=== CODEX ===

Categories:
  Bestiary ............ 3/12 discovered
  Locations ........... 1/8 discovered
  Items & Artifacts ... 5/20 discovered
  Characters .......... 2/6 discovered
  Factions ............ 1/4 discovered
  History ............. 0/10 discovered
  Legends ............. 0/5 discovered
  Crafting Knowledge .. 0/8 discovered

Total Progress: 12/73 entries (16%)

Type 'codex <category>' to view entries in a category.
Type 'codex <entry name>' to view a specific entry.

---

> codex bestiary
=== BESTIARY ===

Discovered:
  * Goblin (Complete)
  * Skeleton Warrior (Standard)
  * Cave Spider (Basic)

Undiscovered: 9 entries

---

> codex goblin
=== GOBLIN ===
Category: Bestiary
Discovered: 2 days ago

Small, green-skinned creatures that infest the upper levels of most
dungeons. Though individually weak, goblins are cunning and dangerous
in groups.

STATS:
  Health: 8-12  |  Attack: 3-5  |  Defense: 1-2
  Speed: Fast   |  Size: Small

WEAKNESSES:
  - Vulnerable to fire damage
  - Low morale - likely to flee when outnumbered

TACTICS:
  Goblins prefer ambush tactics and will retreat to summon reinforcements
  if a fight goes poorly. Target their shamans first to prevent healing.

Related: Goblin Shaman, Goblin Chieftain, Orcish Alliance
```

### Configuration Example

```json
{
  "$schema": "../schemas/codex-entries.schema.json",
  "entries": [
    {
      "id": "bestiary-goblin",
      "title": "Goblin",
      "category": "Bestiary",
      "content": {
        "Basic": {
          "text": "Small, green-skinned creatures that infest dungeon upper levels."
        },
        "Standard": {
          "text": "Small, green-skinned creatures that infest the upper levels of most dungeons. Though individually weak, goblins are cunning and dangerous in groups.",
          "stats": "Health: 8-12 | Attack: 3-5 | Defense: 1-2"
        },
        "Complete": {
          "text": "Small, green-skinned creatures that infest the upper levels of most dungeons. Though individually weak, goblins are cunning and dangerous in groups.",
          "stats": "Health: 8-12 | Attack: 3-5 | Defense: 1-2 | Speed: Fast | Size: Small",
          "weaknesses": "Vulnerable to fire damage. Low morale - likely to flee when outnumbered.",
          "tips": "Target their shamans first to prevent healing. They retreat to summon reinforcements."
        }
      },
      "relatedEntryIds": ["bestiary-goblin-shaman", "bestiary-goblin-chieftain", "factions-orcish-alliance"],
      "tags": ["goblin", "humanoid", "common", "dungeon"],
      "unlockSourceId": "monster-goblin",
      "unlockType": "Defeat"
    }
  ]
}
```

### Acceptance Criteria

- [ ] CodexEntry can be created from definition
- [ ] CodexCategory enum covers all specified categories
- [ ] EntryRevealLevel controls visible content
- [ ] `codex` command shows category summary
- [ ] `codex <category>` lists entries in category
- [ ] `codex <entry>` displays entry content
- [ ] Only discovered entries are visible
- [ ] Reveal level controls shown content
- [ ] Entries can be configured via JSON
- [ ] ~25 unit tests pass

---

## v0.2.1b: Discovery Mechanics

### Overview

Implement the systems that trigger codex discoveries through gameplay actions. Players unlock entries by defeating monsters, examining items, completing dialogues, and finding documents.

### Scope

**In Scope:**
- `DiscoveryTrigger` value object for unlock conditions
- `DiscoveryType` enum for trigger categories
- `DiscoveryService` for processing triggers
- Combat discovery (defeating monsters unlocks bestiary)
- Examination discovery (examining items/monsters reveals lore)
- Dialogue discovery (NPC conversations unlock entries)
- Document discovery (finding books/scrolls adds entries)
- Room discovery (entering new areas unlocks locations)

**Out of Scope:**
- Fragment collection (v0.2.1c)
- Cross-reference linking (v0.2.1c)
- Search functionality (v0.2.1d)
- Progress tracking (v0.2.1d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Value Objects | 2 | `DiscoveryTrigger`, `DiscoveryResult` |
| Enums | 1 | `DiscoveryType` |
| Services | 1 | `DiscoveryService` |
| Event Handlers | 4 | Combat, Examine, Dialogue, Room entry |
| Entity Updates | 4 | Monster, Item, NPC, Room codex links |
| Unit Tests | ~30 | Discovery trigger and integration tests |

### DiscoveryType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of actions that can trigger codex discoveries.
/// </summary>
public enum DiscoveryType
{
    /// <summary>Defeating a monster in combat.</summary>
    Defeat,

    /// <summary>Examining an entity or object.</summary>
    Examine,

    /// <summary>Completing a dialogue with an NPC.</summary>
    Dialogue,

    /// <summary>Finding and reading a document.</summary>
    Document,

    /// <summary>Entering a location for the first time.</summary>
    Explore,

    /// <summary>Acquiring an item.</summary>
    Acquire,

    /// <summary>Reaching a reputation level with a faction.</summary>
    Reputation,

    /// <summary>Taking damage from a source.</summary>
    Damaged,

    /// <summary>Using or witnessing an ability.</summary>
    Ability,

    /// <summary>Collecting all fragments.</summary>
    FragmentComplete
}
```

### DiscoveryTrigger Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines conditions for unlocking a codex entry.
/// </summary>
public readonly record struct DiscoveryTrigger
{
    /// <summary>
    /// Gets the type of discovery action.
    /// </summary>
    public DiscoveryType Type { get; init; }

    /// <summary>
    /// Gets the source entity ID (monster, item, NPC, etc.).
    /// </summary>
    public string SourceId { get; init; }

    /// <summary>
    /// Gets the codex entry ID to unlock.
    /// </summary>
    public string EntryId { get; init; }

    /// <summary>
    /// Gets the reveal level granted by this trigger.
    /// </summary>
    public EntryRevealLevel RevealLevel { get; init; }

    /// <summary>
    /// Gets the minimum count required (e.g., defeat 3 goblins).
    /// </summary>
    public int RequiredCount { get; init; }

    /// <summary>
    /// Gets optional additional conditions.
    /// </summary>
    public string? AdditionalCondition { get; init; }

    /// <summary>
    /// Creates a defeat trigger.
    /// </summary>
    public static DiscoveryTrigger OnDefeat(
        string monsterId,
        string entryId,
        EntryRevealLevel level = EntryRevealLevel.Basic,
        int count = 1)
    {
        return new DiscoveryTrigger
        {
            Type = DiscoveryType.Defeat,
            SourceId = monsterId,
            EntryId = entryId,
            RevealLevel = level,
            RequiredCount = count
        };
    }

    /// <summary>
    /// Creates an examine trigger.
    /// </summary>
    public static DiscoveryTrigger OnExamine(
        string sourceId,
        string entryId,
        EntryRevealLevel level = EntryRevealLevel.Standard)
    {
        return new DiscoveryTrigger
        {
            Type = DiscoveryType.Examine,
            SourceId = sourceId,
            EntryId = entryId,
            RevealLevel = level,
            RequiredCount = 1
        };
    }

    /// <summary>
    /// Creates a dialogue trigger.
    /// </summary>
    public static DiscoveryTrigger OnDialogue(
        string npcId,
        string entryId,
        EntryRevealLevel level = EntryRevealLevel.Standard,
        string? dialogueNodeId = null)
    {
        return new DiscoveryTrigger
        {
            Type = DiscoveryType.Dialogue,
            SourceId = npcId,
            EntryId = entryId,
            RevealLevel = level,
            RequiredCount = 1,
            AdditionalCondition = dialogueNodeId
        };
    }
}
```

### DiscoveryResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of a discovery attempt.
/// </summary>
public readonly record struct DiscoveryResult
{
    /// <summary>
    /// Gets whether any entries were discovered.
    /// </summary>
    public bool HasDiscoveries { get; init; }

    /// <summary>
    /// Gets newly discovered entries.
    /// </summary>
    public IReadOnlyList<CodexEntry> NewEntries { get; init; }

    /// <summary>
    /// Gets entries with increased reveal level.
    /// </summary>
    public IReadOnlyList<CodexEntry> RevealedMore { get; init; }

    /// <summary>
    /// Gets fragments collected.
    /// </summary>
    public IReadOnlyList<string> FragmentsCollected { get; init; }

    /// <summary>
    /// Creates an empty result.
    /// </summary>
    public static DiscoveryResult None => new()
    {
        HasDiscoveries = false,
        NewEntries = Array.Empty<CodexEntry>(),
        RevealedMore = Array.Empty<CodexEntry>(),
        FragmentsCollected = Array.Empty<string>()
    };

    /// <summary>
    /// Creates a result with new discoveries.
    /// </summary>
    public static DiscoveryResult WithEntries(
        IEnumerable<CodexEntry> newEntries,
        IEnumerable<CodexEntry>? revealedMore = null)
    {
        var newList = newEntries.ToList();
        var revealedList = revealedMore?.ToList() ?? new List<CodexEntry>();

        return new DiscoveryResult
        {
            HasDiscoveries = newList.Count > 0 || revealedList.Count > 0,
            NewEntries = newList,
            RevealedMore = revealedList,
            FragmentsCollected = Array.Empty<string>()
        };
    }
}
```

### DiscoveryService Interface

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Processes discovery triggers and unlocks codex entries.
/// </summary>
public interface IDiscoveryService
{
    /// <summary>
    /// Processes a monster defeat for discoveries.
    /// </summary>
    DiscoveryResult ProcessDefeat(Guid playerId, string monsterId, int totalDefeated);

    /// <summary>
    /// Processes an examination for discoveries.
    /// </summary>
    DiscoveryResult ProcessExamine(Guid playerId, string targetId, string targetType);

    /// <summary>
    /// Processes dialogue completion for discoveries.
    /// </summary>
    DiscoveryResult ProcessDialogue(Guid playerId, string npcId, string? nodeId = null);

    /// <summary>
    /// Processes document reading for discoveries.
    /// </summary>
    DiscoveryResult ProcessDocument(Guid playerId, string documentId);

    /// <summary>
    /// Processes room entry for discoveries.
    /// </summary>
    DiscoveryResult ProcessRoomEntry(Guid playerId, string roomId, bool firstVisit);

    /// <summary>
    /// Processes item acquisition for discoveries.
    /// </summary>
    DiscoveryResult ProcessItemAcquired(Guid playerId, string itemId);

    /// <summary>
    /// Gets triggers for a specific source.
    /// </summary>
    IEnumerable<DiscoveryTrigger> GetTriggersForSource(string sourceId);
}
```

### Entity Modifications

```
MODIFY: MonsterDefinition
├── ADD: CodexEntryId: string?
├── ADD: ExamineCodexLevel: EntryRevealLevel
└── ADD: DefeatCodexLevel: EntryRevealLevel

MODIFY: Item
├── ADD: CodexEntryId: string?
├── ADD: IsDocument: bool
└── ADD: DocumentContent: string?

MODIFY: NPC
├── ADD: CodexEntryId: string?
└── ADD: DialogueCodexTriggers: IReadOnlyList<DiscoveryTrigger>

MODIFY: Room
├── ADD: CodexEntryId: string?
└── ADD: DocumentIds: IReadOnlyList<string>
```

### Combat Integration

```csharp
// In CombatService or CombatEncounter, after monster defeat:
public void ProcessMonsterDefeated(Monster monster, Player player)
{
    // Existing defeat logic...

    // Codex discovery
    var killCount = player.GetMonsterKillCount(monster.DefinitionId);
    var result = _discoveryService.ProcessDefeat(
        player.Id,
        monster.DefinitionId,
        killCount);

    if (result.HasDiscoveries)
    {
        // Notify player of discoveries
        foreach (var entry in result.NewEntries)
        {
            _logger.LogInformation("Player discovered codex entry: {Title}", entry.Title);
        }
    }
}
```

### User-Facing Changes

**Discovery Notifications:**
```
=== COMBAT VICTORY ===
You defeated the Goblin Shaman!
Experience gained: 25 XP
Loot: Shaman's Staff, 12 gold

[CODEX] New entry discovered: "Goblin Shaman"
[CODEX] Entry updated: "Goblin" (now Complete)

---

> examine skeleton
You examine the Skeleton Warrior carefully...

An animated skeleton clad in rusted armor. The magical energy holding
it together emanates from a glowing rune on its skull.

[CODEX] New entry discovered: "Skeleton Warrior"

---

> read scroll
You unroll the ancient scroll and read...

"In the Year of Shadows, the Necromancer King raised his army from
the fallen of the Great War..."

[CODEX] New entry discovered: "The Necromancer King"
[CODEX] Fragment collected: "Rise of the Undead" (2/4)
```

### Acceptance Criteria

- [ ] DiscoveryType enum covers all trigger types
- [ ] Defeating monsters unlocks bestiary entries
- [ ] Examining entities reveals codex information
- [ ] Dialogue with NPCs can unlock entries
- [ ] Reading documents adds history/lore entries
- [ ] First room visits can unlock location entries
- [ ] Discovery notifications display to player
- [ ] Repeat kills increase reveal level
- [ ] ~30 unit tests pass

---

## v0.2.1c: Fragments & Cross-References

### Overview

Implement the fragment collection system for piecing together legendary entries and the cross-reference system that links related codex entries together.

### Scope

**In Scope:**
- `CodexFragment` entity for partial lore
- Fragment collection mechanics
- Fragment completion tracking
- `CodexReference` value object for linking
- Cross-reference display in entries
- Related entry navigation
- Partial entry reveal from fragments
- Hint system for missing fragments

**Out of Scope:**
- Search functionality (v0.2.1d)
- Progress percentages (v0.2.1d)
- Achievement integration (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Entities | 1 | `CodexFragment` |
| Value Objects | 2 | `CodexReference`, `FragmentProgress` |
| Service Updates | 1 | Update `CodexService` for fragments |
| Configuration | 1 | `codex-fragments.json` |
| Unit Tests | ~25 | Fragment and reference tests |

### CodexFragment Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a collectible piece of a larger codex entry.
/// </summary>
public class CodexFragment : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the fragment's definition ID.
    /// </summary>
    public string FragmentId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the parent entry ID this fragment belongs to.
    /// </summary>
    public string ParentEntryId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the fragment's display title.
    /// </summary>
    public string Title { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the fragment's content text.
    /// </summary>
    public string Content { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the order of this fragment in the complete entry.
    /// </summary>
    public int Order { get; private set; }

    /// <summary>
    /// Gets the total number of fragments for the parent entry.
    /// </summary>
    public int TotalFragments { get; private set; }

    /// <summary>
    /// Gets whether this fragment has been collected.
    /// </summary>
    public bool IsCollected { get; private set; }

    /// <summary>
    /// Gets when this fragment was collected.
    /// </summary>
    public DateTime? CollectedAt { get; private set; }

    /// <summary>
    /// Gets the player who owns this fragment instance.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets a hint about where to find this fragment.
    /// </summary>
    public string? LocationHint { get; private set; }

    /// <summary>
    /// Gets the source type for collection.
    /// </summary>
    public DiscoveryType SourceType { get; private set; }

    /// <summary>
    /// Gets the source ID for collection.
    /// </summary>
    public string? SourceId { get; private set; }

    private CodexFragment() { /* EF Core */ }

    /// <summary>
    /// Creates a new codex fragment.
    /// </summary>
    public static CodexFragment Create(
        string fragmentId,
        string parentEntryId,
        string title,
        string content,
        int order,
        int totalFragments,
        Guid playerId,
        string? locationHint = null,
        DiscoveryType sourceType = DiscoveryType.Document,
        string? sourceId = null)
    {
        return new CodexFragment
        {
            Id = Guid.NewGuid(),
            FragmentId = fragmentId,
            ParentEntryId = parentEntryId,
            Title = title,
            Content = content,
            Order = order,
            TotalFragments = totalFragments,
            IsCollected = false,
            PlayerId = playerId,
            LocationHint = locationHint,
            SourceType = sourceType,
            SourceId = sourceId
        };
    }

    /// <summary>
    /// Marks this fragment as collected.
    /// </summary>
    public void Collect()
    {
        if (!IsCollected)
        {
            IsCollected = true;
            CollectedAt = DateTime.UtcNow;
        }
    }
}
```

### CodexReference Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a cross-reference link between codex entries.
/// </summary>
public readonly record struct CodexReference
{
    /// <summary>
    /// Gets the target entry ID.
    /// </summary>
    public string TargetEntryId { get; init; }

    /// <summary>
    /// Gets the display text for the reference.
    /// </summary>
    public string DisplayText { get; init; }

    /// <summary>
    /// Gets the type of relationship.
    /// </summary>
    public ReferenceType Type { get; init; }

    /// <summary>
    /// Gets whether the target entry must be discovered to show.
    /// </summary>
    public bool RequiresDiscovery { get; init; }
}

/// <summary>
/// Types of cross-reference relationships.
/// </summary>
public enum ReferenceType
{
    /// <summary>General related topic.</summary>
    Related,

    /// <summary>Entry is a sub-topic of this entry.</summary>
    SubTopic,

    /// <summary>Entry is the parent topic.</summary>
    ParentTopic,

    /// <summary>Entry mentions this topic.</summary>
    Mentions,

    /// <summary>Entry is contradicted by this entry.</summary>
    Contradicts,

    /// <summary>Entry continues this entry's story.</summary>
    Continues
}
```

### FragmentProgress Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks progress toward completing a fragmented entry.
/// </summary>
public readonly record struct FragmentProgress
{
    /// <summary>
    /// Gets the parent entry ID.
    /// </summary>
    public string EntryId { get; init; }

    /// <summary>
    /// Gets collected fragment IDs.
    /// </summary>
    public IReadOnlyList<string> CollectedFragmentIds { get; init; }

    /// <summary>
    /// Gets the total number of fragments.
    /// </summary>
    public int TotalFragments { get; init; }

    /// <summary>
    /// Gets the number of collected fragments.
    /// </summary>
    public int CollectedCount => CollectedFragmentIds.Count;

    /// <summary>
    /// Gets whether all fragments are collected.
    /// </summary>
    public bool IsComplete => CollectedCount >= TotalFragments;

    /// <summary>
    /// Gets the completion percentage.
    /// </summary>
    public int CompletionPercent => TotalFragments > 0
        ? (CollectedCount * 100) / TotalFragments
        : 0;

    /// <summary>
    /// Gets hints for missing fragments.
    /// </summary>
    public IReadOnlyList<string> MissingHints { get; init; }
}
```

### CodexService Updates

```csharp
// Additional methods for ICodexService

/// <summary>
/// Collects a fragment for a player.
/// </summary>
CodexFragment? CollectFragment(Guid playerId, string fragmentId);

/// <summary>
/// Gets fragment progress for an entry.
/// </summary>
FragmentProgress GetFragmentProgress(Guid playerId, string entryId);

/// <summary>
/// Gets all fragments for an entry.
/// </summary>
IEnumerable<CodexFragment> GetFragments(Guid playerId, string entryId);

/// <summary>
/// Gets related entries for cross-referencing.
/// </summary>
IEnumerable<CodexReference> GetReferences(Guid playerId, string entryId);

/// <summary>
/// Checks if completing fragments should unlock the entry.
/// </summary>
bool CheckFragmentCompletion(Guid playerId, string entryId);
```

### User-Facing Changes

**Fragment Collection:**
```
> read ancient tome
You carefully read the crumbling pages...

"...and so the Sundering began. The great rift tore the world asunder,
and from the depths rose the First Shadow..."

[CODEX] Fragment collected: "The Sundering" (3/5)
  "Only 2 fragments remain to complete this entry."
  Hint: "Legends speak of similar texts in the Deep Archives."

---

> codex "The Sundering"
=== THE SUNDERING ===
Category: Legends
Status: Incomplete (3/5 fragments)

[Fragment 1 - The Warning]
"Before the breaking, the seers spoke of darkness..."

[Fragment 2 - The Ritual]
"Seven mages gathered at the Nexus, their power combined..."

[Fragment 3 - The Aftermath]
"...and so the Sundering began. The great rift tore the world asunder..."

[Fragment 4 - ???]
  Hint: "Said to be inscribed on the walls of the Shadow Temple."

[Fragment 5 - ???]
  Hint: "A scholar in the Eastern Archives may know more."

---

> codex goblin
=== GOBLIN ===
[... entry content ...]

Related Entries:
  * Goblin Shaman (Bestiary) - discovered
  * Goblin Chieftain (Bestiary) - discovered
  * Orcish Alliance (Factions) - not yet discovered
  * Goblin Warrens (Locations) - discovered
```

### Configuration Example

```json
{
  "$schema": "../schemas/codex-fragments.schema.json",
  "fragments": [
    {
      "fragmentId": "sundering-fragment-1",
      "parentEntryId": "legend-the-sundering",
      "title": "The Warning",
      "content": "Before the breaking, the seers spoke of darkness...",
      "order": 1,
      "totalFragments": 5,
      "locationHint": "Found in the ruins of the Old Library.",
      "sourceType": "Document",
      "sourceId": "item-ancient-prophecy-scroll"
    },
    {
      "fragmentId": "sundering-fragment-4",
      "parentEntryId": "legend-the-sundering",
      "title": "The Sacrifice",
      "content": "One must fall so that the rift may close...",
      "order": 4,
      "totalFragments": 5,
      "locationHint": "Said to be inscribed on the walls of the Shadow Temple.",
      "sourceType": "Explore",
      "sourceId": "room-shadow-temple-inner-sanctum"
    }
  ]
}
```

### Acceptance Criteria

- [ ] CodexFragment can be created and collected
- [ ] Fragments belong to parent entries
- [ ] Collecting all fragments completes the entry
- [ ] Incomplete entries show collected fragments
- [ ] Missing fragment hints display
- [ ] Cross-references link related entries
- [ ] Reference display respects discovery state
- [ ] Fragment progress tracks correctly
- [ ] ~25 unit tests pass

---

## v0.2.1d: Progress & UI

### Overview

Implement completion tracking, search functionality, discovery hints, and the full TUI codex interface for navigating and exploring the encyclopedia.

### Scope

**In Scope:**
- `CodexProgress` entity for tracking discoveries
- Category completion percentages
- Total discovery progress
- `codex search <term>` command
- Search by title, tags, and content
- Discovery hints for incomplete entries
- Full TUI codex interface
- Category navigation
- Entry browsing

**Out of Scope:**
- GUI codex interface (future version)
- Achievement system integration (future version)
- Codex export functionality (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Entities | 1 | `CodexProgress` |
| Value Objects | 2 | `CategoryProgress`, `SearchResult` |
| Services | 1 | `CodexSearchService` |
| Commands | 1 | `codex search <term>` |
| TUI Updates | 1 | Full codex interface |
| Unit Tests | ~20 | Progress and search tests |

### CodexProgress Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Tracks a player's codex discovery progress.
/// </summary>
public class CodexProgress : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the player ID.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the total entries discovered.
    /// </summary>
    public int TotalDiscovered { get; private set; }

    /// <summary>
    /// Gets the total entries available.
    /// </summary>
    public int TotalEntries { get; private set; }

    /// <summary>
    /// Gets progress per category.
    /// </summary>
    public IReadOnlyDictionary<CodexCategory, CategoryProgress> CategoryProgress { get; private set; }
        = new Dictionary<CodexCategory, CategoryProgress>();

    /// <summary>
    /// Gets the total fragments collected.
    /// </summary>
    public int FragmentsCollected { get; private set; }

    /// <summary>
    /// Gets the total fragments available.
    /// </summary>
    public int TotalFragments { get; private set; }

    /// <summary>
    /// Gets entries completed to full reveal.
    /// </summary>
    public int EntriesCompleted { get; private set; }

    /// <summary>
    /// Gets the last discovery timestamp.
    /// </summary>
    public DateTime? LastDiscovery { get; private set; }

    /// <summary>
    /// Gets milestones achieved.
    /// </summary>
    public IReadOnlyList<string> Milestones { get; private set; } = Array.Empty<string>();

    private CodexProgress() { /* EF Core */ }

    /// <summary>
    /// Creates progress tracking for a player.
    /// </summary>
    public static CodexProgress Create(Guid playerId, int totalEntries, int totalFragments)
    {
        return new CodexProgress
        {
            Id = Guid.NewGuid(),
            PlayerId = playerId,
            TotalDiscovered = 0,
            TotalEntries = totalEntries,
            TotalFragments = totalFragments,
            FragmentsCollected = 0,
            EntriesCompleted = 0
        };
    }

    /// <summary>
    /// Records a discovery.
    /// </summary>
    public void RecordDiscovery(CodexCategory category, bool isComplete)
    {
        TotalDiscovered++;
        LastDiscovery = DateTime.UtcNow;

        if (isComplete)
            EntriesCompleted++;

        UpdateCategoryProgress(category);
        CheckMilestones();
    }

    /// <summary>
    /// Records a fragment collection.
    /// </summary>
    public void RecordFragment()
    {
        FragmentsCollected++;
        CheckMilestones();
    }

    /// <summary>
    /// Gets overall completion percentage.
    /// </summary>
    public int GetOverallPercent()
    {
        return TotalEntries > 0 ? (TotalDiscovered * 100) / TotalEntries : 0;
    }

    private void UpdateCategoryProgress(CodexCategory category)
    {
        // Update category-specific progress
        var progress = new Dictionary<CodexCategory, CategoryProgress>(CategoryProgress);

        if (!progress.TryGetValue(category, out var current))
        {
            current = new CategoryProgress { Discovered = 0, Total = 0 };
        }

        progress[category] = current with { Discovered = current.Discovered + 1 };
        CategoryProgress = progress;
    }

    private void CheckMilestones()
    {
        var milestones = Milestones.ToList();
        var percent = GetOverallPercent();

        if (percent >= 25 && !milestones.Contains("quarter-complete"))
            milestones.Add("quarter-complete");
        if (percent >= 50 && !milestones.Contains("half-complete"))
            milestones.Add("half-complete");
        if (percent >= 75 && !milestones.Contains("three-quarters-complete"))
            milestones.Add("three-quarters-complete");
        if (percent >= 100 && !milestones.Contains("codex-master"))
            milestones.Add("codex-master");

        Milestones = milestones;
    }
}
```

### CategoryProgress Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Progress within a specific codex category.
/// </summary>
public readonly record struct CategoryProgress
{
    /// <summary>
    /// Gets the number of discovered entries.
    /// </summary>
    public int Discovered { get; init; }

    /// <summary>
    /// Gets the total entries in category.
    /// </summary>
    public int Total { get; init; }

    /// <summary>
    /// Gets entries with complete reveal.
    /// </summary>
    public int Completed { get; init; }

    /// <summary>
    /// Gets the discovery percentage.
    /// </summary>
    public int DiscoveryPercent => Total > 0 ? (Discovered * 100) / Total : 0;

    /// <summary>
    /// Gets the completion percentage.
    /// </summary>
    public int CompletionPercent => Discovered > 0 ? (Completed * 100) / Discovered : 0;
}
```

### SearchResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of a codex search.
/// </summary>
public readonly record struct SearchResult
{
    /// <summary>
    /// Gets the matching entry.
    /// </summary>
    public CodexEntry Entry { get; init; }

    /// <summary>
    /// Gets the match type.
    /// </summary>
    public SearchMatchType MatchType { get; init; }

    /// <summary>
    /// Gets the relevance score.
    /// </summary>
    public int Relevance { get; init; }

    /// <summary>
    /// Gets the matched text snippet.
    /// </summary>
    public string? MatchSnippet { get; init; }
}

/// <summary>
/// Types of search matches.
/// </summary>
public enum SearchMatchType
{
    /// <summary>Exact title match.</summary>
    TitleExact,

    /// <summary>Partial title match.</summary>
    TitlePartial,

    /// <summary>Tag match.</summary>
    Tag,

    /// <summary>Content match.</summary>
    Content
}
```

### CodexSearchService

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Provides search functionality for the codex.
/// </summary>
public interface ICodexSearchService
{
    /// <summary>
    /// Searches codex entries by term.
    /// </summary>
    IEnumerable<SearchResult> Search(Guid playerId, string searchTerm);

    /// <summary>
    /// Searches within a specific category.
    /// </summary>
    IEnumerable<SearchResult> SearchInCategory(
        Guid playerId,
        string searchTerm,
        CodexCategory category);

    /// <summary>
    /// Gets suggestions based on partial input.
    /// </summary>
    IEnumerable<string> GetSuggestions(Guid playerId, string partialTerm, int maxResults = 5);
}
```

### User-Facing Changes

**Search Command:**
```
> codex search goblin
=== CODEX SEARCH: "goblin" ===

Found 4 results:

[Bestiary] Goblin (Complete)
  "Small, green-skinned creatures that infest..."

[Bestiary] Goblin Shaman (Standard)
  "...goblin shamans serve as spiritual leaders..."

[Bestiary] Goblin Chieftain (Basic)
  "The strongest goblins rise to become chieftains..."

[Locations] Goblin Warrens (Standard)
  "A maze of tunnels where goblins make their home..."

---

> codex search "fire damage"
=== CODEX SEARCH: "fire damage" ===

Found 2 results:

[Bestiary] Goblin (Complete)
  "...Vulnerable to fire damage..."

[Bestiary] Ice Elemental (Standard)
  "...takes double fire damage but is immune to cold..."
```

**Progress Display:**
```
> codex
=== CODEX ===

Overall Progress: 24/73 entries (33%)
████████░░░░░░░░░░░░░░░░ 33%

Categories:
  Bestiary ................ 8/12 (67%)  ████████████░░░░░░
  Locations ............... 4/8  (50%)  ██████████░░░░░░░░
  Items & Artifacts ....... 7/20 (35%)  ███████░░░░░░░░░░░
  Characters .............. 3/6  (50%)  ██████████░░░░░░░░
  Factions ................ 2/4  (50%)  ██████████░░░░░░░░
  History ................. 0/10 (0%)   ░░░░░░░░░░░░░░░░░░
  Legends ................. 0/5  (0%)   ░░░░░░░░░░░░░░░░░░
  Crafting Knowledge ...... 0/8  (0%)   ░░░░░░░░░░░░░░░░░░

Fragments: 12/25 collected
Entries Completed: 15/24 discovered

Recent Discoveries:
  * Goblin Shaman (2 hours ago)
  * Iron Sword (yesterday)
  * The Eastern Tunnels (3 days ago)

Commands:
  codex <category>     - View category
  codex <entry>        - View entry
  codex search <term>  - Search entries
```

**Hints for Incomplete Entries:**
```
> codex "skeleton warrior"
=== SKELETON WARRIOR ===
Category: Bestiary
Status: Basic (more to discover)

An animated skeleton clad in rusted armor.

[More information available]
  Hint: "Defeat more Skeleton Warriors to learn their weaknesses."
  Hint: "Examine a Skeleton Warrior closely to learn its origins."
```

### Acceptance Criteria

- [ ] CodexProgress tracks per-player discoveries
- [ ] Category completion percentages display correctly
- [ ] Overall progress percentage accurate
- [ ] `codex search` finds entries by title
- [ ] Search finds entries by tags
- [ ] Search finds entries by content
- [ ] Results sorted by relevance
- [ ] Discovery hints show for incomplete entries
- [ ] Progress bar visualization in TUI
- [ ] Recent discoveries list displays
- [ ] ~20 unit tests pass

---

## Dependencies & Prerequisites

```
v0.2.0 (NPCs & Dialogue) - REQUIRED
    │
    ├── NPC entity ─────────────────────┐
    ├── DialogueOutcome ────────────────┤
    ├── FactionDefinition ──────────────┤
    └── Player reputation ──────────────┘
                                        │
                                        ▼
v0.2.1 (Codex & Lore Discovery)
    │
    ├── v0.2.1a: Codex Foundation ──────────────────┐
    │       Dependencies: Base entities              │
    │                                                │
    ├── v0.2.1b: Discovery Mechanics ───────────────┤
    │       Dependencies: v0.2.1a, Combat, NPCs      │
    │                                                │
    ├── v0.2.1c: Fragments & Cross-References ──────┤
    │       Dependencies: v0.2.1a, v0.2.1b           │
    │                                                │
    └── v0.2.1d: Progress & UI ─────────────────────┘
            Dependencies: v0.2.1a, v0.2.1b, v0.2.1c
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.2.1a | ~8 | ~3 | ~25 | Medium |
| v0.2.1b | ~5 | ~6 | ~30 | High |
| v0.2.1c | ~4 | ~3 | ~25 | Medium |
| v0.2.1d | ~5 | ~4 | ~20 | Medium |
| **Total** | **~22** | **~16** | **~100** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Content volume overwhelming | Medium | Medium | Start with core entries, expand iteratively |
| Discovery triggers complexity | High | Medium | Clear trigger hierarchy, thorough testing |
| Search performance with large codex | Medium | Low | Index entries, limit search scope |
| Fragment tracking complexity | Medium | Low | Simple collection model, clear UI |
| Cross-reference cycles | Low | Low | Validate references at load time |

---

## Design Decisions (Confirmed)

### Codex Architecture

| Decision | Value | Notes |
|----------|-------|-------|
| **Entry Storage** | Per-player instances | Each player has their own discovery state |
| **Category Organization** | Enum-based | 8 fixed categories from spec |
| **Reveal System** | 5 levels | Hidden → Basic → Standard → Detailed → Complete |

### Discovery System

| Decision | Value | Notes |
|----------|-------|-------|
| **Trigger Types** | 10 types | Covers all specified discovery methods |
| **Multi-trigger Support** | Yes | Same entry can have multiple unlock paths |
| **Progressive Reveal** | Yes | Different actions reveal different levels |

### Fragment System

| Decision | Value | Notes |
|----------|-------|-------|
| **Fragment Storage** | Separate entity | Fragments independent of main entries |
| **Completion Behavior** | Auto-unlock | All fragments → entry becomes Complete |
| **Hint System** | Per-fragment | Each fragment has location hint |

---

## Integration Points

### From v0.2.0
- NPC dialogue triggers character/faction entries
- Reputation changes can unlock faction codex content
- Companion dialogue provides character backgrounds

### To v0.2.2 (Merchant System)
- Item codex entries provide price/value hints
- Crafting knowledge entries inform merchant inventory

### To v0.3.0 (Quests)
- Quest completion can unlock history entries
- Codex entries can provide quest hints
- Quest journal integrates with codex for lore context

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.2.1a Design Spec** - Create detailed design specification
3. **Implement v0.2.1a** - Build codex foundation
4. **v0.2.1b Design Spec** - Discovery mechanics details
5. **Implement v0.2.1b** - Build discovery system
6. **Repeat for v0.2.1c, v0.2.1d**

---

*This scope breakdown provides a structured approach to implementing v0.2.1 Codex & Lore Discovery. Each sub-phase builds on the previous, allowing for incremental development and testing while creating a rich discovery-based knowledge system.*
