# v0.16.5e Design Specification: Legendary Drop Presentation

## Document Information

| Field               | Value                                                               |
| ------------------- | ------------------------------------------------------------------- |
| **Version**         | v0.16.5e                                                            |
| **Feature**         | Legendary Drop Presentation                                         |
| **Status**          | Draft                                                               |
| **Dependencies**    | v0.16.5a-d (UniqueItem, SpecialEffect, Registry, MythForgedService) |
| **Estimated Tests** | 15                                                                  |

---

## 1. Executive Summary

Version 0.16.5e implements special visual presentation for Myth-Forged (legendary) item drops. This phase creates the `MythForgedDropEvent` value object, defines the `ILegendaryPresentation` interface for rendering exciting drop announcements, establishes tier-based color constants, and provides formatting for examination text that includes lore and special effect descriptions. The goal is to make legendary drops feel special and memorable.

### 1.1 Feature Overview

```
v0.16.5e: Legendary Drop Presentation
├── Domain Layer
│   ├── MythForgedDropEvent Value Object
│   │   ├── UniqueItem reference
│   │   ├── DropSource information
│   │   ├── Timestamp
│   │   └── IsFirstOfRun flag
│   └── TierColors Static Class
│       ├── JuryRigged (Gray #808080)
│       ├── Scavenged (White #FFFFFF)
│       ├── ClanForged (Green #00FF00)
│       ├── Optimized (Purple #800080)
│       └── MythForged (Gold #FFD700)
├── Application Layer
│   └── ILegendaryPresentation Interface
│       ├── FormatDropAnnouncement(event) → string
│       ├── FormatExaminationText(item) → string
│       ├── GetTierColor(tier) → string
│       └── FormatEffectList(effects) → string
└── Presentation Elements
    ├── Drop announcement banner
    ├── Atmospheric lore text
    ├── Stat line formatting
    └── Special effect descriptions
```

### 1.2 Goals

1. Create `MythForgedDropEvent` value object for drop context
2. Define `ILegendaryPresentation` interface for rendering
3. Establish tier color constants (5 tiers)
4. Format exciting drop announcements with lore
5. Format detailed examination text with effects

### 1.3 Non-Goals (Deferred)

- Achievement integration hooks (v0.16.5f)
- Audio effects for legendary drops (future)
- Animation/particle effects (future)
- Localization support (future)

---

## 2. Architecture

### 2.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                           │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              LegendaryDropRenderer                          ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ Renders drop announcements to TUI/GUI                   │││
│  │  │ Uses ILegendaryPresentation for formatting              │││
│  │  │ Applies TierColors for styling                          │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              ILegendaryPresentation Interface               ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ FormatDropAnnouncement(event) → string                  │││
│  │  │ FormatExaminationText(item) → string                    │││
│  │  │ FormatStatLine(stats) → string                          │││
│  │  │ FormatEffectList(effects) → string                      │││
│  │  │ GetAnnouncementFrame() → (top, bottom)                  │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              MythForgedDropEvent (VO)                     │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Item: UniqueItem                                    │  │  │
│  │  │ SourceType: DropSourceType                          │  │  │
│  │  │ SourceId: string                                    │  │  │
│  │  │ DroppedAt: DateTime                                 │  │  │
│  │  │ IsFirstOfRun: bool                                  │  │  │
│  │  │ PlayerLevel: int                                    │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  TierColors (Static)                      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ JuryRigged  = "#808080" (Gray)                      │  │  │
│  │  │ Scavenged   = "#FFFFFF" (White)                     │  │  │
│  │  │ ClanForged  = "#00FF00" (Green)                     │  │  │
│  │  │ Optimized   = "#800080" (Purple)                    │  │  │
│  │  │ MythForged  = "#FFD700" (Gold)                      │  │  │
│  │  ├─────────────────────────────────────────────────────┤  │  │
│  │  │ GetColor(QualityTier) → string                      │  │  │
│  │  │ GetColorName(QualityTier) → string                  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Drop Announcement Flow

```
┌─────────────────────────────────────────────────────────────────┐
│              DROP ANNOUNCEMENT FLOW                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  MYTH-FORGED DROP OCCURS                                        │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 1: Create MythForgedDropEvent                       │   │
│  │                                                          │   │
│  │  event = MythForgedDropEvent.Create(                     │   │
│  │      item: droppedItem,                                  │   │
│  │      sourceType: context.SourceType,                     │   │
│  │      sourceId: context.SourceId,                         │   │
│  │      isFirstOfRun: registry.GetDroppedCount() == 1,      │   │
│  │      playerLevel: player.Level)                          │   │
│  │                                                          │   │
│  └────────────────────────────┬─────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 2: Format Announcement                              │   │
│  │                                                          │   │
│  │  announcement = presentation.FormatDropAnnouncement(     │   │
│  │      event)                                              │   │
│  │                                                          │   │
│  │  Components:                                             │   │
│  │  ├─ Top border (═══════════════════════════════)         │   │
│  │  ├─ Header (✦ LEGENDARY DROP ✦)                         │   │
│  │  ├─ Atmospheric text (varies by source)                  │   │
│  │  ├─ Item name with [Myth-Forged] prefix                  │   │
│  │  ├─ Stat line (damage, bonuses, effects)                 │   │
│  │  └─ Bottom border (═══════════════════════════════)      │   │
│  │                                                          │   │
│  └────────────────────────────┬─────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 3: Apply Styling                                    │   │
│  │                                                          │   │
│  │  color = TierColors.GetColor(QualityTier.Legendary)      │   │
│  │  // Returns "#FFD700" (Gold)                             │   │
│  │                                                          │   │
│  │  Apply color to:                                         │   │
│  │  ├─ Item name                                            │   │
│  │  ├─ Border decorations                                   │   │
│  │  └─ Special effect names                                 │   │
│  │                                                          │   │
│  └────────────────────────────┬─────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 4: Render to Display                                │   │
│  │                                                          │   │
│  │  renderer.DisplayAnnouncement(announcement, color)       │   │
│  │                                                          │   │
│  │  Duration: 3-5 seconds (configurable)                    │   │
│  │  Position: Center of screen                              │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Examination Text Structure

```
┌─────────────────────────────────────────────────────────────────┐
│              EXAMINATION TEXT STRUCTURE                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    EXAMINATION OUTPUT                    │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  ══════════════════════════════════════════════════════  │   │
│  │                                                          │   │
│  │  [Myth-Forged] Shadowfang Blade                         │   │
│  │  ─────────────────────────────────                      │   │
│  │                                                          │   │
│  │  "The shadows remember what the light forgets."         │   │
│  │                            - Unknown                     │   │
│  │                                                          │   │
│  │  A blade forged in eternal darkness that drains         │   │
│  │  life from foes.                                        │   │
│  │                                                          │   │
│  │  ─────────────────────────────────                      │   │
│  │  STATS                                                   │   │
│  │  ├─ Might:       +5                                      │   │
│  │  ├─ Agility:     +2                                      │   │
│  │  └─ Bonus Damage: +15                                    │   │
│  │                                                          │   │
│  │  ─────────────────────────────────                      │   │
│  │  SPECIAL EFFECTS                                         │   │
│  │  ✦ Life Steal - Heals 15% of damage dealt               │   │
│  │  ✦ Shadow Damage - Deals 10 shadow damage on hit        │   │
│  │                                                          │   │
│  │  ─────────────────────────────────                      │   │
│  │  Requirements: Level 10 | Warrior, Rogue                │   │
│  │                                                          │   │
│  │  ══════════════════════════════════════════════════════  │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Data Model

### 3.1 TierColors Static Class

**Location:** `src/Core/RuneAndRust.Domain/Constants/TierColors.cs`

```csharp
namespace RuneAndRust.Domain.Constants;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Color constants for quality tiers.
/// Provides hex colors and names for consistent styling across TUI and GUI.
/// </summary>
public static class TierColors
{
    /// <summary>Tier 0: Jury-Rigged (Gray)</summary>
    public const string JuryRigged = "#808080";

    /// <summary>Tier 1: Scavenged (White)</summary>
    public const string Scavenged = "#FFFFFF";

    /// <summary>Tier 2: Clan-Forged (Green)</summary>
    public const string ClanForged = "#00FF00";

    /// <summary>Tier 3: Optimized (Purple)</summary>
    public const string Optimized = "#800080";

    /// <summary>Tier 4: Myth-Forged/Legendary (Gold)</summary>
    public const string MythForged = "#FFD700";

    /// <summary>Border decoration for legendary announcements</summary>
    public const string LegendaryBorder = "#FFD700";

    /// <summary>Accent color for special effects</summary>
    public const string EffectAccent = "#FFAA00";

    /// <summary>
    /// Gets the hex color for a quality tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>Hex color string (e.g., "#FFD700").</returns>
    public static string GetColor(QualityTier tier) =>
        tier switch
        {
            QualityTier.JuryRigged => JuryRigged,
            QualityTier.Scavenged => Scavenged,
            QualityTier.ClanForged => ClanForged,
            QualityTier.Optimized => Optimized,
            QualityTier.Legendary => MythForged,
            _ => Scavenged
        };

    /// <summary>
    /// Gets the tier index (0-4) color.
    /// </summary>
    public static string GetColorByIndex(int tierIndex) =>
        tierIndex switch
        {
            0 => JuryRigged,
            1 => Scavenged,
            2 => ClanForged,
            3 => Optimized,
            4 => MythForged,
            _ => Scavenged
        };

    /// <summary>
    /// Gets the display name of a tier's color.
    /// </summary>
    public static string GetColorName(QualityTier tier) =>
        tier switch
        {
            QualityTier.JuryRigged => "Gray",
            QualityTier.Scavenged => "White",
            QualityTier.ClanForged => "Green",
            QualityTier.Optimized => "Purple",
            QualityTier.Legendary => "Gold",
            _ => "White"
        };

    /// <summary>
    /// Gets the tier prefix text with brackets.
    /// </summary>
    public static string GetTierPrefix(QualityTier tier) =>
        tier switch
        {
            QualityTier.JuryRigged => "[Jury-Rigged]",
            QualityTier.Scavenged => "[Scavenged]",
            QualityTier.ClanForged => "[Clan-Forged]",
            QualityTier.Optimized => "[Optimized]",
            QualityTier.Legendary => "[Myth-Forged]",
            _ => ""
        };
}
```

### 3.2 MythForgedDropEvent Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/MythForgedDropEvent.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents a Myth-Forged item drop event for presentation purposes.
/// Contains all context needed to render an exciting drop announcement.
/// </summary>
public readonly record struct MythForgedDropEvent
{
    /// <summary>The unique item that dropped.</summary>
    public UniqueItem Item { get; }

    /// <summary>Type of source that generated the drop.</summary>
    public DropSourceType SourceType { get; }

    /// <summary>Specific source identifier.</summary>
    public string SourceId { get; }

    /// <summary>When the drop occurred.</summary>
    public DateTime DroppedAt { get; }

    /// <summary>Whether this is the first Myth-Forged drop of the run.</summary>
    public bool IsFirstOfRun { get; }

    /// <summary>Player's level when the drop occurred.</summary>
    public int PlayerLevel { get; }

    private MythForgedDropEvent(
        UniqueItem item,
        DropSourceType sourceType,
        string sourceId,
        DateTime droppedAt,
        bool isFirstOfRun,
        int playerLevel)
    {
        Item = item;
        SourceType = sourceType;
        SourceId = sourceId;
        DroppedAt = droppedAt;
        IsFirstOfRun = isFirstOfRun;
        PlayerLevel = playerLevel;
    }

    /// <summary>
    /// Creates a new MythForgedDropEvent with validation.
    /// </summary>
    public static MythForgedDropEvent Create(
        UniqueItem item,
        DropSourceType sourceType,
        string sourceId,
        bool isFirstOfRun = false,
        int playerLevel = 1,
        DateTime? droppedAt = null)
    {
        ArgumentNullException.ThrowIfNull(item, nameof(item));
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceId, nameof(sourceId));
        ArgumentOutOfRangeException.ThrowIfLessThan(playerLevel, 1, nameof(playerLevel));

        return new MythForgedDropEvent(
            item,
            sourceType,
            sourceId.ToLowerInvariant(),
            droppedAt ?? DateTime.UtcNow,
            isFirstOfRun,
            playerLevel);
    }

    /// <summary>
    /// Gets atmospheric text based on the drop source.
    /// </summary>
    public string GetAtmosphericText() =>
        SourceType switch
        {
            DropSourceType.Boss => "The air hums with ancient power. A legendary relic lies before you.",
            DropSourceType.Container => "As the lid opens, golden light spills forth. Something legendary awaits.",
            DropSourceType.Quest => "Your deeds have been rewarded. A legend is now yours to wield.",
            DropSourceType.Monster => "From the fallen foe, a treasure beyond measure emerges.",
            DropSourceType.Vendor => "The merchant's eyes widen as they present their finest work.",
            _ => "A legendary item has been discovered."
        };

    /// <summary>
    /// Gets a special message for first drop of run.
    /// </summary>
    public string? GetFirstDropMessage() =>
        IsFirstOfRun ? "Your first legendary of this journey!" : null;

    public override string ToString() =>
        $"MythForgedDropEvent[{Item.ItemId} from {SourceType}:{SourceId}]";
}
```

### 3.3 ILegendaryPresentation Interface

**Location:** `src/Core/RuneAndRust.Application/Interfaces/ILegendaryPresentation.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Interface for formatting legendary item presentations.
/// Provides methods for creating exciting drop announcements and detailed examination text.
/// </summary>
public interface ILegendaryPresentation
{
    /// <summary>
    /// Formats a full drop announcement for display.
    /// </summary>
    /// <param name="dropEvent">The drop event context.</param>
    /// <returns>Formatted multi-line announcement string.</returns>
    string FormatDropAnnouncement(MythForgedDropEvent dropEvent);

    /// <summary>
    /// Formats detailed examination text for a unique item.
    /// </summary>
    /// <param name="item">The unique item to examine.</param>
    /// <returns>Formatted multi-line examination string.</returns>
    string FormatExaminationText(UniqueItem item);

    /// <summary>
    /// Formats the stat bonuses as a display line.
    /// </summary>
    /// <param name="stats">The item stats.</param>
    /// <returns>Formatted stat line (e.g., "+5 Might | +2 Agility").</returns>
    string FormatStatLine(ItemStats stats);

    /// <summary>
    /// Formats a list of special effects for display.
    /// </summary>
    /// <param name="effects">The special effects.</param>
    /// <returns>Formatted multi-line effect list.</returns>
    string FormatEffectList(IReadOnlyList<SpecialEffect> effects);

    /// <summary>
    /// Gets the announcement frame borders.
    /// </summary>
    /// <param name="width">Desired width of the frame.</param>
    /// <returns>Tuple of (top border, bottom border).</returns>
    (string Top, string Bottom) GetAnnouncementFrame(int width = 47);

    /// <summary>
    /// Formats the item header with tier prefix and name.
    /// </summary>
    /// <param name="item">The unique item.</param>
    /// <returns>Formatted header (e.g., "[Myth-Forged] Shadowfang Blade").</returns>
    string FormatItemHeader(UniqueItem item);

    /// <summary>
    /// Formats class affinity requirements.
    /// </summary>
    /// <param name="classAffinities">List of class IDs.</param>
    /// <returns>Formatted class list or "All Classes".</returns>
    string FormatClassAffinities(IReadOnlyList<string> classAffinities);
}
```

### 3.4 LegendaryPresentationService Implementation

**Location:** `src/Core/RuneAndRust.Application/Services/LegendaryPresentationService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Constants;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;
using System.Text;

/// <summary>
/// Service for formatting legendary item presentations.
/// </summary>
public class LegendaryPresentationService : ILegendaryPresentation
{
    private const char BorderChar = '═';
    private const char DividerChar = '─';
    private const string LegendarySymbol = "✦";
    private const string EffectBullet = "✦";
    private const string StatBullet = "├─";
    private const string StatBulletLast = "└─";

    /// <inheritdoc />
    public string FormatDropAnnouncement(MythForgedDropEvent dropEvent)
    {
        var sb = new StringBuilder();
        var (top, bottom) = GetAnnouncementFrame();

        sb.AppendLine(top);
        sb.AppendLine($"{LegendarySymbol} LEGENDARY DROP {LegendarySymbol}");
        sb.AppendLine(dropEvent.GetAtmosphericText());
        sb.AppendLine();
        sb.AppendLine(FormatItemHeader(dropEvent.Item));
        sb.AppendLine(FormatStatLine(dropEvent.Item.Stats));

        var firstDropMsg = dropEvent.GetFirstDropMessage();
        if (firstDropMsg != null)
        {
            sb.AppendLine();
            sb.AppendLine(firstDropMsg);
        }

        sb.AppendLine(bottom);

        return sb.ToString();
    }

    /// <inheritdoc />
    public string FormatExaminationText(UniqueItem item)
    {
        var sb = new StringBuilder();
        var divider = new string(DividerChar, 37);
        var doubleLine = new string(BorderChar, 54);

        sb.AppendLine(doubleLine);
        sb.AppendLine();
        sb.AppendLine(FormatItemHeader(item));
        sb.AppendLine(divider);
        sb.AppendLine();

        // Flavor text
        if (!string.IsNullOrWhiteSpace(item.FlavorText))
        {
            sb.AppendLine($"\"{item.FlavorText}\"");
            sb.AppendLine();
        }

        // Description
        sb.AppendLine(item.Description);
        sb.AppendLine();

        // Stats section
        sb.AppendLine(divider);
        sb.AppendLine("STATS");
        sb.AppendLine(FormatStatsDetailed(item.Stats));
        sb.AppendLine();

        // Effects section (if any)
        if (item.SpecialEffectIds.Count > 0)
        {
            sb.AppendLine(divider);
            sb.AppendLine("SPECIAL EFFECTS");
            sb.AppendLine(FormatEffectIds(item.SpecialEffectIds));
            sb.AppendLine();
        }

        // Requirements
        sb.AppendLine(divider);
        sb.AppendLine($"Requirements: Level {item.RequiredLevel} | {FormatClassAffinities(item.ClassAffinities)}");
        sb.AppendLine();
        sb.AppendLine(doubleLine);

        return sb.ToString();
    }

    /// <inheritdoc />
    public string FormatStatLine(ItemStats stats)
    {
        var parts = new List<string>();

        if (stats.Might != 0) parts.Add($"+{stats.Might} MIGHT");
        if (stats.Agility != 0) parts.Add($"+{stats.Agility} AGI");
        if (stats.Will != 0) parts.Add($"+{stats.Will} WILL");
        if (stats.Fortitude != 0) parts.Add($"+{stats.Fortitude} FORT");
        if (stats.Arcana != 0) parts.Add($"+{stats.Arcana} ARC");
        if (stats.BonusDamage != 0) parts.Add($"+{stats.BonusDamage} Damage");
        if (stats.BonusDefense != 0) parts.Add($"+{stats.BonusDefense} Defense");
        if (stats.BonusHealth != 0) parts.Add($"+{stats.BonusHealth} HP");

        return parts.Count > 0 ? string.Join(" | ", parts) : "No stat bonuses";
    }

    /// <inheritdoc />
    public string FormatEffectList(IReadOnlyList<SpecialEffect> effects)
    {
        if (effects.Count == 0)
            return "No special effects";

        var sb = new StringBuilder();
        foreach (var effect in effects)
        {
            sb.AppendLine($"{EffectBullet} {FormatEffectName(effect.EffectType)} - {effect.Description}");
        }
        return sb.ToString().TrimEnd();
    }

    /// <inheritdoc />
    public (string Top, string Bottom) GetAnnouncementFrame(int width = 47)
    {
        var border = new string(BorderChar, width);
        return (border, border);
    }

    /// <inheritdoc />
    public string FormatItemHeader(UniqueItem item) =>
        $"{TierColors.GetTierPrefix(item.QualityTier)} {item.Name}";

    /// <inheritdoc />
    public string FormatClassAffinities(IReadOnlyList<string> classAffinities)
    {
        if (classAffinities.Count == 0)
            return "All Classes";

        return string.Join(", ", classAffinities.Select(c =>
            char.ToUpper(c[0]) + c[1..])); // Capitalize first letter
    }

    private string FormatStatsDetailed(ItemStats stats)
    {
        var lines = new List<string>();

        if (stats.Might != 0) lines.Add($"Might:        +{stats.Might}");
        if (stats.Agility != 0) lines.Add($"Agility:      +{stats.Agility}");
        if (stats.Will != 0) lines.Add($"Will:         +{stats.Will}");
        if (stats.Fortitude != 0) lines.Add($"Fortitude:    +{stats.Fortitude}");
        if (stats.Arcana != 0) lines.Add($"Arcana:       +{stats.Arcana}");
        if (stats.BonusHealth != 0) lines.Add($"Bonus Health: +{stats.BonusHealth}");
        if (stats.BonusDamage != 0) lines.Add($"Bonus Damage: +{stats.BonusDamage}");
        if (stats.BonusDefense != 0) lines.Add($"Bonus Defense: +{stats.BonusDefense}");

        if (lines.Count == 0)
            return $"{StatBulletLast} No stat bonuses";

        var sb = new StringBuilder();
        for (int i = 0; i < lines.Count; i++)
        {
            var bullet = i == lines.Count - 1 ? StatBulletLast : StatBullet;
            sb.AppendLine($"{bullet} {lines[i]}");
        }
        return sb.ToString().TrimEnd();
    }

    private string FormatEffectIds(IReadOnlyList<string> effectIds)
    {
        var sb = new StringBuilder();
        foreach (var effectId in effectIds)
        {
            // Format effect ID to display name (e.g., "life-steal" → "Life Steal")
            var displayName = string.Join(" ", effectId.Split('-')
                .Select(word => char.ToUpper(word[0]) + word[1..]));
            sb.AppendLine($"{EffectBullet} {displayName}");
        }
        return sb.ToString().TrimEnd();
    }

    private static string FormatEffectName(SpecialEffectType effectType) =>
        effectType switch
        {
            SpecialEffectType.IgnoreArmor => "Armor Pierce",
            SpecialEffectType.LifeSteal => "Life Steal",
            SpecialEffectType.Cleave => "Cleave",
            SpecialEffectType.Phase => "Phase Strike",
            SpecialEffectType.Reflect => "Damage Reflect",
            SpecialEffectType.FireDamage => "Fire Damage",
            SpecialEffectType.IceDamage => "Ice Damage",
            SpecialEffectType.LightningDamage => "Lightning Damage",
            SpecialEffectType.Slow => "Slow",
            SpecialEffectType.AutoHide => "Shadow Step",
            SpecialEffectType.Detection => "True Sight",
            SpecialEffectType.CriticalBonus => "Critical Edge",
            SpecialEffectType.DamageReduction => "Damage Reduction",
            SpecialEffectType.FearAura => "Fear Aura",
            _ => effectType.ToString()
        };
}
```

---

## 4. Logging Specification

### 4.1 Log Events

| Event                       | Level       | Template                                          |
| --------------------------- | ----------- | ------------------------------------------------- |
| Drop announcement formatted | Debug       | `"Formatted drop announcement for {ItemId}"`      |
| Examination text formatted  | Debug       | `"Formatted examination text for {ItemId}"`       |
| First drop of run           | Information | `"First Myth-Forged drop of run: {ItemId}"`       |
| Tier color retrieved        | Debug       | `"Retrieved color {Color} for tier {Tier}"`       |
| Effect list formatted       | Debug       | `"Formatted {Count} special effects for display"` |

---

## 5. Unit Testing

### 5.1 Test Classes

| Test Class                          | Location                          | Tests |
| ----------------------------------- | --------------------------------- | ----- |
| `TierColorsTests`                   | `Domain.UnitTests/Constants/`     | 5     |
| `MythForgedDropEventTests`          | `Domain.UnitTests/ValueObjects/`  | 5     |
| `LegendaryPresentationServiceTests` | `Application.UnitTests/Services/` | 5     |

### 5.2 TierColorsTests

```csharp
[TestFixture]
public class TierColorsTests
{
    [Test]
    [TestCase(QualityTier.JuryRigged, "#808080")]
    [TestCase(QualityTier.Scavenged, "#FFFFFF")]
    [TestCase(QualityTier.ClanForged, "#00FF00")]
    [TestCase(QualityTier.Optimized, "#800080")]
    [TestCase(QualityTier.Legendary, "#FFD700")]
    public void GetColor_ReturnCorrectHexForTier(QualityTier tier, string expected)
    {
        // Act
        var result = TierColors.GetColor(tier);

        // Assert
        result.Should().Be(expected);
    }

    [Test]
    [TestCase(0, "#808080")]
    [TestCase(4, "#FFD700")]
    public void GetColorByIndex_ReturnsCorrectColor(int index, string expected)
    {
        // Act
        var result = TierColors.GetColorByIndex(index);

        // Assert
        result.Should().Be(expected);
    }

    [Test]
    public void GetColorName_ForLegendary_ReturnsGold()
    {
        // Act
        var result = TierColors.GetColorName(QualityTier.Legendary);

        // Assert
        result.Should().Be("Gold");
    }

    [Test]
    public void GetTierPrefix_ForLegendary_ReturnsMythForged()
    {
        // Act
        var result = TierColors.GetTierPrefix(QualityTier.Legendary);

        // Assert
        result.Should().Be("[Myth-Forged]");
    }

    [Test]
    public void MythForgedConstant_IsGoldColor()
    {
        // Assert
        TierColors.MythForged.Should().Be("#FFD700");
    }
}
```

### 5.3 MythForgedDropEventTests

```csharp
[TestFixture]
public class MythForgedDropEventTests
{
    [Test]
    public void Create_WithValidData_CreatesEvent()
    {
        // Arrange
        var item = CreateTestUniqueItem();

        // Act
        var dropEvent = MythForgedDropEvent.Create(
            item,
            DropSourceType.Boss,
            "shadow-lord",
            isFirstOfRun: true,
            playerLevel: 10);

        // Assert
        dropEvent.Item.Should().Be(item);
        dropEvent.SourceType.Should().Be(DropSourceType.Boss);
        dropEvent.SourceId.Should().Be("shadow-lord");
        dropEvent.IsFirstOfRun.Should().BeTrue();
        dropEvent.PlayerLevel.Should().Be(10);
    }

    [Test]
    public void GetAtmosphericText_ForBoss_ReturnsExpectedText()
    {
        // Arrange
        var dropEvent = MythForgedDropEvent.Create(
            CreateTestUniqueItem(),
            DropSourceType.Boss,
            "boss");

        // Act
        var text = dropEvent.GetAtmosphericText();

        // Assert
        text.Should().Contain("ancient power");
    }

    [Test]
    public void GetFirstDropMessage_WhenFirstOfRun_ReturnsMessage()
    {
        // Arrange
        var dropEvent = MythForgedDropEvent.Create(
            CreateTestUniqueItem(),
            DropSourceType.Boss,
            "boss",
            isFirstOfRun: true);

        // Act
        var message = dropEvent.GetFirstDropMessage();

        // Assert
        message.Should().NotBeNull();
        message.Should().Contain("first legendary");
    }

    [Test]
    public void GetFirstDropMessage_WhenNotFirst_ReturnsNull()
    {
        // Arrange
        var dropEvent = MythForgedDropEvent.Create(
            CreateTestUniqueItem(),
            DropSourceType.Boss,
            "boss",
            isFirstOfRun: false);

        // Act
        var message = dropEvent.GetFirstDropMessage();

        // Assert
        message.Should().BeNull();
    }

    [Test]
    public void Create_WithNullItem_ThrowsArgumentNullException()
    {
        // Act
        var act = () => MythForgedDropEvent.Create(null!, DropSourceType.Boss, "boss");

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    private static UniqueItem CreateTestUniqueItem() =>
        UniqueItem.Create(
            "test-item", "Test Item", "Desc", "Flavor",
            ItemCategory.Weapon, ItemStats.Empty,
            new[] { DropSource.Create(DropSourceType.Boss, "boss", 5m) });
}
```

### 5.4 LegendaryPresentationServiceTests

```csharp
[TestFixture]
public class LegendaryPresentationServiceTests
{
    private LegendaryPresentationService _service = null!;

    [SetUp]
    public void SetUp()
    {
        _service = new LegendaryPresentationService();
    }

    [Test]
    public void FormatDropAnnouncement_ContainsLegendaryHeader()
    {
        // Arrange
        var item = CreateTestUniqueItem();
        var dropEvent = MythForgedDropEvent.Create(item, DropSourceType.Boss, "boss");

        // Act
        var result = _service.FormatDropAnnouncement(dropEvent);

        // Assert
        result.Should().Contain("LEGENDARY DROP");
        result.Should().Contain("[Myth-Forged]");
        result.Should().Contain(item.Name);
    }

    [Test]
    public void FormatStatLine_WithMultipleStats_FormatsCorrectly()
    {
        // Arrange
        var stats = ItemStats.Create(might: 5, agility: 2, bonusDamage: 15);

        // Act
        var result = _service.FormatStatLine(stats);

        // Assert
        result.Should().Contain("+5 MIGHT");
        result.Should().Contain("+2 AGI");
        result.Should().Contain("+15 Damage");
    }

    [Test]
    public void FormatItemHeader_IncludesTierPrefix()
    {
        // Arrange
        var item = CreateTestUniqueItem();

        // Act
        var result = _service.FormatItemHeader(item);

        // Assert
        result.Should().StartWith("[Myth-Forged]");
        result.Should().Contain(item.Name);
    }

    [Test]
    public void FormatClassAffinities_WithEmptyList_ReturnsAllClasses()
    {
        // Act
        var result = _service.FormatClassAffinities(Array.Empty<string>());

        // Assert
        result.Should().Be("All Classes");
    }

    [Test]
    public void GetAnnouncementFrame_ReturnsMatchingBorders()
    {
        // Act
        var (top, bottom) = _service.GetAnnouncementFrame(47);

        // Assert
        top.Should().HaveLength(47);
        bottom.Should().HaveLength(47);
        top.Should().Be(bottom);
    }

    private static UniqueItem CreateTestUniqueItem() =>
        UniqueItem.Create(
            "shadowfang-blade", "Shadowfang Blade",
            "A dark blade", "In shadows we trust",
            ItemCategory.Weapon,
            ItemStats.Create(might: 5, bonusDamage: 15),
            new[] { DropSource.Create(DropSourceType.Boss, "boss", 5m) },
            classAffinities: new[] { "warrior", "rogue" },
            specialEffectIds: new[] { "life-steal" });
}
```

---

## 6. Acceptance Criteria

| #   | Criterion                                          | Verification |
| --- | -------------------------------------------------- | ------------ |
| 1   | Myth-Forged color is Gold (#FFD700)                | Unit test    |
| 2   | All 5 tier colors are defined                      | Unit test    |
| 3   | Drop announcement contains "LEGENDARY DROP" header | Unit test    |
| 4   | Atmospheric text varies by source type             | Unit test    |
| 5   | First drop of run shows special message            | Unit test    |
| 6   | Stat line formats with pipe separators             | Unit test    |
| 7   | Item header includes [Myth-Forged] prefix          | Unit test    |
| 8   | Empty class affinities shows "All Classes"         | Unit test    |
| 9   | Examination text includes flavor and description   | Unit test    |

---

## 7. Deliverable Checklist

### 7.1 Domain Layer

- [ ] `TierColors.cs` - Static class with color constants
- [ ] `MythForgedDropEvent.cs` - Value object for drop context

### 7.2 Application Layer

- [ ] `ILegendaryPresentation.cs` - Interface for presentation formatting
- [ ] `LegendaryPresentationService.cs` - Implementation

### 7.3 Tests

- [ ] `TierColorsTests.cs` - Color constants tests
- [ ] `MythForgedDropEventTests.cs` - Drop event tests
- [ ] `LegendaryPresentationServiceTests.cs` - Service tests

---

## 8. Dependencies

### 8.1 Required

| Dependency       | Version  | Purpose                  |
| ---------------- | -------- | ------------------------ |
| UniqueItem       | v0.16.5a | Item data for formatting |
| SpecialEffect    | v0.16.5b | Effect descriptions      |
| MythForgedResult | v0.16.5d | Drop context             |
| QualityTier      | v0.16.0  | Tier classification      |

### 8.2 Dependents

| Feature                 | Version  | Relationship             |
| ----------------------- | -------- | ------------------------ |
| Achievement Integration | v0.16.5f | Uses drop events         |
| TUI Renderer            | Future   | Consumes formatted text  |
| GUI Renderer            | Future   | Consumes colors and text |

---

## 9. Future Considerations

### 9.1 Deferred to v0.16.5f

- Achievement hooks for drop events
- Collection tracking display

### 9.2 Deferred to Later Versions

- Audio cues for legendary drops
- Particle/animation effects
- Localization of atmospheric text
- Customizable announcement themes
