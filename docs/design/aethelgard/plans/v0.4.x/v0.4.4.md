# v0.4.4: The Mystic (Archetype Specialization)

> **Status:** Planned
> **Milestone:** v0.4.x - The Saga & The Weaver
> **Theme:** Where others see ruin, the Mystic sees resonance—channeling the Old Ones' legacy through Galdr and glyph.

---

## Table of Contents

1. [Overview](#overview)
2. [Sub-Version Breakdown](#sub-version-breakdown)
3. [Architecture Overview](#architecture-overview)
4. [Cross-Cutting Concerns](#cross-cutting-concerns)
5. [Domain 4 Compliance](#domain-4-compliance)
6. [Dependency Map](#dependency-map)
7. [Testing Strategy Summary](#testing-strategy-summary)
8. [Changelog Template](#changelog-template)

---

## Overview

v0.4.4 introduces **The Mystic**—the full archetype specialization system that transforms the generic magic foundation (v0.4.3) into a distinct playstyle. While v0.4.3 provided the engine (Flux, Spells, MagicService, Backlash), v0.4.4 delivers the experience: Mystic-exclusive abilities, the Galdr chanting system, spell school mastery, and the unique resource mechanic of Aetheric Resonance.

### Relationship to v0.4.3

| v0.4.3 (The Weaver) | v0.4.4 (The Mystic) |
|---------------------|---------------------|
| Flux system (environmental) | Aetheric Resonance (personal attunement) |
| Generic spell casting | Mystic-exclusive Galdr (chanted spells) |
| Spell entity & repository | Spell School Mastery progression |
| Backlash mechanics | Paradox and Aetheric Overload |
| Basic `cast` command | Extended casting modes: Quick, Channeled, Ritual |
| 12 starter spells | Mystic specialization tree (15+ abilities) |

### Design Philosophy

The Mystic archetype follows three core principles:

1. **Risk vs Reward**: Mystics gain power through Aetheric Resonance, but high resonance amplifies both spell potency AND backlash severity.
2. **Versatility**: Unlike Warriors (sustained damage) or Scouts (tactical positioning), Mystics excel at situation-specific solutions—the right spell at the right time.
3. **Progression Depth**: School Mastery provides long-term growth that shapes playstyle (Destruction specialists vs Restoration healers vs Alteration controllers).

### Core Mechanics

| Mechanic | Description |
|----------|-------------|
| **Aetheric Resonance** | Personal attunement to ambient Flux (0-100). Higher = stronger spells, but also stronger backlash. |
| **Galdr (Chants)** | Multi-turn spells that build power through concentration. Can be interrupted. |
| **School Mastery** | XP-like progression per school. Unlock tiers for reduced costs, new spells, passive bonuses. |
| **Paradox** | Mystic-specific consequence when Resonance + Flux exceed safe thresholds. |
| **Aetheric Overflow** | When Resonance hits 100, the Mystic gains temporary power but risks soul damage. |
| **Casting Modes** | Quick Cast (instant, +Flux), Standard Cast, Channeled Cast (-Flux, +time), Ritual Cast (out-of-combat) |

---

## Sub-Version Breakdown

To manage complexity and ensure proper testing, v0.4.4 is divided into **5 sub-versions**:

| Sub-Version | Codename | Focus | Estimated Tests |
|-------------|----------|-------|-----------------|
| **v0.4.4a** | The Attunement | Aetheric Resonance system, Mystic resource pool | ~32 |
| **v0.4.4b** | The Galdr | Chanting system, concentration checks, interruption | ~38 |
| **v0.4.4c** | The Mastery | School Mastery progression, tier unlocks, passives | ~35 |
| **v0.4.4d** | The Paradox | Mystic-specific backlash, Aetheric Overflow, soul damage | ~30 |
| **v0.4.4e** | The Grimoire | Mystic spell tree, TUI integration, `grimoire` command | ~25 |

**Total Estimated Tests: ~160**

---

## v0.4.4a: The Attunement (Aetheric Resonance)

> **Goal:** Implement the Mystic's personal attunement system that interacts with environmental Flux.

### Scope

- **ResonanceState** model: Personal Flux attunement (0-100) on Mystic characters
- **IResonanceService** interface: Contract for resonance manipulation
- **ResonanceService** implementation: Attunement tracking, decay, amplification
- **ResonanceChangedEvent**: Event for UI/audio hooks
- **Casting Mode integration**: Quick/Standard/Channeled modifiers

### Key Concepts

**Aetheric Resonance** differs from environmental Flux:

| Aspect | Flux (v0.4.3) | Resonance (v0.4.4a) |
|--------|---------------|---------------------|
| Scope | Environmental (shared) | Personal (per character) |
| Source | Spell casting adds | Spell casting adds, attuning to Flux |
| Decay | Per round (combat) | Per rest (slower) |
| Effect | Backlash risk | Spell potency modifier |
| Cap | 100 (Overload) | 100 (Overflow) |

**Resonance Thresholds:**
- **0-24 (Dim)**: -10% spell potency, safe casting
- **25-49 (Steady)**: Normal spell potency, minor attunement bonus
- **50-74 (Bright)**: +15% spell potency, elevated risk
- **75-99 (Blazing)**: +30% spell potency, high risk, visual effects
- **100 (Overflow)**: +50% potency for 1 turn, then forced discharge

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `ResonanceState` | Core/Models/Magic | Personal attunement tracking |
| `ResonanceThreshold` | Core/Enums | Dim, Steady, Bright, Blazing, Overflow |
| `IResonanceService` | Core/Interfaces | Service contract |
| `ResonanceService` | Engine/Services | Attunement logic |
| `ResonanceChangedEvent` | Core/Events | Event on threshold crossing |
| `CastingMode` | Core/Enums | Quick, Standard, Channeled, Ritual |

### Decision Trees

1. **ModifyResonance**: Get current → Add/subtract → Clamp → Check threshold → Publish event
2. **GetPotencyModifier**: Threshold → Return multiplier (0.9 to 1.5)
3. **ApplyCastingModeModifiers**: Mode → Modify resonance gain/loss, cast time
4. **ProcessResonanceDecay**: Check rest state → Calculate decay amount → Apply

### Deliverables

- [ ] `ResonanceState.cs` - Model with CurrentValue, MaxValue, DecayRate
- [ ] `ResonanceThreshold.cs` - Enum: Dim, Steady, Bright, Blazing, Overflow
- [ ] `CastingMode.cs` - Enum: Quick, Standard, Channeled, Ritual
- [ ] `IResonanceService.cs` - Interface with core methods
- [ ] `ResonanceService.cs` - Implementation with comprehensive logging
- [ ] `ResonanceChangedEvent.cs` - Event record
- [ ] `ResonanceServiceTests.cs` - 32 unit tests
- [ ] DI registration in `Program.cs`
- [ ] MagicService integration for potency calculation

### Test Categories (32 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| ModifyResonance | 8 | Add/subtract, clamping, overflow prevention |
| Threshold Detection | 6 | All threshold transitions |
| Potency Calculation | 6 | Multiplier accuracy per threshold |
| Casting Mode Effects | 8 | Quick/Standard/Channeled/Ritual modifiers |
| Integration | 4 | MagicService → ResonanceService flow |

---

## v0.4.4b: The Galdr (Chanting System)

> **Goal:** Implement multi-turn spellcasting (Galdr) that requires concentration and can be interrupted.

### Scope

- **GaldrState** model: Tracks active chant, turns remaining, accumulated power
- **IGaldrService** interface: Contract for chant management
- **GaldrService** implementation: Start, advance, complete, interrupt chants
- **Concentration Check**: WILL-based save when damaged while chanting
- **Interruption mechanics**: Movement, taking actions, damage, silence effects
- **Power accumulation**: Longer chants = stronger effects

### Key Concepts

**Galdr** are extended spells that build power over multiple turns:

| Aspect | Instant Spells | Galdr (Chanted) |
|--------|----------------|-----------------|
| Cast Time | 1 turn | 2-5 turns |
| Power | Fixed | Accumulates per turn |
| Interruption | N/A | Concentration checks |
| Resource | AP spent immediately | AP spent on completion |
| Risk | Standard backlash | Backlash on interrupt (lost energy) |

**Concentration Mechanics:**
- **Damage Check**: DC = 10 or Damage/2 (whichever higher), WILL save
- **Movement**: Automatically breaks chant (no save)
- **Other Actions**: Breaks chant (except `wait` or `continue`)
- **Silence Effect**: Prevents starting new chants, breaks existing

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `GaldrState` | Core/Models/Magic | Active chant tracking |
| `GaldrPhase` | Core/Enums | Weaving, Sustaining, Releasing |
| `IGaldrService` | Core/Interfaces | Chant management contract |
| `GaldrService` | Engine/Services | Chant lifecycle logic |
| `ConcentrationResult` | Core/Models/Magic | Save result model |
| `GaldrInterruptedEvent` | Core/Events | Event on interruption |
| `GaldrCompletedEvent` | Core/Events | Event on successful release |

### Decision Trees

1. **StartGaldr**: Validate spell is Galdr → Check not already chanting → Initialize state → Publish event
2. **AdvanceGaldr**: Check active → Decrement turns → Accumulate power → Check completion → Process
3. **CheckConcentration**: Calculate DC → Roll WILL → Apply modifiers → Return result
4. **InterruptGaldr**: Capture state → Calculate backlash → Clear state → Apply consequences → Publish event
5. **ReleaseGaldr**: Verify complete → Calculate final power → Execute effect → Clear state → Publish event

### Deliverables

- [ ] `GaldrState.cs` - Model with Spell, TurnsRemaining, AccumulatedPower, Target
- [ ] `GaldrPhase.cs` - Enum: None, Weaving, Sustaining, Releasing
- [ ] `ConcentrationResult.cs` - Model with Success, DC, Roll, Modifiers
- [ ] `IGaldrService.cs` - Interface with Start, Advance, Interrupt, Release, CheckConcentration
- [ ] `GaldrService.cs` - Full implementation
- [ ] `GaldrInterruptedEvent.cs` - Event with Reason, LostPower, BacklashDamage
- [ ] `GaldrCompletedEvent.cs` - Event with Spell, FinalPower, Target
- [ ] CommandParser extension - `chant`, `continue`, `release` commands
- [ ] CombatService integration - Turn processing for active chants
- [ ] `GaldrServiceTests.cs` - 38 unit tests

### Test Categories (38 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Start Galdr | 6 | Valid start, already chanting, non-Galdr spell |
| Advance Galdr | 8 | Turn countdown, power accumulation, completion |
| Concentration Checks | 10 | Various damage amounts, modifiers, success/fail |
| Interruption | 8 | Movement, damage, silence, voluntary |
| Release | 4 | Power calculation, effect execution |
| Integration | 2 | Full chant cycle |

---

## v0.4.4c: The Mastery (School Progression)

> **Goal:** Implement School Mastery system for long-term Mystic progression.

### Scope

- **SchoolMastery** model: XP-like progression per spell school
- **MasteryTier** enum: Novice, Apprentice, Adept, Master, Archon
- **IMasteryService** interface: Contract for mastery tracking and benefits
- **MasteryService** implementation: XP gain, tier unlocks, passive bonuses
- **Tier benefits**: Cost reduction, new spell unlocks, passive effects
- **Mastery display**: TUI for viewing progression

### Key Concepts

**School Mastery** provides permanent progression:

| Tier | XP Required | AP Cost Mod | Flux Cost Mod | Special |
|------|-------------|-------------|---------------|---------|
| Novice | 0 | +0% | +0% | Basic spells only |
| Apprentice | 100 | -5% | -5% | Tier 2 spells unlock |
| Adept | 300 | -10% | -10% | School passive unlocks |
| Master | 600 | -15% | -15% | Tier 3 spells unlock |
| Archon | 1000 | -20% | -20% | Ultimate ability unlocks |

**XP Gain:**
- Casting a spell: +10 XP to that school
- Killing with a spell: +25 XP bonus
- Completing Galdr: +15 XP bonus
- Learning new spell: +50 XP to school

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `SchoolMastery` | Core/Models/Magic | Per-school progression |
| `MasteryTier` | Core/Enums | Novice → Archon |
| `SchoolPassive` | Core/Models/Magic | Passive bonus from Adept+ |
| `IMasteryService` | Core/Interfaces | Mastery management contract |
| `MasteryService` | Engine/Services | XP, tier, bonus logic |
| `MasteryTierReachedEvent` | Core/Events | Event on tier up |
| `SchoolMasteryDisplay` | Terminal/Rendering | Mastery TUI component |

### School Passives (Adept Tier)

| School | Passive Name | Effect |
|--------|--------------|--------|
| Destruction | Entropic Resonance | +1 damage die on critical hits |
| Restoration | Life Attunement | +10% healing received |
| Alteration | Reality Anchor | +1 turn duration on buffs |
| Divination | Third Eye | Reveal enemy intent after Analyze |

### Decision Trees

1. **AddMasteryXP**: Get current → Add XP → Check tier threshold → Tier up if needed → Publish event
2. **GetTierBonuses**: Get tier → Calculate cost modifiers → Return bonus set
3. **CheckSpellUnlock**: Get mastery tier → Compare to spell tier requirement → Return availability
4. **ApplySchoolPassive**: Check tier >= Adept → Get passive → Apply to relevant calculations

### Deliverables

- [ ] `SchoolMastery.cs` - Model with School, CurrentXP, Tier
- [ ] `MasteryTier.cs` - Enum: Novice, Apprentice, Adept, Master, Archon
- [ ] `SchoolPassive.cs` - Model with Name, Effect, School
- [ ] `IMasteryService.cs` - Interface with AddXP, GetTier, GetBonuses, GetPassive
- [ ] `MasteryService.cs` - Full implementation
- [ ] `MasteryTierReachedEvent.cs` - Event with School, NewTier, UnlockedSpells
- [ ] Character entity extension - `Dictionary<SpellSchool, SchoolMastery>`
- [ ] MagicService integration - Apply cost modifiers, passive effects
- [ ] `SchoolMasteryDisplay.cs` - TUI renderer
- [ ] `mastery` command in CommandParser
- [ ] `MasteryServiceTests.cs` - 35 unit tests

### Test Categories (35 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| XP Gain | 8 | Various sources, capping |
| Tier Calculation | 6 | All tier boundaries |
| Cost Modifiers | 8 | AP and Flux reduction per tier |
| Spell Unlocks | 6 | Tier requirements, availability |
| Passives | 5 | Application, stacking, removal |
| Integration | 2 | Full progression cycle |

---

## v0.4.4d: The Paradox (Mystic-Specific Backlash)

> **Goal:** Implement enhanced backlash mechanics specific to Mystics: Paradox and Aetheric Overflow.

### Scope

- **Paradox** mechanic: When Resonance + Flux exceed combined threshold
- **IParadoxService** interface: Contract for Paradox checks and effects
- **ParadoxService** implementation: Risk calculation, effect determination
- **Aetheric Overflow**: Special state when Resonance hits 100
- **Soul Damage**: Permanent consequence from repeated Paradox
- **Paradox mitigation**: School Mastery reduces Paradox severity

### Key Concepts

**Paradox** is a Mystic-specific enhanced backlash:

| Mechanic | Backlash (v0.4.3d) | Paradox (v0.4.4d) |
|----------|--------------------|--------------------|
| Trigger | Flux > 50 | Flux + Resonance > 100 |
| Severity Factors | Flux level only | Flux + Resonance + School mismatch |
| Consequences | Damage, Aether Sickness, Corruption | Same + Soul Fracture, Reality Tear |
| Mitigation | None | School Mastery reduces severity |
| Special | None | Overflow state grants power before damage |

**Paradox Severity Table:**

| Combined (Flux + Resonance) | Risk | Severity Range |
|-----------------------------|------|----------------|
| 100-119 | 20% | Minor only |
| 120-139 | 35% | Minor to Major |
| 140-159 | 50% | Major to Severe |
| 160-179 | 70% | Severe to Catastrophic |
| 180+ | 90% | Catastrophic guaranteed on fail |

**Aetheric Overflow (Resonance = 100):**
1. Mystic enters Overflow state (1 turn)
2. +50% spell potency, -50% AP costs
3. At turn end: Forced discharge → Take damage, gain Soul Fracture
4. Soul Fracture: Permanent -1 to Max Resonance capacity (stacks)

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `ParadoxResult` | Core/Models/Magic | Paradox check outcome |
| `ParadoxSeverity` | Core/Enums | Minor, Major, Severe, Catastrophic |
| `SoulFracture` | Core/Models/Magic | Permanent penalty tracking |
| `IParadoxService` | Core/Interfaces | Paradox management contract |
| `ParadoxService` | Engine/Services | Risk calculation, effects |
| `OverflowState` | Core/Models/Magic | Temporary overflow tracking |
| `ParadoxTriggeredEvent` | Core/Events | Event on Paradox |
| `OverflowDischargeEvent` | Core/Events | Event on forced discharge |

### Decision Trees

1. **CheckParadox**: Get Flux + Resonance → Calculate risk → Roll → Determine severity → Apply effects
2. **CalculateParadoxSeverity**: Combined value → Base severity → Apply mastery reduction → Return final
3. **EnterOverflow**: Set state → Grant bonuses → Schedule discharge → Publish event
4. **ProcessOverflowDischarge**: Calculate damage → Apply Soul Fracture → Clear state → Publish event
5. **ApplySoulFracture**: Increment fracture count → Reduce max resonance → Check soul death

### Deliverables

- [ ] `ParadoxResult.cs` - Model with Triggered, Severity, Effects
- [ ] `ParadoxSeverity.cs` - Enum: None, Minor, Major, Severe, Catastrophic
- [ ] `SoulFracture.cs` - Model tracking permanent penalties
- [ ] `OverflowState.cs` - Model for temporary overflow
- [ ] `IParadoxService.cs` - Interface with CheckParadox, EnterOverflow, ProcessDischarge
- [ ] `ParadoxService.cs` - Full implementation
- [ ] `ParadoxTriggeredEvent.cs` - Event with Severity, Effects, SoulDamage
- [ ] `OverflowDischargeEvent.cs` - Event with Damage, FractureGained
- [ ] Character entity extension - `List<SoulFracture>`
- [ ] MagicService integration - Paradox check before casting
- [ ] `ParadoxServiceTests.cs` - 30 unit tests

### Test Categories (30 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Risk Calculation | 8 | Various combined values |
| Severity Determination | 6 | All severity levels, mastery reduction |
| Effect Application | 6 | Damage, statuses, soul fracture |
| Overflow | 6 | Entry, bonuses, discharge |
| Soul Fracture | 4 | Accumulation, max resonance reduction |

---

## v0.4.4e: The Grimoire (Mystic Spell Tree & TUI)

> **Goal:** Implement the Mystic specialization tree, expanded spell list, and the `grimoire` command for spell management.

### Scope

- **Mystic Specialization Tree**: 15+ abilities unique to Mystics
- **Expanded Spell List**: Tier 2-3 spells for each school
- **Grimoire TUI**: Full spell management interface
- **Spell Learning**: System for acquiring new spells
- **Quick Slot System**: Hotkey spells for combat

### Key Concepts

**Mystic Specialization Tree** (separate from School Mastery):

| Branch | Focus | Key Abilities |
|--------|-------|---------------|
| **Channeler** | Raw power | Empower Spell, Overcharge, Aether Surge |
| **Ritualist** | Utility/Control | Extended Duration, Mass Targeting, Ritual Casting |
| **Warder** | Defense/Support | Spell Shield, Counterspell, Aetheric Ward |

**Expanded Spell List (Tier 2-3):**

| Spell | School | Tier | AP | Flux | Type | Effect |
|-------|--------|------|-----|------|------|--------|
| Inferno | Destruction | 2 | 6 | 18 | Instant | 3d6 Fire, AoE (3 targets) |
| Glacial Spike | Destruction | 2 | 5 | 14 | Instant | 2d8 Cold + Slow (2 turns) |
| Chain Lightning | Destruction | 3 | 8 | 22 | Galdr(2) | 4d6 Lightning, chains to 3 targets |
| Mass Mending | Restoration | 2 | 7 | 16 | Galdr(1) | Heal 2d6 to all allies |
| Resurrect | Restoration | 3 | 12 | 30 | Galdr(3) | Revive fallen ally at 1 HP |
| Haste | Alteration | 2 | 5 | 14 | Instant | Grant extra action (1 turn) |
| Polymorph | Alteration | 3 | 10 | 25 | Galdr(2) | Transform enemy (WILL save) |
| True Sight | Divination | 2 | 4 | 10 | Instant | Reveal hidden, see through illusions |
| Prophecy | Divination | 3 | 8 | 20 | Galdr(3) | Predict enemy actions (3 turns) |

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `MysticSpecialization` | Core/Entities | Specialization tree node |
| `SpecializationBranch` | Core/Enums | Channeler, Ritualist, Warder |
| `SpellQuickSlot` | Core/Models/Magic | Hotkey binding |
| `IGrimoireService` | Core/Interfaces | Spell management contract |
| `GrimoireService` | Engine/Services | Learning, organizing, quick slots |
| `GrimoireRenderer` | Terminal/Rendering | Full grimoire TUI |
| `SpellLearnedEvent` | Core/Events | Event on learning spell |

### Decision Trees

1. **LearnSpell**: Check requirements (tier, school, XP) → Add to known → Gain mastery XP → Publish event
2. **AssignQuickSlot**: Validate spell known → Assign to slot (1-5) → Update bindings
3. **RenderGrimoire**: Get known spells → Group by school → Show mastery → Display quick slots
4. **CastFromQuickSlot**: Get binding → Validate cooldown → Execute cast command

### Deliverables

- [ ] `MysticSpecialization.cs` - Specialization node entity
- [ ] `SpecializationBranch.cs` - Enum: Channeler, Ritualist, Warder
- [ ] `SpellQuickSlot.cs` - Model with SlotNumber, SpellId
- [ ] `IGrimoireService.cs` - Interface with LearnSpell, AssignSlot, GetKnownSpells
- [ ] `GrimoireService.cs` - Full implementation
- [ ] `GrimoireRenderer.cs` - Full TUI renderer
- [ ] `SpellLearnedEvent.cs` - Event record
- [ ] Expanded spell seeder - Tier 2-3 spells
- [ ] `grimoire` command in CommandParser
- [ ] Quick slot commands (`1-5` during combat)
- [ ] `GrimoireServiceTests.cs` - 25 unit tests

### Test Categories (25 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Spell Learning | 8 | Requirements, already known, mastery gain |
| Quick Slots | 6 | Assignment, overwrite, removal |
| Specialization | 6 | Point allocation, ability unlocks |
| TUI Rendering | 3 | Layout, grouping, display |
| Integration | 2 | Full grimoire workflow |

---

## Architecture Overview

### Service Dependency Graph

```
                        ┌─────────────────────┐
                        │    GameService      │
                        └──────────┬──────────┘
                                   │
                ┌──────────────────┼──────────────────┐
                │                  │                  │
                ▼                  ▼                  ▼
      ┌─────────────────┐  ┌─────────────┐  ┌───────────────┐
      │  CombatService  │  │  GameLoop   │  │ CommandParser │
      └────────┬────────┘  └─────────────┘  └───────┬───────┘
               │                                    │
    ┌──────────┴────────────────┬───────────────────┘
    │                           │
    ▼                           ▼
┌─────────────┐          ┌─────────────────┐
│MagicService │◄─────────│   "cast" cmd    │
│  (v0.4.3c)  │          │   "chant" cmd   │
└──────┬──────┘          │   "grimoire"    │
       │                 └─────────────────┘
       │
┌──────┴──────┬──────────────┬──────────────┬──────────────┐
│             │              │              │              │
▼             ▼              ▼              ▼              ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ Resonance │ │   Galdr   │ │  Mastery  │ │  Paradox  │ │ Grimoire  │
│  Service  │ │  Service  │ │  Service  │ │  Service  │ │  Service  │
│ (v0.4.4a) │ │ (v0.4.4b) │ │ (v0.4.4c) │ │ (v0.4.4d) │ │ (v0.4.4e) │
└───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘
       │             │              │              │
       │             │              │              │
       └─────────────┴──────────────┴──────────────┘
                            │
                            ▼
              ┌──────────────────────────┐
              │    AetherService         │
              │    (v0.4.3a - Flux)      │
              └──────────────────────────┘
```

### Data Flow: Mystic Casting a Galdr

```
1. Player: "chant inferno on goblin"
                │
                ▼
2. CommandParser.HandleChantCommand()
                │
                ▼
3. GrimoireService.ValidateSpellKnown()
                │
                ▼
4. ResonanceService.GetPotencyModifier()
                │
                ▼
5. ParadoxService.CheckParadox()
   ├── If Paradox → Apply effects, abort cast
   │
6. MagicService.CanCast() (v0.4.3c)
                │
                ▼
7. GaldrService.StartGaldr()
   ├── Initialize GaldrState
   ├── Set TurnsRemaining
   └── Publish GaldrStartedEvent
                │
                ▼
8. [Combat continues, player chooses "continue"]
                │
                ▼
9. GaldrService.AdvanceGaldr()
   ├── Decrement TurnsRemaining
   ├── Accumulate power
   └── Check for completion
                │
                ▼
10. [If damage taken]
    GaldrService.CheckConcentration()
    ├── Roll WILL save vs DC
    └── If fail → InterruptGaldr()
                │
                ▼
11. [On completion]
    GaldrService.ReleaseGaldr()
    ├── Calculate final power (base × potency × accumulated)
    ├── MagicService.ExecuteSpellEffect()
    ├── MasteryService.AddMasteryXP()
    ├── ResonanceService.ModifyResonance()
    └── Publish GaldrCompletedEvent
```

---

## Cross-Cutting Concerns

### 1. Mystic Archetype Check

All v0.4.4 services must verify the character is a Mystic:

```csharp
if (character.Archetype != ArchetypeType.Mystic)
{
    _logger.LogWarning("Non-Mystic attempted Mystic action");
    return OperationResult.Failure("Only Mystics can perform this action.");
}
```

### 2. Resonance + Flux Interaction

Services must consider both resources:

```csharp
var combinedRisk = _aetherService.GetCurrentFlux() + _resonanceService.GetCurrentResonance();
if (combinedRisk > ParadoxThreshold)
{
    var paradoxResult = _paradoxService.CheckParadox(caster);
    // Handle paradox...
}
```

### 3. School Mastery Integration

All spell operations should apply mastery bonuses:

```csharp
var mastery = _masteryService.GetMastery(caster, spell.School);
var apCost = (int)(spell.ApCost * mastery.CostModifier);
var fluxCost = (int)(spell.FluxCost * mastery.FluxModifier);
```

---

## Domain 4 Compliance

### Voice Guidelines for Mystic Content

All Mystic-related text must use Domain 4 compliant language:

| Forbidden | Allowed |
|-----------|---------|
| "Mana points" | "Aetheric reserves" |
| "Spell slots" | "Patterns woven into memory" |
| "Cooldown timer" | "The pattern fades from readiness" |
| "DPS output" | "The destructive resonance" |
| "Magic system" | "The Old Ones' gift" |

### Example Descriptions

**Resonance Threshold Messages:**
- **Dim**: "Your connection to the weave flickers, barely a whisper."
- **Steady**: "The aether flows through you in measured currents."
- **Bright**: "Power crackles at your fingertips, eager for release."
- **Blazing**: "Reality bends around you, straining at your presence."
- **Overflow**: "THE WEAVE SCREAMS THROUGH YOUR SOUL!"

**Galdr Messages:**
- Start: "{Name} begins weaving the Galdr of {Spell}, ancient words taking shape..."
- Continue: "The pattern grows more intricate, power accumulating..."
- Interrupt: "The weaving unravels! Raw aether tears back through {Name}!"
- Complete: "The Galdr is complete! {Spell} bursts forth in terrible glory!"

---

## Dependency Map

```
v0.4.3a (AetherService/Flux)
    │
    └──► v0.4.4a (ResonanceService)
              │
              ├──► v0.4.4b (GaldrService)
              │         │
              │         └──► v0.4.4d (ParadoxService)
              │
              └──► v0.4.4c (MasteryService)
                        │
                        └──► v0.4.4e (GrimoireService)

v0.4.3b (SpellRepository)
    │
    └──► v0.4.4e (Expanded Spells)

v0.4.3c (MagicService)
    │
    └──► All v0.4.4 services (integration)

v0.4.3d (BacklashService)
    │
    └──► v0.4.4d (ParadoxService extends)
```

### Implementation Order

1. **v0.4.4a** - Foundation (depends only on v0.4.3)
2. **v0.4.4b** - Can start after v0.4.4a basics
3. **v0.4.4c** - Can start after v0.4.4a basics
4. **v0.4.4d** - Requires v0.4.4a complete
5. **v0.4.4e** - Requires v0.4.4c complete, benefits from all others

---

## Testing Strategy Summary

### Unit Test Distribution

| Sub-Version | Test Class | Count |
|-------------|------------|-------|
| v0.4.4a | ResonanceServiceTests.cs | 32 |
| v0.4.4b | GaldrServiceTests.cs | 38 |
| v0.4.4c | MasteryServiceTests.cs | 35 |
| v0.4.4d | ParadoxServiceTests.cs | 30 |
| v0.4.4e | GrimoireServiceTests.cs | 25 |
| **Total** | | **160** |

### Integration Tests

- `MysticCombatIntegrationTests.cs` - Full combat cycle with Galdr
- `MasteryProgressionTests.cs` - XP gain to tier unlock flow
- `ParadoxScenarioTests.cs` - High-risk casting scenarios

### Manual Testing Scenarios

1. **Galdr Duel**: Cast Galdr, get interrupted, retry, complete
2. **Mastery Grind**: Cast 100 spells, verify tier progression
3. **Paradox Death**: Intentionally trigger Overflow discharge
4. **Grimoire Management**: Learn, organize, use quick slots

---

## Changelog Template

```markdown
## v0.4.4 - The Mystic (Archetype Specialization)

**Release Date:** TBD

### Summary
The Mystic awakens. This update transforms the magic foundation into a fully-realized
archetype experience with Aetheric Resonance, multi-turn Galdr casting, School Mastery
progression, and the dangerous allure of Paradox.

### Features

#### Aetheric Resonance (v0.4.4a)
- Personal attunement to ambient Flux affects spell potency
- Five threshold tiers: Dim (-10%) to Overflow (+50%)
- Casting modes: Quick, Standard, Channeled, Ritual

#### Galdr System (v0.4.4b)
- Multi-turn chanted spells that build power over time
- Concentration checks on damage (WILL-based)
- Interruption mechanics: movement, actions, silence

#### School Mastery (v0.4.4c)
- XP progression per spell school
- Five tiers: Novice → Archon
- Cost reductions, spell unlocks, passive abilities

#### Paradox (v0.4.4d)
- Mystic-enhanced backlash when Flux + Resonance exceed threshold
- Aetheric Overflow: temporary power surge with soul damage
- Soul Fracture: permanent resonance capacity reduction

#### Grimoire (v0.4.4e)
- `grimoire` command for spell management
- 9 new Tier 2-3 spells across all schools
- Quick slot system for combat casting (keys 1-5)
- Mystic specialization branches: Channeler, Ritualist, Warder

### Technical
- 5 new service interfaces and implementations
- ~15 new model classes and enums
- ~160 unit tests across 5 test classes
- Full TUI integration for all new systems

### Domain 4 Compliance
- All spell descriptions use archaeologist-perspective language
- Resonance/Paradox messages maintain mystical tone
- No precision measurements in any player-facing text
```

---

## Next Steps

After v0.4.4 implementation:

1. **v0.4.5**: Consider Warrior archetype specialization (Rage, Stances, Combat Mastery)
2. **v0.4.6**: Consider Scout archetype specialization (Stealth, Traps, Tracking)
3. **v0.5.0**: Potential milestone for complete archetype system
