# Changelog: v0.3.1 - Core Crafting System & Database Infrastructure

**Versions:** v0.3.1a through v0.3.1e
**Release Dates:** December 20, 2025

## Table of Contents

- [Overview](#overview)
- [Part A: The Blueprint (Core Crafting Engine)](#part-a-the-blueprint-core-crafting-engine)
  - [Summary](#summary)
  - [New Features](#new-features)
  - [Files Created](#files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Seed Recipe Data (12 Recipes)](#seed-recipe-data-12-recipes)
  - [Commands Reference (Updated)](#commands-reference-updated)
  - [Logging Matrix (v0.3.1a)](#logging-matrix-v031a)
  - [Complete Test Inventory](#complete-test-inventory)
  - [DI Registration](#di-registration)
  - [Build Verification](#build-verification)
  - [Directory Structure After v0.3.1a](#directory-structure-after-v031a)
  - [Dependencies](#dependencies)
  - [Test Summary by Category](#test-summary-by-category)
  - [Running Tests](#running-tests)
  - [Migration Notes](#migration-notes)
  - [Next Steps (v0.3.1b: Crafting UI)](#next-steps-v031b-crafting-ui)
- [Part B: The Tinkerer (Bodging & Medicine)](#part-b-the-tinkerer-bodging--medicine)
  - [Summary](#summary-1)
  - [New Features](#new-features-1)
  - [Files Created](#files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Commands Reference (Updated)](#commands-reference-updated-1)
  - [Logging Matrix (v0.3.1b)](#logging-matrix-v031b)
  - [Complete Test Inventory](#complete-test-inventory-1)
  - [DI Registration](#di-registration-1)
  - [Build Verification](#build-verification-1)
  - [Directory Structure After v0.3.1b](#directory-structure-after-v031b)
  - [Dependencies](#dependencies-1)
  - [Test Summary by Category](#test-summary-by-category-1)
  - [Running Tests](#running-tests-1)
  - [Migration Notes](#migration-notes-1)
  - [Next Steps (v0.3.1c: Crafting UI)](#next-steps-v031c-crafting-ui)
- [Part C: The Alchemist (Alchemy & Runeforging)](#part-c-the-alchemist-alchemy--runeforging)
  - [Summary](#summary-2)
  - [New Features](#new-features-2)
  - [Files Created](#files-created-2)
  - [Files Modified](#files-modified-2)
  - [Code Implementation Details](#code-implementation-details-2)
  - [Commands Reference (Updated)](#commands-reference-updated-2)
  - [Logging Matrix (v0.3.1c)](#logging-matrix-v031c)
  - [Complete Test Inventory](#complete-test-inventory-2)
  - [DI Registration](#di-registration-2)
  - [Build Verification](#build-verification-2)
  - [Directory Structure After v0.3.1c](#directory-structure-after-v031c)
  - [Dependencies](#dependencies-2)
  - [Test Summary by Category](#test-summary-by-category-2)
  - [Running Tests](#running-tests-2)
  - [Migration Notes](#migration-notes-2)
  - [Next Steps (v0.3.1d: Runeforging Enchantment)](#next-steps-v031d-runeforging-enchantment)
  - [Catastrophe Damage Reference](#catastrophe-damage-reference)
- [Part D: Database Infrastructure](#part-d-database-infrastructure)
  - [Summary](#summary-3)
  - [New Features](#new-features-3)
  - [Files Created](#files-created-3)
  - [Files Modified](#files-modified-3)
  - [Code Implementation Details](#code-implementation-details-3)
  - [Quick Start Commands](#quick-start-commands)
  - [Environment Variables](#environment-variables)
  - [Database Schema Overview](#database-schema-overview)
  - [Build Verification](#build-verification-3)
  - [Directory Structure After v0.3.1d](#directory-structure-after-v031d)
  - [Migration Notes](#migration-notes-3)
  - [Test Architecture](#test-architecture)
  - [Prerequisites](#prerequisites)
  - [Troubleshooting](#troubleshooting)
  - [Next Steps (v0.3.2)](#next-steps-v032)
  - [Dependencies](#dependencies-3)
  - [Running Tests](#running-tests-3)
- [Part E: PostgreSQL Integration Tests](#part-e-postgresql-integration-tests)
  - [Summary](#summary-4)
  - [New Test Categories](#new-test-categories)
  - [Files Created](#files-created-4)
  - [Key Implementation Details](#key-implementation-details)
  - [Test Execution](#test-execution)
  - [Test Architecture Summary](#test-architecture-summary)
  - [Build Verification](#build-verification-4)
  - [Directory Structure After v0.3.1e](#directory-structure-after-v031e)
  - [Why PostgreSQL-Specific Tests?](#why-postgresql-specific-tests)
  - [Dependencies](#dependencies-4)
  - [Next Steps (v0.3.2)](#next-steps-v032-1)

---

## Overview

Version 0.3.1 represents a major expansion of the Rune & Rust game engine, introducing a complete **crafting system** with four specialized trades, trade-specific catastrophe mechanics, equipment durability and repair systems, and full **PostgreSQL database infrastructure** with Docker containerization.

This release spans five sub-versions:
- **v0.3.1a**: Core crafting engine with WITS-based skill checks and 12 starter recipes
- **v0.3.1b**: Equipment durability, repair mechanics, and salvage operations
- **v0.3.1c**: Trade-specific catastrophes (Alchemy explosions, Runeforging corruption)
- **v0.3.1d**: Docker-based PostgreSQL infrastructure and EF Core migrations
- **v0.3.1e**: PostgreSQL-specific integration tests (JSONB, constraints, transactions)

**Combined Test Count:** 1733 tests (all passing)
- 1567 unit tests
- 137 integration tests (InMemory)
- 29 integration tests (PostgreSQL)

---

## Part A: The Blueprint (Core Crafting Engine)

**Release Date:** December 20, 2025
**Total Tests:** 1672 (17 new tests added)

---

### Summary

Version 0.3.1a introduces the **Core Crafting Engine** - the foundational system for player-driven item creation using WITS-based skill checks. This release establishes the Recipe registry pattern, CraftingService with 4-tier outcome determination, and 12 starter recipes across 4 crafting trades.

Key architectural additions:
- **CraftingTrade Enum**: Four specialization categories (Bodging, Alchemy, Runeforging, Field Medicine)
- **CraftingOutcome Enum**: Four-tier result classification (Failure, Success, Masterwork, Catastrophe)
- **Recipe Entity**: Definition model with ingredients, DC, and output configuration
- **RecipeRegistry**: Static registry pattern with 12 seed recipes (3 per trade)
- **CraftingService**: WITS-based crafting with quality tier scaling
- **Extended Command Parser**: New verbs (craft, make)

---

### New Features

#### WITS-Based Crafting System
- **Dice Pool**: Character's WITS attribute determines number of d10s rolled
- **Success Threshold**: Rolls of 8+ count as successes; rolls of 1 count as botches
- **Net Successes**: Total successes minus botches compared to recipe DC
- **Ingredient Consumption**: Materials consumed before roll (regardless of outcome)

#### Four-Tier Outcome System
- **Catastrophe (Net < 0)**: More botches than successes - materials destroyed
- **Failure (0 <= Net < DC)**: Roll insufficient - no output produced
- **Success (Net >= DC)**: Standard success - ClanForged quality output
- **Masterwork (Net >= DC + 5)**: Exceptional roll - MythForged quality output

#### Four Crafting Trades
| Trade | Focus | Example Items |
|-------|-------|---------------|
| Bodging | Mechanical repairs, improvised tools | Torch, Lockpick, Rope |
| Alchemy | Potions, salves, chemical compounds | Stimulant, Antitoxin, Firebomb |
| Runeforging | Aetheric inscriptions, enchantments | Glow Stone, Ward Token, Battery |
| Field Medicine | Bandages, stimulants, medical kits | Bandage, Splint, Medkit |

#### Recipe Registry (12 Starter Recipes)
Static registry pattern for non-persisted recipe data, initialized via static constructor.

---

### Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CraftingTrade.cs` | Four crafting specializations: Bodging, Alchemy, Runeforging, FieldMedicine |
| `RuneAndRust.Core/Enums/CraftingOutcome.cs` | Four outcome types: Failure, Success, Masterwork, Catastrophe |
| `RuneAndRust.Core/Entities/Recipe.cs` | Recipe definition with DC, ingredients, and output configuration |
| `RuneAndRust.Core/Models/Crafting/CraftingResult.cs` | Record containing dice results, outcome, and produced item details |
| `RuneAndRust.Core/Interfaces/ICraftingService.cs` | Contract for crafting operations (6 methods) |
| `RuneAndRust.Core/Data/RecipeRegistry.cs` | Static registry with 12 seed recipes and lookup methods |

#### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CraftingService.cs` | WITS-based crafting logic with ingredient validation and quality scaling |

#### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CraftingServiceTests.cs` | Crafting mechanics validation (17 tests) |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/CommandParser.cs` | Extended `ParseResult` with crafting flags; added craft/make/create commands |
| `RuneAndRust.Terminal/Program.cs` | Registered IItemRepository, IInventoryService, ICraftingService in DI; updated version to v0.3.1a |

---

### Code Implementation Details

#### CraftingTrade Enum
```csharp
public enum CraftingTrade
{
    Bodging = 0,       // Mechanical repairs, improvised tools
    Alchemy = 1,       // Potions, salves, chemical compounds
    Runeforging = 2,   // Aetheric inscriptions, enchantments
    FieldMedicine = 3  // Bandages, stimulants, medical kits
}
```

#### CraftingOutcome Enum
```csharp
public enum CraftingOutcome
{
    Failure = 0,      // Net successes < DC (no output, ingredients lost)
    Success = 1,      // Net successes >= DC (ClanForged quality)
    Masterwork = 2,   // Net successes >= DC + 5 (MythForged quality)
    Catastrophe = 3   // Net successes < 0 (materials destroyed)
}
```

#### Recipe Entity
```csharp
public class Recipe
{
    public string RecipeId { get; set; }       // e.g., "RCP_ALC_STIM"
    public string Name { get; set; }            // Display name
    public string Description { get; set; }     // Narrative description
    public CraftingTrade Trade { get; set; }    // Trade category
    public int BaseDc { get; set; }             // Difficulty class
    public Dictionary<string, int> Ingredients { get; set; }  // ItemId -> Quantity
    public string OutputItemId { get; set; }    // Output item ID
    public int OutputQuantity { get; set; }     // Output count
    public List<string> RequiredKeywords { get; set; }  // Optional prerequisites
}
```

#### CraftingResult Record
```csharp
public record CraftingResult(
    bool IsSuccess,
    CraftingOutcome Outcome,
    string RecipeId,
    string RecipeName,
    int DiceRolled,
    int Successes,
    int Botches,
    int NetSuccesses,
    int DifficultyClass,
    string? OutputItemId,
    int OutputQuantity,
    QualityTier? OutputQuality,
    string Message,
    IReadOnlyList<int> Rolls
);
```

#### ICraftingService Interface
```csharp
public interface ICraftingService
{
    Task<CraftingResult> CraftItemAsync(Character crafter, string recipeId);
    bool HasIngredients(Character crafter, Recipe recipe);
    IReadOnlyList<Recipe> GetAvailableRecipes(Character crafter);
    IReadOnlyList<Recipe> GetRecipesByTrade(CraftingTrade trade);
    Recipe? GetRecipe(string recipeId);
    IReadOnlyList<Recipe> GetAllRecipes();
}
```

#### RecipeRegistry Static Class
```csharp
public static class RecipeRegistry
{
    private static readonly Dictionary<string, Recipe> _recipes;
    public static IReadOnlyDictionary<string, Recipe> Recipes => _recipes;

    static RecipeRegistry() => InitializeRecipes();

    public static Recipe? GetById(string recipeId);
    public static IReadOnlyList<Recipe> GetByTrade(CraftingTrade trade);
    public static IReadOnlyList<Recipe> GetAll();

    private static void InitializeRecipes();  // Seeds 12 recipes
}
```

#### CraftingService Outcome Thresholds
```csharp
private const int MasterworkThreshold = 5;  // DC + 5 for masterwork

private static CraftingOutcome DetermineOutcome(int netSuccesses, int dc)
{
    if (netSuccesses < 0)
        return CraftingOutcome.Catastrophe;
    if (netSuccesses >= dc + MasterworkThreshold)
        return CraftingOutcome.Masterwork;
    if (netSuccesses >= dc)
        return CraftingOutcome.Success;
    return CraftingOutcome.Failure;
}
```

#### Quality Tier Mapping
```csharp
// Masterwork crafting produces MythForged quality
var masterworkItem = CloneItemWithQuality(outputItem, QualityTier.MythForged);

// Standard success produces ClanForged quality
var craftedItem = CloneItemWithQuality(outputItem, QualityTier.ClanForged);
```

#### ParseResult Extensions
```csharp
public class ParseResult
{
    // Existing properties...

    // New crafting properties
    public bool RequiresCraft { get; set; }
    public string? CraftTarget { get; set; }
}
```

---

### Seed Recipe Data (12 Recipes)

#### Bodging Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_BOD_TORCH | Improvised Torch | 2 | scrap_wood x1, oily_rag x1 | torch |
| RCP_BOD_LOCKPICK | Bent Lockpick | 3 | scrap_metal x2 | lockpick |
| RCP_BOD_ROPE | Knotted Rope | 2 | fiber_bundle x3 | rope |

#### Alchemy Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_ALC_STIM | Basic Stimulant | 3 | blight_moss x1, clean_water x1 | stimulant |
| RCP_ALC_ANTITOX | Crude Antitoxin | 4 | blight_moss x2, charcoal x1 | antitoxin |
| RCP_ALC_FIREBOMB | Alchemist Fire | 5 | oily_rag x2, sulfur x1, glass_vial x1 | firebomb |

#### Runeforging Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_RUN_GLOW | Glow Stone | 2 | quartz_shard x1, aether_dust x1 | glowstone |
| RCP_RUN_WARD | Minor Ward Token | 4 | iron_shard x1, aether_dust x2 | wardtoken |
| RCP_RUN_CHARGE | Runic Battery | 5 | copper_wire x2, aether_dust x3 | battery |

#### Field Medicine Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_MED_BANDAGE | Field Bandage | 2 | clean_cloth x2 | bandage |
| RCP_MED_SPLINT | Emergency Splint | 3 | scrap_wood x1, clean_cloth x1 | splint |
| RCP_MED_KIT | Medkit | 4 | clean_cloth x3, blight_moss x1, clean_water x1 | medkit |

---

### Commands Reference (Updated)

#### Exploration Phase Commands
| Command | Aliases | Action |
|---------|---------|--------|
| `craft <recipe>` | `make <recipe>`, `create <recipe>` | Attempt to craft using WITS roll |

---

### Logging Matrix (v0.3.1a)

#### CraftingService Logs
| Event | Level | Template |
|-------|-------|----------|
| Craft Start | Information | `"Crafting attempt: {RecipeId} by {CharacterName}"` |
| Recipe Lookup | Debug | `"Recipe lookup: {RecipeId} found={Found}"` |
| Ingredient Check | Debug | `"Ingredient check: {ItemId} required={Required} has={Available}"` |
| Ingredient Consumed | Debug | `"Consumed: {Quantity}x {ItemId}"` |
| Consume Failed | Warning | `"Failed to consume ingredient {ItemId}: {Message}"` |
| Dice Roll | Debug | `"Craft roll: {Wits}d10 = {Successes}S/{Botches}B, Net={Net}, DC={DC}"` |
| Craft Success | Information | `"Craft SUCCESS: {RecipeName} -> {Quantity}x {ItemId} (ClanForged)"` |
| Craft Masterwork | Information | `"Craft MASTERWORK: {RecipeName} -> {Quantity}x {ItemId}"` |
| Craft Failure | Information | `"Craft FAILURE: {RecipeName} (Net {Net} < DC {DC})"` |
| Craft Catastrophe | Warning | `"Craft CATASTROPHE: {RecipeName} - materials lost!"` |

#### CommandParser Logs
| Event | Level | Template |
|-------|-------|----------|
| Craft Command | Debug | `"Craft command for target: {Target}"` |

---

### Complete Test Inventory

#### Engine/CraftingServiceTests.cs (17 tests)

##### Ingredient Validation Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_WithUnknownRecipe_ReturnsFailure` | Unknown recipe returns failure |
| `CraftItem_WithInsufficientIngredients_ReturnsFailure` | Missing ingredients blocks crafting |
| `CraftItem_WithValidIngredients_ConsumesIngredients` | Verifies ingredient consumption |

##### Outcome Determination Tests (6 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_RollMeetsDc_ReturnsSuccess` | Net == DC returns Success |
| `CraftItem_RollExceedsDcBy5_ReturnsMasterwork` | Net >= DC + 5 returns Masterwork |
| `CraftItem_RollBelowDc_ReturnsFailure` | Net < DC returns Failure |
| `CraftItem_NetNegativeSuccesses_ReturnsCatastrophe` | Net < 0 returns Catastrophe |
| `CraftItem_RollExactlyAtMasterworkThreshold_ReturnsMasterwork` | Edge case for masterwork threshold |

##### HasIngredients Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `HasIngredients_WithExactQuantity_ReturnsTrue` | Exact match passes |
| `HasIngredients_WithExcessQuantity_ReturnsTrue` | Excess quantity passes |
| `HasIngredients_WithMissingItem_ReturnsFalse` | Missing item fails |
| `HasIngredients_WithInsufficientQuantity_ReturnsFalse` | Insufficient quantity fails |

##### Recipe Query Tests (5 tests)
| Test Name | Description |
|-----------|-------------|
| `GetAvailableRecipes_FiltersToAffordable` | Only craftable recipes returned |
| `GetRecipesByTrade_ReturnsCorrectTrade` | Trade filtering works |
| `GetRecipe_WithValidId_ReturnsRecipe` | Valid ID returns recipe |
| `GetRecipe_WithInvalidId_ReturnsNull` | Invalid ID returns null |
| `GetAllRecipes_Returns12Recipes` | All 12 recipes returned |

---

### DI Registration

Added to `Program.cs`:
```csharp
// Register Repositories
services.AddScoped<IItemRepository, ItemRepository>();

// Register Inventory Services
services.AddScoped<IInventoryService, InventoryService>();

// Register Crafting Services (v0.3.1a)
services.AddScoped<ICraftingService, CraftingService>();
```

---

### Build Verification

```
Build succeeded.
    0 Error(s)

Test run:
  Passed: 1672
  Failed: 0
  Skipped: 0
```

---

### Directory Structure After v0.3.1a

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Data/
│   │   └── RecipeRegistry.cs                [NEW]
│   ├── Entities/
│   │   ├── Character.cs
│   │   ├── Recipe.cs                        [NEW]
│   │   └── ... (existing entities)
│   ├── Enums/
│   │   ├── CraftingOutcome.cs               [NEW]
│   │   ├── CraftingTrade.cs                 [NEW]
│   │   └── ... (existing enums)
│   ├── Interfaces/
│   │   ├── ICraftingService.cs              [NEW]
│   │   └── ... (existing interfaces)
│   └── Models/
│       └── Crafting/
│           └── CraftingResult.cs            [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CommandParser.cs                 [MODIFIED]
│       ├── CraftingService.cs               [NEW]
│       └── ... (existing services)
├── RuneAndRust.Terminal/
│   └── Program.cs                           [MODIFIED]
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── CraftingServiceTests.cs          [NEW]
│       └── ... (existing tests)
└── docs/
    └── changelogs/
        └── v0.3.1a.md                       [NEW]
```

---

### Dependencies

#### Service Dependencies
| Service | Depends On |
|---------|------------|
| CraftingService | IDiceService, IInventoryService, IItemRepository, ILogger |

#### Existing Infrastructure Used
| Component | Usage |
|-----------|-------|
| IDiceService | WITS pool rolling (d10 with 8+ success, 1 botch) |
| IInventoryService | Ingredient consumption, output item addition |
| IItemRepository | Item lookup for creating output items |
| QualityTier | Output quality (ClanForged for success, MythForged for masterwork) |

---

### Test Summary by Category

| Category | Test Count |
|----------|------------|
| CraftItemAsync - Ingredient Validation | 3 |
| CraftItemAsync - Outcome Determination | 6 |
| HasIngredients | 4 |
| Recipe Queries | 5 |
| **v0.3.1a New Tests** | **17** |
| **Total** | **1672** |

---

### Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.3.1a new tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingService"

# Run crafting outcome tests specifically
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingService&FullyQualifiedName~Outcome"
```

---

### Migration Notes

- **No database migrations required**: Recipes use static registry pattern (not persisted)
- **RecipeRegistry auto-initializes**: Static constructor seeds all 12 recipes
- **ICraftingService registered as Scoped**: Inherits scope from IInventoryService dependency

---

### Next Steps (v0.3.1b: Crafting UI)

Potential features for the next sub-release:
- CraftingScreenRenderer for dedicated crafting interface
- Recipe list display with ingredient availability indicators
- Crafting progress and result feedback
- Integration with exploration phase flow

---

## Part B: The Tinkerer (Bodging & Medicine)

**Release Date:** December 20, 2025
**Total Tests:** 1692 (20 new tests added)

---

### Summary

Version 0.3.1b introduces the **Bodging System** - equipment durability tracking with WITS-based repair mechanics and salvage operations. This release establishes the foundation for equipment maintenance and material recycling in Rune & Rust.

Key architectural additions:
- **Durability System**: Equipment entities now track MaxDurability, CurrentDurability, and IsBroken state
- **IBodgingService**: Service contract with 5 methods for repair and salvage operations
- **BodgingService**: WITS-based repair with 4-tier outcomes, salvage with quality/weight-based yield
- **RepairResult/SalvageResult Records**: Operation result models with full roll details
- **Extended Command Parser**: New verbs (repair, fix, mend, salvage, scrap, dismantle)

---

### New Features

#### Equipment Durability System
- **MaxDurability**: Maximum durability value (default 100)
- **CurrentDurability**: Current durability, decreased by damage
- **IsBroken**: Computed property, true when CurrentDurability <= 0
- **Permanent Damage**: Catastrophic repair failures reduce MaxDurability by 10

#### WITS-Based Repair Mechanics
- **Dice Pool**: Character's WITS attribute determines number of d10s rolled
- **Success Threshold**: Rolls of 8+ count as successes; rolls of 1 count as botches
- **Dynamic DC**: DC = 8 + (damage / 5) - more damaged items are harder to repair
- **Scrap Cost**: Ceiling(damage / 5) Scrap consumed before rolling

#### Four-Tier Repair Outcomes
- **Catastrophe (Net < 0)**: Materials lost, MaxDurability permanently reduced by 10
- **Failure (0 <= Net < DC)**: Materials lost, no repair performed
- **Success (Net >= DC)**: Durability restored by min(damage, net * 5)
- **Masterwork (Net >= DC + 5)**: Full restoration to MaxDurability

#### Salvage System
- **Yield Formula**: (Weight / 100) * (QualityModifier + 1)
- **Quality Modifiers**: JuryRigged=0, Scavenged=1, ClanForged=2, Optimized=3, MythForged=4
- **Minimum Yield**: Always at least 1 Scrap
- **Item Destruction**: Salvaged equipment is permanently destroyed

---

### Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/Crafting/RepairResult.cs` | Record containing dice results, outcome, and durability changes |
| `RuneAndRust.Core/Models/Crafting/SalvageResult.cs` | Record containing salvage success status and Scrap yield |
| `RuneAndRust.Core/Interfaces/IBodgingService.cs` | Contract for repair and salvage operations (5 methods) |

#### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/BodgingService.cs` | WITS-based repair logic with durability management and salvage yield |

#### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/BodgingServiceTests.cs` | Repair and salvage mechanics validation (20 tests) |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Equipment.cs` | Added MaxDurability, CurrentDurability, IsBroken properties |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Extended ParseResult with repair/salvage flags; added repair/fix/mend/salvage/scrap/dismantle commands |
| `RuneAndRust.Terminal/Program.cs` | Registered IBodgingService in DI; updated version to v0.3.1b |

---

### Code Implementation Details

#### Equipment Durability Properties
```csharp
public class Equipment : Item
{
    // Existing properties...

    #region Durability Properties

    /// <summary>
    /// Gets or sets the maximum durability of this equipment.
    /// Equipment cannot be repaired beyond this value.
    /// </summary>
    public int MaxDurability { get; set; } = 100;

    /// <summary>
    /// Gets or sets the current durability of this equipment.
    /// Equipment becomes broken when this reaches 0.
    /// </summary>
    public int CurrentDurability { get; set; } = 100;

    /// <summary>
    /// Gets whether this equipment is broken and unusable.
    /// Broken equipment provides no bonuses and cannot be used in combat.
    /// </summary>
    public bool IsBroken => CurrentDurability <= 0;

    #endregion
}
```

#### RepairResult Record
```csharp
public record RepairResult(
    bool IsSuccess,
    CraftingOutcome Outcome,
    string ItemName,
    int DiceRolled,
    int Successes,
    int Botches,
    int NetSuccesses,
    int DifficultyClass,
    int DurabilityRestored,
    int ScrapConsumed,
    int? MaxDurabilityLost,  // Only set on Catastrophe
    string Message,
    IReadOnlyList<int> Rolls
);
```

#### SalvageResult Record
```csharp
public record SalvageResult(
    bool IsSuccess,
    string ItemName,
    int ScrapYield,
    string Message
);
```

#### IBodgingService Interface
```csharp
public interface IBodgingService
{
    Task<RepairResult> RepairItemAsync(Character character, Guid itemId);
    Task<SalvageResult> SalvageItemAsync(Character character, Guid itemId);
    int CalculateRepairCost(Equipment equipment);
    int CalculateSalvageYield(Equipment equipment);
    bool CanRepair(Character character, Equipment equipment);
}
```

#### BodgingService Core Constants
```csharp
private const int BaseRepairDc = 8;           // Base DC for repair
private const int DamageDivisor = 5;           // Divides damage for cost/DC calculation
private const int MasterworkThreshold = 5;     // DC + 5 for masterwork
private const int CatastrophePenalty = 10;     // MaxDurability reduction on fumble
private const int SalvageWeightDivisor = 100;  // Divides weight for yield calculation
```

#### Repair DC Calculation
```csharp
private int CalculateDc(Equipment equipment)
{
    var damage = equipment.MaxDurability - equipment.CurrentDurability;
    return BaseRepairDc + (damage / DamageDivisor);
}
```

#### Salvage Yield Calculation
```csharp
public int CalculateSalvageYield(Equipment equipment)
{
    var qualityMod = GetQualityModifier(equipment.Quality);
    var yield = (equipment.Weight / SalvageWeightDivisor) * (qualityMod + 1);
    return Math.Max(1, yield); // Minimum 1 Scrap
}

private static int GetQualityModifier(QualityTier tier) => tier switch
{
    QualityTier.JuryRigged => 0,
    QualityTier.Scavenged => 1,
    QualityTier.ClanForged => 2,
    QualityTier.Optimized => 3,
    QualityTier.MythForged => 4,
    _ => 0
};
```

#### ParseResult Extensions
```csharp
public class ParseResult
{
    // Existing properties...

    // New repair properties
    public bool RequiresRepair { get; set; }
    public string? RepairTarget { get; set; }

    // New salvage properties
    public bool RequiresSalvage { get; set; }
    public string? SalvageTarget { get; set; }
}
```

---

### Commands Reference (Updated)

#### Exploration Phase Commands
| Command | Aliases | Action |
|---------|---------|--------|
| `repair <item>` | `fix <item>`, `mend <item>` | Attempt to repair equipment using WITS roll |
| `salvage <item>` | `scrap <item>`, `dismantle <item>` | Destroy equipment to extract Scrap |

---

### Logging Matrix (v0.3.1b)

#### BodgingService Logs
| Event | Level | Template |
|-------|-------|----------|
| Repair Start | Information | `"Repair attempt: {ItemName} by {CharacterName}"` |
| Repair Cost Calculated | Debug | `"Repair cost: {ScrapCost} Scrap for {Damage} damage"` |
| Scrap Consumed | Debug | `"Consumed: {Quantity}x Scrap for repair"` |
| Repair Roll | Debug | `"Repair roll: {Wits}d10 = {Successes}S/{Botches}B, Net={Net}, DC={DC}"` |
| Repair Success | Information | `"Repair SUCCESS: {ItemName} restored {Durability} points"` |
| Repair Masterwork | Information | `"Repair MASTERWORK: {ItemName} fully restored"` |
| Repair Failure | Information | `"Repair FAILURE: {ItemName} (Net {Net} < DC {DC})"` |
| Repair Catastrophe | Warning | `"Repair CATASTROPHE: {ItemName} - MaxDurability reduced by {Penalty}!"` |
| Salvage Start | Information | `"Salvage attempt: {ItemName} by {CharacterName}"` |
| Salvage Yield | Debug | `"Salvage yield: {Yield} Scrap from {Weight}g {Quality} item"` |
| Salvage Complete | Information | `"Salvage SUCCESS: {ItemName} -> {Yield}x Scrap"` |

#### CommandParser Logs
| Event | Level | Template |
|-------|-------|----------|
| Repair Command | Debug | `"Repair command for target: {Target}"` |
| Salvage Command | Debug | `"Salvage command for target: {Target}"` |

---

### Complete Test Inventory

#### Engine/BodgingServiceTests.cs (20 tests)

##### Validation Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `RepairItem_WithNonEquipment_ReturnsFailure` | Non-equipment items cannot be repaired |
| `RepairItem_WithUndamagedItem_ReturnsFailure` | Pristine items don't need repair |
| `RepairItem_WithInsufficientScrap_ReturnsFailure` | Insufficient materials blocks repair |
| `RepairItem_WithUnknownItem_ReturnsFailure` | Unknown item ID returns failure |

##### Outcome Determination Tests (5 tests)
| Test Name | Description |
|-----------|-------------|
| `RepairItem_RollMeetsDc_RestoresDurability` | Net >= DC restores durability |
| `RepairItem_RollExceedsDcBy5_FullyRestores` | Net >= DC + 5 fully restores |
| `RepairItem_RollBelowDc_ReturnsFailure` | Net < DC returns Failure |
| `RepairItem_NetNegative_ReducesMaxDurability` | Net < 0 permanently reduces MaxDurability |
| `RepairItem_ConsumesScrap` | Verifies Scrap consumption |

##### Salvage Tests (5 tests)
| Test Name | Description |
|-----------|-------------|
| `SalvageItem_WithValidEquipment_YieldsScrap` | Valid salvage produces Scrap |
| `SalvageItem_WithNonEquipment_ReturnsFailure` | Non-equipment cannot be salvaged |
| `SalvageItem_RemovesItemFromInventory` | Item removed on salvage |
| `SalvageItem_HighQualityYieldsMoreScrap` | Higher quality = more Scrap |
| `SalvageItem_HeavyItemYieldsMoreScrap` | Heavier items = more Scrap |

##### Helper Method Tests (6 tests)
| Test Name | Description |
|-----------|-------------|
| `CalculateRepairCost_ReturnsCorrectValue` | Ceiling(damage / 5) |
| `CalculateRepairCost_MinimumOne` | Always at least 1 Scrap |
| `CalculateSalvageYield_ReturnsCorrectValue` | (Weight/100) * (QualityMod+1) |
| `CalculateSalvageYield_MinimumOne` | Always at least 1 Scrap |
| `CanRepair_WithSufficientScrap_ReturnsTrue` | Enough Scrap passes |
| `CanRepair_WithInsufficientScrap_ReturnsFalse` | Not enough Scrap fails |

---

### DI Registration

Added to `Program.cs`:
```csharp
// Register Bodging Services (v0.3.1b)
services.AddScoped<IBodgingService, BodgingService>();
```

---

### Build Verification

```
Build succeeded.
    0 Error(s)

Test run:
  Passed: 1692
  Failed: 0
  Skipped: 0
```

---

### Directory Structure After v0.3.1b

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   ├── Equipment.cs                       [MODIFIED - durability]
│   │   └── ... (existing entities)
│   ├── Interfaces/
│   │   ├── IBodgingService.cs                 [NEW]
│   │   └── ... (existing interfaces)
│   └── Models/
│       └── Crafting/
│           ├── CraftingResult.cs
│           ├── RepairResult.cs                [NEW]
│           └── SalvageResult.cs               [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── BodgingService.cs                  [NEW]
│       ├── CommandParser.cs                   [MODIFIED]
│       └── ... (existing services)
├── RuneAndRust.Terminal/
│   └── Program.cs                             [MODIFIED]
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── BodgingServiceTests.cs             [NEW]
│       └── ... (existing tests)
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        └── v0.3.1b.md                         [NEW]
```

---

### Dependencies

#### Service Dependencies
| Service | Depends On |
|---------|------------|
| BodgingService | IDiceService, IInventoryService, IItemRepository, ILogger |

#### Existing Infrastructure Used
| Component | Usage |
|-----------|-------|
| IDiceService | WITS pool rolling (d10 with 8+ success, 1 botch) |
| IInventoryService | Scrap consumption, item removal, Scrap addition |
| IItemRepository | Scrap item lookup for salvage output |
| QualityTier | Salvage yield calculation multiplier |
| CraftingOutcome | Reused for repair outcome classification |

---

### Test Summary by Category

| Category | Test Count |
|----------|------------|
| RepairItemAsync - Validation | 4 |
| RepairItemAsync - Outcomes | 5 |
| SalvageItemAsync | 5 |
| Helper Methods | 6 |
| **v0.3.1b New Tests** | **20** |
| **Total** | **1692** |

---

### Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.3.1b new tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~BodgingService"

# Run repair outcome tests specifically
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~BodgingService&FullyQualifiedName~Repair"

# Run salvage tests specifically
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~BodgingService&FullyQualifiedName~Salvage"
```

---

### Migration Notes

- **No database migrations required**: Durability properties are in-memory state
- **Existing Equipment unaffected**: Defaults to 100/100 durability (pristine condition)
- **IBodgingService registered as Scoped**: Inherits scope from IInventoryService dependency
- **Scrap item**: Created dynamically if not found in ItemRepository

---

### Next Steps (v0.3.1c: Crafting UI)

Potential features for the next sub-release:
- CraftingScreenRenderer for dedicated crafting interface
- Recipe list display with ingredient availability indicators
- Durability display in equipment UI
- Repair confirmation prompts with cost preview
- Location-restricted Field Medicine crafting

---

## Part C: The Alchemist (Alchemy & Runeforging)

**Release Date:** December 20, 2025
**Total Tests:** 1704 (12 new tests added)

---

### Summary

Version 0.3.1c introduces **trade-specific catastrophe mechanics** for Alchemy and Runeforging crafting trades. When crafters roll net negative successes, they now suffer consequences unique to their trade: Alchemists take explosive damage, while Runeforgers accumulate Corruption.

Key architectural additions:
- **CatastropheType Enum**: Five catastrophe types (None, Explosive, Toxic, Corrosive, Corruption)
- **ItemProperty Entity**: Foundation for runic enchantment buffs on items
- **Trade-Specific Handling**: CraftingService applies damage or Corruption based on recipe CatastropheType
- **Extended Recipe Model**: Recipes now define catastrophe type, damage, and corruption values
- **Extended Command Parser**: New verbs (brew, mix, concoct, forge, inscribe, etch)

---

### New Features

#### Trade-Specific Catastrophe Mechanics

##### Alchemy: Explosive Catastrophe
- **Trigger**: Net negative successes on Alchemy recipe
- **Effect**: Crafter takes physical damage (CatastropheDamage property)
- **Damage Values**:
  - Basic Stimulant: 5 damage
  - Crude Antitoxin: 8 damage
  - Alchemist Fire: 15 damage
- **HP Clamping**: Damage cannot reduce HP below 0

##### Runeforging: Corruption Catastrophe
- **Trigger**: Net negative successes on Runeforging recipe
- **Effect**: Crafter gains permanent Corruption via TraumaService
- **Corruption Values**:
  - Glow Stone: 3 Corruption
  - Minor Ward Token: 5 Corruption
  - Runic Battery: 8 Corruption
- **Integration**: Uses existing ITraumaService.AddCorruption() method

#### ItemProperty System (Foundation)
- **Entity Created**: Stores runic buffs for future enchantment features
- **StatModifiers Dictionary**: Maps stat names to modifier values
- **Item.Properties Collection**: Equipment can hold multiple properties
- **Ready for v0.3.1d**: Target item enchantment implementation

#### New Commands
- **Alchemy**: `brew <recipe>`, `mix <recipe>`, `concoct <recipe>`
- **Runeforging**: `forge <rune>`, `forge <rune> on <item>`, `inscribe`, `etch`

---

### Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CatastropheType.cs` | Enum with 5 catastrophe types |
| `RuneAndRust.Core/Entities/ItemProperty.cs` | Entity for runic buffs with stat modifiers |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Item.cs` | Added Properties collection for enchantments |
| `RuneAndRust.Core/Entities/Recipe.cs` | Added CatastropheType, CatastropheDamage, CatastropheCorruption, OutputProperties, RequiresTargetItem |
| `RuneAndRust.Core/Models/Crafting/CraftingResult.cs` | Added DamageDealt, CorruptionAdded, EnchantedItem optional fields |
| `RuneAndRust.Engine/Services/CraftingService.cs` | Injected ITraumaService, added trade-specific catastrophe handling |
| `RuneAndRust.Core/Data/RecipeRegistry.cs` | Updated Alchemy (Explosive) and Runeforging (Corruption) recipes |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added brew/mix/concoct and forge/inscribe/etch commands |
| `RuneAndRust.Tests/Engine/CraftingServiceTests.cs` | Added 12 new catastrophe tests |

---

### Code Implementation Details

#### CatastropheType Enum
```csharp
public enum CatastropheType
{
    None = 0,       // Standard catastrophe: materials lost only
    Explosive = 1,  // Alchemy: deals physical damage
    Toxic = 2,      // Reserved for future
    Corrosive = 3,  // Reserved for future
    Corruption = 4  // Runeforging: adds permanent Corruption
}
```

#### ItemProperty Entity
```csharp
public class ItemProperty
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public Dictionary<string, int> StatModifiers { get; set; } = new();
    public DateTime AppliedAt { get; set; } = DateTime.UtcNow;
}
```

#### Recipe Catastrophe Properties
```csharp
public class Recipe
{
    // Existing properties...

    // Catastrophe Properties (v0.3.1c)
    public CatastropheType CatastropheType { get; set; } = CatastropheType.None;
    public int CatastropheDamage { get; set; } = 0;
    public int CatastropheCorruption { get; set; } = 0;

    // Runeforging Properties (v0.3.1c)
    public List<ItemProperty> OutputProperties { get; set; } = new();
    public bool RequiresTargetItem { get; set; } = false;
}
```

#### CraftingResult Extensions
```csharp
public record CraftingResult(
    // Existing parameters...
    int? DamageDealt = null,       // HP damage from Explosive catastrophe
    int? CorruptionAdded = null,   // Corruption from Runeforging catastrophe
    Equipment? EnchantedItem = null // Target item enchanted by Runeforging
);
```

#### CraftingService Catastrophe Handler
```csharp
private CraftingResult HandleCatastrophe(Character crafter, Recipe recipe, DiceResult diceResult, int netSuccesses)
{
    switch (recipe.CatastropheType)
    {
        case CatastropheType.Explosive:
            crafter.CurrentHP = Math.Max(0, crafter.CurrentHP - recipe.CatastropheDamage);
            // Return result with DamageDealt set
            break;

        case CatastropheType.Corruption:
            _traumaService.AddCorruption(crafter, recipe.CatastropheCorruption, "Runic Backlash");
            // Return result with CorruptionAdded set
            break;

        default:
            // Standard catastrophe: materials lost only
            break;
    }
}
```

#### ParseResult Extensions
```csharp
public class ParseResult
{
    // Existing properties...

    // Alchemy & Runeforging Commands (v0.3.1c)
    public bool RequiresBrew { get; set; }
    public string? BrewTarget { get; set; }
    public bool RequiresForge { get; set; }
    public string? ForgeRune { get; set; }
    public string? ForgeTarget { get; set; }
}
```

---

### Commands Reference (Updated)

#### Exploration Phase Commands
| Command | Aliases | Action |
|---------|---------|--------|
| `brew <recipe>` | `mix <recipe>`, `concoct <recipe>` | Attempt to brew an Alchemy recipe |
| `forge <rune>` | `inscribe <rune>`, `etch <rune>` | Forge a runic item |
| `forge <rune> on <item>` | `inscribe <rune> on <item>` | Inscribe a rune onto equipment |

---

### Logging Matrix (v0.3.1c)

#### CraftingService Logs
| Event | Level | Template |
|-------|-------|----------|
| Alchemy Catastrophe | Warning | `"ALCHEMY CATASTROPHE: {CharacterName} takes {Damage} explosive damage!"` |
| Runeforging Catastrophe | Warning | `"RUNEFORGING CATASTROPHE: {CharacterName} gains {Corruption} Corruption!"` |

#### CommandParser Logs
| Event | Level | Template |
|-------|-------|----------|
| Brew Command | Debug | `"Brew command for target: {Target}"` |
| Forge Command | Debug | `"Forge command: {Rune} on {Target}"` |
| Forge Command (no target) | Debug | `"Forge command (no target): {Rune}"` |

---

### Complete Test Inventory

#### Engine/CraftingServiceTests.cs (12 new tests)

##### Alchemy Catastrophe Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_AlchemyCatastrophe_DealsDamage` | Verifies HP reduction on explosive failure |
| `CraftItem_AlchemyCatastrophe_SetsResultDamage` | Verifies DamageDealt is set in result |
| `CraftItem_AlchemyCatastrophe_DoesNotReduceHpBelowZero` | HP clamped to 0 minimum |
| `CraftItem_FirebombCatastrophe_DealsHighDamage` | High-risk recipe deals 15 damage |

##### Runeforging Catastrophe Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_RuneforgingCatastrophe_AddsCorruption` | Verifies TraumaService.AddCorruption called |
| `CraftItem_RuneforgingCatastrophe_SetsResultCorruption` | Verifies CorruptionAdded is set in result |
| `CraftItem_RuneforgingSuccess_NoCorruptionAdded` | Success does not add Corruption |

##### Cross-Trade Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_BodgingCatastrophe_NoDamageOrCorruption` | Bodging has no special catastrophe |
| `CraftItem_AlchemySuccess_CreatesPotionWithNoDamage` | Success causes no damage |
| `Recipe_CatastropheType_DefaultsToNone` | Default catastrophe type is None |

##### Recipe Validation Tests (2 tests)
| Test Name | Description |
|-----------|-------------|
| `Recipe_AlchemyRecipes_HaveExplosiveCatastrophe` | All Alchemy recipes have Explosive type |
| `Recipe_RuneforgingRecipes_HaveCorruptionCatastrophe` | All Runeforging recipes have Corruption type |

---

### DI Registration

No new DI registrations required. ITraumaService already registered in Program.cs from v0.3.0b.

---

### Build Verification

```
Build succeeded.
    0 Error(s)

Unit Test run (excludes integration tests):
  Passed: 1567
  Failed: 0
  Skipped: 0

Note: 137 integration tests require a running PostgreSQL database.
Run with: dotnet test --filter "FullyQualifiedName!~Integration"
```

---

### Directory Structure After v0.3.1c

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Data/
│   │   └── RecipeRegistry.cs                    [MODIFIED - catastrophe data]
│   ├── Entities/
│   │   ├── Item.cs                              [MODIFIED - Properties]
│   │   ├── ItemProperty.cs                      [NEW]
│   │   ├── Recipe.cs                            [MODIFIED - catastrophe fields]
│   │   └── ... (existing entities)
│   ├── Enums/
│   │   ├── CatastropheType.cs                   [NEW]
│   │   └── ... (existing enums)
│   └── Models/
│       └── Crafting/
│           ├── CraftingResult.cs                [MODIFIED - new fields]
│           └── ... (existing models)
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CraftingService.cs                   [MODIFIED - catastrophe logic]
│       ├── CommandParser.cs                     [MODIFIED - brew/forge commands]
│       └── ... (existing services)
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── CraftingServiceTests.cs              [MODIFIED - 12 new tests]
│       └── ... (existing tests)
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        └── v0.3.1c.md                           [NEW]
```

---

### Dependencies

#### Service Dependencies
| Service | Depends On |
|---------|------------|
| CraftingService | IDiceService, IInventoryService, IItemRepository, ITraumaService, ILogger |

#### Existing Infrastructure Used
| Component | Usage |
|-----------|-------|
| ITraumaService | AddCorruption() for Runeforging catastrophe |
| Character.CurrentHP | HP reduction for Alchemy catastrophe |
| Character.Corruption | Corruption tracking (0-100) |
| CraftingOutcome | Reused for outcome determination |

---

### Test Summary by Category

| Category | Test Count |
|----------|------------|
| CraftingServiceTests - Alchemy Catastrophe | 4 |
| CraftingServiceTests - Runeforging Catastrophe | 3 |
| CraftingServiceTests - Cross-Trade | 3 |
| CraftingServiceTests - Recipe Validation | 2 |
| **v0.3.1c New Tests** | **12** |
| **Total** | **1704** |

---

### Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.3.1c new tests (catastrophe-related)
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingServiceTests&FullyQualifiedName~Catastrophe"

# Run all crafting service tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingServiceTests"

# Run non-integration tests only
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName!~Integration"
```

---

### Migration Notes

- **No database migrations required**: All new properties have defaults and are in-memory state
- **Existing recipes unaffected**: CatastropheType defaults to None (no special effect)
- **TraumaService integration**: Uses existing AddCorruption() method from v0.3.0b
- **Backward compatible**: Existing crafting continues to work unchanged

---

### Next Steps (v0.3.1d: Runeforging Enchantment)

Potential features for the next sub-release:
- Runeforging target item enchantment (apply OutputProperties to equipment)
- ItemProperty persistence to database
- Property stacking and conflict resolution
- Visual indicators for enchanted items in inventory
- Equipment bonuses from ItemProperty.StatModifiers

---

### Catastrophe Damage Reference

#### Alchemy Recipes
| Recipe | Base DC | Catastrophe Damage |
|--------|---------|-------------------|
| Basic Stimulant | 3 | 5 HP |
| Crude Antitoxin | 4 | 8 HP |
| Alchemist Fire | 5 | 15 HP |

#### Runeforging Recipes
| Recipe | Base DC | Catastrophe Corruption |
|--------|---------|----------------------|
| Glow Stone | 2 | 3 Corruption |
| Minor Ward Token | 4 | 5 Corruption |
| Runic Battery | 5 | 8 Corruption |

---

## Part D: Database Infrastructure

**Release Date:** December 20, 2025
**Total Tests:** 1704 (all passing)

---

### Summary

Version 0.3.1d establishes **Docker-based PostgreSQL infrastructure** for the Rune & Rust project. This release adds containerized database support, EF Core migrations, and design-time tooling to enable persistent game state and full integration testing.

Key additions:
- **Docker Compose Configuration**: PostgreSQL 16 container with health checks
- **EF Core Migrations**: Initial schema creation for all 11 database tables
- **Design-Time Factory**: Enables EF tooling without running the full application
- **ItemProperty Persistence**: DbContext configuration for v0.3.1c runeforging system
- **Connection String Updates**: Default configuration for Docker container

---

### New Features

#### Docker PostgreSQL Container

A `docker-compose.yml` configuration provides a ready-to-use PostgreSQL 16 instance:

- **Container Name**: `runeandrust-db`
- **Database**: `RuneAndRust`
- **Port**: 5433 (avoids conflict with existing PostgreSQL instances on 5432)
- **Health Check**: Automatic readiness verification
- **Persistent Volume**: Data survives container restarts

#### EF Core Migration Support

Initial migration creates the complete database schema:

| Table | Purpose |
|-------|---------|
| `SaveGames` | Persisted game saves with JSONB state |
| `Rooms` | World locations with position coordinates |
| `Characters` | Player characters with attributes and stats |
| `InteractableObjects` | Containers, doors, and examinable objects |
| `Items` | Base item table (TPH inheritance) |
| `Equipment` | Weapons and armor (inherits from Items) |
| `ItemProperties` | Runic enchantments with stat modifiers |
| `InventoryItems` | Character-Item join table |
| `CodexEntries` | Scavenger's Journal lore entries |
| `DataCaptures` | Player-discovered knowledge fragments |
| `ActiveAbilities` | Combat abilities by archetype |

#### Design-Time DbContext Factory

Enables EF Core CLI tools to create migrations without starting the application:

```bash
# Create a new migration
dotnet ef migrations add MigrationName --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence

# Apply migrations to database
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
```

---

### Files Created

| File | Purpose |
|------|---------|
| `docker-compose.yml` | PostgreSQL 16 container configuration |
| `RuneAndRust.Persistence/Data/DesignTimeDbContextFactory.cs` | EF Core design-time factory |
| `RuneAndRust.Persistence/Migrations/20251220231703_InitialCreate.cs` | Initial schema migration |
| `docs/changelogs/v0.3.1d.md` | This changelog |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added ItemProperties DbSet and entity configuration |
| `RuneAndRust.Terminal/Program.cs` | Updated default connection string to use port 5433 |

---

### Code Implementation Details

#### Docker Compose Configuration

```yaml
services:
  postgres:
    image: postgres:16
    container_name: runeandrust-db
    environment:
      POSTGRES_DB: RuneAndRust
      POSTGRES_USER: postgres
    ports:
      - "5433:5432"
    volumes:
      - runeandrust_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d RuneAndRust"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  runeandrust_pgdata:
```

#### Design-Time Factory

```csharp
public class DesignTimeDbContextFactory : IDesignTimeDbContextFactory<RuneAndRustDbContext>
{
    public RuneAndRustDbContext CreateDbContext(string[] args)
    {
        var connectionString = Environment.GetEnvironmentVariable("RUNEANDRUST_CONNECTION_STRING")
            ?? "Host=localhost;Port=5433;Database=RuneAndRust;Username=postgres;Password=...";

        var optionsBuilder = new DbContextOptionsBuilder<RuneAndRustDbContext>();
        optionsBuilder.UseNpgsql(connectionString);

        return new RuneAndRustDbContext(optionsBuilder.Options);
    }
}
```

#### ItemProperty Entity Configuration

```csharp
modelBuilder.Entity<ItemProperty>(entity =>
{
    entity.ToTable("ItemProperties");
    entity.HasKey(p => p.Id);

    entity.Property(p => p.Name)
        .HasMaxLength(100)
        .IsRequired();

    entity.Property(p => p.StatModifiers)
        .HasColumnType("jsonb")
        .HasConversion(
            v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
            v => JsonSerializer.Deserialize<Dictionary<string, int>>(v, (JsonSerializerOptions?)null)
                ?? new Dictionary<string, int>()
        )
        .IsRequired();

    entity.Property(p => p.AppliedAt).IsRequired();
});
```

#### Item-to-Properties Relationship

```csharp
modelBuilder.Entity<Item>(entity =>
{
    // ... existing configuration ...

    entity.HasMany(i => i.Properties)
        .WithOne()
        .HasForeignKey("ItemId")
        .OnDelete(DeleteBehavior.Cascade);
});
```

---

### Quick Start Commands

```bash
# Start the database container
docker-compose up -d

# Verify container is running
docker ps --filter "name=runeandrust-db"

# Apply database migrations
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence

# Run the game (connects to Docker database)
dotnet run --project RuneAndRust.Terminal

# Stop the database container
docker-compose down

# Stop and remove all data
docker-compose down -v
```

---

### Environment Variables

| Variable | Purpose | Default |
|----------|---------|---------|
| `RUNEANDRUST_CONNECTION_STRING` | Override database connection | `Host=localhost;Port=5433;Database=RuneAndRust;...` |

---

### Database Schema Overview

#### JSONB Columns

PostgreSQL's JSONB type is used for complex data structures:

| Table | Column | Content |
|-------|--------|---------|
| `SaveGames` | `SerializedState` | Complete game state snapshot |
| `Rooms` | `Exits` | Direction-to-RoomId mappings |
| `Characters` | `EquipmentBonuses` | Attribute-to-bonus mappings |
| `Equipment` | `AttributeBonuses` | Stat bonuses from gear |
| `Equipment` | `Requirements` | Attribute requirements to equip |
| `CodexEntries` | `UnlockThresholds` | Fragment count to text mappings |
| `ItemProperties` | `StatModifiers` | Runic buff values |

#### Table Relationships

```
Characters ─┬─< InventoryItems >─── Items (TPH: Item/Equipment)
            │                            │
            │                            └─< ItemProperties
            │
            └─< DataCaptures >─── CodexEntries

Rooms ─< InteractableObjects

SaveGames (standalone)
ActiveAbilities (standalone)
```

---

### Build Verification

```
Build succeeded.
    0 Error(s)

Test Results:
  Passed: 1704
  Failed: 0
  Skipped: 0

Docker Container:
  Status: Running (healthy)
  Port: 5433
  Database: RuneAndRust (schema applied)
```

---

### Directory Structure After v0.3.1d

```
RuneAndRust/
├── docker-compose.yml                              [NEW]
├── RuneAndRust.Persistence/
│   ├── Data/
│   │   ├── RuneAndRustDbContext.cs                 [MODIFIED]
│   │   └── DesignTimeDbContextFactory.cs           [NEW]
│   └── Migrations/
│       ├── 20251220231703_InitialCreate.cs         [NEW]
│       └── RuneAndRustDbContextModelSnapshot.cs    [NEW]
├── RuneAndRust.Terminal/
│   └── Program.cs                                  [MODIFIED]
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        ├── v0.3.1c.md
        └── v0.3.1d.md                              [NEW]
```

---

### Migration Notes

- **Port 5433**: The Docker container uses port 5433 to avoid conflicts with existing PostgreSQL installations on the default port 5432
- **Credentials**: Default development credentials are used; production deployments should use environment variables
- **Data Persistence**: The `runeandrust_pgdata` volume persists data across container restarts
- **InMemory Tests**: Integration tests continue to use EF Core's InMemory provider for speed; they do not require the Docker container

---

### Test Architecture

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1567 | Mocked dependencies |
| Integration Tests | 137 | EF Core InMemory provider |
| **Total** | **1704** | All passing |

---

### Prerequisites

- Docker Desktop or Docker Engine
- .NET 9.0 SDK
- EF Core CLI tools (`dotnet tool install --global dotnet-ef`)

---

### Troubleshooting

#### Container Name Conflict

If you see "container name already in use":

```bash
docker rm runeandrust-db
docker-compose up -d
```

#### Port Already in Use

If port 5433 is occupied, modify `docker-compose.yml`:

```yaml
ports:
  - "5434:5432"  # Use a different host port
```

Then update the connection string in `Program.cs` or set the environment variable.

#### Migration Errors

If migrations fail, ensure the container is running and healthy:

```bash
docker ps --filter "name=runeandrust-db"
docker logs runeandrust-db
```

---

### Next Steps (v0.3.2)

Potential features for the next release:
- Database seeding with starter content (rooms, items, codex entries)
- Save/Load game functionality using PostgreSQL persistence
- PostgreSQL-specific integration tests for JSONB queries
- Connection pooling configuration for production

---

### Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Microsoft.EntityFrameworkCore.Design | 9.0.4 | EF Core CLI tooling |
| Microsoft.EntityFrameworkCore.InMemory | 9.0.1 | In-memory testing |

---

### Running Tests

```bash
# Run all tests (does not require Docker)
dotnet test RuneAndRust.Tests

# Run only unit tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName!~Integration"

# Run only integration tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~Integration"
```

---

## Part E: PostgreSQL Integration Tests

**Release Date:** December 20, 2025
**Total Tests:** 1733 (all passing)

---

### Summary

Version 0.3.1e adds **PostgreSQL-specific integration tests** that validate database behavior beyond what the InMemory provider can test. These tests run against a real PostgreSQL instance (via Docker) and verify JSONB column persistence, constraint enforcement, transaction handling, and cascade delete behavior.

Key additions:
- **PostgreSQL Test Fixture**: Isolated test database per test run with automatic cleanup
- **JSONB Query Tests**: Validates complex dictionary/object serialization
- **Constraint Validation Tests**: Verifies unique indexes, foreign keys, and cascade deletes
- **Transaction Tests**: Tests commit, rollback, savepoints, and concurrent access

---

### New Test Categories

#### PostgreSQL Test Fixture

The `PostgreSqlTestFixture` class provides isolated PostgreSQL testing:

- Creates a unique database for each test run (`RuneAndRust_Test_{GUID}`)
- Automatically applies EF Core migrations
- Terminates connections and drops database on cleanup
- Each test uses `CreateContext()` for proper isolation

```csharp
public class PostgreSqlTestFixture : IAsyncLifetime
{
    public async Task InitializeAsync()
    {
        // Create unique test database
        await masterContext.Database.ExecuteSqlRawAsync($"CREATE DATABASE \"{_testDatabaseName}\"");

        // Apply migrations
        using var migrationContext = CreateContext();
        await migrationContext.Database.MigrateAsync();
    }

    public async Task DisposeAsync()
    {
        // Terminate connections and drop database
        await masterContext.Database.ExecuteSqlRawAsync($"DROP DATABASE IF EXISTS \"{_testDatabaseName}\"");
    }
}
```

#### JSONB Query Tests (9 tests)

Validates PostgreSQL JSONB column persistence for complex data types:

| Test | Entity | JSONB Column |
|------|--------|--------------|
| `Room_Exits_PersistsJsonbDictionary` | Room | Exits (Direction -> Guid) |
| `Room_Exits_UpdatesJsonbDictionary` | Room | Exits update behavior |
| `Room_Exits_EmptyDictionaryPersists` | Room | Empty dictionary handling |
| `Character_EquipmentBonuses_PersistsJsonbDictionary` | Character | EquipmentBonuses |
| `Equipment_AttributeBonuses_PersistsJsonbDictionary` | Equipment | AttributeBonuses, Requirements |
| `ItemProperty_StatModifiers_PersistsJsonbDictionary` | ItemProperty | StatModifiers |
| `ItemProperty_MultipleProperties_PersistIndependently` | Item/ItemProperty | Multiple properties |
| `CodexEntry_UnlockThresholds_PersistsJsonbDictionary` | CodexEntry | UnlockThresholds |
| `SaveGame_SerializedState_PersistsLargeJsonb` | SaveGame | SerializedState (large JSON) |

#### Constraint Validation Tests (13 tests)

Verifies PostgreSQL constraint enforcement:

**Unique Constraints (SqlState 23505):**
| Test | Entity | Constraint |
|------|--------|------------|
| `Character_Name_UniqueConstraintEnforced` | Character | IX_Characters_Name |
| `SaveGame_SlotNumber_UniqueConstraintEnforced` | SaveGame | IX_SaveGames_SlotNumber |
| `CodexEntry_Title_UniqueConstraintEnforced` | CodexEntry | IX_CodexEntries_Title |
| `ActiveAbility_Name_UniqueConstraintEnforced` | ActiveAbility | IX_ActiveAbilities_Name |

**Foreign Key Constraints (SqlState 23503):**
| Test | Validates |
|------|-----------|
| `InventoryItem_RequiresValidCharacter` | InventoryItem.CharacterId FK |
| `InventoryItem_RequiresValidItem` | InventoryItem.ItemId FK |
| `DataCapture_CodexEntryId_AllowsNull` | Nullable FK behavior |

**Cascade Deletes:**
| Test | Validates |
|------|-----------|
| `Character_Delete_CascadesInventoryItems` | Character -> InventoryItems cascade |
| `Item_Delete_CascadesItemProperties` | Item -> ItemProperties cascade |

**Required Fields:**
| Test | Validates |
|------|-----------|
| `Room_Name_Required` | Room.Name NOT NULL |
| `Item_Description_Required` | Item.Description NOT NULL |

**TPH Inheritance:**
| Test | Validates |
|------|-----------|
| `TPH_Equipment_LoadsCorrectType` | Equipment loads as Equipment type |
| `TPH_Item_LoadsCorrectType` | Item loads as Item type (not Equipment) |

#### Transaction Tests (7 tests)

Validates PostgreSQL transaction behavior:

| Test | Validates |
|------|-----------|
| `Transaction_Commit_PersistsAllChanges` | Explicit commit persists data |
| `Transaction_Rollback_DiscardsAllChanges` | Explicit rollback discards data |
| `Transaction_Dispose_WithoutCommit_RollsBack` | Implicit rollback on dispose |
| `Transaction_PartialFailure_RollsBackAll` | Constraint violation rolls back all changes |
| `Transaction_Savepoint_AllowsPartialRollback` | Savepoints enable partial rollback |
| `Transaction_ConcurrentReads_SeeCommittedData` | Read committed isolation level |
| `Transaction_BulkInsert_HandlesLargeDataset` | 100 items in single transaction |

---

### Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Integration/PostgreSQL/PostgreSqlTestFixture.cs` | Test fixture with database lifecycle |
| `RuneAndRust.Tests/Integration/PostgreSQL/JsonbQueryTests.cs` | JSONB persistence tests |
| `RuneAndRust.Tests/Integration/PostgreSQL/ConstraintValidationTests.cs` | Constraint enforcement tests |
| `RuneAndRust.Tests/Integration/PostgreSQL/TransactionTests.cs` | Transaction behavior tests |
| `docs/changelogs/v0.3.1e.md` | This changelog |

---

### Key Implementation Details

#### Test Isolation Pattern

Each test creates its own DbContext to prevent state pollution:

```csharp
[Fact]
public async Task SomeTest()
{
    // Arrange - Create context for setup
    using var context = _fixture.CreateContext();

    // ... create entities ...
    await context.SaveChangesAsync();

    // Assert - Fresh context for verification
    using var freshContext = _fixture.CreateContext();
    var loaded = await freshContext.Entities.FindAsync(id);
    loaded.Should().NotBeNull();
}
```

#### JSONB Change Detection

EF Core's value conversion doesn't track in-place dictionary modifications. Tests demonstrate the correct pattern:

```csharp
// WRONG - Changes not detected
room.Exits[Direction.West] = newId;

// CORRECT - Create new dictionary to trigger change detection
var updatedExits = new Dictionary<Direction, Guid>(room.Exits);
updatedExits[Direction.West] = newId;
room.Exits = updatedExits;
```

#### PostgresException SqlState Codes

| Code | Meaning |
|------|---------|
| 23505 | Unique constraint violation |
| 23503 | Foreign key violation |
| 23502 | NOT NULL violation |

---

### Test Execution

#### Prerequisites

1. Docker container running:
   ```bash
   docker-compose up -d
   ```

2. Database initialized:
   ```bash
   dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
   ```

#### Running PostgreSQL Tests Only

```bash
dotnet test RuneAndRust.Tests --filter "Category=PostgreSQL" -v n
```

#### Running All Tests

```bash
dotnet test RuneAndRust.Tests
```

---

### Test Architecture Summary

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1567 | Mocked dependencies |
| Integration Tests (InMemory) | 137 | EF Core InMemory provider |
| Integration Tests (PostgreSQL) | 29 | Real PostgreSQL via Docker |
| **Total** | **1733** | All passing |

---

### Build Verification

```
Build succeeded.
    0 Error(s)

Test Results:
  Passed: 1733
  Failed: 0
  Skipped: 0

PostgreSQL Container:
  Status: Running (healthy)
  Port: 5433
  Test Database: Created/Dropped per test run
```

---

### Directory Structure After v0.3.1e

```
RuneAndRust/
├── RuneAndRust.Tests/
│   └── Integration/
│       └── PostgreSQL/
│           ├── PostgreSqlTestFixture.cs           [NEW]
│           ├── JsonbQueryTests.cs                 [NEW]
│           ├── ConstraintValidationTests.cs       [NEW]
│           └── TransactionTests.cs                [NEW]
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        ├── v0.3.1c.md
        ├── v0.3.1d.md
        └── v0.3.1e.md                             [NEW]
```

---

### Why PostgreSQL-Specific Tests?

The InMemory provider has limitations that PostgreSQL-specific tests address:

| Feature | InMemory | PostgreSQL |
|---------|----------|------------|
| JSONB serialization | Stores in memory | Tests actual JSONB column type |
| Unique constraints | Not enforced | Fully enforced (SqlState 23505) |
| Foreign key constraints | Not enforced | Fully enforced (SqlState 23503) |
| Transactions | Limited support | Full ACID compliance |
| Savepoints | Not supported | Fully supported |
| Concurrent access | Single-threaded | Multi-connection isolation |

---

### Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Npgsql | (transitive) | PostgresException for SqlState checking |
| FluentAssertions | 8.x | Test assertions |
| xUnit | 2.9.x | Test framework |

---

### Next Steps (v0.3.2)

Potential features for the next release:
- Database seeding with starter content
- Save/Load game functionality
- Connection pooling configuration
- Query performance tests with EXPLAIN ANALYZE
