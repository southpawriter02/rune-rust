# v0.7.3 Combat UI Components - Scope Breakdown

**Version:** 0.7.3
**Theme:** Combat Integration
**Prerequisites:** v0.7.2c Complete (Interactive Panels - Command Input)
**Total Estimated Tests:** ~25 new tests

---

## Executive Summary

The Combat Integration sub-version brings tactical combat to the GUI with a visual combat grid panel. This includes entity tokens on a clickable grid, terrain and cover visualization, mouse-based movement and targeting, range highlighting, a combatant list with HP bars, and action buttons. This completes the GUI Foundation by providing full combat functionality.

Key focus areas:
- **Combat Grid**: Visual grid display with entity tokens and terrain
- **Mouse Interaction**: Click-to-move and click-to-attack targeting
- **Combat UI**: Combatant list, action buttons, turn information

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.7.3a | Combat Grid Display | Grid rendering, entity tokens, terrain visualization | ~10 |
| v0.7.3b | Grid Interaction | Click-to-move, click-to-attack, range highlighting | ~8 |
| v0.7.3c | Combat UI Components | Combatant list, action buttons, turn indicator | ~7 |

---

## Existing Infrastructure

### Already Implemented (from v0.7.3)

| Feature | Location | Notes |
|---------|----------|-------|
| InventoryPanel | `Views/InventoryPanel.axaml` | Interactive panel |
| ContextMenuService | `Services/ContextMenuService.cs` | Right-click menus |
| CommandInputPanel | `Views/CommandInputPanel.axaml` | Text input |
| HealthBarControl | `Controls/HealthBarControl.cs` | HP visualization |
| WindowLayoutService | `Services/WindowLayoutService.cs` | Panel regions |

### Already Implemented (from v0.5.x)

| Feature | Location | Notes |
|---------|----------|-------|
| CombatGrid | `Domain/Entities/CombatGrid.cs` | Grid state |
| CombatState | `Domain/Entities/CombatState.cs` | Turn tracking |
| CombatService | `Application/Services/CombatService.cs` | Combat logic |
| GridPosition | `Domain/ValueObjects/GridPosition.cs` | Position data |
| MovementService | `Application/Services/MovementService.cs` | Movement calculation |
| GridRenderer (TUI) | `Presentation/Adapters/GridRenderer.cs` | TUI grid (reference) |

### Needs Implementation (v0.7.3)

| Feature | Part | Notes |
|---------|------|-------|
| CombatGridPanel | v0.7.3a | Grid UserControl |
| GridCellControl | v0.7.3a | Individual cell |
| EntityTokenControl | v0.7.3a | Entity display |
| GridInteractionService | v0.7.3b | Click handling |
| RangeHighlightOverlay | v0.7.3b | Movement/attack range |
| CombatantListPanel | v0.7.2c | Entity list with HP |
| CombatActionBar | v0.7.2c | Action buttons |

---

## Feature Analysis & Categorization

### Grid Display Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Grid cell rendering | High | Canvas/Grid | **v0.7.3a** |
| Entity tokens | Medium | CombatGrid | **v0.7.3a** |
| Terrain visualization | Medium | GridCell type | **v0.7.3a** |
| Coordinate labels | Low | Grid layout | **v0.7.3a** |

### Grid Interaction Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Cell click detection | Medium | Grid cells | **v0.7.3b** |
| Movement targeting | Medium | MovementService | **v0.7.3b** |
| Attack targeting | Medium | CombatService | **v0.7.3b** |
| Range highlighting | High | Overlay rendering | **v0.7.3b** |

### Combat UI Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Combatant list | Medium | CombatState | **v0.7.2c** |
| HP bar display | Low | HealthBarControl | **v0.7.2c** |
| Action buttons | Medium | Commands | **v0.7.2c** |
| Turn indicator | Low | CombatState | **v0.7.2c** |

---

## Part Definitions

---

## v0.7.3a: Combat Grid Display

[v0.7.3a Design Specification](v0.7.3a-design-specification.md)

### Overview

Implement the visual combat grid that displays the tactical battlefield. This includes the grid itself with coordinate labels, entity tokens representing players and monsters, and terrain visualization (floor, walls, water, cover).

### Scope

**In Scope:**
- `CombatGridPanel` UserControl
- `CombatGridPanelViewModel` with grid binding
- `GridCellControl` for individual cells
- `EntityTokenControl` for entities
- Grid coordinate labels (A-H, 1-8)
- Floor cell rendering
- Wall cell rendering
- Water/hazard cell rendering
- Cover object visualization
- Entity token icons (@, M, etc.)
- Entity facing indicator
- Token color by faction
- Grid legend display
- Grid zoom (optional)

**Out of Scope:**
- Click interaction (v0.7.3b)
- Range highlighting (v0.7.3b)
- Combatant list (v0.7.2c)
- Action buttons (v0.7.2c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| User Controls | 3 | `CombatGridPanel`, `GridCellControl`, `EntityTokenControl` |
| ViewModels | 2 | `CombatGridPanelViewModel`, `GridCellViewModel` |
| Renderers | 2 | Cell renderer, token renderer |
| Styles | 1 | `CombatGridStyles.axaml` |
| Unit Tests | ~10 | Grid rendering, token placement tests |

### Combat Grid Panel Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMBAT GRID PANEL                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚       1     2     3     4     5     6     7     8                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                    â”‚
â”‚  A â”‚  â–‘  â”‚  â–‘  â”‚  â–ˆ  â”‚  â–ˆ  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  B â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  C â”‚  â–‘  â”‚  â–‘  â”‚ [S] â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  D â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚ [@] â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  E â”‚  â–‘  â”‚  ~  â”‚  ~  â”‚  ~  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  F â”‚  â–‘  â”‚  â–‘  â”‚  ~  â”‚  â–‘  â”‚  â–‘  â”‚ [G] â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  G â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  H â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                          â”‚
â”‚  Legend:  @ = You   S = Skeleton   G = Goblin                           â”‚
â”‚           â–‘ = Floor   â–ˆ = Wall   ~ = Water                               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GridCellControl

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Represents a single cell in the combat grid.
/// </summary>
public class GridCellControl : TemplatedControl
{
    public static readonly StyledProperty<GridCellType> CellTypeProperty =
        AvaloniaProperty.Register<GridCellControl, GridCellType>(nameof(CellType));
    
    public static readonly StyledProperty<bool> IsHighlightedProperty =
        AvaloniaProperty.Register<GridCellControl, bool>(nameof(IsHighlighted));
    
    public static readonly StyledProperty<HighlightType> HighlightTypeProperty =
        AvaloniaProperty.Register<GridCellControl, HighlightType>(nameof(HighlightType));
    
    public static readonly StyledProperty<bool> HasEntityProperty =
        AvaloniaProperty.Register<GridCellControl, bool>(nameof(HasEntity));
    
    public GridCellType CellType
    {
        get => GetValue(CellTypeProperty);
        set => SetValue(CellTypeProperty, value);
    }
    
    public bool IsHighlighted
    {
        get => GetValue(IsHighlightedProperty);
        set => SetValue(IsHighlightedProperty, value);
    }
    
    public HighlightType HighlightType
    {
        get => GetValue(HighlightTypeProperty);
        set => SetValue(HighlightTypeProperty, value);
    }
    
    public bool HasEntity
    {
        get => GetValue(HasEntityProperty);
        set => SetValue(HasEntityProperty, value);
    }
    
    public IBrush CellBackground => CellType switch
    {
        GridCellType.Floor => Brushes.DimGray,
        GridCellType.Wall => Brushes.DarkSlateGray,
        GridCellType.Water => Brushes.DarkBlue,
        GridCellType.Hazard => Brushes.DarkRed,
        GridCellType.Cover => Brushes.SaddleBrown,
        _ => Brushes.Black
    };
    
    public string CellSymbol => CellType switch
    {
        GridCellType.Floor => "â–‘",
        GridCellType.Wall => "â–ˆ",
        GridCellType.Water => "~",
        GridCellType.Hazard => "â˜¼",
        GridCellType.Cover => "â–“",
        _ => " "
    };
}

public enum GridCellType
{
    Floor,
    Wall,
    Water,
    Hazard,
    Cover
}
```

### EntityTokenControl

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays an entity on the combat grid.
/// </summary>
public class EntityTokenControl : TemplatedControl
{
    public static readonly StyledProperty<Combatant?> EntityProperty =
        AvaloniaProperty.Register<EntityTokenControl, Combatant?>(nameof(Entity));
    
    public static readonly StyledProperty<bool> IsSelectedProperty =
        AvaloniaProperty.Register<EntityTokenControl, bool>(nameof(IsSelected));
    
    public static readonly StyledProperty<bool> IsCurrentTurnProperty =
        AvaloniaProperty.Register<EntityTokenControl, bool>(nameof(IsCurrentTurn));
    
    public Combatant? Entity
    {
        get => GetValue(EntityProperty);
        set => SetValue(EntityProperty, value);
    }
    
    public bool IsSelected
    {
        get => GetValue(IsSelectedProperty);
        set => SetValue(IsSelectedProperty, value);
    }
    
    public bool IsCurrentTurn
    {
        get => GetValue(IsCurrentTurnProperty);
        set => SetValue(IsCurrentTurnProperty, value);
    }
    
    public string TokenSymbol => Entity?.IsPlayer == true ? "@" : Entity?.Name[0].ToString() ?? "?";
    
    public IBrush TokenColor => Entity?.Faction switch
    {
        Faction.Player => Brushes.LimeGreen,
        Faction.Ally => Brushes.Cyan,
        Faction.Enemy => Brushes.OrangeRed,
        Faction.Neutral => Brushes.Yellow,
        _ => Brushes.White
    };
    
    public string Tooltip => Entity is not null 
        ? $"{Entity.Name}\nHP: {Entity.Health}/{Entity.MaxHealth}"
        : "";
}
```

### CombatGridPanelViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class CombatGridPanelViewModel : ViewModelBase
{
    private readonly IGameSessionService _gameSession;
    private readonly ICombatService _combatService;
    
    [ObservableProperty]
    private ObservableCollection<ObservableCollection<GridCellViewModel>> _cells = new();
    
    [ObservableProperty]
    private ObservableCollection<EntityTokenViewModel> _tokens = new();
    
    [ObservableProperty]
    private int _gridWidth = 8;
    
    [ObservableProperty]
    private int _gridHeight = 8;
    
    [ObservableProperty]
    private bool _isInCombat;
    
    public CombatGridPanelViewModel(IGameSessionService gameSession, ICombatService combatService)
    {
        _gameSession = gameSession;
        _combatService = combatService;
        
        _gameSession.OnCombatStateChanged += HandleCombatStateChanged;
        _combatService.OnGridUpdated += RefreshGrid;
    }
    
    private void HandleCombatStateChanged(bool inCombat)
    {
        IsInCombat = inCombat;
        if (inCombat)
        {
            InitializeGrid();
            RefreshGrid();
        }
    }
    
    private void InitializeGrid()
    {
        var grid = _combatService.CurrentGrid;
        GridWidth = grid.Width;
        GridHeight = grid.Height;
        
        Cells.Clear();
        for (int row = 0; row < GridHeight; row++)
        {
            var rowCells = new ObservableCollection<GridCellViewModel>();
            for (int col = 0; col < GridWidth; col++)
            {
                var cell = grid.GetCell(col, row);
                rowCells.Add(new GridCellViewModel(new GridPosition(col, row), cell));
            }
            Cells.Add(rowCells);
        }
    }
    
    private void RefreshGrid()
    {
        // Update entity tokens
        Tokens.Clear();
        foreach (var combatant in _combatService.AllCombatants)
        {
            Tokens.Add(new EntityTokenViewModel(combatant));
        }
    }
}
```

### Acceptance Criteria

- [ ] Combat grid displays when combat starts
- [ ] Grid shows 8x8 cells (configurable)
- [ ] Coordinate labels display (A-H, 1-8)
- [ ] Floor cells render correctly
- [ ] Wall cells render as blocked
- [ ] Water cells render distinctly
- [ ] Entity tokens display on grid
- [ ] Player token shows @
- [ ] Monster tokens show first letter
- [ ] Token colors indicate faction
- [ ] Legend explains symbols
- [ ] Grid hides when combat ends
- [ ] ~10 unit tests pass

---

## v0.7.3b: Grid Interaction

[v0.7.3b Design Specification](v0.7.3b-design-specification.md)

### Overview

Implement click-based interaction with the combat grid for movement and targeting. This includes detecting cell clicks, highlighting valid movement/attack ranges, and executing move/attack actions based on clicks.

### Scope

**In Scope:**
- `IGridInteractionService` interface
- `GridInteractionService` implementation
- Cell click detection
- Movement mode activation
- Movement range highlighting (blue)
- Click-to-move execution
- Attack mode activation
- Attack range highlighting (red)
- Click-to-attack execution
- Ability targeting mode
- Ability AoE preview (purple)
- Target selection feedback
- Action cancellation (right-click/Escape)
- Hover tooltip

**Out of Scope:**
- Grid display (v0.7.3a)
- Combatant list (v0.7.2c)
- Action buttons (v0.7.2c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Interfaces | 1 | `IGridInteractionService` |
| Services | 1 | `GridInteractionService` |
| Overlays | 1 | Range highlight overlay |
| Event Handlers | 3 | Click, hover, cancel |
| Unit Tests | ~8 | Interaction, range tests |

### Grid Interaction Modes

```
MOVEMENT MODE (After clicking "Move" button):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       1     2     3     4     5     6     7     8                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                    â”‚
â”‚  A â”‚  â–‘  â”‚  â–‘  â”‚  â–ˆ  â”‚  â–ˆ  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  B â”‚  â–‘  â”‚  â–‘  â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–“ = Reachable    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤      (4 move)      â”‚
â”‚  C â”‚  â–‘  â”‚ â–“â–“â–“ â”‚ [S] â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  D â”‚  â–‘  â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ [@] â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  E â”‚  â–‘  â”‚  ~  â”‚  ~  â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  F â”‚  â–‘  â”‚  â–‘  â”‚  ~  â”‚  â–‘  â”‚ â–“â–“â–“ â”‚ [G] â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  G â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                          â”‚
â”‚  [Click a blue cell to move there]              [Right-click to cancel]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ATTACK MODE (After clicking "Attack" button):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       1     2     3     4     5     6     7     8                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                    â”‚
â”‚  A â”‚  â–‘  â”‚  â–‘  â”‚  â–ˆ  â”‚  â–ˆ  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  B â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  C â”‚  â–‘  â”‚  â–‘  â”‚ [S] â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  Skeleton in range â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤   (melee: 1 cell)  â”‚
â”‚  D â”‚  â–‘  â”‚  â–‘  â”‚ â–ˆâ–ˆâ–ˆ â”‚ â–ˆâ–ˆâ–ˆ â”‚ [@] â”‚ â–ˆâ–ˆâ–ˆ â”‚  â–‘  â”‚  â–‘  â”‚  â–ˆ = Attack range  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  E â”‚  â–‘  â”‚  ~  â”‚  ~  â”‚ â–ˆâ–ˆâ–ˆ â”‚ â–ˆâ–ˆâ–ˆ â”‚ â–ˆâ–ˆâ–ˆ â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  F â”‚  â–‘  â”‚  â–‘  â”‚  ~  â”‚  â–‘  â”‚  â–‘  â”‚ [G] â”‚  â–‘  â”‚  â–‘  â”‚  Goblin out of     â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤   range            â”‚
â”‚  G â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                          â”‚
â”‚  [Click an enemy in red to attack]              [Right-click to cancel]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ABILITY AoE PREVIEW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       1     2     3     4     5     6     7     8                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                    â”‚
â”‚  A â”‚  â–‘  â”‚  â–‘  â”‚  â–ˆ  â”‚  â–ˆ  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  B â”‚  â–‘  â”‚ â—Šâ—Šâ—Š â”‚ â—Šâ—Šâ—Š â”‚ â—Šâ—Šâ—Š â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â—Š = AoE effect   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤      area          â”‚
â”‚  C â”‚  â–‘  â”‚ â—Šâ—Šâ—Š â”‚ [S] â”‚ â—Šâ—Šâ—Š â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  Fireball 3x3     â”‚
â”‚  D â”‚  â–‘  â”‚ â—Šâ—Šâ—Š â”‚ â—Šâ—Šâ—Š â”‚ â—Šâ—Šâ—Š â”‚ [@] â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                          â”‚
â”‚  [Click to confirm Fireball at C3]              [Right-click to cancel]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### IGridInteractionService Interface

```csharp
namespace RuneAndRust.Avalonia.Services;

/// <summary>
/// Handles grid interaction for combat.
/// </summary>
public interface IGridInteractionService
{
    /// <summary>Gets the current interaction mode.</summary>
    GridInteractionMode CurrentMode { get; }
    
    /// <summary>Enters movement targeting mode.</summary>
    void EnterMovementMode(Combatant mover);
    
    /// <summary>Enters attack targeting mode.</summary>
    void EnterAttackMode(Combatant attacker, int range);
    
    /// <summary>Enters ability targeting mode.</summary>
    void EnterAbilityMode(Combatant caster, AbilityDefinition ability);
    
    /// <summary>Cancels current targeting mode.</summary>
    void CancelTargeting();
    
    /// <summary>Handles cell click.</summary>
    void HandleCellClick(GridPosition position);
    
    /// <summary>Handles cell hover.</summary>
    void HandleCellHover(GridPosition position);
    
    /// <summary>Gets highlighted cells for current mode.</summary>
    IReadOnlyList<HighlightedCell> GetHighlightedCells();
    
    /// <summary>Event when targeting completes.</summary>
    event Action<TargetingResult>? OnTargetingComplete;
    
    /// <summary>Event when highlights change.</summary>
    event Action? OnHighlightsChanged;
}

public enum GridInteractionMode
{
    None,
    Movement,
    Attack,
    Ability
}

public record HighlightedCell(GridPosition Position, HighlightType Type);
public record TargetingResult(GridInteractionMode Mode, GridPosition Target, bool Success);
```

### GridInteractionService Implementation

```csharp
namespace RuneAndRust.Avalonia.Services;

public class GridInteractionService : IGridInteractionService
{
    private readonly ICombatService _combatService;
    private readonly IMovementService _movementService;
    private readonly ILogger<GridInteractionService> _logger;
    
    private GridInteractionMode _currentMode = GridInteractionMode.None;
    private Combatant? _activeEntity;
    private AbilityDefinition? _activeAbility;
    private HashSet<GridPosition> _validTargets = new();
    
    public GridInteractionMode CurrentMode => _currentMode;
    
    public event Action<TargetingResult>? OnTargetingComplete;
    public event Action? OnHighlightsChanged;
    
    public void EnterMovementMode(Combatant mover)
    {
        _currentMode = GridInteractionMode.Movement;
        _activeEntity = mover;
        
        // Calculate valid movement positions
        _validTargets = _movementService
            .GetReachablePositions(mover.Position, mover.RemainingMovement)
            .ToHashSet();
        
        OnHighlightsChanged?.Invoke();
        _logger.LogDebug("Entered movement mode for {Entity}", mover.Name);
    }
    
    public void EnterAttackMode(Combatant attacker, int range)
    {
        _currentMode = GridInteractionMode.Attack;
        _activeEntity = attacker;
        
        // Calculate valid attack positions (cells with enemies in range)
        _validTargets = _combatService
            .GetEnemiesInRange(attacker, range)
            .Select(e => e.Position)
            .ToHashSet();
        
        OnHighlightsChanged?.Invoke();
        _logger.LogDebug("Entered attack mode for {Entity}, range {Range}", attacker.Name, range);
    }
    
    public void HandleCellClick(GridPosition position)
    {
        if (_currentMode == GridInteractionMode.None)
            return;
        
        if (!_validTargets.Contains(position))
        {
            _logger.LogDebug("Invalid target position: {Position}", position);
            return;
        }
        
        var result = new TargetingResult(_currentMode, position, true);
        
        // Execute action based on mode
        switch (_currentMode)
        {
            case GridInteractionMode.Movement:
                _combatService.MoveEntity(_activeEntity!, position);
                break;
            case GridInteractionMode.Attack:
                var target = _combatService.GetEntityAt(position);
                if (target is not null)
                    _combatService.Attack(_activeEntity!, target);
                break;
            case GridInteractionMode.Ability:
                _combatService.UseAbility(_activeEntity!, _activeAbility!, position);
                break;
        }
        
        CancelTargeting();
        OnTargetingComplete?.Invoke(result);
    }
    
    public void CancelTargeting()
    {
        _currentMode = GridInteractionMode.None;
        _activeEntity = null;
        _activeAbility = null;
        _validTargets.Clear();
        OnHighlightsChanged?.Invoke();
    }
    
    public IReadOnlyList<HighlightedCell> GetHighlightedCells()
    {
        var highlightType = _currentMode switch
        {
            GridInteractionMode.Movement => HighlightType.Movement,
            GridInteractionMode.Attack => HighlightType.Attack,
            GridInteractionMode.Ability => HighlightType.Ability,
            _ => HighlightType.None
        };
        
        return _validTargets
            .Select(p => new HighlightedCell(p, highlightType))
            .ToList();
    }
}
```

### Acceptance Criteria

- [ ] Click on cell detected correctly
- [ ] Movement mode highlights reachable cells
- [ ] Click on valid cell moves entity
- [ ] Attack mode highlights enemies in range
- [ ] Click on enemy executes attack
- [ ] Ability mode shows AoE preview
- [ ] Right-click cancels targeting
- [ ] Escape key cancels targeting
- [ ] Hover shows cell/entity tooltip
- [ ] Invalid targets show feedback
- [ ] ~8 unit tests pass

---

## v0.7.2c: Combat UI Components

[v0.7.2c Design Specification](v0.7.2c-design-specification.md)

### Overview

Implement the combat UI components that accompany the grid: a combatant list showing all entities with HP bars, an action bar with combat buttons, and a turn indicator showing whose turn it is.

### Scope

**In Scope:**
- `CombatantListPanel` UserControl
- `CombatantListViewModel` with entity binding
- Combatant entries with HP bars
- Turn order indicator (â–º)
- Status effect icons
- `CombatActionBar` UserControl
- Action buttons (Attack, Move, Ability, Defend, Item, Wait, End Turn)
- Button enable/disable based on state
- Action point display
- Turn info display (Round X, Your Turn)

**Out of Scope:**
- Grid display (v0.7.3a)
- Grid interaction (v0.7.3b)
- Advanced ability selection (v0.8.0)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| User Controls | 2 | `CombatantListPanel`, `CombatActionBar` |
| ViewModels | 2 | `CombatantListViewModel`, `CombatActionBarViewModel` |
| Commands | 7 | Attack, Move, Ability, Defend, Item, Wait, EndTurn |
| Styles | 1 | `CombatUIStyles.axaml` |
| Unit Tests | ~7 | List, button state tests |

### Combat UI Layout

```
COMBATANT LIST (Right sidebar):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          COMBATANTS                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚  â–º Hero                               â”‚  â—„â”€â”€ Current turn
â”‚    HP: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  65/100       â”‚
â”‚    Status: [âš” Defensive] [ğŸ›¡ +2 AC]  â”‚
â”‚                                       â”‚
â”‚    Skeleton                           â”‚
â”‚    HP: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  15/45        â”‚
â”‚    Status: [ğŸ©¸ Bleeding]              â”‚
â”‚                                       â”‚
â”‚    Goblin                             â”‚
â”‚    HP: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  25/25        â”‚
â”‚    Status: (none)                     â”‚
â”‚                                       â”‚
â”‚    Goblin Archer                      â”‚
â”‚    HP: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  12/20        â”‚
â”‚    Status: (none)                     â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


COMBAT ACTION BAR (Bottom):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Round 3  â”‚  YOUR TURN  â”‚  Action: âœ“  â”‚  Bonus: âœ“  â”‚  Move: 4/4        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  âš”     â”‚ â”‚  ğŸƒ    â”‚ â”‚  âœ¨    â”‚ â”‚  ğŸ›¡    â”‚ â”‚  ğŸ’    â”‚ â”‚  â³    â”‚â”‚
â”‚  â”‚ Attack  â”‚ â”‚  Move   â”‚ â”‚ Ability â”‚ â”‚ Defend  â”‚ â”‚  Item   â”‚ â”‚  Wait   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         [End Turn]                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CombatantListViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class CombatantListViewModel : ViewModelBase
{
    private readonly ICombatService _combatService;
    
    [ObservableProperty]
    private ObservableCollection<CombatantEntryViewModel> _combatants = new();
    
    [ObservableProperty]
    private Guid _currentTurnEntityId;
    
    public CombatantListViewModel(ICombatService combatService)
    {
        _combatService = combatService;
        _combatService.OnCombatantsChanged += RefreshCombatants;
        _combatService.OnTurnChanged += HandleTurnChanged;
    }
    
    private void RefreshCombatants()
    {
        Combatants.Clear();
        foreach (var combatant in _combatService.AllCombatants.OrderBy(c => c.Initiative))
        {
            Combatants.Add(new CombatantEntryViewModel(combatant, combatant.Id == CurrentTurnEntityId));
        }
    }
    
    private void HandleTurnChanged(Combatant current)
    {
        CurrentTurnEntityId = current.Id;
        foreach (var entry in Combatants)
        {
            entry.IsCurrentTurn = entry.EntityId == CurrentTurnEntityId;
        }
    }
}

public partial class CombatantEntryViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _name;
    
    [ObservableProperty]
    private int _currentHp;
    
    [ObservableProperty]
    private int _maxHp;
    
    [ObservableProperty]
    private bool _isCurrentTurn;
    
    [ObservableProperty]
    private ObservableCollection<StatusEffectViewModel> _statusEffects = new();
    
    public Guid EntityId { get; }
    public bool IsPlayer { get; }
    public string TurnIndicator => IsCurrentTurn ? "â–º" : " ";
}
```

### CombatActionBarViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class CombatActionBarViewModel : ViewModelBase
{
    private readonly ICombatService _combatService;
    private readonly IGridInteractionService _gridInteraction;
    
    [ObservableProperty]
    private int _currentRound;
    
    [ObservableProperty]
    private bool _isPlayerTurn;
    
    [ObservableProperty]
    private bool _hasAction = true;
    
    [ObservableProperty]
    private bool _hasBonus = true;
    
    [ObservableProperty]
    private int _remainingMovement;
    
    [ObservableProperty]
    private int _maxMovement;
    
    [ObservableProperty]
    private bool _canAttack = true;
    
    [ObservableProperty]
    private bool _canMove = true;
    
    [ObservableProperty]
    private bool _canUseAbility = true;
    
    public CombatActionBarViewModel(ICombatService combatService, IGridInteractionService gridInteraction)
    {
        _combatService = combatService;
        _gridInteraction = gridInteraction;
        _combatService.OnTurnChanged += HandleTurnChanged;
    }
    
    [RelayCommand(CanExecute = nameof(CanAttack))]
    private void Attack()
    {
        var player = _combatService.GetPlayerCombatant();
        _gridInteraction.EnterAttackMode(player, player.AttackRange);
    }
    
    [RelayCommand(CanExecute = nameof(CanMove))]
    private void Move()
    {
        var player = _combatService.GetPlayerCombatant();
        _gridInteraction.EnterMovementMode(player);
    }
    
    [RelayCommand(CanExecute = nameof(CanUseAbility))]
    private void Ability()
    {
        // Open ability selection
    }
    
    [RelayCommand]
    private void Defend()
    {
        _combatService.ExecuteDefend(_combatService.GetPlayerCombatant());
        HasAction = false;
    }
    
    [RelayCommand]
    private void UseItem()
    {
        // Open item selection for consumables
    }
    
    [RelayCommand]
    private void Wait()
    {
        _combatService.ExecuteWait(_combatService.GetPlayerCombatant());
    }
    
    [RelayCommand]
    private void EndTurn()
    {
        _combatService.EndPlayerTurn();
    }
    
    private void HandleTurnChanged(Combatant current)
    {
        IsPlayerTurn = current.IsPlayer;
        CurrentRound = _combatService.CurrentRound;
        HasAction = true;
        HasBonus = true;
        RemainingMovement = current.RemainingMovement;
        MaxMovement = current.MaxMovement;
        UpdateButtonStates();
    }
}
```

### Acceptance Criteria

- [ ] Combatant list shows all entities
- [ ] HP bars display for each combatant
- [ ] Current turn indicator (â–º) shows
- [ ] Status effects display as icons
- [ ] Action bar shows during combat
- [ ] Turn info displays (Round, Turn)
- [ ] Action/bonus/move points display
- [ ] Attack button enters attack mode
- [ ] Move button enters movement mode
- [ ] Buttons disable when unavailable
- [ ] End Turn advances to next turn
- [ ] ~7 unit tests pass

---

## Dependencies & Prerequisites

```
v0.7.2c (Command Input Panel) - REQUIRED
    â”‚
    â””â”€â”€ Interactive panels, core UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                          â”‚
v0.7.3 (Combat Integration)                                               â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.7.3a: Combat Grid Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: CombatGrid, WindowLayoutService                 â”‚
    â”‚       Provides: CombatGridPanel, GridCellControl, EntityTokenControlâ”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.7.3b: Grid Interaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: v0.7.3a (grid), CombatService, MovementService  â”‚
    â”‚       Provides: IGridInteractionService, range highlighting         â”‚
    â”‚                                                                     â”‚
    â””â”€â”€ v0.7.2c: Combat UI Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Dependencies: v0.7.3a, v0.7.3b, HealthBarControl
            Provides: CombatantListPanel, CombatActionBar
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.7.3a | ~6 | ~2 | ~10 | High |
| v0.7.3b | ~3 | ~2 | ~8 | High |
| v0.7.2c | ~4 | ~1 | ~7 | Medium |
| **Total** | **~13** | **~5** | **~25** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Grid rendering performance | High | Medium | Use virtualization, optimize redraws |
| Click detection accuracy | Medium | Low | Use proper hit testing |
| Highlight overlay complexity | Medium | Medium | Simple overlay approach |
| State synchronization | Medium | Low | Single source of truth (CombatService) |

---

## Design Decisions (Confirmed)

### Grid Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Grid Size** | 8x8 (configurable) | Matches domain |
| **Cell Size** | 40x40 pixels | Readable tokens |
| **Rendering** | ItemsControl + Canvas | Flexible positioning |

### Grid Interaction

| Decision | Value | Notes |
|----------|-------|-------|
| **Highlight Colors** | Blue/Red/Purple | Movement/Attack/Ability |
| **Cancel Trigger** | Right-click + Escape | Standard patterns |
| **Click Feedback** | Visual + sound | Clear confirmation |

### Combat UI

| Decision | Value | Notes |
|----------|-------|-------|
| **Turn Indicator** | â–º symbol | Clear visual |
| **Action Buttons** | Icon + text | Accessible |
| **Button Disable** | Gray out + tooltip | Explain why |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.7.3a Design Spec** - Create detailed design for Combat Grid Display
3. **v0.7.3a Implementation** - Build grid and token controls
4. **v0.7.3b Design Spec** - Create specification for Grid Interaction
5. **v0.7.3b Implementation** - Build interaction service and highlighting
6. **v0.7.2c Design Spec** - Create specification for Combat UI Components
7. **v0.7.2c Implementation** - Build combatant list and action bar

---

*This scope breakdown completes the v0.7.0 GUI Foundation series. The combat integration brings tactical combat to the GUI, providing a visually rich and interactive combat experience. v0.7.3 completion marks the transition to v0.8.0 GUI Polish & Features.*
