# v0.17.4c Design Specification: Ability Tier Structures

**Version:** 0.17.4c
**Theme:** Specialization Ability Tiers & Ability Definitions
**Author:** Claude
**Created:** 2026-01-27
**Status:** Draft
**Prerequisites:** v0.17.4b Complete (Specialization Definitions)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SpecializationAbility Value Object](#4-specializationability-value-object)
5. [SpecializationAbilityTier Value Object](#5-specializationabilitytier-value-object)
6. [SpecializationDefinition Enhancement](#6-specializationdefinition-enhancement)
7. [Configuration](#7-configuration)
8. [Commands](#8-commands)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Future Considerations](#15-future-considerations)
16. [Implementation Notes](#16-implementation-notes)
17. [Document Metadata](#17-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.17.4c, the Ability Tier Structures phase. This phase defines the tiered ability progression system that gives each specialization its unique mechanical identity.

Key components:

1. **SpecializationAbility Value Object**: Represents an individual ability within a specialization tier, containing all mechanical properties (cost, cooldown, passive/active, effects).

2. **SpecializationAbilityTier Value Object**: Groups abilities by tier (1, 2, 3), defining unlock costs and prerequisites for each tier of power.

3. **SpecializationDefinition Enhancement**: Adds the `AbilityTiers` collection to the existing entity from v0.17.4b.

This infrastructure enables the full specialization ability system, building on the foundation from v0.17.4a-b and enabling provider services in v0.17.4d.

### 1.2 Current vs. Target Implementation

| Aspect                   | Current Implementation | Target Implementation                  |
| ------------------------ | ---------------------- | -------------------------------------- |
| **Ability Organization** | Flat list (if any)     | Three-tier hierarchical structure      |
| **Tier Progression**     | Not implemented        | Sequential unlock with PP costs        |
| **Ability Mechanics**    | Basic ability system   | Specialization-specific abilities      |
| **Passive Abilities**    | Not differentiated     | Explicit `IsPassive` flag              |
| **Resource Costs**       | Generic                | References SpecialResource or standard |

### 1.3 Scope

**In Scope:**

- Define `SpecializationAbility` value object with mechanical properties
- Define `SpecializationAbilityTier` value object with tier grouping
- Enhance `SpecializationDefinition` with `AbilityTiers` collection
- Configuration file structure for ability tiers
- Unit tests for ability and tier structures (~3 tests)

**Out of Scope:**

- Provider service - v0.17.4d
- Application service - v0.17.4e
- Actual ability effect implementation - Combat system integration

### 1.4 Key Deliverables

| Type               | Count | Details                                              |
| ------------------ | ----- | ---------------------------------------------------- |
| Value Objects      | 2     | `SpecializationAbility`, `SpecializationAbilityTier` |
| Entity Enhancement | 1     | `AbilityTiers` on `SpecializationDefinition`         |
| Configuration      | 1     | Enhanced `specializations.json` with ability tiers   |
| Unit Tests         | ~3    | Ability creation, tier validation, tier hierarchy    |

---

## 2. Dependencies

### 2.1 Required from v0.17.4b

| Component                   | Location                                           | Usage in v0.17.4c               |
| --------------------------- | -------------------------------------------------- | ------------------------------- |
| `SpecializationDefinition`  | `Domain/Entities/SpecializationDefinition.cs`      | Enhanced with AbilityTiers      |
| `SpecialResourceDefinition` | `Domain/ValueObjects/SpecialResourceDefinition.cs` | Ability resource cost reference |

### 2.2 Required from v0.17.4a

| Component          | Location                           | Usage in v0.17.4c                 |
| ------------------ | ---------------------------------- | --------------------------------- |
| `SpecializationId` | `Domain/Enums/SpecializationId.cs` | Links abilities to specialization |

### 2.3 Required from Existing Systems

| Component           | Location                               | Usage in v0.17.4c                       |
| ------------------- | -------------------------------------- | --------------------------------------- |
| `AbilityDefinition` | `Domain/Entities/AbilityDefinition.cs` | Reference for ability ID matching       |
| `ResourceType`      | `Domain/Enums/ResourceType.cs`         | Standard resource costs (Stamina, etc.) |

### 2.4 Provides to Future Versions

| Version  | Component               | Usage                                   |
| -------- | ----------------------- | --------------------------------------- |
| v0.17.4d | `AbilityTiers`          | Provider returns tiers with definitions |
| v0.17.4e | `SpecializationAbility` | Application service grants abilities    |
| v0.17.5  | All                     | Character creation ability preview      |
| Combat   | `SpecializationAbility` | Combat ability execution                |

---

## 3. Architecture Diagrams

### 3.1 Tier Hierarchy Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TIER HIERARCHY STRUCTURE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SpecializationDefinition                                                   │
│  ├── SpecializationId: Berserkr                                             │
│  ├── DisplayName: "Berserkr"                                                │
│  ├── SpecialResource: Rage (0-100)                                          │
│  │                                                                           │
│  └── AbilityTiers: IReadOnlyList<SpecializationAbilityTier>                 │
│      │                                                                       │
│      ├── TIER 1 (Unlocked at selection, cost: 0 PP)                         │
│      │   ├── Rage Strike [Active] - Cost: 20 Rage                           │
│      │   ├── Blood Frenzy [Passive] - +10% damage when below 50% HP         │
│      │   └── Intimidating Presence [Active] - Fear nearby enemies           │
│      │                                                                       │
│      ├── TIER 2 (Unlocked at Rank 2, cost: 2 PP, requires Tier 1)           │
│      │   ├── Berserker Charge [Active] - Rush and stun                      │
│      │   ├── Pain is Power [Passive] - Damage taken → Rage                  │
│      │   └── Reckless Swing [Active] - High damage, lowers defense          │
│      │                                                                       │
│      └── TIER 3 (Unlocked at Rank 3, cost: 3 PP, requires Tier 2)           │
│          ├── Unstoppable Fury [Active] - Immune to CC during rage           │
│          ├── Death's Door Defiance [Passive] - Survive fatal blow once      │
│          └── Cataclysmic Roar [Active] - AoE damage + terror                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Tier Unlock Decision Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TIER UNLOCK DECISION FLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  PLAYER REQUESTS TIER UNLOCK                                                │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              CHECK PREREQUISITES                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│      ┌───────────────────────────────────────────────────────┐              │
│      │      REQUIRES PREVIOUS TIER?                          │              │
│      └───────────────────────────────────────────────────────┘              │
│           │                          │                                       │
│     [YES] │                          │ [NO - Tier 1]                         │
│           ▼                          ▼                                       │
│  ┌──────────────────────┐   ┌──────────────────────┐                        │
│  │  Previous tier       │   │  Skip prerequisite   │                        │
│  │  unlocked?           │   │  check               │                        │
│  └──────────────────────┘   └──────────────────────┘                        │
│     │ [NO]     │ [YES]              │                                        │
│     ▼          ▼                    ▼                                        │
│  ┌────────┐  ┌─────────────────────────────────────────────────────────┐    │
│  │ DENY   │  │              CHECK PP COST                               │    │
│  │ UNLOCK │  └─────────────────────────────────────────────────────────┘    │
│  └────────┘           │                                                      │
│                       ▼                                                      │
│      ┌───────────────────────────────────────────────────────┐              │
│      │      PLAYER HAS SUFFICIENT PP?                        │              │
│      └───────────────────────────────────────────────────────┘              │
│           │                          │                                       │
│     [NO]  │                          │ [YES]                                 │
│           ▼                          ▼                                       │
│  ┌──────────────────────┐   ┌──────────────────────┐                        │
│  │  DENY UNLOCK         │   │  APPROVE UNLOCK      │                        │
│  │  "Insufficient PP"   │   │  - Deduct PP         │                        │
│  └──────────────────────┘   │  - Grant abilities   │                        │
│                              │  - Mark tier unlocked│                        │
│                              └──────────────────────┘                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Value Object Relationships

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VALUE OBJECT RELATIONSHIPS                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    SpecializationDefinition                           │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  + AbilityTiers: IReadOnlyList<SpecializationAbilityTier>            │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                          │                                                   │
│                          │ 1..*                                              │
│                          ▼                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    SpecializationAbilityTier                          │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  + Tier: int                         (1, 2, or 3)                    │   │
│  │  + DisplayName: string               ("Core Techniques")             │   │
│  │  + UnlockCost: int                   (PP required)                   │   │
│  │  + RequiresPreviousTier: bool        (true for Tier 2+)              │   │
│  │  + RequiredRank: int                 (progression rank required)     │   │
│  │  + Abilities: IReadOnlyList<SpecializationAbility>                   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                          │                                                   │
│                          │ 1..*                                              │
│                          ▼                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    SpecializationAbility                              │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │  + AbilityId: string                 ("rage-strike")                 │   │
│  │  + DisplayName: string               ("Rage Strike")                 │   │
│  │  + Description: string               (ability effect description)    │   │
│  │  + IsPassive: bool                   (passive vs active)             │   │
│  │  + ResourceCost: int                 (amount required)               │   │
│  │  + ResourceType: string              ("rage", "stamina", etc.)       │   │
│  │  + Cooldown: int                     (turns between uses)            │   │
│  │  + CorruptionRisk: int               (0 for Coherent paths)          │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. SpecializationAbility Value Object

### 4.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationAbility.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an individual ability within a specialization tier.
/// </summary>
/// <remarks>
/// <para>
/// SpecializationAbility defines the mechanical properties of abilities unique
/// to a specialization. These abilities are organized into tiers (1, 2, 3) and
/// unlocked via Progression Points.
/// </para>
/// <para>
/// Abilities can be:
/// <list type="bullet">
/// <item><description>Active: Requires manual activation, may have cooldown</description></item>
/// <item><description>Passive: Always in effect once unlocked</description></item>
/// </list>
/// </para>
/// <para>
/// Heretical path abilities may have Corruption risk on use or fumble.
/// </para>
/// </remarks>
public readonly record struct SpecializationAbility
{
    /// <summary>
    /// Gets the unique identifier for this ability.
    /// </summary>
    /// <remarks>
    /// Uses kebab-case format (e.g., "rage-strike", "blood-frenzy").
    /// Must be unique within the specialization.
    /// </remarks>
    public string AbilityId { get; init; }

    /// <summary>
    /// Gets the display name shown in UI.
    /// </summary>
    /// <example>"Rage Strike", "Blood Frenzy", "Intimidating Presence"</example>
    public string DisplayName { get; init; }

    /// <summary>
    /// Gets the description of the ability's effect.
    /// </summary>
    public string Description { get; init; }

    /// <summary>
    /// Gets whether this is a passive ability.
    /// </summary>
    /// <remarks>
    /// Passive abilities are always in effect once the tier is unlocked.
    /// Active abilities require manual activation.
    /// </remarks>
    public bool IsPassive { get; init; }

    /// <summary>
    /// Gets the resource cost to use this ability.
    /// </summary>
    /// <remarks>
    /// 0 for abilities with no resource cost or passive abilities.
    /// </remarks>
    public int ResourceCost { get; init; }

    /// <summary>
    /// Gets the resource type consumed by this ability.
    /// </summary>
    /// <remarks>
    /// Can be:
    /// <list type="bullet">
    /// <item><description>Special resource ID (e.g., "rage", "block-charges")</description></item>
    /// <item><description>Standard resource (e.g., "stamina", "health")</description></item>
    /// <item><description>Empty string for no-cost abilities</description></item>
    /// </list>
    /// </remarks>
    public string ResourceType { get; init; }

    /// <summary>
    /// Gets the cooldown in turns between uses.
    /// </summary>
    /// <remarks>
    /// 0 for abilities with no cooldown. Passive abilities should have 0 cooldown.
    /// </remarks>
    public int Cooldown { get; init; }

    /// <summary>
    /// Gets the Corruption risk when using this ability.
    /// </summary>
    /// <remarks>
    /// <para>0 for Coherent path abilities or abilities with no Corruption risk.</para>
    /// <para>Positive values indicate chance or amount of Corruption gain.</para>
    /// <para>Heretical path abilities may trigger Corruption on use or fumble.</para>
    /// </remarks>
    public int CorruptionRisk { get; init; }

    /// <summary>
    /// Gets whether this ability has a resource cost.
    /// </summary>
    public bool HasResourceCost => ResourceCost > 0 && !string.IsNullOrEmpty(ResourceType);

    /// <summary>
    /// Gets whether this ability has a cooldown.
    /// </summary>
    public bool HasCooldown => Cooldown > 0;

    /// <summary>
    /// Gets whether this ability risks Corruption.
    /// </summary>
    public bool RisksCorruption => CorruptionRisk > 0;

    /// <summary>
    /// Creates a new specialization ability with validation.
    /// </summary>
    /// <param name="abilityId">Unique identifier (kebab-case).</param>
    /// <param name="displayName">UI display name.</param>
    /// <param name="description">Effect description.</param>
    /// <param name="isPassive">True for passive abilities.</param>
    /// <param name="resourceCost">Resource amount required (0 for no cost).</param>
    /// <param name="resourceType">Resource type ID (empty for no cost).</param>
    /// <param name="cooldown">Turns between uses (0 for no cooldown).</param>
    /// <param name="corruptionRisk">Corruption risk amount (0 for none).</param>
    /// <returns>A validated <see cref="SpecializationAbility"/>.</returns>
    /// <exception cref="ArgumentException">Thrown when validation fails.</exception>
    public static SpecializationAbility Create(
        string abilityId,
        string displayName,
        string description,
        bool isPassive,
        int resourceCost = 0,
        string resourceType = "",
        int cooldown = 0,
        int corruptionRisk = 0)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(abilityId);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);
        ArgumentException.ThrowIfNullOrWhiteSpace(description);
        ArgumentOutOfRangeException.ThrowIfNegative(resourceCost);
        ArgumentOutOfRangeException.ThrowIfNegative(cooldown);
        ArgumentOutOfRangeException.ThrowIfNegative(corruptionRisk);

        // Passive abilities should not have cooldown
        if (isPassive && cooldown > 0)
        {
            throw new ArgumentException(
                "Passive abilities cannot have a cooldown",
                nameof(cooldown));
        }

        return new SpecializationAbility
        {
            AbilityId = abilityId.ToLowerInvariant(),
            DisplayName = displayName,
            Description = description,
            IsPassive = isPassive,
            ResourceCost = resourceCost,
            ResourceType = resourceType?.ToLowerInvariant() ?? string.Empty,
            Cooldown = cooldown,
            CorruptionRisk = corruptionRisk
        };
    }

    /// <summary>
    /// Creates an active ability with standard parameters.
    /// </summary>
    public static SpecializationAbility CreateActive(
        string abilityId,
        string displayName,
        string description,
        int resourceCost,
        string resourceType,
        int cooldown = 0,
        int corruptionRisk = 0)
    {
        return Create(
            abilityId,
            displayName,
            description,
            isPassive: false,
            resourceCost,
            resourceType,
            cooldown,
            corruptionRisk);
    }

    /// <summary>
    /// Creates a passive ability.
    /// </summary>
    public static SpecializationAbility CreatePassive(
        string abilityId,
        string displayName,
        string description,
        int corruptionRisk = 0)
    {
        return Create(
            abilityId,
            displayName,
            description,
            isPassive: true,
            resourceCost: 0,
            resourceType: string.Empty,
            cooldown: 0,
            corruptionRisk);
    }

    /// <inheritdoc />
    public override string ToString()
    {
        var type = IsPassive ? "Passive" : "Active";
        var cost = HasResourceCost ? $", {ResourceCost} {ResourceType}" : "";
        var cd = HasCooldown ? $", CD: {Cooldown}" : "";
        return $"{DisplayName} [{type}{cost}{cd}]";
    }
}
```

---

## 5. SpecializationAbilityTier Value Object

### 5.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationAbilityTier.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a tier of abilities within a specialization.
/// </summary>
/// <remarks>
/// <para>
/// Each specialization has three tiers of abilities:
/// <list type="bullet">
/// <item><description>Tier 1: Unlocked when specialization is selected (0 PP)</description></item>
/// <item><description>Tier 2: Unlocked at Rank 2 (2 PP, requires Tier 1)</description></item>
/// <item><description>Tier 3: Unlocked at Rank 3 (3 PP, requires Tier 2)</description></item>
/// </list>
/// </para>
/// <para>
/// Each tier contains 2-4 abilities (mix of active and passive).
/// </para>
/// </remarks>
public readonly record struct SpecializationAbilityTier
{
    /// <summary>
    /// Gets the tier number (1, 2, or 3).
    /// </summary>
    public int Tier { get; init; }

    /// <summary>
    /// Gets the display name for this tier.
    /// </summary>
    /// <example>"Core Techniques", "Advanced Mastery", "Ultimate Power"</example>
    public string DisplayName { get; init; }

    /// <summary>
    /// Gets the Progression Point cost to unlock this tier.
    /// </summary>
    /// <remarks>
    /// Standard costs: Tier 1 = 0, Tier 2 = 2, Tier 3 = 3
    /// </remarks>
    public int UnlockCost { get; init; }

    /// <summary>
    /// Gets whether unlocking this tier requires the previous tier.
    /// </summary>
    /// <remarks>
    /// Always false for Tier 1, always true for Tier 2 and 3.
    /// </remarks>
    public bool RequiresPreviousTier { get; init; }

    /// <summary>
    /// Gets the minimum progression rank required to unlock this tier.
    /// </summary>
    /// <remarks>
    /// Standard: Tier 1 = 1, Tier 2 = 2, Tier 3 = 3
    /// </remarks>
    public int RequiredRank { get; init; }

    /// <summary>
    /// Gets the abilities available in this tier.
    /// </summary>
    public IReadOnlyList<SpecializationAbility> Abilities { get; init; }

    /// <summary>
    /// Gets the count of abilities in this tier.
    /// </summary>
    public int AbilityCount => Abilities?.Count ?? 0;

    /// <summary>
    /// Gets the count of passive abilities in this tier.
    /// </summary>
    public int PassiveCount => Abilities?.Count(a => a.IsPassive) ?? 0;

    /// <summary>
    /// Gets the count of active abilities in this tier.
    /// </summary>
    public int ActiveCount => Abilities?.Count(a => !a.IsPassive) ?? 0;

    /// <summary>
    /// Creates a new ability tier with validation.
    /// </summary>
    /// <param name="tier">Tier number (1, 2, or 3).</param>
    /// <param name="displayName">Display name for the tier.</param>
    /// <param name="unlockCost">PP cost to unlock.</param>
    /// <param name="requiresPreviousTier">Whether previous tier must be unlocked.</param>
    /// <param name="requiredRank">Minimum progression rank required.</param>
    /// <param name="abilities">Abilities in this tier.</param>
    /// <returns>A validated <see cref="SpecializationAbilityTier"/>.</returns>
    /// <exception cref="ArgumentException">Thrown when validation fails.</exception>
    public static SpecializationAbilityTier Create(
        int tier,
        string displayName,
        int unlockCost,
        bool requiresPreviousTier,
        int requiredRank,
        IEnumerable<SpecializationAbility> abilities)
    {
        ArgumentOutOfRangeException.ThrowIfLessThan(tier, 1);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(tier, 3);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);
        ArgumentOutOfRangeException.ThrowIfNegative(unlockCost);
        ArgumentOutOfRangeException.ThrowIfLessThan(requiredRank, 1);
        ArgumentNullException.ThrowIfNull(abilities);

        var abilityList = abilities.ToList();

        if (abilityList.Count == 0)
        {
            throw new ArgumentException(
                "Tier must contain at least one ability",
                nameof(abilities));
        }

        // Tier 1 should not require previous tier
        if (tier == 1 && requiresPreviousTier)
        {
            throw new ArgumentException(
                "Tier 1 cannot require a previous tier",
                nameof(requiresPreviousTier));
        }

        // Tier 2+ should require previous tier
        if (tier > 1 && !requiresPreviousTier)
        {
            throw new ArgumentException(
                $"Tier {tier} must require the previous tier",
                nameof(requiresPreviousTier));
        }

        // Validate unique ability IDs within tier
        var duplicateIds = abilityList
            .GroupBy(a => a.AbilityId)
            .Where(g => g.Count() > 1)
            .Select(g => g.Key)
            .ToList();

        if (duplicateIds.Count > 0)
        {
            throw new ArgumentException(
                $"Duplicate ability IDs in tier: {string.Join(", ", duplicateIds)}",
                nameof(abilities));
        }

        return new SpecializationAbilityTier
        {
            Tier = tier,
            DisplayName = displayName,
            UnlockCost = unlockCost,
            RequiresPreviousTier = requiresPreviousTier,
            RequiredRank = requiredRank,
            Abilities = abilityList.AsReadOnly()
        };
    }

    /// <summary>
    /// Creates a standard Tier 1 (free on selection).
    /// </summary>
    public static SpecializationAbilityTier CreateTier1(
        string displayName,
        IEnumerable<SpecializationAbility> abilities)
    {
        return Create(
            tier: 1,
            displayName: displayName,
            unlockCost: 0,
            requiresPreviousTier: false,
            requiredRank: 1,
            abilities: abilities);
    }

    /// <summary>
    /// Creates a standard Tier 2 (2 PP, requires Tier 1).
    /// </summary>
    public static SpecializationAbilityTier CreateTier2(
        string displayName,
        IEnumerable<SpecializationAbility> abilities)
    {
        return Create(
            tier: 2,
            displayName: displayName,
            unlockCost: 2,
            requiresPreviousTier: true,
            requiredRank: 2,
            abilities: abilities);
    }

    /// <summary>
    /// Creates a standard Tier 3 (3 PP, requires Tier 2).
    /// </summary>
    public static SpecializationAbilityTier CreateTier3(
        string displayName,
        IEnumerable<SpecializationAbility> abilities)
    {
        return Create(
            tier: 3,
            displayName: displayName,
            unlockCost: 3,
            requiresPreviousTier: true,
            requiredRank: 3,
            abilities: abilities);
    }

    /// <summary>
    /// Checks if this tier can be unlocked given current state.
    /// </summary>
    /// <param name="currentRank">Player's current progression rank.</param>
    /// <param name="previousTierUnlocked">Whether the previous tier is unlocked.</param>
    /// <param name="availablePp">Available Progression Points.</param>
    /// <returns>Validation result with reason if cannot unlock.</returns>
    public (bool CanUnlock, string? Reason) CanUnlock(
        int currentRank,
        bool previousTierUnlocked,
        int availablePp)
    {
        if (RequiresPreviousTier && !previousTierUnlocked)
        {
            return (false, $"Tier {Tier - 1} must be unlocked first");
        }

        if (currentRank < RequiredRank)
        {
            return (false, $"Requires Rank {RequiredRank}");
        }

        if (availablePp < UnlockCost)
        {
            return (false, $"Requires {UnlockCost} PP ({availablePp} available)");
        }

        return (true, null);
    }

    /// <inheritdoc />
    public override string ToString()
    {
        return $"Tier {Tier}: {DisplayName} ({AbilityCount} abilities, {UnlockCost} PP)";
    }
}
```

---

## 6. SpecializationDefinition Enhancement

### 6.1 Entity Enhancement

**File:** `src/Core/RuneAndRust.Domain/Entities/SpecializationDefinition.cs`

Add the following to the existing entity:

```csharp
// Add to existing properties
/// <summary>
/// Gets the ability tiers for this specialization.
/// </summary>
/// <remarks>
/// Contains 3 tiers of abilities, each with 2-4 abilities.
/// </remarks>
public IReadOnlyList<SpecializationAbilityTier> AbilityTiers { get; private set; }

/// <summary>
/// Gets the total count of abilities across all tiers.
/// </summary>
public int TotalAbilityCount => AbilityTiers?.Sum(t => t.AbilityCount) ?? 0;

/// <summary>
/// Gets all abilities across all tiers.
/// </summary>
public IEnumerable<SpecializationAbility> AllAbilities =>
    AbilityTiers?.SelectMany(t => t.Abilities) ?? Enumerable.Empty<SpecializationAbility>();

// Add to private constructor
private SpecializationDefinition()
{
    DisplayName = null!;
    Tagline = null!;
    Description = null!;
    SelectionText = null!;
    AbilityTiers = Array.Empty<SpecializationAbilityTier>();
}

// Update Create factory method signature and body
public static SpecializationDefinition Create(
    SpecializationId specializationId,
    string displayName,
    string tagline,
    string description,
    string selectionText,
    Archetype parentArchetype,
    SpecializationPathType pathType,
    int unlockCost,
    SpecialResourceDefinition? specialResource = null,
    IEnumerable<SpecializationAbilityTier>? abilityTiers = null)
{
    // ... existing validation ...

    var tiersList = abilityTiers?.ToList() ?? new List<SpecializationAbilityTier>();

    // Validate tier numbers are sequential and unique
    if (tiersList.Count > 0)
    {
        var tierNumbers = tiersList.Select(t => t.Tier).OrderBy(t => t).ToList();
        if (tierNumbers.Distinct().Count() != tierNumbers.Count)
        {
            throw new ArgumentException(
                "Ability tiers must have unique tier numbers",
                nameof(abilityTiers));
        }
    }

    // Validate no duplicate ability IDs across tiers
    var allAbilityIds = tiersList
        .SelectMany(t => t.Abilities)
        .Select(a => a.AbilityId)
        .ToList();

    var duplicateIds = allAbilityIds
        .GroupBy(id => id)
        .Where(g => g.Count() > 1)
        .Select(g => g.Key)
        .ToList();

    if (duplicateIds.Count > 0)
    {
        throw new ArgumentException(
            $"Duplicate ability IDs across tiers: {string.Join(", ", duplicateIds)}",
            nameof(abilityTiers));
    }

    return new SpecializationDefinition
    {
        // ... existing assignments ...
        AbilityTiers = tiersList.AsReadOnly()
    };
}

/// <summary>
/// Gets a specific tier by number.
/// </summary>
/// <param name="tierNumber">The tier number (1, 2, or 3).</param>
/// <returns>The tier, or null if not found.</returns>
public SpecializationAbilityTier? GetTier(int tierNumber)
{
    return AbilityTiers.FirstOrDefault(t => t.Tier == tierNumber);
}

/// <summary>
/// Gets a specific ability by ID.
/// </summary>
/// <param name="abilityId">The ability ID.</param>
/// <returns>The ability, or null if not found.</returns>
public SpecializationAbility? GetAbility(string abilityId)
{
    return AllAbilities.FirstOrDefault(a =>
        a.AbilityId.Equals(abilityId, StringComparison.OrdinalIgnoreCase));
}

/// <summary>
/// Gets the tier containing a specific ability.
/// </summary>
/// <param name="abilityId">The ability ID.</param>
/// <returns>The tier number, or null if ability not found.</returns>
public int? GetAbilityTier(string abilityId)
{
    return AbilityTiers
        .FirstOrDefault(t => t.Abilities.Any(a =>
            a.AbilityId.Equals(abilityId, StringComparison.OrdinalIgnoreCase)))
        .Tier;
}
```

---

## 7. Configuration

### 7.1 Enhanced Specializations JSON with Ability Tiers

**File:** `config/specializations.json`

```json
{
    "$schema": "./schemas/specializations.schema.json",
    "definitions": [
        {
            "specializationId": "Berserkr",
            "displayName": "Berserkr",
            "tagline": "Fury Unleashed",
            "description": "The Berserkr channels primal rage into devastating combat prowess...",
            "selectionText": "Embrace the fury. Let rage fuel your strikes.",
            "parentArchetype": "Warrior",
            "pathType": "Heretical",
            "unlockCost": 0,
            "specialResource": {
                "resourceId": "rage",
                "displayName": "Rage",
                "minValue": 0,
                "maxValue": 100,
                "startsAt": 0,
                "regenPerTurn": 0,
                "decayPerTurn": 5,
                "description": "Fury that builds with each strike"
            },
            "abilityTiers": [
                {
                    "tier": 1,
                    "displayName": "Primal Fury",
                    "unlockCost": 0,
                    "requiresPreviousTier": false,
                    "requiredRank": 1,
                    "abilities": [
                        {
                            "abilityId": "rage-strike",
                            "displayName": "Rage Strike",
                            "description": "Channel rage into a devastating blow. Damage scales with current Rage.",
                            "isPassive": false,
                            "resourceCost": 20,
                            "resourceType": "rage",
                            "cooldown": 0,
                            "corruptionRisk": 5
                        },
                        {
                            "abilityId": "blood-frenzy",
                            "displayName": "Blood Frenzy",
                            "description": "When below 50% health, deal 10% increased damage.",
                            "isPassive": true,
                            "resourceCost": 0,
                            "resourceType": "",
                            "cooldown": 0,
                            "corruptionRisk": 0
                        },
                        {
                            "abilityId": "intimidating-presence",
                            "displayName": "Intimidating Presence",
                            "description": "Your fury terrifies nearby enemies, reducing their accuracy.",
                            "isPassive": false,
                            "resourceCost": 15,
                            "resourceType": "rage",
                            "cooldown": 3,
                            "corruptionRisk": 0
                        }
                    ]
                },
                {
                    "tier": 2,
                    "displayName": "Unleashed Beast",
                    "unlockCost": 2,
                    "requiresPreviousTier": true,
                    "requiredRank": 2,
                    "abilities": [
                        {
                            "abilityId": "berserker-charge",
                            "displayName": "Berserker Charge",
                            "description": "Rush toward an enemy, stunning them on impact.",
                            "isPassive": false,
                            "resourceCost": 30,
                            "resourceType": "rage",
                            "cooldown": 4,
                            "corruptionRisk": 10
                        },
                        {
                            "abilityId": "pain-is-power",
                            "displayName": "Pain is Power",
                            "description": "Convert 25% of damage taken into Rage.",
                            "isPassive": true,
                            "resourceCost": 0,
                            "resourceType": "",
                            "cooldown": 0,
                            "corruptionRisk": 0
                        },
                        {
                            "abilityId": "reckless-swing",
                            "displayName": "Reckless Swing",
                            "description": "A powerful attack that leaves you vulnerable. +50% damage, -30% defense for 1 turn.",
                            "isPassive": false,
                            "resourceCost": 25,
                            "resourceType": "rage",
                            "cooldown": 2,
                            "corruptionRisk": 5
                        }
                    ]
                },
                {
                    "tier": 3,
                    "displayName": "Avatar of Destruction",
                    "unlockCost": 3,
                    "requiresPreviousTier": true,
                    "requiredRank": 3,
                    "abilities": [
                        {
                            "abilityId": "unstoppable-fury",
                            "displayName": "Unstoppable Fury",
                            "description": "Become immune to crowd control while above 50 Rage.",
                            "isPassive": true,
                            "resourceCost": 0,
                            "resourceType": "",
                            "cooldown": 0,
                            "corruptionRisk": 0
                        },
                        {
                            "abilityId": "deaths-door-defiance",
                            "displayName": "Death's Door Defiance",
                            "description": "Once per combat, survive a fatal blow with 1 HP and gain 50 Rage.",
                            "isPassive": true,
                            "resourceCost": 0,
                            "resourceType": "",
                            "cooldown": 0,
                            "corruptionRisk": 15
                        },
                        {
                            "abilityId": "cataclysmic-roar",
                            "displayName": "Cataclysmic Roar",
                            "description": "Release all Rage in a devastating area attack. Damage scales with Rage consumed.",
                            "isPassive": false,
                            "resourceCost": 50,
                            "resourceType": "rage",
                            "cooldown": 6,
                            "corruptionRisk": 20
                        }
                    ]
                }
            ]
        }
    ]
}
```

### 7.2 Standard Tier Structure

| Tier | Display Name Pattern                       | Unlock Cost | Requires Previous | Required Rank | Abilities |
| ---- | ------------------------------------------ | ----------- | ----------------- | ------------- | --------- |
| 1    | "Core Techniques" / "Primal Fury"          | 0 PP        | No                | 1             | 2-4       |
| 2    | "Advanced Mastery" / "Unleashed Beast"     | 2 PP        | Yes               | 2             | 2-4       |
| 3    | "Ultimate Power" / "Avatar of Destruction" | 3 PP        | Yes               | 3             | 2-4       |

---

## 8. Commands

No new commands introduced in v0.17.4c. Ability tier structures are internal value objects.

---

## 9. User-Facing Changes

### 9.1 No Direct UI Changes

v0.17.4c introduces foundational value objects consumed by v0.17.4e and v0.17.5.

### 9.2 Future UI Integration Points

The value objects defined here will enable:

- Ability tier tree display (v0.17.5)
- Tier unlock buttons with PP cost (v0.17.5)
- Ability tooltips with resource/cooldown info (v0.17.5)
- Corruption risk warnings on Heretical abilities (v0.17.5)

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component                             | Level   | Events                                |
| ------------------------------------- | ------- | ------------------------------------- |
| `SpecializationAbility.Create`        | Debug   | Ability creation                      |
| `SpecializationAbilityTier.Create`    | Debug   | Tier creation with ability count      |
| `SpecializationAbilityTier.CanUnlock` | Debug   | Unlock validation result              |
| Validation failures                   | Warning | Duplicate IDs, invalid tier structure |

### 10.2 Log Message Templates

```csharp
// Debug: Ability creation
_logger.LogDebug(
    "Created SpecializationAbility {AbilityId} ({Type}) - Cost: {Cost} {ResourceType}",
    ability.AbilityId,
    ability.IsPassive ? "Passive" : "Active",
    ability.ResourceCost,
    ability.ResourceType);

// Debug: Tier creation
_logger.LogDebug(
    "Created Tier {TierNumber} '{DisplayName}' with {AbilityCount} abilities ({ActiveCount} active, {PassiveCount} passive)",
    tier.Tier,
    tier.DisplayName,
    tier.AbilityCount,
    tier.ActiveCount,
    tier.PassiveCount);

// Debug: Unlock validation
_logger.LogDebug(
    "Tier {TierNumber} unlock check: CanUnlock={CanUnlock}, Reason={Reason}",
    tier.Tier,
    canUnlock,
    reason ?? "N/A");

// Warning: Duplicate ability IDs
_logger.LogWarning(
    "Duplicate ability IDs detected in tier {Tier}: {DuplicateIds}",
    tier,
    string.Join(", ", duplicateIds));
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature                            | Test Count |
| ---------------------------------- | ---------- |
| SpecializationAbility creation     | 1          |
| SpecializationAbilityTier creation | 1          |
| Tier unlock validation             | 1          |
| **Total**                          | **~3**     |

### 11.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SpecializationAbilityTests.cs`

```csharp
[TestFixture]
public class SpecializationAbilityTests
{
    [Test]
    public void CreateActive_WithValidParameters_CreatesActiveAbility()
    {
        // Arrange & Act
        var ability = SpecializationAbility.CreateActive(
            abilityId: "rage-strike",
            displayName: "Rage Strike",
            description: "A powerful rage-fueled attack",
            resourceCost: 20,
            resourceType: "rage",
            cooldown: 0,
            corruptionRisk: 5);

        // Assert
        ability.AbilityId.Should().Be("rage-strike");
        ability.DisplayName.Should().Be("Rage Strike");
        ability.IsPassive.Should().BeFalse();
        ability.ResourceCost.Should().Be(20);
        ability.ResourceType.Should().Be("rage");
        ability.HasResourceCost.Should().BeTrue();
        ability.CorruptionRisk.Should().Be(5);
        ability.RisksCorruption.Should().BeTrue();
    }

    [Test]
    public void CreatePassive_WithValidParameters_CreatesPassiveAbility()
    {
        // Arrange & Act
        var ability = SpecializationAbility.CreatePassive(
            abilityId: "blood-frenzy",
            displayName: "Blood Frenzy",
            description: "Increased damage when low HP");

        // Assert
        ability.IsPassive.Should().BeTrue();
        ability.ResourceCost.Should().Be(0);
        ability.HasResourceCost.Should().BeFalse();
        ability.Cooldown.Should().Be(0);
    }

    [Test]
    public void Create_PassiveWithCooldown_ThrowsArgumentException()
    {
        // Arrange & Act
        var act = () => SpecializationAbility.Create(
            abilityId: "test",
            displayName: "Test",
            description: "Test",
            isPassive: true,
            cooldown: 5); // Invalid for passive

        // Assert
        act.Should().Throw<ArgumentException>()
            .WithMessage("*Passive abilities cannot have a cooldown*");
    }
}
```

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SpecializationAbilityTierTests.cs`

```csharp
[TestFixture]
public class SpecializationAbilityTierTests
{
    [Test]
    public void CreateTier1_WithValidAbilities_CreatesTier()
    {
        // Arrange
        var abilities = new[]
        {
            SpecializationAbility.CreateActive("ability-1", "Ability 1", "Desc", 10, "stamina"),
            SpecializationAbility.CreatePassive("ability-2", "Ability 2", "Desc")
        };

        // Act
        var tier = SpecializationAbilityTier.CreateTier1("Core Techniques", abilities);

        // Assert
        tier.Tier.Should().Be(1);
        tier.UnlockCost.Should().Be(0);
        tier.RequiresPreviousTier.Should().BeFalse();
        tier.RequiredRank.Should().Be(1);
        tier.AbilityCount.Should().Be(2);
        tier.ActiveCount.Should().Be(1);
        tier.PassiveCount.Should().Be(1);
    }

    [Test]
    public void Create_Tier2WithoutRequiresPrevious_ThrowsArgumentException()
    {
        // Arrange
        var abilities = new[]
        {
            SpecializationAbility.CreateActive("ability-1", "Ability 1", "Desc", 10, "stamina")
        };

        // Act
        var act = () => SpecializationAbilityTier.Create(
            tier: 2,
            displayName: "Advanced",
            unlockCost: 2,
            requiresPreviousTier: false, // Invalid for Tier 2
            requiredRank: 2,
            abilities: abilities);

        // Assert
        act.Should().Throw<ArgumentException>()
            .WithMessage("*Tier 2 must require the previous tier*");
    }

    [Test]
    public void CanUnlock_WithAllRequirementsMet_ReturnsTrue()
    {
        // Arrange
        var abilities = new[]
        {
            SpecializationAbility.CreateActive("ability-1", "Ability 1", "Desc", 10, "stamina")
        };
        var tier = SpecializationAbilityTier.CreateTier2("Advanced", abilities);

        // Act
        var (canUnlock, reason) = tier.CanUnlock(
            currentRank: 2,
            previousTierUnlocked: true,
            availablePp: 5);

        // Assert
        canUnlock.Should().BeTrue();
        reason.Should().BeNull();
    }

    [Test]
    public void CanUnlock_WithoutPreviousTier_ReturnsFalse()
    {
        // Arrange
        var abilities = new[]
        {
            SpecializationAbility.CreateActive("ability-1", "Ability 1", "Desc", 10, "stamina")
        };
        var tier = SpecializationAbilityTier.CreateTier2("Advanced", abilities);

        // Act
        var (canUnlock, reason) = tier.CanUnlock(
            currentRank: 2,
            previousTierUnlocked: false,
            availablePp: 5);

        // Assert
        canUnlock.Should().BeFalse();
        reason.Should().Contain("Tier 1 must be unlocked first");
    }
}
```

---

## 12. Use Cases

### UC-001: Create Ability Tier from Configuration

**Actor:** Configuration Loader
**Precondition:** Specialization JSON loaded
**Flow:**

1. Loader reads tier entry from JSON
2. For each ability in tier, Loader calls `SpecializationAbility.Create()`
3. Loader calls `SpecializationAbilityTier.Create()` with ability collection
4. Factory validates tier structure and ability uniqueness
5. Factory returns immutable tier value object

**Postcondition:** Valid `SpecializationAbilityTier` instance created

### UC-002: Check Tier Unlock Eligibility

**Actor:** Progression System
**Precondition:** Player requests tier unlock
**Flow:**

1. System retrieves player's current rank and PP
2. System checks if previous tier is unlocked
3. System calls `tier.CanUnlock(rank, previousUnlocked, pp)`
4. If returns true, system proceeds with unlock
5. If returns false, system displays reason to player

**Postcondition:** Player informed of unlock eligibility

### UC-003: Get Ability by ID

**Actor:** Combat System
**Precondition:** Player uses specialization ability
**Flow:**

1. Combat receives ability ID from player action
2. Combat calls `specializationDefinition.GetAbility(abilityId)`
3. Combat retrieves ability properties (cost, cooldown, corruption risk)
4. Combat validates player has resources and ability not on cooldown
5. Combat executes ability effects

**Postcondition:** Ability executed with correct mechanics

---

## 13. Deliverable Checklist

### Value Objects

- [ ] `SpecializationAbility.cs` with Create, CreateActive, CreatePassive methods
- [ ] `SpecializationAbilityTier.cs` with Create, CreateTier1/2/3 methods
- [ ] `CanUnlock()` validation method on tier

### Entity Enhancement

- [ ] `AbilityTiers` property on `SpecializationDefinition`
- [ ] `TotalAbilityCount` computed property
- [ ] `AllAbilities` enumerable property
- [ ] `GetTier()`, `GetAbility()`, `GetAbilityTier()` helper methods
- [ ] Factory validation for duplicate ability IDs

### Configuration

- [ ] Enhanced `specializations.json` with `abilityTiers` array
- [ ] At least 1 complete specialization with all 3 tiers

### Testing

- [ ] `SpecializationAbilityTests.cs` with ~2 tests
- [ ] `SpecializationAbilityTierTests.cs` with ~2 tests
- [ ] All tests passing

### Documentation

- [ ] XML documentation on all public types and members
- [ ] Remarks sections with ability/tier examples

---

## 14. Acceptance Criteria

### Functional

- [ ] `SpecializationAbility.Create()` validates passive abilities have no cooldown
- [ ] `SpecializationAbility` has convenience factory methods (`CreateActive`, `CreatePassive`)
- [ ] `SpecializationAbilityTier.Create()` validates tier number 1-3
- [ ] `SpecializationAbilityTier.Create()` validates Tier 1 cannot require previous
- [ ] `SpecializationAbilityTier.Create()` validates Tier 2+ must require previous
- [ ] `SpecializationAbilityTier.Create()` validates unique ability IDs within tier
- [ ] `CanUnlock()` checks rank, previous tier, and PP requirements
- [ ] `SpecializationDefinition` validates unique ability IDs across all tiers

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 unit tests pass
- [ ] XML documentation complete on all public members
- [ ] Configuration file has valid JSON structure with ability tiers

---

## 15. Future Considerations

### Deferred to v0.17.4d

- **ISpecializationProvider**: Service for loading specialization definitions with tiers

### Deferred to v0.17.4e

- **ISpecializationApplicationService**: Service for applying specialization and granting abilities
- **Tier unlock application**: Actual PP deduction and ability granting

### Deferred to Combat Integration

- **Ability effect execution**: Actual damage/healing/status application
- **Cooldown tracking**: Per-ability cooldown state
- **Resource consumption**: Deducting costs on use
- **Corruption application**: Applying Corruption risk on Heretical abilities

---

## 16. Implementation Notes

### 16.1 Value Object Immutability

Both `SpecializationAbility` and `SpecializationAbilityTier` are `readonly record struct`:

- Full immutability after creation
- Value equality semantics
- Minimal memory allocation

### 16.2 Tier Validation Strategy

Validation is hierarchical:

1. Individual ability validated in `SpecializationAbility.Create()`
2. Tier structure validated in `SpecializationAbilityTier.Create()`
3. Cross-tier uniqueness validated in `SpecializationDefinition.Create()`

### 16.3 Corruption Risk Design

- `CorruptionRisk` is stored as an integer value
- 0 means no Corruption risk (all Coherent abilities, some Heretical)
- Positive values indicate chance or amount (implementation TBD)
- Heretical abilities typically have 5-20 Corruption risk

### 16.4 Standard Tier Costs

The `CreateTier1/2/3` factory methods encode standard progression:

- Tier 1: Free (part of specialization selection)
- Tier 2: 2 PP, requires Rank 2, requires Tier 1
- Tier 3: 3 PP, requires Rank 3, requires Tier 2

---

## 17. Document Metadata

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
_Author: Claude_
