> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.3](../v0.2.x/v0.2.3.md).

# v0.2.3c Changelog: The Arsenal (Archetype Kits)

**Release Date:** 2025-12-20
**Milestone:** v0.2.3 - The Hero's Toolkit (3 of 3)
**Test Count:** 1509 tests (0 new, existing tests updated)

---

## Summary

This release completes milestone v0.2.3 "The Hero's Toolkit" by seeding the database with **Tier 1 abilities for each archetype** and wiring the `use` command in Combat UI. Players can now execute archetype-specific abilities using numbered hotkeys (`1`, `2`, `3`) or by name (`use wild swing`), with auto-targeting for single-enemy encounters and explicit target syntax for multi-enemy scenarios (`use aether dart on goblin`). The combat screen now displays an ability panel with hotkey bindings, resource costs, and cooldown status. This implementation connects v0.2.3b's EffectScript parser to actual gameplay, enabling the tactical combat experience that defines Rune & Rust.

---

## New Features

### Archetype Ability Kits

Each archetype receives 2 Tier 1 abilities at character creation:

| Archetype | Ability 1 | Ability 2 |
|-----------|-----------|-----------|
| **Warrior** | Wild Swing (35 STA, 2d8 Physical) | Defensive Stance (Free, +Fortified, CD:2) |
| **Skirmisher** | Precise Shot (30 STA, 1d8 Physical, Range:2) | Evasive Roll (20 STA, +Evasion, CD:2) |
| **Mystic** | Aether Dart (15 AP, 1d10 Arcane, Range:3) | Mind Spike (25 AP, 1d6 Psychic + Dazed, CD:1) |
| **Adept** | Mend Wound (20 STA, HEAL:12, CD:2) | Blessed Strike (15 AP, 1d6 Radiant + HEAL:6, CD:1) |

### Combat UI Commands

New combat commands for ability usage:

| Command | Example | Description |
|---------|---------|-------------|
| `use <name>` | `use wild swing` | Use ability by name (partial match) |
| `use <#>` | `use 1` | Use ability by hotkey number |
| `<#>` | `1` | Shortcut for `use <#>` |
| `use <name> on <target>` | `use aether dart on goblin` | Use ability on specific target |
| `use <#> at <target>` | `use 2 at wolf` | Use hotkey ability on specific target |

### Auto-Targeting Logic

Abilities automatically resolve targets based on context:

| Condition | Behavior |
|-----------|----------|
| Self-targeting ability (Range=0) | Target is user |
| Single enemy alive | Auto-select that enemy |
| Multiple enemies alive | Require explicit target ("on <name>") |
| Invalid target specified | Return error with available target names |

### Combat Screen Ability Panel

New UI section displays player abilities during combat:

```
╭──────────────────────────────────────────╮
│         YOUR ABILITIES                   │
├───┬──────────────────┬───────────┬───────┤
│ # │ Ability          │ Cost      │Status │
├───┼──────────────────┼───────────┼───────┤
│[1]│ Wild Swing       │ 35 STA    │ READY │
│[2]│ Defensive Stance │ Free      │ CD: 2 │
╰───┴──────────────────┴───────────┴───────╯
```

Status indicators:
- **READY** (green): Ability can be used
- **CD: X** (red): Cooldown remaining (X turns)
- **N/A** (grey): Insufficient resources

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IActiveAbilityRepository.cs` | Repository interface with `GetByArchetypeAsync()` and `ExistsByNameAsync()` |
| `RuneAndRust.Persistence/Repositories/ActiveAbilityRepository.cs` | EF Core repository implementation with archetype filtering |
| `RuneAndRust.Persistence/Data/AbilitySeeder.cs` | Idempotent seeder with 8 Tier 1 abilities (2 per archetype) |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/ActiveAbility.cs` | Added `Archetype` (ArchetypeType) and `Tier` (int, default 1) properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `Abilities` list property; updated `FromCharacter()` to accept abilities parameter |
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `GetPlayerAbilities()`, `ExecutePlayerAbility(int)`, `ExecutePlayerAbility(string)` |
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Added `AbilityView` record and `PlayerAbilities` property |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added `DbSet<ActiveAbility>` with entity configuration and composite index |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `IActiveAbilityRepository` dependency; ability loading in `StartCombat()`; ability execution methods |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added `use` command parsing for combat phase; hotkey shortcuts (1-9) |
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Added `RenderAbilities()` method for ability panel display |
| `RuneAndRust.Terminal/Program.cs` | Registered `IActiveAbilityRepository`; changed `CombatService` to Scoped; added seeder call |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `IActiveAbilityRepository` mock with default setup |

---

## Code Implementation Details

### ActiveAbility Entity Extensions

```csharp
// New properties added to ActiveAbility.cs
public ArchetypeType Archetype { get; set; }
public int Tier { get; set; } = 1;
```

**Key Behaviors:**
- `Archetype` determines which characters can learn the ability
- `Tier` controls unlock progression (Tier 1: Level 1+, Tier 2: Level 5+, Tier 3: Level 10+)

### IActiveAbilityRepository Interface

```csharp
public interface IActiveAbilityRepository : IRepository<ActiveAbility>
{
    Task<IEnumerable<ActiveAbility>> GetByArchetypeAsync(ArchetypeType archetype, int maxTier = 1);
    Task<ActiveAbility?> GetByNameAsync(string name);
    Task AddRangeAsync(IEnumerable<ActiveAbility> abilities);
    Task<bool> ExistsByNameAsync(string name);
}
```

**Key Behaviors:**
- `GetByArchetypeAsync()` filters by archetype and tier ceiling
- Results ordered by Tier, then Name for consistent UI display
- Case-insensitive name matching for player convenience

### AbilityView Record

```csharp
public record AbilityView(
    int Hotkey,            // 1-based index
    string Name,           // "Wild Swing"
    string CostDisplay,    // "35 STA" or "15 AP" or "Free"
    int CooldownRemaining, // 0 if ready
    bool IsUsable          // Can afford resources and not on cooldown
);
```

### Combat Ability Execution Flow

```
CommandParser.HandleCombat("use 1")
    │
    ├─ Parse: hotkey=1, targetName=null
    │
    └─ CombatService.ExecutePlayerAbility(1, null)
          │
          ├─ Get ability by index from player.Abilities
          │
          ├─ AbilityService.CanUse(player, ability)
          │     ├─ Check cooldown
          │     ├─ Check stamina
          │     └─ Check aether
          │
          ├─ ResolveAbilityTarget(ability, targetName)
          │     ├─ Range=0 → return player (self-target)
          │     ├─ Single enemy → auto-select
          │     ├─ Multiple + no target → return null (error)
          │     └─ Explicit target → find by name
          │
          ├─ AbilityService.Execute(player, target, ability)
          │     ├─ Deduct resources
          │     ├─ Set cooldown
          │     └─ Parse EffectScript → apply effects
          │
          ├─ Log combat event
          │
          ├─ Check target death → remove combatant
          │
          └─ Return narrative message
```

### Seeder Implementation

```csharp
public static async Task SeedAsync(RuneAndRustDbContext context, ILogger? logger = null)
{
    if (await context.ActiveAbilities.AnyAsync())
    {
        logger?.LogDebug("Active abilities already exist, skipping seed");
        return;
    }

    var abilities = GetTier1Abilities();
    await context.ActiveAbilities.AddRangeAsync(abilities);
    await context.SaveChangesAsync();
}
```

**Key Behaviors:**
- Idempotent: skips if any abilities exist
- Seeds all archetypes in single transaction
- Domain 4 compliant descriptions (no precision measurements)

---

## Ability Data

### Warrior Abilities

| Ability | Cost | Script | Cooldown | Range | Description |
|---------|------|--------|----------|-------|-------------|
| Wild Swing | 35 STA | `DAMAGE:Physical:2d8` | 0 | 1 | Powerful but reckless attack that sacrifices precision for raw power |
| Defensive Stance | Free | `STATUS:Fortified:1:1` | 2 | 0 | Brace yourself against incoming attacks, raising your guard |

### Skirmisher Abilities

| Ability | Cost | Script | Cooldown | Range | Description |
|---------|------|--------|----------|-------|-------------|
| Precise Shot | 30 STA | `DAMAGE:Physical:1d8` | 0 | 2 | Take careful aim at an exposed weakness |
| Evasive Roll | 20 STA | `STATUS:Evasion:1:1` | 2 | 0 | Quick tumble to avoid incoming attacks |

### Mystic Abilities

| Ability | Cost | Script | Cooldown | Range | Description |
|---------|------|--------|----------|-------|-------------|
| Aether Dart | 15 AP | `DAMAGE:Arcane:1d10` | 0 | 3 | Channel raw Aetheric energy into a concentrated bolt |
| Mind Spike | 25 AP | `DAMAGE:Psychic:1d6;STATUS:Dazed:1:1` | 1 | 2 | Psychic assault that pierces mental defenses |

### Adept Abilities

| Ability | Cost | Script | Cooldown | Range | Description |
|---------|------|--------|----------|-------|-------------|
| Mend Wound | 20 STA | `HEAL:12` | 2 | 0 | Channel restorative energy to close minor wounds |
| Blessed Strike | 15 AP | `DAMAGE:Radiant:1d6;HEAL:6` | 1 | 1 | Infuse weapon with purifying light that harms and heals |

---

## Database Schema

### ActiveAbilities Table

```sql
CREATE TABLE "ActiveAbilities" (
    "Id" uuid NOT NULL PRIMARY KEY,
    "Name" character varying(100) NOT NULL,
    "Description" character varying(500) NOT NULL,
    "StaminaCost" integer NOT NULL,
    "AetherCost" integer NOT NULL,
    "CooldownTurns" integer NOT NULL,
    "Range" integer NOT NULL,
    "EffectScript" character varying(500) NOT NULL,
    "Archetype" integer NOT NULL,
    "Tier" integer NOT NULL
);

CREATE UNIQUE INDEX "IX_ActiveAbilities_Name" ON "ActiveAbilities" ("Name");
CREATE INDEX "IX_ActiveAbilities_Archetype_Tier" ON "ActiveAbilities" ("Archetype", "Tier");
```

---

## Logging Matrix

### CombatService Ability Logs

| Event | Level | Template |
|-------|-------|----------|
| Abilities Loaded | Information | `"Loaded {Count} abilities for archetype {Archetype}"` |
| Auto-target | Debug | `"Auto-targeting single enemy: {Target}"` |
| Self-target | Debug | `"{Ability} is self-targeting"` |
| Explicit Target | Debug | `"Explicit target: {Target}"` |
| Multiple Enemies | Warning | `"Multiple enemies present, target required for {Ability}"` |
| Invalid Hotkey | Debug | `"Invalid ability hotkey: {Hotkey}. Player has {Count} abilities."` |
| Ability Not Found | Debug | `"Ability '{AbilityName}' not found in player's kit"` |
| Target Slain | Warning | `"{Target} was slain by ability!"` |
| Victory | Information | `"Combat Victory! All enemies defeated by ability."` |

### AbilitySeeder Logs

| Event | Level | Template |
|-------|-------|----------|
| Skip Seed | Debug | `"Active abilities already exist, skipping seed"` |
| Seed Start | Information | `"Seeding Tier 1 abilities..."` |
| Seed Complete | Information | `"Seeded {Count} Tier 1 abilities"` |

---

## DI Registration Changes

### Program.cs

```csharp
// Repository registration (line 48)
services.AddScoped<IActiveAbilityRepository, ActiveAbilityRepository>();

// CombatService changed from Singleton to Scoped (line 85)
services.AddScoped<ICombatService, CombatService>();

// Seeder call after host build (lines 99-104)
using (var scope = host.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<RuneAndRustDbContext>();
    AbilitySeeder.SeedAsync(context).GetAwaiter().GetResult();
}
```

### CombatService Constructor (Breaking Change)

**Before (v0.2.3b):**
```csharp
public CombatService(..., IAbilityService abilityService, ILogger<CombatService> logger)
```

**After (v0.2.3c):**
```csharp
public CombatService(..., IAbilityService abilityService, IActiveAbilityRepository abilityRepository, ILogger<CombatService> logger)
```

---

## Architecture

### Ability Loading Flow

```
Game Start
    │
    └─ AbilitySeeder.SeedAsync() → 8 abilities to database
         │
         └─ Combat Start
              │
              └─ CombatService.StartCombat()
                    │
                    ├─ Get character archetype
                    │
                    ├─ IActiveAbilityRepository.GetByArchetypeAsync(archetype, maxTier=1)
                    │
                    └─ Combatant.FromCharacter(character, abilities)
                          │
                          └─ player.Abilities = abilities
```

### Command Parsing Flow

```
User Input: "use aether dart on goblin"
    │
    └─ CommandParser.HandleCombat()
          │
          ├─ Match: "use " prefix
          │
          ├─ ExecuteAbilityCommand("aether dart on goblin")
          │     │
          │     ├─ Find " on " separator
          │     │     └─ abilityArg = "aether dart"
          │     │     └─ targetName = "goblin"
          │     │
          │     └─ CombatService.ExecutePlayerAbility("aether dart", "goblin")
          │
          └─ Display result + advance turn
```

---

## Known Limitations

1. **No Ability Progression:** Only Tier 1 abilities are seeded; Tier 2/3 require level-based unlocking (future feature)
2. **No Ability Customization:** Abilities are fixed per archetype; no talent trees or ability swapping
3. **Enemy Abilities Not Implemented:** Enemies use basic attacks only; enemy ability system deferred to v0.2.4
4. **No Healing Target Selection:** Self-targeting healing abilities cannot target allies
5. **Range Validation Not Enforced:** Ranged abilities can target any enemy regardless of distance
6. **No Ability Tooltips:** Full ability descriptions are not shown in combat UI

---

## Migration Notes

### For Developers

If you have custom `CombatService` instantiations, add the `IActiveAbilityRepository`:

```csharp
// Update your mocks in tests
var mockAbilityRepo = new Mock<IActiveAbilityRepository>();
mockAbilityRepo.Setup(r => r.GetByArchetypeAsync(It.IsAny<ArchetypeType>(), It.IsAny<int>()))
    .ReturnsAsync(new List<ActiveAbility>());

_sut = new CombatService(
    _gameState,
    _mockInitiative.Object,
    _mockAttackResolution.Object,
    _mockLootService.Object,
    _mockStatusEffects.Object,
    _mockAIService.Object,
    _mockTraitService.Object,
    _mockResourceService.Object,
    _mockAbilityService.Object,
    mockAbilityRepo.Object,  // NEW
    _mockLogger.Object);
```

### Database Migration

Run EF Core migration to create the ActiveAbilities table:

```bash
dotnet ef migrations add AddActiveAbilities --project RuneAndRust.Persistence
dotnet ef database update --project RuneAndRust.Persistence
```

---

## Verification Results

### Build Output

```
Build succeeded.
    63 Warning(s)
    0 Error(s)
```

### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:  1509, Skipped:     0, Total:  1509, Duration: 572 ms
```

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Entities/
│   └── ActiveAbility.cs             [MODIFIED - added Archetype, Tier]
├── Interfaces/
│   ├── IActiveAbilityRepository.cs  [NEW]
│   └── ICombatService.cs            [MODIFIED - added ability methods]
├── Models/Combat/
│   └── Combatant.cs                 [MODIFIED - added Abilities list]
├── ViewModels/
│   └── CombatViewModel.cs           [MODIFIED - added AbilityView, PlayerAbilities]

RuneAndRust.Persistence/
├── Data/
│   ├── AbilitySeeder.cs             [NEW]
│   └── RuneAndRustDbContext.cs      [MODIFIED - added DbSet]
├── Repositories/
│   └── ActiveAbilityRepository.cs   [NEW]

RuneAndRust.Engine/Services/
├── CombatService.cs                 [MODIFIED - ability loading, execution, UI]
├── CommandParser.cs                 [MODIFIED - use command, hotkeys]

RuneAndRust.Terminal/
├── Program.cs                       [MODIFIED - DI, seeder call]
├── Services/
│   └── CombatScreenRenderer.cs      [MODIFIED - ability panel]

RuneAndRust.Tests/Engine/
├── CombatServiceTests.cs            [MODIFIED - added ability repo mock]
```

---

## Milestone v0.2.3 Complete

This release completes the v0.2.3 milestone "The Hero's Toolkit":

| Sub-version | Feature | Status |
|-------------|---------|--------|
| v0.2.3a | Resource Service (Stamina/Aether/Overcast) | Complete |
| v0.2.3b | Ability Service (EffectScript Parser) | Complete |
| v0.2.3c | Archetype Kits (Database + UI) | Complete |

---

## Next Steps (v0.2.4)

- Implement enemy ability system with AI ability selection
- Add Tier 2 abilities unlocked at Level 5
- Create ability unlock screen in character progression
- Add visual effects for ability execution (screen flash, damage numbers)
- Implement multi-target abilities (AOE damage, group heals)
- Add ability combos and synergies between archetypes

---

## Contributors

- Implementation: Claude Opus 4.5
