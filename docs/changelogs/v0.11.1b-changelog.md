# v0.11.1b Changelog: Recipe Book

**Version:** 0.11.1b
**Phase:** Recipe Book (Player Recipe Knowledge Tracking)
**Date:** 2026-01-19
**Status:** ✅ Complete

---

## Summary

Implements the Recipe Book system enabling players to track which crafting recipes they know. Players start with default recipes and can learn additional recipes through discovery. The recipe service provides methods for querying known recipes, learning new recipes, and validating crafting prerequisites.

This version connects recipe definitions (v0.11.1a) to player entities, enabling player-specific recipe knowledge tracking and pre-craft validation.

---

## Added

### Domain Layer - Entities

| Entity | Description |
|--------|-------------|
| `RecipeBook` | Tracks known recipes per player with learning timestamps |

#### RecipeBook Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier (IEntity requirement) |
| `PlayerId` | `Guid` | Associated player's ID |
| `KnownRecipeIds` | `IReadOnlySet<string>` | Set of known recipe IDs |
| `KnownCount` | `int` | Number of known recipes |

#### RecipeBook Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(playerId)` | `RecipeBook` | Factory method to create empty book |
| `IsKnown(recipeId)` | `bool` | Case-insensitive check if recipe is known |
| `Learn(recipeId)` | `bool` | Add recipe to book (false if already known) |
| `GetLearnedDate(recipeId)` | `DateTime?` | When recipe was learned (null if not known) |
| `InitializeDefaults(ids)` | `void` | Bulk add default recipes without events |

### Domain Layer - Player Modifications

| Change | Description |
|--------|-------------|
| `Player.RecipeBook` | New property for recipe knowledge tracking |
| `Player.EnsureRecipeBook()` | Internal method for backwards compatibility |

### Application Layer - Events

| Event | Description |
|-------|-------------|
| `RecipeLearnedEvent` | Published when a player learns a new recipe |

#### RecipeLearnedEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `PlayerId` | `Guid` | Player who learned the recipe |
| `RecipeId` | `string` | Learned recipe identifier |
| `RecipeName` | `string` | Display name of the recipe |
| `Timestamp` | `DateTimeOffset` | When learning occurred |

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `LearnRecipeResult` | Result of learning attempt with status |
| `CraftValidation` | Pre-craft validation result |
| `MissingIngredient` | Details of insufficient resources |

#### LearnResultType Enum

| Value | Description |
|-------|-------------|
| `Success` | Recipe newly learned |
| `AlreadyKnown` | Player already knows recipe |
| `NotFound` | Recipe doesn't exist |

#### LearnRecipeResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsSuccess` | `bool` | True if newly learned |
| `ResultType` | `LearnResultType` | Outcome category |
| `RecipeId` | `string` | Attempted recipe ID |
| `RecipeName` | `string?` | Recipe name (null if not found) |
| `FailureReason` | `string?` | Human-readable failure message |

#### CraftValidation Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsValid` | `bool` | True if can craft |
| `Recipe` | `RecipeDefinition?` | Recipe definition (if found) |
| `FailureReason` | `string?` | Why validation failed |
| `MissingIngredients` | `IReadOnlyList<MissingIngredient>?` | Missing resources |
| `IsMissingIngredients` | `bool` | True if missing ingredients |

#### MissingIngredient Properties

| Property | Type | Description |
|----------|------|-------------|
| `ResourceId` | `string` | Resource identifier |
| `ResourceName` | `string` | Display name |
| `QuantityNeeded` | `int` | Additional amount required |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IRecipeService` | Service for recipe management operations |

#### IRecipeService Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `GetKnownRecipes(player)` | `IReadOnlyList<RecipeDefinition>` | All known recipes |
| `GetKnownRecipesByCategory(player, category)` | `IReadOnlyList<RecipeDefinition>` | Known recipes in category |
| `GetCraftableRecipes(player, stationId)` | `IReadOnlyList<RecipeDefinition>` | Known recipes for station |
| `IsRecipeKnown(player, recipeId)` | `bool` | Check if player knows recipe |
| `GetKnownRecipe(player, recipeId)` | `RecipeDefinition?` | Get if player knows it |
| `GetKnownRecipeCount(player)` | `int` | Count of known recipes |
| `GetTotalRecipeCount()` | `int` | Total recipes in game |
| `LearnRecipe(player, recipeId)` | `LearnRecipeResult` | Attempt to learn recipe |
| `InitializeDefaultRecipes(player)` | `void` | Add starter recipes |
| `CanCraft(player, recipeId, stationId)` | `CraftValidation` | Validate crafting attempt |

### Application Layer - Services

| Service | Description |
|---------|-------------|
| `RecipeService` | Implementation of IRecipeService |

#### RecipeService Dependencies

| Dependency | Purpose |
|------------|---------|
| `IRecipeProvider` | Access recipe definitions |
| `IResourceProvider` | Resource name lookups |
| `IGameEventLogger` | Publish learning events |
| `ILogger<RecipeService>` | Diagnostic logging |

### Infrastructure Layer - DI Registration

| Registration | Lifetime | Description |
|--------------|----------|-------------|
| `IRecipeService` | Scoped | Recipe management service |
| `IRecipeProvider` | Singleton | Recipe definitions provider |
| `IResourceProvider` | Singleton | Resource definitions provider |

---

## Validation Flow

The `CanCraft` method performs validation in this order:

1. **Recipe Exists** - Recipe ID must exist in provider
2. **Recipe Known** - Player must know the recipe
3. **Station Match** - Player must be at correct station (if stationId provided)
4. **Ingredients Available** - Player must have sufficient resources

Validation stops at first failure with appropriate feedback.

---

## Unit Tests

### RecipeBookTests (~20 tests)

- Factory creation with player ID
- Learning new recipes (success, duplicate)
- Case-insensitive lookups
- Timestamp tracking
- Default recipe initialization
- Invalid parameter handling

### RecipeServiceTests (~25 tests)

- Constructor null validation
- LearnRecipe (success, already known, not found)
- GetKnownRecipes filtering
- InitializeDefaultRecipes
- CanCraft validation (all conditions)
- Category and station filtering
- Event publishing verification

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/RecipeBook.cs` | Recipe book entity |
| `src/Core/RuneAndRust.Application/Events/RecipeEvents.cs` | Recipe learning event |
| `src/Core/RuneAndRust.Application/DTOs/LearnRecipeResult.cs` | Learning result DTO |
| `src/Core/RuneAndRust.Application/DTOs/CraftValidation.cs` | Validation result DTO |
| `src/Core/RuneAndRust.Application/Interfaces/IRecipeService.cs` | Service interface |
| `src/Core/RuneAndRust.Application/Services/RecipeService.cs` | Service implementation |
| `tests/.../Entities/RecipeBookTests.cs` | RecipeBook unit tests |
| `tests/.../Services/RecipeServiceTests.cs` | RecipeService unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Added RecipeBook property |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Added service registrations |

---

## API Examples

### Initializing New Players

```csharp
// During character creation
var player = new Player("Hero");
recipeService.InitializeDefaultRecipes(player);
Console.WriteLine($"Started with {player.RecipeBook.KnownCount} recipes");
// Output: Started with 9 recipes
```

### Learning Recipes

```csharp
// From a recipe scroll
var result = recipeService.LearnRecipe(player, "steel-sword");

switch (result.ResultType)
{
    case LearnResultType.Success:
        Console.WriteLine($"Learned {result.RecipeName}!");
        break;
    case LearnResultType.AlreadyKnown:
        Console.WriteLine("You already know this recipe.");
        break;
    case LearnResultType.NotFound:
        Console.WriteLine("Unknown recipe.");
        break;
}
```

### Querying Known Recipes

```csharp
// Get all known recipes
var recipes = recipeService.GetKnownRecipes(player);
Console.WriteLine($"You know {recipes.Count} recipes");

// Filter by category
var weapons = recipeService.GetKnownRecipesByCategory(player, RecipeCategory.Weapon);
foreach (var weapon in weapons)
{
    Console.WriteLine($"- {weapon.Name} (DC {weapon.DifficultyClass})");
}

// Get recipes for current station
var anvilRecipes = recipeService.GetCraftableRecipes(player, "anvil");
Console.WriteLine($"Available at anvil: {anvilRecipes.Count}");
```

### Craft Validation

```csharp
var validation = recipeService.CanCraft(player, "iron-sword", "anvil");

if (validation.IsValid)
{
    Console.WriteLine("Ready to craft!");
    // Proceed with crafting (v0.11.2)
}
else if (validation.IsMissingIngredients)
{
    Console.WriteLine("Missing ingredients:");
    foreach (var missing in validation.MissingIngredients!)
    {
        Console.WriteLine($"  {missing.ResourceName} x{missing.QuantityNeeded}");
    }
}
else
{
    Console.WriteLine(validation.FailureReason);
}
```

### Checking Recipe Knowledge

```csharp
// Quick check
if (recipeService.IsRecipeKnown(player, "steel-sword"))
{
    Console.WriteLine("You can craft Steel Swords!");
}

// Get recipe if known
var recipe = recipeService.GetKnownRecipe(player, "iron-sword");
if (recipe != null)
{
    Console.WriteLine($"Ingredients: {recipe.GetIngredientsDisplay()}");
}
```

---

## v0.11.x Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | ✅ Complete |
| v0.11.0b | Harvestable Features | ✅ Complete |
| v0.11.0c | Gathering Service | ✅ Complete |
| v0.11.1a | Recipe Definitions | ✅ Complete |
| v0.11.1b | Recipe Book | ✅ Complete |
| v0.11.1c | Recipe Discovery | Pending |
| v0.11.2 | Crafting System | Pending |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.11.1a | RecipeDefinition | Recipe templates |
| v0.11.1a | IRecipeProvider | Recipe queries |
| v0.11.1a | RecipeCategory | Category enum |
| v0.11.0a | IResourceProvider | Ingredient name lookups |
| v0.0.x | Player | Player entity integration |
| v0.0.x | IGameEventLogger | Event publishing |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.11.1c | RecipeBook | Recipe scroll learning |
| v0.11.2 | IRecipeService | Crafting validation |
| v0.11.2 | CraftValidation | Pre-craft checks |

---

## Key Design Decisions

1. **RecipeBook in Domain Layer** - Follows Player entity pattern for domain modeling
2. **Case-Insensitive Lookups** - Uses StringComparer.OrdinalIgnoreCase throughout
3. **EnsureRecipeBook Pattern** - Handles backwards compatibility with existing players
4. **Event via IGameEventLogger** - Uses existing LogCharacter method for events
5. **CanCraft Returns Recipe** - Failed validations still include recipe when possible
6. **MissingIngredient Uses Names** - Resource names resolved for user display
7. **No Events on Default Init** - InitializeDefaultRecipes doesn't publish events

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | Recipe lookup attempts, validation steps |
| Information | Recipe learned, service initialized |
| Warning | Attempt to learn non-existent recipe |

---

## Notes

- RecipeBook tracks learning timestamps for statistics/achievements
- Case-insensitive throughout (RecipeBook, RecipeService)
- CanCraft null stationId skips station validation
- MissingIngredients reports only additional quantity needed
- Station names formatted with proper articles ("an Anvil", "a Workbench")
- Resource pools checked via Player.GetResource() method
- Orphaned recipe IDs (deleted from provider) filtered from GetKnownRecipes
