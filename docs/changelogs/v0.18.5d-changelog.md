# v0.18.5d Changelog — Turn-Based Integration

**Release Date:** 2026-02-02  
**Version:** 0.18.5d  
**Phase:** Trauma Economy — Resource Integration  
**Focus:** Turn Processing Orchestration

---

## Summary

Implements the Turn-Based Integration layer for the Trauma Economy system. This phase adds the `TurnIntegrationResult` value object and `UnifiedTurnHandler` service to orchestrate per-turn effects across all integrated trauma economy systems.

---

## Added

### Domain Layer

#### Enums

- **`TurnPhase`** — Differentiates between turn start and turn end processing phases
    - `Start` (0): Beginning of character turn
    - `End` (1): End of character turn

#### Enum Extensions

- **`StressSource.ApotheosisStrain`** — New stress source for Arcanist Apotheosis maintenance costs

#### Value Objects

- **`TurnIntegrationResult`** — Immutable record struct capturing all turn processing outcomes (~380 lines)
    - Character ID and turn phase tracking
    - Resource decay results (`RageDecay`, `MomentumDecay`)
    - Apotheosis mechanics (active state, stress cost, auto-exit detection)
    - Panic Table outcomes (`PanicCheckPerformed`, `PanicEffectApplied`)
    - CPS stage and effects tracking
    - Environmental stress applied
    - Trauma check trigger status
    - Factory methods: `CreateTurnStart()`, `CreateTurnEnd()`, `Empty()`
    - Computed properties: `HadResourceDecay`, `HadPsychologicalEffects`, `HasEffects`, `IsValid`

### Application Layer

#### Services

- **`UnifiedTurnHandler`** — Central orchestrator for per-turn trauma economy effects (~360 lines)
    - Required dependencies: `IStressService`, `ITraumaService`, `IDiceService`, `ICpsService`
    - Optional specialization dependencies: `IRageService`, `IMomentumService`, `ICoherenceService`
    - **`ProcessTurnStart()`**: Handles out-of-combat resource decay (Rage: -10, Momentum: -15) and Apotheosis stress costs (+10 per turn)
    - **`ProcessTurnEnd()`**: Manages Panic Table checks at RuinMadness stage, CPS stage effects, environmental stress (capped at 5/turn), and trauma trigger detection
    - Comprehensive structured logging throughout

### Tests

- **`UnifiedTurnHandlerTests`** — 17 unit tests covering:
    - Constructor validation (5 tests)
    - Turn start resource decay (3 tests)
    - Apotheosis processing (2 tests)
    - Panic check mechanics (2 tests)
    - Environmental stress and trauma (3 tests)
    - Result object validation (2 tests)

---

## Turn Processing Mechanics

### Turn Start Effects

1. **Out-of-Combat Resource Decay**
    - Rage: -10 per non-combat turn
    - Momentum: -15 per non-combat turn
2. **Apotheosis Maintenance**
    - +10 stress per turn while in Apotheosis
    - Auto-exit if stress reaches 100

### Turn End Effects

1. **Panic Table Checks** — Rolled at RuinMadness CPS stage
2. **CPS Stage Effects** — Applied based on current stress level
3. **Environmental Stress** — Up to 5 stress per turn from environment
4. **Trauma Check Triggers** — Flagged when stress reaches 100

---

## Dependencies

- v0.18.5a: `TraumaEconomyState` and `TraumaEconomySnapshot` (aggregation layer)
- v0.18.5b: `UnifiedDamageHandler` and `DamageIntegrationResult` (damage integration)
- v0.18.5c: `UnifiedRestHandler` and `RestIntegrationResult` (rest integration)

---

## Files Changed

| File                                           | Change                                  |
| ---------------------------------------------- | --------------------------------------- |
| `Domain/Enums/StressSource.cs`                 | Added `ApotheosisStrain` value          |
| `Domain/Enums/TurnPhase.cs`                    | **NEW** — Turn phase differentiation    |
| `Domain/ValueObjects/TurnIntegrationResult.cs` | **NEW** — Turn processing result object |
| `Application/Services/UnifiedTurnHandler.cs`   | **NEW** — Turn orchestration service    |
| `Tests/.../UnifiedTurnHandlerTests.cs`         | **NEW** — 17 unit tests                 |
