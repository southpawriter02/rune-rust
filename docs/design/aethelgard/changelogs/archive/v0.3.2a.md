> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.2](../v0.3.x/v0.3.2.md).

# v0.3.2a Changelog: The Campfire (Core Logic)

**Release Date:** December 20, 2025
**Total Tests:** 1753 (all passing)

---

## Summary

Version 0.3.2a implements the **core resting mechanics** for Rune & Rust. This is the first sub-version of the Rest & Recovery milestone (v0.3.2), establishing the mathematical foundation for resource management and recovery formulas.

Key additions:
- **RestService**: Handles rest transactions with supply consumption and recovery calculations
- **Two Rest Types**: Sanctuary (full recovery, safe) vs Wilderness (partial recovery, resource-dependent)
- **Supply System**: Tag-based item identification for Rations and Water
- **Exhausted Status**: New debuff applied when resting without supplies
- **New Items**: Waterskin variants added to loot tables

---

## Feature: Rest System

### Rest Types

| Type | Supplies Required | HP Recovery | Stamina Recovery | Stress Recovery |
|------|-------------------|-------------|------------------|-----------------|
| **Sanctuary** | None | Full (MaxHP) | Full (MaxStamina) | Full (to 0) |
| **Wilderness** | Ration + Water | Partial (formula) | Full | Partial (formula) |
| **Wilderness (No Supplies)** | N/A | Halved | Halved | None |

### Recovery Formulas (Wilderness)

```
HP Recovery     = 10 + (Sturdiness × 2)
Stress Recovery = Will × 5
Stamina         = MaxStamina (full)

If Exhausted:
  HP Recovery   = (10 + (Sturdiness × 2)) / 2
  Stamina       = MaxStamina / 2
  Stress        = 0 (no recovery)
```

### Supply Consumption

Wilderness rest requires both:
- **1× Ration-tagged item** (e.g., Field Rations, Dvergr Iron-Bread)
- **1× Water-tagged item** (e.g., Waterskin, Dvergr Flask)

If either is missing:
- `[Exhausted]` status effect is applied
- Recovery values are halved
- No stress recovery occurs

---

## New Entities & Enums

### RestType Enum

```csharp
public enum RestType
{
    Wilderness = 0,  // Requires supplies, partial heal, ambush risk (future)
    Sanctuary = 1    // Safe, full heal, no supplies needed
}
```

### RestResult Record

```csharp
public record RestResult(
    int HpRecovered,
    int StaminaRecovered,
    int StressRecovered,
    bool SuppliesConsumed,
    bool IsExhausted,
    int TimeAdvancedMinutes = 480
);
```

### StatusEffectType.Exhausted

Added to the debuffs section (value = 5):

```csharp
/// <summary>
/// Out-of-combat debuff from resting without supplies.
/// Halves all recovery from rest. Prevents running.
/// Cured by resting at a Sanctuary or consuming supplies.
/// </summary>
Exhausted = 5
```

---

## Entity Modifications

### Item.Tags Property

New property for categorization and behavior filtering:

```csharp
/// <summary>
/// Tags for categorization and behavior filtering (e.g., "Ration", "Water").
/// Stored as JSONB in PostgreSQL.
/// </summary>
public List<string> Tags { get; set; } = new();

/// <summary>
/// Checks if this item has the specified tag (case-insensitive).
/// </summary>
public bool HasTag(string tag) =>
    Tags.Any(t => t.Equals(tag, StringComparison.OrdinalIgnoreCase));
```

### Character.ActiveStatusEffects Property

New property for persistent out-of-combat status effects:

```csharp
/// <summary>
/// Persistent status effects active outside of combat.
/// Combat status effects are tracked separately on Combatant.
/// </summary>
public List<StatusEffectType> ActiveStatusEffects { get; set; } = new();

public bool HasStatusEffect(StatusEffectType effect);
public void AddStatusEffect(StatusEffectType effect);
public void RemoveStatusEffect(StatusEffectType effect);
```

---

## Service Layer

### IRestService Interface

```csharp
public interface IRestService
{
    /// <summary>
    /// Performs a rest action, consuming supplies and applying recovery.
    /// </summary>
    Task<RestResult> PerformRestAsync(Character character, RestType type);

    /// <summary>
    /// Checks if the character has required supplies for wilderness rest.
    /// </summary>
    Task<bool> HasRequiredSuppliesAsync(Character character);
}
```

### RestService Implementation

**Dependencies:**
- `IInventoryService` - For supply check and item removal
- `ILogger<RestService>` - For traceability

**Key Logic:**

```csharp
public async Task<RestResult> PerformRestAsync(Character character, RestType type)
{
    if (type == RestType.Sanctuary)
    {
        // Full recovery: HP=Max, Stamina=Max, Stress=0
        // Cures Exhausted status
        return await PerformSanctuaryRestAsync(character);
    }
    else
    {
        // Check supplies, consume or apply Exhausted
        // Apply partial recovery based on attributes
        return await PerformWildernessRestAsync(character);
    }
}
```

---

## Repository Layer

### IInventoryRepository.FindByTagAsync

New method for tag-based item search:

```csharp
/// <summary>
/// Finds the first item in inventory that has the specified tag.
/// Uses case-insensitive matching.
/// </summary>
Task<InventoryItem?> FindByTagAsync(Guid characterId, string tag);
```

### InventoryRepository Implementation

```csharp
public async Task<InventoryItem?> FindByTagAsync(Guid characterId, string tag)
{
    var normalizedTag = tag.Trim().ToLowerInvariant();

    // Load items and filter in memory (JSONB array queries are complex in EF Core)
    var items = await _dbSet
        .Include(ii => ii.Item)
        .Where(ii => ii.CharacterId == characterId)
        .ToListAsync();

    return items.FirstOrDefault(ii =>
        ii.Item.Tags.Any(t => t.Equals(normalizedTag, StringComparison.OrdinalIgnoreCase)));
}
```

### IInventoryService.FindItemByTagAsync

```csharp
/// <summary>
/// Finds an item in inventory by tag (e.g., "Ration", "Water").
/// </summary>
Task<InventoryItem?> FindItemByTagAsync(Character character, string tag);
```

---

## Loot Table Updates

### Consumable Template Enhancement

Added optional `Tags` parameter:

```csharp
public record ConsumableTemplate(
    string Name,
    string Description,
    string DetailedDescription,
    int Weight,
    int Value,
    List<string>? Tags = null  // NEW: Optional categorization tags
);
```

### Ration Tags Added

| Item | Quality | Tags |
|------|---------|------|
| Questionable Rations | JuryRigged | `["Ration"]` |
| Field Rations | Scavenged | `["Ration"]` |
| Dvergr Iron-Bread | ClanForged | `["Ration"]` |

### New Waterskin Items

| Item | Quality | Tags | Weight | Value |
|------|---------|------|--------|-------|
| Cracked Waterskin | JuryRigged | `["Water"]` | 200g | 4 Scrip |
| Waterskin | Scavenged | `["Water"]` | 250g | 10 Scrip |
| Dvergr Flask | ClanForged | `["Water"]` | 300g | 30 Scrip |

**Item Descriptions (AAM-VOICE compliant):**

```
Cracked Waterskin (JuryRigged)
"A patched container that leaks at the seams."
"Several repairs suggest long use. Contents remain drinkable, if not appetizing."

Waterskin (Scavenged)
"A leather container for carrying water."
"The stitching holds well. Sufficient for a day's hydration in the wastes."

Dvergr Flask (ClanForged)
"A metal-bound container of superior construction."
"The interior coating prevents contamination. Water stays fresh for extended periods."
```

---

## Database Migration

### Migration: AddRestSystemColumns

```csharp
public partial class AddRestSystemColumns : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<string>(
            name: "Tags",
            table: "Items",
            type: "jsonb",
            nullable: false,
            defaultValue: "[]");

        migrationBuilder.AddColumn<string>(
            name: "ActiveStatusEffects",
            table: "Characters",
            type: "jsonb",
            nullable: false,
            defaultValue: "[]");
    }
}
```

### DbContext Configuration

```csharp
// Item.Tags (v0.3.2a)
entity.Property(i => i.Tags)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<List<string>>(v, (JsonSerializerOptions?)null) ?? new List<string>()
    )
    .IsRequired();

// Character.ActiveStatusEffects (v0.3.2a)
entity.Property(c => c.ActiveStatusEffects)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<List<StatusEffectType>>(v, (JsonSerializerOptions?)null) ?? new List<StatusEffectType>()
    )
    .IsRequired();
```

---

## Unit Tests (20 tests)

### RestServiceTests

| Category | Test | Validates |
|----------|------|-----------|
| **Sanctuary** | `Sanctuary_FullRecovery_RestoresAllStats` | HP/Stamina to max, stress to 0 |
| **Sanctuary** | `Sanctuary_RemovesExhausted_WhenPresent` | Cures Exhausted status |
| **Sanctuary** | `Sanctuary_DoesNotConsumeSupplies` | No inventory changes |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_ConsumesRationAndWater` | 1 of each consumed |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_HpRecovery_UsesSturdiness` | 10 + (STU × 2) formula |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_HpRecovery_CapsAtMaxHp` | No overheal |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_StressRecovery_UsesWill` | Will × 5 formula |
| **Wilderness (Supplies)** | `Wilderness_WithSupplies_StaminaRecovery_Full` | Stamina = Max |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_AppliesExhausted` | Status applied |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_HalvesHpRecovery` | Recovery / 2 |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_HalvesStaminaRecovery` | MaxStamina / 2 |
| **Wilderness (No Supplies)** | `Wilderness_WithoutSupplies_NoStressRecovery` | Stress unchanged |
| **Wilderness (Partial)** | `Wilderness_MissingRationOnly_AppliesExhausted` | Water alone insufficient |
| **Wilderness (Partial)** | `Wilderness_MissingWaterOnly_AppliesExhausted` | Ration alone insufficient |
| **HasSupplies** | `HasRequiredSupplies_BothPresent_ReturnsTrue` | Validation passes |
| **HasSupplies** | `HasRequiredSupplies_MissingRation_ReturnsFalse` | Validation fails |
| **HasSupplies** | `HasRequiredSupplies_MissingWater_ReturnsFalse` | Validation fails |
| **Edge Cases** | `Wilderness_HighSturdiness_LargeHpRecovery` | STU=10 → 30 HP |
| **Edge Cases** | `Wilderness_StressAtZero_StaysAtZero` | No negative stress |
| **Edge Cases** | `Wilderness_AlreadyExhausted_StillAppliesPenalties` | Pre-existing status honored |

---

## Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/RestType.cs` | Rest type enum |
| `RuneAndRust.Core/Models/RestResult.cs` | Result record |
| `RuneAndRust.Core/Interfaces/IRestService.cs` | Service interface |
| `RuneAndRust.Engine/Services/RestService.cs` | Service implementation |
| `RuneAndRust.Tests/Engine/RestServiceTests.cs` | Unit tests (20) |
| `RuneAndRust.Persistence/Migrations/20251221014933_AddRestSystemColumns.cs` | DB migration |
| `docs/changelogs/v0.3.2a.md` | This changelog |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/StatusEffectType.cs` | Added `Exhausted = 5` |
| `RuneAndRust.Core/Entities/Item.cs` | Added `Tags` property and `HasTag()` method |
| `RuneAndRust.Core/Entities/Character.cs` | Added `ActiveStatusEffects` with helper methods |
| `RuneAndRust.Core/Interfaces/IInventoryRepository.cs` | Added `FindByTagAsync` method |
| `RuneAndRust.Persistence/Repositories/InventoryRepository.cs` | Implemented `FindByTagAsync` |
| `RuneAndRust.Core/Interfaces/IInventoryService.cs` | Added `FindItemByTagAsync` method |
| `RuneAndRust.Engine/Services/InventoryService.cs` | Implemented `FindItemByTagAsync` |
| `RuneAndRust.Engine/Services/LootTables.cs` | Added tags to rations, new Waterskin items |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | JSONB config for new columns |
| `RuneAndRust.Terminal/Program.cs` | Registered `IInventoryRepository`, `IRestService` |

---

## Logging Matrix

| System | Event | Level | Message Template |
|--------|-------|-------|------------------|
| Rest | Start | Info | `"{Name} initiating {Type} rest."` |
| Rest | Supplies Check | Debug | `"Supply check: Ration={HasRation}, Water={HasWater}."` |
| Rest | Supplies Consumed | Debug | `"Consumed 1x {RationName}, 1x {WaterName}."` |
| Rest | Exhaustion Applied | Warning | `"{Name} rests without supplies. Applying [Exhausted]."` |
| Rest | Exhaustion Cured | Info | `"{Name} cured of Exhausted at Sanctuary."` |
| Rest | Recovery | Info | `"Rest complete. HP+{HP}, Stress-{Stress}. Supplies used: {Used}."` |
| Rest | Sanctuary | Info | `"{Name} fully restored at Sanctuary."` |
| Inventory | Tag Search | Debug | `"Searching for item with tag '{Tag}' in {CharacterName}'s inventory"` |
| Inventory | Tag Found | Debug | `"Found item '{ItemName}' with tag '{Tag}'"` |
| Inventory | Tag Not Found | Debug | `"No item with tag '{Tag}' found in inventory"` |

---

## Dependency Injection Registration

```csharp
// Register Inventory Services
services.AddScoped<IInventoryRepository, InventoryRepository>();
services.AddScoped<IInventoryService, InventoryService>();

// Register Rest Services (v0.3.2a)
services.AddScoped<IRestService, RestService>();
```

---

## Directory Structure After v0.3.2a

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   ├── Character.cs                    [MODIFIED - ActiveStatusEffects]
│   │   └── Item.cs                         [MODIFIED - Tags]
│   ├── Enums/
│   │   ├── RestType.cs                     [NEW]
│   │   └── StatusEffectType.cs             [MODIFIED - Exhausted]
│   ├── Interfaces/
│   │   ├── IInventoryRepository.cs         [MODIFIED - FindByTagAsync]
│   │   ├── IInventoryService.cs            [MODIFIED - FindItemByTagAsync]
│   │   └── IRestService.cs                 [NEW]
│   └── Models/
│       └── RestResult.cs                   [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── InventoryService.cs             [MODIFIED - FindItemByTagAsync]
│       ├── LootTables.cs                   [MODIFIED - Tags, Waterskins]
│       └── RestService.cs                  [NEW]
├── RuneAndRust.Persistence/
│   ├── Data/
│   │   └── RuneAndRustDbContext.cs         [MODIFIED - JSONB configs]
│   ├── Migrations/
│   │   └── 20251221014933_AddRestSystemColumns.cs [NEW]
│   └── Repositories/
│       └── InventoryRepository.cs          [MODIFIED - FindByTagAsync]
├── RuneAndRust.Terminal/
│   └── Program.cs                          [MODIFIED - DI registrations]
├── RuneAndRust.Tests/
│   └── Engine/
│       └── RestServiceTests.cs             [NEW - 20 tests]
└── docs/
    └── changelogs/
        └── v0.3.2a.md                      [NEW]
```

---

## Test Architecture Summary

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1587 | Mocked dependencies |
| Integration Tests (InMemory) | 137 | EF Core InMemory provider |
| Integration Tests (PostgreSQL) | 29 | Real PostgreSQL via Docker |
| **Total** | **1753** | All passing |

---

## Build Verification

```
Build succeeded.
    0 Error(s)
    66 Warning(s) (pre-existing)

Test Results:
  Passed: 1753
  Failed: 0
  Skipped: 0

New Tests Added: 20 (RestServiceTests)
```

---

## Deferred to v0.3.2b (The Watch)

- Ambush check logic and Camp Craft skill integration
- Risk calculation based on biome danger level
- Encounter generation with "Ambush" tag

## Deferred to v0.3.2c (The Dawn)

- `rest` and `camp` command wiring in CommandParser
- RestScreenRenderer using Spectre.Console
- Sanctuary validation (Room feature check)
- Time advancement integration

---

## Migration Instructions

### Apply Database Migration

```bash
# Ensure Docker container is running
docker-compose up -d

# Apply migration
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
```

### Verify New Columns

```sql
-- Check Items table
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Items' AND column_name = 'Tags';

-- Check Characters table
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'Characters' AND column_name = 'ActiveStatusEffects';
```

---

## API Usage Examples

### Performing a Rest

```csharp
// Inject IRestService
public class GameService
{
    private readonly IRestService _restService;

    public async Task RestAtCampAsync(Character character)
    {
        // Check supplies first
        if (!await _restService.HasRequiredSuppliesAsync(character))
        {
            Console.WriteLine("Warning: You have no supplies. Resting will apply Exhausted.");
        }

        var result = await _restService.PerformRestAsync(character, RestType.Wilderness);

        Console.WriteLine($"Rest complete: HP+{result.HpRecovered}, Stress-{result.StressRecovered}");

        if (result.IsExhausted)
            Console.WriteLine("You are Exhausted from lack of supplies.");
    }

    public async Task RestAtSanctuaryAsync(Character character)
    {
        var result = await _restService.PerformRestAsync(character, RestType.Sanctuary);
        Console.WriteLine("You are fully restored at the Sanctuary.");
    }
}
```

### Finding Items by Tag

```csharp
// Find any ration in inventory
var ration = await _inventoryService.FindItemByTagAsync(character, "Ration");
if (ration != null)
{
    Console.WriteLine($"Found ration: {ration.Item.Name}");
}
```

---

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Serilog | 3.x | Structured logging |
| FluentAssertions | 8.x | Test assertions |
| xUnit | 2.9.x | Test framework |
| Moq | 4.x | Mocking framework |
