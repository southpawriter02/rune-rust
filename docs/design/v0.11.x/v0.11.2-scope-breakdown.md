# v0.11.2 Crafting System - Scope Breakdown

**Version:** 0.11.2
**Theme:** Crafting System
**Prerequisites:** v0.11.1c Complete (Recipes & Discovery - Recipe Discovery)
**Total Estimated Tests:** ~30 new tests

---

## Executive Summary

The Crafting System sub-version implements the complete crafting loop including crafting stations in rooms, the craft command, and quality dice checks that affect output. Players must be at the appropriate station with required resources to craft items. Crafting skill affects success chance and quality.

Key focus areas:
- **Crafting Stations**: Station types and room placement
- **Crafting Mechanics**: Dice checks, resource consumption, quality rolls
- **Quality System**: Roll margins determine item quality tiers

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.11.2a | Crafting Stations | CraftingStation, station types, room integration | ~10 |
| v0.11.2b | Crafting Service | ICraftingService, dice checks, resource consumption | ~12 |
| v0.11.2c | Quality System | Quality tiers, roll margins, item enhancement | ~8 |

---

## Existing Infrastructure

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| Room | `Domain/Entities/Room.cs` | Room with features |
| RoomFeature | `Domain/Entities/RoomFeature.cs` | Interactable features |
| DiceService | `Application/Services/DiceService.cs` | Dice rolling |
| Player | `Domain/Entities/Player.cs` | Player entity |
| Inventory | `Domain/Entities/Inventory.cs` | Item storage |
| Skills | `Domain/ValueObjects/Skills.cs` | Skill system |

### Already Implemented (from v0.11.1-v0.11.2)

| Feature | Location | Notes |
|---------|----------|-------|
| ResourceDefinition | `Domain/Definitions/ResourceDefinition.cs` | Resource types |
| IResourceProvider | `Application/Interfaces/IResourceProvider.cs` | Resource loading |
| RecipeDefinition | `Domain/Definitions/RecipeDefinition.cs` | Recipe templates |
| IRecipeService | `Application/Interfaces/IRecipeService.cs` | Recipe management |
| RecipeBook | `Domain/Entities/RecipeBook.cs` | Known recipes |

### Needs Implementation (v0.11.2)

| Feature | Part | Notes |
|---------|------|-------|
| CraftingStationDefinition | v0.11.2a | Station templates |
| CraftingStation | v0.11.2a | Room feature |
| ICraftingStationProvider | v0.11.2a | Config loading |
| ICraftingService | v0.11.2b | Crafting interface |
| CraftingService | v0.11.2b | Crafting logic |
| CraftCommand | v0.11.2b | Player command |
| CraftedItemQuality | v0.11.1c | Quality enum |
| QualityModifier | v0.11.1c | Quality effects |

---

## Feature Analysis & Categorization

### Crafting Station Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| CraftingStationDefinition | Medium | Domain | **v0.11.2a** |
| CraftingStation entity | Medium | Room features | **v0.11.2a** |
| Station types (anvil, etc.) | Low | Config | **v0.11.2a** |
| Station-recipe linking | Low | Recipes | **v0.11.2a** |
| ICraftingStationProvider | Low | Config | **v0.11.2a** |
| Room station placement | Medium | Rooms | **v0.11.2a** |

### Crafting Service Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| ICraftingService interface | Medium | Application | **v0.11.2b** |
| CraftingService impl | High | Service | **v0.11.2b** |
| Craft dice check | Medium | DiceService | **v0.11.2b** |
| Resource consumption | Medium | Inventory | **v0.11.2b** |
| Skill modifiers | Medium | Skills | **v0.11.2b** |
| CraftCommand | Medium | Commands | **v0.11.2b** |
| Crafting failure | Medium | Resources | **v0.11.2b** |

### Quality System Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| CraftedItemQuality enum | Low | Domain | **v0.11.1c** |
| Quality determination | Medium | Dice rolls | **v0.11.1c** |
| Roll margin thresholds | Low | Config | **v0.11.1c** |
| Quality stat bonuses | Medium | Items | **v0.11.1c** |
| Critical success (nat 20) | Low | Dice | **v0.11.1c** |
| Failure resource loss | Medium | Inventory | **v0.11.1c** |

---

## Part Definitions

---

## v0.11.2a: Crafting Stations

[v0.11.2a Design Specification](v0.11.2a-design-specification.md)

### Overview

Define crafting stations as interactable room features. Each station type supports specific recipe categories. Stations are placed in rooms and can be examined and used for crafting.

### Scope

**In Scope:**
- `CraftingStationDefinition` entity
- `CraftingStation` room feature
- Station types (anvil, workbench, alchemy-table)
- Station-to-category linking
- `ICraftingStationProvider` interface
- `CraftingStationProvider` implementation
- Room station spawning
- Station descriptions
- `crafting-stations.json` configuration
- Station icons

**Out of Scope:**
- Crafting mechanics (v0.11.2b)
- Quality system (v0.11.1c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 2 | `CraftingStationDefinition`, `CraftingStation` |
| Interfaces | 1 | `ICraftingStationProvider` |
| Infrastructure | 1 | `CraftingStationProvider` |
| Room Updates | 1 | Station feature support |
| Configuration | 1 | `crafting-stations.json` |
| Unit Tests | ~10 | Station loading, room tests |

### Crafting Station Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CRAFTING STATION ARCHITECTURE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     Configuration                        Domain
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€

   crafting-stations.json        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  CraftingStationDefinition  â”‚
   â”‚ {                â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚   "id": "anvil", â”‚  â”€â”€â”€â”€â”€â–¶   â”‚ + StationId: string         â”‚
   â”‚   "name": ...,   â”‚           â”‚ + Name: string              â”‚
   â”‚   "categories":..â”‚           â”‚ + Description: string       â”‚
   â”‚ }                â”‚           â”‚ + Categories: List<RecipeCat>
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ + IconPath: string?         â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚ creates instance
                                                 â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚      CraftingStation        â”‚
                                  â”‚      (Room feature)         â”‚
                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                  â”‚ + DefinitionId: string      â”‚
                                  â”‚ + IsAvailable: bool         â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    STATION TYPES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    ANVIL                WORKBENCH            ALCHEMY TABLE
    â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ğŸ”¨    â”‚         â”‚   ğŸªš    â”‚          â”‚   âš—ï¸    â”‚
    â”‚  ANVIL  â”‚         â”‚WORKBENCHâ”‚          â”‚ ALCHEMY â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Crafts:              Crafts:              Crafts:
    â€¢ Weapons            â€¢ Armor              â€¢ Potions
    â€¢ Tools              â€¢ Accessories        â€¢ Consumables
    â€¢ Metal items        â€¢ Leather items      â€¢ Poisons
    â€¢ Materials          â€¢ Wood items         
    
    Skill:               Skill:               Skill:
    Smithing             Leatherworking       Alchemy


    ROOM WITH CRAFTING STATION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  BLACKSMITH'S FORGE                                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                  â”‚
    â”‚  The heat from the forge fills the room. An ancient anvil       â”‚
    â”‚  stands ready for use, scarred from countless hammerings.       â”‚
    â”‚                                                                  â”‚
    â”‚  FEATURES:                                                       â”‚
    â”‚  â””â”€ [Anvil] A sturdy anvil for smithing                         â”‚
    â”‚             Crafts: Weapons, Tools, Materials                    â”‚
    â”‚             > examine anvil                                      â”‚
    â”‚             > craft iron-sword                                   â”‚
    â”‚                                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CraftingStationDefinition Entity

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines a type of crafting station.
/// </summary>
public class CraftingStationDefinition : IEntity
{
    public Guid Id { get; private set; }
    public string StationId { get; private set; } = null!;
    public string Name { get; private set; } = null!;
    public string Description { get; private set; } = null!;
    public IReadOnlyList<RecipeCategory> SupportedCategories { get; private set; } = [];
    public string CraftingSkillId { get; private set; } = null!;
    public string? IconPath { get; private set; }
    
    private CraftingStationDefinition() { }
    
    public static CraftingStationDefinition Create(
        string stationId,
        string name,
        string description,
        IEnumerable<RecipeCategory> supportedCategories,
        string craftingSkillId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(stationId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);
        ArgumentException.ThrowIfNullOrWhiteSpace(craftingSkillId);
        
        return new CraftingStationDefinition
        {
            Id = Guid.NewGuid(),
            StationId = stationId.ToLowerInvariant(),
            Name = name,
            Description = description,
            SupportedCategories = supportedCategories.ToList(),
            CraftingSkillId = craftingSkillId.ToLowerInvariant()
        };
    }
    
    /// <summary>Checks if this station supports a recipe category.</summary>
    public bool SupportsCategory(RecipeCategory category)
    {
        return SupportedCategories.Contains(category);
    }
    
    /// <summary>Checks if this station can craft a recipe.</summary>
    public bool CanCraftRecipe(RecipeDefinition recipe)
    {
        return SupportsCategory(recipe.Category);
    }
}
```

### CraftingStation Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// A crafting station instance in a room.
/// </summary>
public class CraftingStation : RoomFeature
{
    public string DefinitionId { get; private set; } = null!;
    public bool IsAvailable { get; private set; } = true;
    
    private CraftingStation() : base() { }
    
    public static CraftingStation Create(CraftingStationDefinition definition)
    {
        return new CraftingStation
        {
            Id = Guid.NewGuid(),
            DefinitionId = definition.StationId,
            Name = definition.Name,
            Description = definition.Description,
            IsInteractable = true,
            InteractionVerb = "use"
        };
    }
    
    /// <summary>Sets the station as in use.</summary>
    public void SetInUse()
    {
        IsAvailable = false;
    }
    
    /// <summary>Sets the station as available.</summary>
    public void SetAvailable()
    {
        IsAvailable = true;
    }
}
```

### ICraftingStationProvider Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides crafting station definitions.
/// </summary>
public interface ICraftingStationProvider
{
    /// <summary>Gets a station by ID.</summary>
    CraftingStationDefinition? GetStation(string stationId);
    
    /// <summary>Gets all stations.</summary>
    IReadOnlyList<CraftingStationDefinition> GetAllStations();
    
    /// <summary>Gets stations that support a category.</summary>
    IReadOnlyList<CraftingStationDefinition> GetStationsForCategory(RecipeCategory category);
    
    /// <summary>Gets the crafting skill for a station.</summary>
    string? GetCraftingSkill(string stationId);
    
    /// <summary>Checks if a station exists.</summary>
    bool Exists(string stationId);
}
```

### Crafting Station Configuration

```json
{
  "$schema": "./schemas/crafting-stations.schema.json",
  "stations": [
    {
      "id": "anvil",
      "name": "Anvil",
      "description": "A sturdy anvil for smithing metal items",
      "supportedCategories": ["Weapon", "Tool", "Material"],
      "craftingSkill": "smithing",
      "icon": "icons/stations/anvil.png"
    },
    {
      "id": "workbench",
      "name": "Workbench",
      "description": "A workbench for crafting armor and leather goods",
      "supportedCategories": ["Armor", "Accessory"],
      "craftingSkill": "leatherworking",
      "icon": "icons/stations/workbench.png"
    },
    {
      "id": "alchemy-table",
      "name": "Alchemy Table",
      "description": "A table with bubbling vials for brewing potions",
      "supportedCategories": ["Potion", "Consumable"],
      "craftingSkill": "alchemy",
      "icon": "icons/stations/alchemy_table.png"
    },
    {
      "id": "enchanting-altar",
      "name": "Enchanting Altar",
      "description": "A mystical altar for imbuing items with magic",
      "supportedCategories": ["Accessory", "Weapon", "Armor"],
      "craftingSkill": "enchanting",
      "icon": "icons/stations/enchanting_altar.png"
    },
    {
      "id": "cooking-fire",
      "name": "Cooking Fire",
      "description": "A simple fire pit for cooking food",
      "supportedCategories": ["Consumable"],
      "craftingSkill": "cooking",
      "icon": "icons/stations/cooking_fire.png"
    }
  ]
}
```

### Acceptance Criteria

- [x] CraftingStationDefinition loads from JSON
- [x] Station types with categories
- [x] CraftingStation room feature
- [x] SupportsCategory filters recipes
- [x] GetStationsForCategory works
- [x] CraftingSkill per station
- [x] Station descriptions display
- [x] Stations spawn in rooms (via CreateInstance factory)
- [x] Examine station shows info (GetStatusDescription, GetInteractionPrompt)
- [x] ~10 unit tests pass (56+ tests created)

---

## v0.11.2b: Crafting Service

[v0.11.2b Design Specification](v0.11.2b-design-specification.md)

### Overview

Implement the crafting service that handles the complete crafting process including validation, dice checks, resource consumption, and item creation. The craft command allows players to create items at appropriate stations.

### Scope

**In Scope:**
- `ICraftingService` interface
- `CraftingService` implementation
- Station presence check
- Recipe knowledge check
- Resource availability check
- Crafting dice check (d20 + skill vs DC)
- Resource consumption
- Item creation on success
- Partial resource loss on failure
- `CraftCommand` implementation
- `CraftResult` record
- `CraftValidation` record
- Crafting events

**Out of Scope:**
- Crafting stations (v0.11.2a)
- Quality tiers (v0.11.1c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Interfaces | 1 | `ICraftingService` |
| Services | 1 | `CraftingService` |
| Commands | 1 | `CraftCommand` |
| Results | 2 | `CraftResult`, `CraftValidation` |
| Events | 2 | `CraftAttemptedEvent`, `ItemCraftedEvent` |
| Unit Tests | ~12 | Dice checks, crafting tests |

### Crafting Service Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRAFTING SERVICE ARCHITECTURE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚       CraftCommand         â”‚
                      â”‚   > craft iron-sword       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚     ICraftingService       â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + CanCraft(player, recipe)â”‚
                      â”‚ + Craft(player, recipe)   â”‚
                      â”‚ + GetCraftableHere(plyr)  â”‚
                      â”‚ + GetCraftingModifier()   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      CraftingService       â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ - _recipeProvider         â”‚
                      â”‚ - _stationProvider        â”‚
                      â”‚ - _inventoryService       â”‚
                      â”‚ - _diceService            â”‚
                      â”‚                           â”‚
                      â”‚ + ValidateStation         â”‚
                      â”‚ + ValidateRecipe          â”‚
                      â”‚ + ValidateResources       â”‚
                      â”‚ + RollCraftCheck          â”‚
                      â”‚ + ConsumeResources        â”‚
                      â”‚ + CreateItem              â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    CRAFTING FLOW
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    > craft iron-sword
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. VALIDATE                          â”‚
    â”‚    â€¢ At station? (Anvil) âœ“           â”‚
    â”‚    â€¢ Know recipe? âœ“                  â”‚
    â”‚    â€¢ Have resources?                 â”‚
    â”‚      - Iron Ore x5 (have: 8) âœ“       â”‚
    â”‚      - Leather x2 (have: 3) âœ“        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. ROLL CRAFT CHECK                  â”‚
    â”‚    Roll: 1d20 + 4 (smithing) = 19    â”‚
    â”‚    DC: 12                            â”‚
    â”‚    Result: SUCCESS (beat by 7)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. CONSUME RESOURCES                 â”‚
    â”‚    - Iron Ore x5                     â”‚
    â”‚    - Leather x2                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. CREATE ITEM                       â”‚
    â”‚    + Iron Sword (Fine Quality)       â”‚
    â”‚    Added to inventory                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    FAILURE CASE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Roll: 1d20 + 2 = 9
    DC: 12
    Result: FAILURE (by 3)
    
    Resources lost: 25% of each ingredient
    - Iron Ore x5 â†’ lose 2 (rounded up)
    - Leather x2 â†’ lose 1 (rounded up)
    
    "Your crafting attempt fails. Some materials are ruined."
```

### ICraftingService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for crafting items at stations.
/// </summary>
public interface ICraftingService
{
    /// <summary>Validates if a player can craft a recipe.</summary>
    CraftValidation CanCraft(Player player, string recipeId);
    
    /// <summary>Attempts to craft an item.</summary>
    CraftResult Craft(Player player, string recipeId);
    
    /// <summary>Gets recipes craftable at the player's current station.</summary>
    IReadOnlyList<RecipeDefinition> GetCraftableRecipesHere(Player player);
    
    /// <summary>Gets the crafting modifier for a player at a station.</summary>
    int GetCraftingModifier(Player player, string stationId);
    
    /// <summary>Gets the station in the player's current room.</summary>
    CraftingStation? GetCurrentStation(Player player);
    
    /// <summary>Calculates resource loss on failure.</summary>
    IReadOnlyList<ResourceLoss> CalculateFailureLoss(RecipeDefinition recipe, int rollMargin);
}
```

### CraftingService Implementation

```csharp
namespace RuneAndRust.Application.Services;

public class CraftingService : ICraftingService
{
    private readonly IRecipeProvider _recipeProvider;
    private readonly IRecipeService _recipeService;
    private readonly ICraftingStationProvider _stationProvider;
    private readonly IResourceProvider _resourceProvider;
    private readonly IInventoryService _inventoryService;
    private readonly IItemFactory _itemFactory;
    private readonly IDiceService _diceService;
    private readonly IGameSessionService _sessionService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<CraftingService> _logger;
    
    private const float FailureLossMin = 0.25f; // 25% loss on close failure
    private const float FailureLossMax = 0.50f; // 50% loss on bad failure
    
    public CraftingService(
        IRecipeProvider recipeProvider,
        IRecipeService recipeService,
        ICraftingStationProvider stationProvider,
        IResourceProvider resourceProvider,
        IInventoryService inventoryService,
        IItemFactory itemFactory,
        IDiceService diceService,
        IGameSessionService sessionService,
        IEventBus eventBus,
        ILogger<CraftingService> logger)
    {
        _recipeProvider = recipeProvider;
        _recipeService = recipeService;
        _stationProvider = stationProvider;
        _resourceProvider = resourceProvider;
        _inventoryService = inventoryService;
        _itemFactory = itemFactory;
        _diceService = diceService;
        _sessionService = sessionService;
        _eventBus = eventBus;
        _logger = logger;
    }
    
    public CraftValidation CanCraft(Player player, string recipeId)
    {
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            return CraftValidation.Failed("Recipe not found.");
        }
        
        // Check recipe knowledge
        if (!_recipeService.IsRecipeKnown(player, recipeId))
        {
            return CraftValidation.Failed("You don't know this recipe.");
        }
        
        // Check station
        var station = GetCurrentStation(player);
        if (station is null)
        {
            return CraftValidation.Failed("You need to be at a crafting station.");
        }
        
        var stationDef = _stationProvider.GetStation(station.DefinitionId);
        if (stationDef is null || !stationDef.CanCraftRecipe(recipe))
        {
            return CraftValidation.Failed(
                $"This {station.Name} cannot craft {recipe.Category} recipes. " +
                $"You need a station that supports {recipe.Category}.");
        }
        
        // Check resources
        var missingResources = GetMissingResources(player, recipe);
        if (missingResources.Count > 0)
        {
            return CraftValidation.InsufficientResources(missingResources);
        }
        
        return CraftValidation.Success(recipe, stationDef);
    }
    
    public CraftResult Craft(Player player, string recipeId)
    {
        var validation = CanCraft(player, recipeId);
        if (!validation.IsValid)
        {
            return CraftResult.ValidationFailed(validation.FailureReason!);
        }
        
        var recipe = validation.Recipe!;
        var station = validation.Station!;
        
        // Roll craft check
        var modifier = GetCraftingModifier(player, station.StationId);
        var roll = _diceService.Roll("1d20");
        var total = roll + modifier;
        var dc = recipe.DifficultyClass;
        var margin = total - dc;
        
        _eventBus.Publish(new CraftAttemptedEvent(
            player.Id, recipeId, roll, modifier, total, dc));
        
        // Check for failure
        if (total < dc)
        {
            // Calculate and apply resource loss
            var losses = CalculateFailureLoss(recipe, margin);
            ApplyResourceLoss(player, losses);
            
            _logger.LogDebug("{Player} failed craft check: {Total} vs DC {DC}",
                player.Name, total, dc);
            
            return CraftResult.Failed(roll, modifier, total, dc, losses);
        }
        
        // Consume all resources on success
        ConsumeResources(player, recipe);
        
        // Create the item (quality determined in v0.11.1c)
        var quality = DetermineQuality(roll, margin);
        var item = _itemFactory.CreateFromRecipe(recipe, quality);
        _inventoryService.AddItem(player.Inventory, item);
        
        _logger.LogInformation("{Player} crafted {Item} ({Quality})",
            player.Name, item.Name, quality);
        
        _eventBus.Publish(new ItemCraftedEvent(
            player.Id, recipeId, item.Id, item.Name, quality));
        
        return CraftResult.Success(roll, modifier, total, dc, item, quality);
    }
    
    public int GetCraftingModifier(Player player, string stationId)
    {
        var stationDef = _stationProvider.GetStation(stationId);
        if (stationDef is null)
            return 0;
        
        return player.Skills.GetModifier(stationDef.CraftingSkillId);
    }
    
    public CraftingStation? GetCurrentStation(Player player)
    {
        var room = _sessionService.GetCurrentRoom(player);
        return room?.Features
            .OfType<CraftingStation>()
            .FirstOrDefault(s => s.IsAvailable);
    }
    
    public IReadOnlyList<ResourceLoss> CalculateFailureLoss(RecipeDefinition recipe, int rollMargin)
    {
        // Further from DC = more loss
        var lossPercent = rollMargin < -5 ? FailureLossMax : FailureLossMin;
        
        return recipe.Ingredients.Select(i =>
        {
            var lossAmount = Math.Max(1, (int)Math.Ceiling(i.Quantity * lossPercent));
            var resource = _resourceProvider.GetResource(i.ResourceId);
            return new ResourceLoss(i.ResourceId, resource?.Name ?? i.ResourceId, lossAmount);
        }).ToList();
    }
    
    private void ConsumeResources(Player player, RecipeDefinition recipe)
    {
        foreach (var ingredient in recipe.Ingredients)
        {
            _inventoryService.RemoveResource(
                player.Inventory, ingredient.ResourceId, ingredient.Quantity);
        }
    }
    
    private void ApplyResourceLoss(Player player, IReadOnlyList<ResourceLoss> losses)
    {
        foreach (var loss in losses)
        {
            _inventoryService.RemoveResource(player.Inventory, loss.ResourceId, loss.Amount);
        }
    }
    
    private CraftedItemQuality DetermineQuality(int roll, int margin)
    {
        // Basic quality determination (expanded in v0.11.1c)
        if (roll == 20) return CraftedItemQuality.Legendary;
        if (margin >= 10) return CraftedItemQuality.Masterwork;
        if (margin >= 5) return CraftedItemQuality.Fine;
        return CraftedItemQuality.Standard;
    }
}
```

### CraftResult and CraftValidation

```csharp
namespace RuneAndRust.Application.Results;

public record CraftValidation(
    bool IsValid,
    RecipeDefinition? Recipe,
    CraftingStationDefinition? Station,
    string? FailureReason,
    IReadOnlyList<MissingResource>? MissingResources = null)
{
    public static CraftValidation Success(RecipeDefinition recipe, CraftingStationDefinition station)
        => new(true, recipe, station, null);
    
    public static CraftValidation Failed(string reason)
        => new(false, null, null, reason);
    
    public static CraftValidation InsufficientResources(IReadOnlyList<MissingResource> missing)
        => new(false, null, null, "Insufficient resources.", missing);
}

public record CraftResult(
    bool IsSuccess,
    int Roll,
    int Modifier,
    int Total,
    int DifficultyClass,
    Item? CraftedItem,
    CraftedItemQuality? Quality,
    IReadOnlyList<ResourceLoss>? ResourcesLost,
    string? FailureReason)
{
    public static CraftResult Success(
        int roll, int modifier, int total, int dc,
        Item item, CraftedItemQuality quality)
        => new(true, roll, modifier, total, dc, item, quality, null, null);
    
    public static CraftResult Failed(
        int roll, int modifier, int total, int dc,
        IReadOnlyList<ResourceLoss> losses)
        => new(false, roll, modifier, total, dc, null, null, losses,
            "Crafting failed. Some materials were lost.");
    
    public static CraftResult ValidationFailed(string reason)
        => new(false, 0, 0, 0, 0, null, null, null, reason);
}

public record MissingResource(string ResourceId, string Name, int Needed, int Have);
public record ResourceLoss(string ResourceId, string Name, int Amount);
```

### CraftCommand

```csharp
namespace RuneAndRust.Application.Commands;

/// <summary>
/// Command to craft an item at a station.
/// </summary>
public class CraftCommand : IGameCommand
{
    private readonly ICraftingService _craftingService;
    private readonly IRecipeProvider _recipeProvider;
    
    public string Name => "craft";
    public string Description => "Craft an item at a crafting station";
    public string Usage => "craft <recipe-name>";
    
    public CraftCommand(
        ICraftingService craftingService,
        IRecipeProvider recipeProvider)
    {
        _craftingService = craftingService;
        _recipeProvider = recipeProvider;
    }
    
    public CommandResult Execute(Player player, string[] args)
    {
        if (args.Length == 0)
        {
            // List craftable recipes at current station
            var recipes = _craftingService.GetCraftableRecipesHere(player);
            if (recipes.Count == 0)
            {
                return CommandResult.Info(
                    "No recipes available here. Find a crafting station.");
            }
            
            return CommandResult.List("Available recipes:", recipes.Select(r =>
                $"{r.Name} (DC {r.DifficultyClass})"));
        }
        
        var recipeName = string.Join("-", args).ToLowerInvariant();
        var result = _craftingService.Craft(player, recipeName);
        
        if (!result.IsSuccess)
        {
            var message = new StringBuilder();
            message.AppendLine($"CRAFTING: {recipeName}");
            
            if (result.Roll > 0)
            {
                message.AppendLine(
                    $"Crafting Check (DC {result.DifficultyClass}): " +
                    $"1d20 ({result.Roll}) + {result.Modifier} = {result.Total}");
                message.AppendLine($"âœ— {result.FailureReason}");
                
                if (result.ResourcesLost?.Count > 0)
                {
                    message.AppendLine("\nResources lost:");
                    foreach (var loss in result.ResourcesLost)
                    {
                        message.AppendLine($"  - {loss.Name} x{loss.Amount}");
                    }
                }
            }
            else
            {
                message.AppendLine($"âœ— {result.FailureReason}");
            }
            
            return CommandResult.Failure(message.ToString());
        }
        
        var output = new StringBuilder();
        output.AppendLine($"CRAFTING: {result.CraftedItem!.Name}");
        output.AppendLine(
            $"Crafting Check (DC {result.DifficultyClass}): " +
            $"1d20 ({result.Roll}) + {result.Modifier} = {result.Total}");
        output.AppendLine($"âœ“ Success! ({result.Quality} Quality)");
        output.AppendLine();
        output.AppendLine("You successfully craft:");
        output.AppendLine($"  {result.CraftedItem.Name}");
        
        return CommandResult.Success(output.ToString());
    }
}
```

### Acceptance Criteria

- [x] CanCraft validates station presence
- [x] CanCraft checks recipe knowledge
- [x] CanCraft checks resources
- [x] Craft rolls d20 + skill vs DC
- [x] Success consumes all resources
- [x] Success creates item
- [x] Failure loses partial resources
- [x] Close failure (within 5) = 25% loss
- [x] Bad failure (beyond 5) = 50% loss
- [ ] CraftCommand works (deferred - command infrastructure not yet implemented)
- [x] Events fire (attempted, crafted)
- [x] ~12 unit tests pass (20 tests created)

---

## v0.11.1c: Quality System

[v0.11.1c Design Specification](v0.11.1c-design-specification.md)

### Overview

Implement the quality tier system that determines crafted item stats based on roll margins. Higher quality items have better stats. Natural 20 creates legendary items with special properties.

### Scope

**In Scope:**
- `CraftedItemQuality` enum
- Quality threshold configuration
- Roll margin â†’ quality mapping
- Quality stat bonuses (+10%, +25%, etc.)
- Natural 20 legendary crafting
- Quality item naming
- Quality visual indicators
- Item description quality text
- `quality-tiers.json` configuration

**Out of Scope:**
- Crafting stations (v0.11.2a)
- Crafting service (v0.11.2b)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Enums | 1 | `CraftedItemQuality` |
| Value Objects | 1 | `QualityModifier` |
| Factory Updates | 1 | Quality item creation |
| Configuration | 1 | `quality-tiers.json` |
| Unit Tests | ~8 | Quality determination tests |

### Quality System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      QUALITY SYSTEM ARCHITECTURE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ROLL RESULT                          QUALITY TIER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Roll < DC - 5    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ— FAILURE (lose 50% resources)
    
    Roll < DC        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ— FAILURE (lose 25% resources)
    
    Roll >= DC       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ“ STANDARD (base stats)
    
    Roll >= DC + 5   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ“ FINE (+10% stats)
    
    Roll >= DC + 10  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ“ MASTERWORK (+25% stats)
    
    Roll = 20 (Nat)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    âœ“ LEGENDARY (+50%, special)


    QUALITY BONUSES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Quality    â”‚ Stat Mult â”‚ Value Mult   â”‚ Special                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Standard   â”‚ 1.0x      â”‚ 1.0x         â”‚ None                    â”‚
    â”‚ Fine       â”‚ 1.10x     â”‚ 1.5x         â”‚ None                    â”‚
    â”‚ Masterwork â”‚ 1.25x     â”‚ 2.5x         â”‚ None                    â”‚
    â”‚ Legendary  â”‚ 1.50x     â”‚ 5.0x         â”‚ Glow effect, unique nameâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    EXAMPLE: IRON SWORD
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Base Stats:          Roll Results:
    â€¢ Attack: +4         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â€¢ Damage: 2d6+2      â”‚ Roll 12 (DC 12) = Standard Iron Sword  â”‚
    â€¢ Value: 50 gold     â”‚   Attack: +4, Damage: 2d6+2             â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                         â”‚ Roll 17 (DC+5) = Fine Iron Sword        â”‚
                         â”‚   Attack: +5, Damage: 2d6+3             â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                         â”‚ Roll 22 (DC+10) = Masterwork Iron Sword â”‚
                         â”‚   Attack: +6, Damage: 2d6+4             â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                         â”‚ Roll 20 (Nat) = Legendary Iron Sword    â”‚
                         â”‚   Attack: +8, Damage: 2d6+5, GLOWS!    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CraftedItemQuality Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Quality tiers for crafted items.
/// </summary>
public enum CraftedItemQuality
{
    Standard,    // Base stats
    Fine,        // +10% stats
    Masterwork,  // +25% stats
    Legendary    // +50% stats, special effects
}

/// <summary>
/// Extension methods for quality tiers.
/// </summary>
public static class CraftedItemQualityExtensions
{
    public static float GetStatMultiplier(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => 1.0f,
        CraftedItemQuality.Fine => 1.10f,
        CraftedItemQuality.Masterwork => 1.25f,
        CraftedItemQuality.Legendary => 1.50f,
        _ => 1.0f
    };
    
    public static float GetValueMultiplier(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => 1.0f,
        CraftedItemQuality.Fine => 1.5f,
        CraftedItemQuality.Masterwork => 2.5f,
        CraftedItemQuality.Legendary => 5.0f,
        _ => 1.0f
    };
    
    public static string GetPrefix(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => "",
        CraftedItemQuality.Fine => "Fine ",
        CraftedItemQuality.Masterwork => "Masterwork ",
        CraftedItemQuality.Legendary => "Legendary ",
        _ => ""
    };
    
    public static bool HasSpecialEffect(this CraftedItemQuality quality)
        => quality == CraftedItemQuality.Legendary;
}
```

### QualityModifier Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents quality-based stat modifications.
/// </summary>
public readonly record struct QualityModifier
{
    public CraftedItemQuality Quality { get; }
    public float StatMultiplier { get; }
    public float ValueMultiplier { get; }
    public bool HasGlowEffect { get; }
    public string NamePrefix { get; }
    
    public QualityModifier(CraftedItemQuality quality)
    {
        Quality = quality;
        StatMultiplier = quality.GetStatMultiplier();
        ValueMultiplier = quality.GetValueMultiplier();
        HasGlowEffect = quality.HasSpecialEffect();
        NamePrefix = quality.GetPrefix();
    }
    
    /// <summary>Applies stat multiplier to a value.</summary>
    public int ApplyToStat(int baseStat)
    {
        return (int)Math.Round(baseStat * StatMultiplier);
    }
    
    /// <summary>Applies value multiplier.</summary>
    public int ApplyToValue(int baseValue)
    {
        return (int)Math.Round(baseValue * ValueMultiplier);
    }
    
    /// <summary>Creates quality name.</summary>
    public string FormatName(string baseName)
    {
        return $"{NamePrefix}{baseName}";
    }
}
```

### Quality Determination Service

```csharp
namespace RuneAndRust.Application.Services;

public class QualityDeterminationService : IQualityDeterminationService
{
    private readonly IQualityTierProvider _tierProvider;
    
    public QualityDeterminationService(IQualityTierProvider tierProvider)
    {
        _tierProvider = tierProvider;
    }
    
    /// <summary>Determines quality from a craft roll.</summary>
    public CraftedItemQuality DetermineQuality(int roll, int margin)
    {
        // Natural 20 always legendary
        if (roll == 20)
        {
            return CraftedItemQuality.Legendary;
        }
        
        var tiers = _tierProvider.GetTiers();
        
        // Check tiers from highest to lowest
        foreach (var tier in tiers.OrderByDescending(t => t.MinMargin))
        {
            if (margin >= tier.MinMargin)
            {
                return tier.Quality;
            }
        }
        
        return CraftedItemQuality.Standard;
    }
    
    /// <summary>Creates a quality modifier for an item.</summary>
    public QualityModifier CreateModifier(CraftedItemQuality quality)
    {
        return new QualityModifier(quality);
    }
}
```

### Item Factory Quality Integration

```csharp
namespace RuneAndRust.Application.Factories;

public partial class ItemFactory
{
    /// <summary>Creates an item from a recipe with quality.</summary>
    public Item CreateFromRecipe(RecipeDefinition recipe, CraftedItemQuality quality)
    {
        var baseItem = _itemProvider.GetItem(recipe.Output.ItemId);
        if (baseItem is null)
        {
            throw new ArgumentException($"Item not found: {recipe.Output.ItemId}");
        }
        
        var modifier = new QualityModifier(quality);
        
        // Create quality-enhanced item
        var item = Item.Create(
            FormatQualityItemId(baseItem.ItemId, quality),
            modifier.FormatName(baseItem.Name),
            FormatQualityDescription(baseItem.Description, quality),
            baseItem.ItemType);
        
        // Apply stat modifiers
        if (baseItem is Weapon weapon)
        {
            item.SetWeaponStats(
                modifier.ApplyToStat(weapon.AttackBonus),
                weapon.DamageDice,
                modifier.ApplyToStat(weapon.DamageBonus));
        }
        else if (baseItem is Armor armor)
        {
            item.SetArmorStats(
                modifier.ApplyToStat(armor.DefenseBonus),
                armor.ArmorType);
        }
        
        // Set value
        item.SetValue(modifier.ApplyToValue(baseItem.BaseValue));
        
        // Add quality property
        item.SetQuality(quality);
        
        // Add glow effect for legendary
        if (modifier.HasGlowEffect)
        {
            item.AddEffect(ItemEffect.Create("glow", "Emits a faint magical glow"));
        }
        
        return item;
    }
    
    private string FormatQualityDescription(string baseDesc, CraftedItemQuality quality)
    {
        return quality switch
        {
            CraftedItemQuality.Fine => 
                $"{baseDesc} This item shows superior craftsmanship.",
            CraftedItemQuality.Masterwork => 
                $"{baseDesc} This item is a masterpiece of crafting skill.",
            CraftedItemQuality.Legendary => 
                $"{baseDesc} This legendary item glows with magical energy.",
            _ => baseDesc
        };
    }
}
```

### Quality Tier Configuration

```json
{
  "$schema": "./schemas/quality-tiers.schema.json",
  "qualityTiers": [
    {
      "quality": "Standard",
      "minMargin": 0,
      "statMultiplier": 1.0,
      "valueMultiplier": 1.0,
      "namePrefix": "",
      "description": "A standard quality item."
    },
    {
      "quality": "Fine",
      "minMargin": 5,
      "statMultiplier": 1.10,
      "valueMultiplier": 1.5,
      "namePrefix": "Fine ",
      "description": "A finely crafted item showing superior workmanship."
    },
    {
      "quality": "Masterwork",
      "minMargin": 10,
      "statMultiplier": 1.25,
      "valueMultiplier": 2.5,
      "namePrefix": "Masterwork ",
      "description": "A masterwork item representing the pinnacle of craft."
    },
    {
      "quality": "Legendary",
      "minMargin": 999,
      "statMultiplier": 1.50,
      "valueMultiplier": 5.0,
      "namePrefix": "Legendary ",
      "description": "A legendary item imbued with magical essence.",
      "hasGlowEffect": true,
      "requiresNatural20": true
    }
  ],
  "failureThresholds": {
    "closeFailure": {
      "maxMargin": -1,
      "resourceLoss": 0.25
    },
    "badFailure": {
      "maxMargin": -6,
      "resourceLoss": 0.50
    }
  }
}
```

### Acceptance Criteria

- [ ] Roll margin determines quality
- [ ] Standard at DC exactly
- [ ] Fine at DC + 5
- [ ] Masterwork at DC + 10
- [ ] Legendary on natural 20
- [ ] Stat multipliers apply
- [ ] Value multipliers apply
- [ ] Quality prefix in name
- [ ] Quality descriptions
- [ ] Legendary glow effect
- [ ] Configurable thresholds
- [ ] ~8 unit tests pass

---

## Dependencies & Prerequisites

```
v0.11.1c (Recipe Discovery) - REQUIRED
    â”‚
    â””â”€â”€ Recipes & Discovery complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                          â”‚
v0.11.2 (Crafting System)                                                 â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.11.2a: Crafting Stations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: Domain, Room features                           â”‚
    â”‚       Provides: CraftingStation, station types                      â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.11.2b: Crafting Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: v0.11.2a, Recipes, DiceService                  â”‚
    â”‚       Provides: ICraftingService, CraftCommand                      â”‚
    â”‚                                                                     â”‚
    â””â”€â”€ v0.11.1c: Quality System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Dependencies: v0.11.2b, Item system
            Provides: CraftedItemQuality, quality modifiers
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.11.2a | ~4 | ~2 | ~10 | Medium |
| v0.11.2b | ~4 | ~2 | ~12 | High |
| v0.11.1c | ~3 | ~2 | ~8 | Medium |
| **Total** | **~11** | **~6** | **~30** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Quality balance | Medium | Medium | Configurable multipliers |
| Failure frustration | Medium | Low | Partial loss, not total |
| Skill investment | Low | Low | Skills affect margin |
| Station availability | Low | Medium | Multiple station types |

---

## Design Decisions (Confirmed)

### Crafting Stations

| Decision | Value | Notes |
|----------|-------|-------|
| **Station Types** | 5 | Anvil, workbench, alchemy, enchanting, cooking |
| **Station Skill** | Per station | Smithing, leatherworking, alchemy |
| **Availability** | Single-use | One craft at a time |

### Crafting Mechanics

| Decision | Value | Notes |
|----------|-------|-------|
| **Roll** | d20 + skill | Standard check |
| **Close Failure** | 25% loss | Within 5 of DC |
| **Bad Failure** | 50% loss | More than 5 below DC |

### Quality System

| Decision | Value | Notes |
|----------|-------|-------|
| **Tiers** | 4 | Standard, Fine, Masterwork, Legendary |
| **Margins** | 0, +5, +10, Nat20 | Clear thresholds |
| **Stat Bonus** | 10%, 25%, 50% | Significant upgrades |

---

## Next Steps

1. ~~**Review & Approve** - Confirm scope breakdown~~ âœ…
2. ~~**v0.11.2a Design Spec** - Create detailed design for Crafting Stations~~ âœ…
3. ~~**v0.11.2a Implementation** - Build station system~~ âœ…
4. ~~**v0.11.2b Design Spec** - Create specification for Crafting Service~~ âœ…
5. ~~**v0.11.2b Implementation** - Build crafting mechanics~~ âœ… (CraftCommand deferred)
6. **v0.11.2c Design Spec** - Create specification for Crafting Commands
7. **v0.11.2c Implementation** - Build CraftCommand (requires command infrastructure)

---

*This scope breakdown completes the v0.11.0 Crafting & Resources series. The crafting system provides meaningful gameplay where player skill investment directly affects crafting outcomes, creating a rewarding progression loop.*
