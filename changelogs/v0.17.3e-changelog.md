# Changelog: v0.17.3e - Archetype Provider Service

**Release Date:** 2026-01-30
**Phase:** Archetype System (5/6)
**Status:** Complete

---

## Overview

Implements the `IArchetypeProvider` interface and `ArchetypeProvider` infrastructure service that loads archetype definitions from `archetypes.json` and provides cached access to all archetype-related data. Also introduces the `RecommendedBuild` domain value object, `ArchetypeConfigurationDto` DTOs, and `ArchetypeConfigurationException`.

This milestone aggregates all data from v0.17.3a through v0.17.3d into a single cohesive provider:

| Component                  | Version  | Description                                           |
| -------------------------- | -------- | ----------------------------------------------------- |
| Archetype definitions      | v0.17.3a | Display metadata, combat role, resource type           |
| Resource bonuses           | v0.17.3b | HP, Stamina, Aether Pool, Movement, Special bonuses   |
| Starting abilities         | v0.17.3c | 3 abilities per archetype (Active/Passive/Stance)     |
| Specialization mappings    | v0.17.3d | Available specializations and recommended first choice |
| Recommended builds         | v0.17.3e | Optional attribute allocations for Simple mode         |

Recommended builds provide pre-configured attribute distributions for Simple mode (quick-start) character creation:

| Archetype  | Build Name          | M  | F  | Wi | Wl | S  | Total | Optimal Lineage |
| ---------- | ------------------- | -- | -- | -- | -- | -- | ----- | --------------- |
| Warrior    | Standard Warrior    | 4  | 3  | 2  | 2  | 4  | 15    | None            |
| Skirmisher | Standard Skirmisher | 3  | 4  | 3  | 2  | 3  | 15    | None            |
| Mystic     | Standard Mystic     | 2  | 3  | 4  | 4  | 2  | 15    | None            |
| Adept      | Standard Adept      | 3  | 3  | 3  | 2  | 3  | 14    | None            |

---

## Added

### Domain Layer

#### Value Objects

- **`RecommendedBuild`** (`ValueObjects/RecommendedBuild.cs`)
    - `readonly record struct` with primary constructor `(string Name, int Might, int Finesse, int Wits, int Will, int Sturdiness, Lineage? OptimalLineage)`
    - File header with `═══` borders, Version: 0.17.3e
    - Section separators: PRIVATE FIELDS, CONSTANTS, COMPUTED PROPERTIES, FACTORY METHODS, HELPER METHODS, PRIVATE HELPERS, DEBUGGING
    - Static `ILogger<RecommendedBuild>?` field for diagnostic output
    - Constants: `MinAttributeValue = 1`, `MaxAttributeValue = 10`
    - Computed properties: `TotalAttributePoints` (sum of all 5 attributes), `HasOptimalLineage` (nullable lineage check)
    - `Create()` factory method with:
        - 5 required attribute parameters + optional lineage and logger
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for name
        - `ValidateAttributeRange()` for each attribute (range [1, 10])
        - Name trimmed via `Trim()`
        - Debug logging on entry, after validation
        - Warning logging on validation failures
        - Information logging on successful creation with all properties
    - `GetDisplaySummary()`: Returns `"{Name}: M{Might} F{Finesse} Wi{Wits} Wl{Will} S{Sturdiness} ({Total} pts)"` with optional `[Optimal: {Lineage}]` suffix
    - `ToString()`: Returns `"RecommendedBuild: {Name} [M{Might} F{Finesse} Wi{Wits} Wl{Will} S{Sturdiness}]"`
    - Full XML documentation on every member with `<summary>`, `<value>`, `<remarks>`, `<param>`, `<returns>`, `<exception>`, `<example>`, `<seealso>`

### Application Layer

#### Interfaces

- **`IArchetypeProvider`** (`Interfaces/IArchetypeProvider.cs`)
    - 8 methods providing centralized access to all archetype data:
        - `GetArchetype(Archetype)`: Returns `ArchetypeDefinition?`
        - `GetAllArchetypes()`: Returns `IReadOnlyList<ArchetypeDefinition>` ordered by enum value
        - `GetResourceBonuses(Archetype)`: Returns `ArchetypeResourceBonuses` (falls back to `None`)
        - `GetStartingAbilities(Archetype)`: Returns `IReadOnlyList<ArchetypeAbilityGrant>` (falls back to empty)
        - `GetSpecializationMapping(Archetype)`: Returns `ArchetypeSpecializationMapping` (falls back to static)
        - `GetSelectionText(Archetype)`: Returns `string` (falls back to empty)
        - `GetRecommendedBuild(Archetype, Lineage?)`: Returns `RecommendedBuild?` with lineage fallback
        - `IsSpecializationAvailable(Archetype, string)`: Case-insensitive availability check
    - Full XML documentation with `<summary>`, `<param>`, `<returns>`, `<remarks>`, `<example>`, `<seealso>` on interface and all methods

#### DTOs

- **`ArchetypeConfigurationDto`** (`DTOs/ArchetypeConfigurationDto.cs`)
    - Root DTO: `ArchetypeConfigurationDto` with `List<ArchetypeDefinitionDto> Archetypes`
    - `ArchetypeDefinitionDto`: 12 fields matching JSON schema (archetypeId through recommendedBuilds)
    - `ArchetypeResourceBonusesDto`: HP, Stamina, AP, Movement bonuses + optional special bonus
    - `ArchetypeSpecialBonusDto`: BonusType, BonusValue, Description
    - `ArchetypeAbilityGrantDto`: AbilityId, AbilityName, AbilityType, Description
    - `ArchetypeSpecializationsDto`: Specializations list + RecommendedFirst
    - `ArchetypeRecommendedBuildDto`: Name, Might, Finesse, Wits, Will, Sturdiness, OptimalLineage
    - Full XML documentation on all DTOs and properties

#### Exceptions

- **`ArchetypeConfigurationException`** (`Exceptions/ArchetypeConfigurationException.cs`)
    - Inherits from `Exception`
    - Two constructors: `(string message)` and `(string message, Exception innerException)`
    - Follows `BackgroundConfigurationException` pattern

### Infrastructure Layer

#### Services

- **`ArchetypeProvider`** (`Services/ArchetypeProvider.cs`)
    - Implements `IArchetypeProvider`
    - Constants: `ExpectedArchetypeCount = 4`, `ExpectedAbilityCount = 3`, `DefaultConfigPath = "config/archetypes.json"`
    - Constructor: `(ILogger<ArchetypeProvider> logger, string? configPath = null)` with `ArgumentNullException.ThrowIfNull`
    - Double-checked locking `EnsureInitialized()` pattern for thread-safe lazy initialization
    - `LoadConfiguration()`: File existence check, JSON deserialization with `PropertyNameCaseInsensitive`, `ArchetypeConfigurationException` on failure
    - `ValidateConfiguration()`: Exact count (4), enum parsing, duplicate detection, resource type validation, ability count (3), ability type validation, specialization non-empty, missing archetype completeness check
    - `BuildCache()`: Maps DTOs to `Dictionary<Archetype, ArchetypeData>`
    - `MapDtoToArchetypeData()`: Orchestrates 5 sub-mappers:
        - `MapDefinition()`: DTO → `ArchetypeDefinition.Create()`
        - `MapResourceBonuses()`: DTO → `ArchetypeResourceBonuses.Create()` with optional special bonus
        - `MapStartingAbilities()`: DTO → `List<ArchetypeAbilityGrant>` via `ArchetypeAbilityGrant.Create()`
        - `MapSpecializationMapping()`: DTO → `ArchetypeSpecializationMapping.Create()`
        - `MapRecommendedBuilds()`: DTO → `List<RecommendedBuild>` via `RecommendedBuild.Create()` with optional lineage parsing
    - Private sealed record: `ArchetypeData(Definition, ResourceBonuses, StartingAbilities, SpecializationMapping, RecommendedBuilds)`
    - Exhaustive logging at all levels (Debug, Information, Warning, Error) per codebase convention
    - Full XML documentation on class and all methods

### Unit Tests

- **`RecommendedBuildTests`** (`ValueObjects/RecommendedBuildTests.cs`) — 22 tests
    - `Create_WithValidData_CreatesBuild`: All 6 properties verified
    - `Create_WithOptimalLineage_SetsLineage`: IronBlooded lineage set correctly
    - `Create_WithWhitespaceInName_TrimsName`: Whitespace trimming
    - `Create_WithMinimumAttributes_Succeeds`: All attributes at 1 (total 5)
    - `Create_WithMaximumAttributes_Succeeds`: All attributes at 10 (total 50)
    - `Create_WithNullName_ThrowsArgumentException`
    - `Create_WithEmptyName_ThrowsArgumentException`
    - `Create_WithWhitespaceOnlyName_ThrowsArgumentException`
    - `Create_WithMightBelowMinimum_ThrowsArgumentOutOfRangeException`
    - `Create_WithFinesseAboveMaximum_ThrowsArgumentOutOfRangeException`
    - `Create_WithWitsBelowMinimum_ThrowsArgumentOutOfRangeException`
    - `Create_WithWillAboveMaximum_ThrowsArgumentOutOfRangeException`
    - `Create_WithSturdinessBelowMinimum_ThrowsArgumentOutOfRangeException`
    - `TotalAttributePoints_StandardWarrior_Returns15`: 4+3+2+2+4=15
    - `TotalAttributePoints_StandardSkirmisher_Returns15`: 3+4+3+2+3=15
    - `TotalAttributePoints_StandardMystic_Returns15`: 2+3+4+4+2=15
    - `TotalAttributePoints_StandardAdept_Returns14`: 3+3+3+2+3=14
    - `HasOptimalLineage_WithNoLineage_ReturnsFalse`
    - `HasOptimalLineage_WithLineage_ReturnsTrue`
    - `Create_WithEachLineage_SetsOptimalLineage`: TestCase for all 4 lineages
    - `GetDisplaySummary_DefaultBuild_ReturnsFormattedString`: "Standard Warrior: M4 F3 Wi2 Wl2 S4 (15 pts)"
    - `GetDisplaySummary_WithLineage_IncludesLineageInfo`: Contains "[Optimal: IronBlooded]"
    - `ToString_ReturnsDebugFormat`: "RecommendedBuild: Standard Warrior [M4 F3 Wi2 Wl2 S4]"
    - `Equals_WithIdenticalValues_ReturnsTrue`: Value equality
    - `Equals_WithDifferentValues_ReturnsFalse`: Value inequality

- **`ArchetypeProviderTests`** (`Providers/ArchetypeProviderTests.cs`) — 25 tests
    - `Constructor_NullLogger_ThrowsArgumentNullException`
    - `Constructor_WithValidParameters_CreatesInstance`
    - `GetAllArchetypes_ReturnsFourArchetypes`: All 4 enum values present
    - `GetAllArchetypes_AllHaveRequiredData`: DisplayName, Tagline, Description, CombatRole, SelectionText, PlaystyleDescription non-empty for all
    - `GetArchetype_Warrior_ReturnsDefinition`: DisplayName, Tagline, CombatRole, PrimaryResource verified
    - `GetArchetype_Mystic_HasAetherPoolResource`: AetherPool resource, Caster / Control role
    - `GetArchetype_InvalidArchetype_ReturnsNull`
    - `GetResourceBonuses_Warrior_ReturnsCorrectBonuses`: HP+49, Stamina+5, AP+0, Movement+0
    - `GetResourceBonuses_Adept_HasSpecialBonus`: ConsumableEffectiveness +20%
    - `GetResourceBonuses_Mystic_HasAetherPoolBonus`: AP+20
    - `GetResourceBonuses_Skirmisher_HasMovementBonus`: Movement+1
    - `GetStartingAbilities_Warrior_ReturnsThreeAbilities`: power-strike, defensive-stance, iron-will
    - `GetStartingAbilities_Mystic_ReturnsThreeAbilities`: aether-bolt, aether-shield, aether-sense
    - `GetStartingAbilities_AllArchetypes_HaveThreeAbilities`
    - `GetStartingAbilities_InvalidArchetype_ReturnsEmptyList`
    - `GetSpecializationMapping_Warrior_ReturnsSixSpecs`: 6 specs, recommended: guardian
    - `GetSpecializationMapping_Mystic_ReturnsTwoSpecs`: 2 specs, recommended: elementalist
    - `GetSelectionText_Warrior_ReturnsNonEmptyText`: Contains "shield"
    - `GetSelectionText_InvalidArchetype_ReturnsEmpty`
    - `GetRecommendedBuild_Warrior_ReturnsBuild`: Standard Warrior M4 F3 Wi2 Wl2 S4 (15 pts)
    - `GetRecommendedBuild_WithLineageNoMatch_FallsBackToDefault`: Falls back to no-lineage build
    - `GetRecommendedBuild_InvalidArchetype_ReturnsNull`
    - `GetRecommendedBuild_AllArchetypes_HaveDefaultBuild`: All 4 have at least one build
    - `IsSpecializationAvailable_ValidSpec_ReturnsTrue`: guardian for Warrior
    - `IsSpecializationAvailable_InvalidSpec_ReturnsFalse`: nonexistent
    - `IsSpecializationAvailable_CrossArchetype_ReturnsFalse`: elementalist unavailable for Warrior
    - `GetAllArchetypes_WithMissingFile_ThrowsArchetypeConfigurationException`
    - `GetArchetype_IsCachedAfterFirstAccess`: Reference equality on repeated calls

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `archetype-provider`: Infrastructure service providing cached access to archetype definitions from JSON config (sortOrder: 32)
    - `recommended-build`: Pre-configured attribute allocation for quick-start character creation (sortOrder: 33)

---

## Changed

### Configuration Files

- **`config/archetypes.json`** — Added `recommendedBuilds` section to all 4 archetypes
    - Each archetype entry now includes a `recommendedBuilds` array with one default build
    - Warrior: "Standard Warrior" M4 F3 Wi2 Wl2 S4 (15 pts), optimalLineage: null
    - Skirmisher: "Standard Skirmisher" M3 F4 Wi3 Wl2 S3 (15 pts), optimalLineage: null
    - Mystic: "Standard Mystic" M2 F3 Wi4 Wl4 S2 (15 pts), optimalLineage: null
    - Adept: "Standard Adept" M3 F3 Wi3 Wl2 S3 (14 pts), optimalLineage: null

- **`config/schemas/archetypes.schema.json`** — Extended with recommended builds definition
    - Added `recommendedBuilds` as optional property in `archetypeDefinition`
    - Added `recommendedBuild` definition with:
        - Required: name, might, finesse, wits, will, sturdiness (integers, 1-10)
        - Optional: optimalLineage (oneOf null or enum ClanBorn/RuneMarked/IronBlooded/VargrKin)
    - Updated top-level and archetype definition descriptions to include "recommended attribute builds"

### Infrastructure Layer

- **`DependencyInjection.cs`** — Added `IArchetypeProvider` singleton registration
    - Registration follows existing provider pattern with `Path.Combine(configPath, "archetypes.json")`
    - Comment block: `// Archetype provider (v0.17.3e) - loads archetype definitions, resource bonuses, starting abilities, specialization mappings, and recommended builds from JSON config`

### Documentation

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.3e deliverables
    - `[x] IArchetypeProvider interface`
    - `[x] ArchetypeProvider with JSON loading`
    - `[x] Configuration file: archetypes.json`
    - `[x] RecommendedBuild value object`

---

## Design Decisions

### Provider in Infrastructure Layer

The design specification placed `ArchetypeProvider` in `Application/Services/`, but all existing providers (`BackgroundProvider`, `LineageProvider`, `AttributeProvider`) live in `Infrastructure/Services/`. The Infrastructure layer was chosen for consistency with established patterns, as these providers load from file system resources (JSON configuration files).

### DTOs in Application Layer

The design specification embedded DTOs as nested records within the provider class. The codebase pattern uses separate DTO classes in `Application/DTOs/` (matching `BackgroundConfigurationDto`, `AttributeConfigurationDto`). The codebase pattern was followed for consistency.

### RecommendedBuild as readonly record struct

Following the established pattern from v0.17.3b-d (`ArchetypeResourceBonuses`, `ArchetypeSpecialBonus`, `ArchetypeAbilityGrant`, `ArchetypeSpecializationMapping`), `RecommendedBuild` uses the `readonly record struct` pattern for value equality semantics, immutability, and zero-allocation access.

### GetRecommendedBuild Lineage Fallback

The `GetRecommendedBuild(Archetype, Lineage?)` method uses a two-step lookup:
1. First tries to find a lineage-specific build (matching `OptimalLineage`)
2. Falls back to the default build (where `HasOptimalLineage == false`)

This supports future lineage-optimized builds while always having a sensible default.

### Validation Strictness

The provider follows `BackgroundProvider`'s strict validation pattern: exact archetype count check (4), enum parsing for all IDs and resource types, duplicate detection, ability count validation (3 per archetype), ability type enum validation, specialization non-empty check, and completeness verification (all expected archetypes present). Any validation failure throws `ArchetypeConfigurationException` to prevent partial/invalid data from entering the cache.

### JSON Schema Draft-07 Consistency

The schema extension uses Draft-07 with `definitions` (not `$defs`), matching all existing schemas in the codebase.

---

## Dependencies

### Prerequisites

| Type                             | Phase    | Usage                                    |
| -------------------------------- | -------- | ---------------------------------------- |
| `Archetype`                      | v0.17.3a | Archetype identification and enum        |
| `ResourceType`                   | v0.17.3a | Primary resource type enum               |
| `AbilityType`                    | v0.17.3c | Starting ability type classification     |
| `Lineage`                        | v0.17.0a | Optional lineage for recommended builds  |
| `ArchetypeDefinition`            | v0.17.3a | Core definition entity                   |
| `ArchetypeResourceBonuses`       | v0.17.3b | Resource bonus value object              |
| `ArchetypeSpecialBonus`          | v0.17.3b | Special bonus value object               |
| `ArchetypeAbilityGrant`          | v0.17.3c | Starting ability value object            |
| `ArchetypeSpecializationMapping` | v0.17.3d | Specialization mapping value object      |

### Provides to Future Phases

| Type                  | Phase    | Usage                                              |
| --------------------- | -------- | -------------------------------------------------- |
| `IArchetypeProvider`  | v0.17.3f | Archetype Application Service uses provider        |
| `IArchetypeProvider`  | v0.17.4  | Specialization System validates via provider       |
| `IArchetypeProvider`  | v0.17.5  | Character creation workflow uses provider           |
| `RecommendedBuild`    | v0.17.3f | Application service applies recommended builds     |
| `RecommendedBuild`    | v0.17.5  | Simple mode creation uses recommended builds       |

---

## Logging Strategy

| Level       | When                                                                                          |
| ----------- | --------------------------------------------------------------------------------------------- |
| Debug       | Provider constructor with config path                                                        |
| Debug       | Configuration loading from file (byte count)                                                 |
| Debug       | Each archetype validation step with properties                                               |
| Debug       | Each archetype data mapping with component details                                           |
| Debug       | Cache building progress and final count                                                      |
| Debug       | Each public method call with parameters and return values                                    |
| Information | Provider initialization start and successful completion with archetype list                  |
| Information | RecommendedBuild creation with all properties and total points                               |
| Warning     | Unknown archetype requested (returns null/empty/fallback)                                    |
| Warning     | Unknown optimal lineage in recommended build configuration (treated as default)              |
| Error       | Configuration file not found                                                                 |
| Error       | JSON deserialization failure                                                                  |
| Error       | Validation failures (wrong count, invalid IDs, duplicates, missing archetypes)               |

---

## Files Created

| Path                                                                                    | Description                              |
| --------------------------------------------------------------------------------------- | ---------------------------------------- |
| `src/Core/RuneAndRust.Domain/ValueObjects/RecommendedBuild.cs`                          | Recommended build value object           |
| `src/Core/RuneAndRust.Application/Interfaces/IArchetypeProvider.cs`                     | Archetype provider interface             |
| `src/Core/RuneAndRust.Application/DTOs/ArchetypeConfigurationDto.cs`                    | Configuration DTOs for deserialization   |
| `src/Core/RuneAndRust.Application/Exceptions/ArchetypeConfigurationException.cs`        | Configuration exception type             |
| `src/Infrastructure/RuneAndRust.Infrastructure/Services/ArchetypeProvider.cs`           | Provider implementation                  |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/RecommendedBuildTests.cs`              | RecommendedBuild unit tests              |
| `tests/RuneAndRust.Application.UnitTests/Providers/ArchetypeProviderTests.cs`           | ArchetypeProvider unit tests             |
| `changelogs/v0.17.3e-changelog.md`                                                     | This changelog                           |

## Files Modified

| Path                                                                          | Description                                               |
| ----------------------------------------------------------------------------- | --------------------------------------------------------- |
| `config/archetypes.json`                                                      | Added recommendedBuilds section to all 4 archetypes       |
| `config/schemas/archetypes.schema.json`                                       | Added recommendedBuild definition and property            |
| `config/glossary.json`                                                        | Added 2 glossary entries (archetype-provider, recommended-build) |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs`        | Added IArchetypeProvider singleton registration           |
| `docs/design/v0.17.x/v0.17.x-overview.md`                                    | Checked off v0.17.3e deliverables                         |

---

## Notes

- Total unit tests for v0.17.3e: ~47 tests (22 RecommendedBuild + 25 ArchetypeProvider)
- The provider tests use the actual `config/archetypes.json` file with `File.Exists` guard for CI environment compatibility
- The `ArchetypeProvider` follows the `BackgroundProvider` pattern exactly: constructor → lazy EnsureInitialized → LoadConfiguration → ValidateConfiguration → BuildCache
- Thread safety is achieved via double-checked locking; once initialized, all reads are lock-free
- The Adept archetype has 14 total attribute points (not 15) reflecting its balanced/versatile design
- Recommended builds are optional in the JSON schema but are configured for all 4 archetypes in the initial release
- Future versions may add lineage-specific optimized builds (e.g., "IronBlooded Warrior" with adjusted attributes)
