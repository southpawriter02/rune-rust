# v0.17.2c Design Specification: Point-Buy Cost System

**Version:** 0.17.2c  
**Phase Name:** Point-Buy Cost System  
**Parent Version:** v0.17.2 (Attribute System)  
**Prerequisites:** v0.17.2b Complete (Allocation Mode System)  
**Estimated Tests:** ~8 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [PointBuyCost Value Object](#4-pointbuycost-value-object)
5. [PointBuyConfiguration Value Object](#5-pointbuyconfiguration-value-object)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schemas](#7-configuration-file-schemas)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `PointBuyCost` and `PointBuyConfiguration` value objects that implement the cost scaling system for Advanced mode attribute allocation. The system uses a tiered cost structure where higher attribute values cost more points, creating meaningful trade-offs during character creation.

**Cost Structure:**

- Values 2-8: 1 point each (standard tier)
- Values 9-10: 2 points each (premium tier)

### 1.2 Key Deliverables

| Category          | Items                                   |
| ----------------- | --------------------------------------- |
| **Value Objects** | `PointBuyCost`, `PointBuyConfiguration` |
| **Configuration** | `attributes.json` (pointBuy section)    |
| **Tests**         | ~8 unit tests                           |

### 1.3 Architectural Significance

- **Tiered Cost Pattern**: Premium costs for exceptional values (9-10)
- **Configuration-Driven**: Cost table loaded from JSON for easy balancing
- **Bidirectional Calculation**: Supports both spending and refunding points
- **Archetype Variance**: Different starting pools (15 standard, 14 for Adept)

---

## 2. Feature Overview

```
v0.17.2c Point-Buy Cost System
├── PointBuyCost Value Object
│   ├── TargetValue: int (2-10)
│   ├── IndividualCost: int (1 or 2)
│   └── CumulativeCost: int (total from 1)
├── PointBuyConfiguration Value Object
│   ├── StartingPoints: int (default 15)
│   ├── AdeptStartingPoints: int (14)
│   ├── MinAttributeValue: int (1)
│   ├── MaxAttributeValue: int (10)
│   └── CostTable: IReadOnlyList<PointBuyCost>
└── Cost Calculation Logic
    ├── CalculateCost(from, to): int
    ├── CanAfford(current, target, remaining): bool
    └── GetRefund(from, to): int
```

### 2.1 Scope Alignment

**In Scope:**

- `PointBuyCost` value object with target, individual, and cumulative costs
- `PointBuyConfiguration` value object with pool sizes and cost table
- Cost calculation logic for increases and decreases
- Archetype-specific starting point pools
- Configuration schema for point-buy settings

**Out of Scope:**

- Derived stat calculation → v0.17.2d
- Full allocation service → v0.17.2f
- UI integration → v0.17.5

---

## 3. Architecture Diagrams

### 3.1 Point-Buy Cost System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  POINT-BUY COST SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    Advanced Mode Attribute Allocation
           │
           │  Player adjusts attribute value
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     COST CALCULATION                                 │
├─────────────────────────────────────────────────────────────────────┤
│  Input: CurrentValue, TargetValue                                   │
│                                                                      │
│  If TargetValue > CurrentValue:                                     │
│    Calculate COST (points to spend)                                 │
│  If TargetValue < CurrentValue:                                     │
│    Calculate REFUND (points returned)                               │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     COST TABLE LOOKUP                                │
├─────────────────────────────────────────────────────────────────────┤
│  Value │ Individual │ Cumulative │  Tier                           │
│    2   │     1      │     1      │  Standard                       │
│    3   │     1      │     2      │  Standard                       │
│    4   │     1      │     3      │  Standard                       │
│    5   │     1      │     4      │  Standard                       │
│    6   │     1      │     5      │  Standard                       │
│    7   │     1      │     6      │  Standard                       │
│    8   │     1      │     7      │  Standard                       │
│    9   │     2      │     9      │  Premium                        │
│   10   │     2      │    11      │  Premium                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Cost Calculation Decision Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  COST CALCULATION DECISION FLOW                      │
└─────────────────────────────────────────────────────────────────────┘

    CalculateCost(fromValue, toValue)
           │
           ▼
    ┌──────────────────────┐
    │ fromValue == toValue?│
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
   ┌────────┐   ┌──────────────────────┐
   │Return 0│   │ toValue > fromValue? │
   └────────┘   └──────────┬───────────┘
                           │
                    ┌──────┴──────┐
                   YES            NO
                    │              │
                    ▼              ▼
           ┌─────────────┐  ┌─────────────────────────┐
           │ INCREASE    │  │ DECREASE (Refund)       │
           │             │  │                         │
           │ Sum costs   │  │ Return negative of      │
           │ from+1 to   │  │ CalculateCost(to, from) │
           │ toValue     │  │                         │
           └─────────────┘  └─────────────────────────┘
                    │
                    ▼
           ┌─────────────────────────────────────────┐
           │ For each value in (fromValue, toValue]: │
           │   If value <= 8: cost += 1              │
           │   Else: cost += 2                       │
           └─────────────────────────────────────────┘
```

### 3.3 Point Pool Management

```
┌─────────────────────────────────────────────────────────────────────┐
│                    POINT POOL MANAGEMENT                             │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation Start
           │
           ▼
    ┌──────────────────────┐
    │ Determine Archetype  │
    └──────────┬───────────┘
               │
    ┌──────────┴───────────────────────────────────────┐
    │                                                   │
    ▼                                                   ▼
┌─────────────────────┐                   ┌─────────────────────────┐
│ Adept Archetype     │                   │ Other Archetypes        │
│ StartingPoints = 14 │                   │ StartingPoints = 15     │
└─────────┬───────────┘                   └───────────┬─────────────┘
          │                                           │
          └─────────────────┬─────────────────────────┘
                            ▼
                ┌───────────────────────┐
                │ All Attributes = 1    │
                │ PointsSpent = 0       │
                │ PointsRemaining = Pool│
                └───────────────────────┘
                            │
                            ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    ALLOCATION LOOP                               │
    ├─────────────────────────────────────────────────────────────────┤
    │  Player increases Might: 1 → 4                                  │
    │    Cost = 3 points (3 × 1 point each)                           │
    │    PointsRemaining: 15 → 12                                     │
    │                                                                  │
    │  Player increases Finesse: 1 → 9                                │
    │    Cost = 9 points (7 × 1 + 2 × 2)                              │
    │    PointsRemaining: 12 → 3                                      │
    │                                                                  │
    │  Player decreases Finesse: 9 → 7                                │
    │    Refund = 4 points (2 + 2)                                    │
    │    PointsRemaining: 3 → 7                                       │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.4 Example Cost Calculations

```
┌─────────────────────────────────────────────────────────────────────┐
│                  EXAMPLE COST CALCULATIONS                           │
└─────────────────────────────────────────────────────────────────────┘

    Example 1: Standard Tier Only (1 → 5)
    ┌─────────────────────────────────────────────────────────────────┐
    │  From 1 to 5:                                                   │
    │    Value 2: +1 point                                            │
    │    Value 3: +1 point                                            │
    │    Value 4: +1 point                                            │
    │    Value 5: +1 point                                            │
    │  Total: 4 points                                                │
    └─────────────────────────────────────────────────────────────────┘

    Example 2: Reaching Premium Tier (1 → 10)
    ┌─────────────────────────────────────────────────────────────────┐
    │  From 1 to 10:                                                  │
    │    Values 2-8: 7 × 1 = 7 points                                 │
    │    Values 9-10: 2 × 2 = 4 points                                │
    │  Total: 11 points (cumulative cost for value 10)                │
    └─────────────────────────────────────────────────────────────────┘

    Example 3: Premium Tier Only (8 → 10)
    ┌─────────────────────────────────────────────────────────────────┐
    │  From 8 to 10:                                                  │
    │    Value 9: +2 points                                           │
    │    Value 10: +2 points                                          │
    │  Total: 4 points                                                │
    └─────────────────────────────────────────────────────────────────┘

    Example 4: Refund (10 → 6)
    ┌─────────────────────────────────────────────────────────────────┐
    │  From 10 to 6:                                                  │
    │    Value 10 → 9: -2 points                                      │
    │    Value 9 → 8: -2 points                                       │
    │    Value 8 → 7: -1 point                                        │
    │    Value 7 → 6: -1 point                                        │
    │  Total Refund: 6 points                                         │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. PointBuyCost Value Object

### 4.1 Purpose

The `PointBuyCost` value object represents the cost to reach a specific attribute value, including both individual increment cost and cumulative cost from base.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PointBuyCost.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the point cost to reach a specific attribute value.
/// </summary>
/// <remarks>
/// <para>
/// PointBuyCost defines the cost structure for point-buy attribute allocation.
/// Each entry specifies the cost to increment TO the target value, plus the
/// cumulative cost from the base value of 1.
/// </para>
/// <para>
/// The cost table uses tiered pricing:
/// - Standard tier (values 2-8): 1 point per increment
/// - Premium tier (values 9-10): 2 points per increment
/// </para>
/// </remarks>
/// <param name="TargetValue">The attribute value this cost applies to (2-10).</param>
/// <param name="IndividualCost">Points to increment from previous value to this value.</param>
/// <param name="CumulativeCost">Total points to reach this value from base (1).</param>
public readonly record struct PointBuyCost(
    int TargetValue,
    int IndividualCost,
    int CumulativeCost)
{
    /// <summary>Gets whether this is a premium tier value (9 or 10).</summary>
    public bool IsPremiumTier => TargetValue >= 9;

    /// <summary>Gets whether this is a standard tier value (2-8).</summary>
    public bool IsStandardTier => TargetValue >= 2 && TargetValue <= 8;

    /// <summary>Creates a PointBuyCost with validation.</summary>
    public static PointBuyCost Create(int targetValue, int individualCost, int cumulativeCost)
    {
        ArgumentOutOfRangeException.ThrowIfLessThan(targetValue, 2);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(targetValue, 10);
        ArgumentOutOfRangeException.ThrowIfNegative(individualCost);
        ArgumentOutOfRangeException.ThrowIfNegative(cumulativeCost);

        return new PointBuyCost(targetValue, individualCost, cumulativeCost);
    }

    /// <summary>Creates the default cost table.</summary>
    public static IReadOnlyList<PointBuyCost> CreateDefaultCostTable() =>
        new List<PointBuyCost>
        {
            new(2, 1, 1),
            new(3, 1, 2),
            new(4, 1, 3),
            new(5, 1, 4),
            new(6, 1, 5),
            new(7, 1, 6),
            new(8, 1, 7),
            new(9, 2, 9),
            new(10, 2, 11)
        };

    public override string ToString() =>
        $"Value {TargetValue}: {IndividualCost} pts (cumulative: {CumulativeCost})";
}
```

---

## 5. PointBuyConfiguration Value Object

### 5.1 Purpose

The `PointBuyConfiguration` value object holds all configuration for the point-buy system, including starting pools, value constraints, and the complete cost table.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PointBuyConfiguration.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Configuration for the point-buy attribute allocation system.
/// </summary>
/// <remarks>
/// <para>
/// PointBuyConfiguration provides all parameters needed for point-buy allocation:
/// starting point pools, attribute value constraints, and the cost table.
/// </para>
/// <para>
/// The Adept archetype uses a reduced starting pool (14 vs 15) to balance
/// their broader ability access with slightly lower base attributes.
/// </para>
/// </remarks>
public readonly record struct PointBuyConfiguration
{
    /// <summary>Gets the standard starting point pool (15).</summary>
    public int StartingPoints { get; init; }

    /// <summary>Gets the Adept archetype's starting point pool (14).</summary>
    public int AdeptStartingPoints { get; init; }

    /// <summary>Gets the minimum attribute value (1).</summary>
    public int MinAttributeValue { get; init; }

    /// <summary>Gets the maximum attribute value (10).</summary>
    public int MaxAttributeValue { get; init; }

    /// <summary>Gets the cost table for each target value.</summary>
    public IReadOnlyList<PointBuyCost> CostTable { get; init; }

    /// <summary>Creates the default configuration.</summary>
    public static PointBuyConfiguration CreateDefault() =>
        new()
        {
            StartingPoints = 15,
            AdeptStartingPoints = 14,
            MinAttributeValue = 1,
            MaxAttributeValue = 10,
            CostTable = PointBuyCost.CreateDefaultCostTable()
        };

    /// <summary>Gets the starting points for a specific archetype.</summary>
    public int GetStartingPointsForArchetype(string archetypeId) =>
        archetypeId.Equals("adept", StringComparison.OrdinalIgnoreCase)
            ? AdeptStartingPoints
            : StartingPoints;

    /// <summary>Calculates the cost to change an attribute value.</summary>
    /// <param name="fromValue">Current attribute value.</param>
    /// <param name="toValue">Target attribute value.</param>
    /// <returns>Points to spend (positive) or refund (negative).</returns>
    public int CalculateCost(int fromValue, int toValue)
    {
        if (fromValue == toValue) return 0;
        if (toValue < fromValue) return -CalculateCost(toValue, fromValue);

        int cost = 0;
        for (int value = fromValue + 1; value <= toValue; value++)
        {
            cost += GetIndividualCost(value);
        }
        return cost;
    }

    /// <summary>Gets the individual cost for a specific target value.</summary>
    public int GetIndividualCost(int targetValue)
    {
        if (targetValue <= MinAttributeValue) return 0;

        var costEntry = CostTable.FirstOrDefault(c => c.TargetValue == targetValue);
        return costEntry.TargetValue == targetValue
            ? costEntry.IndividualCost
            : (targetValue <= 8 ? 1 : 2);
    }

    /// <summary>Gets the cumulative cost from base to target value.</summary>
    public int GetCumulativeCost(int targetValue)
    {
        if (targetValue <= MinAttributeValue) return 0;

        var costEntry = CostTable.FirstOrDefault(c => c.TargetValue == targetValue);
        return costEntry.TargetValue == targetValue
            ? costEntry.CumulativeCost
            : CalculateCost(MinAttributeValue, targetValue);
    }

    /// <summary>Checks if a value change can be afforded.</summary>
    public bool CanAfford(int currentValue, int targetValue, int pointsRemaining)
    {
        if (targetValue < MinAttributeValue || targetValue > MaxAttributeValue)
            return false;

        var cost = CalculateCost(currentValue, targetValue);
        return cost <= pointsRemaining;
    }

    /// <summary>Gets the maximum value reachable with available points.</summary>
    public int GetMaxReachableValue(int currentValue, int pointsRemaining)
    {
        int maxValue = currentValue;
        for (int v = currentValue + 1; v <= MaxAttributeValue; v++)
        {
            if (CalculateCost(currentValue, v) <= pointsRemaining)
                maxValue = v;
            else
                break;
        }
        return maxValue;
    }
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                    | Layer  | Category     | Description                    |
| ----------------------- | ------ | ------------ | ------------------------------ |
| `PointBuyCost`          | Domain | Value Object | Cost for a single target value |
| `PointBuyConfiguration` | Domain | Value Object | Complete point-buy config      |

### 6.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── ValueObjects/
│   ├── AttributeDescription.cs         (v0.17.2a)
│   ├── AttributeAllocationState.cs     (v0.17.2b)
│   ├── PointBuyCost.cs                  ← NEW
│   └── PointBuyConfiguration.cs         ← NEW
```

---

## 7. Configuration File Schemas

### 7.1 attributes.json (Point-Buy Section)

**File:** `config/attributes.json` (extended)

```json
{
    "pointBuy": {
        "startingPoints": 15,
        "adeptStartingPoints": 14,
        "minAttributeValue": 1,
        "maxAttributeValue": 10,
        "costTable": [
            { "targetValue": 2, "individualCost": 1, "cumulativeCost": 1 },
            { "targetValue": 3, "individualCost": 1, "cumulativeCost": 2 },
            { "targetValue": 4, "individualCost": 1, "cumulativeCost": 3 },
            { "targetValue": 5, "individualCost": 1, "cumulativeCost": 4 },
            { "targetValue": 6, "individualCost": 1, "cumulativeCost": 5 },
            { "targetValue": 7, "individualCost": 1, "cumulativeCost": 6 },
            { "targetValue": 8, "individualCost": 1, "cumulativeCost": 7 },
            { "targetValue": 9, "individualCost": 2, "cumulativeCost": 9 },
            { "targetValue": 10, "individualCost": 2, "cumulativeCost": 11 }
        ]
    }
}
```

---

## 8. Logging Specifications

| Event               | Level       | Template                                        |
| ------------------- | ----------- | ----------------------------------------------- |
| Cost calculated     | Debug       | "Cost from {From} to {To}: {Cost} points"       |
| Refund calculated   | Debug       | "Refund from {From} to {To}: {Amount} points"   |
| Affordability check | Debug       | "CanAfford {Current}→{Target}: {Result}"        |
| Config loaded       | Information | "Loaded point-buy config: {StartingPoints} pts" |

---

## 9. Unit Testing Requirements

### 9.1 Test Count: ~8 tests

```csharp
[TestFixture]
public class PointBuyCostTests
{
    [Test]
    public void CreateDefaultCostTable_ReturnsNineEntries()
    {
        var table = PointBuyCost.CreateDefaultCostTable();
        table.Should().HaveCount(9);
    }

    [Test]
    [TestCase(8, false)]
    [TestCase(9, true)]
    [TestCase(10, true)]
    public void IsPremiumTier_ReturnsCorrectly(int value, bool expected)
    {
        var cost = new PointBuyCost(value, value <= 8 ? 1 : 2, 0);
        cost.IsPremiumTier.Should().Be(expected);
    }
}

[TestFixture]
public class PointBuyConfigurationTests
{
    private PointBuyConfiguration _config;

    [SetUp]
    public void Setup() => _config = PointBuyConfiguration.CreateDefault();

    [Test]
    public void CalculateCost_From1To8_Returns7Points()
    {
        var cost = _config.CalculateCost(1, 8);
        cost.Should().Be(7);
    }

    [Test]
    public void CalculateCost_From8To10_Returns4Points()
    {
        var cost = _config.CalculateCost(8, 10);
        cost.Should().Be(4); // 2 + 2
    }

    [Test]
    public void CalculateCost_From1To10_Returns11Points()
    {
        var cost = _config.CalculateCost(1, 10);
        cost.Should().Be(11);
    }

    [Test]
    public void CalculateCost_Decrease_ReturnsNegativeRefund()
    {
        var cost = _config.CalculateCost(10, 8);
        cost.Should().Be(-4);
    }

    [Test]
    public void GetStartingPointsForArchetype_Adept_Returns14()
    {
        var points = _config.GetStartingPointsForArchetype("adept");
        points.Should().Be(14);
    }

    [Test]
    public void GetStartingPointsForArchetype_Warrior_Returns15()
    {
        var points = _config.GetStartingPointsForArchetype("warrior");
        points.Should().Be(15);
    }

    [Test]
    public void CanAfford_WithSufficientPoints_ReturnsTrue()
    {
        _config.CanAfford(1, 5, 10).Should().BeTrue();
    }

    [Test]
    public void CanAfford_WithInsufficientPoints_ReturnsFalse()
    {
        _config.CanAfford(1, 10, 5).Should().BeFalse();
    }
}
```

---

## 10. Use Cases

| ID     | Use Case                | Flow                                                                   |
| ------ | ----------------------- | ---------------------------------------------------------------------- |
| UC-001 | Calculate Increase Cost | Player raises attribute → Calculate cost → Deduct from pool            |
| UC-002 | Calculate Refund        | Player lowers attribute → Calculate refund → Add to pool               |
| UC-003 | Check Affordability     | Player tries to increase → Check if affordable → Enable/disable button |

---

## 11. User Stories

**US-001:** As a player, I want to see how many points an attribute increase costs so I can plan my build.

**US-002:** As a player, I want to get points back when I lower an attribute so I can reallocate them.

**US-003:** As a player choosing Adept, I want my lower point pool reflected so I understand the trade-off.

---

## 12. Deliverable Checklist

- [ ] `PointBuyCost` value object created with all properties
- [ ] `PointBuyConfiguration` value object created with cost calculation
- [ ] Default cost table factory implemented
- [ ] Configuration JSON section added for point-buy
- [ ] ~8 unit tests implemented and passing
- [ ] XML documentation complete

---

## 13. Acceptance Criteria

### Functional

- [ ] Cost from 1→8 equals 7 points (7 × 1)
- [ ] Cost from 8→10 equals 4 points (2 × 2)
- [ ] Cost from 1→10 equals 11 points (7 + 4)
- [ ] Decrease returns negative (refund)
- [ ] Adept gets 14 starting points
- [ ] Other archetypes get 15 starting points

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~8 unit tests pass
- [ ] XML documentation complete

---

## 14. Dependencies

### Required from Previous Phases

| Type                       | Phase    | Usage                        |
| -------------------------- | -------- | ---------------------------- |
| `AttributeAllocationState` | v0.17.2b | Uses TotalPoints from config |

### Provides to Future Phases

| Type                    | Phase    | Usage                             |
| ----------------------- | -------- | --------------------------------- |
| `PointBuyConfiguration` | v0.17.2e | Provider loads and returns config |
| `PointBuyConfiguration` | v0.17.2f | Service uses for cost validation  |

---

## 15. Future Considerations

### Deferred to v0.17.2d

- Derived stat formulas using attribute values

### Deferred to v0.17.2f

- Full allocation service with point tracking
- Validation of complete allocation

### Out of Scope for v0.17.2

- Custom cost tables per campaign
- Alternative point pool sizes
- Attribute value modifiers from external sources

---

_Document Version: 1.0_  
_Last Updated: 2025-01-27_
