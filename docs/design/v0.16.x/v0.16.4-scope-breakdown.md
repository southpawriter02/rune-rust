# v0.16.4 Container Loot Generation - Scope Breakdown

**Version:** 0.16.4  
**Theme:** Container Loot Generation  
**Prerequisites:** v0.16.3 Complete (Smart Loot Generation)  
**Total Estimated Tests:** ~12 new tests

---

## Executive Summary

This version implements automatic loot generation for containers (chests, lockers, caches). Currently, container loot must be manually populated - this version adds auto-generation based on container type, room biome, and quality tier ranges. Containers remember their looted state to prevent exploitation.

The work is divided into **6 sub-phases**:

| Phase    | Name                        | Focus                                         | Est. Tests |
| -------- | --------------------------- | --------------------------------------------- | ---------- |
| v0.16.4a | Container Type System       | ContainerType enum, ContainerTypeDefinition   | ~2         |
| v0.16.4b | Container Loot Table Entity | ContainerLootTable, ContainerContents         | ~2         |
| v0.16.4c | Biome Loot Modifiers        | BiomeLootModifiers, modifier application      | ~2         |
| v0.16.4d | Container Loot Service      | IContainerLootService, ContainerLootGenerator | ~3         |
| v0.16.4e | Container State Persistence | IContainerStateRepository, save/load          | ~2         |
| v0.16.4f | Room Integration            | ContainerInfo, search/open commands           | ~1         |

---

## Feature Analysis & Categorization

### Container Types

| Feature                       | Complexity | Dependencies               | Assigned Phase |
| ----------------------------- | ---------- | -------------------------- | -------------- |
| ContainerType enum (10 types) | Low        | None                       | **v0.16.4a**   |
| ContainerTypeDefinition VO    | Medium     | ContainerType, QualityTier | **v0.16.4a**   |
| container-types.json          | Low        | ContainerTypeDefinition    | **v0.16.4a**   |

### Loot Tables

| Feature                   | Complexity | Dependencies       | Assigned Phase |
| ------------------------- | ---------- | ------------------ | -------------- |
| ContainerLootTable entity | Medium     | ContainerType      | **v0.16.4b**   |
| ContainerContents VO      | Low        | ContainerLootTable | **v0.16.4b**   |
| Looted state tracking     | Low        | ContainerLootTable | **v0.16.4b**   |

### Biome Modifiers

| Feature                    | Complexity | Dependencies       | Assigned Phase |
| -------------------------- | ---------- | ------------------ | -------------- |
| BiomeLootModifiers VO      | Medium     | None               | **v0.16.4c**   |
| Modifier application logic | Medium     | BiomeLootModifiers | **v0.16.4c**   |
| biome-loot-modifiers.json  | Low        | BiomeLootModifiers | **v0.16.4c**   |

### Loot Service

| Feature                | Complexity | Dependencies      | Assigned Phase |
| ---------------------- | ---------- | ----------------- | -------------- |
| IContainerLootService  | Medium     | All v0.16.4a-c    | **v0.16.4d**   |
| ContainerLootGenerator | Medium     | ISmartLootService | **v0.16.4d**   |
| Smart loot integration | Medium     | v0.16.3           | **v0.16.4d**   |

### Persistence

| Feature                   | Complexity | Dependencies              | Assigned Phase |
| ------------------------- | ---------- | ------------------------- | -------------- |
| IContainerStateRepository | Medium     | ContainerLootTable        | **v0.16.4e**   |
| Save/load container state | Medium     | IContainerStateRepository | **v0.16.4e**   |
| Reset for new run         | Low        | IContainerStateRepository | **v0.16.4e**   |

### Room Integration

| Feature                    | Complexity | Dependencies      | Assigned Phase |
| -------------------------- | ---------- | ----------------- | -------------- |
| ContainerInfo VO           | Low        | ContainerType     | **v0.16.4f**   |
| Room.GetContainers()       | Low        | ContainerInfo     | **v0.16.4f**   |
| Hidden container discovery | Medium     | Perception system | **v0.16.4f**   |

---

## Phase Definitions

---

## v0.16.4a: Container Type System

[v0.16.4a Design Specification](v0.16.4a-design-specification.md)

### Overview

Defines the 10 container types and their loot specifications.

### Scope

**In Scope:**

- ContainerType enum (SmallChest, MediumChest, LargeChest, BossChest, HiddenCache, Corpse, Locker, SupplyCrate, WeaponRack, ArmorStand)
- ContainerTypeDefinition value object
- container-types.json configuration

**Out of Scope:**

- Loot generation (v0.16.4d)
- Persistence (v0.16.4e)

### Key Deliverables

| Type                 | Count | Details                   |
| -------------------- | ----- | ------------------------- |
| Domain Enums         | 1     | `ContainerType`           |
| Domain Value Objects | 1     | `ContainerTypeDefinition` |
| Configuration        | 1     | `container-types.json`    |
| Unit Tests           | ~2    |                           |

### Container Specifications

| Type        | Items | Tier Range | Currency     | Special            |
| ----------- | ----- | ---------- | ------------ | ------------------ |
| SmallChest  | 1-2   | 0-1        | 10-30 gold   | —                  |
| MediumChest | 2-4   | 1-2        | 25-75 gold   | —                  |
| LargeChest  | 3-5   | 2-3        | 50-150 gold  | —                  |
| BossChest   | 4-6   | 3-4        | 100-300 gold | Myth-Forged chance |
| HiddenCache | 1-3   | 1-3        | 50-200 gold  | DC 14 to find      |
| Corpse      | 0-2   | 0-1        | 5-20 gold    | May be empty       |
| SupplyCrate | 2-3   | 0-1        | —            | Consumables only   |
| WeaponRack  | 1-2   | 1-3        | —            | Weapons only       |
| ArmorStand  | 1     | 1-3        | —            | Armor only         |

### Acceptance Criteria

- [ ] Container type has correct item count range
- [ ] Tier range enforced for each type
- [ ] ~2 unit tests pass

---

## v0.16.4b: Container Loot Table Entity

[v0.16.4b Design Specification](v0.16.4b-design-specification.md)

### Overview

Defines the entity that tracks container contents and looted state.

### Scope

**In Scope:**

- ContainerLootTable entity
- ContainerContents value object
- Looted state tracking

**Out of Scope:**

- Biome modifiers (v0.16.4c)
- Loot generation (v0.16.4d)

### Key Deliverables

| Type                 | Count | Details              |
| -------------------- | ----- | -------------------- |
| Domain Entities      | 1     | `ContainerLootTable` |
| Domain Value Objects | 1     | `ContainerContents`  |
| Unit Tests           | ~2    |                      |

### Container States

1. **Undiscovered** - Hidden containers not yet found
2. **Discovered** - Found but not opened
3. **Locked** - Requires key or lockpicking
4. **Open** - Contents visible
5. **Looted** - Already emptied

### Acceptance Criteria

- [ ] Container generates contents on first access
- [ ] Looted container returns empty on subsequent access
- [ ] ~2 unit tests pass

---

## v0.16.4c: Biome Loot Modifiers

[v0.16.4c Design Specification](v0.16.4c-design-specification.md)

### Overview

Implements biome-specific modifiers that affect loot quality and quantity.

### Scope

**In Scope:**

- BiomeLootModifiers value object
- Modifier application logic
- biome-loot-modifiers.json configuration

**Out of Scope:**

- Loot generation service (v0.16.4d)

### Key Deliverables

| Type                 | Count | Details                     |
| -------------------- | ----- | --------------------------- |
| Domain Value Objects | 1     | `BiomeLootModifiers`        |
| Configuration        | 1     | `biome-loot-modifiers.json` |
| Unit Tests           | ~2    |                             |

### Biome Modifier Examples

| Biome      | Gold | Drop Rate | Quality | Rare Chance |
| ---------- | ---- | --------- | ------- | ----------- |
| The Roots  | 1.0  | 1.0       | 0       | 0%          |
| Muspelheim | 1.2  | 0.9       | 0       | +5%         |
| Alfheim    | 1.5  | 0.7       | +1      | +15%        |
| Jötunheim  | 2.0  | 0.8       | +1      | +20%        |
| Boss Rooms | 1.5  | 1.0       | +1      | +25%        |

### Acceptance Criteria

- [ ] Gold scaled by multiplier
- [ ] Quality bonus shifts tier correctly
- [ ] ~2 unit tests pass

---

## v0.16.4d: Container Loot Service

[v0.16.4d Design Specification](v0.16.4d-design-specification.md)

### Overview

Implements the service that generates and manages container loot.

### Scope

**In Scope:**

- IContainerLootService interface
- ContainerLootGenerator class
- Smart loot integration
- Biome modifier application

**Out of Scope:**

- State persistence (v0.16.4e)
- Room integration (v0.16.4f)

### Key Deliverables

| Type                   | Count | Details                  |
| ---------------------- | ----- | ------------------------ |
| Application Interfaces | 1     | `IContainerLootService`  |
| Application Services   | 1     | `ContainerLootGenerator` |
| Unit Tests             | ~3    |                          |

### Generation Flow

```
OpenContainer(containerId, characterId):
  1. Get ContainerLootTable
  2. If IsLooted: Return empty
  3. If GeneratedContents == null:
     a. Get container type definition
     b. Get biome modifiers
     c. Get player for smart loot
     d. Generate contents
  4. Mark as looted
  5. Return contents
```

### Acceptance Criteria

- [ ] Container generates correct item count
- [ ] Biome modifiers affect generation
- [ ] Looted container returns empty
- [ ] ~3 unit tests pass

---

## v0.16.4e: Container State Persistence

[v0.16.4e Design Specification](v0.16.4e-design-specification.md)

### Overview

Implements persistence of container looted state within a run.

### Scope

**In Scope:**

- IContainerStateRepository interface
- Save/load container state
- Reset for new run

**Out of Scope:**

- Room integration (v0.16.4f)

### Key Deliverables

| Type                   | Count | Details                     |
| ---------------------- | ----- | --------------------------- |
| Application Interfaces | 1     | `IContainerStateRepository` |
| Unit Tests             | ~2    |                             |

### Persistence Strategy

- Container looted state persists within a run
- Contents generated once and cached
- Reset on new run/game

### Acceptance Criteria

- [ ] Container state persists after looting
- [ ] Reset clears all container states
- [ ] ~2 unit tests pass

---

## v0.16.4f: Room Integration

[v0.16.4f Design Specification](v0.16.4f-design-specification.md)

### Overview

Integrates containers into the room system with discovery and commands.

### Scope

**In Scope:**

- ContainerInfo value object
- Room.GetContainers() method
- Room.GetHiddenContainers() method
- Room.RevealContainer() method

**Out of Scope:**

- UI rendering (future version)

### Key Deliverables

| Type                 | Count | Details         |
| -------------------- | ----- | --------------- |
| Domain Value Objects | 1     | `ContainerInfo` |
| Modified Entities    | 1     | Update `Room`   |
| Unit Tests           | ~1    |                 |

### Container Commands

```
> search
  You search the room and find a hidden cache! (DC 14 passed)

> open chest
  You open the small chest...
  Found: Iron Sword (Scavenged), 23 gold
```

### Acceptance Criteria

- [ ] Room lists all containers
- [ ] Hidden containers require discovery
- [ ] Open command triggers loot generation
- [ ] ~1 unit tests pass (integration tested elsewhere)

---

## Dependencies & Prerequisites

```
v0.16.3 (Smart Loot Generation) - REQUIRED
    │
    └── ISmartLootService, WeightedItemPool
            │
            ▼
v0.16.4 (Container Loot Generation)
    │
    ├── v0.16.4a: Container Type System ───────────┐
    │       Dependencies: v0.16.0 (QualityTier)     │
    │                                               │
    ├── v0.16.4b: Container Loot Table Entity ─────┤
    │       Dependencies: v0.16.4a                  │
    │                                               │
    ├── v0.16.4c: Biome Loot Modifiers ────────────┤
    │       Dependencies: None                      │
    │                                               │
    ├── v0.16.4d: Container Loot Service ──────────┤
    │       Dependencies: v0.16.4a-c, v0.16.3       │
    │                                               │
    ├── v0.16.4e: Container State Persistence ─────┤
    │       Dependencies: v0.16.4b                  │
    │                                               │
    └── v0.16.4f: Room Integration ────────────────┘
            Dependencies: v0.16.4a-e
```

---

## Configuration Files

| File                        | Purpose                          | Phase    |
| --------------------------- | -------------------------------- | -------- |
| `container-types.json`      | Container type definitions       | v0.16.4a |
| `biome-loot-modifiers.json` | Biome-specific modifiers         | v0.16.4c |
| `container-placements.json` | Default containers per room type | v0.16.4f |

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.16.4a  | ~3        | 0              | ~2         | Low        |
| v0.16.4b  | ~2        | 0              | ~2         | Medium     |
| v0.16.4c  | ~2        | 0              | ~2         | Medium     |
| v0.16.4d  | ~2        | 0              | ~3         | Medium     |
| v0.16.4e  | ~2        | 0              | ~2         | Medium     |
| v0.16.4f  | ~2        | ~1             | ~1         | Low        |
| **Total** | **~13**   | **~1**         | **~12**    |            |

---

## Risk Assessment

| Risk                           | Impact | Probability | Mitigation                      |
| ------------------------------ | ------ | ----------- | ------------------------------- |
| Container respawn exploitation | High   | Low         | Strict looted state persistence |
| Biome balance issues           | Medium | Medium      | Configurable multipliers        |

---

_This scope breakdown provides a structured approach to implementing v0.16.4 Container Loot Generation. Each sub-phase builds on the previous, allowing for incremental development and testing._
