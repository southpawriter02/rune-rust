# v0.11.2b Design Specification: Crafting Service

**Version:** 0.11.2b
**Parent:** v0.11.2 (Crafting System)
**Prerequisites:** v0.11.2a Complete (Crafting Stations)
**Status:** Design In Progress

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ICraftingService Interface](#4-icraftingservice-interface)
5. [CraftingService Implementation](#5-craftingservice-implementation)
6. [Result Records](#6-result-records)
7. [Domain Events](#7-domain-events)
8. [CraftCommand Implementation](#8-craftcommand-implementation)
9. [Rendering Changes](#9-rendering-changes)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.11.2b implements the Crafting Service, the core system that handles the complete crafting process. This includes validating crafting prerequisites, executing dice checks against recipe difficulty, consuming resources, creating items on success, and applying partial resource loss on failure. The service integrates with the crafting stations from v0.11.2a and the recipe system from v0.11.1.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | ICraftingService |
| **Services** | CraftingService |
| **Commands** | CraftCommand |
| **Result Records** | CraftResult, CraftValidation, MissingResource, ResourceLoss |
| **Domain Events** | CraftAttemptedEvent, ItemCraftedEvent |
| **Tests** | ~12 new unit tests |

### Architectural Significance

This version establishes the **Crafting Dice Check Pattern** used throughout the game:
- Standard d20 + skill modifier vs DC mechanic
- Graduated failure consequences (25% vs 50% resource loss)
- Validation-first approach with detailed error feedback
- Result records for type-safe operation outcomes
- Domain events for crafting activities

---

## 2. Feature Overview

```
v0.11.2b Crafting Service Features
├── ICraftingService Interface
│   ├── CanCraft validation method
│   ├── Craft execution method
│   ├── GetCraftableRecipesHere discovery
│   ├── GetCraftingModifier skill lookup
│   ├── GetCurrentStation room query
│   └── CalculateFailureLoss resource loss
├── CraftingService Implementation
│   ├── Station presence validation
│   ├── Recipe knowledge validation
│   ├── Resource availability validation
│   ├── Crafting dice check (d20 + skill vs DC)
│   ├── Resource consumption on success
│   ├── Item creation on success
│   └── Partial resource loss on failure
├── Result Records
│   ├── CraftValidation (validation outcome)
│   ├── CraftResult (crafting outcome)
│   ├── MissingResource (what's needed)
│   └── ResourceLoss (what's lost on failure)
├── Domain Events
│   ├── CraftAttemptedEvent
│   └── ItemCraftedEvent
└── CraftCommand
    ├── Parse recipe name
    ├── Execute crafting
    ├── Display roll results
    └── Show crafted item or failure
```

---

## 3. Architecture Diagrams

### 3.1 Crafting Service Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                    CRAFTING SERVICE ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────────┘

                          PRESENTATION LAYER
                          ──────────────────
                      ┌───────────────────────────┐
                      │       CraftCommand         │
                      │   > craft iron-sword       │
                      ├───────────────────────────┤
                      │ + Name: "craft"           │
                      │ + Execute(player, args)   │
                      │ + ParseRecipeName(args)   │
                      └───────────────┬───────────┘
                                      │
                                      ▼
                          APPLICATION LAYER
                          ─────────────────

                      ┌───────────────────────────┐
                      │     ICraftingService       │
                      ├───────────────────────────┤
                      │ + CanCraft(plyr, recipe)  │
                      │ + Craft(player, recipe)   │
                      │ + GetCraftableHere(plyr)  │
                      │ + GetCraftingModifier()   │
                      │ + GetCurrentStation()     │
                      │ + CalculateFailureLoss()  │
                      └───────────────┬───────────┘
                                      │
                      ┌───────────────┴───────────┐
                      │      CraftingService       │
                      ├───────────────────────────┤
                      │ Dependencies:             │
                      │ - IRecipeProvider         │
                      │ - IRecipeService          │
                      │ - ICraftingStationProvider│
                      │ - IInventoryService       │
                      │ - IItemFactory            │
                      │ - IDiceService            │
                      │ - IEventBus               │
                      │                           │
                      │ Methods:                  │
                      │ + ValidateStation()       │
                      │ + ValidateRecipeKnown()   │
                      │ + ValidateResources()     │
                      │ + RollCraftCheck()        │
                      │ + ConsumeResources()      │
                      │ + ApplyResourceLoss()     │
                      │ + CreateCraftedItem()     │
                      │ + DetermineQuality()      │
                      └───────────────────────────┘


    RESULT RECORDS                          DOMAIN EVENTS
    ──────────────                          ─────────────

    ┌─────────────────────────┐     ┌─────────────────────────────┐
    │     CraftValidation      │     │     CraftAttemptedEvent     │
    ├─────────────────────────┤     ├─────────────────────────────┤
    │ + IsValid: bool          │     │ + PlayerId: Guid            │
    │ + Recipe: RecipeDef?     │     │ + RecipeId: string          │
    │ + Station: StationDef?   │     │ + Roll: int                 │
    │ + FailureReason: string? │     │ + Modifier: int             │
    │ + MissingResources: []   │     │ + Total: int                │
    └─────────────────────────┘     │ + DifficultyClass: int      │
                                    └─────────────────────────────┘
    ┌─────────────────────────┐
    │       CraftResult        │     ┌─────────────────────────────┐
    ├─────────────────────────┤     │      ItemCraftedEvent       │
    │ + IsSuccess: bool        │     ├─────────────────────────────┤
    │ + Roll: int              │     │ + PlayerId: Guid            │
    │ + Modifier: int          │     │ + RecipeId: string          │
    │ + Total: int             │     │ + ItemId: Guid              │
    │ + DifficultyClass: int   │     │ + ItemName: string          │
    │ + CraftedItem: Item?     │     │ + Quality: CraftedItemQuality│
    │ + Quality: Quality?      │     └─────────────────────────────┘
    │ + ResourcesLost: []      │
    │ + FailureReason: string? │
    └─────────────────────────┘

    ┌─────────────────────────┐     ┌─────────────────────────────┐
    │     MissingResource      │     │       ResourceLoss          │
    ├─────────────────────────┤     ├─────────────────────────────┤
    │ + ResourceId: string     │     │ + ResourceId: string        │
    │ + Name: string           │     │ + Name: string              │
    │ + Needed: int            │     │ + Amount: int               │
    │ + Have: int              │     └─────────────────────────────┘
    └─────────────────────────┘
```

### 3.2 Crafting Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         CRAFTING FLOW                                │
└─────────────────────────────────────────────────────────────────────┘

    > craft iron-sword
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. VALIDATE PREREQUISITES            │
    ├──────────────────────────────────────┤
    │  ┌─ Check Station                    │
    │  │  • Player at crafting station? ───┼──▶ NO ──▶ "You need to be at
    │  │  • Station supports category? ────┼──▶ NO ──▶  a crafting station."
    │  │                                   │
    │  ├─ Check Recipe                     │
    │  │  • Recipe exists? ────────────────┼──▶ NO ──▶ "Recipe not found."
    │  │  • Player knows recipe? ──────────┼──▶ NO ──▶ "You don't know this recipe."
    │  │                                   │
    │  └─ Check Resources                  │
    │     • Has Iron Ore x5? (have: 8) ✓   │
    │     • Has Leather x2? (have: 3) ✓    │
    │     • All ingredients present? ──────┼──▶ NO ──▶ "Insufficient resources:
    │                                      │            Iron Ore: need 5, have 2"
    └──────────────────────────────────────┘
           │
           │ ALL VALID
           ▼
    ┌──────────────────────────────────────┐
    │ 2. ROLL CRAFTING CHECK               │
    ├──────────────────────────────────────┤
    │                                      │
    │  Roll: 1d20 + Skill Modifier         │
    │  ┌────────────────────────────────┐  │
    │  │ d20 roll: 15                   │  │
    │  │ + Smithing modifier: +4        │  │
    │  │ ─────────────────────          │  │
    │  │ Total: 19                      │  │
    │  │ vs DC: 12                      │  │
    │  └────────────────────────────────┘  │
    │                                      │
    │  Margin: 19 - 12 = +7 (Success!)     │
    │                                      │
    │  ──▶ Publish CraftAttemptedEvent     │
    │                                      │
    └──────────────────────────────────────┘
           │
     ┌─────┴─────┐
     │           │
  SUCCESS    FAILURE
  (≥ DC)     (< DC)
     │           │
     ▼           ▼
    ┌─────────────────┐    ┌─────────────────────────────┐
    │ 3a. SUCCESS     │    │ 3b. FAILURE                 │
    ├─────────────────┤    ├─────────────────────────────┤
    │                 │    │ Calculate Loss %:           │
    │ Consume ALL     │    │                             │
    │ resources:      │    │ If margin ≥ -5 (close):     │
    │ - Iron Ore x5   │    │   Loss = 25% of each        │
    │ - Leather x2    │    │   ingredient                │
    │                 │    │                             │
    │                 │    │ If margin < -5 (bad):       │
    │                 │    │   Loss = 50% of each        │
    │                 │    │   ingredient                │
    │                 │    │                             │
    │                 │    │ Apply Loss:                 │
    │                 │    │ - Iron Ore: 2 lost          │
    │                 │    │ - Leather: 1 lost           │
    └────────┬────────┘    └──────────────┬──────────────┘
             │                            │
             ▼                            ▼
    ┌─────────────────┐    ┌─────────────────────────────┐
    │ 4a. CREATE ITEM │    │ 4b. RETURN FAILURE          │
    ├─────────────────┤    ├─────────────────────────────┤
    │                 │    │                             │
    │ Determine       │    │ Return CraftResult:         │
    │ Quality:        │    │ - IsSuccess: false          │
    │ - Roll 20: Leg. │    │ - Roll: 7                   │
    │ - Margin ≥10:   │    │ - Modifier: +2              │
    │   Masterwork    │    │ - Total: 9                  │
    │ - Margin ≥5:    │    │ - DC: 12                    │
    │   Fine          │    │ - ResourcesLost: [...]      │
    │ - Margin ≥0:    │    │                             │
    │   Standard      │    │ "Crafting failed. Some      │
    │                 │    │  materials were lost."      │
    │ Create Item:    │    │                             │
    │ + Iron Sword    │    └─────────────────────────────┘
    │   (Fine Quality)│
    │                 │
    │ Add to Inventory│
    │                 │
    │ Publish Event:  │
    │ ItemCraftedEvent│
    │                 │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ 5. RETURN       │
    ├─────────────────┤
    │ CraftResult:    │
    │ - IsSuccess:true│
    │ - Roll: 15      │
    │ - Modifier: +4  │
    │ - Total: 19     │
    │ - DC: 12        │
    │ - Item: Iron Sw.│
    │ - Quality: Fine │
    └─────────────────┘
```

### 3.3 Failure Resource Loss Calculation

```
┌─────────────────────────────────────────────────────────────────────┐
│                  FAILURE RESOURCE LOSS CALCULATION                   │
└─────────────────────────────────────────────────────────────────────┘

    ROLL MARGINS AND LOSS PERCENTAGES
    ──────────────────────────────────

    Roll Total  │  DC  │ Margin │  Loss %  │  Result
    ────────────┼──────┼────────┼──────────┼─────────────────
        17      │  12  │   +5   │   0%     │  Success (Fine)
        12      │  12  │    0   │   0%     │  Success (Standard)
        11      │  12  │   -1   │  25%     │  Close Failure
         9      │  12  │   -3   │  25%     │  Close Failure
         7      │  12  │   -5   │  25%     │  Close Failure (boundary)
         6      │  12  │   -6   │  50%     │  Bad Failure
         3      │  12  │   -9   │  50%     │  Bad Failure
         1      │  12  │  -11   │  50%     │  Bad Failure


    LOSS CALCULATION FORMULA
    ────────────────────────

    For each ingredient:
    ┌─────────────────────────────────────────────────────────────────┐
    │  lossAmount = MAX(1, CEILING(ingredientQuantity × lossPercent)) │
    └─────────────────────────────────────────────────────────────────┘

    Example Recipe: Iron Sword
    ├─ Iron Ore x5
    └─ Leather x2

    CLOSE FAILURE (25% loss):
    ┌────────────────────────────────────────────────────────────────┐
    │  Iron Ore: CEILING(5 × 0.25) = CEILING(1.25) = 2 lost          │
    │  Leather:  CEILING(2 × 0.25) = CEILING(0.5) = 1 lost           │
    │            (MIN 1 applies, so at least 1 of each)              │
    │                                                                │
    │  Player loses: 2 Iron Ore, 1 Leather                           │
    │  Player keeps: 3 Iron Ore, 1 Leather                           │
    └────────────────────────────────────────────────────────────────┘

    BAD FAILURE (50% loss):
    ┌────────────────────────────────────────────────────────────────┐
    │  Iron Ore: CEILING(5 × 0.50) = CEILING(2.5) = 3 lost           │
    │  Leather:  CEILING(2 × 0.50) = CEILING(1.0) = 1 lost           │
    │                                                                │
    │  Player loses: 3 Iron Ore, 1 Leather                           │
    │  Player keeps: 2 Iron Ore, 1 Leather                           │
    └────────────────────────────────────────────────────────────────┘


    DECISION TREE
    ─────────────

    RollCraftCheck(player, recipe)
           │
           ▼
    ┌──────────────┐
    │ total < DC ? │
    └──────┬───────┘
           │
     ┌─────┴─────┐
     │           │
    YES         NO
     │           │
     ▼           ▼
    ┌────────────────┐    ┌─────────────────┐
    │ FAILURE        │    │ SUCCESS         │
    │                │    │                 │
    │ margin = total │    │ ConsumeAll()    │
    │   - dc         │    │ CreateItem()    │
    │                │    │ DetermineQuality│
    │ margin < -5 ?  │    └─────────────────┘
    └───────┬────────┘
            │
      ┌─────┴─────┐
      │           │
     YES         NO
      │           │
      ▼           ▼
    ┌──────────┐  ┌──────────┐
    │ BAD      │  │ CLOSE    │
    │ loss=50% │  │ loss=25% │
    └──────────┘  └──────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                          │
├─────────────────────────────────────────────────────────────────────┤
│  CraftCommand              GameRenderer                              │
│  ├─ Execute(player, args)  └─ RenderCraftResultAsync()              │
│  ├─ ParseRecipeName()                                               │
│  └─ FormatCraftOutput()                                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  ICraftingService                   IEventBus                        │
│  ├─ CanCraft(player, recipeId)      └─ Publish(event)               │
│  ├─ Craft(player, recipeId)                                         │
│  ├─ GetCraftableRecipesHere()      IDiceService                     │
│  ├─ GetCraftingModifier()          └─ Roll("1d20")                  │
│  ├─ GetCurrentStation()                                             │
│  └─ CalculateFailureLoss()         IItemFactory                     │
│                                    └─ CreateFromRecipe(recipe, qual)│
│  CraftingService                                                    │
│  ├─ Dependencies                   IInventoryService                │
│  └─ Implementation                 ├─ HasResources()                │
│                                    ├─ RemoveResource()              │
│  Result Records:                   └─ AddItem()                     │
│  ├─ CraftValidation                                                 │
│  ├─ CraftResult                    IRecipeProvider                  │
│  ├─ MissingResource                └─ GetRecipe(recipeId)           │
│  └─ ResourceLoss                                                    │
│                                    IRecipeService                   │
│  Domain Events:                    └─ IsRecipeKnown(player, recipe) │
│  ├─ CraftAttemptedEvent                                             │
│  └─ ItemCraftedEvent               ICraftingStationProvider         │
│                                    └─ GetStation(stationId)         │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                               │
├─────────────────────────────────────────────────────────────────────┤
│  Player                     Room                                     │
│  ├─ Skills                  └─ GetCraftingStations()                │
│  └─ Inventory                                                        │
│                             CraftingStation                          │
│  RecipeDefinition           └─ IsAvailable                          │
│  ├─ DifficultyClass                                                 │
│  ├─ Ingredients             CraftingStationDefinition               │
│  └─ Output                  ├─ CanCraftRecipe()                     │
│                             └─ CraftingSkillId                      │
│  Item                                                               │
│  └─ Created via factory     CraftedItemQuality                      │
│                             └─ (Standard, Fine, Masterwork, Leg.)   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ICraftingService Interface

### 4.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICraftingService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for crafting items at crafting stations.
/// </summary>
/// <remarks>
/// The crafting service validates prerequisites (station, recipe knowledge, resources),
/// executes dice checks against recipe difficulty, consumes resources on success,
/// and applies partial resource loss on failure.
/// </remarks>
public interface ICraftingService
{
    /// <summary>
    /// Validates whether a player can craft a specific recipe.
    /// </summary>
    /// <param name="player">The player attempting to craft.</param>
    /// <param name="recipeId">The recipe identifier.</param>
    /// <returns>A validation result indicating success or failure with details.</returns>
    /// <remarks>
    /// Checks:
    /// 1. Player is at an appropriate crafting station
    /// 2. Player knows the recipe
    /// 3. Player has required resources
    /// </remarks>
    CraftValidation CanCraft(Player player, string recipeId);

    /// <summary>
    /// Attempts to craft an item from a recipe.
    /// </summary>
    /// <param name="player">The player attempting to craft.</param>
    /// <param name="recipeId">The recipe identifier.</param>
    /// <returns>
    /// A craft result containing success/failure status, dice roll details,
    /// created item (on success), or lost resources (on failure).
    /// </returns>
    /// <remarks>
    /// On success: Consumes all resources, creates item with quality based on roll.
    /// On failure: Applies partial resource loss (25% close, 50% bad failure).
    /// </remarks>
    CraftResult Craft(Player player, string recipeId);

    /// <summary>
    /// Gets all recipes the player can craft at their current station.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>
    /// Recipes the player knows that can be crafted at the current station.
    /// </returns>
    IReadOnlyList<RecipeDefinition> GetCraftableRecipesHere(Player player);

    /// <summary>
    /// Calculates the player's crafting modifier for a specific station.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="stationId">The station identifier.</param>
    /// <returns>
    /// The skill modifier based on the station's required crafting skill.
    /// </returns>
    int GetCraftingModifier(Player player, string stationId);

    /// <summary>
    /// Gets the crafting station in the player's current room.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>
    /// The first available crafting station in the room, or null if none.
    /// </returns>
    CraftingStation? GetCurrentStation(Player player);

    /// <summary>
    /// Calculates resource loss for a failed crafting attempt.
    /// </summary>
    /// <param name="recipe">The recipe being crafted.</param>
    /// <param name="rollMargin">The difference between roll total and DC (negative).</param>
    /// <returns>
    /// A list of resource losses to apply. Close failure (margin >= -5): 25% loss.
    /// Bad failure (margin < -5): 50% loss.
    /// </returns>
    IReadOnlyList<ResourceLoss> CalculateFailureLoss(RecipeDefinition recipe, int rollMargin);

    /// <summary>
    /// Gets recipes the player has resources for at their current station.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>
    /// Recipes that can be immediately crafted (known, at station, have resources).
    /// </returns>
    IReadOnlyList<RecipeDefinition> GetReadyToCraftRecipes(Player player);
}
```

---

## 5. CraftingService Implementation

### 5.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/CraftingService.cs`

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Implements crafting mechanics including validation, dice checks,
/// resource consumption, and item creation.
/// </summary>
public sealed class CraftingService : ICraftingService
{
    private readonly IRecipeProvider _recipeProvider;
    private readonly IRecipeService _recipeService;
    private readonly ICraftingStationProvider _stationProvider;
    private readonly IResourceProvider _resourceProvider;
    private readonly IInventoryService _inventoryService;
    private readonly IItemFactory _itemFactory;
    private readonly IDiceService _diceService;
    private readonly IGameSessionService _sessionService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<CraftingService> _logger;

    /// <summary>
    /// Resource loss percentage for close failures (within 5 of DC).
    /// </summary>
    private const float CloseFaitureLossPercent = 0.25f;

    /// <summary>
    /// Resource loss percentage for bad failures (more than 5 below DC).
    /// </summary>
    private const float BadFailureLossPercent = 0.50f;

    /// <summary>
    /// Threshold for bad failure (roll margin worse than this).
    /// </summary>
    private const int BadFailureThreshold = -5;

    /// <summary>
    /// Initializes a new instance of CraftingService.
    /// </summary>
    public CraftingService(
        IRecipeProvider recipeProvider,
        IRecipeService recipeService,
        ICraftingStationProvider stationProvider,
        IResourceProvider resourceProvider,
        IInventoryService inventoryService,
        IItemFactory itemFactory,
        IDiceService diceService,
        IGameSessionService sessionService,
        IEventBus eventBus,
        ILogger<CraftingService> logger)
    {
        _recipeProvider = recipeProvider ?? throw new ArgumentNullException(nameof(recipeProvider));
        _recipeService = recipeService ?? throw new ArgumentNullException(nameof(recipeService));
        _stationProvider = stationProvider ?? throw new ArgumentNullException(nameof(stationProvider));
        _resourceProvider = resourceProvider ?? throw new ArgumentNullException(nameof(resourceProvider));
        _inventoryService = inventoryService ?? throw new ArgumentNullException(nameof(inventoryService));
        _itemFactory = itemFactory ?? throw new ArgumentNullException(nameof(itemFactory));
        _diceService = diceService ?? throw new ArgumentNullException(nameof(diceService));
        _sessionService = sessionService ?? throw new ArgumentNullException(nameof(sessionService));
        _eventBus = eventBus ?? throw new ArgumentNullException(nameof(eventBus));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public CraftValidation CanCraft(Player player, string recipeId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));

        // Check recipe exists
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            _logger.LogDebug("Recipe not found: {RecipeId}", recipeId);
            return CraftValidation.Failed("Recipe not found.");
        }

        // Check recipe knowledge
        if (!_recipeService.IsRecipeKnown(player, recipeId))
        {
            _logger.LogDebug(
                "Player {PlayerName} doesn't know recipe: {RecipeId}",
                player.Name,
                recipeId);
            return CraftValidation.Failed("You don't know this recipe.");
        }

        // Check station
        var station = GetCurrentStation(player);
        if (station is null)
        {
            _logger.LogDebug(
                "Player {PlayerName} not at crafting station",
                player.Name);
            return CraftValidation.Failed("You need to be at a crafting station.");
        }

        var stationDef = _stationProvider.GetStation(station.DefinitionId);
        if (stationDef is null)
        {
            _logger.LogWarning(
                "Station definition not found: {DefinitionId}",
                station.DefinitionId);
            return CraftValidation.Failed("Invalid crafting station.");
        }

        if (!stationDef.CanCraftRecipe(recipe))
        {
            _logger.LogDebug(
                "Station {StationId} cannot craft {Category} recipes",
                station.DefinitionId,
                recipe.Category);
            return CraftValidation.Failed(
                $"This {station.Name} cannot craft {recipe.Category} recipes. " +
                $"You need a station that supports {recipe.Category}.");
        }

        // Check resources
        var missingResources = GetMissingResources(player, recipe);
        if (missingResources.Count > 0)
        {
            _logger.LogDebug(
                "Player {PlayerName} missing resources for {RecipeId}: {Missing}",
                player.Name,
                recipeId,
                string.Join(", ", missingResources.Select(m => $"{m.Name}:{m.Have}/{m.Needed}")));
            return CraftValidation.InsufficientResources(recipe, stationDef, missingResources);
        }

        _logger.LogDebug(
            "Player {PlayerName} can craft {RecipeId} at {StationId}",
            player.Name,
            recipeId,
            station.DefinitionId);

        return CraftValidation.Success(recipe, stationDef);
    }

    /// <inheritdoc />
    public CraftResult Craft(Player player, string recipeId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));

        // Validate prerequisites
        var validation = CanCraft(player, recipeId);
        if (!validation.IsValid)
        {
            return CraftResult.ValidationFailed(validation.FailureReason!);
        }

        var recipe = validation.Recipe!;
        var station = validation.Station!;

        // Roll craft check
        var modifier = GetCraftingModifier(player, station.StationId);
        var roll = _diceService.Roll("1d20");
        var total = roll + modifier;
        var dc = recipe.DifficultyClass;
        var margin = total - dc;

        _logger.LogInformation(
            "Player {PlayerName} rolling craft check: d20({Roll}) + {Modifier} = {Total} vs DC {DC}",
            player.Name,
            roll,
            modifier,
            total,
            dc);

        // Publish attempt event
        _eventBus.Publish(new CraftAttemptedEvent(
            player.Id,
            recipeId,
            roll,
            modifier,
            total,
            dc));

        // Handle failure
        if (total < dc)
        {
            var losses = CalculateFailureLoss(recipe, margin);
            ApplyResourceLoss(player, losses);

            _logger.LogInformation(
                "Player {PlayerName} failed craft check for {RecipeId}. " +
                "Margin: {Margin}, Resources lost: {LossCount}",
                player.Name,
                recipeId,
                margin,
                losses.Count);

            return CraftResult.Failed(roll, modifier, total, dc, losses);
        }

        // Handle success
        ConsumeResources(player, recipe);

        // Determine quality based on roll
        var quality = DetermineQuality(roll, margin);

        // Create the item
        var item = _itemFactory.CreateFromRecipe(recipe, quality);
        _inventoryService.AddItem(player.Inventory, item);

        _logger.LogInformation(
            "Player {PlayerName} crafted {ItemName} ({Quality}) from {RecipeId}",
            player.Name,
            item.Name,
            quality,
            recipeId);

        // Publish success event
        _eventBus.Publish(new ItemCraftedEvent(
            player.Id,
            recipeId,
            item.Id,
            item.Name,
            quality));

        return CraftResult.Success(roll, modifier, total, dc, item, quality);
    }

    /// <inheritdoc />
    public IReadOnlyList<RecipeDefinition> GetCraftableRecipesHere(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        var station = GetCurrentStation(player);
        if (station is null)
        {
            return [];
        }

        var stationDef = _stationProvider.GetStation(station.DefinitionId);
        if (stationDef is null)
        {
            return [];
        }

        // Get known recipes that this station supports
        var knownRecipes = _recipeService.GetKnownRecipes(player);
        return knownRecipes
            .Where(r => stationDef.CanCraftRecipe(r))
            .ToList();
    }

    /// <inheritdoc />
    public int GetCraftingModifier(Player player, string stationId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(stationId, nameof(stationId));

        var stationDef = _stationProvider.GetStation(stationId);
        if (stationDef is null)
        {
            return 0;
        }

        return player.Skills.GetModifier(stationDef.CraftingSkillId);
    }

    /// <inheritdoc />
    public CraftingStation? GetCurrentStation(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        var room = _sessionService.GetCurrentRoom(player);
        if (room is null)
        {
            return null;
        }

        return room.GetCraftingStations()
            .FirstOrDefault(s => s.IsAvailable);
    }

    /// <inheritdoc />
    public IReadOnlyList<ResourceLoss> CalculateFailureLoss(RecipeDefinition recipe, int rollMargin)
    {
        ArgumentNullException.ThrowIfNull(recipe, nameof(recipe));

        // Determine loss percentage based on how badly the roll failed
        var lossPercent = rollMargin < BadFailureThreshold
            ? BadFailureLossPercent
            : CloseFaitureLossPercent;

        return recipe.Ingredients.Select(ingredient =>
        {
            // Calculate loss amount: at least 1, rounded up
            var lossAmount = Math.Max(1, (int)Math.Ceiling(ingredient.Quantity * lossPercent));
            var resource = _resourceProvider.GetResource(ingredient.ResourceId);
            var resourceName = resource?.Name ?? ingredient.ResourceId;

            return new ResourceLoss(ingredient.ResourceId, resourceName, lossAmount);
        }).ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<RecipeDefinition> GetReadyToCraftRecipes(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        return GetCraftableRecipesHere(player)
            .Where(r => GetMissingResources(player, r).Count == 0)
            .ToList();
    }

    /// <summary>
    /// Gets resources the player is missing for a recipe.
    /// </summary>
    private IReadOnlyList<MissingResource> GetMissingResources(Player player, RecipeDefinition recipe)
    {
        var missing = new List<MissingResource>();

        foreach (var ingredient in recipe.Ingredients)
        {
            var have = _inventoryService.GetResourceCount(player.Inventory, ingredient.ResourceId);
            if (have < ingredient.Quantity)
            {
                var resource = _resourceProvider.GetResource(ingredient.ResourceId);
                var resourceName = resource?.Name ?? ingredient.ResourceId;
                missing.Add(new MissingResource(
                    ingredient.ResourceId,
                    resourceName,
                    ingredient.Quantity,
                    have));
            }
        }

        return missing;
    }

    /// <summary>
    /// Consumes all resources for a recipe from player's inventory.
    /// </summary>
    private void ConsumeResources(Player player, RecipeDefinition recipe)
    {
        foreach (var ingredient in recipe.Ingredients)
        {
            _inventoryService.RemoveResource(
                player.Inventory,
                ingredient.ResourceId,
                ingredient.Quantity);

            _logger.LogDebug(
                "Consumed {Quantity}x {ResourceId} for crafting",
                ingredient.Quantity,
                ingredient.ResourceId);
        }
    }

    /// <summary>
    /// Applies resource loss due to failed crafting.
    /// </summary>
    private void ApplyResourceLoss(Player player, IReadOnlyList<ResourceLoss> losses)
    {
        foreach (var loss in losses)
        {
            _inventoryService.RemoveResource(
                player.Inventory,
                loss.ResourceId,
                loss.Amount);

            _logger.LogDebug(
                "Lost {Amount}x {ResourceId} due to crafting failure",
                loss.Amount,
                loss.ResourceId);
        }
    }

    /// <summary>
    /// Determines item quality based on the crafting roll.
    /// </summary>
    /// <remarks>
    /// Quality tiers:
    /// - Natural 20: Legendary
    /// - Margin >= 10: Masterwork
    /// - Margin >= 5: Fine
    /// - Otherwise: Standard
    /// </remarks>
    private static CraftedItemQuality DetermineQuality(int roll, int margin)
    {
        // Natural 20 always creates legendary items
        if (roll == 20)
        {
            return CraftedItemQuality.Legendary;
        }

        // Quality based on margin above DC
        return margin switch
        {
            >= 10 => CraftedItemQuality.Masterwork,
            >= 5 => CraftedItemQuality.Fine,
            _ => CraftedItemQuality.Standard
        };
    }
}
```

---

## 6. Result Records

### 6.1 CraftValidation Record

**File:** `src/Core/RuneAndRust.Application/Results/CraftValidation.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Result of validating a crafting attempt.
/// </summary>
/// <param name="IsValid">Whether the crafting attempt is valid.</param>
/// <param name="Recipe">The recipe being crafted (null if validation failed).</param>
/// <param name="Station">The station being used (null if validation failed).</param>
/// <param name="FailureReason">Reason for validation failure (null if valid).</param>
/// <param name="MissingResources">List of missing resources (null if not resource issue).</param>
public sealed record CraftValidation(
    bool IsValid,
    RecipeDefinition? Recipe,
    CraftingStationDefinition? Station,
    string? FailureReason,
    IReadOnlyList<MissingResource>? MissingResources = null)
{
    /// <summary>
    /// Creates a successful validation result.
    /// </summary>
    /// <param name="recipe">The validated recipe.</param>
    /// <param name="station">The crafting station.</param>
    /// <returns>A successful validation result.</returns>
    public static CraftValidation Success(
        RecipeDefinition recipe,
        CraftingStationDefinition station)
    {
        return new CraftValidation(
            IsValid: true,
            Recipe: recipe,
            Station: station,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed validation result.
    /// </summary>
    /// <param name="reason">The reason for failure.</param>
    /// <returns>A failed validation result.</returns>
    public static CraftValidation Failed(string reason)
    {
        return new CraftValidation(
            IsValid: false,
            Recipe: null,
            Station: null,
            FailureReason: reason);
    }

    /// <summary>
    /// Creates a validation result for insufficient resources.
    /// </summary>
    /// <param name="recipe">The recipe being validated.</param>
    /// <param name="station">The crafting station.</param>
    /// <param name="missing">The list of missing resources.</param>
    /// <returns>A validation result with resource details.</returns>
    public static CraftValidation InsufficientResources(
        RecipeDefinition recipe,
        CraftingStationDefinition station,
        IReadOnlyList<MissingResource> missing)
    {
        return new CraftValidation(
            IsValid: false,
            Recipe: recipe,
            Station: station,
            FailureReason: "Insufficient resources.",
            MissingResources: missing);
    }

    /// <summary>
    /// Gets whether the validation failed due to missing resources.
    /// </summary>
    public bool IsMissingResources => MissingResources is { Count: > 0 };

    /// <summary>
    /// Gets a formatted string of missing resources.
    /// </summary>
    /// <returns>A string describing what resources are needed.</returns>
    public string GetMissingResourcesDisplay()
    {
        if (MissingResources is null || MissingResources.Count == 0)
        {
            return string.Empty;
        }

        return string.Join("\n", MissingResources.Select(m =>
            $"  {m.Name}: need {m.Needed}, have {m.Have}"));
    }
}
```

### 6.2 CraftResult Record

**File:** `src/Core/RuneAndRust.Application/Results/CraftResult.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Result of a crafting attempt.
/// </summary>
/// <param name="IsSuccess">Whether crafting succeeded.</param>
/// <param name="Roll">The d20 roll value.</param>
/// <param name="Modifier">The skill modifier applied.</param>
/// <param name="Total">The total roll (Roll + Modifier).</param>
/// <param name="DifficultyClass">The recipe DC.</param>
/// <param name="CraftedItem">The created item (null on failure).</param>
/// <param name="Quality">The item quality (null on failure).</param>
/// <param name="ResourcesLost">Resources lost on failure (null on success).</param>
/// <param name="FailureReason">Reason for failure (null on success).</param>
public sealed record CraftResult(
    bool IsSuccess,
    int Roll,
    int Modifier,
    int Total,
    int DifficultyClass,
    Item? CraftedItem,
    CraftedItemQuality? Quality,
    IReadOnlyList<ResourceLoss>? ResourcesLost,
    string? FailureReason)
{
    /// <summary>
    /// Creates a successful crafting result.
    /// </summary>
    /// <param name="roll">The d20 roll.</param>
    /// <param name="modifier">The skill modifier.</param>
    /// <param name="total">The total roll.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="item">The crafted item.</param>
    /// <param name="quality">The item quality.</param>
    /// <returns>A successful craft result.</returns>
    public static CraftResult Success(
        int roll,
        int modifier,
        int total,
        int dc,
        Item item,
        CraftedItemQuality quality)
    {
        return new CraftResult(
            IsSuccess: true,
            Roll: roll,
            Modifier: modifier,
            Total: total,
            DifficultyClass: dc,
            CraftedItem: item,
            Quality: quality,
            ResourcesLost: null,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed crafting result (dice check failed).
    /// </summary>
    /// <param name="roll">The d20 roll.</param>
    /// <param name="modifier">The skill modifier.</param>
    /// <param name="total">The total roll.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="losses">Resources lost due to failure.</param>
    /// <returns>A failed craft result.</returns>
    public static CraftResult Failed(
        int roll,
        int modifier,
        int total,
        int dc,
        IReadOnlyList<ResourceLoss> losses)
    {
        return new CraftResult(
            IsSuccess: false,
            Roll: roll,
            Modifier: modifier,
            Total: total,
            DifficultyClass: dc,
            CraftedItem: null,
            Quality: null,
            ResourcesLost: losses,
            FailureReason: "Crafting failed. Some materials were lost.");
    }

    /// <summary>
    /// Creates a result for validation failure (no dice roll).
    /// </summary>
    /// <param name="reason">The validation failure reason.</param>
    /// <returns>A validation failed result.</returns>
    public static CraftResult ValidationFailed(string reason)
    {
        return new CraftResult(
            IsSuccess: false,
            Roll: 0,
            Modifier: 0,
            Total: 0,
            DifficultyClass: 0,
            CraftedItem: null,
            Quality: null,
            ResourcesLost: null,
            FailureReason: reason);
    }

    /// <summary>
    /// Gets whether this was a dice roll failure vs validation failure.
    /// </summary>
    public bool WasDiceRollFailure => !IsSuccess && Roll > 0;

    /// <summary>
    /// Gets the margin (how much the roll beat or missed the DC).
    /// </summary>
    public int Margin => Total - DifficultyClass;

    /// <summary>
    /// Gets whether this was a close failure (within 5 of DC).
    /// </summary>
    public bool IsCloseFailure => WasDiceRollFailure && Margin >= -5;

    /// <summary>
    /// Gets whether this was a bad failure (more than 5 below DC).
    /// </summary>
    public bool IsBadFailure => WasDiceRollFailure && Margin < -5;

    /// <summary>
    /// Gets the total resources lost count.
    /// </summary>
    public int TotalResourcesLost => ResourcesLost?.Sum(r => r.Amount) ?? 0;

    /// <summary>
    /// Gets a formatted string showing the dice roll details.
    /// </summary>
    /// <returns>A string like "d20(15) + 4 = 19 vs DC 12".</returns>
    public string GetRollDisplay()
    {
        if (Roll == 0)
        {
            return string.Empty;
        }

        var modifierSign = Modifier >= 0 ? "+" : "";
        return $"d20({Roll}) {modifierSign}{Modifier} = {Total} vs DC {DifficultyClass}";
    }
}
```

### 6.3 MissingResource and ResourceLoss Records

**File:** `src/Core/RuneAndRust.Application/Results/CraftingRecords.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Represents a resource the player is missing for crafting.
/// </summary>
/// <param name="ResourceId">The resource identifier.</param>
/// <param name="Name">The display name of the resource.</param>
/// <param name="Needed">The quantity needed for the recipe.</param>
/// <param name="Have">The quantity the player currently has.</param>
public sealed record MissingResource(
    string ResourceId,
    string Name,
    int Needed,
    int Have)
{
    /// <summary>
    /// Gets how many more of this resource are needed.
    /// </summary>
    public int Shortage => Needed - Have;

    /// <summary>
    /// Gets a formatted display string.
    /// </summary>
    public string ToDisplayString() => $"{Name}: need {Needed}, have {Have}";
}

/// <summary>
/// Represents resource loss from a failed crafting attempt.
/// </summary>
/// <param name="ResourceId">The resource identifier.</param>
/// <param name="Name">The display name of the resource.</param>
/// <param name="Amount">The quantity lost.</param>
public sealed record ResourceLoss(
    string ResourceId,
    string Name,
    int Amount)
{
    /// <summary>
    /// Gets a formatted display string.
    /// </summary>
    public string ToDisplayString() => $"{Name} x{Amount}";
}
```

---

## 7. Domain Events

### 7.1 CraftAttemptedEvent

**File:** `src/Core/RuneAndRust.Domain/Events/CraftAttemptedEvent.cs`

```csharp
namespace RuneAndRust.Domain.Events;

/// <summary>
/// Event raised when a player attempts to craft an item.
/// </summary>
/// <param name="PlayerId">The player who attempted crafting.</param>
/// <param name="RecipeId">The recipe being crafted.</param>
/// <param name="Roll">The d20 roll value.</param>
/// <param name="Modifier">The skill modifier applied.</param>
/// <param name="Total">The total roll result.</param>
/// <param name="DifficultyClass">The recipe's difficulty class.</param>
public sealed record CraftAttemptedEvent(
    Guid PlayerId,
    string RecipeId,
    int Roll,
    int Modifier,
    int Total,
    int DifficultyClass) : IDomainEvent
{
    /// <summary>
    /// Gets the timestamp when the event occurred.
    /// </summary>
    public DateTime OccurredAt { get; } = DateTime.UtcNow;

    /// <summary>
    /// Gets whether the crafting attempt succeeded.
    /// </summary>
    public bool WasSuccessful => Total >= DifficultyClass;

    /// <summary>
    /// Gets the margin (how much the roll beat or missed the DC).
    /// </summary>
    public int Margin => Total - DifficultyClass;

    /// <summary>
    /// Gets whether this was a natural 20 roll.
    /// </summary>
    public bool IsNatural20 => Roll == 20;
}
```

### 7.2 ItemCraftedEvent

**File:** `src/Core/RuneAndRust.Domain/Events/ItemCraftedEvent.cs`

```csharp
namespace RuneAndRust.Domain.Events;

/// <summary>
/// Event raised when a player successfully crafts an item.
/// </summary>
/// <param name="PlayerId">The player who crafted the item.</param>
/// <param name="RecipeId">The recipe used.</param>
/// <param name="ItemId">The unique ID of the created item.</param>
/// <param name="ItemName">The name of the created item.</param>
/// <param name="Quality">The quality tier of the crafted item.</param>
public sealed record ItemCraftedEvent(
    Guid PlayerId,
    string RecipeId,
    Guid ItemId,
    string ItemName,
    CraftedItemQuality Quality) : IDomainEvent
{
    /// <summary>
    /// Gets the timestamp when the event occurred.
    /// </summary>
    public DateTime OccurredAt { get; } = DateTime.UtcNow;

    /// <summary>
    /// Gets whether the crafted item is of exceptional quality.
    /// </summary>
    public bool IsExceptionalQuality =>
        Quality is CraftedItemQuality.Masterwork or CraftedItemQuality.Legendary;
}
```

---

## 8. CraftCommand Implementation

### 8.1 Command Implementation

**File:** `src/Presentation/RuneAndRust.Presentation/Commands/CraftCommand.cs`

```csharp
namespace RuneAndRust.Presentation.Commands;

/// <summary>
/// Command for crafting items at crafting stations.
/// </summary>
/// <remarks>
/// Usage:
/// - "craft" - Lists recipes available at current station
/// - "craft [recipe-name]" - Attempts to craft the specified recipe
/// </remarks>
public sealed class CraftCommand : IGameCommand
{
    private readonly ICraftingService _craftingService;
    private readonly IRecipeProvider _recipeProvider;
    private readonly ILogger<CraftCommand> _logger;

    /// <inheritdoc />
    public string Name => "craft";

    /// <inheritdoc />
    public string Description => "Craft an item at a crafting station";

    /// <inheritdoc />
    public string Usage => "craft [recipe-name]";

    /// <inheritdoc />
    public IReadOnlyList<string> Aliases => ["make", "create"];

    /// <summary>
    /// Initializes a new instance of CraftCommand.
    /// </summary>
    public CraftCommand(
        ICraftingService craftingService,
        IRecipeProvider recipeProvider,
        ILogger<CraftCommand> logger)
    {
        _craftingService = craftingService ?? throw new ArgumentNullException(nameof(craftingService));
        _recipeProvider = recipeProvider ?? throw new ArgumentNullException(nameof(recipeProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public CommandResult Execute(Player player, string[] args)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        // No arguments - list available recipes
        if (args.Length == 0)
        {
            return ListAvailableRecipes(player);
        }

        // Parse recipe name
        var recipeName = ParseRecipeName(args);

        _logger.LogDebug(
            "Player {PlayerName} attempting to craft: {RecipeName}",
            player.Name,
            recipeName);

        // Attempt to craft
        var result = _craftingService.Craft(player, recipeName);

        return FormatCraftResult(result, recipeName);
    }

    /// <summary>
    /// Lists recipes available at the player's current station.
    /// </summary>
    private CommandResult ListAvailableRecipes(Player player)
    {
        var station = _craftingService.GetCurrentStation(player);
        if (station is null)
        {
            return CommandResult.Info(
                "You need to be at a crafting station to craft.\n" +
                "Find a station like an Anvil, Workbench, or Alchemy Table.");
        }

        var recipes = _craftingService.GetCraftableRecipesHere(player);
        if (recipes.Count == 0)
        {
            return CommandResult.Info(
                $"You don't know any recipes that can be crafted at this {station.Name}.\n" +
                "Discover recipes by finding recipe scrolls or learning from NPCs.");
        }

        var readyRecipes = _craftingService.GetReadyToCraftRecipes(player);

        var output = new StringBuilder();
        output.AppendLine($"═══ RECIPES AT {station.Name.ToUpperInvariant()} ═══");
        output.AppendLine();

        foreach (var recipe in recipes)
        {
            var isReady = readyRecipes.Contains(recipe);
            var readyMark = isReady ? "[READY] " : "";
            output.AppendLine($"  {readyMark}{recipe.Name} (DC {recipe.DifficultyClass})");
        }

        output.AppendLine();
        output.AppendLine("Type 'craft <recipe-name>' to craft an item.");

        return CommandResult.Success(output.ToString());
    }

    /// <summary>
    /// Parses recipe name from command arguments.
    /// </summary>
    private static string ParseRecipeName(string[] args)
    {
        // Join args with dashes for kebab-case recipe IDs
        return string.Join("-", args).ToLowerInvariant();
    }

    /// <summary>
    /// Formats the craft result for display.
    /// </summary>
    private static CommandResult FormatCraftResult(CraftResult result, string recipeName)
    {
        var output = new StringBuilder();

        // Validation failure (no dice roll)
        if (!result.WasDiceRollFailure && !result.IsSuccess)
        {
            output.AppendLine($"═══ CRAFTING: {recipeName} ═══");
            output.AppendLine();
            output.AppendLine($"✗ {result.FailureReason}");
            return CommandResult.Failure(output.ToString());
        }

        output.AppendLine($"═══ CRAFTING: {recipeName} ═══");
        output.AppendLine();

        // Show dice roll
        output.AppendLine("Crafting Check:");
        output.AppendLine($"  {result.GetRollDisplay()}");
        output.AppendLine();

        if (result.IsSuccess)
        {
            // Success output
            output.AppendLine($"✓ SUCCESS! ({result.Quality} Quality)");
            output.AppendLine();
            output.AppendLine("You successfully craft:");
            output.AppendLine($"  {result.CraftedItem!.Name}");

            if (result.Quality is CraftedItemQuality.Legendary)
            {
                output.AppendLine();
                output.AppendLine("★ LEGENDARY! The item glows with magical energy!");
            }
            else if (result.Quality is CraftedItemQuality.Masterwork)
            {
                output.AppendLine();
                output.AppendLine("★ Masterwork! An exceptional piece of craftsmanship!");
            }

            return CommandResult.Success(output.ToString());
        }
        else
        {
            // Failure output
            var failureType = result.IsBadFailure ? "BAD FAILURE" : "FAILURE";
            output.AppendLine($"✗ {failureType}");
            output.AppendLine();
            output.AppendLine(result.FailureReason);
            output.AppendLine();

            if (result.ResourcesLost is { Count: > 0 })
            {
                output.AppendLine("Resources lost:");
                foreach (var loss in result.ResourcesLost)
                {
                    output.AppendLine($"  - {loss.ToDisplayString()}");
                }
            }

            return CommandResult.Failure(output.ToString());
        }
    }
}
```

---

## 9. Rendering Changes

### 9.1 Craft Command Display Examples

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CRAFT COMMAND OUTPUT                            │
└─────────────────────────────────────────────────────────────────────┘

    LIST RECIPES (NO ARGUMENT)
    ──────────────────────────

    > craft

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ RECIPES AT ANVIL ═══                                         ║
    ║                                                                   ║
    ║    [READY] Iron Sword (DC 12)                                     ║
    ║    [READY] Iron Dagger (DC 8)                                     ║
    ║    Steel Sword (DC 15)                                            ║
    ║    Iron Helmet (DC 14)                                            ║
    ║                                                                   ║
    ║  Type 'craft <recipe-name>' to craft an item.                    ║
    ╚═══════════════════════════════════════════════════════════════════╝


    SUCCESSFUL CRAFT
    ────────────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  Crafting Check:                                                  ║
    ║    d20(15) +4 = 19 vs DC 12                                       ║
    ║                                                                   ║
    ║  ✓ SUCCESS! (Fine Quality)                                        ║
    ║                                                                   ║
    ║  You successfully craft:                                          ║
    ║    Fine Iron Sword                                                ║
    ╚═══════════════════════════════════════════════════════════════════╝


    LEGENDARY CRAFT (NATURAL 20)
    ────────────────────────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  Crafting Check:                                                  ║
    ║    d20(20) +4 = 24 vs DC 12                                       ║
    ║                                                                   ║
    ║  ✓ SUCCESS! (Legendary Quality)                                   ║
    ║                                                                   ║
    ║  You successfully craft:                                          ║
    ║    Legendary Iron Sword                                           ║
    ║                                                                   ║
    ║  ★ LEGENDARY! The item glows with magical energy!                 ║
    ╚═══════════════════════════════════════════════════════════════════╝


    CLOSE FAILURE (25% LOSS)
    ────────────────────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  Crafting Check:                                                  ║
    ║    d20(7) +2 = 9 vs DC 12                                         ║
    ║                                                                   ║
    ║  ✗ FAILURE                                                        ║
    ║                                                                   ║
    ║  Crafting failed. Some materials were lost.                       ║
    ║                                                                   ║
    ║  Resources lost:                                                  ║
    ║    - Iron Ore x2                                                  ║
    ║    - Leather x1                                                   ║
    ╚═══════════════════════════════════════════════════════════════════╝


    BAD FAILURE (50% LOSS)
    ──────────────────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  Crafting Check:                                                  ║
    ║    d20(2) +2 = 4 vs DC 12                                         ║
    ║                                                                   ║
    ║  ✗ BAD FAILURE                                                    ║
    ║                                                                   ║
    ║  Crafting failed. Some materials were lost.                       ║
    ║                                                                   ║
    ║  Resources lost:                                                  ║
    ║    - Iron Ore x3                                                  ║
    ║    - Leather x1                                                   ║
    ╚═══════════════════════════════════════════════════════════════════╝


    VALIDATION FAILURE
    ──────────────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  ✗ Insufficient resources.                                        ║
    ║                                                                   ║
    ║  Missing:                                                         ║
    ║    Iron Ore: need 5, have 2                                       ║
    ╚═══════════════════════════════════════════════════════════════════╝


    NO STATION
    ──────────

    > craft iron-sword

    ╔═══════════════════════════════════════════════════════════════════╗
    ║  ═══ CRAFTING: iron-sword ═══                                     ║
    ║                                                                   ║
    ║  ✗ You need to be at a crafting station.                         ║
    ╚═══════════════════════════════════════════════════════════════════╝
```

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `CraftingService` | Information | Crafting roll, success/failure with details |
| `CraftingService` | Debug | Validation steps, resource consumption |
| `CraftingService` | Warning | Station definition not found |
| `CraftCommand` | Debug | Command execution, recipe parsing |

### 10.2 Log Message Templates

```csharp
// CraftingService - Validation
_logger.LogDebug("Recipe not found: {RecipeId}", recipeId);

_logger.LogDebug(
    "Player {PlayerName} doesn't know recipe: {RecipeId}",
    player.Name,
    recipeId);

_logger.LogDebug(
    "Player {PlayerName} not at crafting station",
    player.Name);

_logger.LogWarning(
    "Station definition not found: {DefinitionId}",
    station.DefinitionId);

_logger.LogDebug(
    "Station {StationId} cannot craft {Category} recipes",
    station.DefinitionId,
    recipe.Category);

_logger.LogDebug(
    "Player {PlayerName} missing resources for {RecipeId}: {Missing}",
    player.Name,
    recipeId,
    string.Join(", ", missingResources.Select(m => $"{m.Name}:{m.Have}/{m.Needed}")));

_logger.LogDebug(
    "Player {PlayerName} can craft {RecipeId} at {StationId}",
    player.Name,
    recipeId,
    station.DefinitionId);

// CraftingService - Crafting
_logger.LogInformation(
    "Player {PlayerName} rolling craft check: d20({Roll}) + {Modifier} = {Total} vs DC {DC}",
    player.Name,
    roll,
    modifier,
    total,
    dc);

_logger.LogInformation(
    "Player {PlayerName} failed craft check for {RecipeId}. " +
    "Margin: {Margin}, Resources lost: {LossCount}",
    player.Name,
    recipeId,
    margin,
    losses.Count);

_logger.LogInformation(
    "Player {PlayerName} crafted {ItemName} ({Quality}) from {RecipeId}",
    player.Name,
    item.Name,
    quality,
    recipeId);

_logger.LogDebug(
    "Consumed {Quantity}x {ResourceId} for crafting",
    ingredient.Quantity,
    ingredient.ResourceId);

_logger.LogDebug(
    "Lost {Amount}x {ResourceId} due to crafting failure",
    loss.Amount,
    loss.ResourceId);

// CraftCommand
_logger.LogDebug(
    "Player {PlayerName} attempting to craft: {RecipeName}",
    player.Name,
    recipeName);
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| CraftingService.CanCraft | ~4 |
| CraftingService.Craft | ~4 |
| CraftingService.CalculateFailureLoss | ~2 |
| Result Records | ~2 |
| **Total** | **~12** |

### 11.2 CraftingServiceCanCraftTests

**File:** `tests/RuneAndRust.Tests/Application/Services/CraftingServiceCanCraftTests.cs`

```csharp
[TestFixture]
public class CraftingServiceCanCraftTests
{
    private Mock<IRecipeProvider> _recipeProviderMock;
    private Mock<IRecipeService> _recipeServiceMock;
    private Mock<ICraftingStationProvider> _stationProviderMock;
    private Mock<IInventoryService> _inventoryServiceMock;
    private Mock<IGameSessionService> _sessionServiceMock;
    private CraftingService _service;

    [SetUp]
    public void SetUp()
    {
        _recipeProviderMock = new Mock<IRecipeProvider>();
        _recipeServiceMock = new Mock<IRecipeService>();
        _stationProviderMock = new Mock<ICraftingStationProvider>();
        _inventoryServiceMock = new Mock<IInventoryService>();
        _sessionServiceMock = new Mock<IGameSessionService>();

        _service = new CraftingService(
            _recipeProviderMock.Object,
            _recipeServiceMock.Object,
            _stationProviderMock.Object,
            Mock.Of<IResourceProvider>(),
            _inventoryServiceMock.Object,
            Mock.Of<IItemFactory>(),
            Mock.Of<IDiceService>(),
            _sessionServiceMock.Object,
            Mock.Of<IEventBus>(),
            Mock.Of<ILogger<CraftingService>>());
    }

    [Test]
    public void CanCraft_RecipeNotFound_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        _recipeProviderMock.Setup(p => p.GetRecipe("unknown"))
            .Returns((RecipeDefinition?)null);

        // Act
        var result = _service.CanCraft(player, "unknown");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsValid, Is.False);
            Assert.That(result.FailureReason, Is.EqualTo("Recipe not found."));
        });
    }

    [Test]
    public void CanCraft_RecipeNotKnown_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        var recipe = CreateTestRecipe("iron-sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword"))
            .Returns(recipe);
        _recipeServiceMock.Setup(s => s.IsRecipeKnown(player, "iron-sword"))
            .Returns(false);

        // Act
        var result = _service.CanCraft(player, "iron-sword");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsValid, Is.False);
            Assert.That(result.FailureReason, Is.EqualTo("You don't know this recipe."));
        });
    }

    [Test]
    public void CanCraft_NoStation_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        var recipe = CreateTestRecipe("iron-sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword"))
            .Returns(recipe);
        _recipeServiceMock.Setup(s => s.IsRecipeKnown(player, "iron-sword"))
            .Returns(true);
        _sessionServiceMock.Setup(s => s.GetCurrentRoom(player))
            .Returns(CreateEmptyRoom());

        // Act
        var result = _service.CanCraft(player, "iron-sword");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsValid, Is.False);
            Assert.That(result.FailureReason, Is.EqualTo("You need to be at a crafting station."));
        });
    }

    [Test]
    public void CanCraft_AllValid_ReturnsSuccess()
    {
        // Arrange
        var player = CreateTestPlayer();
        var recipe = CreateTestRecipe("iron-sword", RecipeCategory.Weapon);
        var station = CreateTestStation("anvil", RecipeCategory.Weapon);
        var stationDef = CreateTestStationDefinition("anvil", RecipeCategory.Weapon);

        SetupValidCraftScenario(player, recipe, station, stationDef);

        // Act
        var result = _service.CanCraft(player, "iron-sword");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsValid, Is.True);
            Assert.That(result.Recipe, Is.EqualTo(recipe));
            Assert.That(result.Station, Is.EqualTo(stationDef));
        });
    }

    // Helper methods...
    private static Player CreateTestPlayer() => Player.Create("Test Player");
    private static RecipeDefinition CreateTestRecipe(string id, RecipeCategory? cat = null) =>
        RecipeDefinition.Create(id, "Test Recipe", cat ?? RecipeCategory.Weapon, 12);
    private static CraftingStation CreateTestStation(string defId, RecipeCategory cat) =>
        CraftingStation.Create(CreateTestStationDefinition(defId, cat));
    private static CraftingStationDefinition CreateTestStationDefinition(string id, RecipeCategory cat) =>
        CraftingStationDefinition.Create(id, "Test Station", "Desc", new[] { cat }, "smithing");
    private static Room CreateEmptyRoom() => Room.Create("test", "Test Room", "Desc");
}
```

### 11.3 CraftingServiceCraftTests

**File:** `tests/RuneAndRust.Tests/Application/Services/CraftingServiceCraftTests.cs`

```csharp
[TestFixture]
public class CraftingServiceCraftTests
{
    private Mock<IDiceService> _diceServiceMock;
    private Mock<IItemFactory> _itemFactoryMock;
    private Mock<IInventoryService> _inventoryServiceMock;
    private Mock<IEventBus> _eventBusMock;
    private CraftingService _service;

    [SetUp]
    public void SetUp()
    {
        _diceServiceMock = new Mock<IDiceService>();
        _itemFactoryMock = new Mock<IItemFactory>();
        _inventoryServiceMock = new Mock<IInventoryService>();
        _eventBusMock = new Mock<IEventBus>();

        // Setup service with mocks...
    }

    [Test]
    public void Craft_RollSucceeds_ReturnsSuccessWithItem()
    {
        // Arrange
        SetupValidScenario();
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(15);
        var item = Item.Create("iron-sword", "Iron Sword", "A sword", ItemType.Weapon);
        _itemFactoryMock.Setup(f => f.CreateFromRecipe(It.IsAny<RecipeDefinition>(), It.IsAny<CraftedItemQuality>()))
            .Returns(item);

        // Act
        var result = _service.Craft(_player, "iron-sword");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.True);
            Assert.That(result.Roll, Is.EqualTo(15));
            Assert.That(result.CraftedItem, Is.Not.Null);
            Assert.That(result.Quality, Is.EqualTo(CraftedItemQuality.Standard));
        });
    }

    [Test]
    public void Craft_RollFails_ReturnsFailureWithResourceLoss()
    {
        // Arrange
        SetupValidScenario();
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(5); // DC 12, so fail

        // Act
        var result = _service.Craft(_player, "iron-sword");

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.False);
            Assert.That(result.WasDiceRollFailure, Is.True);
            Assert.That(result.ResourcesLost, Is.Not.Empty);
        });
    }

    [Test]
    public void Craft_Natural20_ReturnsLegendaryQuality()
    {
        // Arrange
        SetupValidScenario();
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(20);
        var item = Item.Create("iron-sword", "Legendary Iron Sword", "A sword", ItemType.Weapon);
        _itemFactoryMock.Setup(f => f.CreateFromRecipe(It.IsAny<RecipeDefinition>(), CraftedItemQuality.Legendary))
            .Returns(item);

        // Act
        var result = _service.Craft(_player, "iron-sword");

        // Assert
        Assert.That(result.Quality, Is.EqualTo(CraftedItemQuality.Legendary));
    }

    [Test]
    public void Craft_PublishesCraftAttemptedEvent()
    {
        // Arrange
        SetupValidScenario();
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(15);

        // Act
        _service.Craft(_player, "iron-sword");

        // Assert
        _eventBusMock.Verify(b => b.Publish(It.Is<CraftAttemptedEvent>(e =>
            e.RecipeId == "iron-sword" &&
            e.Roll == 15)), Times.Once);
    }
}
```

### 11.4 CalculateFailureLossTests

**File:** `tests/RuneAndRust.Tests/Application/Services/CraftingServiceFailureLossTests.cs`

```csharp
[TestFixture]
public class CraftingServiceFailureLossTests
{
    private CraftingService _service;
    private Mock<IResourceProvider> _resourceProviderMock;

    [SetUp]
    public void SetUp()
    {
        _resourceProviderMock = new Mock<IResourceProvider>();
        // Setup service...
    }

    [Test]
    public void CalculateFailureLoss_CloseFailure_Returns25PercentLoss()
    {
        // Arrange
        var recipe = CreateRecipeWithIngredients(
            ("iron-ore", 5),
            ("leather", 2));
        var margin = -3; // Close failure (within 5 of DC)

        // Act
        var losses = _service.CalculateFailureLoss(recipe, margin);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(losses, Has.Count.EqualTo(2));
            // Iron Ore: ceil(5 * 0.25) = 2
            Assert.That(losses[0].Amount, Is.EqualTo(2));
            // Leather: ceil(2 * 0.25) = 1 (min 1)
            Assert.That(losses[1].Amount, Is.EqualTo(1));
        });
    }

    [Test]
    public void CalculateFailureLoss_BadFailure_Returns50PercentLoss()
    {
        // Arrange
        var recipe = CreateRecipeWithIngredients(
            ("iron-ore", 5),
            ("leather", 2));
        var margin = -8; // Bad failure (more than 5 below DC)

        // Act
        var losses = _service.CalculateFailureLoss(recipe, margin);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(losses, Has.Count.EqualTo(2));
            // Iron Ore: ceil(5 * 0.50) = 3
            Assert.That(losses[0].Amount, Is.EqualTo(3));
            // Leather: ceil(2 * 0.50) = 1
            Assert.That(losses[1].Amount, Is.EqualTo(1));
        });
    }

    private static RecipeDefinition CreateRecipeWithIngredients(params (string id, int qty)[] ingredients)
    {
        // Create recipe with specified ingredients...
    }
}
```

### 11.5 ResultRecordTests

**File:** `tests/RuneAndRust.Tests/Application/Results/CraftingResultTests.cs`

```csharp
[TestFixture]
public class CraftingResultTests
{
    [Test]
    public void CraftResult_Success_HasCorrectProperties()
    {
        // Arrange & Act
        var item = Item.Create("sword", "Sword", "Desc", ItemType.Weapon);
        var result = CraftResult.Success(15, 4, 19, 12, item, CraftedItemQuality.Fine);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.IsSuccess, Is.True);
            Assert.That(result.Roll, Is.EqualTo(15));
            Assert.That(result.Modifier, Is.EqualTo(4));
            Assert.That(result.Total, Is.EqualTo(19));
            Assert.That(result.DifficultyClass, Is.EqualTo(12));
            Assert.That(result.Margin, Is.EqualTo(7));
            Assert.That(result.WasDiceRollFailure, Is.False);
        });
    }

    [Test]
    public void CraftResult_Failed_IdentifiesFailureType()
    {
        // Arrange
        var losses = new List<ResourceLoss> { new("ore", "Iron Ore", 2) };

        // Act - Close failure (margin = -3)
        var closeFailure = CraftResult.Failed(7, 2, 9, 12, losses);

        // Act - Bad failure (margin = -8)
        var badFailure = CraftResult.Failed(2, 2, 4, 12, losses);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(closeFailure.IsCloseFailure, Is.True);
            Assert.That(closeFailure.IsBadFailure, Is.False);
            Assert.That(badFailure.IsCloseFailure, Is.False);
            Assert.That(badFailure.IsBadFailure, Is.True);
        });
    }
}
```

---

## 12. Use Cases

### 12.1 UC-001: Validate Crafting Prerequisites

**Actor:** System (CraftingService)
**Preconditions:** Player has initiated craft command
**Flow:**
1. System checks if recipe exists
2. System checks if player knows recipe
3. System checks if player is at appropriate station
4. System checks if station supports recipe category
5. System checks if player has required resources
6. System returns validation result

**Outcome:** Validation success/failure with details

```
    CanCraft(player, "iron-sword")
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Recipe exists?                    │──▶ NO ──▶ "Recipe not found."
    └──────────────────────────────────────┘
           │ YES
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Player knows recipe?              │──▶ NO ──▶ "You don't know this recipe."
    └──────────────────────────────────────┘
           │ YES
           ▼
    ┌──────────────────────────────────────┐
    │ 3. At crafting station?              │──▶ NO ──▶ "Need crafting station."
    └──────────────────────────────────────┘
           │ YES
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Station supports category?        │──▶ NO ──▶ "Station can't craft this."
    └──────────────────────────────────────┘
           │ YES
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Has required resources?           │──▶ NO ──▶ "Insufficient resources."
    └──────────────────────────────────────┘
           │ YES
           ▼
    ┌──────────────────────────────────────┐
    │ Return: CraftValidation.Success()    │
    └──────────────────────────────────────┘
```

### 12.2 UC-002: Execute Crafting Dice Check

**Actor:** System (CraftingService)
**Preconditions:** Validation passed
**Flow:**
1. System gets player's crafting modifier for station skill
2. System rolls d20
3. System adds modifier to roll
4. System compares total to recipe DC
5. System publishes CraftAttemptedEvent
6. System returns success if total >= DC

**Outcome:** Dice roll result determines success/failure

```
    RollCraftCheck(player, recipe, station)
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Get skill modifier                │
    │    modifier = player.Skills          │
    │      .GetModifier(station.SkillId)   │
    │    (e.g., Smithing +4)               │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Roll d20                          │
    │    roll = diceService.Roll("1d20")   │
    │    (e.g., rolled 15)                 │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Calculate total                   │
    │    total = roll + modifier           │
    │    (e.g., 15 + 4 = 19)               │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Compare to DC                     │
    │    DC = recipe.DifficultyClass       │
    │    margin = total - DC               │
    │    (e.g., 19 - 12 = +7)              │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Publish CraftAttemptedEvent       │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 6. Success? total >= DC              │
    │    (19 >= 12 = SUCCESS)              │
    └──────────────────────────────────────┘
```

### 12.3 UC-003: Handle Successful Craft

**Actor:** System (CraftingService)
**Preconditions:** Dice check succeeded
**Flow:**
1. System determines quality from roll margin
2. System consumes all required resources
3. System creates item with determined quality
4. System adds item to player inventory
5. System publishes ItemCraftedEvent
6. System returns success result

**Outcome:** Player receives crafted item

```
    HandleSuccess(player, recipe, roll, margin)
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Determine quality                 │
    │    if (roll == 20) → Legendary       │
    │    elif (margin >= 10) → Masterwork  │
    │    elif (margin >= 5) → Fine         │
    │    else → Standard                   │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Consume resources                 │
    │    foreach ingredient:               │
    │      inventory.Remove(id, quantity)  │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Create item                       │
    │    item = factory.CreateFromRecipe(  │
    │      recipe, quality)                │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Add to inventory                  │
    │    inventory.AddItem(item)           │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Publish ItemCraftedEvent          │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 6. Return CraftResult.Success()      │
    └──────────────────────────────────────┘
```

### 12.4 UC-004: Handle Failed Craft

**Actor:** System (CraftingService)
**Preconditions:** Dice check failed
**Flow:**
1. System calculates failure margin
2. System determines loss percentage (25% or 50%)
3. System calculates resource losses for each ingredient
4. System removes lost resources from inventory
5. System returns failure result with loss details

**Outcome:** Player loses partial resources

```
    HandleFailure(player, recipe, margin)
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Determine failure severity        │
    │    if (margin < -5) → Bad Failure    │
    │    else → Close Failure              │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Calculate loss percentage         │
    │    Bad Failure: 50%                  │
    │    Close Failure: 25%                │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Calculate losses per ingredient   │
    │    foreach ingredient:               │
    │      loss = ceil(qty × lossPercent)  │
    │      loss = max(1, loss)             │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Apply resource losses             │
    │    foreach loss:                     │
    │      inventory.Remove(id, amount)    │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Return CraftResult.Failed()       │
    │    with loss details                 │
    └──────────────────────────────────────┘
```

### 12.5 UC-005: List Craftable Recipes

**Actor:** Player
**Preconditions:** Player is at a crafting station
**Flow:**
1. Player issues `craft` command with no arguments
2. System gets current station
3. System gets player's known recipes
4. System filters recipes by station category
5. System marks recipes with sufficient resources
6. System displays recipe list

**Outcome:** Player sees available recipes

```
    > craft
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Get current station               │
    │    station = GetCurrentStation()     │
    │    (e.g., Anvil)                     │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Get known recipes                 │
    │    recipes = recipeService           │
    │      .GetKnownRecipes(player)        │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Filter by station category        │
    │    recipes.Where(r =>                │
    │      station.CanCraftRecipe(r))      │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Check resource availability       │
    │    Mark [READY] if player has all    │
    │    required resources                │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Display recipe list               │
    │    ═══ RECIPES AT ANVIL ═══          │
    │    [READY] Iron Sword (DC 12)        │
    │    Steel Sword (DC 15)               │
    └──────────────────────────────────────┘
```

---

## 13. Deliverable Checklist

### Application Layer

- [ ] `ICraftingService` interface in `Application/Interfaces/`
- [ ] `CraftingService` implementation in `Application/Services/`
- [ ] `CraftValidation` record in `Application/Results/`
- [ ] `CraftResult` record in `Application/Results/`
- [ ] `MissingResource` record in `Application/Results/`
- [ ] `ResourceLoss` record in `Application/Results/`

### Domain Layer

- [ ] `CraftAttemptedEvent` in `Domain/Events/`
- [ ] `ItemCraftedEvent` in `Domain/Events/`

### Presentation Layer

- [ ] `CraftCommand` in `Presentation/Commands/`

### Testing

- [ ] `CraftingServiceCanCraftTests` (~4 tests)
- [ ] `CraftingServiceCraftTests` (~4 tests)
- [ ] `CraftingServiceFailureLossTests` (~2 tests)
- [ ] `CraftingResultTests` (~2 tests)
- [ ] All ~12 unit tests passing

### Integration

- [ ] DI registration for ICraftingService
- [ ] Command registration for CraftCommand

---

## 14. Acceptance Criteria

### Functional

- [ ] CanCraft validates station presence
- [ ] CanCraft checks recipe knowledge
- [ ] CanCraft checks resource availability
- [ ] CanCraft validates station supports recipe category
- [ ] Craft rolls d20 + skill modifier vs DC
- [ ] Success consumes all required resources
- [ ] Success creates item with appropriate quality
- [ ] Success adds item to player inventory
- [ ] Failure calculates correct loss percentage
- [ ] Close failure (within 5 of DC) loses 25% resources
- [ ] Bad failure (more than 5 below DC) loses 50% resources
- [ ] Natural 20 creates Legendary quality item
- [ ] Margin >= 10 creates Masterwork quality
- [ ] Margin >= 5 creates Fine quality
- [ ] CraftAttemptedEvent publishes on every attempt
- [ ] ItemCraftedEvent publishes on success
- [ ] CraftCommand with no args lists available recipes
- [ ] CraftCommand with recipe name attempts crafting

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~12 unit tests pass
- [ ] XML documentation complete for all public types
- [ ] Logging follows established patterns

---

## 15. Dependencies

### 15.1 Required from v0.11.2a

| Type | Location | Usage |
|------|----------|-------|
| `CraftingStationDefinition` | `Domain/Definitions/` | Station validation |
| `CraftingStation` | `Domain/Entities/` | Current station lookup |
| `ICraftingStationProvider` | `Application/Interfaces/` | Station retrieval |
| Room extension methods | `Domain/Extensions/` | Station queries |

### 15.2 Required from v0.11.1

| Type | Location | Usage |
|------|----------|-------|
| `RecipeDefinition` | `Domain/Definitions/` | Recipe lookup |
| `RecipeCategory` | `Domain/Enums/` | Category validation |
| `IRecipeProvider` | `Application/Interfaces/` | Recipe retrieval |
| `IRecipeService` | `Application/Interfaces/` | Knowledge check |

### 15.3 Required from Prior Versions

| Type | Location | Usage |
|------|----------|-------|
| `Player` | `Domain/Entities/` | Player state |
| `Skills` | `Domain/ValueObjects/` | Crafting modifier |
| `Inventory` | `Domain/Entities/` | Resource storage |
| `Item` | `Domain/Entities/` | Created items |
| `IDiceService` | `Application/Interfaces/` | Dice rolling |
| `IInventoryService` | `Application/Interfaces/` | Resource management |
| `IItemFactory` | `Application/Interfaces/` | Item creation |
| `IEventBus` | `Application/Interfaces/` | Event publishing |
| `IGameSessionService` | `Application/Interfaces/` | Current room |

### 15.4 Provides to v0.11.2c

| Type | Usage |
|------|-------|
| `ICraftingService` | Quality system integration |
| `CraftResult` | Quality determination context |
| `DetermineQuality` logic | Quality system extension |

---

## 16. Future Considerations

### Deferred to v0.11.2c (Quality System)

- **Quality Tier Configuration**: Configurable thresholds
- **Quality Stat Multipliers**: Enhanced item stats
- **Quality Value Multipliers**: Enhanced item value
- **Legendary Effects**: Special item effects
- **Quality Provider**: JSON configuration loading

### Deferred to Later Versions

- **Crafting Time**: Time-based crafting
- **Batch Crafting**: Craft multiple items at once
- **Crafting Queues**: Queue multiple crafting operations
- **Crafting Interruption**: Cancel in-progress crafting
- **Tool Requirements**: Specific tools for recipes
- **Crafting XP**: Experience gain from crafting
- **Critical Failures**: Catastrophic failure effects
- **Salvaging**: Recover materials from items

### Out of Scope

- **Multiplayer Crafting**: Shared station access
- **Crafting Minigames**: Interactive crafting
- **Real-time Crafting**: Time-based mechanics
- **Crafting Automation**: Auto-crafting systems

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
