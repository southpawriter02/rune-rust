# Changelog: v0.18.1b - CorruptionTracker Entity & Result Objects

**Release Date:** 2026-01-31
**Phase:** Runic Blight Corruption (2/5)
**Status:** Complete

---

## Overview

Implements the stateful entity and result objects for the Runic Blight Corruption system. v0.18.1b establishes `CorruptionTracker` — a mutable domain entity that tracks per-character corruption accumulation, threshold crossings, and computed penalties — along with `CorruptionAddResult` and `TerminalErrorResult` value objects for operation outcomes.

Additionally creates the `CorruptionSource` enum (8 categories) which was listed as a v0.18.1a dependency in the design specification but was not implemented in that phase. This enum is required by `CorruptionTracker.AddCorruption` and `CorruptionAddResult`.

Unlike the immutable `CorruptionState` value object (v0.18.1a), `CorruptionTracker` maintains persistent state including character association, threshold trigger history, and provides domain methods for corruption manipulation.

---

## Added

### Domain Layer — Enums

- **`CorruptionSource`** (`Domain/Enums/CorruptionSource.cs`)
    - 8-value enum with explicit integer assignments (0-7) for stable serialization
    - Values: MysticMagic (0), HereticalAbility (1), Artifact (2), Environmental (3), Consumable (4), Ritual (5), ForlornContact (6), BlightTransfer (7)
    - Comprehensive XML documentation per value with corruption ranges, gameplay context, and Blot-Priest-specific mechanics
    - Box comment header and section separators following established pattern

### Domain Layer — Entities

- **`CorruptionTracker`** (`Domain/Entities/CorruptionTracker.cs`)
    - Implements `IEntity` for repository and persistence support
    - Private parameterless constructor for EF Core materialization
    - Factory method: `Create(Guid characterId)` with ArgumentException for empty Guid

#### CorruptionTracker Stored Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique entity identifier (IEntity) |
| `CharacterId` | `Guid` | Owner character reference |
| `CurrentCorruption` | `int` | Corruption value (0-100) |
| `Threshold25Triggered` | `bool` | One-time 25% crossing flag |
| `Threshold50Triggered` | `bool` | One-time 50% crossing flag (faction lock) |
| `Threshold75Triggered` | `bool` | One-time 75% crossing flag |

#### CorruptionTracker Computed Properties

| Property | Type | Formula/Logic |
|----------|------|---------------|
| `Stage` | `CorruptionStage` | Via `CorruptionState.DetermineStage()` |
| `MaxHpPenaltyPercent` | `int` | floor(Corruption/10) * 5 (0-50%) |
| `MaxApPenaltyPercent` | `int` | floor(Corruption/10) * 5 (0-50%) |
| `ResolveDicePenalty` | `int` | floor(Corruption/20) (0-5 dice) |
| `TechBonus` | `int` | By stage: 0/+1/+2/+2/+2/0 |
| `SocialPenalty` | `int` | By stage: 0/-1/-2/-2/-2/0 |
| `IsFactionLocked` | `bool` | Corruption >= 50 |
| `IsTerminalError` | `bool` | Corruption >= 100 |

#### CorruptionTracker Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `AddCorruption(int, CorruptionSource)` | `CorruptionAddResult` | Adds corruption with threshold tracking |
| `SetCorruption(int)` | `void` | Internal — for deserialization/testing |
| `SetThresholdTriggers(bool, bool, bool)` | `void` | Internal — for deserialization/testing |

### Domain Layer — Value Objects

- **`CorruptionAddResult`** (`Domain/ValueObjects/CorruptionAddResult.cs`)
    - `readonly record struct` with private constructor and `Create` factory
    - Properties: PreviousCorruption, NewCorruption, AmountGained (computed), Source, ThresholdCrossed (int?), StageCrossed (bool), PreviousStage, NewStage, IsTerminalError
    - Arrow property: `NowFactionLocked` (NewCorruption >= 50 && PreviousCorruption < 50)
    - Custom ToString with corruption transition, source, threshold/stage crossings, and Terminal Error indicator

- **`TerminalErrorResult`** (`Domain/ValueObjects/TerminalErrorResult.cs`)
    - `readonly record struct` with private constructor
    - Factory methods: `Success(int successes, int dc = 3)` and `Failure(int successes, int dc = 3)`
    - Properties: Survived, FinalCorruption (99 if survived, 100 if Forlorn), BecameForlorn, SuccessesRolled, RequiredDc
    - Arrow property: `WasCriticalSuccess` (Survived && SuccessesRolled >= RequiredDc * 2)
    - Custom ToString with outcome, successes/DC ratio, and critical success indicator

### Unit Tests

- **`CorruptionSourceTests`** (`Enums/CorruptionSourceTests.cs`) — 2 test methods (10 test case executions)
    - `CorruptionSource_HasExpectedValues` — verifies all 8 integer assignments (0-7)
    - `CorruptionSource_HasCorrectCount` — verifies exactly 8 enum values exist

- **`CorruptionTrackerTests`** (`Entities/CorruptionTrackerTests.cs`) — 35 test methods (87 test case executions)
    - Factory: Create initialization, unique ID generation, empty Guid rejection
    - IEntity: interface compliance, Id accessibility via cast
    - Penalties: parameterized across 17 corruption levels (0, 9, 10, 19, 20, 25, 39, 40, 45, 50, 60, 75, 80, 85, 99, 100)
    - Stage: boundary tests at all 11 transition points
    - TechBonus: 8 stage-based cases
    - SocialPenalty: 8 stage-based cases
    - IsFactionLocked: 5 boundary cases
    - IsTerminalError: 4 boundary cases
    - Threshold crossings: 25/50/75 one-time triggers, no-crossing null, multi-threshold behavior
    - Stage crossing: detection, same-stage non-detection
    - Terminal Error: reaching 100, clamping above max
    - Negative amounts: reduction and clamping at zero
    - Source recording: all 8 CorruptionSource values
    - SetCorruption: clamping behavior (5 cases)
    - SetThresholdTriggers: flag setting
    - ToString: mid-corruption, Terminal Error, zero corruption

- **`CorruptionAddResultTests`** (`ValueObjects/CorruptionAddResultTests.cs`) — 11 test methods (25 test case executions)
    - Factory: Create stores all properties
    - AmountGained: 5 cases (gain, clamped gain, negative, zero)
    - StageCrossed: 6 stage transition cases via CorruptionTracker
    - IsTerminalError: 3 boundary cases
    - NowFactionLocked: 5 transition cases
    - ToString: basic, threshold crossing, Terminal Error

- **`TerminalErrorResultTests`** (`ValueObjects/TerminalErrorResultTests.cs`) — 11 test methods (18 test case executions)
    - Success factory: correct properties, default DC
    - Failure factory: correct properties, default DC
    - WasCriticalSuccess: 6 parameterized cases + failure edge case
    - BecameForlorn: inverse of Survived verification
    - ToString: normal success, critical success, failure

### Glossary

- **`config/glossary.json`** — Added 4 glossary entries (sortOrder 92-95)
    - `corruption-source`: Enum categorizing eight corruption source origins
    - `corruption-tracker`: Mutable entity tracking per-character corruption with computed penalties
    - `corruption-add-result`: Immutable result capturing corruption change outcomes
    - `terminal-error-result`: Immutable result capturing Terminal Error survival check outcomes

---

## Changed

### Project Configuration

- **`src/Core/RuneAndRust.Domain/RuneAndRust.Domain.csproj`** — Added `InternalsVisibleTo` for `RuneAndRust.Domain.UnitTests` to allow test access to internal `SetCorruption` and `SetThresholdTriggers` methods

### Documentation

- **`docs/design/v0.18.x/v0.18.1-scope-breakdown.md`** — Checked off v0.18.1b acceptance criteria
- **`docs/design/v0.18.x/v0.18.1b-design-specification.md`** — Checked off deliverable and acceptance criteria items

---

## Design Decisions

### CorruptionSource Created in v0.18.1b

The design specification lists `CorruptionSource` as "FROM v0.18.1a (Dependencies)" but it was not implemented in v0.18.1a (which only created `CorruptionStage` and `CorruptionState`). Since `CorruptionTracker.AddCorruption` and `CorruptionAddResult` both require `CorruptionSource`, it was created in this phase. The 8 enum values follow the canonical scope breakdown definition.

### Environmental Instead of BlightExposure

The design specification test code uses `CorruptionSource.BlightExposure` but the scope breakdown's canonical enum list defines `Environmental` as the category for Blight zone exposure. The scope breakdown was followed as the authoritative source, and test references were adapted accordingly.

### Section Separators Instead of #region Directives

The design specification uses `#region` / `#endregion` blocks. The codebase convention (established in `StressHistoryEntry.cs` and all v0.18.0/v0.18.1a files) uses `═══` comment line separators with ALL-CAPS section headers. Codebase convention was followed.

### InternalsVisibleTo for Test Access

`CorruptionTracker.SetCorruption` and `SetThresholdTriggers` are marked `internal` per the design specification (bypass threshold logic, for deserialization/testing only). Added `InternalsVisibleTo` to the Domain project file rather than making these methods public, maintaining proper encapsulation.

### Test Count Expansion

The design specification estimated ~5 tests. The implementation includes 59 test methods across 4 test files (140 individual test case executions), consistent with v0.18.1a's pattern where ~4 estimated tests became 21 actual test methods. The expanded coverage includes all penalty formula boundary conditions, all stage transitions, all threshold crossing scenarios, all CorruptionSource values, clamping edge cases, and ToString formatting.

### Threshold Crossing Else-If Logic

When a single large corruption addition crosses multiple thresholds simultaneously (e.g., 0 -> 80 crosses 25, 50, and 75), only the first uncrossed threshold is reported per `AddCorruption` call. This matches the design specification's else-if chain and means subsequent thresholds must be triggered by future corruption additions.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CorruptionStage` | v0.18.1a | Stage enum for computed properties and stage crossing detection |
| `CorruptionState` | v0.18.1a | `DetermineStage()` method for stage resolution |
| `StressHistoryEntry` | v0.18.0f | Pattern reference for entity structure and conventions |
| `StressSource` | v0.18.0a | Pattern reference for CorruptionSource enum structure |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `CorruptionSource` | v0.18.1c | Parameter type in ICorruptionService methods |
| `CorruptionTracker` | v0.18.1c | Entity managed by ICorruptionService |
| `CorruptionTracker` | v0.18.1d | Entity operated on by CorruptionService implementation |
| `CorruptionAddResult` | v0.18.1c | Return type for ICorruptionService.AddCorruption |
| `CorruptionAddResult` | v0.18.1d | Return type from service operations |
| `TerminalErrorResult` | v0.18.1c | Return type for ICorruptionService.PerformTerminalErrorCheck |
| `TerminalErrorResult` | v0.18.1d | Created by CorruptionService during Terminal Error handling |

---

## Logging Strategy

No runtime logging in v0.18.1b — CorruptionTracker is a domain entity and does not perform logging directly. Logging specifications shown in the design specification (section 8) are for the service layer (v0.18.1d) which will log corruption state changes, threshold crossings, stage transitions, faction lock events, and Terminal Error outcomes.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/CorruptionSource.cs` | Corruption source enum (8 categories) |
| `src/Core/RuneAndRust.Domain/Entities/CorruptionTracker.cs` | Per-character corruption tracker entity |
| `src/Core/RuneAndRust.Domain/ValueObjects/CorruptionAddResult.cs` | Corruption addition result value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/TerminalErrorResult.cs` | Terminal Error check result value object |
| `tests/RuneAndRust.Domain.UnitTests/Enums/CorruptionSourceTests.cs` | CorruptionSource tests (2 methods) |
| `tests/RuneAndRust.Domain.UnitTests/Entities/CorruptionTrackerTests.cs` | CorruptionTracker tests (35 methods) |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CorruptionAddResultTests.cs` | CorruptionAddResult tests (11 methods) |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TerminalErrorResultTests.cs` | TerminalErrorResult tests (11 methods) |
| `changelogs/v0.18.1b-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/RuneAndRust.Domain.csproj` | Added InternalsVisibleTo for test project |
| `config/glossary.json` | Added 4 glossary entries (sortOrder 92-95) |
| `docs/design/v0.18.x/v0.18.1-scope-breakdown.md` | Checked off v0.18.1b acceptance criteria |
| `docs/design/v0.18.x/v0.18.1b-design-specification.md` | Checked off deliverable and acceptance criteria |

---

## Notes

- Total unit tests for v0.18.1b: 59 test methods across 4 test files (140 individual test case executions, exceeding the ~5 estimate)
- All 140 new test executions pass; all existing tests unaffected (0 regressions)
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` box comment headers and section separators, file-scoped namespaces, comprehensive XML documentation with `<summary>`, `<remarks>`, `<para>`, `<list>`, `<example>`, `<seealso>`, and `<value>` tags
- Pre-existing glossary schema validation failure at term #88 remains (unrelated to v0.18.1b changes)
- The CorruptionTracker entity pattern established here (mutable entity with computed properties and domain methods returning result VOs) will be referenced by the CorruptionService (v0.18.1d) and persistence configuration (v0.18.1e)
