> **Archived** - This plan has been consolidated. See the complete version at [v0.3.22](../v0.3.x/v0.3.22.md).

# v0.3.22c: The Forecast (Predictive UI)
This sub-version introduces "Hover Intent" logic. It transforms the Combat UI from a reactive display into a proactive tactical tool. By previewing the mathematical probability of success and potential damage before the player commits to an action, we reduce frustration and reward strategic planning.

## v0.3.22c: The Forecast
Goal: Implement a prediction engine that calculates hit probabilities and damage ranges for the currently selected action/target, and update the Combat UI to display this "Forecast" in real-time.
1. Architecture & Data Flow
	•	Predictive Engine: Extend AttackResolutionService with a "Dry Run" mode. Instead of rolling dice, it calculates statistical probabilities based on the attacker's pool and the defender's stats.
	•	ViewModel Integration: Update CombatViewModel to include a CurrentForecast property. This property is updated whenever the player changes their selected action or target.
	•	Rendering: The CombatScreenRenderer displays this forecast (e.g., a "Tactical readout" panel) whenever valid target data exists.
Data Flow: The Prediction Pipeline
	1	Input: Player highlights "Attack" command targeting "Draugr A".
	2	Request: UI Layer calls CombatService.GetForecast(player, target, attackType).
	3	Calculation:
	◦	Hit Chance: Calculate based on (AttackerPool * 0.2) - (DefenderDefense / 5). (Approximation: Average net successes per die is ~0.2).
	◦	Damage Range: (WeaponMin + Attr) - Soak to (WeaponMax + Attr) - Soak.
	4	Formatting: Create CombatForecast object (e.g., "Hit: Likely (~80%) | Dmg: 4-8").
	5	Render: Update UI Footer with the forecast string.

2. Logic Decision Trees
A. Probability Calculation Logic (Approximation) Input: AttackerDice (N), DefenderDefense (D)
	1	Defense Threshold: Threshold = Floor(D / 5).
	2	Expected Net Successes (E): E = N * 0.2 (Success rate 30% - Botch rate 10% = 20% net average).
	3	Determine Label:
	◦	If E >= Threshold + 2: "Guaranteed" (>95%).
	◦	If E >= Threshold + 1: "Very Likely" (~80%).
	◦	If E >= Threshold: "Likely" (~60%).
	◦	If E >= Threshold - 1: "Risky" (~40%).
	◦	Else: "Unlikely" (<20%).
	4	Crit Chance: N * 0.1 (Roughly 10% per die to roll a 10).
B. Damage Range Logic Input: Weapon (d6), Attribute (4), Soak (2)
	1	Calculate Raw:
	◦	Min: 1 + 4 = 5.
	◦	Max: 6 + 4 = 10.
	2	Apply Soak:
	◦	Min: Max(1, 5 - 2) = 3.
	◦	Max: Max(1, 10 - 2) = 8.
	3	Output: Range "3-8".

3. Code Implementation
A. Forecast Model File: RuneAndRust.Core/Models/Combat/CombatForecast.cs
public record CombatForecast(
    string HitChanceLabel,
    int MinDamage,
    int MaxDamage,
    int CritChancePercent,
    bool IsLethal // If MinDamage >= Target.CurrentHP
);
B. Service Expansion File: RuneAndRust.Engine/Services/AttackResolutionService.cs
public CombatForecast GetForecast(Combatant attacker, Combatant defender, AttackType type)
{
    // 1. Calculate Dice Pool
    var poolSize = _dice.CalculatePool(attacker.GetAttribute(Attribute.Finesse),
                                       attacker.GetAttribute(Attribute.Wits));

    // 2. Calculate Defense Threshold
    var defenseScore = CalculateDefenseScore(defender); // 10 + Fin - Stress
    var threshold = defenseScore / 5;

    // 3. Estimate Hit Chance (Heuristic)
    // Net success expectancy is ~0.2 per die (0.3 success - 0.1 botch)
    double expectedNet = poolSize * 0.2;
    double margin = expectedNet - threshold;

    string label = margin switch
    {
        >= 2.0 => "[green]Guaranteed[/]",
        >= 1.0 => "[green]Very Likely[/]",
        >= 0.0 => "[yellow]Likely[/]",
        >= -1.0 => "[orange1]Risky[/]",
        _ => "[red]Unlikely[/]"
    };

    // 4. Calculate Damage Range
    int weaponDie = attacker.WeaponDamageDie;
    int attrBonus = attacker.GetAttribute(Attribute.Might); // Assuming Str based
    int soak = defender.ArmorSoak;

    int minDmg = Math.Max(1, (1 + attrBonus) - soak);
    int maxDmg = Math.Max(1, (weaponDie + attrBonus) - soak);

    return new CombatForecast(
        HitChanceLabel: label,
        MinDamage: minDmg,
        MaxDamage: maxDmg,
        CritChancePercent: (int)(poolSize * 10), // Rough calc
        IsLethal: minDmg >= defender.CurrentHp
    );
}
C. ViewModel Update File: RuneAndRust.Core/ViewModels/CombatViewModel.cs
public record CombatViewModel(
    // ... existing properties
    CombatForecast? CurrentForecast // Null if no target selected
);

4. Deliverable Checklist (v0.3.22c)
	•	Core:
	◦	[ ] Create CombatForecast record.
	◦	[ ] Update CombatViewModel to include CurrentForecast.
	•	Engine:
	◦	[ ] Implement GetForecast in AttackResolutionService.
	◦	[ ] Add CalculatePool helper to DiceService (refactor existing logic to be public/reusable).
	◦	[ ] Update CombatService to expose a PreviewAction(targetId) method that returns a Forecast.
	•	Terminal:
	◦	[ ] Update CombatScreenRenderer to draw the "Prediction Bar" (e.g., above the input line).
	◦	[ ] Bind Tab or specific targeting keys to trigger the Preview update.
	•	Tests:
	◦	[ ] Forecast_Calculates_Correct_Range.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Combat
Forecast
Verbose
"[UI] Forecast generated for {Attacker} vs {Target}: {Label}"
Attacker, Target, Label

6. Testing Strategy
Unit Tests (AttackResolutionServiceTests.cs):
	•	DamageRange_IsAccurate:
	◦	Setup: Weapon d6, Might 4, Soak 2.
	◦	Act: GetForecast.
	◦	Assert: Min = 3 (1+4-2), Max = 8 (6+4-2).
	•	HitChance_Labels:
	◦	Setup: High Finesse vs Low Defense.
	◦	Assert: Label contains "Guaranteed" or "Likely".
	•	Lethality_Check:
	◦	Setup: Target HP = 5. Min Damage = 6.
	◦	Assert: IsLethal is True.
Integration Tests:
	•	UI_Rendering:
	◦	Call PreviewAction. verify CombatViewModel.CurrentForecast is populated.
	◦	Render. Verify text "Likely" appears in output string.

7. Draft Changelog (v0.3.22c)
# Changelog: v0.3.22c - The Forecast

**Release Date:** 2026-03-XX

## Summary
The final phase of "The Tactician II" introduces the Combat Forecast system. By simulating combat math before the dice roll, the interface now provides tactical predictions, allowing players to weigh risks (hit chance) against rewards (damage potential) without needing a calculator.

## Changes
- **Core:** Added `CombatForecast` model to encapsulate prediction data.
- **Engine:** Implemented predictive logic in `AttackResolutionService` to estimate hit probabilities and damage ranges based on known stats.
- **UI:** The Combat Screen now displays a "Forecast Bar" when targeting an enemy, showing Hit Chance, Damage Range, and a "Lethal" indicator if the attack is guaranteed to kill.