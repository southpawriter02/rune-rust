> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.2](../v0.2.x/v0.2.2.md).

# v0.2.2b Changelog: The Mind (AI Behaviors)

**Release Date:** 2025-12-20
**Milestone:** v0.2.2 – The Adversary (2 of 3)
**Test Count:** 1414 tests (28 new)

---

## Summary

This release implements the **EnemyAIService** to drive enemy turns using archetype-based decision logic. Enemies are no longer passive stat-blocks—they now make tactical decisions based on their Archetype, HP thresholds, and stamina resources.

---

## New Features

### Enemy AI System (EnemyAIService)

The core of v0.2.2b is a probability-based decision matrix that determines enemy actions:

| Archetype    | HP Trigger            | Default Behavior         | Heavy Attack Chance |
|--------------|----------------------|--------------------------|---------------------|
| DPS          | < 25% + Cowardly = Flee | Standard Attack          | 20% (roll >= 80)    |
| Tank         | < 40% = Defend       | 60% Attack / 40% Defend  | 0%                  |
| GlassCannon  | < 25% + Cowardly = Flee | Standard Attack          | 20% (roll >= 80)    |
| Swarm        | None                 | Light Attack (always)    | 0%                  |
| Support      | None                 | 70% Light / 30% Standard | 0%                  |
| Caster       | None                 | Standard Attack (ranged) | 0%                  |
| Boss         | None                 | 50% Heavy / 50% Standard | 50%                 |

### State Triggers

- **Cowardly Tag + Low HP (< 25%)**: Triggers flee action
- **Tank + Wounded (< 40% HP)**: Triggers defensive stance
- **Stamina Exhaustion**: Falls back to cheaper attacks or passes turn

### UX Pacing

- 750ms delay before enemy actions for readability
- AAM-VOICE compliant flavor text for all actions
- Combat log integration with Spectre markup formatting

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/ActionType.cs` | Enum for AI action types (Attack, Defend, Flee, Pass) |
| `RuneAndRust.Core/Models/Combat/CombatAction.cs` | Record representing an enemy's intended action |
| `RuneAndRust.Core/Interfaces/IEnemyAIService.cs` | Interface for enemy AI decision-making |
| `RuneAndRust.Engine/Services/EnemyAIService.cs` | Archetype-based AI implementation |
| `RuneAndRust.Tests/Engine/EnemyAIServiceTests.cs` | 28 unit tests for AI behaviors |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `ExecuteEnemyAttack`, `ProcessDefend`, `ProcessFlee`, `ProcessEnemyTurnAsync` |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `IsDefending` property for defensive stance tracking |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `IEnemyAIService` dependency, implemented enemy turn processing |
| `RuneAndRust.Terminal/Program.cs` | Registered `IEnemyAIService` in DI container |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `IEnemyAIService` mock to test setup |

---

## API Changes

### ICombatService Interface

New methods added:

```csharp
string ExecuteEnemyAttack(Combatant attacker, Combatant target, AttackType attackType);
void ProcessDefend(Combatant combatant);
void ProcessFlee(Combatant combatant);
Task ProcessEnemyTurnAsync(Combatant enemy);
```

### CombatService Constructor (Breaking Change)

The constructor now requires `IEnemyAIService`:

```csharp
// Before
public CombatService(GameState, IInitiativeService, IAttackResolutionService,
                     ILootService, IStatusEffectService, ILogger)

// After
public CombatService(GameState, IInitiativeService, IAttackResolutionService,
                     ILootService, IStatusEffectService, IEnemyAIService, ILogger)
```

Existing tests updated to mock this new dependency.

---

## Test Coverage

### New Tests (28 total)

**Archetype Behavior Tests:**
- `DetermineAction_DPS_AttacksByDefault`
- `DetermineAction_DPS_HeavyAttackOnHighRoll`
- `DetermineAction_GlassCannon_BehavesLikeDPS`
- `DetermineAction_Tank_DefendsWhenWounded`
- `DetermineAction_Tank_AttacksWhenHealthy_LowRoll`
- `DetermineAction_Tank_DefendsWhenHealthy_HighRoll`
- `DetermineAction_Swarm_AlwaysLightAttack`
- `DetermineAction_Swarm_PassesWhenNoStamina`
- `DetermineAction_Support_PrefersLightAttack_LowRoll`
- `DetermineAction_Support_UsesStandardAttack_HighRoll`
- `DetermineAction_Caster_UsesStandardAttack`
- `DetermineAction_Caster_PassesWhenNoStamina`
- `DetermineAction_Boss_PrefersHeavyAttack`
- `DetermineAction_Boss_UsesStandardOnLowRoll`
- `DetermineAction_Boss_DefendsWhenNoStamina`

**State Trigger Tests:**
- `DetermineAction_CowardlyTag_FleesAtLowHp`
- `DetermineAction_CowardlyTag_DoesNotFleeWhenHealthy`
- `DetermineAction_NoCowardlyTag_DoesNotFlee`
- `DetermineAction_GlassCannon_FleesWhenCowardlyAndLowHp`

**Resource Management Tests:**
- `DetermineAction_LowStamina_FallsBackToLightAttack`
- `DetermineAction_NoStamina_PassesTurn`
- `DetermineAction_CannotAffordHeavy_FallsBackToStandard`

**Target Selection Tests:**
- `DetermineAction_NoPlayer_PassesTurn`
- `DetermineAction_FindsPlayerTarget`

**Edge Cases:**
- `DetermineAction_ZeroMaxHp_DoesNotCrash`
- `DetermineAction_DefaultArchetype_UsesAggressiveLogic`
- `DetermineAction_CombatActionContainsSourceId`
- `DetermineAction_AttackAction_HasFlavorText`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| AI Start | Trace | `"[AI] {Name} (Arch:{Archetype}) thinking. HP: {Hp}% Stm: {Stamina}"` |
| Trigger Matched | Debug | `"[AI] Trigger matched: {Trigger} (Val: {Value})"` |
| Behavior Roll | Debug | `"[AI] Behavior roll: {Roll}"` |
| Decision Made | Information | `"[AI] {Name} chose {Action} vs {Target}. Roll: {Roll}"` |
| Resource Fallback | Warning | `"[AI] Wanted {Action} but insufficient Stamina. Fallback: {Fallback}"` |
| Enemy Attack | Information | `"{Attacker} attacks {Target} ({AttackType}): {Outcome}"` |
| Enemy Fled | Information | `"{Name} fled from combat"` |
| Processing Turn | Debug | `"Processing enemy turn for {Name}"` |

---

## Architecture

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  CombatService      │────▶│    EnemyAIService    │────▶│   CombatAction      │
│  (NextTurn)         │     │   (DetermineAction)  │     │   (What to do)      │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
         │                           │                            │
         │                           ▼                            │
         │                  ┌──────────────────────┐              │
         │                  │   Combatant          │              │
         │                  │   - Archetype        │              │
         │                  │   - CurrentHp/Max    │              │
         │                  │   - Tags             │              │
         │                  └──────────────────────┘              │
         │                                                        │
         ▼                                                        ▼
┌─────────────────────┐                               ┌─────────────────────┐
│  ExecuteEnemyAttack │◀──────────────────────────────│   AttackResolution  │
│  (Apply action)     │                               │   Service           │
└─────────────────────┘                               └─────────────────────┘
```

---

## Known Limitations

1. **Defend Soak Bonus**: The `IsDefending` property is set but the soak bonus is not yet applied. Full implementation in v0.2.2c.
2. **Single Target**: AI always targets the player. Multi-target selection for party combat in future releases.
3. **No Abilities**: Caster and Support archetypes use basic attacks. Special abilities coming in v0.2.2c.

---

## Migration Notes

### For Developers

If you have custom CombatService instantiations, you must now provide an `IEnemyAIService`:

```csharp
// Update your DI registration
services.AddSingleton<IEnemyAIService, EnemyAIService>();
```

### For Tests

Existing CombatService tests need to mock `IEnemyAIService`:

```csharp
private readonly Mock<IEnemyAIService> _mockAIService = new Mock<IEnemyAIService>();

_sut = new CombatService(
    _gameState,
    _mockInitiative.Object,
    _mockAttackResolution.Object,
    _mockLootService.Object,
    _mockStatusEffects.Object,
    _mockAIService.Object,  // NEW
    _mockLogger.Object);
```

---

## Next Steps (v0.2.2c)

- Implement defend soak bonus application
- Add special abilities for Caster and Support archetypes
- Phase 2 triggers for Boss enemies
- Multi-combatant targeting

---

## Contributors

- AI Implementation: Claude Opus 4.5
