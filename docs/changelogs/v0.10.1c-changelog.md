# v0.10.1c Changelog: Environmental Combat

**Version:** 0.10.1c
**Phase:** Environmental Combat (Push, Knockback, Hazards)
**Date:** 2026-01-18
**Status:** ‚úÖ Complete

---

## Summary

Implements environmental combat interactions including push abilities that move targets, knockback on critical hits, and hazard interactions when pushed into dangerous terrain. This adds tactical depth through battlefield manipulation, allowing players to gain positional advantages by pushing enemies into hazards or off key positions.

---

## Added

### Domain Layer - Enums

| Enum | Values | Description |
|------|--------|-------------|
| `HazardType` | Extended with `Pit=9`, `Lava=10` | Types of environmental hazards on the combat grid |

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `EnvironmentalHazardDefinition` | Defines hazard properties including damage dice, type, status effects, and special behaviors |
| `PushResult` | Result of push/knockback with position tracking, movement status, and hazard interaction |
| `HazardDamageResult` | Result of hazard damage including damage dealt, status effects, and trap status |

**EnvironmentalHazardDefinition Properties:**
- `Type` - HazardType enum value
- `Name` - Display name for UI
- `Description` - Flavor text
- `DamageDice` - Damage dice notation (e.g., "3d6")
- `DamageType` - Damage type string (e.g., "fire", "piercing")
- `StatusEffectId` - Optional status effect to apply
- `DamageOnEnter` - Whether damage is dealt on entry
- `DamagePerTurn` - Whether damage is dealt each turn
- `RequiresClimbOut` - Whether climbing is required to escape (pits)
- `DegradesArmor` - Whether the hazard degrades armor (acid)
- `IconPath` - Optional UI icon path

**PushResult Factory Methods:**
- `Success(start, end, cellsMoved, direction)` - Successful push
- `Resisted(start, pusherRoll, targetRoll)` - Target resisted push via STR check
- `Blocked(start, blockedBy)` - Push blocked by wall or entity
- `NoPush(start, reason)` - Push failed for other reasons
- `WithHazardDamage(hazardDamage)` - Extension to add hazard damage to result

**HazardDamageResult Factory Methods:**
- `EntryDamage(...)` - Damage dealt on entering hazard
- `TickDamage(...)` - Per-turn damage from hazard
- `NoHazard(position)` - Position has no hazard
- `NoDamage(...)` - Hazard exists but dealt no damage

### Application Layer - Events

| Event | Description |
|-------|-------------|
| `CombatantPushedEvent` | Raised when a combatant is pushed |
| `CombatantKnockedBackEvent` | Raised when a combatant is knocked back |
| `PushResistedEvent` | Raised when push is resisted via STR check |
| `HazardDamageDealtEvent` | Raised when hazard damage is applied |
| `CombatantTrappedEvent` | Raised when combatant falls into trapping hazard |

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IEnvironmentalHazardProvider` | GetHazard(type), GetHazardByName(name), TryParseFromTerrain(id), GetAllHazards, HazardExists, Count |
| `IEnvironmentalCombatService` | Push, Knockback, IsHazard, GetHazardType, ApplyHazardDamage, TickHazards, ProcessCriticalKnockback, GetDirectionToward, GetDirectionAway |

### Application Layer - Service

| Service | Description |
|---------|-------------|
| `EnvironmentalCombatService` | Full implementation of environmental combat with push/knockback mechanics, hazard detection, damage application, and critical knockback processing |

### Infrastructure Layer - Provider

| Provider | Description |
|----------|-------------|
| `JsonEnvironmentalHazardProvider` | Loads hazard definitions from JSON configuration file |

### Configuration

| File | Description |
|------|-------------|
| `config/environmental-hazards.json` | Hazard definitions (Lava, Spikes, Pit, AcidPool, Fire, PoisonGas, Ice, Electricity) |
| `config/schemas/environmental-hazards.schema.json` | JSON schema for hazard configuration validation |

---

## Push Mechanics

### Opposed Might Check
- **Pusher Roll:** `1d20 + Might modifier`
- **Target Roll:** `1d20 + Might modifier`
- **Target wins ties** - Push is resisted if target roll >= pusher roll

### Movement Processing
- Push moves target cell-by-cell in specified direction
- Movement stops on:
  - **Wall/Edge:** Push blocked, target stops at last valid position
  - **Entity:** Push blocked, target stops before blocking entity
  - **Hazard:** Push stops, hazard damage applied

### Push Result States
| State | Description |
|-------|-------------|
| `WasPushed` | Target was moved at least one cell |
| `WasResisted` | Target won opposed check |
| `WasBlocked` | Movement blocked by obstacle |
| `HitHazard` | Target was pushed into hazard |
| `WasKnockback` | Movement was knockback (no opposed check) |

---

## Knockback Mechanics

### Forced Movement
- **No opposed check** - Knockback always succeeds
- **Direction:** Away from source position
- **Distance:** Typically 1 cell on critical hit

### Critical Hit Knockback
- Triggered automatically on critical hits
- Moves target 1 cell away from attacker
- Configurable via `criticalKnockbackDistance` setting

---

## Hazard System

### Hazard Definitions

| Hazard | Damage | Type | Per Turn | Status Effect | Special |
|--------|--------|------|----------|---------------|---------|
| üåã Lava | 3d6 | Fire | YES | burning | - |
| ‚öîÔ∏è Spikes | 2d6 | Piercing | NO | bleeding | - |
| ‚¨õ Pit | 2d6 | Bludgeoning | NO | prone | Requires climb out |
| üíß Acid Pool | 2d4 | Acid | YES | - | Degrades armor |
| üî• Fire | 2d6 | Fire | YES | burning | - |
| ‚òÅÔ∏è Poison Gas | 1d6 | Poison | YES | poisoned | Entry damage: NO |
| ‚ùÑÔ∏è Ice | 1d8 | Cold | NO | slowed | - |
| ‚ö° Electricity | 2d8 | Lightning | NO | - | - |

### Hazard Detection
- Uses `GridCell.TerrainType == TerrainType.Hazardous`
- Hazard type parsed from `TerrainDefinitionId` (e.g., "hazard:lava")

### Damage Application
- Damage applied through `Combatant` ‚Üí `Player/Monster.TakeDamage()`
- Damage reduced by entity's defense value
- Status effects currently require `IEffectTarget` implementation (documented limitation)

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Push attempt | Debug | `"Push attempt: {Pusher} pushing {Target} {Direction} for {Distance} cell(s)"` |
| Opposed check | Debug | `"Opposed Might check: Pusher {PusherRoll} vs Target {TargetRoll}"` |
| Push resisted | Information | `"{Target} resisted push from {Pusher}"` |
| Push succeeded | Information | `"{Target} pushed {Cells} cells from {Start} to {End}"` |
| Knockback | Information | `"{Target} knocked back {Cells} cells from {Start} to {End}"` |
| Hazard detected | Debug | `"Target pushed into hazard at {Position}"` |
| Hazard damage | Information | `"{Target} took {Damage} {DamageType} damage from {HazardName}"` |
| Critical knockback | Information | `"Critical hit knockback: {Target} knocked back 1 cell"` |
| Hazard tick | Information | `"Hazard tick processed: {Count} combatants affected"` |
| Provider loaded | Information | `"JsonEnvironmentalHazardProvider loaded {Count} hazards"` |

---

## Unit Tests

**30 tests** covering:

### Push Tests (6 tests)
- Push moves target in correct direction on success
- Push uses opposed Might check (verifies dice rolls)
- Target wins ties - push resisted
- Push blocked by wall - stops at boundary
- Push blocked by entity - stops before blocker
- Push into hazard triggers damage

### Knockback Tests (3 tests)
- Knockback calculates direction away from source
- Knockback has no opposed check (forced movement)
- Critical knockback triggered on critical hit

### Critical Knockback Tests (2 tests)
- ProcessCriticalKnockback triggers on critical
- ProcessCriticalKnockback does nothing on non-critical

### Hazard Detection Tests (3 tests)
- IsHazard detects hazardous terrain
- IsHazard returns false for normal terrain
- GetHazardType parses hazard from terrain definition

### Hazard Damage Tests (2 tests)
- ApplyHazardDamage deals damage correctly (with defense reduction)
- ApplyHazardDamage does not apply status effect when target not IEffectTarget

### Hazard Tick Tests (2 tests)
- TickHazards processes per-turn damage for hazards with DamagePerTurn
- TickHazards skips hazards without per-turn damage

### Direction Tests (6 tests)
- GetDirectionToward returns correct cardinal directions
- GetDirectionAway returns opposite direction
- Direction tests for all cardinal directions (N, S, E, W)

### Provider Tests (6 tests)
- Provider loads hazards from configuration
- Provider returns correct hazard by type
- Provider returns null for unknown type
- Provider TryParseFromTerrain parses terrain definition IDs
- Provider counts hazards correctly
- Provider GetAllHazards returns all definitions

---

## Files Changed

| Path | Change |
|------|--------|
| `src/.../Domain/Enums/HazardType.cs` | MODIFIED - Added `Pit=9`, `Lava=10` |
| `src/.../Application/DTOs/EnvironmentalHazardDefinition.cs` | NEW |
| `src/.../Application/DTOs/PushResult.cs` | NEW |
| `src/.../Application/DTOs/HazardDamageResult.cs` | NEW |
| `src/.../Application/Events/EnvironmentalCombatEvents.cs` | NEW |
| `src/.../Application/Interfaces/IEnvironmentalHazardProvider.cs` | NEW |
| `src/.../Application/Interfaces/IEnvironmentalCombatService.cs` | NEW |
| `src/.../Application/Services/EnvironmentalCombatService.cs` | NEW |
| `src/.../Infrastructure/Providers/JsonEnvironmentalHazardProvider.cs` | NEW |
| `src/.../Infrastructure/DependencyInjection.cs` | MODIFIED - Added environmental combat DI registrations |
| `config/environmental-hazards.json` | NEW |
| `config/schemas/environmental-hazards.schema.json` | NEW |
| `tests/.../Services/EnvironmentalCombatServiceTests.cs` | NEW |

---

## DI Registration

```csharp
// Infrastructure (AddInfrastructure)
services.AddSingleton<IEnvironmentalHazardProvider>(sp =>
{
    var hazardsPath = Path.Combine(configPath, "environmental-hazards.json");
    var logger = sp.GetRequiredService<ILogger<JsonEnvironmentalHazardProvider>>();
    return new JsonEnvironmentalHazardProvider(hazardsPath, logger);
});

// Application (AddApplicationServices)
services.AddScoped<IEnvironmentalCombatService, EnvironmentalCombatService>();
```

---

## Known Limitations

### Status Effect Application
Status effects from hazards are **not currently applied** because:
- `Player` and `Monster` entities do not implement `IEffectTarget`
- The `EnvironmentalCombatService.GetEffectTarget()` method returns `null` for these entities
- A future enhancement should have `Player` and `Monster` implement `IEffectTarget` to enable status effect application

This is documented in the test `ApplyHazardDamage_DoesNotApplyStatusEffect_WhenTargetNotIEffectTarget`.

---

## v0.10.1 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.10.1a | Defense Actions | ‚úÖ Complete |
| v0.10.1b | Combat Stances | ‚úÖ Complete |
| v0.10.1c | Environmental Combat | ‚úÖ Complete |

---

## Dependencies

| Dependency | Purpose |
|------------|---------|
| `IEnvironmentalHazardProvider` | Loading hazard definitions from JSON |
| `IDiceService` | Rolling damage dice and opposed checks |
| `IBuffDebuffService` | Status effect application (when IEffectTarget implemented) |
| `IGameEventLogger` | Combat event logging |
| `CombatGrid` | Grid position management and entity placement |
| `MovementDirection` | Direction enum for push/knockback |

---

## Integration Notes

### Using Push in Combat

```csharp
// Push ability execution
var result = _environmentalCombatService.Push(
    pusher: attacker,
    target: defender,
    grid: combatGrid,
    direction: MovementDirection.East,
    distance: 2);

if (result.WasPushed)
{
    // Update grid position
    grid.MoveEntity(defender.Id, result.EndPosition);

    if (result.HitHazard && result.HazardDamage != null)
    {
        // Hazard damage already applied
        Log($"{defender.DisplayName} pushed into {result.HazardDamage.HazardName}!");
    }
}
else if (result.WasResisted)
{
    Log($"{defender.DisplayName} resisted the push!");
}
```

### Processing Critical Knockback

```csharp
// After attack resolution
if (attackResult.IsCriticalHit)
{
    var knockbackResult = _environmentalCombatService.ProcessCriticalKnockback(
        attacker, target, grid, isCritical: true);

    if (knockbackResult?.WasPushed == true)
    {
        // Position updated by knockback
    }
}
```

### Hazard Tick at Round Start

```csharp
// At the start of each combat round
var hazardResults = _environmentalCombatService.TickHazards(grid, combatants);

foreach (var result in hazardResults)
{
    Log($"{result.HazardName} dealt {result.DamageDealt} damage!");
}
```

---

*Document Version: 1.0 | Last Updated: 2026-01-18*
