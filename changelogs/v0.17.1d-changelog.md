# Changelog: v0.17.1d - Background Provider Service

**Release Date:** 2026-01-29
**Phase:** Background System (4/5)
**Status:** Complete

---

## Overview

Implements the Background Provider service that serves as the central access point for all background data. The provider loads background definitions from JSON configuration (`config/backgrounds.json`) and caches them in memory for efficient access throughout the application lifetime.

The provider follows the established `LineageProvider` pattern (v0.17.0e): file-based JSON loading, lazy initialization with double-checked locking, and dictionary-based caching keyed by the `Background` enum. The `IBackgroundProvider` interface is defined in the Application layer, while the `BackgroundProvider` implementation lives in the Infrastructure layer alongside the deserialization DTOs.

---

## Added

### Application Layer

#### Interfaces

- **`IBackgroundProvider`** (`Interfaces/IBackgroundProvider.cs`)
    - Interface defining the contract for background data access
    - Methods:
        - `GetAllBackgrounds()`: Returns all 6 background definitions
        - `GetBackground(Background)`: Returns specific definition or null
        - `GetSelectionText(Background)`: Returns creation UI flavor text or default message
        - `GetSkillGrants(Background)`: Returns skill grants or empty list
        - `GetEquipmentGrants(Background)`: Returns equipment grants or empty list
        - `GetNarrativeHooks(Background)`: Returns narrative hook strings or empty list
        - `HasBackground(Background)`: Checks if background exists in provider
    - Comprehensive XML documentation with examples, remarks, and seealso tags
    - Designed for singleton DI registration (immutable data after loading)

#### DTOs

- **`BackgroundConfigurationDto`** (`DTOs/BackgroundConfigurationDto.cs`)
    - Root DTO: `BackgroundConfigurationDto` with `Backgrounds` list property
    - `BackgroundDefinitionDto`: All string properties plus nested grant DTOs
    - `BackgroundSkillGrantDto`: SkillId, BonusAmount, GrantType fields
    - `BackgroundEquipmentGrantDto`: ItemId, Quantity, IsEquipped, Slot fields
    - Property names match JSON structure (camelCase, case-insensitive deserialization)
    - Complete XML documentation on all DTO types and properties

#### Exceptions

- **`BackgroundConfigurationException`** (`Exceptions/BackgroundConfigurationException.cs`)
    - Custom exception for background configuration loading/validation failures
    - Two constructors: message-only and message+innerException
    - Follows `LineageConfigurationException` pattern exactly
    - XML documentation lists common failure causes

### Infrastructure Layer

#### Services

- **`BackgroundProvider`** (`Services/BackgroundProvider.cs`)
    - Implements `IBackgroundProvider` with file-based JSON loading
    - Constructor takes `ILogger<BackgroundProvider>` and optional config path
    - Lazy initialization with double-checked locking via `EnsureInitialized()`
    - Configuration loading flow:
        1. `LoadConfiguration()`: Reads JSON file, deserializes with `System.Text.Json`
        2. `ValidateConfiguration()`: Checks count = 6, no duplicates, valid enum values
        3. `BuildCache()`: Maps DTOs to domain entities via `MapDtoToDefinition()`
    - DTO-to-entity mapping:
        - Parses `SkillGrantType` enum with fallback to `Permanent` on unknown values
        - Parses `EquipmentSlot` enum with null fallback on unknown values
        - Creates `BackgroundDefinition` via factory method with all grants
    - Constants: `ExpectedBackgroundCount = 6`, `DefaultConfigPath = "config/backgrounds.json"`
    - Exhaustive structured logging at all levels:
        - **Information**: Initialization start/success, cache population
        - **Debug**: Individual background loading, method calls, component access
        - **Warning**: Unknown enum values, missing hooks, background not found
        - **Error**: File not found, JSON parse failure, validation failures

### Dependency Injection

- **`DependencyInjection.cs`** — Updated
    - Added singleton registration for `IBackgroundProvider` → `BackgroundProvider`
    - Uses lambda factory with `Path.Combine(configPath, "backgrounds.json")`
    - Follows same pattern as `ILineageProvider` registration (v0.17.0e)

### Unit Tests

- **`BackgroundProviderTests`** (`Providers/BackgroundProviderTests.cs`) — 18 tests
    - `Constructor_NullLogger_ThrowsArgumentNullException`: Null logger validation
    - `Constructor_WithValidParameters_CreatesInstance`: Successful construction
    - `GetAllBackgrounds_ReturnsExactlySixBackgrounds`: Count and enum coverage
    - `GetBackground_WithValidBackground_ReturnsDefinition`: Village Smith properties
    - `GetBackground_ClanGuard_HasCorrectProperties`: Clan Guard full verification
    - `GetSelectionText_WithValidBackground_ReturnsText`: Valid text content
    - `GetSelectionText_WithInvalidBackground_ReturnsDefaultMessage`: Default fallback
    - `GetSkillGrants_ForVillageSmith_ReturnsCraftAndMight`: Skill grant verification
    - `GetSkillGrants_WithInvalidBackground_ReturnsEmptyList`: Empty fallback
    - `GetEquipmentGrants_ForClanGuard_ReturnsShieldAndSpear`: Equipped items
    - `GetEquipmentGrants_ForTravelingHealer_ReturnsBandagesx5`: Consumable quantities
    - `GetNarrativeHooks_ForRuinDelver_ReturnsThreeHooks`: Hook content
    - `HasBackground_WithLoadedBackground_ReturnsTrue`: Existence check
    - `HasBackground_WithInvalidBackground_ReturnsFalse`: Non-existence check
    - `GetAllBackgrounds_WithMissingFile_ThrowsBackgroundConfigurationException`: Error handling
    - `GetBackground_IsCachedAfterFirstAccess`: Reference equality caching
    - `GetAllBackgrounds_AllBackgroundsHaveSkillAndEquipmentGrants`: Cross-background validation
    - `GetSkillGrants_ForOutcastScavenger_ReturnsSurvivalAndStealth`: Additional background verification

---

## Design Decisions

### File-Based Loading vs IConfiguration

The design specification suggested using `IConfiguration`-based loading. However, the codebase consistently uses direct file-based JSON loading with `System.Text.Json` across all providers (LineageProvider, JsonStanceProvider, JsonAbilityTreeProvider, etc.). BackgroundProvider follows the established file-based pattern for consistency:
- Constructor accepts a file path string (not `IConfiguration`)
- JSON is loaded via `File.ReadAllText()` and `JsonSerializer.Deserialize()`
- `PropertyNameCaseInsensitive = true` for flexible JSON key matching

### Lazy Initialization Pattern

Following `LineageProvider`, the BackgroundProvider uses lazy initialization with double-checked locking rather than constructor-time loading. This ensures:
- Fast construction (no I/O in constructor)
- Thread-safe initialization on first access
- Lock-free reads after initialization

### DTOs in Application Layer

Following the `LineageConfigurationDto` precedent, background DTOs are placed in the Application layer (`Application.DTOs` namespace) rather than the Infrastructure layer. This keeps the DTO types accessible to both layers while maintaining the dependency direction (Infrastructure → Application → Domain).

### Validation Strategy

The provider validates configuration strictly:
- Exactly 6 backgrounds required (not more, not less)
- All `Background` enum values must be present
- No duplicates allowed
- Invalid enum values cause `BackgroundConfigurationException`

This matches the `LineageProvider` validation pattern (which requires exactly 4 lineages).

---

## Dependencies

### Prerequisites

- v0.17.1a (Background Enum & Definition) — Complete
- v0.17.1b (Skill Grants) — Complete
- v0.17.1c (Equipment Grants) — Complete

### Provides to v0.17.1e

| Type | Usage |
| ---- | ----- |
| `IBackgroundProvider` | Dependency for `IBackgroundApplicationService` |
| `BackgroundProvider` | Concrete implementation registered in DI |

### Provides to v0.17.5

| Type | Usage |
| ---- | ----- |
| `IBackgroundProvider` | Used by character creation workflow for background selection |
| `GetSelectionText()` | Displayed in background selection UI panel |
| `GetSkillGrants()` | Shown as preview before confirming background choice |
| `GetEquipmentGrants()` | Shown as preview before confirming background choice |
