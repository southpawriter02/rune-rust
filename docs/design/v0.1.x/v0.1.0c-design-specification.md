# v0.1.0c Design Specification: Room Types & Hidden Passages

**Version:** 0.1.0c
**Phase Name:** Room Types & Hidden Passages
**Parent Version:** v0.1.0 (Expanded Dungeon & Z-Axis)
**Prerequisites:** v0.1.0b Complete (Procedural Room Generation)
**Estimated Tests:** ~22 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [RoomType Enum](#4-roomtype-enum)
5. [Exit Value Object](#5-exit-value-object)
6. [Room Entity Updates](#6-room-entity-updates)
7. [Search Command & Discovery](#7-search-command--discovery)
8. [Room Type Behaviors](#8-room-type-behaviors)
9. [Configuration](#9-configuration)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Add room type variety and hidden passage discovery mechanics to the dungeon system. This phase introduces six distinct room types (Standard, Treasure, Trap, Boss, Safe, Shrine) with unique behaviors, replaces the simple Guid-based exit system with a rich Exit value object supporting visibility states, and implements the `search` command for player-driven discovery using the existing skill check system.

### 1.2 Current State

| Area | Current State (v0.1.0b) | Target State (v0.1.0c) |
|------|-------------------------|------------------------|
| Room types | Implicit (all Standard) | 6 explicit types with behaviors |
| Exit representation | `Dictionary<Direction, Guid>` | `Dictionary<Direction, Exit>` |
| Hidden passages | None | Discoverable via search command |
| Discovery mechanics | None | Perception/Investigation skill checks |
| Room descriptions | Static per template | Type-aware with indicators |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `RoomType` (6 values) |
| **Value Objects** | `Exit` with visibility state, `SearchResult` |
| **Entity Updates** | `Room` with type and enhanced exits |
| **Services** | `SearchService` for discovery mechanics |
| **Commands** | `search` command handler |
| **Configuration** | `room-types.json` |
| **Tests** | ~22 new unit tests |

### 1.4 Architectural Significance

This version establishes the **discovery mechanics pattern** that will be used for:
- Hidden content discovery (exits, items, secrets)
- Skill check integration for exploration
- Room-specific behaviors and interactions

---

## 2. Feature Overview

```
v0.1.0c Room Types & Hidden Passages
├── RoomType Enum
│   ├── Standard (default room)
│   ├── Treasure (valuable loot)
│   ├── Trap (hazard trigger)
│   ├── Boss (powerful enemy)
│   ├── Safe (no monsters)
│   └── Shrine (blessing/interaction)
├── Exit Value Object
│   ├── TargetRoomId
│   ├── IsHidden / IsDiscovered
│   ├── HiddenHint (subtle clue)
│   ├── DiscoveryDC
│   └── StairType (for vertical)
├── Room Entity Updates
│   ├── RoomType property
│   ├── Exit dictionary migration
│   ├── Type-aware descriptions
│   └── GetVisibleExits() method
├── Search Command
│   ├── search command handler
│   ├── Perception skill check
│   ├── Investigation alternative
│   └── Discovery result messaging
├── Hidden Discovery
│   ├── Hidden exit discovery
│   ├── Hidden item discovery
│   ├── DC-based difficulty
│   └── Hint system
└── Room Type Behaviors
    ├── Entry behavior triggers
    ├── Monster spawn rules
    └── Type-specific descriptions
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  CommandParser                        GameView                               │
│  ├── Parse("search")                  ├── RenderRoom()                      │
│  │   └── SearchCommand                │   └── Show room type indicator      │
│  └── Parse("look")                    └── DisplayExits()                    │
│      └── Include type info                └── Only show discovered exits    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  GameSessionService                   SearchService                          │
│  ├── HandleSearch()                   ├── PerformSearch()                   │
│  │   └── Call SearchService           │   └── Skill check for discovery    │
│  ├── GetCurrentRoom()                 ├── GetDiscoverables()                │
│  │   └── Return with type info        │   └── Hidden exits + items         │
│  └── TryMove()                        └── RevealDiscovery()                 │
│      └── Check exit discovered            └── Update exit/item state        │
│                                                                              │
│  Configuration:                                                              │
│  └── RoomTypeConfiguration                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Entities:                      Value Objects:           Enums:             │
│  ┌─────────────────────┐       ┌─────────────────────┐  ┌─────────────────┐ │
│  │ Room                │       │ Exit          // NEW│  │ RoomType  // NEW│ │
│  │ ├── RoomType        │       │ ├── TargetRoomId    │  │ ├── Standard    │ │
│  │ ├── Exits[Dir,Exit] │       │ ├── IsHidden        │  │ ├── Treasure    │ │
│  │ ├── HiddenItems     │       │ ├── IsDiscovered    │  │ ├── Trap        │ │
│  │ ├── GetVisibleExits │       │ ├── HiddenHint      │  │ ├── Boss        │ │
│  │ └── RevealExit()    │       │ ├── DiscoveryDC     │  │ ├── Safe        │ │
│  └─────────────────────┘       │ └── StairType?      │  │ └── Shrine      │ │
│                                └─────────────────────┘  └─────────────────┘ │
│                                ┌─────────────────────┐                      │
│                                │ SearchResult  // NEW│                      │
│                                │ ├── SkillCheckResult│                      │
│                                │ ├── DiscoveredExits │                      │
│                                │ └── DiscoveredItems │                      │
│                                └─────────────────────┘                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Search Command Flow

```
┌───────────────────┐
│ Player Input      │
│ "search"          │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────┐
│ CommandParser.Parse("search")         │
│ └── Return SearchCommand              │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│ GameSessionService.HandleSearch()     │
├───────────────────────────────────────┤
│ 1. Get current room                   │
│ 2. Call SearchService.PerformSearch() │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────┐
│ SearchService.PerformSearch(player, room)                 │
├───────────────────────────────────────────────────────────┤
│ 1. Get all hidden discoverables in room                   │
│    └── Hidden exits + hidden items                        │
│ 2. If nothing hidden, return early                        │
│    └── "You don't find anything unusual."                 │
│ 3. Find lowest DC among hidden items                      │
│ 4. Perform Perception skill check vs DC                   │
│    └── Use SkillCheckService.PerformCheckWithDC()         │
│ 5. On Success:                                            │
│    └── Reveal all items with DC ≤ roll result             │
│    └── Update Exit.IsDiscovered = true                    │
│    └── Return SearchResult with discoveries               │
│ 6. On Failure:                                            │
│    └── Return SearchResult with no discoveries            │
└───────────────────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────┐
│ Format and display result                                 │
├───────────────────────────────────────────────────────────┤
│ Success Example:                                          │
│ "You carefully examine your surroundings..."              │
│ "[Perception check: 14 vs DC 12 - Success!]"              │
│ "You notice a slight draft coming from the east."         │
│ "A hidden passage has been revealed!"                     │
├───────────────────────────────────────────────────────────┤
│ Failure Example:                                          │
│ "You search the room thoroughly..."                       │
│ "[Perception check: 8 vs DC 15 - Failure]"                │
│ "You don't find anything unusual."                        │
└───────────────────────────────────────────────────────────┘
```

### 3.3 Exit Visibility Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Room with Exits                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Exits Dictionary:                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ North: Exit { TargetId: A, IsHidden: false, IsDiscovered: true } │   │
│  │ East:  Exit { TargetId: B, IsHidden: true,  IsDiscovered: false }│   │
│  │ South: Exit { TargetId: C, IsHidden: false, IsDiscovered: true } │   │
│  │ Down:  Exit { TargetId: D, IsHidden: true,  IsDiscovered: true } │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  GetVisibleExits():                                                      │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ Returns only:                                                     │   │
│  │ - North (not hidden)                                              │   │
│  │ - South (not hidden)                                              │   │
│  │ - Down  (hidden but discovered)                                   │   │
│  │ Excludes:                                                         │   │
│  │ - East  (hidden and NOT discovered)                               │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Room Description:                                                       │
│  "Exits: north, south, down"                                            │
│  (East not shown until discovered via search)                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. RoomType Enum

### 4.1 Purpose

Define distinct room categories that affect gameplay, monster spawning, and room descriptions.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/RoomType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categorizes rooms by their primary function and behavior.
/// </summary>
/// <remarks>
/// Room types affect monster spawning rules, entry behaviors,
/// available interactions, and how the room is described to players.
/// </remarks>
public enum RoomType
{
    /// <summary>
    /// Standard room with normal encounters and no special behavior.
    /// </summary>
    Standard = 0,

    /// <summary>
    /// Contains valuable loot. May be guarded by monsters.
    /// </summary>
    Treasure = 1,

    /// <summary>
    /// Contains traps that may trigger on entry or interaction.
    /// </summary>
    Trap = 2,

    /// <summary>
    /// Contains a powerful boss monster. Exits may lock during combat.
    /// </summary>
    Boss = 3,

    /// <summary>
    /// Safe haven where monsters never spawn. May offer rest mechanics.
    /// </summary>
    Safe = 4,

    /// <summary>
    /// Religious or magical site with special interactions available.
    /// </summary>
    Shrine = 5
}
```

### 4.3 Room Type Properties

| Type | Monster Spawn | Loot Modifier | Special Behavior |
|------|---------------|---------------|------------------|
| Standard | Normal (template chance) | 1.0x | None |
| Treasure | 50% guarded | 2.0x+ | Extra loot spawned |
| Trap | Ambush possible | 1.0x | Trap trigger on entry |
| Boss | Always (boss) | 3.0x | Exit lock during combat |
| Safe | Never | 0.5x | Rest/healing available |
| Shrine | Rare guardian | 1.5x | Blessing interaction |

---

## 5. Exit Value Object

### 5.1 Purpose

Replace the simple `Guid` exit reference with a rich value object that tracks visibility state, discovery difficulty, and vertical connection type.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/Exit.cs`

```csharp
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an exit from a room with visibility and discovery state.
/// </summary>
/// <remarks>
/// Exits can be hidden and require discovery via the search command.
/// Hidden exits are not shown in room descriptions until discovered.
/// The Exit record replaces the previous Guid-based exit system.
/// </remarks>
public readonly record struct Exit
{
    /// <summary>
    /// Gets the ID of the room this exit leads to.
    /// </summary>
    public Guid TargetRoomId { get; init; }

    /// <summary>
    /// Gets whether this exit is hidden and requires discovery.
    /// </summary>
    /// <remarks>
    /// Hidden exits are not shown in room descriptions or the exits list
    /// until they have been discovered via the search command.
    /// </remarks>
    public bool IsHidden { get; init; }

    /// <summary>
    /// Gets whether this exit has been discovered by the player.
    /// </summary>
    /// <remarks>
    /// For non-hidden exits, this is always true.
    /// For hidden exits, this becomes true after successful discovery.
    /// </remarks>
    public bool IsDiscovered { get; init; }

    /// <summary>
    /// Gets the subtle hint that may be noticed before full discovery.
    /// </summary>
    /// <remarks>
    /// Examples: "a slight draft", "faint scratching sounds", "discolored stones"
    /// This hint may be shown on failed search attempts or high perception.
    /// </remarks>
    public string? HiddenHint { get; init; }

    /// <summary>
    /// Gets the difficulty class for discovering this exit.
    /// </summary>
    /// <remarks>
    /// Standard DC values from difficulty.json:
    /// - Easy: DC 8
    /// - Moderate: DC 12
    /// - Challenging: DC 15
    /// - Hard: DC 18
    /// </remarks>
    public int DiscoveryDC { get; init; }

    /// <summary>
    /// Gets the type of vertical connection, if applicable.
    /// </summary>
    /// <remarks>
    /// Null for horizontal exits (N, S, E, W).
    /// Set for vertical exits (Up, Down) to describe the connection type.
    /// </remarks>
    public StairType? StairType { get; init; }

    /// <summary>
    /// Gets whether this exit is visible to the player.
    /// </summary>
    /// <remarks>
    /// An exit is visible if it's not hidden, or if it has been discovered.
    /// </remarks>
    public bool IsVisible => !IsHidden || IsDiscovered;

    /// <summary>
    /// Creates a standard (non-hidden) exit to the target room.
    /// </summary>
    /// <param name="targetId">The ID of the target room.</param>
    /// <returns>A visible, non-hidden exit.</returns>
    public static Exit Standard(Guid targetId) => new()
    {
        TargetRoomId = targetId,
        IsHidden = false,
        IsDiscovered = true,
        DiscoveryDC = 0,
        StairType = null
    };

    /// <summary>
    /// Creates a standard vertical exit with stair type.
    /// </summary>
    /// <param name="targetId">The ID of the target room.</param>
    /// <param name="stairType">The type of vertical connection.</param>
    /// <returns>A visible, non-hidden vertical exit.</returns>
    public static Exit Vertical(Guid targetId, StairType stairType) => new()
    {
        TargetRoomId = targetId,
        IsHidden = false,
        IsDiscovered = true,
        DiscoveryDC = 0,
        StairType = stairType
    };

    /// <summary>
    /// Creates a hidden exit that requires discovery.
    /// </summary>
    /// <param name="targetId">The ID of the target room.</param>
    /// <param name="discoveryDC">The difficulty class for discovery.</param>
    /// <param name="hint">Optional hint for near-misses.</param>
    /// <returns>A hidden exit awaiting discovery.</returns>
    public static Exit Hidden(Guid targetId, int discoveryDC, string? hint = null) => new()
    {
        TargetRoomId = targetId,
        IsHidden = true,
        IsDiscovered = false,
        DiscoveryDC = discoveryDC,
        HiddenHint = hint,
        StairType = null
    };

    /// <summary>
    /// Creates a hidden vertical exit that requires discovery.
    /// </summary>
    /// <param name="targetId">The ID of the target room.</param>
    /// <param name="stairType">The type of vertical connection.</param>
    /// <param name="discoveryDC">The difficulty class for discovery.</param>
    /// <param name="hint">Optional hint for near-misses.</param>
    /// <returns>A hidden vertical exit awaiting discovery.</returns>
    public static Exit HiddenVertical(
        Guid targetId,
        StairType stairType,
        int discoveryDC,
        string? hint = null) => new()
    {
        TargetRoomId = targetId,
        IsHidden = true,
        IsDiscovered = false,
        DiscoveryDC = discoveryDC,
        HiddenHint = hint,
        StairType = stairType
    };

    /// <summary>
    /// Creates a new Exit with the discovered state set to true.
    /// </summary>
    /// <returns>A copy of this exit with IsDiscovered = true.</returns>
    public Exit AsDiscovered() => this with { IsDiscovered = true };
}
```

---

## 6. Room Entity Updates

### 6.1 Exit Dictionary Migration

The `Room` entity's `_exits` dictionary changes from `Dictionary<Direction, Guid>` to `Dictionary<Direction, Exit>`.

### 6.2 Updated Room Entity

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs` (changes)

```csharp
/// <summary>
/// Gets the type of this room.
/// </summary>
/// <remarks>
/// Room type affects monster spawning, loot, and available interactions.
/// </remarks>
public RoomType RoomType { get; private set; } = RoomType.Standard;

/// <summary>
/// Dictionary mapping directions to Exit value objects.
/// </summary>
private readonly Dictionary<Direction, Exit> _exits = [];

/// <summary>
/// List of hidden items that require discovery.
/// </summary>
private readonly List<HiddenItem> _hiddenItems = [];

/// <summary>
/// Gets a read-only dictionary of all exits from this room.
/// </summary>
/// <remarks>
/// Includes both visible and hidden exits. Use GetVisibleExits()
/// to get only exits the player can currently see.
/// </remarks>
public IReadOnlyDictionary<Direction, Exit> Exits => _exits.AsReadOnly();

/// <summary>
/// Gets a read-only list of hidden items in this room.
/// </summary>
public IReadOnlyList<HiddenItem> HiddenItems => _hiddenItems.AsReadOnly();

/// <summary>
/// Sets the room type.
/// </summary>
/// <param name="roomType">The type to set.</param>
public void SetRoomType(RoomType roomType)
{
    RoomType = roomType;
}

/// <summary>
/// Adds or updates an exit from this room.
/// </summary>
/// <param name="direction">The direction of the exit.</param>
/// <param name="exit">The exit value object.</param>
public void AddExit(Direction direction, Exit exit)
{
    _exits[direction] = exit;
}

/// <summary>
/// Adds a standard (non-hidden) exit to this room.
/// </summary>
/// <param name="direction">The direction of the exit.</param>
/// <param name="targetRoomId">The ID of the target room.</param>
public void AddExit(Direction direction, Guid targetRoomId)
{
    _exits[direction] = Exit.Standard(targetRoomId);
}

/// <summary>
/// Adds a hidden exit that requires discovery.
/// </summary>
/// <param name="direction">The direction of the exit.</param>
/// <param name="targetRoomId">The ID of the target room.</param>
/// <param name="discoveryDC">The difficulty class for discovery.</param>
/// <param name="hint">Optional hint for the hidden passage.</param>
public void AddHiddenExit(Direction direction, Guid targetRoomId, int discoveryDC, string? hint = null)
{
    _exits[direction] = Exit.Hidden(targetRoomId, discoveryDC, hint);
}

/// <summary>
/// Gets only exits that are visible to the player.
/// </summary>
/// <returns>Dictionary of visible exits (not hidden or already discovered).</returns>
public IReadOnlyDictionary<Direction, Exit> GetVisibleExits()
{
    return _exits
        .Where(kvp => kvp.Value.IsVisible)
        .ToDictionary(kvp => kvp.Key, kvp => kvp.Value)
        .AsReadOnly();
}

/// <summary>
/// Gets hidden exits that have not yet been discovered.
/// </summary>
/// <returns>Dictionary of undiscovered hidden exits.</returns>
public IReadOnlyDictionary<Direction, Exit> GetHiddenExits()
{
    return _exits
        .Where(kvp => kvp.Value.IsHidden && !kvp.Value.IsDiscovered)
        .ToDictionary(kvp => kvp.Key, kvp => kvp.Value)
        .AsReadOnly();
}

/// <summary>
/// Reveals a hidden exit, marking it as discovered.
/// </summary>
/// <param name="direction">The direction of the exit to reveal.</param>
/// <returns>True if the exit was revealed; false if not found or already visible.</returns>
public bool RevealExit(Direction direction)
{
    if (!_exits.TryGetValue(direction, out var exit))
        return false;

    if (!exit.IsHidden || exit.IsDiscovered)
        return false;

    _exits[direction] = exit.AsDiscovered();
    return true;
}

/// <summary>
/// Checks if there is a visible exit in the specified direction.
/// </summary>
/// <param name="direction">The direction to check.</param>
/// <returns>True if a visible exit exists in that direction.</returns>
public bool HasVisibleExit(Direction direction)
{
    return _exits.TryGetValue(direction, out var exit) && exit.IsVisible;
}

/// <summary>
/// Gets the target room ID for a visible exit.
/// </summary>
/// <param name="direction">The direction of the exit.</param>
/// <returns>The target room ID if a visible exit exists; otherwise, null.</returns>
public Guid? GetVisibleExit(Direction direction)
{
    if (_exits.TryGetValue(direction, out var exit) && exit.IsVisible)
        return exit.TargetRoomId;
    return null;
}

/// <summary>
/// Gets a human-readable description of visible exits.
/// </summary>
/// <returns>A string describing available exits.</returns>
public string GetExitsDescription()
{
    var visibleExits = GetVisibleExits();

    if (visibleExits.Count == 0)
        return "There are no visible exits.";

    var horizontalExits = visibleExits.Keys
        .Where(d => d is Direction.North or Direction.South or Direction.East or Direction.West)
        .Select(d => d.ToString().ToLower());

    var verticalExits = visibleExits.Keys
        .Where(d => d is Direction.Up or Direction.Down)
        .Select(d => d == Direction.Up ? "up" : "down");

    var allExits = horizontalExits.Concat(verticalExits).ToList();

    return $"Exits: {string.Join(", ", allExits)}";
}

/// <summary>
/// Adds a hidden item to this room.
/// </summary>
/// <param name="hiddenItem">The hidden item to add.</param>
public void AddHiddenItem(HiddenItem hiddenItem)
{
    ArgumentNullException.ThrowIfNull(hiddenItem);
    _hiddenItems.Add(hiddenItem);
}

/// <summary>
/// Reveals a hidden item, moving it to the regular items list.
/// </summary>
/// <param name="hiddenItemId">The ID of the hidden item to reveal.</param>
/// <returns>The revealed item, or null if not found.</returns>
public Item? RevealHiddenItem(Guid hiddenItemId)
{
    var hiddenItem = _hiddenItems.FirstOrDefault(h => h.Id == hiddenItemId);
    if (hiddenItem == null) return null;

    _hiddenItems.Remove(hiddenItem);
    _items.Add(hiddenItem.Item);
    return hiddenItem.Item;
}

/// <summary>
/// Gets undiscovered hidden items.
/// </summary>
public IReadOnlyList<HiddenItem> GetUndiscoveredHiddenItems() =>
    _hiddenItems.Where(h => !h.IsDiscovered).ToList().AsReadOnly();

/// <summary>
/// Gets a room type indicator for display.
/// </summary>
/// <returns>A short string indicating room type, or empty for Standard.</returns>
public string GetRoomTypeIndicator() => RoomType switch
{
    RoomType.Treasure => "[Treasure Room]",
    RoomType.Trap => "[Trap Room]",
    RoomType.Boss => "[Boss Chamber]",
    RoomType.Safe => "[Safe Haven]",
    RoomType.Shrine => "[Shrine]",
    _ => string.Empty
};
```

---

## 7. Search Command & Discovery

### 7.1 SearchResult Value Object

**File:** `src/Core/RuneAndRust.Application/ValueObjects/SearchResult.cs`

```csharp
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.ValueObjects;

/// <summary>
/// Result of a search action in a room.
/// </summary>
/// <param name="SkillCheck">The skill check result for the search.</param>
/// <param name="DiscoveredExits">Directions of newly discovered exits.</param>
/// <param name="DiscoveredItems">IDs of newly discovered items.</param>
/// <param name="NothingToFind">True if there was nothing hidden to find.</param>
public readonly record struct SearchResult(
    SkillCheckResult? SkillCheck,
    IReadOnlyList<Direction> DiscoveredExits,
    IReadOnlyList<Guid> DiscoveredItems,
    bool NothingToFind)
{
    /// <summary>
    /// Gets whether any discoveries were made.
    /// </summary>
    public bool FoundSomething => DiscoveredExits.Count > 0 || DiscoveredItems.Count > 0;

    /// <summary>
    /// Gets whether the search succeeded (check passed or nothing to find).
    /// </summary>
    public bool IsSuccess => NothingToFind || (SkillCheck?.IsSuccess ?? false);

    /// <summary>
    /// Creates a result for when there's nothing hidden in the room.
    /// </summary>
    public static SearchResult NothingHidden() => new(
        null,
        Array.Empty<Direction>(),
        Array.Empty<Guid>(),
        NothingToFind: true);

    /// <summary>
    /// Creates a result for a failed search attempt.
    /// </summary>
    public static SearchResult Failed(SkillCheckResult check) => new(
        check,
        Array.Empty<Direction>(),
        Array.Empty<Guid>(),
        NothingToFind: false);

    /// <summary>
    /// Creates a result for a successful search with discoveries.
    /// </summary>
    public static SearchResult Success(
        SkillCheckResult check,
        IReadOnlyList<Direction> exits,
        IReadOnlyList<Guid> items) => new(
        check,
        exits,
        items,
        NothingToFind: false);
}
```

### 7.2 HiddenItem Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/HiddenItem.cs`

```csharp
using RuneAndRust.Domain.Entities;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an item that is hidden and requires discovery.
/// </summary>
/// <param name="Id">Unique identifier for tracking discovery.</param>
/// <param name="Item">The hidden item.</param>
/// <param name="DiscoveryDC">Difficulty class for discovery.</param>
/// <param name="Hint">Optional hint for near-misses.</param>
/// <param name="IsDiscovered">Whether this item has been discovered.</param>
public record HiddenItem(
    Guid Id,
    Item Item,
    int DiscoveryDC,
    string? Hint = null,
    bool IsDiscovered = false)
{
    /// <summary>
    /// Creates a new hidden item with a generated ID.
    /// </summary>
    public static HiddenItem Create(Item item, int discoveryDC, string? hint = null) =>
        new(Guid.NewGuid(), item, discoveryDC, hint, false);

    /// <summary>
    /// Returns a copy marked as discovered.
    /// </summary>
    public HiddenItem AsDiscovered() => this with { IsDiscovered = true };
}
```

### 7.3 SearchService

**File:** `src/Core/RuneAndRust.Application/Services/SearchService.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.ValueObjects;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Service for performing search actions and discovering hidden content.
/// </summary>
public class SearchService
{
    private readonly SkillCheckService _skillCheckService;
    private readonly ILogger<SearchService> _logger;

    /// <summary>
    /// The default skill used for searching.
    /// </summary>
    public const string DefaultSearchSkill = "perception";

    /// <summary>
    /// Alternative skill that can be used for searching.
    /// </summary>
    public const string AlternativeSearchSkill = "investigation";

    /// <summary>
    /// Creates a new SearchService.
    /// </summary>
    public SearchService(
        SkillCheckService skillCheckService,
        ILogger<SearchService> logger)
    {
        _skillCheckService = skillCheckService ?? throw new ArgumentNullException(nameof(skillCheckService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Performs a search action in the current room.
    /// </summary>
    /// <param name="player">The player performing the search.</param>
    /// <param name="room">The room being searched.</param>
    /// <param name="skillId">The skill to use (defaults to perception).</param>
    /// <returns>The search result with any discoveries.</returns>
    public SearchResult PerformSearch(
        Player player,
        Room room,
        string skillId = DefaultSearchSkill)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(room);

        _logger.LogDebug(
            "Player {Player} searching room {Room} with {Skill}",
            player.Name, room.Name, skillId);

        // Get all hidden content
        var hiddenExits = room.GetHiddenExits();
        var hiddenItems = room.GetUndiscoveredHiddenItems();

        // Nothing to find?
        if (hiddenExits.Count == 0 && hiddenItems.Count == 0)
        {
            _logger.LogDebug("No hidden content in room {Room}", room.Name);
            return SearchResult.NothingHidden();
        }

        // Find the lowest DC (easiest to discover)
        var exitDCs = hiddenExits.Values.Select(e => e.DiscoveryDC);
        var itemDCs = hiddenItems.Select(i => i.DiscoveryDC);
        var lowestDC = exitDCs.Concat(itemDCs).Min();

        // Perform skill check against lowest DC
        var checkResult = _skillCheckService.PerformCheckWithDC(
            player,
            skillId,
            lowestDC,
            GetDifficultyName(lowestDC));

        _logger.LogInformation(
            "Search check: {Total} vs DC {DC} = {Result}",
            checkResult.TotalResult, lowestDC, checkResult.SuccessLevel);

        if (!checkResult.IsSuccess)
        {
            // Check if we should give a hint (within 3 of DC)
            if (checkResult.Margin >= -3)
            {
                LogNearMissHint(hiddenExits, hiddenItems);
            }

            return SearchResult.Failed(checkResult);
        }

        // Discover everything with DC <= roll result
        var discoveredExits = new List<Direction>();
        var discoveredItems = new List<Guid>();

        foreach (var (direction, exit) in hiddenExits)
        {
            if (exit.DiscoveryDC <= checkResult.TotalResult)
            {
                if (room.RevealExit(direction))
                {
                    discoveredExits.Add(direction);
                    _logger.LogInformation(
                        "Discovered hidden exit to {Direction} (DC {DC})",
                        direction, exit.DiscoveryDC);
                }
            }
        }

        foreach (var hiddenItem in hiddenItems)
        {
            if (hiddenItem.DiscoveryDC <= checkResult.TotalResult)
            {
                var revealed = room.RevealHiddenItem(hiddenItem.Id);
                if (revealed != null)
                {
                    discoveredItems.Add(hiddenItem.Id);
                    _logger.LogInformation(
                        "Discovered hidden item {Item} (DC {DC})",
                        revealed.Name, hiddenItem.DiscoveryDC);
                }
            }
        }

        return SearchResult.Success(checkResult, discoveredExits, discoveredItems);
    }

    /// <summary>
    /// Gets a difficulty name for a DC value.
    /// </summary>
    private string GetDifficultyName(int dc) => dc switch
    {
        <= 5 => "Trivial",
        <= 8 => "Easy",
        <= 12 => "Moderate",
        <= 15 => "Challenging",
        <= 18 => "Hard",
        <= 22 => "Very Hard",
        <= 26 => "Extreme",
        _ => "Legendary"
    };

    /// <summary>
    /// Logs a hint for near-miss searches.
    /// </summary>
    private void LogNearMissHint(
        IReadOnlyDictionary<Direction, Exit> exits,
        IReadOnlyList<HiddenItem> items)
    {
        // Find hints to potentially show
        var exitHints = exits.Values
            .Where(e => !string.IsNullOrEmpty(e.HiddenHint))
            .Select(e => e.HiddenHint!)
            .ToList();

        var itemHints = items
            .Where(i => !string.IsNullOrEmpty(i.Hint))
            .Select(i => i.Hint!)
            .ToList();

        if (exitHints.Count > 0 || itemHints.Count > 0)
        {
            _logger.LogDebug(
                "Near miss - could show hints: {Hints}",
                string.Join(", ", exitHints.Concat(itemHints)));
        }
    }
}
```

### 7.4 Command Integration

The `search` command is handled in `GameSessionService`:

```csharp
/// <summary>
/// Handles the search command.
/// </summary>
/// <param name="skillOverride">Optional skill to use instead of perception.</param>
/// <returns>The search result.</returns>
public SearchResult HandleSearch(string? skillOverride = null)
{
    var player = _currentSession?.Player
        ?? throw new InvalidOperationException("No active session");

    var room = GetCurrentRoom()
        ?? throw new InvalidOperationException("Player not in a room");

    var skill = skillOverride ?? SearchService.DefaultSearchSkill;
    return _searchService.PerformSearch(player, room, skill);
}
```

---

## 8. Room Type Behaviors

### 8.1 Entry Behaviors

When a player enters a room, the room type may trigger special behavior:

| Type | Entry Trigger | Description |
|------|---------------|-------------|
| Standard | None | Normal room entry |
| Treasure | None | No immediate effect |
| Trap | Perception check | Auto-check to detect trap |
| Boss | Warning message | "A powerful presence awaits..." |
| Safe | Healing notification | "You feel safe here." |
| Shrine | Blessing prompt | Offer to interact with shrine |

### 8.2 Monster Spawn Rules

Room types affect procedural monster spawning from v0.1.0b:

```csharp
/// <summary>
/// Adjusts monster spawn chance based on room type.
/// </summary>
public float GetAdjustedMonsterChance(float baseChance, RoomType roomType) => roomType switch
{
    RoomType.Safe => 0f,                    // Never spawn monsters
    RoomType.Boss => 1f,                    // Always spawn (boss)
    RoomType.Treasure => baseChance * 0.5f, // 50% chance of guard
    RoomType.Shrine => baseChance * 0.2f,   // Rare guardians
    RoomType.Trap => baseChance * 1.2f,     // Slightly more likely
    _ => baseChance                          // Normal chance
};
```

### 8.3 Room Type Descriptions

Room descriptions include type-specific elements:

```csharp
/// <summary>
/// Gets type-specific description addition.
/// </summary>
public string GetRoomTypeDescription(RoomType type) => type switch
{
    RoomType.Treasure => "Glittering objects catch your eye among the shadows.",
    RoomType.Trap => "Something feels off about this place...",
    RoomType.Boss => "An ominous presence fills the chamber.",
    RoomType.Safe => "A warm light fills this sanctuary.",
    RoomType.Shrine => "Ancient symbols glow softly on an altar.",
    _ => string.Empty
};
```

---

## 9. Configuration

### 9.1 RoomTypeConfiguration Class

**File:** `src/Core/RuneAndRust.Application/Configuration/RoomTypeConfiguration.cs`

```csharp
namespace RuneAndRust.Application.Configuration;

/// <summary>
/// Configuration for room type definitions.
/// </summary>
public class RoomTypeConfiguration
{
    /// <summary>
    /// Schema version for configuration validation.
    /// </summary>
    public string Version { get; init; } = "1.0";

    /// <summary>
    /// Room type definitions keyed by type ID.
    /// </summary>
    public IReadOnlyDictionary<string, RoomTypeDefinition> RoomTypes { get; init; } =
        new Dictionary<string, RoomTypeDefinition>();
}

/// <summary>
/// Defines a room type with its properties and behaviors.
/// </summary>
public class RoomTypeDefinition
{
    /// <summary>
    /// Room type identifier (matches enum name).
    /// </summary>
    public string Id { get; init; } = string.Empty;

    /// <summary>
    /// Display name for this room type.
    /// </summary>
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// Description shown when entering rooms of this type.
    /// </summary>
    public string EntryDescription { get; init; } = string.Empty;

    /// <summary>
    /// Short indicator shown in room header.
    /// </summary>
    public string Indicator { get; init; } = string.Empty;

    /// <summary>
    /// Monster spawn multiplier (1.0 = normal, 0 = never).
    /// </summary>
    public float MonsterSpawnMultiplier { get; init; } = 1.0f;

    /// <summary>
    /// Loot quality multiplier.
    /// </summary>
    public float LootMultiplier { get; init; } = 1.0f;

    /// <summary>
    /// Whether this room type allows resting.
    /// </summary>
    public bool AllowsRest { get; init; }

    /// <summary>
    /// Description pool for atmospheric additions.
    /// </summary>
    public IReadOnlyList<string> DescriptionPool { get; init; } = [];
}
```

---

## 10. Data Model Changes

### 10.1 New Enums

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Enum | `RoomType` | `Domain/Enums/RoomType.cs` | 6 room type values |

### 10.2 New Value Objects

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Record | `Exit` | `Domain/ValueObjects/Exit.cs` | Exit with visibility state |
| Record | `HiddenItem` | `Domain/ValueObjects/HiddenItem.cs` | Hidden item container |
| Record | `SearchResult` | `Application/ValueObjects/SearchResult.cs` | Search action result |

### 10.3 New Configuration Classes

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Class | `RoomTypeConfiguration` | `Application/Configuration/` | Room type definitions |
| Class | `RoomTypeDefinition` | `Application/Configuration/` | Individual type config |

### 10.4 New Services

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Class | `SearchService` | `Application/Services/` | Search and discovery logic |

### 10.5 Modified Entities

| Entity | Changes |
|--------|---------|
| `Room` | Add `RoomType`, change `_exits` to `Dictionary<Direction, Exit>`, add hidden item support |
| `Dungeon` | Update `ConnectRooms` to use `Exit` value object |

---

## 11. Configuration File Schemas

### 11.1 room-types.json

**File:** `config/room-types.json`

```json
{
  "version": "1.0",
  "roomTypes": {
    "standard": {
      "id": "standard",
      "name": "Standard Room",
      "entryDescription": "",
      "indicator": "",
      "monsterSpawnMultiplier": 1.0,
      "lootMultiplier": 1.0,
      "allowsRest": false,
      "descriptionPool": []
    },
    "treasure": {
      "id": "treasure",
      "name": "Treasure Room",
      "entryDescription": "Glittering objects catch your eye among the shadows.",
      "indicator": "[Treasure Room]",
      "monsterSpawnMultiplier": 0.5,
      "lootMultiplier": 2.0,
      "allowsRest": false,
      "descriptionPool": [
        "Gold coins are scattered across the floor.",
        "An ornate chest sits in the corner.",
        "Precious gems glitter from a pile of treasure."
      ]
    },
    "trap": {
      "id": "trap",
      "name": "Trap Room",
      "entryDescription": "Something feels off about this place...",
      "indicator": "[Trap Room]",
      "monsterSpawnMultiplier": 1.2,
      "lootMultiplier": 1.0,
      "allowsRest": false,
      "descriptionPool": [
        "Suspicious pressure plates line the floor.",
        "You notice thin wires stretched across the passage.",
        "The walls have small holes that could hide dart traps."
      ]
    },
    "boss": {
      "id": "boss",
      "name": "Boss Chamber",
      "entryDescription": "An ominous presence fills the chamber.",
      "indicator": "[Boss Chamber]",
      "monsterSpawnMultiplier": 1.0,
      "lootMultiplier": 3.0,
      "allowsRest": false,
      "descriptionPool": [
        "The air crackles with dark energy.",
        "Bones of previous challengers litter the ground.",
        "A massive throne dominates the far end of the chamber."
      ]
    },
    "safe": {
      "id": "safe",
      "name": "Safe Haven",
      "entryDescription": "You feel safe here. The dangers of the dungeon seem distant.",
      "indicator": "[Safe Haven]",
      "monsterSpawnMultiplier": 0.0,
      "lootMultiplier": 0.5,
      "allowsRest": true,
      "descriptionPool": [
        "A warm fire crackles in a hearth.",
        "Soft cushions and blankets offer a place to rest.",
        "Clean water flows from a fountain."
      ]
    },
    "shrine": {
      "id": "shrine",
      "name": "Shrine",
      "entryDescription": "Ancient symbols glow softly on a weathered altar.",
      "indicator": "[Shrine]",
      "monsterSpawnMultiplier": 0.2,
      "lootMultiplier": 1.5,
      "allowsRest": false,
      "descriptionPool": [
        "Incense smoke curls around ancient statues.",
        "Offerings of coin and food lie at the altar's base.",
        "Faded murals depict forgotten gods."
      ]
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `SearchService` | Information | Successful discovery, search check result |
| `SearchService` | Debug | Search initiated, nothing to find, near-miss hints |
| `SearchService` | Warning | Invalid skill specified |
| `Room` | Debug | Exit revealed, hidden item revealed |
| `Room` | Information | Room type set |
| `GameSessionService` | Information | Search command executed |
| `GameSessionService` | Debug | Player movement with hidden exit check |

### 12.2 Log Message Examples

```
[Information] Search check: 14 vs DC 12 = Success
[Information] Discovered hidden exit to East (DC 12)
[Information] Discovered hidden item Ancient Key (DC 15)
[Debug] Player searching room Ancient Library with perception
[Debug] No hidden content in room Entrance Hall
[Debug] Near miss - could show hints: "a slight draft to the east"
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| RoomType enum | ~2 |
| Exit value object | ~4 |
| HiddenItem value object | ~2 |
| Room.GetVisibleExits() | ~3 |
| Room.RevealExit() | ~2 |
| Room hidden item methods | ~2 |
| SearchResult value object | ~2 |
| SearchService.PerformSearch | ~5 |
| **Total** | **~22** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `RoomTypeTests.cs` | ~2 | Enum values, properties |
| `ExitTests.cs` | ~4 | Standard, Hidden, Vertical factories, IsVisible |
| `HiddenItemTests.cs` | ~2 | Create, AsDiscovered |
| `RoomExitVisibilityTests.cs` | ~5 | GetVisibleExits, RevealExit, GetHiddenExits |
| `RoomHiddenItemTests.cs` | ~2 | AddHiddenItem, RevealHiddenItem |
| `SearchResultTests.cs` | ~2 | Factory methods, properties |
| `SearchServiceTests.cs` | ~5 | PerformSearch scenarios |

### 13.3 Sample Test Cases

#### ExitTests.cs

```csharp
[Test]
public void Standard_CreatesVisibleExit()
{
    var targetId = Guid.NewGuid();
    var exit = Exit.Standard(targetId);

    Assert.That(exit.TargetRoomId, Is.EqualTo(targetId));
    Assert.That(exit.IsHidden, Is.False);
    Assert.That(exit.IsDiscovered, Is.True);
    Assert.That(exit.IsVisible, Is.True);
}

[Test]
public void Hidden_CreatesHiddenExit()
{
    var targetId = Guid.NewGuid();
    var exit = Exit.Hidden(targetId, 15, "a slight draft");

    Assert.That(exit.IsHidden, Is.True);
    Assert.That(exit.IsDiscovered, Is.False);
    Assert.That(exit.IsVisible, Is.False);
    Assert.That(exit.DiscoveryDC, Is.EqualTo(15));
    Assert.That(exit.HiddenHint, Is.EqualTo("a slight draft"));
}

[Test]
public void AsDiscovered_ReturnsDiscoveredCopy()
{
    var exit = Exit.Hidden(Guid.NewGuid(), 12);

    var discovered = exit.AsDiscovered();

    Assert.That(discovered.IsHidden, Is.True); // Still marked as "was hidden"
    Assert.That(discovered.IsDiscovered, Is.True);
    Assert.That(discovered.IsVisible, Is.True);
}

[Test]
public void Vertical_IncludesStairType()
{
    var exit = Exit.Vertical(Guid.NewGuid(), StairType.Ladder);

    Assert.That(exit.StairType, Is.EqualTo(StairType.Ladder));
    Assert.That(exit.IsVisible, Is.True);
}
```

#### SearchServiceTests.cs

```csharp
[Test]
public void PerformSearch_NoHiddenContent_ReturnsNothingHidden()
{
    var room = CreateRoomWithNoHiddenContent();
    var player = CreateTestPlayer();
    var service = CreateSearchService();

    var result = service.PerformSearch(player, room);

    Assert.That(result.NothingToFind, Is.True);
    Assert.That(result.SkillCheck, Is.Null);
}

[Test]
public void PerformSearch_SuccessfulCheck_RevealsHiddenExits()
{
    var room = CreateRoomWithHiddenExit(Direction.East, discoveryDC: 10);
    var player = CreatePlayerWithHighPerception();
    var service = CreateSearchService();

    var result = service.PerformSearch(player, room);

    Assert.That(result.IsSuccess, Is.True);
    Assert.That(result.DiscoveredExits, Contains.Item(Direction.East));
    Assert.That(room.GetVisibleExits().ContainsKey(Direction.East), Is.True);
}

[Test]
public void PerformSearch_FailedCheck_DoesNotReveal()
{
    var room = CreateRoomWithHiddenExit(Direction.East, discoveryDC: 25);
    var player = CreatePlayerWithLowPerception();
    var service = CreateSearchService();

    var result = service.PerformSearch(player, room);

    Assert.That(result.IsSuccess, Is.False);
    Assert.That(result.DiscoveredExits, Is.Empty);
    Assert.That(room.GetHiddenExits().ContainsKey(Direction.East), Is.True);
}

[Test]
public void PerformSearch_MultipleDCs_OnlyRevealsEasierOnes()
{
    var room = new Room("Test", "Test", Position3D.Origin);
    room.AddHiddenExit(Direction.East, Guid.NewGuid(), 10, null);  // DC 10
    room.AddHiddenExit(Direction.West, Guid.NewGuid(), 20, null);  // DC 20
    var player = CreatePlayerWithMidPerception(); // Rolls ~12-14
    var service = CreateSearchService();

    var result = service.PerformSearch(player, room);

    // Should discover East (DC 10) but not West (DC 20) if roll was ~12-14
    Assert.That(result.DiscoveredExits, Contains.Item(Direction.East));
    Assert.That(result.DiscoveredExits, Does.Not.Contain(Direction.West));
}
```

---

## 14. Use Cases

### UC-001: Search Reveals Hidden Exit

**Actor:** Player
**Flow:** Enter room with hidden exit → Type "search" → Roll Perception vs DC → Success → Exit revealed → Exit now appears in exits list

### UC-002: Search Fails to Find Hidden Content

**Actor:** Player
**Flow:** Enter room with hidden exit (DC 18) → Type "search" → Roll Perception → Fail (roll 12) → "You don't find anything unusual." → Exit remains hidden

### UC-003: Near-Miss Search Gets Hint

**Actor:** Player
**Flow:** Enter room with hidden exit (DC 15, hint: "slight draft") → Type "search" → Roll 13 (within 3 of DC) → "You don't find anything, but you notice a slight draft to the east."

### UC-004: Movement Blocked by Undiscovered Exit

**Actor:** Player
**Flow:** Room has hidden exit East (not discovered) → Player types "east" → "There is no exit in that direction." → Player must search first

### UC-005: Enter Treasure Room

**Actor:** Player
**Flow:** Move into room with RoomType.Treasure → Room description includes "[Treasure Room]" → "Glittering objects catch your eye..." → Enhanced loot available

### UC-006: Enter Safe Room

**Actor:** Player
**Flow:** Move into room with RoomType.Safe → "[Safe Haven]" shown → "You feel safe here." → No monsters present → Rest option available

### UC-007: Discover Hidden Item

**Actor:** Player
**Flow:** Room has hidden item (Ancient Key, DC 12) → Search succeeds → "You find an Ancient Key hidden in the rubble!" → Item added to room items

---

## 15. Deliverable Checklist

### Domain Layer

- [ ] `RoomType.cs` enum created (6 values)
- [ ] `Exit.cs` value object created
- [ ] `HiddenItem.cs` value object created
- [ ] `Room.cs` updated with RoomType property
- [ ] `Room.cs` exits dictionary migrated to Exit type
- [ ] `Room.cs` hidden item support added
- [ ] `Room.cs` GetVisibleExits() implemented
- [ ] `Room.cs` RevealExit() implemented
- [ ] `Dungeon.cs` ConnectRooms() updated for Exit type

### Application Layer

- [ ] `SearchResult.cs` value object created
- [ ] `SearchService.cs` implemented
- [ ] `RoomTypeConfiguration.cs` created
- [ ] `RoomTypeDefinition.cs` created
- [ ] `GameSessionService.cs` HandleSearch() added

### Presentation Layer

- [ ] `search` command parsed
- [ ] Room type indicator in room display
- [ ] Hidden exit filtering in exit display

### Configuration Files

- [ ] `config/room-types.json` created

### Infrastructure Updates

- [ ] `JsonConfigurationProvider` - Load room types
- [ ] `DependencyInjection.cs` - Register SearchService

### Tests

- [ ] `RoomTypeTests.cs` (~2 tests)
- [ ] `ExitTests.cs` (~4 tests)
- [ ] `HiddenItemTests.cs` (~2 tests)
- [ ] `RoomExitVisibilityTests.cs` (~5 tests)
- [ ] `RoomHiddenItemTests.cs` (~2 tests)
- [ ] `SearchResultTests.cs` (~2 tests)
- [ ] `SearchServiceTests.cs` (~5 tests)
- [ ] All ~22 tests passing

### Documentation

- [ ] XML documentation for all new types
- [ ] Updated code comments for modified types

---

## 16. Acceptance Criteria

### Functional

- [ ] RoomType enum defined with 6 types (Standard, Treasure, Trap, Boss, Safe, Shrine)
- [ ] Exit value object has TargetRoomId, IsHidden, IsDiscovered, HiddenHint, DiscoveryDC, StairType
- [ ] Exit.Standard() creates visible, non-hidden exit
- [ ] Exit.Hidden() creates hidden exit requiring discovery
- [ ] Exit.IsVisible returns true for non-hidden OR discovered exits
- [ ] Room entity has RoomType property defaulting to Standard
- [ ] Room.GetVisibleExits() returns only visible exits
- [ ] Room.GetHiddenExits() returns only undiscovered hidden exits
- [ ] Room.RevealExit() marks hidden exit as discovered
- [ ] Hidden exits not shown in room description until discovered
- [ ] `search` command triggers Perception skill check
- [ ] Successful search reveals hidden exits with DC ≤ roll result
- [ ] Successful search reveals hidden items with DC ≤ roll result
- [ ] Failed search does not reveal hidden content
- [ ] Room type indicator shown in room description for non-Standard types
- [ ] Attempting to move through undiscovered exit fails

### Quality

- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] All ~22 unit tests pass
- [ ] Configuration files validate (valid JSON, required fields)
- [ ] XML documentation complete for all new/modified types
- [ ] No breaking changes to existing room navigation

---

## 17. Dependencies

### 17.1 Prerequisites (REQUIRES)

```
v0.1.0c Room Types & Hidden Passages
    │
    └── REQUIRES from v0.1.0b
        ├── RoomGeneratorService (for type assignment during generation)
        ├── RoomTemplate (add room type field)
        └── On-demand room generation
    │
    └── REQUIRES from v0.1.0a
        ├── Direction enum with Up/Down
        ├── Position3D value object
        └── StairType enum
    │
    └── REQUIRES from v0.0.5
        ├── SkillCheckService
        ├── Perception skill definition
        ├── Investigation skill definition
        └── DifficultyClassDefinition
```

### 17.2 Provides (to future phases)

```
v0.1.0c Room Types & Hidden Passages
    │
    └── PROVIDES to v0.1.0d
        ├── RoomType for map symbols
        ├── Exit.IsVisible for map rendering
        └── Room exploration state
    │
    └── PROVIDES to future versions
        ├── Hidden content pattern
        ├── Discovery mechanics
        └── Room type behavior framework
```

---

## 18. Future Considerations

### 18.1 Deferred to Future Versions

- **Trap mechanics implementation**: Actual trap triggering, damage, disarm checks
- **Boss encounter scripting**: Special boss behaviors, phase changes, dialogue
- **Shrine blessings**: Deity system, blessing effects, offerings
- **Safe room rest mechanics**: Health restoration, status cure, save points
- **Trap room detection**: Automatic Perception check on entry

### 18.2 Deferred to v0.1.0d (Map Command & Polish)

- **Room type symbols on map**: Different ASCII symbols for each type
- **Discovered exit indicators**: Show secret passages differently on map

### 18.3 Out of Scope

- **Trap design tools**: Creating custom trap types
- **Boss AI behaviors**: Complex combat patterns
- **Dynamic room type changes**: Rooms changing type over time

---

*Document Version: 1.0*
*Last Updated: 2026-01-08*
*Author: Claude*
