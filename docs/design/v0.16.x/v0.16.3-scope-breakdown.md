## v0.16.3 - Smart Loot Generation

**Focus:** Class-appropriate filtering, weighted item selection, and equipment-to-class mapping

**Source Specification:** [loot-generation.md](../../aethelgard/design/04-systems/loot-generation.md)

### Overview

This version implements "smart loot" - a class-biased drop system that ensures 60% of drops are appropriate for the player's archetype. This reduces frustration from constantly receiving unusable gear while still allowing 40% of drops to be random for experimentation, companion gearing, or trading.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 1 | 2 |
| Value Objects | 4 | 5 |
| Entities | 1 | 3 |
| Services | 2 | 5 |
| **Total** | **8** | **~15** |

---

### v0.16.3a - Equipment Class Mapping

#### EquipmentClassAffinity Enum
```
EquipmentClassAffinity
├── Warrior - MIGHT-based weapons, Heavy armor
├── Skirmisher - FINESSE-based weapons, Light/Medium armor
├── Mystic - WILL-based implements, Light armor only
├── Adept - WITS-based tools, Light armor
├── Universal - Any class can use effectively
```

#### EquipmentClassMapping Value Object
```
EquipmentClassMapping
├── ItemId: string
├── ItemCategory: string (Weapon, Armor, Accessory)
├── PrimaryAffinity: EquipmentClassAffinity
├── SecondaryAffinities: List<EquipmentClassAffinity>
├── PrimaryAttribute: string (MIGHT, FINESSE, WILL, WITS)
├── IsUniversal: bool
```

**Weapon to Class Mapping:**
| Weapon Category | Primary Affinity | Attribute |
|-----------------|------------------|-----------|
| Axes | Warrior | MIGHT |
| Greatswords | Warrior | MIGHT |
| Hammers/Blunt | Warrior | MIGHT |
| Heavy Blunt | Warrior | MIGHT |
| Spears | Skirmisher/Warrior | FINESSE/MIGHT |
| Daggers | Skirmisher/Mystic | FINESSE |
| Blades (1H) | Skirmisher | FINESSE |
| Bows | Skirmisher | FINESSE |
| Rifles | Skirmisher | FINESSE |
| Staves | Mystic | WILL |
| Focus/Orbs | Mystic | WILL |
| EnergyMelee | Adept | WITS |
| Arc-Cannon | Adept | WITS |
| Crossbows | Adept | WITS |

**Armor to Class Mapping:**
| Armor Category | Primary Affinity | Secondary |
|----------------|------------------|-----------|
| Light | Universal | All |
| Medium | Warrior/Skirmisher | — |
| Heavy | Warrior | — |
| Shields | Warrior | — |
| Arcane Robes | Mystic | Adept |

**Configuration (`equipment-class-mapping.json`):**
```json
{
  "mappings": [
    {
      "itemCategory": "Axes",
      "primaryAffinity": "Warrior",
      "secondaryAffinities": [],
      "primaryAttribute": "MIGHT",
      "isUniversal": false
    },
    {
      "itemCategory": "Daggers",
      "primaryAffinity": "Skirmisher",
      "secondaryAffinities": ["Mystic", "Adept"],
      "primaryAttribute": "FINESSE",
      "isUniversal": false
    },
    {
      "itemCategory": "LightArmor",
      "primaryAffinity": "Universal",
      "secondaryAffinities": [],
      "primaryAttribute": null,
      "isUniversal": true
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Axes map to Warrior affinity
- [ ] Light armor maps to Universal

---

### v0.16.3b - Smart Loot Algorithm

#### SmartLootContext Value Object
```
SmartLootContext
├── PlayerArchetype: string
├── QualityTier: QualityTier
├── ItemCategory: string? (optional filter)
├── BiomeModifiers: LootModifiers?
├── ForceClassAppropriate: bool (override 60% chance)
```

#### SmartLootResult Value Object
```
SmartLootResult
├── SelectedItem: ItemDefinition
├── QualityTier: QualityTier
├── WasClassAppropriate: bool
├── SelectionReason: string
├── AlternativesConsidered: int
```

#### ISmartLootService Interface
```csharp
public interface ISmartLootService
{
    /// <summary>
    /// Generates a class-appropriate item with 60% bias.
    /// </summary>
    SmartLootResult GenerateSmartLoot(SmartLootContext context, Random rng);

    /// <summary>
    /// Gets all items matching player class and tier.
    /// </summary>
    IReadOnlyList<ItemDefinition> GetClassAppropriateItems(
        string archetype,
        QualityTier tier);

    /// <summary>
    /// Checks if an item is appropriate for a class.
    /// </summary>
    bool IsClassAppropriate(string itemId, string archetype);
}
```

**Smart Loot Algorithm:**
```
GenerateSmartLoot(context, rng):
  1. Roll 0-99
  2. If roll < 60 (60% chance):
     a. Filter items by PlayerArchetype affinity
     b. Filter by QualityTier
     c. If items found: Select random from filtered pool
     d. If no items found: Fall through to random
  3. Else (40% chance) OR no class items:
     a. Get all items of QualityTier
     b. Select random from full pool
  4. Apply attribute bonus based on tier
  5. Return SmartLootResult
```

**Class Filtering Logic:**
```
GetClassAppropriateItems(archetype, tier):
  1. Get all items of specified tier
  2. For each item:
     a. Get EquipmentClassMapping
     b. If PrimaryAffinity == archetype: Include
     c. If archetype in SecondaryAffinities: Include
     d. If IsUniversal: Include
  3. Return filtered list
```

**Unit Tests (~3):**
- [ ] 60% of drops are class-appropriate over large sample
- [ ] Falls back to random when no class items exist
- [ ] Universal items included for all classes

---

### v0.16.3c - Weighted Item Selection

#### WeightedItemPool Entity
```
WeightedItemPool
├── PoolId: string
├── Tier: QualityTier
├── Items: List<WeightedItem>
├── TotalWeight: int
├── Methods:
│   ├── SelectRandom(rng) → ItemDefinition
│   ├── AddItem(item, weight)
│   └── FilterByAffinity(archetype) → WeightedItemPool
```

#### WeightedItem Value Object
```
WeightedItem
├── ItemId: string
├── Weight: int (higher = more common)
├── ItemDefinition: ItemDefinition
├── ClassAffinity: EquipmentClassAffinity
```

**Weight Distribution Guidelines:**
| Item Rarity | Weight | Notes |
|-------------|--------|-------|
| Common | 100 | Basic weapons/armor |
| Uncommon | 50 | Slightly better stats |
| Rare | 25 | Notable upgrades |
| Very Rare | 10 | Significant finds |
| Unique (per tier) | 5 | Special items |

**Weighted Selection Algorithm:**
```
SelectRandom(rng):
  1. Calculate TotalWeight = sum of all weights
  2. Roll 0 to TotalWeight-1
  3. Accumulate weights until roll < cumulative
  4. Return selected item
```

**Configuration (in items.json):**
```json
{
  "items": [
    {
      "id": "iron_sword",
      "name": "Iron Sword",
      "category": "Swords",
      "tier": "Scavenged",
      "weight": 100,
      "classAffinity": "Skirmisher"
    },
    {
      "id": "flame_blade",
      "name": "Flame Blade",
      "category": "Swords",
      "tier": "ClanForged",
      "weight": 25,
      "classAffinity": "Skirmisher"
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] Weighted selection favors higher-weight items
- [ ] Zero-weight items never selected
- [ ] Distribution matches expected weights over large sample

---

### v0.16.3d - Loot Service Integration

#### Enhanced LootService
```csharp
public class LootService : ILootService
{
    private readonly ISmartLootService _smartLootService;
    private readonly IDropTableProvider _dropTableProvider;
    private readonly ITierScalingService _tierScalingService;

    public LootDrop GenerateLoot(Monster monster, PlayerCharacter? player)
    {
        // Get enemy drop class
        var dropClass = GetEnemyDropClass(monster.Definition);

        // Roll for quality tier
        var tier = _dropTableProvider.RollQualityTier(dropClass, _rng);
        if (tier == null) return LootDrop.Empty;

        // Generate smart loot if player provided
        if (player != null)
        {
            var context = new SmartLootContext
            {
                PlayerArchetype = player.Archetype,
                QualityTier = tier.Value
            };
            var result = _smartLootService.GenerateSmartLoot(context, _rng);
            return CreateLootDrop(result, tier.Value);
        }

        // Fallback to random loot
        return GenerateRandomLoot(tier.Value);
    }
}
```

#### LootDrop Enhancement
```
LootDrop (updated)
├── Items: List<DroppedItem>
├── Currency: Dictionary<string, int>
├── QualityTier: QualityTier?
├── HasMythForged: bool
├── WasClassAppropriate: bool (NEW)
├── PlayerArchetype: string? (NEW)
```

**Integration Points:**
```
On Monster Death:
  1. Get player reference (for smart loot)
  2. Call LootService.GenerateLoot(monster, player)
  3. Apply biome modifiers if applicable
  4. Add loot to room

On Container Open:
  1. Get player reference
  2. Call ContainerLootService (v0.16.4)
  3. Apply smart loot to container contents
```

**Unit Tests (~4):**
- [ ] GenerateLoot uses smart loot when player provided
- [ ] GenerateLoot falls back to random without player
- [ ] WasClassAppropriate flag set correctly
- [ ] Biome modifiers applied when present

---

### v0.16.3e - Stat Verification Service

#### IStatVerificationService Interface
```csharp
public interface IStatVerificationService
{
    /// <summary>
    /// Verifies generated item has tier-appropriate stats.
    /// </summary>
    bool VerifyItemStats(DroppedItem item, QualityTier expectedTier);

    /// <summary>
    /// Applies tier scaling to base item.
    /// </summary>
    DroppedItem ApplyTierScaling(ItemDefinition baseItem, QualityTier tier, Random rng);

    /// <summary>
    /// Gets expected stat ranges for tier.
    /// </summary>
    StatRange GetExpectedStats(QualityTier tier, string itemCategory);
}
```

#### StatRange Value Object
```
StatRange
├── MinDamage: string (dice notation)
├── MaxDamage: string (dice notation)
├── MinDefense: int
├── MaxDefense: int
├── MinAttributeBonus: int
├── MaxAttributeBonus: int
```

**Stat Verification Logic:**
```
VerifyItemStats(item, tier):
  1. Get expected range for tier
  2. Check damage within range
  3. Check defense within range
  4. Check attribute bonus within range
  5. Return true if all pass
```

**Unit Tests (~3):**
- [ ] Tier 0 items have 1d6 damage
- [ ] Tier 4 items have 2d6+4 damage
- [ ] Attribute bonuses within tier range

---

### Configuration Files

| File | Purpose |
|------|---------|
| `equipment-class-mapping.json` | Item category to class affinity |
| `weighted-items.json` | Item weights by tier |
| `stat-ranges.json` | Expected stat ranges per tier |

---

### Dependencies

**Requires:**
- v0.16.0: Quality tier system
- v0.16.1: Weapon categories (for mapping)
- v0.16.2: Armor categories (for mapping)
- Player/archetype system

**Provides to:**
- v0.16.4: Container loot (uses smart loot)
- v0.16.5: Unique items (integrates with selection)

---

### Acceptance Criteria

- [ ] EquipmentClassAffinity enum has 5 values
- [ ] Equipment-to-class mapping covers all categories
- [ ] Smart loot algorithm applies 60% class bias
- [ ] Fallback to random when no class items available
- [ ] Weighted selection uses item weights
- [ ] Higher-weight items appear more frequently
- [ ] Generated items have tier-appropriate stats
- [ ] Stat verification catches mismatched items
- [ ] LootDrop tracks WasClassAppropriate flag
- [ ] Integration with monster death works
- [ ] ~15 unit tests pass
