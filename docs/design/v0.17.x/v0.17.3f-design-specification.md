# v0.17.3f Design Specification: Archetype Application Service

**Version:** 0.17.3f  
**Phase Name:** Archetype Application Service  
**Parent Version:** v0.17.3 (Archetype System)  
**Prerequisites:** v0.17.3e Complete (Archetype Provider Service)  
**Estimated Tests:** ~12 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ArchetypeApplicationResult Value Object](#4-archetypeapplicationresult-value-object)
5. [IArchetypeApplicationService Interface](#5-iarchetypeapplicationservice-interface)
6. [ArchetypeApplicationService Implementation](#6-archetypeapplicationservice-implementation)
7. [Data Model Changes](#7-data-model-changes)
8. [Integration Points](#8-integration-points)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [User Stories](#12-user-stories)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IArchetypeApplicationService` interface, `ArchetypeApplicationService` implementation, and `ArchetypeApplicationResult` value object that apply an archetype to a character during character creation.

The application service:

- Applies resource bonuses (HP, Stamina, Aether Pool, Movement)
- Grants starting abilities (3 per archetype)
- Sets specialization mapping for future selection
- Validates application preconditions
- Returns comprehensive result with applied changes

### 1.2 Key Deliverables

| Category          | Items                          |
| ----------------- | ------------------------------ |
| **Value Objects** | `ArchetypeApplicationResult`   |
| **Interfaces**    | `IArchetypeApplicationService` |
| **Services**      | `ArchetypeApplicationService`  |
| **Tests**         | ~12 unit tests                 |

### 1.3 Architectural Significance

This version completes the Archetype System by providing the **Application Pattern**:

- **Single Responsibility**: One service handles all archetype application logic
- **Result Object Pattern**: Returns detailed results for UI feedback
- **Validation First**: Checks preconditions before applying changes
- **Permanent Choice**: Archetype cannot be changed once applied
- **Integration Ready**: Works with IArchetypeProvider and Character entity

---

## 2. Feature Overview

```
v0.17.3f Archetype Application Service
├── ArchetypeApplicationResult Value Object
│   ├── Success: bool
│   ├── AppliedArchetype: Archetype
│   ├── ResourceBonusesApplied: ArchetypeResourceBonuses
│   ├── AbilitiesGranted: IReadOnlyList<ArchetypeAbilityGrant>
│   ├── AvailableSpecializations: ArchetypeSpecializationMapping
│   ├── FailureReason: string?
│   └── Display methods
├── IArchetypeApplicationService Interface
│   ├── ApplyArchetype(character, archetype): Result
│   ├── CanApplyArchetype(character, archetype): ValidationResult
│   ├── GetApplicationPreview(archetype): Preview
│   └── RevertArchetype(character): Result  [Future]
└── ArchetypeApplicationService Implementation
    ├── Uses IArchetypeProvider for data
    ├── Validation logic
    ├── Resource bonus application
    ├── Ability granting
    └── Specialization mapping setup
```

### 2.1 Scope Alignment

**In Scope:**

- `ArchetypeApplicationResult` value object
- `IArchetypeApplicationService` interface
- `ArchetypeApplicationService` implementation
- Apply archetype to character (resource bonuses, abilities, specializations)
- Validation before application
- Application preview for UI

**Out of Scope:**

- Character entity modifications → Character already has archetype property
- Specialization application → v0.17.4
- Character creation workflow → v0.17.5
- Archetype reversion/respec → Future version

---

## 3. Architecture Diagrams

### 3.1 Application Service Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              ARCHETYPE APPLICATION SERVICE OVERVIEW                  │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation Workflow (v0.17.5)
           │
           │  Step 4: Apply Archetype
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 IArchetypeApplicationService                         │
├─────────────────────────────────────────────────────────────────────┤
│  + ApplyArchetype(character, archetype): Result                     │
│  + CanApplyArchetype(character, archetype): ValidationResult        │
│  + GetApplicationPreview(archetype): Preview                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Uses
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     IArchetypeProvider                               │
├─────────────────────────────────────────────────────────────────────┤
│  + GetArchetype()                                                    │
│  + GetResourceBonuses()                                              │
│  + GetStartingAbilities()                                            │
│  + GetSpecializationMapping()                                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Returns
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  ArchetypeApplicationResult                          │
├─────────────────────────────────────────────────────────────────────┤
│  + Success: bool                                                     │
│  + AppliedArchetype: Archetype                                       │
│  + ResourceBonusesApplied: ArchetypeResourceBonuses                 │
│  + AbilitiesGranted: IReadOnlyList<ArchetypeAbilityGrant>           │
│  + AvailableSpecializations: ArchetypeSpecializationMapping         │
│  + FailureReason: string?                                            │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Application Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      APPLICATION FLOW                                │
└─────────────────────────────────────────────────────────────────────┘

    ApplyArchetype(character, Archetype.Warrior)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ STEP 1: Validate Preconditions                                   │
    │ - Character has no archetype?                                    │
    │ - Archetype is valid?                                            │
    │ - Character has required lineage/background?                     │
    └──────────────────────────────────────────────────────────────────┘
           │
        ┌──┴──┐
      Valid  Invalid
        │       │
        │       ▼
        │    Return ArchetypeApplicationResult.Failed(reason)
        │
        ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ STEP 2: Get Archetype Data                                       │
    │ - GetResourceBonuses(Warrior)                                    │
    │ - GetStartingAbilities(Warrior)                                  │
    │ - GetSpecializationMapping(Warrior)                              │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ STEP 3: Apply Resource Bonuses                                   │
    │ - character.MaxHp += 49                                          │
    │ - character.MaxStamina += 5                                      │
    │ - character.MaxAetherPool += 0                                   │
    │ - character.Movement += 0                                        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ STEP 4: Grant Starting Abilities                                 │
    │ - AddAbility("power-strike")                                     │
    │ - AddAbility("defensive-stance")                                 │
    │ - AddAbility("iron-will")                                        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ STEP 5: Set Archetype                                            │
    │ - character.Archetype = Archetype.Warrior                        │
    │ - character.AvailableSpecializations = [6 specs]                 │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    Return ArchetypeApplicationResult.Succeeded(...)
```

### 3.3 Validation Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                    VALIDATION DECISION TREE                          │
└─────────────────────────────────────────────────────────────────────┘

    CanApplyArchetype(character, archetype)?
           │
           ▼
    ┌──────────────────────┐
    │ character is null?   │
    └──────────┬───────────┘
               │
           ┌───┴───┐
          YES      NO
           │       │
           ▼       ▼
    FAIL:         ┌──────────────────────┐
    "Character    │ character has        │
    is required"  │ existing archetype?  │
                  └──────────┬───────────┘
                             │
                      ┌──────┴──────┐
                     YES            NO
                      │              │
                      ▼              ▼
               FAIL:              ┌──────────────────────┐
               "Archetype         │ archetype is valid   │
               already            │ enum value?          │
               selected"          └──────────┬───────────┘
                                             │
                                      ┌──────┴──────┐
                                     YES            NO
                                      │              │
                                      ▼              ▼
                               PASS: Valid       FAIL:
                                                 "Invalid
                                                 archetype"
```

### 3.4 Character State Before/After

```
┌─────────────────────────────────────────────────────────────────────┐
│                CHARACTER STATE BEFORE / AFTER                        │
└─────────────────────────────────────────────────────────────────────┘

    BEFORE (Step 3 Complete: Background Applied)
    ┌─────────────────────────────────────────────────────────────────┐
    │ Character: "Aldric"                                             │
    ├─────────────────────────────────────────────────────────────────┤
    │ Lineage: Human                                                  │
    │ Background: Soldier                                             │
    │ Archetype: null                                                 │
    │ MaxHp: 51 (base 50 + soldier 1)                                 │
    │ MaxStamina: 20 (base)                                           │
    │ MaxAetherPool: 0                                                │
    │ Movement: 6 (base)                                              │
    │ Abilities: []                                                   │
    │ AvailableSpecializations: null                                  │
    └─────────────────────────────────────────────────────────────────┘
           │
           │  ApplyArchetype(character, Archetype.Warrior)
           ▼
    AFTER (Step 4 Complete: Archetype Applied)
    ┌─────────────────────────────────────────────────────────────────┐
    │ Character: "Aldric"                                             │
    ├─────────────────────────────────────────────────────────────────┤
    │ Lineage: Human                                                  │
    │ Background: Soldier                                             │
    │ Archetype: Warrior                      ← SET                   │
    │ MaxHp: 100 (51 + 49)                    ← INCREASED            │
    │ MaxStamina: 25 (20 + 5)                 ← INCREASED            │
    │ MaxAetherPool: 0                        ← UNCHANGED            │
    │ Movement: 6                             ← UNCHANGED            │
    │ Abilities: [Power Strike, Defensive     ← GRANTED              │
    │             Stance, Iron Will]                                  │
    │ AvailableSpecializations: [guardian,    ← SET                   │
    │   berserker, weapon-master, vanguard,                           │
    │   juggernaut, battle-commander]                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.5 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Step 4: Archetype Selection                                    │
│      └── On Confirm: applicationService.ApplyArchetype(...)         │
│                                                                      │
│  ArchetypeConfirmationPanel                                          │
│  └── Shows application preview before commit                        │
│  └── Displays result details after application                      │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              IArchetypeApplicationService                     │  │
│  │                     (Interface)                               │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + ApplyArchetype(character, archetype): Result               │  │
│  │  + CanApplyArchetype(character, archetype): ValidationResult  │  │
│  │  + GetApplicationPreview(archetype): Preview                  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              ▲                                       │
│                              │ implements                            │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │               ArchetypeApplicationService                     │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  - _archetypeProvider: IArchetypeProvider                     │  │
│  │  - _logger: ILogger                                           │  │
│  │  - ApplyResourceBonuses(character, bonuses)                   │  │
│  │  - GrantAbilities(character, abilities)                       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              │ uses                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   IArchetypeProvider                          │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  Character (entity to be modified)                                   │
│  ArchetypeApplicationResult (value object returned)                  │
│  ArchetypeResourceBonuses (v0.17.3b)                                 │
│  ArchetypeAbilityGrant (v0.17.3c)                                    │
│  ArchetypeSpecializationMapping (v0.17.3d)                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ArchetypeApplicationResult Value Object

### 4.1 Purpose

The `ArchetypeApplicationResult` value object encapsulates the result of applying an archetype to a character, including success/failure status and all changes made.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ArchetypeApplicationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of applying an archetype to a character.
/// </summary>
/// <remarks>
/// <para>
/// ArchetypeApplicationResult provides comprehensive feedback about the
/// archetype application operation, including all bonuses applied and
/// abilities granted.
/// </para>
/// <para>
/// On success, the result contains:
/// - The applied archetype
/// - Resource bonuses (HP, Stamina, AP, Movement)
/// - Granted abilities (3 per archetype)
/// - Available specializations for future selection
/// </para>
/// <para>
/// On failure, the result contains:
/// - Success = false
/// - FailureReason explaining why application failed
/// </para>
/// </remarks>
public sealed class ArchetypeApplicationResult
{
    /// <summary>
    /// Gets whether the application was successful.
    /// </summary>
    public bool Success { get; }

    /// <summary>
    /// Gets the applied archetype, if successful.
    /// </summary>
    public Archetype? AppliedArchetype { get; }

    /// <summary>
    /// Gets the resource bonuses applied.
    /// </summary>
    public ArchetypeResourceBonuses? ResourceBonusesApplied { get; }

    /// <summary>
    /// Gets the abilities granted.
    /// </summary>
    public IReadOnlyList<ArchetypeAbilityGrant> AbilitiesGranted { get; }

    /// <summary>
    /// Gets the available specializations for the archetype.
    /// </summary>
    public ArchetypeSpecializationMapping? AvailableSpecializations { get; }

    /// <summary>
    /// Gets the failure reason, if unsuccessful.
    /// </summary>
    public string? FailureReason { get; }

    private ArchetypeApplicationResult(
        bool success,
        Archetype? appliedArchetype,
        ArchetypeResourceBonuses? resourceBonusesApplied,
        IReadOnlyList<ArchetypeAbilityGrant> abilitiesGranted,
        ArchetypeSpecializationMapping? availableSpecializations,
        string? failureReason)
    {
        Success = success;
        AppliedArchetype = appliedArchetype;
        ResourceBonusesApplied = resourceBonusesApplied;
        AbilitiesGranted = abilitiesGranted;
        AvailableSpecializations = availableSpecializations;
        FailureReason = failureReason;
    }

    /// <summary>
    /// Creates a successful application result.
    /// </summary>
    public static ArchetypeApplicationResult Succeeded(
        Archetype archetype,
        ArchetypeResourceBonuses bonuses,
        IReadOnlyList<ArchetypeAbilityGrant> abilities,
        ArchetypeSpecializationMapping specializations) =>
        new(
            success: true,
            appliedArchetype: archetype,
            resourceBonusesApplied: bonuses,
            abilitiesGranted: abilities,
            availableSpecializations: specializations,
            failureReason: null);

    /// <summary>
    /// Creates a failed application result.
    /// </summary>
    public static ArchetypeApplicationResult Failed(string reason) =>
        new(
            success: false,
            appliedArchetype: null,
            resourceBonusesApplied: null,
            abilitiesGranted: Array.Empty<ArchetypeAbilityGrant>(),
            availableSpecializations: null,
            failureReason: reason);

    /// <summary>
    /// Creates a failed result for already having an archetype.
    /// </summary>
    public static ArchetypeApplicationResult AlreadyHasArchetype(Archetype existing) =>
        Failed($"Character already has archetype: {existing}. Archetype is a permanent choice.");

    /// <summary>
    /// Creates a failed result for null character.
    /// </summary>
    public static ArchetypeApplicationResult CharacterRequired =>
        Failed("A character is required to apply an archetype.");

    /// <summary>
    /// Gets a display-friendly summary of the application.
    /// </summary>
    public string GetSummary()
    {
        if (!Success)
            return $"Failed: {FailureReason}";

        return $"Applied {AppliedArchetype}:\n" +
               $"  Resource Bonuses: {ResourceBonusesApplied?.GetDisplaySummary()}\n" +
               $"  Abilities Granted: {AbilitiesGranted.Count}\n" +
               $"  Specializations Available: {AvailableSpecializations?.Count}";
    }

    /// <summary>
    /// Gets a formatted list of granted abilities.
    /// </summary>
    public IReadOnlyList<string> GetGrantedAbilitiesList() =>
        AbilitiesGranted.Select(a => a.GetShortDisplay()).ToList();

    /// <summary>
    /// Gets a formatted list of available specializations.
    /// </summary>
    public IReadOnlyList<string> GetSpecializationsList() =>
        AvailableSpecializations?.GetDisplayList() ?? Array.Empty<string>();
}
```

---

## 5. IArchetypeApplicationService Interface

### 5.1 Purpose

The `IArchetypeApplicationService` interface defines the contract for applying archetypes to characters during character creation.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArchetypeApplicationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for applying archetypes to characters during character creation.
/// </summary>
/// <remarks>
/// <para>
/// IArchetypeApplicationService handles the Step 4 operation in character
/// creation: applying the selected archetype to the character. This includes
/// applying resource bonuses, granting starting abilities, and setting up
/// available specializations.
/// </para>
/// <para>
/// Archetype selection is permanent—once applied, it cannot be changed.
/// The service validates this precondition before application.
/// </para>
/// </remarks>
public interface IArchetypeApplicationService
{
    /// <summary>
    /// Applies an archetype to a character.
    /// </summary>
    /// <param name="character">The character to modify.</param>
    /// <param name="archetype">The archetype to apply.</param>
    /// <returns>Result containing applied changes or failure reason.</returns>
    /// <remarks>
    /// This operation:
    /// 1. Validates the character doesn't already have an archetype
    /// 2. Applies resource bonuses (HP, Stamina, AP, Movement)
    /// 3. Grants starting abilities (3 per archetype)
    /// 4. Sets available specializations for Step 5
    /// </remarks>
    ArchetypeApplicationResult ApplyArchetype(Character character, Archetype archetype);

    /// <summary>
    /// Checks whether an archetype can be applied to a character.
    /// </summary>
    /// <param name="character">The character to check.</param>
    /// <param name="archetype">The archetype to validate.</param>
    /// <returns>Validation result with success status and any issues.</returns>
    ArchetypeValidationResult CanApplyArchetype(Character character, Archetype archetype);

    /// <summary>
    /// Gets a preview of what applying an archetype would do.
    /// </summary>
    /// <param name="archetype">The archetype to preview.</param>
    /// <returns>Preview showing bonuses and abilities that would be applied.</returns>
    /// <remarks>
    /// Used by the UI to show the player what they would receive before
    /// confirming their selection.
    /// </remarks>
    ArchetypeApplicationPreview GetApplicationPreview(Archetype archetype);
}

/// <summary>
/// Result of validating whether an archetype can be applied.
/// </summary>
/// <param name="IsValid">Whether the archetype can be applied.</param>
/// <param name="Issues">List of validation issues, if any.</param>
public readonly record struct ArchetypeValidationResult(
    bool IsValid,
    IReadOnlyList<string> Issues)
{
    /// <summary>
    /// Creates a valid result.
    /// </summary>
    public static ArchetypeValidationResult Valid => new(true, Array.Empty<string>());

    /// <summary>
    /// Creates an invalid result with the specified issues.
    /// </summary>
    public static ArchetypeValidationResult Invalid(params string[] issues) =>
        new(false, issues);
}

/// <summary>
/// Preview of archetype application for UI display.
/// </summary>
/// <param name="Archetype">The archetype being previewed.</param>
/// <param name="DisplayName">Display name of the archetype.</param>
/// <param name="ResourceBonuses">Resource bonuses that would be applied.</param>
/// <param name="StartingAbilities">Abilities that would be granted.</param>
/// <param name="AvailableSpecializations">Specializations that would become available.</param>
public readonly record struct ArchetypeApplicationPreview(
    Archetype Archetype,
    string DisplayName,
    ArchetypeResourceBonuses ResourceBonuses,
    IReadOnlyList<ArchetypeAbilityGrant> StartingAbilities,
    ArchetypeSpecializationMapping AvailableSpecializations)
{
    /// <summary>
    /// Gets the total number of elements in this preview.
    /// </summary>
    public int TotalElements =>
        (ResourceBonuses.TotalBonusCount > 0 ? 1 : 0) +
        StartingAbilities.Count +
        AvailableSpecializations.Count;
}
```

---

## 6. ArchetypeApplicationService Implementation

### 6.1 Purpose

The `ArchetypeApplicationService` implements `IArchetypeApplicationService`, coordinating with `IArchetypeProvider` to apply archetype data to characters.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ArchetypeApplicationService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Applies archetypes to characters during character creation.
/// </summary>
public class ArchetypeApplicationService : IArchetypeApplicationService
{
    private readonly IArchetypeProvider _archetypeProvider;
    private readonly ILogger<ArchetypeApplicationService> _logger;

    /// <summary>
    /// Initializes a new instance of ArchetypeApplicationService.
    /// </summary>
    /// <param name="archetypeProvider">Provider for archetype data.</param>
    /// <param name="logger">Logger instance.</param>
    public ArchetypeApplicationService(
        IArchetypeProvider archetypeProvider,
        ILogger<ArchetypeApplicationService> logger)
    {
        ArgumentNullException.ThrowIfNull(archetypeProvider);
        ArgumentNullException.ThrowIfNull(logger);

        _archetypeProvider = archetypeProvider;
        _logger = logger;

        _logger.LogInformation("ArchetypeApplicationService initialized");
    }

    /// <inheritdoc />
    public ArchetypeApplicationResult ApplyArchetype(Character character, Archetype archetype)
    {
        _logger.LogInformation(
            "Attempting to apply archetype {Archetype} to character {CharacterName}",
            archetype, character?.Name ?? "null");

        // Step 1: Validate
        var validation = CanApplyArchetype(character, archetype);
        if (!validation.IsValid)
        {
            var reason = string.Join("; ", validation.Issues);
            _logger.LogWarning(
                "Cannot apply archetype {Archetype}: {Reason}",
                archetype, reason);
            return ArchetypeApplicationResult.Failed(reason);
        }

        // Step 2: Get archetype data
        var definition = _archetypeProvider.GetArchetype(archetype);
        var bonuses = _archetypeProvider.GetResourceBonuses(archetype);
        var abilities = _archetypeProvider.GetStartingAbilities(archetype);
        var specializations = _archetypeProvider.GetSpecializationMapping(archetype);

        if (definition == null)
        {
            _logger.LogError("Archetype definition not found: {Archetype}", archetype);
            return ArchetypeApplicationResult.Failed($"Archetype '{archetype}' not found.");
        }

        // Step 3: Apply resource bonuses
        ApplyResourceBonuses(character!, bonuses);

        // Step 4: Grant starting abilities
        GrantAbilities(character!, abilities);

        // Step 5: Set archetype and specializations
        character!.SetArchetype(archetype);
        character.SetAvailableSpecializations(specializations);

        _logger.LogInformation(
            "Applied archetype {Archetype} to {CharacterName}: " +
            "HP+{HpBonus}, Stamina+{StaminaBonus}, {AbilityCount} abilities, " +
            "{SpecCount} specializations available",
            archetype, character.Name,
            bonuses.MaxHpBonus, bonuses.MaxStaminaBonus,
            abilities.Count, specializations.Count);

        return ArchetypeApplicationResult.Succeeded(
            archetype, bonuses, abilities, specializations);
    }

    /// <inheritdoc />
    public ArchetypeValidationResult CanApplyArchetype(Character? character, Archetype archetype)
    {
        var issues = new List<string>();

        if (character == null)
        {
            issues.Add("A character is required.");
            return ArchetypeValidationResult.Invalid(issues.ToArray());
        }

        if (character.HasArchetype)
        {
            issues.Add($"Character already has archetype: {character.Archetype}. " +
                       "Archetype is a permanent choice.");
        }

        if (!Enum.IsDefined(archetype))
        {
            issues.Add($"Invalid archetype value: {archetype}.");
        }

        // Check if archetype definition exists
        if (_archetypeProvider.GetArchetype(archetype) == null)
        {
            issues.Add($"Archetype '{archetype}' is not configured.");
        }

        if (issues.Count > 0)
        {
            _logger.LogDebug(
                "Validation failed for {Archetype}: {Issues}",
                archetype, string.Join(", ", issues));
            return ArchetypeValidationResult.Invalid(issues.ToArray());
        }

        return ArchetypeValidationResult.Valid;
    }

    /// <inheritdoc />
    public ArchetypeApplicationPreview GetApplicationPreview(Archetype archetype)
    {
        var definition = _archetypeProvider.GetArchetype(archetype);
        var bonuses = _archetypeProvider.GetResourceBonuses(archetype);
        var abilities = _archetypeProvider.GetStartingAbilities(archetype);
        var specializations = _archetypeProvider.GetSpecializationMapping(archetype);

        _logger.LogDebug("Generated application preview for {Archetype}", archetype);

        return new ArchetypeApplicationPreview(
            archetype,
            definition?.DisplayName ?? archetype.ToString(),
            bonuses,
            abilities,
            specializations);
    }

    private void ApplyResourceBonuses(Character character, ArchetypeResourceBonuses bonuses)
    {
        _logger.LogDebug(
            "Applying resource bonuses to {CharacterName}: {Summary}",
            character.Name, bonuses.GetDisplaySummary());

        character.ModifyMaxHp(bonuses.MaxHpBonus);
        character.ModifyMaxStamina(bonuses.MaxStaminaBonus);
        character.ModifyMaxAetherPool(bonuses.MaxAetherPoolBonus);
        character.ModifyMovement(bonuses.MovementBonus);

        if (bonuses.HasSpecialBonus)
        {
            bonuses.SpecialBonus!.Value.ApplyTo(character);
            _logger.LogDebug(
                "Applied special bonus: {BonusType} = {Value}",
                bonuses.SpecialBonus.Value.BonusType,
                bonuses.SpecialBonus.Value.BonusValue);
        }
    }

    private void GrantAbilities(Character character, IReadOnlyList<ArchetypeAbilityGrant> abilities)
    {
        foreach (var grant in abilities)
        {
            character.AddAbility(grant.AbilityId);

            _logger.LogDebug(
                "Granted ability {AbilityId} ({Type}) to {CharacterName}",
                grant.AbilityId, grant.AbilityType, character.Name);

            if (grant.IsPassive)
            {
                // Passive abilities take effect immediately
                character.ActivatePassiveAbility(grant.AbilityId);
            }
        }

        _logger.LogInformation(
            "Granted {Count} starting abilities to {CharacterName}",
            abilities.Count, character.Name);
    }
}
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                           | Layer       | Category     | Description                  |
| ------------------------------ | ----------- | ------------ | ---------------------------- |
| `ArchetypeApplicationResult`   | Domain      | Value Object | Application result data      |
| `ArchetypeValidationResult`    | Application | Value Object | Validation result            |
| `ArchetypeApplicationPreview`  | Application | Value Object | Preview for UI               |
| `IArchetypeApplicationService` | Application | Interface    | Application service contract |
| `ArchetypeApplicationService`  | Application | Service      | Service implementation       |

### 7.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── ValueObjects/
│   └── ArchetypeApplicationResult.cs            ← NEW

src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IArchetypeApplicationService.cs          ← NEW
├── Services/
│   └── ArchetypeApplicationService.cs           ← NEW
```

---

## 8. Integration Points

### 8.1 Character Entity Methods Required

The `Character` entity must expose the following methods for the application service:

```csharp
// Properties
bool HasArchetype { get; }
Archetype? Archetype { get; }

// Resource modification
void ModifyMaxHp(int bonus);
void ModifyMaxStamina(int bonus);
void ModifyMaxAetherPool(int bonus);
void ModifyMovement(int bonus);

// Ability management
void AddAbility(string abilityId);
void ActivatePassiveAbility(string abilityId);

// Archetype management
void SetArchetype(Archetype archetype);
void SetAvailableSpecializations(ArchetypeSpecializationMapping mapping);
```

### 8.2 Dependency Injection Registration

```csharp
services.AddScoped<IArchetypeApplicationService, ArchetypeApplicationService>();
services.AddScoped<IArchetypeProvider, ArchetypeProvider>();
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component                     | Level       | Events                                           |
| ----------------------------- | ----------- | ------------------------------------------------ |
| `ArchetypeApplicationService` | Information | Service initialized, archetype applied           |
| `ArchetypeApplicationService` | Debug       | Validation, bonus application, abilities granted |
| `ArchetypeApplicationService` | Warning     | Validation failed                                |
| `ArchetypeApplicationService` | Error       | Archetype definition not found                   |

### 9.2 Logging Templates

```csharp
// Information
"ArchetypeApplicationService initialized"
"Attempting to apply archetype {Archetype} to character {CharacterName}"
"Applied archetype {Archetype} to {CharacterName}: HP+{HpBonus}, Stamina+{StaminaBonus}, {AbilityCount} abilities, {SpecCount} specializations available"
"Granted {Count} starting abilities to {CharacterName}"

// Debug
"Validation failed for {Archetype}: {Issues}"
"Applying resource bonuses to {CharacterName}: {Summary}"
"Applied special bonus: {BonusType} = {Value}"
"Granted ability {AbilityId} ({Type}) to {CharacterName}"
"Generated application preview for {Archetype}"

// Warning
"Cannot apply archetype {Archetype}: {Reason}"

// Error
"Archetype definition not found: {Archetype}"
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count: ~12 tests

```csharp
[TestFixture]
public class ArchetypeApplicationResultTests
{
    [Test]
    public void Succeeded_CreatesSuccessfulResult()
    {
        // Arrange
        var bonuses = ArchetypeResourceBonuses.Warrior;
        var abilities = new List<ArchetypeAbilityGrant>
        {
            ArchetypeAbilityGrant.CreateActive("power-strike", "Power Strike", "Desc")
        };
        var specs = ArchetypeSpecializationMapping.Warrior;

        // Act
        var result = ArchetypeApplicationResult.Succeeded(
            Archetype.Warrior, bonuses, abilities, specs);

        // Assert
        result.Success.Should().BeTrue();
        result.AppliedArchetype.Should().Be(Archetype.Warrior);
        result.ResourceBonusesApplied.Should().Be(bonuses);
        result.AbilitiesGranted.Should().HaveCount(1);
        result.FailureReason.Should().BeNull();
    }

    [Test]
    public void Failed_CreatesFailedResult()
    {
        // Act
        var result = ArchetypeApplicationResult.Failed("Test failure");

        // Assert
        result.Success.Should().BeFalse();
        result.AppliedArchetype.Should().BeNull();
        result.FailureReason.Should().Be("Test failure");
    }

    [Test]
    public void GetSummary_OnSuccess_ReturnsFormattedSummary()
    {
        // Arrange
        var result = ArchetypeApplicationResult.Succeeded(
            Archetype.Warrior,
            ArchetypeResourceBonuses.Warrior,
            new List<ArchetypeAbilityGrant>(),
            ArchetypeSpecializationMapping.Warrior);

        // Act
        var summary = result.GetSummary();

        // Assert
        summary.Should().Contain("Applied Warrior");
    }
}

[TestFixture]
public class ArchetypeApplicationServiceTests
{
    private Mock<IArchetypeProvider> _providerMock;
    private Mock<ILogger<ArchetypeApplicationService>> _loggerMock;
    private ArchetypeApplicationService _service;

    [SetUp]
    public void Setup()
    {
        _providerMock = new Mock<IArchetypeProvider>();
        _loggerMock = new Mock<ILogger<ArchetypeApplicationService>>();

        SetupDefaultProviderMock();

        _service = new ArchetypeApplicationService(
            _providerMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void ApplyArchetype_ValidCharacter_AppliesSuccessfully()
    {
        // Arrange
        var character = CreateTestCharacter();

        // Act
        var result = _service.ApplyArchetype(character, Archetype.Warrior);

        // Assert
        result.Success.Should().BeTrue();
        result.AppliedArchetype.Should().Be(Archetype.Warrior);
        result.ResourceBonusesApplied!.MaxHpBonus.Should().Be(49);
        result.AbilitiesGranted.Should().HaveCount(3);
    }

    [Test]
    public void ApplyArchetype_NullCharacter_ReturnsFailed()
    {
        // Act
        var result = _service.ApplyArchetype(null!, Archetype.Warrior);

        // Assert
        result.Success.Should().BeFalse();
        result.FailureReason.Should().Contain("character is required");
    }

    [Test]
    public void ApplyArchetype_CharacterHasArchetype_ReturnsFailed()
    {
        // Arrange
        var character = CreateTestCharacter();
        character.SetArchetype(Archetype.Skirmisher);

        // Act
        var result = _service.ApplyArchetype(character, Archetype.Warrior);

        // Assert
        result.Success.Should().BeFalse();
        result.FailureReason.Should().Contain("already has archetype");
    }

    [Test]
    public void CanApplyArchetype_ValidCharacter_ReturnsValid()
    {
        // Arrange
        var character = CreateTestCharacter();

        // Act
        var validation = _service.CanApplyArchetype(character, Archetype.Warrior);

        // Assert
        validation.IsValid.Should().BeTrue();
        validation.Issues.Should().BeEmpty();
    }

    [Test]
    public void CanApplyArchetype_NullCharacter_ReturnsInvalid()
    {
        // Act
        var validation = _service.CanApplyArchetype(null, Archetype.Warrior);

        // Assert
        validation.IsValid.Should().BeFalse();
        validation.Issues.Should().Contain("A character is required.");
    }

    [Test]
    public void CanApplyArchetype_ExistingArchetype_ReturnsInvalid()
    {
        // Arrange
        var character = CreateTestCharacter();
        character.SetArchetype(Archetype.Mystic);

        // Act
        var validation = _service.CanApplyArchetype(character, Archetype.Warrior);

        // Assert
        validation.IsValid.Should().BeFalse();
        validation.Issues.Should().Contain(i => i.Contains("already has archetype"));
    }

    [Test]
    public void GetApplicationPreview_ReturnsCompletePreview()
    {
        // Act
        var preview = _service.GetApplicationPreview(Archetype.Warrior);

        // Assert
        preview.Archetype.Should().Be(Archetype.Warrior);
        preview.DisplayName.Should().Be("Warrior");
        preview.ResourceBonuses.MaxHpBonus.Should().Be(49);
        preview.StartingAbilities.Should().HaveCount(3);
        preview.AvailableSpecializations.Count.Should().Be(6);
    }

    [Test]
    public void ApplyArchetype_Mystic_AppliesAetherPoolBonus()
    {
        // Arrange
        var character = CreateTestCharacter();
        SetupMysticProviderMock();

        // Act
        var result = _service.ApplyArchetype(character, Archetype.Mystic);

        // Assert
        result.Success.Should().BeTrue();
        result.ResourceBonusesApplied!.MaxAetherPoolBonus.Should().Be(20);
    }

    [Test]
    public void ApplyArchetype_Skirmisher_AppliesMovementBonus()
    {
        // Arrange
        var character = CreateTestCharacter();
        SetupSkirmisherProviderMock();

        // Act
        var result = _service.ApplyArchetype(character, Archetype.Skirmisher);

        // Assert
        result.Success.Should().BeTrue();
        result.ResourceBonusesApplied!.MovementBonus.Should().Be(1);
    }

    private void SetupDefaultProviderMock()
    {
        _providerMock.Setup(p => p.GetArchetype(Archetype.Warrior))
            .Returns(ArchetypeDefinition.Create(
                Archetype.Warrior, "Warrior", "Tagline",
                "Description", "Selection", "Tank",
                ResourceType.Stamina, "Playstyle"));

        _providerMock.Setup(p => p.GetResourceBonuses(Archetype.Warrior))
            .Returns(ArchetypeResourceBonuses.Warrior);

        _providerMock.Setup(p => p.GetStartingAbilities(Archetype.Warrior))
            .Returns(new List<ArchetypeAbilityGrant>
            {
                ArchetypeAbilityGrant.CreateActive("power-strike", "Power Strike", "Desc"),
                ArchetypeAbilityGrant.CreateStance("defensive-stance", "Defensive Stance", "Desc"),
                ArchetypeAbilityGrant.CreatePassive("iron-will", "Iron Will", "Desc")
            });

        _providerMock.Setup(p => p.GetSpecializationMapping(Archetype.Warrior))
            .Returns(ArchetypeSpecializationMapping.Warrior);
    }
}
```

---

## 11. Use Cases

### UC-001: Apply Archetype During Character Creation

**Actor:** Player  
**Precondition:** Player has completed Step 3 (Background)  
**Flow:** Select archetype → Call ApplyArchetype → Receive result → Display confirmation  
**Postcondition:** Character has archetype, bonuses, abilities, and specializations

### UC-002: Preview Archetype Before Selection

**Actor:** Player  
**Precondition:** Player is on Step 4  
**Flow:** Hover/select archetype → Call GetApplicationPreview → Display preview panel  
**Postcondition:** Player sees what they would receive

### UC-003: Validate Archetype Selection

**Actor:** System  
**Precondition:** Archetype selection submitted  
**Flow:** Call CanApplyArchetype → Check preconditions → Return validation result  
**Postcondition:** Invalid selections are prevented

---

## 12. User Stories

**US-001:** As a player, I want choosing my archetype to immediately apply all its bonuses so the character sheet reflects my choice.

**US-002:** As a player, I want to see a preview of archetype bonuses before committing so I can make an informed decision.

**US-003:** As a player, I want to be prevented from accidentally selecting a second archetype since it's permanent.

**US-004:** As a developer, I want a result object with all applied changes so the UI can display confirmation details.

---

## 13. Deliverable Checklist

### Value Objects

- [ ] `ArchetypeApplicationResult` with Success/Failed factories
- [ ] `ArchetypeValidationResult` record
- [ ] `ArchetypeApplicationPreview` record
- [ ] Full XML documentation

### Interface

- [ ] `IArchetypeApplicationService` interface
- [ ] Three methods: ApplyArchetype, CanApplyArchetype, GetApplicationPreview
- [ ] Full XML documentation

### Service

- [ ] `ArchetypeApplicationService` implementing interface
- [ ] Validation logic
- [ ] Resource bonus application
- [ ] Ability granting
- [ ] Integration with IArchetypeProvider
- [ ] Comprehensive logging
- [ ] Full XML documentation

### Testing

- [ ] ~12 unit tests implemented
- [ ] All tests passing
- [ ] Success and failure paths covered

---

## 14. Acceptance Criteria

### Functional

- [ ] `ApplyArchetype(character, Warrior)` applies HP+49, Stamina+5
- [ ] `ApplyArchetype` grants 3 starting abilities
- [ ] `ApplyArchetype` sets available specializations
- [ ] `ApplyArchetype` returns success with all applied data
- [ ] `ApplyArchetype` on null character returns failure
- [ ] `ApplyArchetype` on character with archetype returns failure
- [ ] `CanApplyArchetype` validates preconditions correctly
- [ ] `GetApplicationPreview` returns complete preview data
- [ ] Passive abilities are activated immediately
- [ ] Special bonuses (Adept consumable effectiveness) are applied

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~12 unit tests pass
- [ ] XML documentation complete

---

## 15. Dependencies

### Required from Previous Phases

| Type                             | Phase    | Usage                          |
| -------------------------------- | -------- | ------------------------------ |
| `Archetype`                      | v0.17.3a | Enum for identification        |
| `ArchetypeDefinition`            | v0.17.3a | Display name for preview       |
| `ArchetypeResourceBonuses`       | v0.17.3b | Bonuses to apply               |
| `ArchetypeAbilityGrant`          | v0.17.3c | Abilities to grant             |
| `ArchetypeSpecializationMapping` | v0.17.3d | Specializations to set         |
| `IArchetypeProvider`             | v0.17.3e | Data source for archetype info |
| `Character`                      | v0.16.x  | Entity being modified          |

### Provides to Future Phases

| Type                           | Phase   | Usage                          |
| ------------------------------ | ------- | ------------------------------ |
| `IArchetypeApplicationService` | v0.17.5 | Creation workflow uses service |
| `ArchetypeApplicationResult`   | v0.17.5 | UI displays application result |
| `ArchetypeApplicationPreview`  | v0.17.5 | UI shows archetype preview     |

---

## 16. Future Considerations

### Deferred to v0.17.4

- Specialization application service (similar pattern)

### Deferred to v0.17.5

- Character creation workflow integration
- UI for archetype confirmation
- Application preview display

### Out of Scope for v0.17.3

- Archetype reversion/respec
- Multi-archetype characters
- Archetype mastery/levels
- Cross-archetype abilities

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_
