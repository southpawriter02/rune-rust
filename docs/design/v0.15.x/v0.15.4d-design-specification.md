# v0.15.4d Design Specification: Trap Disarmament System

**Version:** 0.15.4d
**Theme:** Trap Disarmament System (Three-Step Procedure)
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Prerequisites:** v0.15.0 Complete (Dice Pool Refactor), v0.15.1 Complete (Skill Infrastructure), v0.15.4a Complete (Lockpicking System), v0.15.4b Complete (Terminal Hacking System), v0.15.4c Complete (ICE Countermeasures)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [TrapType Enum](#4-traptype-enum)
5. [DisarmStep Enum](#5-disarmstep-enum)
6. [TrapDisarmState Entity](#6-trapdisarmstate-entity)
7. [TrapContext Value Object](#7-trapcontext-value-object)
8. [DisarmResult Value Object](#8-disarmresult-value-object)
9. [TrapDisarmamentService](#9-trapdisarmamentservice-implementation)
10. [Salvageable Components](#10-salvageable-components)
11. [Data Model Changes](#11-data-model-changes)
12. [Configuration Files](#12-configuration-files)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)
20. [Document Metadata](#20-document-metadata)

---

## 1. Executive Summary

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.4d, the Trap Disarmament System. This phase implements the three-step procedure for detecting, analyzing, and disarming traps encountered during dungeon exploration in Aethelgard.

Traps in Aethelgard represent the layered dangers of Old World ruins—mechanical devices, electrified grids, and incomprehensible Jötun defenses that punish the unwary. The cargo cult inhabitants have learned to identify and neutralize these threats through careful observation and hard-won experience, though true understanding remains elusive. The system supports:

1. **Trap Classification**: Five trap types from Tripwire (DC 8) to Jötun Defense (DC 24)
2. **Three-Step Procedure**: Detection → Analysis → Disarmament progression
3. **Analysis Benefits**: Optional step reveals DC, consequences, and hints
4. **Failure Escalation**: Each failed attempt increases DC by +1
5. **Fumble Consequence**: [Forced Execution] triggers the trap on the disarmer
6. **Critical Salvage**: Critical success yields valuable trap components

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `TrapType`, `DisarmStep`, `DisarmStatus` |
| **Value Objects** | `TrapContext`, `DisarmResult`, `TrapAnalysisInfo` |
| **Entities** | `TrapDisarmState` |
| **Services** | `ITrapDisarmamentService`, `TrapDisarmamentService` |
| **Configuration** | `trap-types.json` |
| **Tests** | ~4 new unit tests |

### 1.3 Architectural Significance

This version establishes the **multi-step procedural pattern** for complex skill interactions:

- **State machine tracking**: `TrapDisarmState` maintains progress through Detection → Analysis → Disarmament
- **Progressive information reveal**: Analysis step provides player agency through informed decisions
- **Escalating difficulty**: Failed attempts make subsequent attempts harder
- **Risk/reward salvage**: Critical success integrates with the crafting component economy

---

## 2. Feature Overview

```
v0.15.4d Trap Disarmament System
├── Trap Classification
│   ├── TrapType enum (5 types)
│   ├── Base DCs (8-24)
│   └── Trap effects/damage
├── Three-Step Procedure
│   ├── Step 1: Detection (Perception)
│   ├── Step 2: Analysis (Optional, WITS)
│   └── Step 3: Disarmament (WITS or FINESSE)
├── State Management
│   ├── TrapDisarmState entity
│   ├── Step progression tracking
│   └── Attempt count / DC escalation
├── Analysis System
│   ├── Reveal disarm DC (Base DC - 2)
│   ├── Reveal failure consequences (Base DC)
│   └── Reveal disarm hints (Base DC + 2)
├── Disarmament Outcomes
│   ├── Success: Trap disabled
│   ├── Critical: Disabled + salvage components
│   ├── Failure: DC +1 for next attempt
│   └── Fumble: [Forced Execution]
├── Salvage System
│   ├── Component tables by trap type
│   └── Integration with inventory/crafting
└── Tool Requirements
    ├── DC 4+ requires [Tinker's Toolkit]
    └── Bare-handed penalty (-2d10)
```

---

## 3. Architecture Diagrams

### 3.1 Three-Step Disarmament Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TRAP DISARMAMENT THREE-STEP FLOW                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Character approaches trapped area                                          │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    STEP 1: DETECTION (Required)                      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Check Type: Perception (passive or active)                         │    │
│  │  DC: Varies by trap sophistication                                  │    │
│  │                                                                      │    │
│  │  Outcomes:                                                           │    │
│  │  ├── Success: Trap detected, proceed to Analysis or Disarmament    │    │
│  │  └── Failure: Walk into trap → TRAP TRIGGERS                        │    │
│  │                                                                      │    │
│  │  Detection DCs:                                                     │    │
│  │  ├── Tripwire: DC 8                                                 │    │
│  │  ├── Pressure Plate: DC 10                                          │    │
│  │  ├── Electrified: DC 14                                             │    │
│  │  ├── Laser Grid: DC 18                                              │    │
│  │  └── Jötun Defense: DC 22                                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │ (on success)                                                     │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    STEP 2: ANALYSIS (Recommended)                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Check Type: WITS                                                   │    │
│  │  Purpose: Gather information before attempting disarmament          │    │
│  │                                                                      │    │
│  │  Information Revealed:                                              │    │
│  │  ┌──────────────────────────┬─────────────────────────────────────┐ │    │
│  │  │ Information              │ Analysis DC                         │ │    │
│  │  ├──────────────────────────┼─────────────────────────────────────┤ │    │
│  │  │ Disarm DC                │ Base DC - 2                         │ │    │
│  │  │ Failure Consequences     │ Base DC                             │ │    │
│  │  │ Disarm Hints             │ Base DC + 2                         │ │    │
│  │  └──────────────────────────┴─────────────────────────────────────┘ │    │
│  │                                                                      │    │
│  │  Note: Analysis is optional but highly recommended                  │    │
│  │        Can attempt disarmament directly after detection             │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    STEP 3: DISARMAMENT                               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Check Type: Higher of WITS or FINESSE                              │    │
│  │  DC: Base DC (modified by previous failures)                        │    │
│  │  Tool Requirement: DC 4+ requires [Tinker's Toolkit]                │    │
│  │                                                                      │    │
│  │  Outcomes:                                                           │    │
│  │  ├── CRITICAL (Net ≥ 5): Trap disabled + salvage components        │    │
│  │  ├── SUCCESS (Net ≥ DC): Trap disabled                             │    │
│  │  ├── FAILURE (Net < DC): DC +1 for next attempt                    │    │
│  │  └── FUMBLE (0 success + botch): [Forced Execution]                │    │
│  │                                                                      │    │
│  │  Disarm DCs:                                                        │    │
│  │  ├── Tripwire: DC 8                                                 │    │
│  │  ├── Pressure Plate: DC 12                                          │    │
│  │  ├── Electrified: DC 16                                             │    │
│  │  ├── Laser Grid: DC 20                                              │    │
│  │  └── Jötun Defense: DC 24                                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Fumble Consequence Flow - [Forced Execution]

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    [FORCED EXECUTION] FUMBLE CONSEQUENCE                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  FUMBLE DETECTED: 0 successes, 1+ botch on disarmament check               │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    CREATE FUMBLE CONSEQUENCE                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  FumbleConsequence                                                  │    │
│  │  ├── ConsequenceId: "fc-trap-001"                                   │    │
│  │  ├── CharacterId: "player-1"                                        │    │
│  │  ├── SkillId: "system-bypass"                                       │    │
│  │  ├── ConsequenceType: ForcedExecution                               │    │
│  │  ├── TargetId: "trap-pressure-plate-3"                              │    │
│  │  ├── IsActive: true (briefly)                                       │    │
│  │  └── Effects:                                                        │    │
│  │      ├── Trap triggers on disarmer (full damage)                    │    │
│  │      ├── Disarmer is primary/only target                            │    │
│  │      └── Trap is destroyed (cannot be salvaged)                     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    APPLY TRAP DAMAGE                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Trap Type Effects:                                                 │    │
│  │  ├── Tripwire: Alarm triggers (alert nearby enemies)               │    │
│  │  ├── Pressure Plate: 2d10 damage                                   │    │
│  │  ├── Electrified: 3d10 lightning damage                            │    │
│  │  ├── Laser Grid: Alarm + lockdown (doors seal)                     │    │
│  │  └── Jötun Defense: 5d10 damage + security alert                   │    │
│  │                                                                      │    │
│  │  Apply:                                                             │    │
│  │  ├── Damage to disarmer                                             │    │
│  │  ├── Any secondary effects (alarm, lockdown, etc.)                 │    │
│  │  └── Mark trap as destroyed                                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DISPLAY NARRATIVE                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  "Your tools slip at the worst possible moment. The mechanism       │    │
│  │   lurches—you hear a click, then a roar of energy. The trap        │    │
│  │   executes its ancient purpose, with you at ground zero."           │    │
│  │                                                                      │    │
│  │   [Forced Execution - Trap triggered, 3d10 lightning damage!]       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  RECOVERY:                                                                  │
│  ├── Trap is now destroyed (no further threat)                             │
│  ├── No salvage possible from destroyed trap                               │
│  └── Heal damage, continue exploration                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Analysis Information Reveal Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ANALYSIS INFORMATION REVEAL                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Trap: Electrified Grid (Base DC 16)                                        │
│  Character attempts WITS check for analysis                                  │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ANALYSIS CHECK: WITS                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Roll: 4d10 → [2, 8, 9, 10] = 3 successes, 0 botches               │    │
│  │  Net Successes: 3                                                   │    │
│  │                                                                      │    │
│  │  Information Thresholds:                                            │    │
│  │  ├── DC 14 (Base - 2): Disarm DC revealed                          │    │
│  │  │   → Net 3 >= DC 2 (14/6) ✓ REVEALED                             │    │
│  │  │                                                                   │    │
│  │  ├── DC 16 (Base): Failure consequences revealed                   │    │
│  │  │   → Net 3 >= DC 3 (16/6) ✓ REVEALED                             │    │
│  │  │                                                                   │    │
│  │  └── DC 18 (Base + 2): Disarm hints revealed                       │    │
│  │      → Net 3 >= DC 3 (18/6) ✓ REVEALED                             │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    REVEALED INFORMATION                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  TrapAnalysisInfo                                                   │    │
│  │  ├── DisarmDcRevealed: true                                         │    │
│  │  │   "The mechanism's complexity suggests a DC 16 challenge."       │    │
│  │  │                                                                   │    │
│  │  ├── ConsequencesRevealed: true                                     │    │
│  │  │   "Failure would unleash 3d10 lightning damage through the      │    │
│  │  │    conductive grid."                                             │    │
│  │  │                                                                   │    │
│  │  └── HintsRevealed: true                                            │    │
│  │      "The power coupling on the left side appears to be the main   │    │
│  │       feed. Disconnecting it first would be wise."                  │    │
│  │       [Hint grants +1d10 on disarmament attempt]                    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Player can now make informed decision:                                     │
│  ├── Proceed with disarmament (now with +1d10 from hint)                   │
│  ├── Find alternate route (avoid trap entirely)                            │
│  ├── Trigger from distance (sacrifice trap for safety)                     │
│  └── Have tankier character trigger it deliberately                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                              │    │
│  │  ├── TrapType.cs             ←── NEW (trap classification)          │    │
│  │  ├── DisarmStep.cs           ←── NEW (procedure step)               │    │
│  │  └── DisarmStatus.cs         ←── NEW (overall status)               │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                       │    │
│  │  ├── TrapContext.cs          ←── NEW (trap check context)           │    │
│  │  ├── DisarmResult.cs         ←── NEW (disarmament outcome)          │    │
│  │  └── TrapAnalysisInfo.cs     ←── NEW (revealed information)         │    │
│  │                                                                      │    │
│  │  Entities/                                                           │    │
│  │  └── TrapDisarmState.cs      ←── NEW (state tracking)               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      SERVICE LAYER                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Interfaces/                                                         │    │
│  │  └── ITrapDisarmamentService.cs   ←── NEW                           │    │
│  │                                                                      │    │
│  │  Services/                                                           │    │
│  │  └── TrapDisarmamentService.cs    ←── NEW                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      CONFIGURATION                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                      │    │
│  │  ├── trap-types.json         ←── NEW (trap definitions)             │    │
│  │  └── trap-descriptors.json   ←── NEW (narrative text)               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. TrapType Enum

### 4.1 Specification

```csharp
/// <summary>
/// Defines the classification of traps found in Aethelgard's ruins and dungeons.
/// </summary>
/// <remarks>
/// Each trap type has an associated base DC for detection and disarmament,
/// as well as specific damage or effect when triggered. Trap sophistication
/// generally increases with DC, reflecting Old World technological complexity.
/// </remarks>
public enum TrapType
{
    /// <summary>
    /// Simple mechanical trap using a wire to trigger an alarm or minor mechanism.
    /// Detection DC: 8, Disarm DC: 8.
    /// Effect: Triggers alarm (alerts nearby enemies).
    /// </summary>
    Tripwire = 0,

    /// <summary>
    /// Weight-sensitive plate that triggers a damaging mechanism when stepped on.
    /// Detection DC: 10, Disarm DC: 12.
    /// Effect: 2d10 damage (crushing, piercing, or bludgeoning).
    /// </summary>
    PressurePlate = 1,

    /// <summary>
    /// Electrified surface or grid that delivers a powerful shock.
    /// Detection DC: 14, Disarm DC: 16.
    /// Effect: 3d10 lightning damage.
    /// </summary>
    Electrified = 2,

    /// <summary>
    /// Advanced Old World security using focused light beams to detect intrusion.
    /// Detection DC: 18, Disarm DC: 20.
    /// Effect: Alarm + lockdown (doors seal, security activates).
    /// </summary>
    LaserGrid = 3,

    /// <summary>
    /// Incomprehensible Jötun defense mechanism, the most dangerous trap type.
    /// Detection DC: 22, Disarm DC: 24.
    /// Effect: 5d10 damage + security alert (reinforcements summoned).
    /// </summary>
    JotunDefense = 4
}
```

### 4.2 Trap Type Summary Table

| Trap Type | Detection DC | Disarm DC | Effect on Trigger |
|-----------|-------------|-----------|-------------------|
| **Tripwire** | 8 | 8 | Alarm (alerts nearby enemies) |
| **Pressure Plate** | 10 | 12 | 2d10 damage |
| **Electrified** | 14 | 16 | 3d10 lightning damage |
| **Laser Grid** | 18 | 20 | Alarm + lockdown |
| **Jötun Defense** | 22 | 24 | 5d10 damage + security alert |

---

## 5. DisarmStep Enum

### 5.1 Specification

```csharp
/// <summary>
/// Represents the three steps in the trap disarmament procedure.
/// </summary>
/// <remarks>
/// The procedure follows a strict progression:
/// 1. Detection is required before any other action
/// 2. Analysis is optional but provides valuable information
/// 3. Disarmament is the final step to neutralize the trap
///
/// Players may skip Analysis and proceed directly to Disarmament,
/// but this sacrifices the information advantage Analysis provides.
/// </remarks>
public enum DisarmStep
{
    /// <summary>
    /// Initial step: Finding the trap before it triggers.
    /// Uses Perception check. Failure means walking into the trap.
    /// </summary>
    Detection = 0,

    /// <summary>
    /// Optional step: Studying the trap to reveal information.
    /// Uses WITS check. Reveals DC, consequences, and hints based on success.
    /// </summary>
    Analysis = 1,

    /// <summary>
    /// Final step: Neutralizing the trap mechanism.
    /// Uses higher of WITS or FINESSE. Success disables trap, fumble triggers it.
    /// </summary>
    Disarmament = 2
}
```

### 5.2 DisarmStatus Enum

```csharp
/// <summary>
/// The overall status of a trap disarmament attempt.
/// </summary>
public enum DisarmStatus
{
    /// <summary>
    /// Trap has not yet been detected.
    /// </summary>
    Undetected = 0,

    /// <summary>
    /// Trap has been detected, awaiting Analysis or Disarmament.
    /// </summary>
    Detected = 1,

    /// <summary>
    /// Trap has been analyzed, awaiting Disarmament.
    /// </summary>
    Analyzed = 2,

    /// <summary>
    /// Disarmament is in progress (for multi-attempt scenarios).
    /// </summary>
    DisarmInProgress = 3,

    /// <summary>
    /// Trap has been successfully disarmed.
    /// </summary>
    Disarmed = 4,

    /// <summary>
    /// Trap was triggered (either by walking into it or fumble).
    /// </summary>
    Triggered = 5,

    /// <summary>
    /// Trap was destroyed (cannot be salvaged).
    /// </summary>
    Destroyed = 6
}
```

---

## 6. TrapDisarmState Entity

### 6.1 Specification

```csharp
/// <summary>
/// Tracks the state of a trap disarmament attempt across the three-step procedure.
/// </summary>
/// <remarks>
/// This entity maintains progress through Detection → Analysis → Disarmament,
/// tracking revealed information, attempt counts, and DC escalation from failures.
/// </remarks>
public class TrapDisarmState
{
    /// <summary>
    /// Unique identifier for this disarmament attempt.
    /// </summary>
    public string DisarmId { get; private set; }

    /// <summary>
    /// The character attempting the disarmament.
    /// </summary>
    public string CharacterId { get; private set; }

    /// <summary>
    /// The type of trap being disarmed.
    /// </summary>
    public TrapType TrapType { get; private set; }

    /// <summary>
    /// The current step in the disarmament procedure.
    /// </summary>
    public DisarmStep CurrentStep { get; private set; }

    /// <summary>
    /// Whether the Analysis step has been completed.
    /// </summary>
    public bool AnalysisComplete { get; private set; }

    /// <summary>
    /// Information revealed through successful Analysis checks.
    /// </summary>
    public TrapAnalysisInfo RevealedInfo { get; private set; }

    /// <summary>
    /// Number of failed disarmament attempts (affects DC).
    /// </summary>
    public int FailedAttempts { get; private set; }

    /// <summary>
    /// The current disarm DC (base + failed attempts).
    /// </summary>
    public int CurrentDisarmDc => GetBaseDisarmDc() + FailedAttempts;

    /// <summary>
    /// The overall status of the disarmament.
    /// </summary>
    public DisarmStatus Status { get; private set; }

    /// <summary>
    /// Components salvaged from the trap (on critical success).
    /// </summary>
    public List<string> SalvagedComponents { get; private set; } = new();

    // Private constructor for EF Core
    private TrapDisarmState() { }

    /// <summary>
    /// Creates a new trap disarmament state for an undetected trap.
    /// </summary>
    public static TrapDisarmState Create(string characterId, TrapType trapType)
    {
        return new TrapDisarmState
        {
            DisarmId = Guid.NewGuid().ToString(),
            CharacterId = characterId,
            TrapType = trapType,
            CurrentStep = DisarmStep.Detection,
            AnalysisComplete = false,
            RevealedInfo = TrapAnalysisInfo.Empty,
            FailedAttempts = 0,
            Status = DisarmStatus.Undetected
        };
    }

    /// <summary>
    /// Marks the trap as detected, allowing Analysis or Disarmament.
    /// </summary>
    public void MarkDetected()
    {
        if (Status != DisarmStatus.Undetected)
            throw new InvalidOperationException("Trap is already detected or in another state.");

        Status = DisarmStatus.Detected;
        CurrentStep = DisarmStep.Analysis; // Next step (optional)
    }

    /// <summary>
    /// Records the results of an Analysis attempt.
    /// </summary>
    public void RecordAnalysis(TrapAnalysisInfo info)
    {
        if (Status != DisarmStatus.Detected && Status != DisarmStatus.Analyzed)
            throw new InvalidOperationException("Must detect trap before analyzing.");

        RevealedInfo = info;
        AnalysisComplete = true;
        Status = DisarmStatus.Analyzed;
        CurrentStep = DisarmStep.Disarmament;
    }

    /// <summary>
    /// Skips Analysis and proceeds directly to Disarmament.
    /// </summary>
    public void SkipAnalysis()
    {
        if (Status != DisarmStatus.Detected)
            throw new InvalidOperationException("Must detect trap before proceeding.");

        CurrentStep = DisarmStep.Disarmament;
        Status = DisarmStatus.DisarmInProgress;
    }

    /// <summary>
    /// Records a failed disarmament attempt, increasing DC.
    /// </summary>
    public void RecordFailedAttempt()
    {
        FailedAttempts++;
        Status = DisarmStatus.DisarmInProgress;
    }

    /// <summary>
    /// Marks the trap as successfully disarmed.
    /// </summary>
    public void MarkDisarmed(List<string>? salvage = null)
    {
        Status = DisarmStatus.Disarmed;
        if (salvage != null)
        {
            SalvagedComponents.AddRange(salvage);
        }
    }

    /// <summary>
    /// Marks the trap as triggered (fumble or walking into it).
    /// </summary>
    public void MarkTriggered()
    {
        Status = DisarmStatus.Triggered;
    }

    /// <summary>
    /// Marks the trap as destroyed (no salvage possible).
    /// </summary>
    public void MarkDestroyed()
    {
        Status = DisarmStatus.Destroyed;
    }

    /// <summary>
    /// Gets the base disarm DC for the trap type.
    /// </summary>
    private int GetBaseDisarmDc()
    {
        return TrapType switch
        {
            TrapType.Tripwire => 8,
            TrapType.PressurePlate => 12,
            TrapType.Electrified => 16,
            TrapType.LaserGrid => 20,
            TrapType.JotunDefense => 24,
            _ => 12
        };
    }
}
```

---

## 7. TrapContext Value Object

### 7.1 Specification

```csharp
/// <summary>
/// Contextual information for a trap disarmament check, providing
/// modifiers and requirements for the skill check.
/// </summary>
/// <param name="TrapType">The type of trap being disarmed.</param>
/// <param name="Step">The current step in the disarmament procedure.</param>
/// <param name="ToolQuality">Quality of tools available for disarmament.</param>
/// <param name="HasAnalysisHint">Whether Analysis revealed a hint (+1d10).</param>
/// <param name="FailedAttempts">Number of previous failed attempts (+1 DC each).</param>
public readonly record struct TrapContext(
    TrapType TrapType,
    DisarmStep Step,
    ToolQuality ToolQuality,
    bool HasAnalysisHint,
    int FailedAttempts)
{
    /// <summary>
    /// Gets the base DC for the current step.
    /// </summary>
    public int GetBaseDc()
    {
        return (Step, TrapType) switch
        {
            // Detection DCs
            (DisarmStep.Detection, TrapType.Tripwire) => 8,
            (DisarmStep.Detection, TrapType.PressurePlate) => 10,
            (DisarmStep.Detection, TrapType.Electrified) => 14,
            (DisarmStep.Detection, TrapType.LaserGrid) => 18,
            (DisarmStep.Detection, TrapType.JotunDefense) => 22,

            // Disarmament DCs
            (DisarmStep.Disarmament, TrapType.Tripwire) => 8,
            (DisarmStep.Disarmament, TrapType.PressurePlate) => 12,
            (DisarmStep.Disarmament, TrapType.Electrified) => 16,
            (DisarmStep.Disarmament, TrapType.LaserGrid) => 20,
            (DisarmStep.Disarmament, TrapType.JotunDefense) => 24,

            // Analysis uses variable DCs based on information sought
            _ => 12
        };
    }

    /// <summary>
    /// Gets the effective DC including failure escalation.
    /// </summary>
    public int GetEffectiveDc()
    {
        return GetBaseDc() + FailedAttempts;
    }

    /// <summary>
    /// Gets the dice pool modifier from tools.
    /// </summary>
    public int GetToolModifier()
    {
        return ToolQuality switch
        {
            ToolQuality.BareHands => -2,
            ToolQuality.Improvised => 0,
            ToolQuality.Proper => 1,
            ToolQuality.Masterwork => 2,
            _ => 0
        };
    }

    /// <summary>
    /// Gets the dice pool modifier from Analysis hint.
    /// </summary>
    public int GetHintModifier()
    {
        return HasAnalysisHint ? 1 : 0;
    }

    /// <summary>
    /// Gets the total dice pool modifier.
    /// </summary>
    public int GetTotalModifier()
    {
        return GetToolModifier() + GetHintModifier();
    }

    /// <summary>
    /// Whether tools are required for this trap (DC 4+).
    /// </summary>
    public bool RequiresTools => GetBaseDc() >= 4;

    /// <summary>
    /// Whether bare hands are allowed (DC 1-3 only).
    /// </summary>
    public bool AllowsBareHands => GetBaseDc() < 4;
}
```

---

## 8. DisarmResult Value Object

### 8.1 Specification

```csharp
/// <summary>
/// The complete result of a trap disarmament attempt, including all
/// mechanical outcomes and consequences.
/// </summary>
/// <param name="State">The updated disarmament state.</param>
/// <param name="Step">The step that was attempted.</param>
/// <param name="Success">Whether the attempt succeeded.</param>
/// <param name="IsCritical">Whether it was a critical success (net >= 5).</param>
/// <param name="IsFumble">Whether it was a fumble (0 success + botch).</param>
/// <param name="NetSuccesses">The net successes from the roll.</param>
/// <param name="EffectiveDc">The DC the roll was against.</param>
/// <param name="DamageDealt">Damage dealt if trap triggered.</param>
/// <param name="DamageType">Type of damage dealt.</param>
/// <param name="AlertTriggered">Whether an alarm was triggered.</param>
/// <param name="LockdownTriggered">Whether a lockdown was triggered.</param>
/// <param name="SalvagedComponents">Components salvaged on critical success.</param>
/// <param name="NarrativeDescription">Flavor text for the outcome.</param>
public readonly record struct DisarmResult(
    TrapDisarmState State,
    DisarmStep Step,
    bool Success,
    bool IsCritical,
    bool IsFumble,
    int NetSuccesses,
    int EffectiveDc,
    int DamageDealt,
    DamageType DamageType,
    bool AlertTriggered,
    bool LockdownTriggered,
    IReadOnlyList<string> SalvagedComponents,
    string NarrativeDescription)
{
    /// <summary>
    /// Whether the trap was triggered (failure on detection or fumble on disarm).
    /// </summary>
    public bool TrapTriggered => (Step == DisarmStep.Detection && !Success) || IsFumble;

    /// <summary>
    /// Whether the trap is now neutralized (success or triggered).
    /// </summary>
    public bool TrapNeutralized => Success || TrapTriggered;

    /// <summary>
    /// Whether salvage was obtained.
    /// </summary>
    public bool HasSalvage => SalvagedComponents.Count > 0;

    /// <summary>
    /// Creates a successful detection result.
    /// </summary>
    public static DisarmResult DetectionSuccess(TrapDisarmState state, int netSuccesses, int dc)
    {
        return new DisarmResult(
            State: state,
            Step: DisarmStep.Detection,
            Success: true,
            IsCritical: netSuccesses >= 5,
            IsFumble: false,
            NetSuccesses: netSuccesses,
            EffectiveDc: dc,
            DamageDealt: 0,
            DamageType: DamageType.None,
            AlertTriggered: false,
            LockdownTriggered: false,
            SalvagedComponents: Array.Empty<string>(),
            NarrativeDescription: "You spot the trap before it spots you. The mechanism " +
                                  "lies dormant, waiting for its next victim."
        );
    }

    /// <summary>
    /// Creates a failed detection result (trap triggers).
    /// </summary>
    public static DisarmResult DetectionFailure(TrapDisarmState state, int netSuccesses, int dc,
        int damage, DamageType damageType, bool alert, bool lockdown, string narrative)
    {
        return new DisarmResult(
            State: state,
            Step: DisarmStep.Detection,
            Success: false,
            IsCritical: false,
            IsFumble: false,
            NetSuccesses: netSuccesses,
            EffectiveDc: dc,
            DamageDealt: damage,
            DamageType: damageType,
            AlertTriggered: alert,
            LockdownTriggered: lockdown,
            SalvagedComponents: Array.Empty<string>(),
            NarrativeDescription: narrative
        );
    }

    /// <summary>
    /// Creates a successful disarmament result.
    /// </summary>
    public static DisarmResult DisarmSuccess(TrapDisarmState state, int netSuccesses, int dc,
        bool isCritical, IReadOnlyList<string> salvage, string narrative)
    {
        return new DisarmResult(
            State: state,
            Step: DisarmStep.Disarmament,
            Success: true,
            IsCritical: isCritical,
            IsFumble: false,
            NetSuccesses: netSuccesses,
            EffectiveDc: dc,
            DamageDealt: 0,
            DamageType: DamageType.None,
            AlertTriggered: false,
            LockdownTriggered: false,
            SalvagedComponents: salvage,
            NarrativeDescription: narrative
        );
    }

    /// <summary>
    /// Creates a failed disarmament result (DC escalation).
    /// </summary>
    public static DisarmResult DisarmFailure(TrapDisarmState state, int netSuccesses, int dc)
    {
        return new DisarmResult(
            State: state,
            Step: DisarmStep.Disarmament,
            Success: false,
            IsCritical: false,
            IsFumble: false,
            NetSuccesses: netSuccesses,
            EffectiveDc: dc,
            DamageDealt: 0,
            DamageType: DamageType.None,
            AlertTriggered: false,
            LockdownTriggered: false,
            SalvagedComponents: Array.Empty<string>(),
            NarrativeDescription: "The mechanism resists your efforts. You'll need to try " +
                                  "a different approach—and it won't be any easier."
        );
    }

    /// <summary>
    /// Creates a fumble result ([Forced Execution]).
    /// </summary>
    public static DisarmResult Fumble(TrapDisarmState state, int netSuccesses, int dc,
        int damage, DamageType damageType, bool alert, bool lockdown, string narrative)
    {
        return new DisarmResult(
            State: state,
            Step: DisarmStep.Disarmament,
            Success: false,
            IsCritical: false,
            IsFumble: true,
            NetSuccesses: netSuccesses,
            EffectiveDc: dc,
            DamageDealt: damage,
            DamageType: damageType,
            AlertTriggered: alert,
            LockdownTriggered: lockdown,
            SalvagedComponents: Array.Empty<string>(),
            NarrativeDescription: narrative
        );
    }
}
```

### 8.2 TrapAnalysisInfo Value Object

```csharp
/// <summary>
/// Information revealed through Analysis of a trap.
/// </summary>
/// <param name="DisarmDcRevealed">Whether the disarm DC was revealed.</param>
/// <param name="DisarmDc">The revealed disarm DC (if revealed).</param>
/// <param name="ConsequencesRevealed">Whether failure consequences were revealed.</param>
/// <param name="ConsequenceDescription">Description of failure consequences.</param>
/// <param name="HintRevealed">Whether a disarm hint was revealed.</param>
/// <param name="HintDescription">The revealed hint for disarmament.</param>
public readonly record struct TrapAnalysisInfo(
    bool DisarmDcRevealed,
    int? DisarmDc,
    bool ConsequencesRevealed,
    string? ConsequenceDescription,
    bool HintRevealed,
    string? HintDescription)
{
    /// <summary>
    /// Empty analysis info (no information revealed).
    /// </summary>
    public static TrapAnalysisInfo Empty => new(false, null, false, null, false, null);

    /// <summary>
    /// Whether any information was revealed.
    /// </summary>
    public bool HasAnyInfo => DisarmDcRevealed || ConsequencesRevealed || HintRevealed;

    /// <summary>
    /// Whether a hint was revealed (grants +1d10 on disarmament).
    /// </summary>
    public bool GrantsHintBonus => HintRevealed;

    /// <summary>
    /// Creates analysis info with all information revealed.
    /// </summary>
    public static TrapAnalysisInfo Full(int disarmDc, string consequences, string hint)
    {
        return new TrapAnalysisInfo(
            DisarmDcRevealed: true,
            DisarmDc: disarmDc,
            ConsequencesRevealed: true,
            ConsequenceDescription: consequences,
            HintRevealed: true,
            HintDescription: hint
        );
    }

    /// <summary>
    /// Creates analysis info with partial information based on check result.
    /// </summary>
    public static TrapAnalysisInfo FromCheckResult(
        int netSuccesses,
        int baseDc,
        int disarmDc,
        string consequences,
        string hint)
    {
        // DC - 2: Reveal disarm DC
        var revealDcThreshold = (baseDc - 2) / 6; // Convert to success-counting DC
        var dcRevealed = netSuccesses >= Math.Max(1, revealDcThreshold);

        // DC: Reveal consequences
        var consequenceThreshold = baseDc / 6;
        var consequencesRevealed = netSuccesses >= Math.Max(1, consequenceThreshold);

        // DC + 2: Reveal hint
        var hintThreshold = (baseDc + 2) / 6;
        var hintRevealed = netSuccesses >= Math.Max(1, hintThreshold);

        return new TrapAnalysisInfo(
            DisarmDcRevealed: dcRevealed,
            DisarmDc: dcRevealed ? disarmDc : null,
            ConsequencesRevealed: consequencesRevealed,
            ConsequenceDescription: consequencesRevealed ? consequences : null,
            HintRevealed: hintRevealed,
            HintDescription: hintRevealed ? hint : null
        );
    }
}
```

---

## 9. TrapDisarmamentService Implementation

### 9.1 Interface

```csharp
/// <summary>
/// Service for handling the three-step trap disarmament procedure.
/// </summary>
public interface ITrapDisarmamentService
{
    /// <summary>
    /// Attempts to detect a trap before triggering it.
    /// </summary>
    /// <param name="character">The character attempting detection.</param>
    /// <param name="trapType">The type of trap in the area.</param>
    /// <returns>Detection result, including trap trigger if failed.</returns>
    DisarmResult AttemptDetection(Character character, TrapType trapType);

    /// <summary>
    /// Analyzes a detected trap to reveal information.
    /// </summary>
    /// <param name="state">The current disarmament state.</param>
    /// <param name="character">The character performing analysis.</param>
    /// <returns>Analysis info with revealed information.</returns>
    TrapAnalysisInfo AnalyzeTrap(TrapDisarmState state, Character character);

    /// <summary>
    /// Attempts to disarm a detected trap.
    /// </summary>
    /// <param name="state">The current disarmament state.</param>
    /// <param name="character">The character attempting disarmament.</param>
    /// <param name="toolQuality">Quality of tools being used.</param>
    /// <returns>Disarmament result, including salvage or fumble consequences.</returns>
    DisarmResult AttemptDisarmament(TrapDisarmState state, Character character, ToolQuality toolQuality);

    /// <summary>
    /// Gets the trap effect when triggered (damage, alerts, etc.).
    /// </summary>
    /// <param name="trapType">The type of trap triggered.</param>
    /// <returns>Tuple of damage, damage type, alert status, lockdown status.</returns>
    (int Damage, DamageType Type, bool Alert, bool Lockdown) GetTrapEffect(TrapType trapType);

    /// <summary>
    /// Gets the salvageable components for a trap type.
    /// </summary>
    /// <param name="trapType">The type of trap.</param>
    /// <returns>List of component IDs that can be salvaged.</returns>
    IReadOnlyList<string> GetSalvageableComponents(TrapType trapType);
}
```

### 9.2 Implementation

```csharp
/// <summary>
/// Implementation of the trap disarmament procedure.
/// </summary>
public class TrapDisarmamentService : ITrapDisarmamentService
{
    private readonly ILogger<TrapDisarmamentService> _logger;
    private readonly ISkillCheckService _skillCheckService;
    private readonly IDiceRollerService _diceRoller;
    private readonly IDamageService _damageService;
    private readonly TrapConfiguration _config;

    public TrapDisarmamentService(
        ILogger<TrapDisarmamentService> logger,
        ISkillCheckService skillCheckService,
        IDiceRollerService diceRoller,
        IDamageService damageService,
        IOptions<TrapConfiguration> config)
    {
        _logger = logger;
        _skillCheckService = skillCheckService;
        _diceRoller = diceRoller;
        _damageService = damageService;
        _config = config.Value;
    }

    /// <inheritdoc />
    public DisarmResult AttemptDetection(Character character, TrapType trapType)
    {
        var state = TrapDisarmState.Create(character.Id, trapType);
        var detectionDc = GetDetectionDc(trapType);

        _logger.LogInformation(
            "Detection attempt: CharacterId={CharacterId}, TrapType={TrapType}, DC={Dc}",
            character.Id, trapType, detectionDc);

        // Perception check for detection
        var checkResult = _skillCheckService.PerformCheck(
            character,
            SkillContext.Create("perception", character.Id),
            detectionDc);

        if (checkResult.IsSuccess)
        {
            state.MarkDetected();
            _logger.LogInformation("Trap detected: {TrapType}", trapType);
            return DisarmResult.DetectionSuccess(state, checkResult.NetSuccesses, detectionDc);
        }
        else
        {
            // Failed detection = walk into trap
            state.MarkTriggered();
            var (damage, damageType, alert, lockdown) = GetTrapEffect(trapType);
            var actualDamage = RollTrapDamage(trapType);

            _logger.LogWarning(
                "Detection failed, trap triggered: TrapType={TrapType}, Damage={Damage}",
                trapType, actualDamage);

            return DisarmResult.DetectionFailure(
                state,
                checkResult.NetSuccesses,
                detectionDc,
                actualDamage,
                damageType,
                alert,
                lockdown,
                GetTriggerNarrative(trapType));
        }
    }

    /// <inheritdoc />
    public TrapAnalysisInfo AnalyzeTrap(TrapDisarmState state, Character character)
    {
        var baseDc = GetDisarmDc(state.TrapType);

        _logger.LogInformation(
            "Analysis attempt: CharacterId={CharacterId}, TrapType={TrapType}",
            character.Id, state.TrapType);

        // WITS check for analysis
        var checkResult = _skillCheckService.PerformCheck(
            character,
            SkillContext.Create("wits-check", character.Id),
            baseDc);

        var analysisInfo = TrapAnalysisInfo.FromCheckResult(
            checkResult.NetSuccesses,
            baseDc,
            state.CurrentDisarmDc,
            GetConsequenceDescription(state.TrapType),
            GetDisarmHint(state.TrapType));

        state.RecordAnalysis(analysisInfo);

        _logger.LogInformation(
            "Analysis complete: DcRevealed={Dc}, ConsequencesRevealed={Consequences}, HintRevealed={Hint}",
            analysisInfo.DisarmDcRevealed,
            analysisInfo.ConsequencesRevealed,
            analysisInfo.HintRevealed);

        return analysisInfo;
    }

    /// <inheritdoc />
    public DisarmResult AttemptDisarmament(
        TrapDisarmState state,
        Character character,
        ToolQuality toolQuality)
    {
        // Validate tool requirements
        if (state.CurrentDisarmDc >= 4 && toolQuality == ToolQuality.BareHands)
        {
            throw new InvalidOperationException(
                "DC 4+ traps require [Tinker's Toolkit]. Cannot attempt bare-handed.");
        }

        var context = new TrapContext(
            state.TrapType,
            DisarmStep.Disarmament,
            toolQuality,
            state.RevealedInfo.GrantsHintBonus,
            state.FailedAttempts);

        _logger.LogInformation(
            "Disarmament attempt: CharacterId={CharacterId}, TrapType={TrapType}, DC={Dc}, Modifier={Mod}",
            character.Id, state.TrapType, context.GetEffectiveDc(), context.GetTotalModifier());

        // Higher of WITS or FINESSE
        var skillId = GetBestDisarmAttribute(character);
        var checkResult = _skillCheckService.PerformCheckWithModifier(
            character,
            SkillContext.Create(skillId, character.Id),
            context.GetEffectiveDc(),
            context.GetTotalModifier());

        // Check for fumble first
        if (checkResult.IsFumble)
        {
            state.MarkDestroyed();
            var (damage, damageType, alert, lockdown) = GetTrapEffect(state.TrapType);
            var actualDamage = RollTrapDamage(state.TrapType);

            _logger.LogWarning(
                "FUMBLE! [Forced Execution]: TrapType={TrapType}, Damage={Damage}",
                state.TrapType, actualDamage);

            return DisarmResult.Fumble(
                state,
                checkResult.NetSuccesses,
                context.GetEffectiveDc(),
                actualDamage,
                damageType,
                alert,
                lockdown,
                GetFumbleNarrative(state.TrapType));
        }

        // Check for success
        if (checkResult.IsSuccess)
        {
            var salvage = checkResult.IsCritical
                ? GetSalvageableComponents(state.TrapType).ToList()
                : new List<string>();

            state.MarkDisarmed(salvage);

            _logger.LogInformation(
                "Disarmament success: Critical={IsCritical}, Salvage={SalvageCount}",
                checkResult.IsCritical, salvage.Count);

            return DisarmResult.DisarmSuccess(
                state,
                checkResult.NetSuccesses,
                context.GetEffectiveDc(),
                checkResult.IsCritical,
                salvage,
                checkResult.IsCritical
                    ? GetCriticalSuccessNarrative(state.TrapType)
                    : GetSuccessNarrative(state.TrapType));
        }

        // Failure - DC escalation
        state.RecordFailedAttempt();

        _logger.LogInformation(
            "Disarmament failed: FailedAttempts={Attempts}, NewDC={NewDc}",
            state.FailedAttempts, state.CurrentDisarmDc);

        return DisarmResult.DisarmFailure(
            state,
            checkResult.NetSuccesses,
            context.GetEffectiveDc());
    }

    /// <inheritdoc />
    public (int Damage, DamageType Type, bool Alert, bool Lockdown) GetTrapEffect(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => (0, DamageType.None, true, false),
            TrapType.PressurePlate => (0, DamageType.Physical, false, false), // Damage rolled separately
            TrapType.Electrified => (0, DamageType.Lightning, false, false),
            TrapType.LaserGrid => (0, DamageType.None, true, true),
            TrapType.JotunDefense => (0, DamageType.Physical, true, false),
            _ => (0, DamageType.None, false, false)
        };
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetSalvageableComponents(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.PressurePlate => new[] { "high-tension-spring", "pressure-sensor" },
            TrapType.Tripwire => new[] { "trigger-mechanism", "wire-bundle" },
            TrapType.Electrified => new[] { "capacitor", "blighted-power-cell" },
            TrapType.LaserGrid => new[] { "sensor-module", "focusing-crystal" },
            TrapType.JotunDefense => new[] { "jotun-mechanism-fragment", "ancient-power-core" },
            _ => Array.Empty<string>()
        };
    }

    private int GetDetectionDc(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => 8,
            TrapType.PressurePlate => 10,
            TrapType.Electrified => 14,
            TrapType.LaserGrid => 18,
            TrapType.JotunDefense => 22,
            _ => 12
        };
    }

    private int GetDisarmDc(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => 8,
            TrapType.PressurePlate => 12,
            TrapType.Electrified => 16,
            TrapType.LaserGrid => 20,
            TrapType.JotunDefense => 24,
            _ => 12
        };
    }

    private int RollTrapDamage(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => 0, // No damage, just alarm
            TrapType.PressurePlate => _diceRoller.Roll(2, 10).Total,
            TrapType.Electrified => _diceRoller.Roll(3, 10).Total,
            TrapType.LaserGrid => 0, // No damage, alarm + lockdown
            TrapType.JotunDefense => _diceRoller.Roll(5, 10).Total,
            _ => 0
        };
    }

    private string GetBestDisarmAttribute(Character character)
    {
        // Return the skill ID for the higher of WITS or FINESSE
        var wits = character.GetAttributeValue("wits");
        var finesse = character.GetAttributeValue("finesse");
        return wits >= finesse ? "wits-check" : "finesse-check";
    }

    private string GetConsequenceDescription(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "Triggering this wire would sound an alarm, alerting nearby threats.",
            TrapType.PressurePlate => "Failure would release a crushing mechanism dealing 2d10 damage.",
            TrapType.Electrified => "The grid would unleash 3d10 lightning damage through the conductive surface.",
            TrapType.LaserGrid => "Breaking the beam would trigger alarms and seal all nearby doors.",
            TrapType.JotunDefense => "The ancient defense would unleash 5d10 damage and summon security constructs.",
            _ => "Unknown consequences."
        };
    }

    private string GetDisarmHint(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "The wire is attached to a simple bell mechanism. Cutting it near the anchor would silence it.",
            TrapType.PressurePlate => "The pressure sensor has a calibration screw. Loosening it would increase the trigger threshold.",
            TrapType.Electrified => "The power coupling on the left side appears to be the main feed. Disconnecting it first would be wise.",
            TrapType.LaserGrid => "The emitters cycle every few seconds. Timing your movements to the cycle is the key.",
            TrapType.JotunDefense => "The mechanism hums in a pattern—ancient but recognizable. Matching the frequency with your tools might confuse it.",
            _ => "No hints available."
        };
    }

    private string GetTriggerNarrative(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "Your foot catches the wire too late. A shrill alarm pierces the darkness.",
            TrapType.PressurePlate => "The floor gives way beneath your foot. Something clicks—then strikes.",
            TrapType.Electrified => "The grid crackles to life as you step onto it. Lightning arcs through your body.",
            TrapType.LaserGrid => "The beam flares red as you break it. Doors slam shut. Alarms wail.",
            TrapType.JotunDefense => "Ancient mechanisms awaken. Pain and noise erupt in equal measure.",
            _ => "The trap activates."
        };
    }

    private string GetSuccessNarrative(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "The wire goes slack in your hands. The trap is neutralized.",
            TrapType.PressurePlate => "With careful precision, you disable the pressure mechanism. Safe.",
            TrapType.Electrified => "The crackling fades. The grid is now just harmless metal.",
            TrapType.LaserGrid => "The beams flicker and die. You've blinded the ancient eye.",
            TrapType.JotunDefense => "The Jötun mechanism groans and falls silent. You've outsmarted the ancients.",
            _ => "The trap is disabled."
        };
    }

    private string GetCriticalSuccessNarrative(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "Not only do you disable the wire, but you recover usable components from the mechanism.",
            TrapType.PressurePlate => "With expert precision, you dismantle the trap entirely, salvaging valuable components.",
            TrapType.Electrified => "You not only disable the grid but carefully extract its power components. Excellent work.",
            TrapType.LaserGrid => "The system yields to your expertise. You salvage the focusing crystal and sensor module intact.",
            TrapType.JotunDefense => "The ancient mechanism surrenders its secrets. You recover fragments of Jötun technology.",
            _ => "The trap is disabled and yields components."
        };
    }

    private string GetFumbleNarrative(TrapType trapType)
    {
        return trapType switch
        {
            TrapType.Tripwire => "Your tools slip at the worst moment. The alarm screams into the darkness.",
            TrapType.PressurePlate => "A wrong move—the mechanism triggers with you on top of it.",
            TrapType.Electrified => "Your probe touches the wrong contact. Lightning answers your mistake.",
            TrapType.LaserGrid => "You stumble into the beam. Doors seal. Alarms howl. You're trapped.",
            TrapType.JotunDefense => "The ancient defense senses your fumbling. It punishes such incompetence severely.",
            _ => "The trap triggers on you."
        };
    }
}
```

---

## 10. Salvageable Components

### 10.1 Components by Trap Type

| Trap Type | Salvageable Components |
|-----------|------------------------|
| **Pressure Plate** | [High-Tension Spring], [Pressure Sensor] |
| **Tripwire** | [Trigger Mechanism], [Wire Bundle] |
| **Electrified** | [Capacitor], [Blighted Power Cell] |
| **Laser Grid** | [Sensor Module], [Focusing Crystal] |
| **Jötun Defense** | [Jötun Mechanism Fragment], [Ancient Power Core] |

### 10.2 Component Value and Uses

```csharp
/// <summary>
/// Components salvageable from traps, used in crafting and upgrades.
/// </summary>
public static class TrapComponents
{
    public static readonly Dictionary<string, ComponentInfo> Components = new()
    {
        ["high-tension-spring"] = new("High-Tension Spring", ComponentRarity.Common,
            "Used in crafting mechanical devices and improvised tools."),

        ["pressure-sensor"] = new("Pressure Sensor", ComponentRarity.Uncommon,
            "Sensitive mechanism for detecting weight changes."),

        ["trigger-mechanism"] = new("Trigger Mechanism", ComponentRarity.Common,
            "Basic mechanical trigger, useful for crafting traps."),

        ["wire-bundle"] = new("Wire Bundle", ComponentRarity.Common,
            "Copper wiring, useful for electrical projects."),

        ["capacitor"] = new("Capacitor", ComponentRarity.Uncommon,
            "Stores electrical charge. Essential for powered devices."),

        ["blighted-power-cell"] = new("Blighted Power Cell", ComponentRarity.Rare,
            "Corrupted but functional power source. Handle with care."),

        ["sensor-module"] = new("Sensor Module", ComponentRarity.Rare,
            "Advanced detection component from Old World technology."),

        ["focusing-crystal"] = new("Focusing Crystal", ComponentRarity.Rare,
            "Precision optics for lasers and energy weapons."),

        ["jotun-mechanism-fragment"] = new("Jötun Mechanism Fragment", ComponentRarity.Epic,
            "Incomprehensible Jötun technology. Valuable to the right collector."),

        ["ancient-power-core"] = new("Ancient Power Core", ComponentRarity.Epic,
            "Intact Jötun power source. Radiates faint warmth.")
    };
}

public record ComponentInfo(string DisplayName, ComponentRarity Rarity, string Description);

public enum ComponentRarity
{
    Common,
    Uncommon,
    Rare,
    Epic
}
```

---

## 11. Data Model Changes

### 11.1 Summary of Changes

| Entity/VO | Change Type | Description |
|-----------|-------------|-------------|
| `TrapType` | New Enum | Trap classification (5 types) |
| `DisarmStep` | New Enum | Procedure step (Detection, Analysis, Disarmament) |
| `DisarmStatus` | New Enum | Overall status tracking |
| `TrapDisarmState` | New Entity | State machine for disarmament procedure |
| `TrapContext` | New Value Object | Check context with modifiers |
| `DisarmResult` | New Value Object | Complete result with consequences |
| `TrapAnalysisInfo` | New Value Object | Revealed information from Analysis |

### 11.2 Database Schema (if applicable)

```sql
-- Trap disarmament state tracking
CREATE TABLE TrapDisarmStates (
    DisarmId VARCHAR(36) PRIMARY KEY,
    CharacterId VARCHAR(36) NOT NULL,
    TrapType INT NOT NULL,
    CurrentStep INT NOT NULL,
    AnalysisComplete BIT NOT NULL,
    FailedAttempts INT NOT NULL DEFAULT 0,
    Status INT NOT NULL,
    SalvagedComponentsJson NVARCHAR(MAX),
    RevealedInfoJson NVARCHAR(MAX),
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

---

## 12. Configuration Files

### 12.1 trap-types.json

```json
{
  "trapTypes": {
    "tripwire": {
      "id": "tripwire",
      "displayName": "Tripwire",
      "description": "Simple wire that triggers an alarm when disturbed",
      "detectionDc": 8,
      "disarmDc": 8,
      "effect": {
        "type": "alarm",
        "damage": null,
        "damageType": null,
        "alertsEnemies": true,
        "triggerLockdown": false
      },
      "salvage": ["trigger-mechanism", "wire-bundle"]
    },
    "pressurePlate": {
      "id": "pressurePlate",
      "displayName": "Pressure Plate",
      "description": "Weight-sensitive plate that triggers a crushing mechanism",
      "detectionDc": 10,
      "disarmDc": 12,
      "effect": {
        "type": "damage",
        "damage": "2d10",
        "damageType": "physical",
        "alertsEnemies": false,
        "triggerLockdown": false
      },
      "salvage": ["high-tension-spring", "pressure-sensor"]
    },
    "electrified": {
      "id": "electrified",
      "displayName": "Electrified Grid",
      "description": "Conductive surface that delivers a powerful electric shock",
      "detectionDc": 14,
      "disarmDc": 16,
      "effect": {
        "type": "damage",
        "damage": "3d10",
        "damageType": "lightning",
        "alertsEnemies": false,
        "triggerLockdown": false
      },
      "salvage": ["capacitor", "blighted-power-cell"]
    },
    "laserGrid": {
      "id": "laserGrid",
      "displayName": "Laser Grid",
      "description": "Old World security beams that trigger alarms and lockdowns",
      "detectionDc": 18,
      "disarmDc": 20,
      "effect": {
        "type": "alarm",
        "damage": null,
        "damageType": null,
        "alertsEnemies": true,
        "triggerLockdown": true
      },
      "salvage": ["sensor-module", "focusing-crystal"]
    },
    "jotunDefense": {
      "id": "jotunDefense",
      "displayName": "Jötun Defense",
      "description": "Incomprehensible ancient defense mechanism",
      "detectionDc": 22,
      "disarmDc": 24,
      "effect": {
        "type": "damage",
        "damage": "5d10",
        "damageType": "physical",
        "alertsEnemies": true,
        "triggerLockdown": false
      },
      "salvage": ["jotun-mechanism-fragment", "ancient-power-core"]
    }
  },
  "toolRequirements": {
    "minimumDcForTools": 4,
    "bareHandsPenalty": -2
  },
  "analysisThresholds": {
    "revealDcModifier": -2,
    "revealConsequencesModifier": 0,
    "revealHintModifier": 2,
    "hintBonusDice": 1
  }
}
```

### 12.2 trap-descriptors.json

```json
{
  "detectionDescriptions": {
    "success": {
      "tripwire": "Your trained eye catches the glint of wire stretched across the passage.",
      "pressurePlate": "The floor tile ahead sits slightly higher than its neighbors. A pressure plate.",
      "electrified": "The faint hum of electricity warns you of the charged grid ahead.",
      "laserGrid": "Faint red lines crisscross the corridor—Old World security lasers.",
      "jotunDefense": "Something ancient stirs at the edge of your perception. Jötun defenses."
    },
    "failure": {
      "tripwire": "Your foot catches the wire too late. A shrill alarm pierces the darkness.",
      "pressurePlate": "The floor gives way beneath your foot. Something clicks—then strikes.",
      "electrified": "The grid crackles to life as you step onto it. Lightning arcs through your body.",
      "laserGrid": "The beam flares red as you break it. Doors slam shut. Alarms wail.",
      "jotunDefense": "Ancient mechanisms awaken. Pain and noise erupt in equal measure."
    }
  },
  "disarmDescriptions": {
    "success": {
      "tripwire": "The wire goes slack in your hands. The trap is neutralized.",
      "pressurePlate": "With careful precision, you disable the pressure mechanism. Safe.",
      "electrified": "The crackling fades. The grid is now just harmless metal.",
      "laserGrid": "The beams flicker and die. You've blinded the ancient eye.",
      "jotunDefense": "The Jötun mechanism groans and falls silent. You've outsmarted the ancients."
    },
    "critical": {
      "tripwire": "Not only do you disable the wire, but you recover usable components from the mechanism.",
      "pressurePlate": "With expert precision, you dismantle the trap entirely, salvaging valuable components.",
      "electrified": "You not only disable the grid but carefully extract its power components.",
      "laserGrid": "The system yields to your expertise. You salvage the focusing crystal and sensor module intact.",
      "jotunDefense": "The ancient mechanism surrenders its secrets. You recover fragments of Jötun technology."
    },
    "failure": {
      "default": "The mechanism resists your efforts. You'll need to try a different approach—and it won't be any easier."
    },
    "fumble": {
      "tripwire": "Your tools slip at the worst moment. The alarm screams into the darkness.",
      "pressurePlate": "A wrong move—the mechanism triggers with you on top of it.",
      "electrified": "Your probe touches the wrong contact. Lightning answers your mistake.",
      "laserGrid": "You stumble into the beam. Doors seal. Alarms howl. You're trapped.",
      "jotunDefense": "The ancient defense senses your fumbling. It punishes such incompetence severely."
    }
  },
  "analysisHints": {
    "tripwire": "The wire is attached to a simple bell mechanism. Cutting it near the anchor would silence it.",
    "pressurePlate": "The pressure sensor has a calibration screw. Loosening it would increase the trigger threshold.",
    "electrified": "The power coupling on the left side appears to be the main feed. Disconnecting it first would be wise.",
    "laserGrid": "The emitters cycle every few seconds. Timing your movements to the cycle is the key.",
    "jotunDefense": "The mechanism hums in a pattern—ancient but recognizable. Matching the frequency with your tools might confuse it."
  }
}
```

---

## 13. Logging Specifications

### 13.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Detection Attempt | Information | `Detection attempt: CharacterId={CharacterId}, TrapType={TrapType}, DC={Dc}` |
| Trap Detected | Information | `Trap detected: {TrapType}` |
| Detection Failed | Warning | `Detection failed, trap triggered: TrapType={TrapType}, Damage={Damage}` |
| Analysis Attempt | Information | `Analysis attempt: CharacterId={CharacterId}, TrapType={TrapType}` |
| Analysis Complete | Information | `Analysis complete: DcRevealed={Dc}, ConsequencesRevealed={Consequences}, HintRevealed={Hint}` |
| Disarmament Attempt | Information | `Disarmament attempt: CharacterId={CharacterId}, TrapType={TrapType}, DC={Dc}, Modifier={Mod}` |
| Disarmament Success | Information | `Disarmament success: Critical={IsCritical}, Salvage={SalvageCount}` |
| Disarmament Failed | Information | `Disarmament failed: FailedAttempts={Attempts}, NewDC={NewDc}` |
| Fumble | Warning | `FUMBLE! [Forced Execution]: TrapType={TrapType}, Damage={Damage}` |

### 13.2 Structured Log Properties

```csharp
public static class TrapLogProperties
{
    public const string CharacterId = "CharacterId";
    public const string TrapType = "TrapType";
    public const string Dc = "Dc";
    public const string Damage = "Damage";
    public const string FailedAttempts = "FailedAttempts";
    public const string NewDc = "NewDc";
    public const string IsCritical = "IsCritical";
    public const string SalvageCount = "SalvageCount";
    public const string DcRevealed = "DcRevealed";
    public const string ConsequencesRevealed = "ConsequencesRevealed";
    public const string HintRevealed = "HintRevealed";
}
```

---

## 14. Unit Testing Requirements

### 14.1 Test Summary (~4 tests)

| Test Class | Test Count | Purpose |
|------------|------------|---------|
| `TrapDisarmamentServiceTests` | 4 | Core disarmament mechanics |

### 14.2 Test Specifications

#### TrapDisarmamentServiceTests.cs

```csharp
[TestFixture]
public class TrapDisarmamentServiceTests
{
    private TrapDisarmamentService _service;
    private Mock<ISkillCheckService> _skillCheckServiceMock;
    private Mock<IDiceRollerService> _diceRollerMock;
    private Mock<IDamageService> _damageServiceMock;
    private Mock<ILogger<TrapDisarmamentService>> _loggerMock;

    [SetUp]
    public void SetUp()
    {
        _skillCheckServiceMock = new Mock<ISkillCheckService>();
        _diceRollerMock = new Mock<IDiceRollerService>();
        _damageServiceMock = new Mock<IDamageService>();
        _loggerMock = new Mock<ILogger<TrapDisarmamentService>>();

        _service = new TrapDisarmamentService(
            _loggerMock.Object,
            _skillCheckServiceMock.Object,
            _diceRollerMock.Object,
            _damageServiceMock.Object,
            Options.Create(new TrapConfiguration()));
    }

    /// <summary>
    /// Verifies that trap type correctly determines the disarm DC.
    /// </summary>
    [Test]
    [TestCase(TrapType.Tripwire, 8)]
    [TestCase(TrapType.PressurePlate, 12)]
    [TestCase(TrapType.Electrified, 16)]
    [TestCase(TrapType.LaserGrid, 20)]
    [TestCase(TrapType.JotunDefense, 24)]
    public void TrapType_SetsCorrectDc(TrapType trapType, int expectedDc)
    {
        // Arrange
        var state = TrapDisarmState.Create("player-1", trapType);

        // Assert
        Assert.That(state.CurrentDisarmDc, Is.EqualTo(expectedDc));
    }

    /// <summary>
    /// Verifies that Analysis reveals correct information based on check result.
    /// </summary>
    [Test]
    public void AnalyzeTrap_RevealsCorrectInformation()
    {
        // Arrange
        var character = TestHelpers.CreateTestCharacter();
        var state = TrapDisarmState.Create(character.Id, TrapType.Electrified);
        state.MarkDetected();

        // Set up WITS check to succeed with net 3
        _skillCheckServiceMock
            .Setup(s => s.PerformCheck(
                It.IsAny<Character>(),
                It.IsAny<SkillContext>(),
                It.IsAny<int>()))
            .Returns(new SkillCheckResult(NetSuccesses: 3, IsSuccess: true, IsCritical: false, IsFumble: false));

        // Act
        var analysisInfo = _service.AnalyzeTrap(state, character);

        // Assert
        Assert.That(analysisInfo.DisarmDcRevealed, Is.True);
        Assert.That(analysisInfo.ConsequencesRevealed, Is.True);
        Assert.That(analysisInfo.HintRevealed, Is.True);
        Assert.That(analysisInfo.DisarmDc, Is.EqualTo(16));
    }

    /// <summary>
    /// Verifies that failed disarmament attempts increase the DC by 1.
    /// </summary>
    [Test]
    public void AttemptDisarmament_Failure_IncreasesDc()
    {
        // Arrange
        var character = TestHelpers.CreateTestCharacter();
        var state = TrapDisarmState.Create(character.Id, TrapType.PressurePlate);
        state.MarkDetected();
        state.SkipAnalysis();

        var initialDc = state.CurrentDisarmDc; // Should be 12

        // Set up check to fail
        _skillCheckServiceMock
            .Setup(s => s.PerformCheckWithModifier(
                It.IsAny<Character>(),
                It.IsAny<SkillContext>(),
                It.IsAny<int>(),
                It.IsAny<int>()))
            .Returns(new SkillCheckResult(NetSuccesses: 1, IsSuccess: false, IsCritical: false, IsFumble: false));

        // Act
        var result = _service.AttemptDisarmament(state, character, ToolQuality.Proper);

        // Assert
        Assert.That(result.Success, Is.False);
        Assert.That(state.FailedAttempts, Is.EqualTo(1));
        Assert.That(state.CurrentDisarmDc, Is.EqualTo(initialDc + 1)); // DC increased by 1
    }

    /// <summary>
    /// Verifies that fumble triggers the trap on the disarmer.
    /// </summary>
    [Test]
    public void AttemptDisarmament_Fumble_TriggersTrapOnDisarmer()
    {
        // Arrange
        var character = TestHelpers.CreateTestCharacter();
        var state = TrapDisarmState.Create(character.Id, TrapType.Electrified);
        state.MarkDetected();
        state.SkipAnalysis();

        // Set up check to fumble (0 success + botch)
        _skillCheckServiceMock
            .Setup(s => s.PerformCheckWithModifier(
                It.IsAny<Character>(),
                It.IsAny<SkillContext>(),
                It.IsAny<int>(),
                It.IsAny<int>()))
            .Returns(new SkillCheckResult(NetSuccesses: -1, IsSuccess: false, IsCritical: false, IsFumble: true));

        // Set up damage roll (3d10 for Electrified)
        _diceRollerMock
            .Setup(d => d.Roll(3, 10))
            .Returns(new DiceResult(Total: 18));

        // Act
        var result = _service.AttemptDisarmament(state, character, ToolQuality.Proper);

        // Assert
        Assert.That(result.IsFumble, Is.True);
        Assert.That(result.TrapTriggered, Is.True);
        Assert.That(result.DamageDealt, Is.EqualTo(18));
        Assert.That(result.DamageType, Is.EqualTo(DamageType.Lightning));
        Assert.That(state.Status, Is.EqualTo(DisarmStatus.Destroyed));
    }
}
```

---

## 15. Use Cases

### 15.1 Use Case: Successful Three-Step Disarmament

```
SCENARIO: Player successfully detects, analyzes, and disarms a Pressure Plate

GIVEN:
  - Player enters a room with a hidden Pressure Plate trap (DC 12)
  - Player has [Tinker's Toolkit] (Proper tools, +1d10)

WHEN (Detection):
  - Perception check DC 10
  - Player rolls 3d10: [7, 8, 9] = 2 successes
  - Net 2 >= DC 2 (10/6) → SUCCESS

THEN:
  - Trap detected
  - Player chooses to Analyze

WHEN (Analysis):
  - WITS check against DC 12
  - Player rolls 4d10: [2, 8, 9, 10] = 3 successes
  - DC - 2 (10): Net 3 >= DC 2 → Disarm DC revealed
  - DC (12): Net 3 >= DC 2 → Consequences revealed
  - DC + 2 (14): Net 3 >= DC 2 → Hint revealed (+1d10)

THEN:
  - Player knows: DC 12, 2d10 damage on failure, hint about calibration screw
  - Player proceeds to Disarmament with +1d10 from hint

WHEN (Disarmament):
  - Higher of WITS/FINESSE check DC 12
  - Base pool: 3d10
  - Tool modifier: +1d10 (Proper)
  - Hint modifier: +1d10
  - Final pool: 5d10
  - Player rolls: [3, 8, 9, 9, 10] = 4 successes
  - Net 4 >= DC 2 (12/6) → SUCCESS

THEN:
  - Trap disabled
  - Path is safe
  - Display: "With careful precision, you disable the pressure mechanism. Safe."
```

### 15.2 Use Case: Critical Success with Salvage

```
SCENARIO: Player achieves critical success on Electrified trap

GIVEN:
  - Player has detected an Electrified trap (DC 16)
  - Player has analyzed and received hint (+1d10)
  - Player has Masterwork tools (+2d10)

WHEN (Disarmament):
  - Final pool: 6d10
  - Player rolls: [7, 8, 9, 10, 10, 10] = 5 successes
  - Net 5 >= 5 → CRITICAL SUCCESS

THEN:
  - Trap disabled
  - Salvage: [Capacitor], [Blighted Power Cell]
  - Display: "You not only disable the grid but carefully extract its power components."
```

### 15.3 Use Case: Fumble - Forced Execution

```
SCENARIO: Player fumbles disarmament and triggers trap on self

GIVEN:
  - Player is attempting to disarm a Jötun Defense (DC 24)
  - Player has failed once (DC now 25)

WHEN (Disarmament):
  - Player rolls 4d10: [1, 1, 3, 5] = 0 successes, 2 botches
  - Net -2, 0 successes, has botches → FUMBLE

THEN:
  - [Forced Execution] triggers
  - 5d10 damage rolled: 32 damage to player
  - Security alert triggered
  - Trap destroyed (no salvage)
  - Display: "The ancient defense senses your fumbling. It punishes such incompetence severely."
```

### 15.4 Use Case: Failed Detection

```
SCENARIO: Player fails to detect Laser Grid and triggers it

GIVEN:
  - Player moves through corridor with hidden Laser Grid (Detection DC 18)

WHEN (Passive Detection):
  - Perception check DC 18
  - Player rolls 3d10: [2, 5, 7] = 0 successes
  - Net 0 < DC 3 (18/6) → FAILURE

THEN:
  - Player walks into trap
  - Laser Grid triggers
  - Alarm sounds (nearby enemies alerted)
  - Lockdown triggers (doors seal)
  - Display: "The beam flares red as you break it. Doors slam shut. Alarms wail."
```

---

## 16. Deliverable Checklist

### 16.1 New Files

| File | Purpose | Status |
|------|---------|--------|
| `Enums/TrapType.cs` | Trap classification enum | Pending |
| `Enums/DisarmStep.cs` | Procedure step enum | Pending |
| `Enums/DisarmStatus.cs` | Status tracking enum | Pending |
| `Entities/TrapDisarmState.cs` | State machine entity | Pending |
| `ValueObjects/TrapContext.cs` | Check context | Pending |
| `ValueObjects/DisarmResult.cs` | Result value object | Pending |
| `ValueObjects/TrapAnalysisInfo.cs` | Analysis info | Pending |
| `Interfaces/ITrapDisarmamentService.cs` | Service interface | Pending |
| `Services/TrapDisarmamentService.cs` | Service implementation | Pending |
| `Configuration/trap-types.json` | Trap definitions | Pending |
| `Configuration/trap-descriptors.json` | Narrative text | Pending |
| `Tests/TrapDisarmamentServiceTests.cs` | Unit tests | Pending |

### 16.2 Modified Files

None - this is a new standalone system.

---

## 17. Acceptance Criteria

### 17.1 Trap Classification
- [ ] Trap type correctly sets Detection DC
- [ ] Trap type correctly sets Disarm DC
- [ ] Each trap type has defined effects (damage, alerts, lockdown)

### 17.2 Three-Step Procedure
- [ ] Detection step uses Perception check
- [ ] Failed Detection triggers the trap
- [ ] Analysis step uses WITS check
- [ ] Analysis reveals information based on thresholds
- [ ] Disarmament uses higher of WITS or FINESSE
- [ ] Analysis can be skipped (proceed directly to Disarmament)

### 17.3 DC Escalation
- [ ] Each failed Disarmament attempt increases DC by +1
- [ ] DC escalation persists across attempts
- [ ] Analysis hint grants +1d10 on Disarmament

### 17.4 Outcomes
- [ ] Success disables trap
- [ ] Critical success (net >= 5) yields salvage
- [ ] Failure increases DC for retry
- [ ] Fumble triggers [Forced Execution]

### 17.5 Tool Requirements
- [ ] DC 4+ traps require [Tinker's Toolkit]
- [ ] Bare hands penalty (-2d10) applies for DC 1-3
- [ ] Tool quality modifiers apply correctly

### 17.6 Testing
- [ ] ~4 unit tests pass
- [ ] All tests verify core mechanics from scope breakdown
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## 18. Dependencies

### 18.1 Required from Previous Versions

| Type | Source | Usage |
|------|--------|-------|
| `ToolQuality` | v0.15.4a | Tool quality modifiers |
| `SkillContext` | v0.15.1a | Context for skill checks |
| `SkillCheckResult` | v0.15.1a | Check result structure |
| `FumbleConsequence` | v0.15.1a | [Forced Execution] consequence |
| `DiceRollerService` | v0.15.0 | Dice rolling for damage |
| `DamageService` | Core | Damage application |

### 18.2 Provides to Future Phases

| Type | Usage in Future |
|------|-----------------|
| `TrapType` | Ruin-Stalker specialization (v0.15.4i) for trap re-arming |
| `TrapDisarmState` | Dungeon exploration system |
| `SalvageableComponent` | Crafting system integration |

---

## 19. Future Considerations

### 19.1 Deferred to v0.15.4i (Specialization Integration)

- **Ruin-Stalker [Trap Artist]**: Re-arm disabled traps as party defenses
- **Ruin-Stalker [Sixth Sense]**: Auto-detect traps within 10 feet

### 19.2 Out of Scope

- **Trap Crafting**: Creating new traps from salvaged components (future crafting system)
- **Environmental Traps**: Room-wide hazards vs. point traps (future dungeon system)
- **Party Trap Detection**: Using party's best Perception (future party mechanics)

---

## 20. Document Metadata

| Property | Value |
|----------|-------|
| **Version** | 0.15.4d |
| **Author** | Claude |
| **Created** | 2026-01-17 |
| **Last Updated** | 2026-01-17 |
| **Status** | Draft |
| **Review Status** | Pending |
| **Word Count** | ~5,500 |
| **Estimated Tests** | ~4 |

---

*This design specification provides the detailed blueprint for implementing v0.15.4d Trap Disarmament System. The three-step procedure (Detection → Analysis → Disarmament) creates meaningful player choices and risk management during dungeon exploration.*
