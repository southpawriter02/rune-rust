# v0.16.4b Changelog — Container Loot Table Entity

**Version:** 0.16.4b
**Date:** 2026-01-29
**Phase:** Container Loot Generation

---

## Summary

Implements the Container Loot Table Entity system for tracking container state and contents throughout the loot lifecycle. Provides `ContainerLootState` enum for 5 lifecycle states, `ContainerContents` value object for immutable item/currency tracking, and `ContainerLootTable` entity with state machine for container management.

---

## Added

### Domain Layer

- **`ContainerLootState`** enum — 5 lifecycle states for container loot tracking:
    - `Undiscovered` (0) — Hidden containers requiring perception check
    - `Discovered` (1) — Visible but not yet opened
    - `Locked` (2) — Requires key or lockpicking
    - `Open` (3) — Contents visible, can be looted
    - `Looted` (4) — Already emptied, terminal state

- **`ContainerContents`** value object — Immutable `readonly record struct` for container loot:
    - `ItemIds` — Collection of item identifiers
    - `CurrencyAmount` — Gold amount (non-negative)
    - `AppliedTier` — Quality tier 0-4
    - Static `Empty` property for looted containers
    - Factory methods: `Create()`, `CurrencyOnly()`, `ItemsOnly()`
    - Computed properties: `HasItems`, `HasCurrency`, `HasContents`, `ItemCount`

- **`ContainerLootTable`** entity — State machine for container lifecycle:
    - Properties: `Id`, `Type`, `State`, `Contents`, `RoomId`, `LootedAt`
    - Factory methods: `Create()`, `CreateHidden()`, `CreateLocked()`
    - State transitions: `Discover()`, `Unlock()`, `Open()`, `Loot()`
    - Content management: `SetContents()`, `GetDisplayContents()`
    - Computed: `IsLooted`, `CanLoot`, `NeedsDiscovery`, `IsLocked`, `HasGeneratedContents`

### Unit Tests

- **`ContainerContentsTests.cs`** — 21 tests covering:
    - Factory method validation (valid parameters, null/negative checks, tier bounds)
    - Static `Empty` property behavior
    - Computed properties (`HasItems`, `HasCurrency`, `HasContents`)
    - Convenience factories (`CurrencyOnly`, `ItemsOnly`)
    - `ToString()` formatting
    - Boundary value tests (tier 0-4)

- **`ContainerLootTableTests.cs`** — 15 tests covering:
    - Factory methods (`Create`, `CreateHidden`, `CreateLocked`)
    - State transitions (`Discover`, `Unlock`, `Open`)
    - `SetContents` validation
    - `Loot` behavior (happy path, already looted, not open, no contents)
    - `GetDisplayContents` behavior
    - Full workflow integrations (hidden container, locked container)

---

## Design Decisions

| Decision                                         | Rationale                                                                                                                      |
| ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| Named `ContainerLootState`                       | Avoids conflict with existing `ContainerState` in ExaminationEnums.cs which tracks physical conditions (Intact, Damaged, etc.) |
| `readonly record struct` for `ContainerContents` | Immutability, value equality, and memory efficiency                                                                            |
| Nullable `Contents` property                     | Supports lazy content generation—null until loot service populates                                                             |
| `LootedAt` timestamp                             | Enables persistence and analytics for container looting patterns                                                               |

---

## Dependencies

| Dependency | Description                                        | Status      |
| ---------- | -------------------------------------------------- | ----------- |
| v0.16.4a   | `ContainerType` enum                               | ✅ Complete |
| v0.16.0    | `QualityTier` enum (referenced in tier validation) | ✅ Complete |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 36/36 passed
- **Test Coverage:** Factory methods, state transitions, loot operations, edge cases
