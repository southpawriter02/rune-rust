# v0.10.4c Changelog: Monster Groups with Coordinated Tactics

**Version:** 0.10.4c
**Phase:** Monster Groups with Coordinated Tactics
**Date:** 2026-01-19
**Status:** ✅ Complete

---

## Summary

Implements coordinated monster group behaviors with tactical AI patterns. Groups define compositions with roles (leader, melee, ranged, caster, striker), tactical behaviors (Flank, FocusFire, ProtectLeader, Swarm, Retreat, Ambush, HitAndRun), and synergy effects that provide bonuses triggered by group conditions.

---

## New Components

### Domain Layer - Enums

| Enum | Location | Description |
|------|----------|-------------|
| `GroupTactic` | `Domain/Enums/GroupTactic.cs` | 8 tactical behaviors for coordinated group movement |
| `SynergyTrigger` | `Domain/Enums/SynergyTrigger.cs` | 5 trigger conditions for synergy effects |

### Domain Layer - Value Objects

| Struct | Location | Description |
|--------|----------|-------------|
| `GridOffset` | `Domain/ValueObjects/GridOffset.cs` | Relative position offset for spawn positioning |

### Domain Layer - Definitions

| Class | Location | Description |
|-------|----------|-------------|
| `GroupMember` | `Domain/Definitions/GroupMember.cs` | Member slot definition with monster ID, count, role, and position |
| `GroupSynergy` | `Domain/Definitions/GroupSynergy.cs` | Synergy effect definition with trigger, bonuses, and targets |
| `MonsterGroupDefinition` | `Domain/Definitions/MonsterGroupDefinition.cs` | Complete group definition with members, tactics, and synergies |

### Application Layer - Tracking

| Class | Location | Description |
|-------|----------|-------------|
| `MonsterGroupInstance` | `Application/Tracking/MonsterGroupInstance.cs` | Runtime state for active monster groups with external role tracking |
| `GroupMoveDecision` | `Application/Tracking/GroupMoveDecision.cs` | Tactical movement decision with position and tactic info |
| `GroupMoveDecisionType` | `Application/Tracking/GroupMoveDecision.cs` | Decision type enum (NoGroup, NoTarget, NoAction, MoveTo, HoldPosition) |

### Application Layer - Interfaces

| Interface | Location | Description |
|-----------|----------|-------------|
| `IMonsterGroupProvider` | `Application/Interfaces/IMonsterGroupProvider.cs` | Provider for group definitions from configuration |
| `IMonsterGroupService` | `Application/Interfaces/IMonsterGroupService.cs` | Service for coordinated group behaviors (15 methods) |

### Application Layer - Services

| Service | Location | Description |
|---------|----------|-------------|
| `MonsterGroupService` | `Application/Services/MonsterGroupService.cs` | Full implementation of group tactics and synergy management |

### Infrastructure Layer - Providers

| Provider | Location | Description |
|----------|----------|-------------|
| `JsonMonsterGroupProvider` | `Infrastructure/Providers/JsonMonsterGroupProvider.cs` | JSON-based group definition provider |

### Configuration Files

| File | Location | Description |
|------|----------|-------------|
| `monster-groups.schema.json` | `config/schemas/monster-groups.schema.json` | JSON Schema for group configuration validation |
| `monster-groups.json` | `config/monster-groups.json` | Sample group definitions (5 groups) |

---

## Key Features

### Group Tactics (8 behaviors)

| Tactic | Description |
|--------|-------------|
| `Flank` | Position on opposite sides of target for flanking bonuses |
| `FocusFire` | All members attack the same target (lowest HP) |
| `ProtectLeader` | Non-leaders position between leader and threats |
| `ProtectCaster` | Melee members protect caster-role members |
| `Swarm` | Cluster around target from all adjacent positions |
| `Retreat` | Fall back when health below 30% threshold |
| `Ambush` | Hold position until target enters trigger range (3 cells) |
| `HitAndRun` | Attack then disengage to safer position |

### Synergy Triggers (5 conditions)

| Trigger | Description |
|---------|-------------|
| `Always` | Applied when group is registered |
| `OnAllyHit` | Triggered when a group member hits a target |
| `OnAllyDamaged` | Triggered when a group member takes damage |
| `PerAdjacentAlly` | Bonus stacks per adjacent allied group member |
| `OnLeaderCommand` | Triggered by leader-specific actions |

### Member Roles

| Role | Description |
|------|-------------|
| `leader` | Group coordinator, protected by ProtectLeader tactic |
| `melee` | Front-line fighters, prefer close combat |
| `ranged` | Back-line attackers, prefer distance |
| `caster` | Spellcasters, protected by ProtectCaster tactic |
| `striker` | High-damage specialists, use hit-and-run |

---

## Files Created

### Domain Layer

- `src/Core/RuneAndRust.Domain/Enums/GroupTactic.cs`
- `src/Core/RuneAndRust.Domain/Enums/SynergyTrigger.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/GridOffset.cs`
- `src/Core/RuneAndRust.Domain/Definitions/GroupMember.cs`
- `src/Core/RuneAndRust.Domain/Definitions/GroupSynergy.cs`
- `src/Core/RuneAndRust.Domain/Definitions/MonsterGroupDefinition.cs`

### Application Layer

- `src/Core/RuneAndRust.Application/Tracking/MonsterGroupInstance.cs`
- `src/Core/RuneAndRust.Application/Tracking/GroupMoveDecision.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IMonsterGroupProvider.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IMonsterGroupService.cs`
- `src/Core/RuneAndRust.Application/Services/MonsterGroupService.cs`

### Infrastructure Layer

- `src/Infrastructure/RuneAndRust.Infrastructure/Providers/JsonMonsterGroupProvider.cs`

### Configuration

- `config/schemas/monster-groups.schema.json`
- `config/monster-groups.json`

### Tests

- `tests/RuneAndRust.Application.UnitTests/Services/MonsterGroupServiceTests.cs` (11 tests)

### Documentation

- `docs/changelogs/v0.10.4c-changelog.md`

---

## API Examples

### Registering a Monster Group

```csharp
// Pre-spawn monsters from definition
var monsters = new[] { shaman, warrior1, warrior2, warrior3 };

// Register the group (roles assigned automatically from definition)
var instance = groupService.RegisterGroup("goblin-warband", monsters);

Console.WriteLine($"Group registered: {instance.GroupId}");
Console.WriteLine($"Members: {instance.TotalCount}, Alive: {instance.AliveCount}");
```

### Getting Tactical Movement

```csharp
// Get tactical move decision for a group member
var decision = groupService.DetermineMove(warrior);

if (decision.ShouldMove)
{
    Console.WriteLine($"Move to {decision.TargetPosition} ({decision.Tactic} tactic)");
    MoveMonster(warrior, decision.TargetPosition!.Value);
}
else if (decision.Type == GroupMoveDecisionType.HoldPosition)
{
    Console.WriteLine("Holding position for ambush");
}
```

### Coordinated Target Selection

```csharp
// Get coordinated target for FocusFire tactic
var target = groupService.DetermineTarget(warrior, possibleTargets);

if (target != null)
{
    Console.WriteLine($"Focus fire on {target.Name} (HP: {target.Health})");
    AttackTarget(warrior, target);
}
```

### Handling Synergy Triggers

```csharp
// When a group member hits a target
groupService.OnGroupMemberHit(attacker, target);

// When a group member takes damage
groupService.OnGroupMemberDamaged(targetMonster, damageAmount);

// Get per-adjacent-ally bonus
var attackBonus = groupService.GetAdjacentAllyBonus(monster, "attack");
var damageBonus = groupService.GetAdjacentAllyBonus(monster, "damage");
```

### Handling Member Death

```csharp
// When a group member dies
groupService.OnGroupMemberDeath(deadMonster);

// Check if group is still active
var groups = groupService.GetActiveGroups();
Console.WriteLine($"Active groups: {groups.Count}");
```

### Querying Group State

```csharp
// Check if monster is in a group
if (groupService.IsInGroup(monster))
{
    var group = groupService.GetGroupForMonster(monster);
    Console.WriteLine($"Part of {group.Definition.Name}");
    Console.WriteLine($"Has leader: {group.HasAliveLeader}");
}

// Get flanking positions for a target
var positions = groupService.GetFlankingPositions(target, groupSize: 4);
```

---

## Design Adaptations

The implementation adapted the design specification to match existing codebase patterns:

| Design Spec | Actual Implementation |
|-------------|----------------------|
| `IEventBus.Publish(event)` | `IGameEventLogger.LogCombat(eventType, message, correlationId, data)` |
| `IMonsterSpawnService.Spawn()` | `RegisterGroup(groupId, preSpawnedMonsters)` - accept pre-spawned monsters |
| `ICombatGrid` | `ICombatGridService` |
| `Monster.SetGroupRole(role)` | Track roles externally in `MonsterGroupInstance._memberRoles` |
| `Monster.GroupRole` | `MonsterGroupInstance.GetMemberRole(monster)` |

---

## Dependencies

| Dependency | Purpose |
|------------|---------|
| `IMonsterGroupProvider` | Lookup group definitions from configuration |
| `ICombatGridService` | Grid access for position calculations |
| `IFlankingService` | Calculate flanking positions for Flank tactic |
| `IBuffDebuffService` | Apply synergy status effects |
| `IGameEventLogger` | Combat event logging |
| `Monster` | Entity for group member instances |
| `Combatant` | Base class for target selection |
| `GridPosition` | Position calculations |

---

## Service Dependencies

```csharp
public MonsterGroupService(
    IMonsterGroupProvider groupProvider,      // Group definition lookup
    ICombatGridService gridService,           // Grid operations
    IFlankingService flankingService,         // Flanking calculations
    IBuffDebuffService buffDebuffService,     // Synergy effects
    IGameEventLogger eventLogger,             // Combat event logging
    ILogger<MonsterGroupService> logger)      // Diagnostic logging
```

---

## Event Details

### MonsterGroupRegistered

| Property | Type | Description |
|----------|------|-------------|
| `GroupId` | `string` | Group definition ID |
| `GroupName` | `string` | Group display name |
| `MemberCount` | `int` | Number of members registered |
| `Tactics` | `List<string>` | Tactics used by the group |

### GroupFocusTarget

| Property | Type | Description |
|----------|------|-------------|
| `GroupId` | `string` | Group definition ID |
| `TargetId` | `Guid` | Selected target entity ID |
| `TargetName` | `string` | Selected target display name |

### GroupMemberDeath

| Property | Type | Description |
|----------|------|-------------|
| `GroupId` | `string` | Group definition ID |
| `MonsterId` | `Guid` | Dead monster entity ID |
| `MonsterName` | `string` | Dead monster display name |
| `AliveCount` | `int` | Remaining alive members |

### GroupDefeated

| Property | Type | Description |
|----------|------|-------------|
| `GroupId` | `string` | Group definition ID |
| `GroupName` | `string` | Group display name |

---

## Test Coverage

| Test | Description |
|------|-------------|
| `RegisterGroup_WithValidGroupId_ReturnsGroupInstanceAndTracksMembers` | Verifies group registration and member tracking |
| `RegisterGroup_WithInvalidGroupId_ThrowsArgumentException` | Verifies error handling for invalid group ID |
| `DetermineMove_WithFlankTactic_ReturnsFlankingPosition` | Verifies Flank tactic position calculation |
| `DetermineMove_WithNoGroup_ReturnsNoGroupDecision` | Verifies NoGroup decision for untracked monsters |
| `DetermineMove_WithNoTarget_ReturnsNoTargetDecision` | Verifies NoAction when no target set |
| `DetermineTarget_WithFocusFireTactic_SelectsLowestHPTarget` | Verifies lowest HP target selection |
| `DetermineTarget_WithFocusFire_UsesExistingTargetIfValid` | Verifies existing target persistence |
| `ApplySynergies_WithAlwaysSynergy_AppliesBonusToMembers` | Verifies Always synergy application |
| `OnGroupMemberHit_WithOnAllyHitSynergy_AppliesTemporaryBonus` | Verifies OnAllyHit trigger |
| `OnGroupMemberDeath_RemovesMemberFromTracking` | Verifies member removal on death |
| `OnGroupMemberDeath_WhenLastMember_RemovesGroupInstance` | Verifies group removal when empty |

---

## Sample Group Definitions

### Goblin Warband

- **Composition:** 1 shaman (leader), 3 warriors (melee)
- **Tactics:** Flank, FocusFire, ProtectLeader
- **Synergies:** Pack Tactics (per-adjacent-ally attack bonus), Shaman's Blessing (always status effect)

### Skeleton Patrol

- **Composition:** 2 warriors (melee), 2 archers (ranged)
- **Tactics:** FocusFire, ProtectCaster
- **Synergies:** Undead Resilience (on-ally-damaged damage bonus)

### Bandit Ambush Party

- **Composition:** 1 captain (leader), 2 rogues (striker), 1 archer (ranged)
- **Tactics:** Ambush, HitAndRun
- **Synergies:** Ambush Strike (always damage bonus), Coordinated Retreat (on-ally-hit haste)

### Orc Raiding Party

- **Composition:** 1 chieftain (leader), 2 berserkers (melee), 3 warriors (melee)
- **Tactics:** Swarm, FocusFire
- **Synergies:** Bloodlust (on-ally-damaged bonuses), Warlord's Command (leader command buff)

### Cultist Ritual Circle

- **Composition:** 1 high priest (leader), 2 mages (caster), 2 acolytes (melee)
- **Tactics:** ProtectLeader, ProtectCaster, Retreat
- **Synergies:** Dark Ritual (always caster damage bonus), Sacrificial Link (on-ally-hit ward)

---

## v0.10.4 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.10.4a | Boss Definitions | ✅ Complete |
| v0.10.4b | Boss Mechanics Service | ✅ Complete |
| v0.10.4c | Monster Groups with Coordinated Tactics | ✅ Complete |

---

## Notes

### External Role Tracking

Since the `Monster` entity does not have a `GroupRole` property, roles are tracked externally in `MonsterGroupInstance._memberRoles`. This allows role assignment without modifying the domain entity.

### Pre-Spawned Monsters

The service uses `RegisterGroup(groupId, monsters)` instead of spawning monsters directly. This allows integration with existing spawn systems and provides flexibility in monster creation.

### Synergy Effects

Status effect application depends on monsters implementing `IEffectTarget`. Attack and damage bonuses are tracked by synergy definitions and can be queried via `GetAdjacentAllyBonus()`.

### Future Enhancements

- Integration with AI decision-making for automatic tactic selection
- Visual indicators for group membership and coordination
- Group formation patterns for spawn positioning
- Inter-group synergies for multiple coordinating groups
