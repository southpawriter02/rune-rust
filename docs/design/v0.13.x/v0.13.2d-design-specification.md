# v0.13.2d Design Specification: Tooltips & Interaction

**Version:** 0.13.2d
**Parent:** v0.13.2 (Ability Tree UI)
**Prerequisites:** v0.13.2a Complete (Tree Visualization), v0.13.2b Complete (Node Display & States)
**Status:** Design Complete
**Estimated Unit Tests:** ~4

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Node Tooltip Component](#4-node-tooltip-component)
   - 4.1 [NodeTooltip Class](#41-nodetooltip-class)
   - 4.2 [Tooltip Display Logic](#42-tooltip-display-logic)
   - 4.3 [Unlock Prompt Display](#43-unlock-prompt-display)
5. [Talent Point Display Component](#5-talent-point-display-component)
   - 5.1 [TalentPointDisplay Class](#51-talentpointdisplay-class)
   - 5.2 [Point Animation](#52-point-animation)
6. [Tooltip Renderer](#6-tooltip-renderer)
   - 6.1 [TooltipRenderer Class](#61-tooltiprenderer-class)
   - 6.2 [Content Formatting](#62-content-formatting)
   - 6.3 [Tooltip Positioning](#63-tooltip-positioning)
7. [Ability Tree Command](#7-ability-tree-command)
   - 7.1 [AbilityTreeCommand Class](#71-abilitytreecommand-class)
   - 7.2 [Node Selection Handling](#72-node-selection-handling)
   - 7.3 [Unlock Confirmation Flow](#73-unlock-confirmation-flow)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [AbilityTreeView Integration](#10-abilitytreeview-integration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

This version implements node tooltips, the unlock action, and talent point display for the ability tree UI. Tooltips show ability details on node selection (triggered by Enter key), including requirements display with satisfaction status. The unlock action allows players to spend talent points on available nodes with a confirmation prompt. The talent point display shows available and spent points in a clear format.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `NodeTooltip`, `TalentPointDisplay` |
| **Renderers** | `TooltipRenderer` |
| **Commands** | `AbilityTreeCommand` |
| **DTOs** | `TooltipDisplayDto`, `TooltipSectionDto`, `TooltipLineDto`, `TalentPointDisplayDto` |
| **View Updates** | `AbilityTreeView` integration |
| **Configuration** | `node-tooltip.json` |
| **Tests** | ~4 unit tests |

### Architectural Significance

This version establishes the **Tooltip & Interaction Pattern** for ability tree UI:
- Tooltips are triggered by selection (Enter key) due to TUI limitations (no hover)
- Tooltip content is structured with sections for ability details, requirements, and status
- Unlock action uses `[U]` key with `[Y]/[N]` confirmation to prevent accidental unlocks
- Talent point display follows the format `# Available | # Spent`
- The pattern coordinates with node state information from v0.13.2b

---

## 2. Feature Overview

```
v0.13.2d Features
├── NodeTooltip (UI Component)
│   ├── ShowTooltip(AbilityNode, NodeState)
│   ├── HideTooltip()
│   ├── ShowRequirements(IEnumerable<NodePrerequisite>)
│   └── ShowUnlockPrompt(AbilityNode)
│
├── TalentPointDisplay (UI Component)
│   ├── RenderPoints(int available, int spent)
│   ├── UpdateAvailable(int newAvailable)
│   └── AnimatePointSpend()
│
├── TooltipRenderer (Renderer)
│   ├── FormatAbilityDetails(AbilityNode)
│   ├── FormatRequirements(IEnumerable<NodePrerequisite>, PlayerAbilityProgress)
│   ├── FormatCost(int pointCost)
│   └── GetTooltipWidth()
│
├── AbilityTreeCommand (Command)
│   ├── HandleNodeSelection(string nodeId)
│   ├── HandleUnlockAction()
│   └── HandleConfirmation(bool confirmed)
│
├── Tooltip Display
│   ├── Ability Name and Tier
│   ├── Point Cost Display
│   ├── Ability Description
│   ├── Cooldown and Resource Cost
│   ├── Prerequisites with Satisfaction
│   └── Status and Action Prompt
│
├── Unlock Confirmation
│   ├── [U] Key Trigger
│   ├── Confirmation Message with Cost
│   └── [Y]/[N] Response Handling
│
└── AbilityTreeView Integration
    ├── Tooltip Layer Rendering
    ├── Selection Event Handling
    └── Command Coordination
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Node tooltips with ability details | v0.13.2-scope-breakdown.md | Yes |
| Requirements display in tooltip | v0.13.2-scope-breakdown.md | Yes |
| Unlock action for available nodes | v0.13.2-scope-breakdown.md | Yes |
| Talent point counter (available/spent) | v0.13.2-scope-breakdown.md | Yes |
| Node selection handling | v0.13.2-scope-breakdown.md | Yes |
| Tree layout | v0.13.2-scope-breakdown.md | No (v0.13.2a) |
| Node state rendering | v0.13.2-scope-breakdown.md | No (v0.13.2b) |
| Prerequisite lines | v0.13.2-scope-breakdown.md | No (v0.13.2c) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    AbilityTreeView      │      │     NodeTooltip         │               │
│  │    (v0.13.2a)           │◄────▶│     (NEW)               │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderTree()          │      │ - ShowTooltip()         │               │
│  │ - RenderTiers()         │      │ - HideTooltip()         │               │
│  │ - RenderNodesWithState()│      │ - ShowRequirements()    │               │
│  │ - HandleKeyInput()      │      │ - ShowUnlockPrompt()    │               │
│  └─────────────────────────┘      └───────────┬─────────────┘               │
│              │                                 │                             │
│              │                                 │                             │
│  ┌─────────────────────────┐      ┌───────────┴─────────────┐               │
│  │   TalentPointDisplay    │      │    TooltipRenderer      │               │
│  │   (NEW)                 │      │    (NEW)                │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderPoints()        │      │ - FormatAbilityDetails()│               │
│  │ - UpdateAvailable()     │      │ - FormatRequirements()  │               │
│  │ - AnimatePointSpend()   │      │ - FormatCost()          │               │
│  └─────────────────────────┘      │ - GetTooltipWidth()     │               │
│                                    └─────────────────────────┘               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                     AbilityTreeCommand (NEW)                             │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │ - HandleNodeSelection()     - HandleUnlockAction()                      │ │
│  │ - HandleConfirmation()      - ProcessKeyInput()                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IAbilityTreeProvider (existing v0.10.2a)         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetTreeForClass(classId) : AbilityTreeDefinition?                 │    │
│  │ + FindNode(nodeId) : AbilityTreeNode?                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ITalentPointService (existing v0.10.2b)          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetUnspentPoints(player) : int                                    │    │
│  │ + GetTotalPointsSpent(player) : int                                 │    │
│  │ + SpendPoints(player, nodeId, points) : TalentSpendResult           │    │
│  │ + GetNodeRank(player, nodeId) : int                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IPrerequisiteValidator (existing v0.10.2c)       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + CanUnlock(player, nodeId) : PrerequisiteResult                    │    │
│  │ + GetPrerequisitesForNode(nodeId) : IReadOnlyList<NodePrerequisite> │    │
│  │ + ArePrerequisitesMet(player, nodeId) : bool                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    AbilityTreeNode      │      │  PlayerAbilityProgress  │               │
│  │   (existing v0.10.2a)   │      │   (existing v0.10.2a)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + NodeId: string        │      │ + PlayerId: Guid        │               │
│  │ + Name: string          │      │ + UnlockedNodeIds: set  │               │
│  │ + Description: string   │      │ + NodeRanks: dict       │               │
│  │ + Tier: int             │      │ + TotalPointsSpent: int │               │
│  │ + PointCost: int        │      │ + HasUnlocked(nodeId)   │               │
│  │ + MaxRank: int          │      │ + GetRank(nodeId): int  │               │
│  │ + Cooldown: int?        │      └─────────────────────────┘               │
│  │ + ResourceCost: int?    │                                                 │
│  │ + ResourceType: string? │      ┌─────────────────────────┐               │
│  │ + PrerequisiteNodeIds   │      │    NodePrerequisite     │               │
│  └─────────────────────────┘      │   (existing v0.10.2a)   │               │
│                                    ├─────────────────────────┤               │
│                                    │ + RequiredNodeId: string│               │
│                                    │ + RequiredRank: int     │               │
│                                    │ + RequiredTier: int     │               │
│                                    └─────────────────────────┘               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Tooltip Display Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TOOLTIP DISPLAY FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    User Presses Enter on Selected Node
           │
           ▼
┌─────────────────────────┐
│  AbilityTreeCommand     │
│  HandleNodeSelection()  │
└───────────┬─────────────┘
            │
            │ 1. Get node and state information
            ▼
┌─────────────────────────────────────────────────────────────┐
│  Gather Tooltip Data                                         │
│                                                              │
│  node = _abilityTreeProvider.FindNode(nodeId)                │
│  progress = _talentPointService.GetProgressForPlayer(...)    │
│  state = _nodeRenderer.GetNodeState(node, progress, points)  │
│  prerequisites = _prereqValidator.GetPrerequisitesForNode()  │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 2. Create tooltip display DTO
            ▼
┌─────────────────────────────────────────────────────────────┐
│  TooltipRenderer.FormatAbilityDetails(node)                  │
│                                                              │
│  Creates TooltipDisplayDto with:                             │
│  - Title: node.Name                                          │
│  - Subtitle: "Tier {tier} | Cost: {cost} points"            │
│  - Description: node.Description                             │
│  - Sections: Cooldown, Resource, Prerequisites               │
│  - Footer: Status message based on state                     │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 3. Calculate tooltip position
            ▼
┌─────────────────────────────────────────────────────────────┐
│  TooltipRenderer.GetTooltipPosition()                        │
│                                                              │
│  Position tooltip adjacent to selected node                  │
│  Adjust if near screen edge                                  │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 4. Show tooltip
            ▼
┌─────────────────────────────────────────────────────────────┐
│  NodeTooltip.ShowTooltip(tooltipDto, position)               │
│                                                              │
│  Render tooltip box with content                             │
│  Set IsVisible = true                                        │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 Unlock Confirmation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    UNLOCK CONFIRMATION FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    User Presses [U] on Available Node
           │
           ▼
┌─────────────────────────┐
│  AbilityTreeCommand     │
│  HandleUnlockAction()   │
└───────────┬─────────────┘
            │
            │ Check node state
            ▼
┌─────────────────────────┐
│  Is state Available?    │
└───────────┬─────────────┘
            │
            ├─── No ──────► Display "Cannot unlock" message
            │               (Locked or Already Unlocked)
            │
            │ Yes
            ▼
┌─────────────────────────────────────────────────────────────┐
│  NodeTooltip.ShowUnlockPrompt(node)                          │
│                                                              │
│  Display:                                                    │
│  "Unlock {NodeName} for {PointCost} talent points?"         │
│  "[Y] Yes   [N] No"                                         │
│                                                              │
│  Set AwaitingConfirmation = true                             │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ User presses [Y] or [N]
            ▼
┌─────────────────────────┐
│  HandleConfirmation()   │
└───────────┬─────────────┘
            │
            ├─── [N] ──────► Hide prompt, return to tree
            │
            │ [Y]
            ▼
┌─────────────────────────────────────────────────────────────┐
│  ITalentPointService.SpendPoints(player, nodeId, cost)       │
│                                                              │
│  If successful:                                              │
│  - Update node state to Unlocked                             │
│  - Update talent point display                               │
│  - Animate point spend                                       │
│  - Refresh prerequisite lines                                │
│  - Show success message                                      │
└───────────┬─────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────┐
│  TalentPointDisplay.AnimatePointSpend()                      │
│  AbilityTreeView.RefreshNodeStates()                         │
│  AbilityTreeView.RefreshConnections()                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. Node Tooltip Component

### 4.1 NodeTooltip Class

**Purpose:** Displays ability details in a tooltip overlay when a node is selected.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/NodeTooltip.cs`

```csharp
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Presentation.Tui.Renderers;
using RuneAndRust.Presentation.Tui.Services;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Displays ability node information in a tooltip overlay.
/// </summary>
/// <remarks>
/// Tooltips are triggered by selection (Enter key) since TUI does not support
/// hover events. The tooltip shows ability details, requirements, and status
/// with contextual information based on the node's current state.
/// </remarks>
public class NodeTooltip
{
    private readonly TooltipRenderer _tooltipRenderer;
    private readonly ITerminalService _terminalService;
    private readonly NodeTooltipConfig _config;
    private readonly ILogger<NodeTooltip> _logger;

    private TooltipDisplayDto? _currentTooltip;
    private TooltipPosition _currentPosition;
    private List<string> _renderedLines = new();

    /// <summary>
    /// Gets whether the tooltip is currently visible.
    /// </summary>
    public bool IsVisible { get; private set; }

    /// <summary>
    /// Gets whether the tooltip is awaiting unlock confirmation.
    /// </summary>
    public bool AwaitingConfirmation { get; private set; }

    /// <summary>
    /// Creates a new instance of the NodeTooltip component.
    /// </summary>
    /// <param name="tooltipRenderer">The renderer for tooltip formatting.</param>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for tooltip display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public NodeTooltip(
        TooltipRenderer tooltipRenderer,
        ITerminalService terminalService,
        NodeTooltipConfig config,
        ILogger<NodeTooltip> logger)
    {
        _tooltipRenderer = tooltipRenderer ?? throw new ArgumentNullException(nameof(tooltipRenderer));
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Shows the tooltip for a node.
    /// </summary>
    /// <param name="node">The ability node to display.</param>
    /// <param name="state">The current state of the node.</param>
    /// <param name="nodeBounds">The screen bounds of the selected node.</param>
    public void ShowTooltip(
        AbilityTreeNode node,
        NodeState state,
        NodeBounds nodeBounds)
    {
        // Hide any existing tooltip first
        if (IsVisible)
        {
            HideTooltip();
        }

        // Create tooltip content
        _currentTooltip = _tooltipRenderer.FormatAbilityDetails(node, state);

        // Calculate position adjacent to node
        _currentPosition = _tooltipRenderer.GetTooltipPosition(
            nodeBounds,
            _config.TooltipWidth,
            _config.MaxTooltipHeight);

        // Render the tooltip
        RenderTooltip();

        IsVisible = true;
        AwaitingConfirmation = false;

        _logger.LogDebug(
            "Showed tooltip for node {NodeId} at ({X}, {Y})",
            node.NodeId,
            _currentPosition.X,
            _currentPosition.Y);
    }

    /// <summary>
    /// Hides the currently displayed tooltip.
    /// </summary>
    public void HideTooltip()
    {
        if (!IsVisible)
        {
            return;
        }

        // Clear rendered lines
        ClearTooltip();

        _currentTooltip = null;
        IsVisible = false;
        AwaitingConfirmation = false;

        _logger.LogDebug("Hid tooltip");
    }

    /// <summary>
    /// Shows the requirements section in the tooltip.
    /// </summary>
    /// <param name="prerequisites">The node prerequisites.</param>
    /// <param name="progress">The player's progress for satisfaction checking.</param>
    public void ShowRequirements(
        IReadOnlyList<NodePrerequisite> prerequisites,
        PlayerAbilityProgress progress)
    {
        if (_currentTooltip == null || !IsVisible)
        {
            return;
        }

        // Add requirements section to tooltip
        var requirementsSection = _tooltipRenderer.FormatRequirements(prerequisites, progress);

        // Re-render with updated content
        ClearTooltip();
        RenderTooltip();

        _logger.LogDebug("Updated tooltip with {Count} requirements", prerequisites.Count);
    }

    /// <summary>
    /// Shows the unlock confirmation prompt.
    /// </summary>
    /// <param name="node">The node to unlock.</param>
    public void ShowUnlockPrompt(AbilityTreeNode node)
    {
        if (!IsVisible)
        {
            return;
        }

        AwaitingConfirmation = true;

        // Render confirmation prompt below tooltip
        var promptY = _currentPosition.Y + _renderedLines.Count + 1;
        var promptLine = $"Unlock {node.Name} for {node.PointCost} talent points?";
        var confirmLine = "[Y] Yes   [N] No";

        _terminalService.WriteAt(
            _currentPosition.X,
            promptY,
            promptLine);
        _terminalService.WriteColoredAt(
            _currentPosition.X,
            promptY + 1,
            confirmLine,
            _config.PromptColor);

        _logger.LogDebug(
            "Showed unlock prompt for node {NodeId} (cost: {Cost})",
            node.NodeId,
            node.PointCost);
    }

    #region Private Methods

    private void RenderTooltip()
    {
        if (_currentTooltip == null)
        {
            return;
        }

        _renderedLines = _tooltipRenderer.BuildTooltipLines(
            _currentTooltip,
            _config.TooltipWidth);

        // Draw tooltip border and content
        var tooltipWidth = _config.TooltipWidth;
        var topBorder = $"┌{new string('─', tooltipWidth - 2)}┐";
        var bottomBorder = $"└{new string('─', tooltipWidth - 2)}┘";

        _terminalService.WriteColoredAt(
            _currentPosition.X,
            _currentPosition.Y,
            topBorder,
            _config.BorderColor);

        for (var i = 0; i < _renderedLines.Count; i++)
        {
            var line = _renderedLines[i];
            var paddedLine = line.PadRight(tooltipWidth - 2);
            _terminalService.WriteColoredAt(
                _currentPosition.X,
                _currentPosition.Y + 1 + i,
                $"│{paddedLine}│",
                _config.BorderColor);
        }

        _terminalService.WriteColoredAt(
            _currentPosition.X,
            _currentPosition.Y + 1 + _renderedLines.Count,
            bottomBorder,
            _config.BorderColor);
    }

    private void ClearTooltip()
    {
        if (_renderedLines.Count == 0)
        {
            return;
        }

        var blankLine = new string(' ', _config.TooltipWidth);
        var totalHeight = _renderedLines.Count + 2; // +2 for borders

        // Clear tooltip area
        for (var i = 0; i < totalHeight; i++)
        {
            _terminalService.WriteAt(
                _currentPosition.X,
                _currentPosition.Y + i,
                blankLine);
        }

        // Clear confirmation prompt if shown
        if (AwaitingConfirmation)
        {
            var promptY = _currentPosition.Y + totalHeight;
            _terminalService.WriteAt(_currentPosition.X, promptY, blankLine);
            _terminalService.WriteAt(_currentPosition.X, promptY + 1, blankLine);
        }

        _renderedLines.Clear();
    }

    #endregion
}
```

### 4.2 Tooltip Display Logic

**Purpose:** Determine tooltip content based on node state and ability details.

The tooltip displays different content based on the node's current state:

**Unlocked Node:**
```
┌─────────────────────────────────────────────┐
│             POWER STRIKE                     │
├─────────────────────────────────────────────┤
│ Tier 1 | Cost: 2 points                     │
├─────────────────────────────────────────────┤
│ A powerful strike that deals 150% weapon    │
│ damage to a single target.                  │
├─────────────────────────────────────────────┤
│ Cooldown: 3 turns                           │
│ Resource: 15 Rage                           │
├─────────────────────────────────────────────┤
│ Status: UNLOCKED (Rank 1/1)                 │
└─────────────────────────────────────────────┘
```

**Available Node:**
```
┌─────────────────────────────────────────────┐
│             WHIRLWIND                        │
├─────────────────────────────────────────────┤
│ Tier 3 | Cost: 2 points                     │
├─────────────────────────────────────────────┤
│ Spin in a deadly arc, dealing 150% weapon   │
│ damage to all adjacent enemies.             │
├─────────────────────────────────────────────┤
│ Cooldown: 4 turns                           │
│ Resource: 25 Rage                           │
├─────────────────────────────────────────────┤
│ Prerequisites:                              │
│ [x] Cleave (Tier 2)                         │
│ [x] 8 points spent in tree                  │
├─────────────────────────────────────────────┤
│ Status: AVAILABLE - Press [U] to unlock     │
└─────────────────────────────────────────────┘
```

**Locked Node:**
```
┌─────────────────────────────────────────────┐
│             LAST STAND                       │
├─────────────────────────────────────────────┤
│ Tier 3 | Cost: 3 points                     │
├─────────────────────────────────────────────┤
│ When reduced below 20% health, gain 50%     │
│ damage reduction for 3 turns.               │
├─────────────────────────────────────────────┤
│ Cooldown: Once per combat                   │
│ Resource: None                              │
├─────────────────────────────────────────────┤
│ Prerequisites:                              │
│ [x] Iron Skin (Tier 1)                      │
│ [ ] Shield Bash (Tier 2)                    │
│ [ ] 10 points spent in tree                 │
├─────────────────────────────────────────────┤
│ Status: LOCKED                              │
└─────────────────────────────────────────────┘
```

### 4.3 Unlock Prompt Display

**Purpose:** Display confirmation when player attempts to unlock a node.

**Unlock Prompt Visual:**
```
┌─────────────────────────────────────────────┐
│ Unlock WHIRLWIND for 2 talent points?       │
│ [Y] Yes   [N] No                            │
└─────────────────────────────────────────────┘
```

**Prompt Behavior:**
- Only shown for nodes in `Available` state
- Displays the exact point cost
- Waits for `Y` or `N` key press
- `Y` executes the unlock action
- `N` cancels and returns to tree view
- Escape key also cancels

---

## 5. Talent Point Display Component

### 5.1 TalentPointDisplay Class

**Purpose:** Shows the player's available and spent talent points.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/TalentPointDisplay.cs`

```csharp
using RuneAndRust.Presentation.Tui.Services;
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Displays the player's talent point allocation status.
/// </summary>
/// <remarks>
/// Shows available and spent points in a clear format:
/// "Talent Points: {available} Available | {spent} Spent"
/// Supports animation when points are spent.
/// </remarks>
public class TalentPointDisplay
{
    private readonly ITerminalService _terminalService;
    private readonly NodeTooltipConfig _config;
    private readonly ILogger<TalentPointDisplay> _logger;

    private int _availablePoints;
    private int _spentPoints;
    private (int X, int Y) _position;

    /// <summary>
    /// Creates a new instance of the TalentPointDisplay component.
    /// </summary>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public TalentPointDisplay(
        ITerminalService terminalService,
        NodeTooltipConfig config,
        ILogger<TalentPointDisplay> logger)
    {
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Sets the display position.
    /// </summary>
    /// <param name="x">The X coordinate.</param>
    /// <param name="y">The Y coordinate.</param>
    public void SetPosition(int x, int y)
    {
        _position = (x, y);
    }

    /// <summary>
    /// Renders the talent point display.
    /// </summary>
    /// <param name="available">The number of available points.</param>
    /// <param name="spent">The number of spent points.</param>
    public void RenderPoints(int available, int spent)
    {
        _availablePoints = available;
        _spentPoints = spent;

        var displayText = FormatPointDisplay(available, spent);

        // Clear previous display
        var clearText = new string(' ', _config.PointDisplayWidth);
        _terminalService.WriteAt(_position.X, _position.Y, clearText);

        // Render new display
        _terminalService.WriteAt(_position.X, _position.Y, "Talent Points: ");

        // Available points in highlight color if > 0
        var availableColor = available > 0
            ? _config.AvailablePointsColor
            : _config.SpentPointsColor;
        _terminalService.WriteColoredAt(
            _position.X + 15,
            _position.Y,
            $"{available} Available",
            availableColor);

        _terminalService.WriteAt(
            _position.X + 15 + $"{available} Available".Length,
            _position.Y,
            " | ");

        _terminalService.WriteColoredAt(
            _position.X + 15 + $"{available} Available".Length + 3,
            _position.Y,
            $"{spent} Spent",
            _config.SpentPointsColor);

        _logger.LogDebug(
            "Rendered talent points: {Available} available, {Spent} spent",
            available,
            spent);
    }

    /// <summary>
    /// Updates the available points display.
    /// </summary>
    /// <param name="newAvailable">The new available point count.</param>
    public void UpdateAvailable(int newAvailable)
    {
        var newSpent = _spentPoints + (_availablePoints - newAvailable);
        RenderPoints(newAvailable, newSpent);
    }

    /// <summary>
    /// Animates a point spend with a brief flash effect.
    /// </summary>
    public void AnimatePointSpend()
    {
        // Brief flash effect on the available points
        var flashText = $"{_availablePoints} Available";
        var flashX = _position.X + 15;

        // Flash to white
        _terminalService.WriteColoredAt(
            flashX,
            _position.Y,
            flashText,
            ConsoleColor.White);

        // Wait briefly (in real implementation, use async/delay)
        Thread.Sleep(100);

        // Return to normal color
        var normalColor = _availablePoints > 0
            ? _config.AvailablePointsColor
            : _config.SpentPointsColor;
        _terminalService.WriteColoredAt(
            flashX,
            _position.Y,
            flashText,
            normalColor);

        _logger.LogDebug("Animated point spend");
    }

    #region Private Methods

    private string FormatPointDisplay(int available, int spent)
    {
        return $"Talent Points: {available} Available | {spent} Spent";
    }

    #endregion
}
```

### 5.2 Point Animation

**Purpose:** Provide visual feedback when points are spent.

**Animation Sequence:**
1. User confirms unlock with `[Y]`
2. Point value briefly flashes white
3. Available points decrement
4. Spent points increment
5. Display returns to normal colors

**Display Format:**
```
Talent Points: 3 Available | 12 Spent
```

**Color Coding:**
- Available points: Yellow when > 0, Gray when 0
- Spent points: Gray
- Label text: Default terminal color

---

## 6. Tooltip Renderer

### 6.1 TooltipRenderer Class

**Purpose:** Handles tooltip content formatting and layout calculations.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Renderers/TooltipRenderer.cs`

```csharp
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.Renderers;

/// <summary>
/// Renders tooltip content for ability tree nodes.
/// </summary>
/// <remarks>
/// Provides consistent formatting for ability details, requirements,
/// and status information displayed in node tooltips.
/// </remarks>
public class TooltipRenderer
{
    private readonly NodeTooltipConfig _config;

    /// <summary>
    /// Creates a new instance of the TooltipRenderer.
    /// </summary>
    /// <param name="config">Configuration for tooltip display settings.</param>
    public TooltipRenderer(NodeTooltipConfig config)
    {
        _config = config ?? throw new ArgumentNullException(nameof(config));
    }

    /// <summary>
    /// Formats ability details into a tooltip DTO.
    /// </summary>
    /// <param name="node">The ability node.</param>
    /// <param name="state">The current state of the node.</param>
    /// <returns>A formatted tooltip display DTO.</returns>
    public TooltipDisplayDto FormatAbilityDetails(AbilityTreeNode node, NodeState state)
    {
        var sections = new List<TooltipSectionDto>();

        // Main details section (cooldown, resource)
        var detailLines = new List<TooltipLineDto>();

        if (node.Cooldown.HasValue && node.Cooldown.Value > 0)
        {
            detailLines.Add(new TooltipLineDto("Cooldown", $"{node.Cooldown.Value} turns"));
        }

        if (node.ResourceCost.HasValue && node.ResourceCost.Value > 0)
        {
            var resourceType = node.ResourceType ?? "Resource";
            detailLines.Add(new TooltipLineDto("Resource", $"{node.ResourceCost.Value} {resourceType}"));
        }

        if (detailLines.Count > 0)
        {
            sections.Add(new TooltipSectionDto(null, detailLines));
        }

        // Status line based on state
        var statusText = GetStatusText(state);
        var footer = $"Status: {statusText}";

        return new TooltipDisplayDto(
            Title: node.Name.ToUpperInvariant(),
            Subtitle: $"Tier {node.Tier} | Cost: {node.PointCost} points",
            Description: node.Description,
            Sections: sections,
            Footer: footer);
    }

    /// <summary>
    /// Formats requirements into a tooltip section.
    /// </summary>
    /// <param name="prerequisites">The node prerequisites.</param>
    /// <param name="progress">The player's progress for satisfaction checking.</param>
    /// <returns>A formatted requirements section DTO.</returns>
    public TooltipSectionDto FormatRequirements(
        IReadOnlyList<NodePrerequisite> prerequisites,
        PlayerAbilityProgress progress)
    {
        var lines = new List<TooltipLineDto>();

        foreach (var prereq in prerequisites)
        {
            var isSatisfied = progress.HasUnlocked(prereq.RequiredNodeId) &&
                progress.GetRank(prereq.RequiredNodeId) >= prereq.RequiredRank;

            var indicator = isSatisfied ? "[x]" : "[ ]";
            var label = $"{indicator} {prereq.RequiredNodeId}";
            var value = $"(Tier {prereq.RequiredTier})";

            lines.Add(new TooltipLineDto(label, value, isSatisfied));
        }

        return new TooltipSectionDto("Prerequisites:", lines);
    }

    /// <summary>
    /// Formats the point cost display.
    /// </summary>
    /// <param name="pointCost">The talent point cost.</param>
    /// <returns>The formatted cost string.</returns>
    public string FormatCost(int pointCost)
    {
        return pointCost == 1
            ? "1 point"
            : $"{pointCost} points";
    }

    /// <summary>
    /// Gets the tooltip width.
    /// </summary>
    /// <returns>The configured tooltip width.</returns>
    public int GetTooltipWidth()
    {
        return _config.TooltipWidth;
    }

    /// <summary>
    /// Calculates the tooltip position relative to a node.
    /// </summary>
    /// <param name="nodeBounds">The bounds of the selected node.</param>
    /// <param name="tooltipWidth">The tooltip width.</param>
    /// <param name="maxHeight">The maximum tooltip height.</param>
    /// <returns>The calculated tooltip position.</returns>
    public TooltipPosition GetTooltipPosition(
        NodeBounds nodeBounds,
        int tooltipWidth,
        int maxHeight)
    {
        // Default: position tooltip to the right of the node
        var x = nodeBounds.X + nodeBounds.Width + _config.TooltipOffset;
        var y = nodeBounds.Y;

        // Adjust if tooltip would go off-screen (simplified check)
        var screenWidth = Console.WindowWidth;
        if (x + tooltipWidth > screenWidth - 2)
        {
            // Position to the left of the node instead
            x = nodeBounds.X - tooltipWidth - _config.TooltipOffset;
        }

        // Ensure minimum X position
        if (x < 1)
        {
            x = 1;
        }

        return new TooltipPosition(x, y);
    }

    /// <summary>
    /// Builds the tooltip content lines for rendering.
    /// </summary>
    /// <param name="tooltip">The tooltip DTO.</param>
    /// <param name="width">The available width.</param>
    /// <returns>A list of formatted lines.</returns>
    public List<string> BuildTooltipLines(TooltipDisplayDto tooltip, int width)
    {
        var lines = new List<string>();
        var innerWidth = width - 2; // Account for borders

        // Title (centered)
        lines.Add(CenterText(tooltip.Title, innerWidth));
        lines.Add(new string('─', innerWidth));

        // Subtitle
        if (!string.IsNullOrEmpty(tooltip.Subtitle))
        {
            lines.Add(CenterText(tooltip.Subtitle, innerWidth));
            lines.Add(new string('─', innerWidth));
        }

        // Description (word-wrapped)
        if (!string.IsNullOrEmpty(tooltip.Description))
        {
            var wrappedLines = WrapText(tooltip.Description, innerWidth);
            lines.AddRange(wrappedLines);
            lines.Add(new string('─', innerWidth));
        }

        // Sections
        foreach (var section in tooltip.Sections)
        {
            if (!string.IsNullOrEmpty(section.Header))
            {
                lines.Add(section.Header);
            }

            foreach (var line in section.Lines)
            {
                var formattedLine = $"{line.Label}: {line.Value}";
                lines.Add(formattedLine.PadRight(innerWidth));
            }
        }

        // Footer
        if (!string.IsNullOrEmpty(tooltip.Footer))
        {
            lines.Add(new string('─', innerWidth));
            lines.Add(tooltip.Footer.PadRight(innerWidth));
        }

        return lines;
    }

    #region Private Methods

    private string GetStatusText(NodeState state)
    {
        return state switch
        {
            NodeState.Unlocked => "UNLOCKED",
            NodeState.Available => "AVAILABLE - Press [U] to unlock",
            NodeState.Locked => "LOCKED",
            _ => "UNKNOWN"
        };
    }

    private string CenterText(string text, int width)
    {
        if (text.Length >= width)
        {
            return text.Substring(0, width);
        }

        var padding = (width - text.Length) / 2;
        return text.PadLeft(padding + text.Length).PadRight(width);
    }

    private IEnumerable<string> WrapText(string text, int maxWidth)
    {
        var words = text.Split(' ');
        var currentLine = new List<string>();
        var currentLength = 0;

        foreach (var word in words)
        {
            if (currentLength + word.Length + (currentLine.Count > 0 ? 1 : 0) > maxWidth)
            {
                if (currentLine.Count > 0)
                {
                    yield return string.Join(" ", currentLine).PadRight(maxWidth);
                    currentLine.Clear();
                    currentLength = 0;
                }
            }

            currentLine.Add(word);
            currentLength += word.Length + (currentLine.Count > 1 ? 1 : 0);
        }

        if (currentLine.Count > 0)
        {
            yield return string.Join(" ", currentLine).PadRight(maxWidth);
        }
    }

    #endregion
}
```

### 6.2 Content Formatting

**Purpose:** Format ability details into structured tooltip content.

**Content Structure:**
1. **Title**: Node name in uppercase
2. **Subtitle**: Tier number and point cost
3. **Description**: Ability description (word-wrapped)
4. **Details Section**: Cooldown and resource cost
5. **Requirements Section**: Prerequisites with satisfaction indicators
6. **Footer**: Status message with action prompt

**Requirement Formatting:**
- Satisfied: `[x] Cleave (Tier 2)` (green or default)
- Unsatisfied: `[ ] Shield Bash (Tier 2)` (gray)

### 6.3 Tooltip Positioning

**Purpose:** Calculate optimal tooltip position relative to the selected node.

**Positioning Rules:**
1. Default position: Right of the selected node
2. If tooltip would extend past screen edge, position left of node
3. Maintain minimum offset from node border
4. Ensure tooltip stays within screen bounds

**Position Calculation:**
```csharp
// Default: right of node
x = nodeBounds.X + nodeBounds.Width + offset

// Adjust if off-screen
if (x + tooltipWidth > screenWidth)
{
    x = nodeBounds.X - tooltipWidth - offset
}
```

---

## 7. Ability Tree Command

### 7.1 AbilityTreeCommand Class

**Purpose:** Handles user input and coordinates ability tree interactions.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Commands/AbilityTreeCommand.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Presentation.Tui.UI;
using RuneAndRust.Presentation.Tui.DTOs;

namespace RuneAndRust.Presentation.Tui.Commands;

/// <summary>
/// Handles ability tree user interactions and commands.
/// </summary>
/// <remarks>
/// Coordinates between the tree view, tooltip, and talent point service
/// to handle node selection, tooltip display, and unlock actions.
/// </remarks>
public class AbilityTreeCommand
{
    private readonly IAbilityTreeProvider _abilityTreeProvider;
    private readonly ITalentPointService _talentPointService;
    private readonly IPrerequisiteValidator _prerequisiteValidator;
    private readonly TreeNodeRenderer _nodeRenderer;
    private readonly NodeTooltip _tooltip;
    private readonly TalentPointDisplay _pointDisplay;
    private readonly AbilityTreeView _treeView;
    private readonly ILogger<AbilityTreeCommand> _logger;

    private string? _selectedNodeId;
    private AbilityTreeNode? _pendingUnlockNode;

    /// <summary>
    /// Gets the currently selected node ID.
    /// </summary>
    public string? SelectedNodeId => _selectedNodeId;

    /// <summary>
    /// Gets whether the command is awaiting unlock confirmation.
    /// </summary>
    public bool AwaitingConfirmation => _tooltip.AwaitingConfirmation;

    /// <summary>
    /// Creates a new instance of the AbilityTreeCommand.
    /// </summary>
    public AbilityTreeCommand(
        IAbilityTreeProvider abilityTreeProvider,
        ITalentPointService talentPointService,
        IPrerequisiteValidator prerequisiteValidator,
        TreeNodeRenderer nodeRenderer,
        NodeTooltip tooltip,
        TalentPointDisplay pointDisplay,
        AbilityTreeView treeView,
        ILogger<AbilityTreeCommand> logger)
    {
        _abilityTreeProvider = abilityTreeProvider ?? throw new ArgumentNullException(nameof(abilityTreeProvider));
        _talentPointService = talentPointService ?? throw new ArgumentNullException(nameof(talentPointService));
        _prerequisiteValidator = prerequisiteValidator ?? throw new ArgumentNullException(nameof(prerequisiteValidator));
        _nodeRenderer = nodeRenderer ?? throw new ArgumentNullException(nameof(nodeRenderer));
        _tooltip = tooltip ?? throw new ArgumentNullException(nameof(tooltip));
        _pointDisplay = pointDisplay ?? throw new ArgumentNullException(nameof(pointDisplay));
        _treeView = treeView ?? throw new ArgumentNullException(nameof(treeView));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Processes a key input for the ability tree.
    /// </summary>
    /// <param name="key">The pressed key.</param>
    /// <param name="player">The current player.</param>
    /// <returns>True if the input was handled, false otherwise.</returns>
    public bool ProcessKeyInput(ConsoleKey key, Player player)
    {
        // If awaiting confirmation, only handle Y/N/Escape
        if (AwaitingConfirmation)
        {
            return HandleConfirmationInput(key, player);
        }

        return key switch
        {
            ConsoleKey.Enter => HandleNodeSelection(_selectedNodeId, player),
            ConsoleKey.U => HandleUnlockAction(player),
            ConsoleKey.Escape => HandleEscape(),
            _ => false
        };
    }

    /// <summary>
    /// Handles node selection (Enter key or navigation).
    /// </summary>
    /// <param name="nodeId">The selected node ID.</param>
    /// <param name="player">The current player.</param>
    /// <returns>True if handled successfully.</returns>
    public bool HandleNodeSelection(string? nodeId, Player player)
    {
        if (string.IsNullOrEmpty(nodeId))
        {
            return false;
        }

        _selectedNodeId = nodeId;

        var node = _abilityTreeProvider.FindNode(nodeId);
        if (node == null)
        {
            _logger.LogWarning("Selected node {NodeId} not found", nodeId);
            return false;
        }

        var progress = _talentPointService.GetProgressForPlayer(player.Id);
        var unspentPoints = _talentPointService.GetUnspentPoints(player);
        var state = _nodeRenderer.GetNodeState(node, progress, unspentPoints);

        // Get node bounds for tooltip positioning
        var bounds = _nodeRenderer.GetNodeBounds(nodeId);
        if (bounds == null)
        {
            _logger.LogWarning("No bounds found for node {NodeId}", nodeId);
            return false;
        }

        // Show tooltip
        _tooltip.ShowTooltip(node, state, bounds.Value);

        // Show requirements if applicable
        if (state != NodeState.Unlocked)
        {
            var prerequisites = _prerequisiteValidator.GetPrerequisitesForNode(nodeId);
            if (prerequisites.Count > 0)
            {
                _tooltip.ShowRequirements(prerequisites, progress);
            }
        }

        _logger.LogDebug("Selected node {NodeId} with state {State}", nodeId, state);
        return true;
    }

    /// <summary>
    /// Handles the unlock action (U key).
    /// </summary>
    /// <param name="player">The current player.</param>
    /// <returns>True if unlock prompt was shown.</returns>
    public bool HandleUnlockAction(Player player)
    {
        if (string.IsNullOrEmpty(_selectedNodeId))
        {
            _logger.LogDebug("No node selected for unlock");
            return false;
        }

        var node = _abilityTreeProvider.FindNode(_selectedNodeId);
        if (node == null)
        {
            return false;
        }

        var progress = _talentPointService.GetProgressForPlayer(player.Id);
        var unspentPoints = _talentPointService.GetUnspentPoints(player);
        var state = _nodeRenderer.GetNodeState(node, progress, unspentPoints);

        // Can only unlock available nodes
        if (state != NodeState.Available)
        {
            _logger.LogDebug(
                "Cannot unlock node {NodeId} - state is {State}",
                _selectedNodeId,
                state);
            return false;
        }

        // Show unlock prompt
        _pendingUnlockNode = node;
        _tooltip.ShowUnlockPrompt(node);

        _logger.LogDebug("Showing unlock prompt for node {NodeId}", _selectedNodeId);
        return true;
    }

    /// <summary>
    /// Handles confirmation input (Y/N).
    /// </summary>
    /// <param name="confirmed">Whether the action was confirmed.</param>
    /// <param name="player">The current player.</param>
    /// <returns>True if handled.</returns>
    public bool HandleConfirmation(bool confirmed, Player player)
    {
        if (_pendingUnlockNode == null)
        {
            return false;
        }

        if (!confirmed)
        {
            // Cancel unlock
            _pendingUnlockNode = null;
            _tooltip.HideTooltip();
            _logger.LogDebug("Unlock cancelled by user");
            return true;
        }

        // Execute unlock
        var result = _talentPointService.SpendPoints(
            player,
            _pendingUnlockNode.NodeId,
            _pendingUnlockNode.PointCost);

        if (!result.Success)
        {
            _logger.LogWarning(
                "Failed to unlock node {NodeId}: {Error}",
                _pendingUnlockNode.NodeId,
                result.ErrorMessage);
            _pendingUnlockNode = null;
            _tooltip.HideTooltip();
            return false;
        }

        // Update displays
        var newAvailable = _talentPointService.GetUnspentPoints(player);
        var newSpent = _talentPointService.GetTotalPointsSpent(player);

        _pointDisplay.AnimatePointSpend();
        _pointDisplay.RenderPoints(newAvailable, newSpent);

        // Refresh tree view
        var tree = _abilityTreeProvider.GetTreeForClass(player.ClassId);
        if (tree != null)
        {
            var progress = _talentPointService.GetProgressForPlayer(player.Id);
            _treeView.RefreshConnections(tree, progress);
        }

        _tooltip.HideTooltip();
        _pendingUnlockNode = null;

        _logger.LogInformation(
            "Unlocked node {NodeId} for {Cost} points",
            _selectedNodeId,
            result.PointsSpent);

        return true;
    }

    #region Private Methods

    private bool HandleConfirmationInput(ConsoleKey key, Player player)
    {
        return key switch
        {
            ConsoleKey.Y => HandleConfirmation(true, player),
            ConsoleKey.N => HandleConfirmation(false, player),
            ConsoleKey.Escape => HandleConfirmation(false, player),
            _ => false
        };
    }

    private bool HandleEscape()
    {
        if (_tooltip.IsVisible)
        {
            _tooltip.HideTooltip();
            return true;
        }

        return false;
    }

    #endregion
}
```

### 7.2 Node Selection Handling

**Purpose:** Handle node selection and display appropriate tooltip.

**Selection Flow:**
1. User navigates to node using arrow keys
2. User presses Enter to select
3. Command retrieves node details and state
4. Tooltip is displayed with formatted content
5. Requirements are shown if node is not unlocked

**Navigation Keys:**
- Arrow keys: Move between nodes
- Enter: Select node (show tooltip)
- Escape: Close tooltip

### 7.3 Unlock Confirmation Flow

**Purpose:** Handle the unlock action with confirmation.

**Confirmation Flow:**
1. User presses `[U]` on an available node
2. Confirmation prompt is displayed
3. User presses `[Y]` or `[N]`
4. If `[Y]`: Execute unlock, update displays
5. If `[N]` or Escape: Cancel and close prompt

**Unlock Execution:**
1. Call `ITalentPointService.SpendPoints()`
2. If successful:
   - Animate point spend
   - Update talent point display
   - Refresh node states
   - Refresh prerequisite lines
   - Close tooltip
3. If failed:
   - Log error
   - Close tooltip

---

## 8. Data Model Changes

### 8.1 New DTOs

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/TooltipDtos.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for tooltip display content.
/// </summary>
/// <param name="Title">The tooltip title (ability name).</param>
/// <param name="Subtitle">The subtitle (tier and cost).</param>
/// <param name="Description">The ability description.</param>
/// <param name="Sections">Content sections (details, requirements).</param>
/// <param name="Footer">The status/action footer.</param>
public record TooltipDisplayDto(
    string Title,
    string? Subtitle,
    string? Description,
    IReadOnlyList<TooltipSectionDto> Sections,
    string? Footer);

/// <summary>
/// Data transfer object for a tooltip content section.
/// </summary>
/// <param name="Header">Optional section header.</param>
/// <param name="Lines">The lines in this section.</param>
public record TooltipSectionDto(
    string? Header,
    IReadOnlyList<TooltipLineDto> Lines);

/// <summary>
/// Data transfer object for a single tooltip line.
/// </summary>
/// <param name="Label">The line label.</param>
/// <param name="Value">The line value.</param>
/// <param name="IsSatisfied">Whether this requirement is satisfied (for prerequisites).</param>
public record TooltipLineDto(
    string Label,
    string Value,
    bool IsSatisfied = true);

/// <summary>
/// Represents the position of a tooltip on screen.
/// </summary>
/// <param name="X">The X coordinate.</param>
/// <param name="Y">The Y coordinate.</param>
public record TooltipPosition(int X, int Y);

/// <summary>
/// Data transfer object for talent point display.
/// </summary>
/// <param name="Available">The number of available points.</param>
/// <param name="Spent">The number of spent points.</param>
/// <param name="Total">The total points earned.</param>
public record TalentPointDisplayDto(
    int Available,
    int Spent,
    int Total);
```

### 8.2 Configuration Classes

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/NodeTooltipConfig.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration for node tooltip display settings.
/// </summary>
public class NodeTooltipConfig
{
    /// <summary>
    /// Width of the tooltip box.
    /// </summary>
    public int TooltipWidth { get; set; } = 45;

    /// <summary>
    /// Maximum height of the tooltip (in lines).
    /// </summary>
    public int MaxTooltipHeight { get; set; } = 20;

    /// <summary>
    /// Offset from the node when positioning tooltip.
    /// </summary>
    public int TooltipOffset { get; set; } = 2;

    /// <summary>
    /// Width of the talent point display area.
    /// </summary>
    public int PointDisplayWidth { get; set; } = 40;

    /// <summary>
    /// Color for the tooltip border.
    /// </summary>
    public ConsoleColor BorderColor { get; set; } = ConsoleColor.DarkCyan;

    /// <summary>
    /// Color for the confirmation prompt.
    /// </summary>
    public ConsoleColor PromptColor { get; set; } = ConsoleColor.Yellow;

    /// <summary>
    /// Color for available points (when > 0).
    /// </summary>
    public ConsoleColor AvailablePointsColor { get; set; } = ConsoleColor.Yellow;

    /// <summary>
    /// Color for spent points.
    /// </summary>
    public ConsoleColor SpentPointsColor { get; set; } = ConsoleColor.Gray;

    /// <summary>
    /// Color for satisfied requirements.
    /// </summary>
    public ConsoleColor SatisfiedColor { get; set; } = ConsoleColor.Green;

    /// <summary>
    /// Color for unsatisfied requirements.
    /// </summary>
    public ConsoleColor UnsatisfiedColor { get; set; } = ConsoleColor.DarkGray;
}
```

---

## 9. Configuration File Schemas

### 9.1 node-tooltip.json

**File:** `config/node-tooltip.json`

```json
{
  "$schema": "./schemas/node-tooltip.schema.json",
  "tooltipWidth": 45,
  "maxTooltipHeight": 20,
  "tooltipOffset": 2,
  "pointDisplayWidth": 40,
  "borderColor": "DarkCyan",
  "promptColor": "Yellow",
  "availablePointsColor": "Yellow",
  "spentPointsColor": "Gray",
  "satisfiedColor": "Green",
  "unsatisfiedColor": "DarkGray"
}
```

### 9.2 node-tooltip.schema.json

**File:** `config/schemas/node-tooltip.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "node-tooltip.schema.json",
  "title": "Node Tooltip Configuration",
  "description": "Configuration for ability tree node tooltip display",
  "type": "object",
  "properties": {
    "tooltipWidth": {
      "type": "integer",
      "description": "Width of the tooltip box",
      "minimum": 30,
      "maximum": 80,
      "default": 45
    },
    "maxTooltipHeight": {
      "type": "integer",
      "description": "Maximum height of the tooltip in lines",
      "minimum": 10,
      "maximum": 40,
      "default": 20
    },
    "tooltipOffset": {
      "type": "integer",
      "description": "Offset from node when positioning tooltip",
      "minimum": 0,
      "maximum": 10,
      "default": 2
    },
    "pointDisplayWidth": {
      "type": "integer",
      "description": "Width of the talent point display area",
      "minimum": 25,
      "maximum": 60,
      "default": 40
    },
    "borderColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "DarkCyan"
    },
    "promptColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Yellow"
    },
    "availablePointsColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Yellow"
    },
    "spentPointsColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Gray"
    },
    "satisfiedColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Green"
    },
    "unsatisfiedColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "DarkGray"
    }
  },
  "$defs": {
    "consoleColor": {
      "type": "string",
      "enum": [
        "Black", "DarkBlue", "DarkGreen", "DarkCyan",
        "DarkRed", "DarkMagenta", "DarkYellow", "Gray",
        "DarkGray", "Blue", "Green", "Cyan",
        "Red", "Magenta", "Yellow", "White"
      ]
    }
  },
  "additionalProperties": false
}
```

---

## 10. AbilityTreeView Integration

### 10.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/AbilityTreeView.cs` (modifications)

```csharp
// Add to AbilityTreeView class

private readonly NodeTooltip _tooltip;
private readonly TalentPointDisplay _pointDisplay;
private readonly AbilityTreeCommand _command;

/// <summary>
/// Renders the complete tree with tooltip support.
/// </summary>
/// <param name="treeDto">The tree display data.</param>
/// <param name="tree">The ability tree definition.</param>
/// <param name="progress">The player's ability progress.</param>
/// <param name="available">Available talent points.</param>
/// <param name="spent">Spent talent points.</param>
public void RenderTreeWithTooltipSupport(
    TreeDisplayDto treeDto,
    AbilityTreeDefinition tree,
    PlayerAbilityProgress progress,
    int available,
    int spent)
{
    // Render tree structure and nodes
    RenderTreeWithConnections(treeDto, tree, progress);

    // Render talent point display
    _pointDisplay.SetPosition(_config.StartX + _config.Padding, _config.StartY - 2);
    _pointDisplay.RenderPoints(available, spent);

    _logger.LogDebug("Rendered tree with tooltip support");
}

/// <summary>
/// Handles key input for the ability tree.
/// </summary>
/// <param name="key">The pressed key.</param>
/// <param name="player">The current player.</param>
/// <returns>True if the input was handled.</returns>
public bool HandleKeyInput(ConsoleKey key, Player player)
{
    return _command.ProcessKeyInput(key, player);
}

/// <summary>
/// Updates the selected node and refreshes highlight.
/// </summary>
/// <param name="newNodeId">The newly selected node ID.</param>
/// <param name="nodeStates">The current node states.</param>
public void UpdateSelection(
    string newNodeId,
    Dictionary<string, NodeStateDisplayDto> nodeStates)
{
    var previousNodeId = _command.SelectedNodeId;
    UpdateSelectionHighlight(previousNodeId, newNodeId, nodeStates);
}
```

### 10.2 CharacterView Updates

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/CharacterView.cs` (modifications)

```csharp
// Add to CharacterView class

/// <summary>
/// Handles ability tree tab with complete interaction support.
/// </summary>
private void HandleAbilityTreeTabComplete()
{
    var player = _gameState.CurrentPlayer;
    if (player == null)
    {
        _logger.LogWarning("Cannot show ability tree - no current player");
        return;
    }

    var tree = _abilityTreeProvider.GetTreeForClass(player.ClassId);
    if (tree == null)
    {
        _logger.LogWarning("No ability tree found for class {ClassId}", player.ClassId);
        return;
    }

    var progress = _talentPointService.GetProgressForPlayer(player.Id);
    var unspentPoints = _talentPointService.GetUnspentPoints(player);
    var spentPoints = _talentPointService.GetTotalPointsSpent(player);

    // Create tree display DTO
    var treeDto = CreateTreeDisplayDto(tree);

    // Render complete tree with tooltip support
    _abilityTreeView.RenderTreeWithTooltipSupport(
        treeDto,
        tree,
        progress,
        unspentPoints,
        spentPoints);

    _logger.LogDebug(
        "Rendered complete ability tree for class {ClassId}",
        player.ClassId);
}
```

### 10.3 Render Layer Order

Rendering order for the complete ability tree UI:

```
1. Clear tree area
2. Render tree border
3. Render tree header
4. Render talent point display  <-- v0.13.2d
5. Render tier labels
6. Render node boxes (placeholder)
7. Render prerequisite lines (v0.13.2c)
8. Render node states (v0.13.2b)
9. Render node tooltip (if visible)  <-- v0.13.2d
10. Render confirmation prompt (if active)  <-- v0.13.2d
```

---

## 11. Logging Specifications

### 11.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `NodeTooltip` | Information | Unlock successful |
| `NodeTooltip` | Debug | Show/hide tooltip, prompt display |
| `NodeTooltip` | Warning | Node not found |
| `TalentPointDisplay` | Debug | Point renders, animations |
| `TooltipRenderer` | Debug | Content formatting, position calculations |
| `AbilityTreeCommand` | Information | Node unlocked |
| `AbilityTreeCommand` | Debug | Key inputs, selections, confirmations |
| `AbilityTreeCommand` | Warning | Unlock failures, node not found |
| `CharacterView` | Debug | Tree rendered with tooltip support |

### 11.2 Log Message Examples

```
[INF] AbilityTreeCommand: Unlocked node whirlwind for 2 points
[DBG] NodeTooltip: Showed tooltip for node whirlwind at (52, 10)
[DBG] NodeTooltip: Showed unlock prompt for node whirlwind (cost: 2)
[DBG] NodeTooltip: Hid tooltip
[DBG] TalentPointDisplay: Rendered talent points: 3 available, 12 spent
[DBG] TalentPointDisplay: Animated point spend
[DBG] AbilityTreeCommand: Selected node whirlwind with state Available
[DBG] AbilityTreeCommand: Showing unlock prompt for node whirlwind
[DBG] AbilityTreeCommand: Unlock cancelled by user
[WRN] AbilityTreeCommand: Failed to unlock node whirlwind: Insufficient points
[WRN] AbilityTreeCommand: Selected node unknown-node not found
[DBG] TooltipRenderer: Calculated tooltip position at (52, 10)
[DBG] CharacterView: Rendered complete ability tree for class warrior
```

---

## 12. Unit Testing Requirements

### 12.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| TooltipRenderer | ~2 |
| AbilityTreeCommand | ~2 |
| **Total** | **~4** |

### 12.2 Test Specifications

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Renderers/TooltipRendererTests.cs`

```csharp
[TestFixture]
public class TooltipRendererTests
{
    private TooltipRenderer _renderer;
    private NodeTooltipConfig _config;

    [SetUp]
    public void Setup()
    {
        _config = new NodeTooltipConfig();
        _renderer = new TooltipRenderer(_config);
    }

    [Test]
    public void FormatAbilityDetails_WithUnlockedState_ReturnsUnlockedStatus()
    {
        // Arrange
        var node = CreateTestNode("power-strike", "Power Strike", 1, 2);

        // Act
        var result = _renderer.FormatAbilityDetails(node, NodeState.Unlocked);

        // Assert
        Assert.That(result.Title, Is.EqualTo("POWER STRIKE"));
        Assert.That(result.Footer, Does.Contain("UNLOCKED"));
    }

    [Test]
    public void FormatAbilityDetails_WithAvailableState_ReturnsUnlockPrompt()
    {
        // Arrange
        var node = CreateTestNode("cleave", "Cleave", 2, 2);

        // Act
        var result = _renderer.FormatAbilityDetails(node, NodeState.Available);

        // Assert
        Assert.That(result.Footer, Does.Contain("Press [U] to unlock"));
    }

    [Test]
    public void FormatRequirements_WithMixedSatisfaction_ReturnsCorrectIndicators()
    {
        // Arrange
        var prerequisites = new List<NodePrerequisite>
        {
            CreatePrerequisite("power-strike", 1, 1),
            CreatePrerequisite("iron-skin", 1, 1)
        };
        var progress = CreateProgressWithUnlockedNode("power-strike");

        // Act
        var result = _renderer.FormatRequirements(prerequisites, progress);

        // Assert
        Assert.That(result.Lines.Count, Is.EqualTo(2));
        Assert.That(result.Lines[0].IsSatisfied, Is.True);
        Assert.That(result.Lines[1].IsSatisfied, Is.False);
    }

    [Test]
    public void GetTooltipPosition_WhenRoomOnRight_ReturnsRightPosition()
    {
        // Arrange
        var nodeBounds = new NodeBounds(10, 10, 11, 3);
        var tooltipWidth = 45;
        var maxHeight = 20;

        // Act
        var result = _renderer.GetTooltipPosition(nodeBounds, tooltipWidth, maxHeight);

        // Assert
        Assert.That(result.X, Is.GreaterThan(nodeBounds.X + nodeBounds.Width));
    }

    #region Test Helpers

    private static AbilityTreeNode CreateTestNode(
        string nodeId, string name, int tier, int pointCost)
    {
        return AbilityTreeNode.Create(
            nodeId: nodeId,
            name: name,
            description: "Test description",
            tier: tier,
            pointCost: pointCost,
            maxRank: 1,
            position: new NodePosition(0, 0),
            prerequisiteNodeIds: new List<string>());
    }

    private static NodePrerequisite CreatePrerequisite(
        string nodeId, int requiredRank, int requiredTier)
    {
        return new NodePrerequisite(nodeId, requiredRank, requiredTier);
    }

    private static PlayerAbilityProgress CreateProgressWithUnlockedNode(string nodeId)
    {
        var progress = PlayerAbilityProgress.Create(Guid.NewGuid());
        progress.UnlockNode(nodeId);
        return progress;
    }

    #endregion
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Commands/AbilityTreeCommandTests.cs`

```csharp
[TestFixture]
public class AbilityTreeCommandTests
{
    private Mock<IAbilityTreeProvider> _mockTreeProvider;
    private Mock<ITalentPointService> _mockTalentService;
    private Mock<IPrerequisiteValidator> _mockPrereqValidator;
    private Mock<TreeNodeRenderer> _mockNodeRenderer;
    private Mock<NodeTooltip> _mockTooltip;
    private Mock<TalentPointDisplay> _mockPointDisplay;
    private Mock<AbilityTreeView> _mockTreeView;
    private Mock<ILogger<AbilityTreeCommand>> _mockLogger;
    private AbilityTreeCommand _command;

    [SetUp]
    public void Setup()
    {
        _mockTreeProvider = new Mock<IAbilityTreeProvider>();
        _mockTalentService = new Mock<ITalentPointService>();
        _mockPrereqValidator = new Mock<IPrerequisiteValidator>();
        _mockNodeRenderer = new Mock<TreeNodeRenderer>();
        _mockTooltip = new Mock<NodeTooltip>();
        _mockPointDisplay = new Mock<TalentPointDisplay>();
        _mockTreeView = new Mock<AbilityTreeView>();
        _mockLogger = new Mock<ILogger<AbilityTreeCommand>>();

        _command = new AbilityTreeCommand(
            _mockTreeProvider.Object,
            _mockTalentService.Object,
            _mockPrereqValidator.Object,
            _mockNodeRenderer.Object,
            _mockTooltip.Object,
            _mockPointDisplay.Object,
            _mockTreeView.Object,
            _mockLogger.Object);
    }

    [Test]
    public void HandleNodeSelection_WithValidNode_ShowsTooltip()
    {
        // Arrange
        var node = CreateTestNode("power-strike");
        var player = CreateTestPlayer();
        var progress = PlayerAbilityProgress.Create(player.Id);

        _mockTreeProvider.Setup(p => p.FindNode("power-strike")).Returns(node);
        _mockTalentService.Setup(s => s.GetProgressForPlayer(player.Id)).Returns(progress);
        _mockTalentService.Setup(s => s.GetUnspentPoints(player)).Returns(5);
        _mockNodeRenderer.Setup(r => r.GetNodeState(node, progress, 5)).Returns(NodeState.Available);
        _mockNodeRenderer.Setup(r => r.GetNodeBounds("power-strike"))
            .Returns(new NodeBounds(10, 10, 11, 3));

        // Act
        var result = _command.HandleNodeSelection("power-strike", player);

        // Assert
        Assert.That(result, Is.True);
        _mockTooltip.Verify(t => t.ShowTooltip(
            node, NodeState.Available, It.IsAny<NodeBounds>()), Times.Once);
    }

    [Test]
    public void HandleUnlockAction_WhenNodeNotAvailable_ReturnsFalse()
    {
        // Arrange
        var node = CreateTestNode("power-strike");
        var player = CreateTestPlayer();
        var progress = PlayerAbilityProgress.Create(player.Id);
        progress.UnlockNode("power-strike");

        _mockTreeProvider.Setup(p => p.FindNode("power-strike")).Returns(node);
        _mockTalentService.Setup(s => s.GetProgressForPlayer(player.Id)).Returns(progress);
        _mockTalentService.Setup(s => s.GetUnspentPoints(player)).Returns(5);
        _mockNodeRenderer.Setup(r => r.GetNodeState(node, progress, 5)).Returns(NodeState.Unlocked);

        // Set selected node
        _command.HandleNodeSelection("power-strike", player);

        // Act
        var result = _command.HandleUnlockAction(player);

        // Assert
        Assert.That(result, Is.False);
    }

    [Test]
    public void HandleConfirmation_WhenConfirmed_SpendsPointsAndUpdatesDisplay()
    {
        // Arrange
        var node = CreateTestNode("cleave", pointCost: 2);
        var player = CreateTestPlayer();
        var progress = PlayerAbilityProgress.Create(player.Id);

        _mockTreeProvider.Setup(p => p.FindNode("cleave")).Returns(node);
        _mockTreeProvider.Setup(p => p.GetTreeForClass(player.ClassId)).Returns((AbilityTreeDefinition?)null);
        _mockTalentService.Setup(s => s.GetProgressForPlayer(player.Id)).Returns(progress);
        _mockTalentService.Setup(s => s.GetUnspentPoints(player)).Returns(5);
        _mockTalentService.Setup(s => s.GetTotalPointsSpent(player)).Returns(10);
        _mockTalentService.Setup(s => s.SpendPoints(player, "cleave", 2))
            .Returns(new TalentSpendResult(true, 2, null));
        _mockNodeRenderer.Setup(r => r.GetNodeState(node, progress, 5)).Returns(NodeState.Available);
        _mockNodeRenderer.Setup(r => r.GetNodeBounds("cleave"))
            .Returns(new NodeBounds(10, 10, 11, 3));
        _mockTooltip.Setup(t => t.AwaitingConfirmation).Returns(true);

        // Setup: select node and trigger unlock
        _command.HandleNodeSelection("cleave", player);
        _command.HandleUnlockAction(player);

        // Act
        var result = _command.HandleConfirmation(true, player);

        // Assert
        Assert.That(result, Is.True);
        _mockTalentService.Verify(s => s.SpendPoints(player, "cleave", 2), Times.Once);
        _mockPointDisplay.Verify(d => d.AnimatePointSpend(), Times.Once);
    }

    #region Test Helpers

    private static AbilityTreeNode CreateTestNode(string nodeId, int pointCost = 2)
    {
        return AbilityTreeNode.Create(
            nodeId: nodeId,
            name: nodeId.Replace("-", " "),
            description: "Test node",
            tier: 1,
            pointCost: pointCost,
            maxRank: 1,
            position: new NodePosition(0, 0),
            prerequisiteNodeIds: new List<string>());
    }

    private static Player CreateTestPlayer()
    {
        return Player.Create(
            Guid.NewGuid(),
            "TestPlayer",
            "warrior",
            1);
    }

    #endregion
}
```

---

## 13. Use Cases

### UC-001: View Node Tooltip

**Actor:** Player
**Flow:** Navigate to node using arrow keys → Press Enter → Tooltip displays with ability details → View name, tier, cost, description, cooldown, resource cost → Press Escape to close

### UC-002: View Locked Node Requirements

**Actor:** Player
**Flow:** Navigate to locked node → Press Enter → Tooltip displays → See prerequisites section → Satisfied prerequisites marked with `[x]` → Unsatisfied prerequisites marked with `[ ]` → Understand what needs to be unlocked first

### UC-003: Unlock Available Node

**Actor:** Player
**Flow:** Navigate to available node → Press Enter → Tooltip shows "Press [U] to unlock" → Press `[U]` → Confirmation prompt shows cost → Press `[Y]` → Node unlocks → Talent points update → Prerequisite lines refresh

### UC-004: Cancel Unlock Action

**Actor:** Player
**Flow:** Navigate to available node → Press `[U]` → Confirmation prompt appears → Press `[N]` or Escape → Prompt dismissed → No changes made

### UC-005: View Talent Point Status

**Actor:** Player
**Flow:** Open ability tree → View talent point display at top → See "{X} Available | {Y} Spent" → Plan point allocation strategy

### UC-006: Attempt to Unlock Locked Node

**Actor:** Player
**Flow:** Navigate to locked node → Press `[U]` → Nothing happens (unlock not available for locked nodes) → View tooltip to see missing prerequisites

---

## 14. Deliverable Checklist

### UI Components
- [ ] `NodeTooltip` class implemented
- [ ] `ShowTooltip()` method displays tooltip
- [ ] `HideTooltip()` method clears tooltip
- [ ] `ShowRequirements()` method updates requirements section
- [ ] `ShowUnlockPrompt()` method displays confirmation
- [ ] `TalentPointDisplay` class implemented
- [ ] `RenderPoints()` method displays point status
- [ ] `UpdateAvailable()` method updates display
- [ ] `AnimatePointSpend()` method provides visual feedback

### Renderers
- [ ] `TooltipRenderer` class implemented
- [ ] `FormatAbilityDetails()` creates tooltip content
- [ ] `FormatRequirements()` formats prerequisites
- [ ] `FormatCost()` formats point cost
- [ ] `GetTooltipWidth()` returns configured width
- [ ] `GetTooltipPosition()` calculates position
- [ ] `BuildTooltipLines()` creates rendered lines

### Commands
- [ ] `AbilityTreeCommand` class implemented
- [ ] `ProcessKeyInput()` handles all key inputs
- [ ] `HandleNodeSelection()` shows tooltip
- [ ] `HandleUnlockAction()` initiates unlock
- [ ] `HandleConfirmation()` processes Y/N response

### DTOs
- [ ] `TooltipDisplayDto` record created
- [ ] `TooltipSectionDto` record created
- [ ] `TooltipLineDto` record created
- [ ] `TooltipPosition` record created
- [ ] `TalentPointDisplayDto` record created

### Configuration
- [ ] `NodeTooltipConfig` class created
- [ ] `config/node-tooltip.json` created
- [ ] `config/schemas/node-tooltip.schema.json` created

### View Integration
- [ ] `AbilityTreeView` updated with `RenderTreeWithTooltipSupport()`
- [ ] `AbilityTreeView` updated with `HandleKeyInput()`
- [ ] `CharacterView` renders complete tree

### Testing
- [ ] ~4 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] Talent point counter shows available/spent in format `# Available | # Spent`
- [ ] Node tooltips show on selection (Enter key)
- [ ] Ability details display in tooltip (name, tier, cost, description)
- [ ] Cooldown and resource cost display in tooltip
- [ ] Requirements display with satisfaction status (`[x]`/`[ ]`)
- [ ] Unlock action works for available nodes only
- [ ] Unlock confirmation shows cost
- [ ] `[Y]` confirms unlock and spends points
- [ ] `[N]` or Escape cancels unlock
- [ ] Talent points update after unlock
- [ ] Point spend animates with flash effect
- [ ] Tooltip positions correctly adjacent to nodes

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~4 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] No hardcoded values (all configurable)

---

## 16. Dependencies

### Required from v0.13.2a

| Type | Location | Usage in v0.13.2d |
|------|----------|-------------------|
| `AbilityTreeView` | `Presentation.Tui/UI/` | Integration point |
| `TreeLayoutRenderer` | `Presentation.Tui/Renderers/` | Node position data |
| `NodeLayoutDto` | `Presentation.Tui/DTOs/` | Node information |
| `NodeScreenPosition` | `Presentation.Tui/DTOs/` | Screen coordinates |
| `AbilityTreeDisplayConfig` | `Presentation.Tui/Configuration/` | Layout settings |

### Required from v0.13.2b

| Type | Location | Usage in v0.13.2d |
|------|----------|-------------------|
| `TreeNodeRenderer` | `Presentation.Tui/UI/` | Node state determination, bounds |
| `NodeState` enum | `Presentation.Tui/DTOs/` | State-specific tooltip content |
| `NodeStateDisplayDto` | `Presentation.Tui/DTOs/` | Node state information |
| `NodeBounds` | `Presentation.Tui/DTOs/` | Tooltip positioning |

### Required from v0.13.2c

| Type | Location | Usage in v0.13.2d |
|------|----------|-------------------|
| `PrerequisiteLines` | `Presentation.Tui/UI/` | Refresh after unlock |
| `LineState` enum | `Presentation.Tui/DTOs/` | Prerequisite satisfaction |

### Required from v0.10.2a-c

| Type | Location | Usage in v0.13.2d |
|------|----------|-------------------|
| `AbilityTreeNode` | `Domain/Definitions/` | Node details for tooltip |
| `AbilityTreeDefinition` | `Domain/Definitions/` | Tree structure |
| `PlayerAbilityProgress` | `Domain/Entities/` | Unlock status |
| `NodePrerequisite` | `Domain/ValueObjects/` | Requirement display |
| `IAbilityTreeProvider` | `Application/Interfaces/` | Node lookup |
| `ITalentPointService` | `Application/Interfaces/` | Point management |
| `IPrerequisiteValidator` | `Application/Interfaces/` | Requirement checking |

---

## 17. Future Considerations

### Out of Scope

- **Hover Tooltips**: TUI does not support hover events; tooltips triggered by selection
- **Tooltip Animations**: Fade-in/fade-out effects
- **Multi-Selection**: Selecting multiple nodes simultaneously
- **Undo Unlock**: Ability to refund spent points
- **Tooltip Scrolling**: Scrollable content for very long descriptions
- **Rich Text Formatting**: Colors within tooltip content text

### Potential Enhancements (Future Versions)

- **Keyboard Shortcuts**: Quick unlock with number keys
- **Tooltip History**: View previously seen tooltips
- **Comparison View**: Compare two nodes side by side
- **Build Planning**: Preview point allocation before committing
- **Point Reset**: Feature to reset all talent points
- **Sound Effects**: Audio feedback for unlock actions

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
