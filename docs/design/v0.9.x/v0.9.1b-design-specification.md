# v0.9.1b Design Specification: Music Themes

**Version:** 0.9.1b
**Parent:** v0.9.1 (Music System)
**Prerequisites:** v0.9.1a Complete (Music Service Core)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## 1. Overview

### Purpose

Define music themes with associated tracks and configuration. Each theme can have multiple tracks (for variety), optional intro tracks, shuffle vs sequential playback, and per-theme volume adjustments. All theme definitions load from `music-themes.json` configuration. Stingers (one-shot celebratory/defeat tracks) are also defined here.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `MusicTheme` (full) |
| **Interfaces** | `IMusicThemeConfig` |
| **Services** | `MusicThemeConfig` |
| **Configuration** | `music-themes.json` |
| **DTOs** | `ThemeDefinition`, `StingerDefinition` |
| **Tests** | ~6 unit tests |

---

## 2. Feature Overview

```
v0.9.1b Features
├── MusicTheme Enum (Full)
│   ├── None
│   ├── MainMenu
│   ├── Exploration
│   ├── Combat
│   ├── BossCombat
│   ├── SafeArea
│   ├── Victory (stinger)
│   └── Defeat (stinger)
│
├── IMusicThemeConfig Interface
│   ├── GetTrackForTheme(theme) → string?
│   ├── GetAllTracksForTheme(theme) → list
│   ├── GetIntroTrack(theme) → string?
│   ├── GetThemeVolume(theme) → float
│   ├── ShouldShuffle(theme) → bool
│   ├── GetStingerTrack(name) → string?
│   └── GetAvailableStingers() → list
│
├── Theme Configuration
│   ├── Multiple tracks per theme
│   ├── Shuffle vs sequential
│   ├── Intro track support
│   ├── Volume per theme
│   └── Loop setting
│
├── Stinger Definitions
│   ├── victory → victory_fanfare.ogg
│   ├── defeat → defeat_somber.ogg
│   ├── level-up → levelup_jingle.ogg
│   └── quest-complete → quest_complete.ogg
│
└── music-themes.json
    ├── Theme array with definitions
    ├── Stinger array with definitions
    └── Transition settings (for v0.9.1c)
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       MusicService (v0.9.1a)                            │
├─────────────────────────────────────────────────────────────────────────┤
│  SetTheme(theme) ──▶ _themeConfig.GetTrackForTheme(theme)              │
│  PlayStinger(name) ─▶ _themeConfig.GetStingerTrack(name)               │
│  PreloadThemeAsync ─▶ _themeConfig.GetAllTracksForTheme(theme)         │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       IMusicThemeConfig                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  GetTrackForTheme(theme) → string?                                     │
│  GetAllTracksForTheme(theme) → IReadOnlyList<string>                   │
│  GetIntroTrack(theme) → string?                                        │
│  GetThemeVolume(theme) → float                                         │
│  ShouldShuffle(theme) → bool                                           │
│  GetStingerTrack(name) → string?                                       │
│  GetAvailableStingers() → IReadOnlyList<string>                        │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       MusicThemeConfig                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  _themes: Dictionary<MusicTheme, ThemeDefinition>                      │
│  _stingers: Dictionary<string, StingerDefinition>                      │
│  _trackIndices: Dictionary<MusicTheme, int> (for sequential)           │
│  _random: Random (for shuffle)                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       config/music-themes.json                          │
├─────────────────────────────────────────────────────────────────────────┤
│  { themes: [...], stingers: [...], transitions: {...} }                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. MusicTheme Enum

**File:** `src/Core/RuneAndRust.Application/Enums/MusicTheme.cs`

```csharp
namespace RuneAndRust.Application.Enums;

/// <summary>
/// Music themes that change based on game context.
/// </summary>
public enum MusicTheme
{
    /// <summary>No music playing.</summary>
    None,

    /// <summary>Main menu music.</summary>
    MainMenu,

    /// <summary>Dungeon exploration ambient music.</summary>
    Exploration,

    /// <summary>Standard combat music.</summary>
    Combat,

    /// <summary>Boss encounter music.</summary>
    BossCombat,

    /// <summary>Town/safe area peaceful music.</summary>
    SafeArea,

    /// <summary>Victory celebration (stinger, one-shot).</summary>
    Victory,

    /// <summary>Defeat/death (stinger, one-shot).</summary>
    Defeat
}
```

---

## 5. IMusicThemeConfig Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IMusicThemeConfig.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Configuration for music themes and track selection.
/// </summary>
public interface IMusicThemeConfig
{
    /// <summary>Gets a track path for a theme (respects shuffle/sequential).</summary>
    /// <param name="theme">The music theme.</param>
    /// <returns>Path to a track, or null if no tracks defined.</returns>
    string? GetTrackForTheme(MusicTheme theme);

    /// <summary>Gets all tracks for a theme.</summary>
    IReadOnlyList<string> GetAllTracksForTheme(MusicTheme theme);

    /// <summary>Gets the intro track for a theme, if any.</summary>
    string? GetIntroTrack(MusicTheme theme);

    /// <summary>Gets the volume multiplier for a theme (0.0-1.0).</summary>
    float GetThemeVolume(MusicTheme theme);

    /// <summary>Gets whether a theme should shuffle tracks.</summary>
    bool ShouldShuffle(MusicTheme theme);

    /// <summary>Gets whether a theme should loop.</summary>
    bool ShouldLoop(MusicTheme theme);

    /// <summary>Gets a stinger track path by name.</summary>
    string? GetStingerTrack(string stingerName);

    /// <summary>Gets the volume for a stinger.</summary>
    float GetStingerVolume(string stingerName);

    /// <summary>Gets all available stinger names.</summary>
    IReadOnlyList<string> GetAvailableStingers();
}
```

---

## 6. Theme & Stinger Definitions

**File:** `src/Core/RuneAndRust.Application/DTOs/MusicThemeDefinitions.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>Configuration DTO for theme definitions.</summary>
public class ThemeDefinition
{
    public MusicTheme Theme { get; set; }
    public List<string> Tracks { get; set; } = new();
    public string? IntroTrack { get; set; }
    public float Volume { get; set; } = 1.0f;
    public bool Loop { get; set; } = true;
    public bool Shuffle { get; set; } = false;
}

/// <summary>Configuration DTO for stinger definitions.</summary>
public class StingerDefinition
{
    public string Name { get; set; } = string.Empty;
    public string Track { get; set; } = string.Empty;
    public float Volume { get; set; } = 1.0f;
}

/// <summary>Root configuration DTO for music-themes.json.</summary>
public class MusicThemesJson
{
    public List<ThemeDefinition> Themes { get; set; } = new();
    public List<StingerDefinition> Stingers { get; set; } = new();
    public TransitionSettings Transitions { get; set; } = new();
}

/// <summary>Transition settings for crossfade (used in v0.9.1c).</summary>
public class TransitionSettings
{
    public float DefaultCrossfade { get; set; } = 2.0f;
    public float CombatCrossfade { get; set; } = 0.5f;
    public float StingerFadeOut { get; set; } = 1.0f;
    public float StingerResumeDelay { get; set; } = 0.5f;
}
```

---

## 7. MusicThemeConfig Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/MusicThemeConfig.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class MusicThemeConfig : IMusicThemeConfig
{
    private readonly Dictionary<MusicTheme, ThemeDefinition> _themes;
    private readonly Dictionary<string, StingerDefinition> _stingers;
    private readonly Dictionary<MusicTheme, int> _trackIndices = new();
    private readonly Random _random = new();
    private readonly ILogger<MusicThemeConfig> _logger;

    public MusicThemeConfig(IConfigurationProvider configProvider, ILogger<MusicThemeConfig> logger)
    {
        _logger = logger;
        var config = configProvider.LoadConfig<MusicThemesJson>("music-themes.json");
        _themes = config.Themes.ToDictionary(t => t.Theme, t => t);
        _stingers = config.Stingers.ToDictionary(s => s.Name.ToLowerInvariant(), s => s);
        _logger.LogInformation("Loaded {ThemeCount} themes, {StingerCount} stingers",
            _themes.Count, _stingers.Count);
    }

    public string? GetTrackForTheme(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def) || def.Tracks.Count == 0)
            return null;

        if (def.Shuffle)
        {
            var index = _random.Next(def.Tracks.Count);
            _logger.LogDebug("Shuffle selected track {Index} for {Theme}", index, theme);
            return def.Tracks[index];
        }

        // Sequential playback
        if (!_trackIndices.TryGetValue(theme, out var trackIndex))
            trackIndex = 0;

        var track = def.Tracks[trackIndex % def.Tracks.Count];
        _trackIndices[theme] = trackIndex + 1;
        _logger.LogDebug("Sequential track {Index} for {Theme}", trackIndex, theme);
        return track;
    }

    public IReadOnlyList<string> GetAllTracksForTheme(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return Array.Empty<string>();
        return def.Tracks;
    }

    public string? GetIntroTrack(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return null;
        return def.IntroTrack;
    }

    public float GetThemeVolume(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return 1.0f;
        return def.Volume;
    }

    public bool ShouldShuffle(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return false;
        return def.Shuffle;
    }

    public bool ShouldLoop(MusicTheme theme)
    {
        if (!_themes.TryGetValue(theme, out var def))
            return true;
        return def.Loop;
    }

    public string? GetStingerTrack(string stingerName)
    {
        var key = stingerName.ToLowerInvariant();
        if (!_stingers.TryGetValue(key, out var def))
            return null;
        return def.Track;
    }

    public float GetStingerVolume(string stingerName)
    {
        var key = stingerName.ToLowerInvariant();
        if (!_stingers.TryGetValue(key, out var def))
            return 1.0f;
        return def.Volume;
    }

    public IReadOnlyList<string> GetAvailableStingers() => _stingers.Keys.ToList();
}
```

---

## 8. Configuration File

**File:** `config/music-themes.json`

```json
{
  "$schema": "./schemas/music-themes.schema.json",
  "themes": [
    {
      "theme": "MainMenu",
      "tracks": ["audio/music/menu_theme.ogg"],
      "volume": 0.7,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "Exploration",
      "tracks": [
        "audio/music/dungeon_ambient_01.ogg",
        "audio/music/dungeon_ambient_02.ogg",
        "audio/music/dungeon_ambient_03.ogg"
      ],
      "volume": 0.6,
      "loop": true,
      "shuffle": true
    },
    {
      "theme": "Combat",
      "tracks": ["audio/music/combat_intense.ogg"],
      "introTrack": "audio/music/combat_intro.ogg",
      "volume": 0.8,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "BossCombat",
      "tracks": [
        "audio/music/boss_epic.ogg",
        "audio/music/boss_epic_phase2.ogg"
      ],
      "introTrack": "audio/music/boss_intro.ogg",
      "volume": 0.9,
      "loop": true,
      "shuffle": false
    },
    {
      "theme": "SafeArea",
      "tracks": [
        "audio/music/town_peaceful.ogg",
        "audio/music/tavern_music.ogg"
      ],
      "volume": 0.5,
      "loop": true,
      "shuffle": true
    }
  ],
  "stingers": [
    {
      "name": "victory",
      "track": "audio/music/victory_fanfare.ogg",
      "volume": 1.0
    },
    {
      "name": "defeat",
      "track": "audio/music/defeat_somber.ogg",
      "volume": 0.8
    },
    {
      "name": "level-up",
      "track": "audio/music/levelup_jingle.ogg",
      "volume": 1.0
    },
    {
      "name": "quest-complete",
      "track": "audio/music/quest_complete.ogg",
      "volume": 0.9
    }
  ],
  "transitions": {
    "defaultCrossfade": 2.0,
    "combatCrossfade": 0.5,
    "stingerFadeOut": 1.0,
    "stingerResumeDelay": 0.5
  }
}
```

---

## 9. Theme Visualization

```
THEME DEFINITIONS:
══════════════════════════════════════════════════════════════════════════

  THEME              TRACKS                        SETTINGS
  ─────              ──────                        ────────

  MainMenu      ──▶  • menu_theme.ogg              Volume: 0.7
                                                   Loop: ✓
                                                   Shuffle: ✗

  Exploration   ──▶  • dungeon_ambient_01.ogg      Volume: 0.6
                     • dungeon_ambient_02.ogg      Loop: ✓
                     • dungeon_ambient_03.ogg      Shuffle: ✓

  Combat        ──▶  [intro] combat_intro.ogg      Volume: 0.8
                     • combat_intense.ogg          Loop: ✓
                                                   Shuffle: ✗

  BossCombat    ──▶  [intro] boss_intro.ogg        Volume: 0.9
                     • boss_epic.ogg               Loop: ✓
                     • boss_epic_phase2.ogg        Shuffle: ✗

  SafeArea      ──▶  • town_peaceful.ogg           Volume: 0.5
                     • tavern_music.ogg            Loop: ✓
                                                   Shuffle: ✓


STINGERS (One-Shot):
══════════════════════════════════════════════════════════════════════════

  NAME              TRACK                          VOLUME
  ────              ─────                          ──────
  victory      ──▶  victory_fanfare.ogg            1.0
  defeat       ──▶  defeat_somber.ogg              0.8
  level-up     ──▶  levelup_jingle.ogg             1.0
  quest-complete ▶  quest_complete.ogg             0.9
```

---

## 10. Unit Testing Requirements (~6 tests)

| Feature | Tests |
|---------|-------|
| GetTrackForTheme returns track | 1 |
| Shuffle mode randomizes selection | 1 |
| Sequential mode cycles tracks | 1 |
| GetIntroTrack returns intro | 1 |
| GetStingerTrack returns stinger | 1 |
| Missing theme returns null | 1 |

---

## 11. Acceptance Criteria

- [ ] MusicTheme enum has all themes
- [ ] Themes load from music-themes.json
- [ ] GetTrackForTheme returns valid track
- [ ] Shuffle mode randomizes track selection
- [ ] Sequential mode cycles through tracks
- [ ] Intro tracks return correctly
- [ ] Theme volumes are configurable
- [ ] ShouldLoop returns correct value
- [ ] Stingers are defined and accessible
- [ ] GetStingerTrack returns stinger path
- [ ] GetStingerVolume returns volume
- [ ] GetAvailableStingers lists all stingers
- [ ] Missing themes return null
- [ ] ~6 unit tests pass

---

## 12. Dependencies

| From | Required |
|------|----------|
| v0.9.1a | `IMusicService` uses config |
| Infrastructure | `IConfigurationProvider` |
| Application | `MusicTheme` enum |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
