# Changelog: v0.17.3f - Archetype Application Service

**Release Date:** 2026-01-30
**Phase:** Archetype System (6/6)
**Status:** Complete

---

## Overview

Implements the `IArchetypeApplicationService` interface and `ArchetypeApplicationService` application service that orchestrates applying archetype bonuses, starting abilities, and specialization mappings to characters during character creation Step 4 (Archetype Selection). Also introduces the `ArchetypeApplicationResult` value object, `ArchetypeValidationResult` and `ArchetypeApplicationPreview` record structs, and comprehensive unit tests.

This milestone completes the v0.17.3 Archetype System by providing the service layer that applies all archetype data from v0.17.3a through v0.17.3e to a `Player` entity:

| Component                  | Version  | Description                                           |
| -------------------------- | -------- | ----------------------------------------------------- |
| Archetype definitions      | v0.17.3a | Display metadata, combat role, resource type           |
| Resource bonuses           | v0.17.3b | HP, Stamina, Aether Pool, Movement, Special bonuses   |
| Starting abilities         | v0.17.3c | 3 abilities per archetype (Active/Passive/Stance)     |
| Specialization mappings    | v0.17.3d | Available specializations and recommended first choice |
| Provider service           | v0.17.3e | Cached access to all archetype data from JSON config  |
| **Application service**    | **v0.17.3f** | **Orchestrates applying all archetype data to characters** |

The service applies archetype data in 5 steps:

1. **Validate preconditions** — null check, existing archetype check, enum validity, definition existence
2. **Retrieve archetype data** — definition, resource bonuses, abilities, specializations from `IArchetypeProvider`
3. **Apply resource bonuses** — HP via `ModifyMaxHp()`, Aether Pool via `ModifyMaxAp()`, Movement via `ModifyMovement()`
4. **Grant starting abilities** — 3 abilities per archetype via `PlayerAbility.Create()` and `Player.AddAbility()`
5. **Set archetype identifier** — via `Player.SetClass(archetypeId, archetypeId)`

---

## Added

### Application Layer

#### Value Objects

- **`ArchetypeApplicationResult`** (`ValueObjects/ArchetypeApplicationResult.cs`)
    - `sealed class` with private constructor (enforces factory method usage)
    - Properties: `Success` (bool), `AppliedArchetype` (Archetype?), `ResourceBonusesApplied` (ArchetypeResourceBonuses?), `AbilitiesGranted` (IReadOnlyList\<ArchetypeAbilityGrant\>), `AvailableSpecializations` (ArchetypeSpecializationMapping?), `FailureReason` (string?)
    - Factory methods:
        - `Succeeded(Archetype, ArchetypeResourceBonuses, IReadOnlyList<ArchetypeAbilityGrant>, ArchetypeSpecializationMapping)`: Creates success result with all granted data
        - `Failed(string reason)`: Creates failure result with empty grants
        - `AlreadyHasArchetype(Archetype existing)`: Creates failure with permanence message
        - `CharacterRequired`: Static property for null character failures
    - Display methods:
        - `GetSummary()`: Formatted summary including archetype name, resource bonuses, ability count, specialization count
        - `GetGrantedAbilitiesList()`: List of formatted ability strings (e.g., "Power Strike [ACTIVE]")
        - `GetSpecializationsList()`: List of formatted specialization names with recommended highlighted
    - Full XML documentation on all members with `<summary>`, `<value>`, `<remarks>`, `<param>`, `<returns>`, `<example>`, `<seealso>`

#### Interfaces

- **`IArchetypeApplicationService`** (`Interfaces/IArchetypeApplicationService.cs`)
    - 3 methods providing archetype application, validation, and preview:
        - `ApplyArchetype(Player character, Archetype archetype)`: Applies all archetype data to character → `ArchetypeApplicationResult`
        - `CanApplyArchetype(Player? character, Archetype archetype)`: Validates preconditions → `ArchetypeValidationResult`
        - `GetApplicationPreview(Archetype archetype)`: Assembles read-only preview → `ArchetypeApplicationPreview`
    - Full XML documentation with `<summary>`, `<param>`, `<returns>`, `<remarks>`, `<example>`, `<seealso>` on interface and all methods

#### Supporting Record Structs

- **`ArchetypeValidationResult`** (`Interfaces/IArchetypeApplicationService.cs`)
    - `readonly record struct` with `(bool IsValid, IReadOnlyList<string> Issues)` primary constructor
    - Factory methods: `Valid` (static property), `Invalid(params string[] issues)`
    - Used by `CanApplyArchetype` for pre-application validation

- **`ArchetypeApplicationPreview`** (`Interfaces/IArchetypeApplicationService.cs`)
    - `readonly record struct` with `(Archetype, string DisplayName, ArchetypeResourceBonuses, IReadOnlyList<ArchetypeAbilityGrant>, ArchetypeSpecializationMapping)` primary constructor
    - Computed property: `TotalElements` (resource categories + abilities + specializations)
    - Used by UI to display archetype details before permanent selection

#### Services

- **`ArchetypeApplicationService`** (`Services/ArchetypeApplicationService.cs`)
    - Implements `IArchetypeApplicationService`
    - Dependencies: `IArchetypeProvider`, `ILogger<ArchetypeApplicationService>`
    - Constructor: `ArgumentNullException.ThrowIfNull` for both dependencies
    - `ApplyArchetype`: 5-step flow (validate → retrieve → apply bonuses → grant abilities → set ID)
    - `CanApplyArchetype`: 4 validation checks (null, HasClass, Enum.IsDefined, definition exists)
    - `GetApplicationPreview`: Assembles preview from provider data with fallback display name
    - Private helpers:
        - `ApplyResourceBonuses(Player, ArchetypeResourceBonuses)`: Applies HP, AP, Movement; defers Stamina and Special
        - `GrantAbilities(Player, IReadOnlyList<ArchetypeAbilityGrant>)`: Creates and adds PlayerAbility instances
    - Exhaustive structured logging at all levels (Debug, Information, Warning, Error)
    - Section separators: PRIVATE FIELDS, CONSTRUCTOR, PUBLIC METHODS, PRIVATE METHODS
    - Full XML documentation on class and all methods

### Unit Tests

- **`ArchetypeApplicationResultTests`** (`ValueObjects/ArchetypeApplicationResultTests.cs`) — 11 tests
    - `Succeeded_WithValidData_CreatesSuccessfulResult`: All properties verified
    - `Succeeded_AbilitiesGranted_ContainsCorrectAbilities`: Ability data verification
    - `Failed_WithReason_CreatesFailedResult`: Failure state and empty grants
    - `AlreadyHasArchetype_ContainsArchetypeNameAndPermanenceMessage`: Message content
    - `CharacterRequired_CreatesFailedResultWithDescriptiveMessage`: Static property
    - `GetSummary_OnSuccess_ContainsAppliedArchetypeAndDetails`: Formatted summary
    - `GetSummary_OnFailure_ContainsFailedPrefixAndReason`: Failure format
    - `GetGrantedAbilitiesList_ReturnsFormattedAbilityDisplayStrings`: Short display format
    - `GetGrantedAbilitiesList_OnFailure_ReturnsEmptyList`: Empty on failure
    - `GetSpecializationsList_OnSuccess_ReturnsFormattedSpecializationNames`: Specialization count
    - `GetSpecializationsList_OnFailure_ReturnsEmptyList`: Empty on failure

- **`ArchetypeApplicationServiceTests`** (`Services/ArchetypeApplicationServiceTests.cs`) — 16 tests
    - `Constructor_NullProvider_ThrowsArgumentNullException`
    - `Constructor_NullLogger_ThrowsArgumentNullException`
    - `ApplyArchetype_Warrior_AppliesSuccessfully`: Full success path with HP+49, Stamina+5, 3 abilities, 6 specs
    - `ApplyArchetype_NullCharacter_ReturnsFailedResult`: Null character guard
    - `ApplyArchetype_CharacterAlreadyHasArchetype_ReturnsFailedResult`: Permanent choice enforcement
    - `ApplyArchetype_DefinitionNotFound_ReturnsFailedResult`: Missing definition
    - `ApplyArchetype_Mystic_AppliesAetherPoolBonus`: AP+20 via ModifyMaxAp
    - `ApplyArchetype_Skirmisher_AppliesMovementBonus`: Movement+1 via ModifyMovement
    - `ApplyArchetype_Adept_AppliesWithSpecialBonus`: HP+30, special bonus tracked
    - `ApplyArchetype_GrantsAbilities_AsUnlocked`: PlayerAbility.Create with isUnlocked:true
    - `ApplyArchetype_SetsArchetypeId_ViaSetClass`: SetClass called with lowercase archetype ID
    - `CanApplyArchetype_ValidCharacter_ReturnsValid`: All checks pass
    - `CanApplyArchetype_NullCharacter_ReturnsInvalid`: Null produces invalid
    - `CanApplyArchetype_ExistingArchetype_ReturnsInvalid`: Permanent choice violation
    - `GetApplicationPreview_ReturnsCompletePreview`: All preview fields populated
    - `GetApplicationPreview_MissingDefinition_UsesFallbackDisplayName`: Enum name fallback

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries
    - `archetype-application-service`: Application layer service orchestrating archetype application during creation Step 4 (sortOrder: 34)
    - `archetype-application-result`: Result value object capturing granted bonuses, abilities, and specializations (sortOrder: 35)
    - `archetype-validation-result`: Lightweight validation result for archetype application preconditions (sortOrder: 36)

---

## Changed

### Infrastructure Layer

- **`DependencyInjection.cs`** — Added `IArchetypeApplicationService` scoped registration
    - Registration: `services.AddScoped<IArchetypeApplicationService, ArchetypeApplicationService>()`
    - Comment block: `// Archetype application service (v0.17.3f) - Orchestrates applying archetype bonuses, starting abilities, and specialization mappings to characters during character creation Step 4 (Archetype Selection).`
    - Placed after `IBackgroundApplicationService` and before `IDerivedStatCalculator`

### Documentation

- **`docs/design/v0.17.x/v0.17.3-scope-breakdown.md`** — Checked off v0.17.3f deliverables
    - `[x] ApplyArchetypeToCharacter grants correct abilities`
    - `[x] Resource bonuses apply correctly`
    - `[x] Archetype cannot be changed after application`
    - Checked off all v0.17.3 acceptance criteria (15/15 items)
    - Checked off v0.17.3e provider tests

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.3f deliverables
    - `[x] Archetype choice is permanent (cannot be changed)`
    - `[x] Archetype grants 3 starting abilities`

---

## Design Decisions

### Sealed Class for ArchetypeApplicationResult

The design specification used a `sealed class` rather than a `readonly record struct`. This was followed because the result uses nullable reference types (`Archetype?`, `ArchetypeResourceBonuses?`, `ArchetypeSpecializationMapping?`, `string?`) and complex collections (`IReadOnlyList<ArchetypeAbilityGrant>`), which are better suited to reference type semantics. The private constructor enforces factory method usage, ensuring consistent initialization.

### Player Entity Adaptation

The v0.17.3f design specification assumed `Character` entity methods that don't exist on the actual `Player` entity:

| Design Spec Assumed | Actual Player Entity | Adaptation |
|---------------------|---------------------|------------|
| `SetArchetype(Archetype)` | `SetClass(string archetypeId, string classId)` | Uses `SetClass(archetypeId, archetypeId)` with lowercase enum name |
| `HasArchetype` property | `HasClass` property | Uses `HasClass` for existing archetype check |
| `ModifyMaxStamina(int)` | Not available | Stamina bonus tracked in result, deferred for future integration |
| `SetAvailableSpecializations(...)` | Not available | Specializations tracked in result for Step 5 |
| `ActivatePassiveAbility(...)` | Not available | Passive abilities granted as unlocked PlayerAbility instances |

### Validation-First Pattern

Following `BackgroundApplicationService`, the service performs all validation checks before modifying the character. If any validation fails, the character is not modified. This ensures atomicity — either all archetype components are applied or none are.

### ArchetypeValidationResult as Separate Type

Rather than using a simple `bool` for validation, `ArchetypeValidationResult` captures multiple validation issues simultaneously. This allows the UI to display all problems at once (e.g., "character already has archetype AND invalid enum value") rather than requiring fix-and-retry loops.

### ArchetypeApplicationPreview as Lightweight Record

The preview struct aggregates all archetype data into a single object for UI display. Using a `readonly record struct` matches the pattern from `ArchetypeValidationResult` and provides value equality semantics for testing.

---

## Dependencies

### Prerequisites

| Type                             | Phase    | Usage                                    |
| -------------------------------- | -------- | ---------------------------------------- |
| `Archetype`                      | v0.17.3a | Archetype identification and enum        |
| `ArchetypeDefinition`            | v0.17.3a | Core definition entity (DisplayName, etc.) |
| `ArchetypeResourceBonuses`       | v0.17.3b | Resource bonus value object              |
| `ArchetypeSpecialBonus`          | v0.17.3b | Special bonus tracking (Adept)           |
| `ArchetypeAbilityGrant`          | v0.17.3c | Starting ability value object            |
| `AbilityType`                    | v0.17.3c | Ability type classification              |
| `ArchetypeSpecializationMapping` | v0.17.3d | Specialization mapping value object      |
| `IArchetypeProvider`             | v0.17.3e | Provider for all archetype data          |
| `Player`                         | v0.1.x   | Character entity with modifier methods   |
| `PlayerAbility`                  | v0.1.x   | Ability entity for character abilities   |

### Provides to Future Phases

| Type                              | Phase    | Usage                                              |
| --------------------------------- | -------- | -------------------------------------------------- |
| `IArchetypeApplicationService`    | v0.17.5  | Character creation workflow Step 4                 |
| `ArchetypeApplicationResult`      | v0.17.5  | UI feedback after archetype selection              |
| `ArchetypeApplicationPreview`     | v0.17.5  | Pre-selection archetype detail display             |
| `ArchetypeValidationResult`       | v0.17.5  | Pre-validation before archetype application        |

---

## Logging Strategy

| Level       | When                                                                                          |
| ----------- | --------------------------------------------------------------------------------------------- |
| Debug       | Service constructor initialization                                                           |
| Debug       | Validation checks start (archetype, character null status)                                   |
| Debug       | Each validation failure with specific details (null, existing archetype, invalid enum, missing definition) |
| Debug       | Validation completion (issue count and list)                                                  |
| Debug       | Archetype data retrieval (definition, abilities, specializations, combat role)                |
| Debug       | Each resource bonus application (HP, AP, Movement, deferred Stamina, special)                |
| Debug       | Resource bonus completion with display summary                                                |
| Debug       | Each ability granted (ID, type, name, passive/activation status)                             |
| Debug       | Archetype ID set on character (ID, HasClass status)                                          |
| Debug       | Preview generation with display name and counts                                              |
| Information | Application start (archetype, character ID, character name)                                  |
| Information | Successful application (all bonuses, ability count, spec count, recommended spec)            |
| Information | Abilities granted summary (count, ability list with types)                                   |
| Warning     | Application failed due to validation (archetype, combined reason)                            |
| Error       | Definition not found in provider after validation passed                                     |

---

## Files Created

| Path                                                                                    | Description                              |
| --------------------------------------------------------------------------------------- | ---------------------------------------- |
| `src/Core/RuneAndRust.Application/ValueObjects/ArchetypeApplicationResult.cs`            | Result value object                      |
| `src/Core/RuneAndRust.Application/Interfaces/IArchetypeApplicationService.cs`            | Interface + validation/preview records   |
| `src/Core/RuneAndRust.Application/Services/ArchetypeApplicationService.cs`               | Service implementation                   |
| `tests/RuneAndRust.Application.UnitTests/ValueObjects/ArchetypeApplicationResultTests.cs`| Result unit tests (11 tests)             |
| `tests/RuneAndRust.Application.UnitTests/Services/ArchetypeApplicationServiceTests.cs`   | Service unit tests (16 tests)            |
| `changelogs/v0.17.3f-changelog.md`                                                     | This changelog                           |

## Files Modified

| Path                                                                          | Description                                               |
| ----------------------------------------------------------------------------- | --------------------------------------------------------- |
| `config/glossary.json`                                                        | Added 3 glossary entries (sortOrder 34-36)                |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs`        | Added IArchetypeApplicationService scoped registration    |
| `docs/design/v0.17.x/v0.17.3-scope-breakdown.md`                             | Checked off v0.17.3f deliverables and all acceptance criteria |
| `docs/design/v0.17.x/v0.17.x-overview.md`                                    | Checked off v0.17.3f deliverables                         |

---

## Notes

- Total unit tests for v0.17.3f: 27 tests (11 ArchetypeApplicationResult + 16 ArchetypeApplicationService)
- This completes the v0.17.3 Archetype System — all 6 phases (a-f) are now implemented
- The service follows the `BackgroundApplicationService` pattern exactly: constructor DI → validation-first → result object return
- Stamina bonus application is deferred until the `Player` entity gains a `ModifyMaxStamina()` method; the bonus is tracked in `ArchetypeResourceBonuses` and `ArchetypeApplicationResult`
- Special bonus (Adept's +20% Consumable Effectiveness) requires combat system integration for mechanical application; tracked in result
- Specialization availability is tracked in the result for Step 5 (Specialization Selection) but is not directly set on the Player entity (no `SetAvailableSpecializations` method exists)
- The `ArchetypeValidationResult` collects all issues simultaneously rather than failing on the first issue, enabling comprehensive UI feedback
- The service uses `Player.SetClass(archetypeId, archetypeId)` as the archetype setter, using lowercase archetype enum names as IDs
