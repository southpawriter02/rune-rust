# v0.1.5d Design Specification: Treasure Vault Generation

**Version:** 0.1.5d
**Phase Name:** Treasure Vault Generation
**Parent Version:** v0.1.5 (Procedural Puzzles & Secrets)
**Prerequisites:** v0.1.5c Complete (Trap Placement System)
**Estimated Tests:** ~21 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [VaultLockType Enum](#4-vaultlocktype-enum)
5. [TreasureRoomTemplate Entity](#5-treasureroomtemplate-entity)
6. [GuardianAssignment Value Object](#6-guardianassignment-value-object)
7. [VaultConfiguration Value Object](#7-vaultconfiguration-value-object)
8. [VaultGenerationService](#8-vaultgenerationservice)
9. [VaultGenerationContext Record](#9-vaultgenerationcontext-record)
10. [VaultGenerationResult Record](#10-vaultgenerationresult-record)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement treasure room templates and vault generation logic for procedural treasure vault creation during dungeon generation. This phase determines vault layouts, assigns guardians, configures lock types, and integrates with puzzle and trap systems. This is **generation-only**—the actual unlock mechanics (guardian combat, puzzle solving, key usage, loot distribution) are deferred to v0.4.0 (Interactive Environment & Puzzles).

### 1.2 Current State

| Area | Current State (v0.1.5c) | Target State (v0.1.5d) |
|------|-------------------------|------------------------|
| Vault types | Not defined | 4 vault types (Minor Cache, Guarded Treasury, Puzzle Vault, Dragon's Hoard) |
| Vault templates | None | JSON-configurable templates with lock types, guardians, and rewards |
| Lock systems | N/A | 5 lock types (None, Guardian, Puzzle, GuardianAndPuzzle, Key) |
| Guardian assignment | N/A | Guardian configuration with level scaling |
| Reward scaling | N/A | Reward multiplier system (1.0x - 3.0x) |
| Integration | N/A | Puzzle and trap placement integration |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `TreasureRoomTemplate` |
| **Value Objects** | `GuardianAssignment`, `VaultConfiguration` |
| **Enums** | `VaultLockType` |
| **Records** | `VaultGenerationContext`, `VaultGenerationResult` |
| **Services** | `VaultGenerationService` (with `IVaultGenerationService` interface) |
| **Configuration** | `vaults.json`, `vaults.schema.json` |
| **Tests** | ~21 new unit tests |

### 1.4 Architectural Significance

This version establishes the **treasure vault generation pattern** that integrates all v0.1.5 systems:
- Template-based vault configuration loaded from JSON
- Lock type system supporting multiple access requirements
- Guardian assignment with level scaling by dungeon depth
- Integration with `IPuzzlePlacementService` (v0.1.5a) for puzzle-locked vaults
- Integration with `ITrapPlacementService` (v0.1.5c) for trapped vaults
- Reward multiplier system for loot scaling
- Biome/style filtering for template selection
- Weighted probability selection for vault templates
- Completes the v0.1.5 procedural content generation framework

### 1.5 Scope Boundaries

| In Scope (v0.1.5d - Generation) | Out of Scope (Deferred to v0.4.0 - Interaction) |
|--------------------------------|------------------------------------------------|
| TreasureRoomTemplate definitions | Unlock mechanics |
| VaultConfiguration assignment | Guardian combat integration |
| Guardian level calculation | Puzzle-lock solving |
| Puzzle/trap integration | Loot distribution |
| Lock type configuration | Key item mechanics |
| Reward multiplier assignment | Vault state persistence (locked/unlocked) |

---

## 2. Feature Overview

```
v0.1.5d Treasure Vault Generation
├── VaultLockType Enum
│   ├── None (freely accessible)
│   ├── Guardian (requires defeating guardian)
│   ├── Puzzle (requires solving puzzle)
│   ├── GuardianAndPuzzle (requires both)
│   └── Key (requires specific key item)
├── TreasureRoomTemplate Entity
│   ├── Unique ID and display name
│   ├── Description template
│   ├── Depth range (min/max)
│   ├── Spawn probability
│   ├── Lock type
│   ├── Puzzle template ID (if puzzle-locked)
│   ├── Guardian assignment (if guardian-locked)
│   ├── Loot table ID
│   ├── Reward multiplier
│   ├── Biome filtering (allowed biomes)
│   ├── Style filtering (architectural styles)
│   └── Trap IDs (traps guarding vault)
├── GuardianAssignment Value Object
│   ├── Monster definition ID
│   ├── Guardian display name
│   ├── Introduction text
│   ├── Defeat text
│   ├── Level offset from depth
│   └── Bonus trait IDs
├── VaultConfiguration Value Object
│   ├── Template ID
│   ├── Lock type
│   ├── Puzzle instance ID (if applicable)
│   ├── Guardian definition ID (if applicable)
│   ├── Guardian level (calculated)
│   ├── Required key ID (if applicable)
│   ├── Loot table ID
│   ├── Reward multiplier
│   └── Trap instance IDs
├── VaultGenerationService
│   ├── GenerateVault(context) - creates vault configuration
│   ├── ShouldGenerateVault(context) - generation decision
│   ├── SelectTemplate(templates, context) - probability selection
│   ├── CreateVaultRoom(template, context) - room generation
│   ├── CreateVaultPuzzle(template, roomId, context) - puzzle integration
│   └── CreateVaultTraps(template, roomId, context) - trap integration
├── VaultGenerationContext Record
│   ├── Dungeon ID
│   ├── Room position
│   ├── Dungeon depth
│   ├── Biome ID and name
│   ├── Architectural style ID
│   ├── World seed
│   └── Room type
├── VaultGenerationResult Record
│   ├── Generated room
│   ├── Template used
│   ├── Puzzle instance (if any)
│   ├── Trap instances
│   └── Vault configuration
└── Configuration
    ├── vaults.json (template definitions)
    └── vaults.schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Room descriptions include vault presence (v0.4.0 adds unlock interaction)   │
│  ├── GameView displays vault descriptions                                   │
│  ├── Guardian encounters shown when entering guarded vaults                 │
│  └── Lock requirements displayed based on VaultLockType                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  VaultGenerationService                                                      │
│  ├── GenerateVault(context)        ├── SelectTemplate(templates, context)   │
│  ├── ShouldGenerateVault(context)  ├── CreateVaultRoom(template, context)   │
│  ├── CreateVaultPuzzle(...)        └── CreateVaultTraps(...)                │
│                                                                              │
│  Interfaces:                        Consumed By:                             │
│  └── IVaultGenerationService        └── DungeonGeneratorService             │
│                                                                              │
│  Records:                           Dependencies:                            │
│  ├── VaultGenerationContext         ├── IConfigurationProvider              │
│  └── VaultGenerationResult          ├── IPuzzlePlacementService (v0.1.5a)   │
│                                     ├── ITrapPlacementService (v0.1.5c)     │
│                                     ├── ISeededRandomService                │
│                                     └── ILogger<VaultGenerationService>     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions (IDefinition):     Value Objects:                               │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                 │
│  │ TreasureRoomTemplate    │    │ GuardianAssignment      │                 │
│  │ ├── Id: string          │    │ ├── MonsterDefinitionId │                 │
│  │ ├── Name: string        │    │ ├── Name: string        │                 │
│  │ ├── DescriptionTemplate │    │ ├── IntroductionText    │                 │
│  │ ├── MinDepth: int       │    │ ├── DefeatText          │                 │
│  │ ├── MaxDepth: int       │    │ ├── LevelOffset: int    │                 │
│  │ ├── SpawnProbability    │    │ └── BonusTraitIds       │                 │
│  │ ├── LockType            │    └─────────────────────────┘                 │
│  │ ├── PuzzleTemplateId?   │    ┌─────────────────────────┐                 │
│  │ ├── Guardian?           │    │ VaultConfiguration      │                 │
│  │ ├── LootTableId         │    │ ├── TemplateId          │                 │
│  │ ├── RewardMultiplier    │    │ ├── LockType            │                 │
│  │ ├── AllowedBiomes       │    │ ├── PuzzleId?: Guid     │                 │
│  │ ├── AllowedStyles       │    │ ├── GuardianDefId?      │                 │
│  │ └── TrapIds             │    │ ├── GuardianLevel: int  │                 │
│  └─────────────────────────┘    │ ├── RequiredKeyId?      │                 │
│                                 │ ├── LootTableId         │                 │
│  Enums:                         │ ├── RewardMultiplier    │                 │
│  ┌─────────────────────────┐    │ └── TrapIds: List<Guid> │                 │
│  │ VaultLockType           │    └─────────────────────────┘                 │
│  │ ├── None                │                                                │
│  │ ├── Guardian            │                                                │
│  │ ├── Puzzle              │                                                │
│  │ ├── GuardianAndPuzzle   │                                                │
│  │ └── Key                 │                                                │
│  └─────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetTreasureRoomTemplates(): IReadOnlyList<TreasureRoomTemplate>        │
│  └── Loads and deserializes config/vaults.json                              │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/vaults.json                                                     │
│  └── config/schemas/vaults.schema.json                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Vault Generation Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Dungeon generation creates room with RoomType.Treasure         │
│ requiring enhanced vault configuration                         │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ VaultGenerationService.ShouldGenerateVault(context)           │
├───────────────────────────────────────────────────────────────┤
│ Checks:                                                       │
│ ├── RoomType == RoomType.Treasure                             │
│ ├── Valid templates exist for context                         │
│ └── Returns true if both conditions met                       │
└───────────────┬───────────────────────────────────────────────┘
                │ (if true)
                ▼
┌───────────────────────────────────────────────────────────────┐
│ VaultGenerationService.GenerateVault(context)                 │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Filter templates by context                           │
├───────────────────────────────────────────────────────────────┤
│ _configurationProvider.GetTreasureRoomTemplates()             │
│     .Where(t => t.IsValidFor(depth, biomeId, styleId))        │
│                                                               │
│ IsValidFor checks:                                            │
│ ├── depth >= MinDepth                                         │
│ ├── depth <= MaxDepth (if MaxDepth > 0)                       │
│ ├── BiomeId in AllowedBiomes (if list not empty)              │
│ └── StyleId in AllowedStyles (if list not empty)              │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Select template (probability-weighted random)         │
├───────────────────────────────────────────────────────────────┤
│ SelectTemplate(templates, context)                            │
│ ├── totalProbability = sum of all SpawnProbability            │
│ ├── roll = random(0, totalProbability)                        │
│ └── Return first template where cumulative > roll             │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Create vault room                                     │
├───────────────────────────────────────────────────────────────┤
│ CreateVaultRoom(template, context)                            │
│ ├── Room.Create(dungeonId, template.Name,                     │
│ │       template.DescriptionTemplate, position, Treasure)     │
│ └── Returns new Room entity                                   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Create vault puzzle (if puzzle-locked)                │
├───────────────────────────────────────────────────────────────┤
│ CreateVaultPuzzle(template, roomId, context)                  │
│ ├── If LockType is Puzzle or GuardianAndPuzzle                │
│ │   └── AND PuzzleTemplateId is set                           │
│ ├── Create PuzzlePlacementContext                             │
│ └── Call _puzzlePlacementService.GeneratePuzzle(puzzleContext)│
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Create vault traps (if TrapIds defined)               │
├───────────────────────────────────────────────────────────────┤
│ CreateVaultTraps(template, roomId, context)                   │
│ ├── If template.TrapIds.Count > 0                             │
│ ├── Create TrapPlacementContext                               │
│ └── Call _trapPlacementService.GenerateTraps(trapContext)     │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 6: Create vault configuration                            │
├───────────────────────────────────────────────────────────────┤
│ CreateConfiguration(template, puzzle, traps, context)         │
│ ├── TemplateId = template.Id                                  │
│ ├── LockType = template.LockType                              │
│ ├── PuzzleId = puzzle?.Id                                     │
│ ├── GuardianDefinitionId = template.Guardian?.MonsterDefId    │
│ ├── GuardianLevel = depth + Guardian.LevelOffset              │
│ ├── LootTableId = template.LootTableId                        │
│ ├── RewardMultiplier = template.RewardMultiplier              │
│ └── TrapIds = traps.Select(t => t.Id).ToList()                │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 7: Return VaultGenerationResult                          │
├───────────────────────────────────────────────────────────────┤
│ VaultGenerationResult                                         │
│ ├── Room = createdRoom                                        │
│ ├── Template = selectedTemplate                               │
│ ├── Puzzle = generatedPuzzle (may be null)                    │
│ ├── Traps = generatedTraps (may be empty)                     │
│ └── Configuration = vaultConfiguration                        │
│                                                               │
│ Result stored with dungeon for v0.4.0 interaction             │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Template Filtering Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Context: Depth=6, BiomeId="volcanic-caves", StyleId="ancient" │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Template Pool (from vaults.json)                              │
├───────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ minor-cache                                             │   │
│ │ ├── MinDepth: 1, MaxDepth: 5                           │   │
│ │ ├── AllowedBiomes: [] (all)                            │   │
│ │ ├── AllowedStyles: [] (all)                            │   │
│ │ └── SpawnProbability: 0.15                             │   │
│ │     → IsValidFor(6, "volcanic-caves", "ancient")       │   │
│ │     → Depth 6 > MaxDepth 5: EXCLUDED                    │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ guarded-treasury                                        │   │
│ │ ├── MinDepth: 3, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: [] (all)                            │   │
│ │ ├── AllowedStyles: ["carved-halls", "ancient-temple"]  │   │
│ │ └── SpawnProbability: 0.08                             │   │
│ │     → IsValidFor(6, "volcanic-caves", "ancient")       │   │
│ │     → Style mismatch: EXCLUDED                          │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ puzzle-vault                                            │   │
│ │ ├── MinDepth: 4, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: [] (all)                            │   │
│ │ ├── AllowedStyles: ["ancient-temple"]                  │   │
│ │ └── SpawnProbability: 0.06                             │   │
│ │     → IsValidFor(6, "volcanic-caves", "ancient")       │   │
│ │     → Style mismatch: EXCLUDED                          │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ dragon-hoard                                            │   │
│ │ ├── MinDepth: 8, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: ["volcanic-caves"]                  │   │
│ │ ├── AllowedStyles: ["natural-caves"]                   │   │
│ │ └── SpawnProbability: 0.02                             │   │
│ │     → IsValidFor(6, "volcanic-caves", "ancient")       │   │
│ │     → Depth 6 < MinDepth 8: EXCLUDED                    │   │
│ └─────────────────────────────────────────────────────────┘   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Valid Templates: [] (no valid templates for this context)     │
│ Result: ShouldGenerateVault returns false                     │
│         GenerateVault returns null                            │
└───────────────────────────────────────────────────────────────┘
```

### 3.4 Lock Type Integration

```
┌───────────────────────────────────────────────────────────────┐
│ VaultLockType determines access requirements                   │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ VaultLockType.None                                      │   │
│ │ ├── Freely accessible vault                             │   │
│ │ ├── No puzzle generated                                 │   │
│ │ ├── No guardian assigned                                │   │
│ │ └── May still contain traps                             │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ VaultLockType.Guardian                                  │   │
│ │ ├── Requires defeating guardian monster                 │   │
│ │ ├── GuardianAssignment configured                       │   │
│ │ ├── GuardianLevel = depth + LevelOffset                 │   │
│ │ └── Combat mechanics in v0.4.0                          │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ VaultLockType.Puzzle                                    │   │
│ │ ├── Requires solving puzzle                             │   │
│ │ ├── PuzzleTemplateId references puzzle                  │   │
│ │ ├── IPuzzlePlacementService generates puzzle            │   │
│ │ └── Solve mechanics in v0.4.0                           │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ VaultLockType.GuardianAndPuzzle                         │   │
│ │ ├── Requires BOTH guardian defeat AND puzzle solve      │   │
│ │ ├── Both GuardianAssignment and PuzzleTemplateId set    │   │
│ │ └── Maximum security vaults                             │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ VaultLockType.Key                                       │   │
│ │ ├── Requires specific key item                          │   │
│ │ ├── RequiredKeyId configured                            │   │
│ │ └── Key discovery mechanics in v0.4.0                   │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. VaultLockType Enum

### 4.1 Purpose

The `VaultLockType` enum categorizes the types of locks protecting treasure vaults. Each type determines the access requirements for the vault.

### 4.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Enums/VaultLockType.cs`

### 4.3 Implementation

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of locks protecting treasure vaults.
/// </summary>
/// <remarks>
/// Each lock type determines access requirements for the vault.
/// Unlock mechanics are implemented in v0.4.0.
/// </remarks>
public enum VaultLockType
{
    /// <summary>
    /// No lock, vault is freely accessible.
    /// </summary>
    /// <remarks>
    /// Vault may still contain traps but has no access restriction.
    /// Typically used for minor caches at shallow depths.
    /// </remarks>
    None = 0,

    /// <summary>
    /// Requires defeating a guardian monster.
    /// </summary>
    /// <remarks>
    /// Guardian must be defeated before accessing vault contents.
    /// Guardian level scales with dungeon depth.
    /// Combat mechanics are implemented in v0.4.0.
    /// </remarks>
    Guardian = 1,

    /// <summary>
    /// Requires solving a puzzle.
    /// </summary>
    /// <remarks>
    /// Puzzle must be solved to unlock vault access.
    /// References a PuzzleTemplate via PuzzleTemplateId.
    /// Puzzle mechanics are implemented in v0.4.0.
    /// </remarks>
    Puzzle = 2,

    /// <summary>
    /// Requires both defeating guardian and solving puzzle.
    /// </summary>
    /// <remarks>
    /// Maximum security vault requiring both challenge types.
    /// Used for legendary treasures at deep dungeon levels.
    /// </remarks>
    GuardianAndPuzzle = 3,

    /// <summary>
    /// Requires a specific key item.
    /// </summary>
    /// <remarks>
    /// Key must be found elsewhere in the dungeon.
    /// Key discovery mechanics are implemented in v0.4.0.
    /// </remarks>
    Key = 4
}
```

### 4.4 Type Characteristics Summary

| Type | Access Requirement | Typical Depth | Reward Multiplier |
|------|-------------------|---------------|-------------------|
| None | Free access | 1-5 | 1.0x |
| Guardian | Defeat monster | 3+ | 1.5x |
| Puzzle | Solve puzzle | 4+ | 1.75x |
| GuardianAndPuzzle | Both challenges | 8+ | 3.0x |
| Key | Find key item | Variable | 2.0x |

---

## 5. TreasureRoomTemplate Entity

### 5.1 Purpose

The `TreasureRoomTemplate` entity defines a treasure vault template loaded from JSON configuration. It specifies the vault's characteristics, lock type, guardian, and reward configuration.

### 5.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Definitions/TreasureRoomTemplate.cs`

### 5.3 Implementation

```csharp
namespace RuneAndRust.Domain.Definitions;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines a treasure vault template for dungeon placement.
/// </summary>
/// <remarks>
/// Vault templates specify characteristics including lock type, guardian,
/// rewards, and placement rules. Loaded from vaults.json.
/// Unlock mechanics are implemented in v0.4.0.
/// </remarks>
public class TreasureRoomTemplate : IDefinition
{
    /// <summary>
    /// Gets the unique identifier (e.g., "dragon-hoard").
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description template.
    /// </summary>
    /// <remarks>
    /// Shown to players when entering the vault room.
    /// May include placeholders for biome-specific text.
    /// </remarks>
    public string DescriptionTemplate { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the minimum dungeon depth for this vault type.
    /// </summary>
    /// <remarks>
    /// Vault will not appear above this depth.
    /// More valuable vaults require deeper dungeons.
    /// </remarks>
    public int MinDepth { get; private set; }

    /// <summary>
    /// Gets the maximum dungeon depth (0 = no limit).
    /// </summary>
    /// <remarks>
    /// Vault will not appear below this depth.
    /// Value of 0 means no maximum limit.
    /// </remarks>
    public int MaxDepth { get; private set; }

    /// <summary>
    /// Gets the spawn probability for this vault type.
    /// </summary>
    /// <remarks>
    /// Used in weighted random selection when multiple templates are valid.
    /// Higher values increase selection likelihood.
    /// </remarks>
    public float SpawnProbability { get; private set; }

    /// <summary>
    /// Gets the lock type protecting this vault.
    /// </summary>
    /// <remarks>
    /// Determines what requirements must be met to access the vault.
    /// </remarks>
    public VaultLockType LockType { get; private set; }

    /// <summary>
    /// Gets the puzzle template ID if puzzle-locked.
    /// </summary>
    /// <remarks>
    /// References a PuzzleTemplate for puzzle generation.
    /// Only used when LockType is Puzzle or GuardianAndPuzzle.
    /// Null for non-puzzle-locked vaults.
    /// </remarks>
    public string? PuzzleTemplateId { get; private set; }

    /// <summary>
    /// Gets the guardian configuration if guardian-locked.
    /// </summary>
    /// <remarks>
    /// Specifies the guardian monster for this vault.
    /// Only used when LockType is Guardian or GuardianAndPuzzle.
    /// Null for non-guarded vaults.
    /// </remarks>
    public GuardianAssignment? Guardian { get; private set; }

    /// <summary>
    /// Gets the loot table ID for this vault.
    /// </summary>
    /// <remarks>
    /// References a LootTable for reward generation in v0.4.0.
    /// </remarks>
    public string LootTableId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the reward multiplier for this vault.
    /// </summary>
    /// <remarks>
    /// Multiplies base loot value. Range: 1.0 - 3.0.
    /// Higher multipliers for more difficult vaults.
    /// Applied in v0.4.0 during loot distribution.
    /// </remarks>
    public float RewardMultiplier { get; private set; }

    /// <summary>
    /// Gets biome IDs where this vault can appear (empty = all).
    /// </summary>
    /// <remarks>
    /// Empty list means the vault can appear in any biome.
    /// Non-empty list restricts placement to listed biomes.
    /// </remarks>
    public IReadOnlyList<string> AllowedBiomes { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets architectural styles this vault fits (empty = all).
    /// </summary>
    /// <remarks>
    /// Empty list means the vault fits any architectural style.
    /// Non-empty list restricts placement to listed styles.
    /// </remarks>
    public IReadOnlyList<string> AllowedStyles { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets trap definition IDs that guard this vault.
    /// </summary>
    /// <remarks>
    /// Traps are generated using ITrapPlacementService.
    /// Empty list means no traps guard this vault.
    /// </remarks>
    public IReadOnlyList<string> TrapIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Private constructor for JSON deserialization.
    /// </summary>
    private TreasureRoomTemplate() { }

    /// <summary>
    /// Creates a treasure room template from configuration.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="name">Display name.</param>
    /// <param name="descriptionTemplate">Description template.</param>
    /// <param name="lockType">Lock type.</param>
    /// <param name="lootTableId">Loot table ID.</param>
    /// <returns>A new TreasureRoomTemplate instance.</returns>
    /// <exception cref="ArgumentException">If id or name is null/empty.</exception>
    public static TreasureRoomTemplate Create(
        string id,
        string name,
        string descriptionTemplate,
        VaultLockType lockType,
        string lootTableId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new TreasureRoomTemplate
        {
            Id = id,
            Name = name,
            DescriptionTemplate = descriptionTemplate,
            LockType = lockType,
            LootTableId = lootTableId,
            RewardMultiplier = 1.0f,
            SpawnProbability = 0.1f
        };
    }

    /// <summary>
    /// Checks if this vault is valid for the given context.
    /// </summary>
    /// <param name="depth">The dungeon depth.</param>
    /// <param name="biomeId">The biome ID (null if none).</param>
    /// <param name="styleId">The architectural style ID (null if none).</param>
    /// <returns>True if the vault can be placed in this context.</returns>
    public bool IsValidFor(int depth, string? biomeId, string? styleId)
    {
        // Check depth constraints
        if (depth < MinDepth) return false;
        if (MaxDepth > 0 && depth > MaxDepth) return false;

        // Check biome constraints (empty list = all allowed)
        if (AllowedBiomes.Count > 0 && biomeId != null && !AllowedBiomes.Contains(biomeId))
            return false;

        // Check style constraints (empty list = all allowed)
        if (AllowedStyles.Count > 0 && styleId != null && !AllowedStyles.Contains(styleId))
            return false;

        return true;
    }

    /// <summary>
    /// Gets whether this vault requires a guardian.
    /// </summary>
    public bool RequiresGuardian => LockType is VaultLockType.Guardian or VaultLockType.GuardianAndPuzzle;

    /// <summary>
    /// Gets whether this vault requires a puzzle.
    /// </summary>
    public bool RequiresPuzzle => LockType is VaultLockType.Puzzle or VaultLockType.GuardianAndPuzzle;

    /// <summary>
    /// Gets whether this vault requires a key.
    /// </summary>
    public bool RequiresKey => LockType == VaultLockType.Key;
}
```

### 5.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `string` | Unique identifier | Required |
| `Name` | `string` | Display name | Required |
| `DescriptionTemplate` | `string` | Description with placeholders | Required |
| `MinDepth` | `int` | Minimum placement depth | 0 |
| `MaxDepth` | `int` | Maximum placement depth (0=no limit) | 0 |
| `SpawnProbability` | `float` | Selection probability | 0.1 |
| `LockType` | `VaultLockType` | Lock type | Required |
| `PuzzleTemplateId` | `string?` | Puzzle reference (if puzzle-locked) | null |
| `Guardian` | `GuardianAssignment?` | Guardian config (if guarded) | null |
| `LootTableId` | `string` | Loot table reference | Required |
| `RewardMultiplier` | `float` | Loot multiplier (1.0-3.0) | 1.0 |
| `AllowedBiomes` | `IReadOnlyList<string>` | Valid biomes (empty=all) | Empty |
| `AllowedStyles` | `IReadOnlyList<string>` | Valid styles (empty=all) | Empty |
| `TrapIds` | `IReadOnlyList<string>` | Trap definitions to place | Empty |

---

## 6. GuardianAssignment Value Object

### 6.1 Purpose

The `GuardianAssignment` value object configures a vault guardian monster. It specifies the monster type, level scaling, narrative text, and bonus traits.

### 6.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/GuardianAssignment.cs`

### 6.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Configuration for a vault guardian monster.
/// </summary>
/// <remarks>
/// Guardian combat mechanics are implemented in v0.4.0.
/// This value object stores the configuration for generation.
/// </remarks>
public readonly record struct GuardianAssignment
{
    /// <summary>
    /// Gets the monster definition ID.
    /// </summary>
    /// <remarks>
    /// References a MonsterDefinition from monsters.json.
    /// Determines the base monster type for the guardian.
    /// </remarks>
    public string MonsterDefinitionId { get; init; }

    /// <summary>
    /// Gets the guardian's display name.
    /// </summary>
    /// <remarks>
    /// May override the base monster name for narrative purposes.
    /// E.g., "Hoard Guardian" instead of "Ancient Dragon".
    /// </remarks>
    public string Name { get; init; }

    /// <summary>
    /// Gets the introduction text when encountered.
    /// </summary>
    /// <remarks>
    /// Shown to the player when first entering the vault.
    /// Sets the tone for the guardian encounter.
    /// </remarks>
    public string IntroductionText { get; init; }

    /// <summary>
    /// Gets the defeat text.
    /// </summary>
    /// <remarks>
    /// Shown to the player after defeating the guardian.
    /// Signals that the vault is now accessible.
    /// </remarks>
    public string DefeatText { get; init; }

    /// <summary>
    /// Gets the level offset from dungeon depth.
    /// </summary>
    /// <remarks>
    /// Guardian level = dungeon depth + LevelOffset.
    /// Higher offsets create more challenging guardians.
    /// Typical range: 0 to 5.
    /// </remarks>
    public int LevelOffset { get; init; }

    /// <summary>
    /// Gets bonus trait IDs for this guardian.
    /// </summary>
    /// <remarks>
    /// Additional traits beyond the base monster definition.
    /// E.g., "legendary", "fire-breath", "resilient".
    /// Applied in v0.4.0 during combat.
    /// </remarks>
    public IReadOnlyList<string> BonusTraitIds { get; init; }

    /// <summary>
    /// Creates a guardian assignment.
    /// </summary>
    /// <param name="monsterDefinitionId">The monster definition ID.</param>
    /// <param name="name">The guardian's display name.</param>
    /// <param name="levelOffset">Level offset from depth (default 0).</param>
    /// <returns>A new GuardianAssignment.</returns>
    public static GuardianAssignment Create(
        string monsterDefinitionId,
        string name,
        int levelOffset = 0)
    {
        return new GuardianAssignment
        {
            MonsterDefinitionId = monsterDefinitionId,
            Name = name,
            IntroductionText = string.Empty,
            DefeatText = string.Empty,
            LevelOffset = levelOffset,
            BonusTraitIds = Array.Empty<string>()
        };
    }

    /// <summary>
    /// Calculates the guardian's level based on dungeon depth.
    /// </summary>
    /// <param name="depth">The dungeon depth.</param>
    /// <returns>The guardian's effective level.</returns>
    public int GetLevel(int depth) => depth + LevelOffset;

    /// <summary>
    /// Gets whether this guardian has bonus traits.
    /// </summary>
    public bool HasBonusTraits => BonusTraitIds.Count > 0;

    /// <summary>
    /// Gets a string representation of the guardian assignment.
    /// </summary>
    public override string ToString() =>
        $"{Name} ({MonsterDefinitionId}) [Level offset: +{LevelOffset}]";
}
```

### 6.4 Properties Summary

| Property | Type | Description |
|----------|------|-------------|
| `MonsterDefinitionId` | `string` | Monster type reference |
| `Name` | `string` | Guardian display name |
| `IntroductionText` | `string` | Encounter introduction |
| `DefeatText` | `string` | Victory narration |
| `LevelOffset` | `int` | Level bonus from depth |
| `BonusTraitIds` | `IReadOnlyList<string>` | Additional traits |
| `HasBonusTraits` | `bool` | True if has bonus traits (computed) |

---

## 7. VaultConfiguration Value Object

### 7.1 Purpose

The `VaultConfiguration` value object captures the complete configuration for a generated vault instance. It stores all lock requirements, puzzle/trap references, and reward configuration.

### 7.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/VaultConfiguration.cs`

### 7.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Configuration for a generated vault instance.
/// </summary>
/// <remarks>
/// Captures all vault access requirements and rewards.
/// Used in v0.4.0 for unlock mechanics and loot distribution.
/// </remarks>
public readonly record struct VaultConfiguration
{
    /// <summary>
    /// Gets the template ID used to generate this vault.
    /// </summary>
    public string TemplateId { get; init; }

    /// <summary>
    /// Gets the lock type protecting this vault.
    /// </summary>
    public VaultLockType LockType { get; init; }

    /// <summary>
    /// Gets the puzzle instance ID if puzzle-locked.
    /// </summary>
    /// <remarks>
    /// References the generated PuzzleInstance.
    /// Null if vault is not puzzle-locked.
    /// </remarks>
    public Guid? PuzzleId { get; init; }

    /// <summary>
    /// Gets the guardian monster definition ID if guardian-locked.
    /// </summary>
    /// <remarks>
    /// References the MonsterDefinition for guardian spawning.
    /// Null if vault is not guarded.
    /// </remarks>
    public string? GuardianDefinitionId { get; init; }

    /// <summary>
    /// Gets the guardian's calculated level.
    /// </summary>
    /// <remarks>
    /// Calculated during generation: depth + LevelOffset.
    /// 0 if vault is not guarded.
    /// </remarks>
    public int GuardianLevel { get; init; }

    /// <summary>
    /// Gets the required key item ID if key-locked.
    /// </summary>
    /// <remarks>
    /// References an ItemDefinition for key requirement.
    /// Null if vault is not key-locked.
    /// </remarks>
    public string? RequiredKeyId { get; init; }

    /// <summary>
    /// Gets the loot table ID for rewards.
    /// </summary>
    /// <remarks>
    /// References a LootTable for reward generation in v0.4.0.
    /// </remarks>
    public string LootTableId { get; init; }

    /// <summary>
    /// Gets the reward multiplier.
    /// </summary>
    /// <remarks>
    /// Applied to loot values in v0.4.0.
    /// Range: 1.0 - 3.0.
    /// </remarks>
    public float RewardMultiplier { get; init; }

    /// <summary>
    /// Gets trap instance IDs placed in this vault.
    /// </summary>
    /// <remarks>
    /// References generated TrapInstance entities.
    /// Empty if vault has no traps.
    /// </remarks>
    public IReadOnlyList<Guid> TrapIds { get; init; }

    /// <summary>
    /// Gets whether this vault is guarded.
    /// </summary>
    public bool IsGuarded => LockType is VaultLockType.Guardian or VaultLockType.GuardianAndPuzzle;

    /// <summary>
    /// Gets whether this vault is puzzle-locked.
    /// </summary>
    public bool IsPuzzleLocked => LockType is VaultLockType.Puzzle or VaultLockType.GuardianAndPuzzle;

    /// <summary>
    /// Gets whether this vault is key-locked.
    /// </summary>
    public bool IsKeyLocked => LockType == VaultLockType.Key;

    /// <summary>
    /// Gets whether this vault has traps.
    /// </summary>
    public bool HasTraps => TrapIds.Count > 0;

    /// <summary>
    /// Gets whether this vault is freely accessible.
    /// </summary>
    public bool IsFreelyAccessible => LockType == VaultLockType.None;

    /// <summary>
    /// Gets a string representation of the vault configuration.
    /// </summary>
    public override string ToString()
    {
        var lockDesc = LockType switch
        {
            VaultLockType.None => "Unlocked",
            VaultLockType.Guardian => $"Guarded (Level {GuardianLevel})",
            VaultLockType.Puzzle => "Puzzle-locked",
            VaultLockType.GuardianAndPuzzle => $"Guarded (Level {GuardianLevel}) + Puzzle-locked",
            VaultLockType.Key => $"Key-locked ({RequiredKeyId})",
            _ => "Unknown"
        };

        return $"Vault[{TemplateId}] {lockDesc} (Reward: {RewardMultiplier:F1}x, Traps: {TrapIds.Count})";
    }
}
```

### 7.4 Properties Summary

| Property | Type | Description |
|----------|------|-------------|
| `TemplateId` | `string` | Source template ID |
| `LockType` | `VaultLockType` | Lock type |
| `PuzzleId` | `Guid?` | Puzzle instance reference |
| `GuardianDefinitionId` | `string?` | Guardian monster reference |
| `GuardianLevel` | `int` | Calculated guardian level |
| `RequiredKeyId` | `string?` | Key item reference |
| `LootTableId` | `string` | Loot table reference |
| `RewardMultiplier` | `float` | Loot multiplier |
| `TrapIds` | `IReadOnlyList<Guid>` | Trap instance references |
| `IsGuarded` | `bool` | True if guarded (computed) |
| `IsPuzzleLocked` | `bool` | True if puzzle-locked (computed) |
| `IsKeyLocked` | `bool` | True if key-locked (computed) |
| `HasTraps` | `bool` | True if has traps (computed) |
| `IsFreelyAccessible` | `bool` | True if no lock (computed) |

---

## 8. VaultGenerationService

### 8.1 Purpose

The `VaultGenerationService` generates treasure vaults during dungeon generation. It handles template selection, room creation, and integration with puzzle and trap placement services.

### 8.2 File Locations

**Interface:** `src/Core/RuneAndRust.Application/Interfaces/IVaultGenerationService.cs`
**Implementation:** `src/Core/RuneAndRust.Application/Services/VaultGenerationService.cs`

### 8.3 Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.DTOs;

/// <summary>
/// Service for generating treasure vaults during dungeon generation.
/// </summary>
/// <remarks>
/// Handles vault generation only. Unlock mechanics (combat, puzzles, keys)
/// and loot distribution are implemented in v0.4.0.
/// </remarks>
public interface IVaultGenerationService
{
    /// <summary>
    /// Generates a treasure vault for the given context.
    /// </summary>
    /// <param name="context">The generation context with room information.</param>
    /// <returns>A vault generation result, or null if no valid templates.</returns>
    VaultGenerationResult? GenerateVault(VaultGenerationContext context);

    /// <summary>
    /// Determines if a room should be a vault.
    /// </summary>
    /// <param name="context">The generation context with room information.</param>
    /// <returns>True if a vault should be generated.</returns>
    bool ShouldGenerateVault(VaultGenerationContext context);
}
```

### 8.4 Implementation

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Generates treasure vaults during dungeon generation.
/// </summary>
/// <remarks>
/// Does not handle unlock mechanics (see v0.4.0).
/// Integrates with IPuzzlePlacementService and ITrapPlacementService.
/// </remarks>
public class VaultGenerationService : IVaultGenerationService
{
    private readonly IConfigurationProvider _configurationProvider;
    private readonly IPuzzlePlacementService _puzzlePlacementService;
    private readonly ITrapPlacementService _trapPlacementService;
    private readonly ISeededRandomService _randomService;
    private readonly ILogger<VaultGenerationService> _logger;

    /// <summary>
    /// Initializes a new instance of VaultGenerationService.
    /// </summary>
    /// <param name="configurationProvider">Configuration provider for vault templates.</param>
    /// <param name="puzzlePlacementService">Puzzle placement service for puzzle-locked vaults.</param>
    /// <param name="trapPlacementService">Trap placement service for trapped vaults.</param>
    /// <param name="randomService">Seeded random service for reproducibility.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public VaultGenerationService(
        IConfigurationProvider configurationProvider,
        IPuzzlePlacementService puzzlePlacementService,
        ITrapPlacementService trapPlacementService,
        ISeededRandomService randomService,
        ILogger<VaultGenerationService> logger)
    {
        _configurationProvider = configurationProvider ?? throw new ArgumentNullException(nameof(configurationProvider));
        _puzzlePlacementService = puzzlePlacementService ?? throw new ArgumentNullException(nameof(puzzlePlacementService));
        _trapPlacementService = trapPlacementService ?? throw new ArgumentNullException(nameof(trapPlacementService));
        _randomService = randomService ?? throw new ArgumentNullException(nameof(randomService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public VaultGenerationResult? GenerateVault(VaultGenerationContext context)
    {
        // Filter templates by context
        var templates = _configurationProvider.GetTreasureRoomTemplates()
            .Where(t => t.IsValidFor(context.Depth, context.BiomeId, context.ArchitecturalStyleId))
            .ToList();

        if (templates.Count == 0)
        {
            _logger.LogDebug(
                "No valid vault templates for depth {Depth}, biome {Biome}, style {Style}",
                context.Depth, context.BiomeId, context.ArchitecturalStyleId);
            return null;
        }

        // Select template using probability-weighted random
        var template = SelectTemplate(templates, context);

        // Create vault components
        var room = CreateVaultRoom(template, context);
        var puzzle = CreateVaultPuzzle(template, room.Id, context);
        var traps = CreateVaultTraps(template, room.Id, context).ToList();
        var configuration = CreateConfiguration(template, puzzle, traps, context);

        _logger.LogInformation(
            "Generated vault '{Template}' ({LockType}) at depth {Depth} with {TrapCount} traps",
            template.Id, template.LockType, context.Depth, traps.Count);

        return new VaultGenerationResult
        {
            Room = room,
            Template = template,
            Puzzle = puzzle,
            Traps = traps,
            Configuration = configuration
        };
    }

    /// <inheritdoc />
    public bool ShouldGenerateVault(VaultGenerationContext context)
    {
        // Only treasure rooms become vaults
        if (context.RoomType != RoomType.Treasure)
        {
            _logger.LogDebug(
                "Room {RoomType} is not a treasure room, skipping vault generation",
                context.RoomType);
            return false;
        }

        // Check if any templates are valid for this context
        var hasValidTemplates = _configurationProvider.GetTreasureRoomTemplates()
            .Any(t => t.IsValidFor(context.Depth, context.BiomeId, context.ArchitecturalStyleId));

        _logger.LogDebug(
            "ShouldGenerateVault for depth {Depth}: {Result}",
            context.Depth, hasValidTemplates);

        return hasValidTemplates;
    }

    /// <summary>
    /// Selects a template using probability-weighted random selection.
    /// </summary>
    /// <param name="templates">Available vault templates.</param>
    /// <param name="context">The generation context.</param>
    /// <returns>Selected vault template.</returns>
    private TreasureRoomTemplate SelectTemplate(
        IList<TreasureRoomTemplate> templates,
        VaultGenerationContext context)
    {
        var totalProbability = templates.Sum(t => t.SpawnProbability);
        var roll = (float)(_randomService.NextDouble() * totalProbability);
        var cumulative = 0f;

        foreach (var template in templates)
        {
            cumulative += template.SpawnProbability;
            if (roll < cumulative)
            {
                _logger.LogDebug(
                    "Selected vault template '{Template}' (probability: {Probability}, roll: {Roll}/{Total})",
                    template.Id, template.SpawnProbability, roll, totalProbability);
                return template;
            }
        }

        // Fallback to first template
        _logger.LogWarning("Falling back to first vault template due to probability calculation issue");
        return templates[0];
    }

    /// <summary>
    /// Creates the vault room entity.
    /// </summary>
    /// <param name="template">The vault template.</param>
    /// <param name="context">The generation context.</param>
    /// <returns>A new Room entity.</returns>
    private Room CreateVaultRoom(TreasureRoomTemplate template, VaultGenerationContext context)
    {
        var room = Room.Create(
            context.DungeonId,
            template.Name,
            template.DescriptionTemplate,
            context.Position,
            RoomType.Treasure);

        _logger.LogDebug(
            "Created vault room '{Name}' at position {Position}",
            template.Name, context.Position);

        return room;
    }

    /// <summary>
    /// Creates a puzzle for puzzle-locked vaults.
    /// </summary>
    /// <param name="template">The vault template.</param>
    /// <param name="roomId">The room ID for the puzzle.</param>
    /// <param name="context">The generation context.</param>
    /// <returns>A PuzzleInstance, or null if not puzzle-locked.</returns>
    private PuzzleInstance? CreateVaultPuzzle(
        TreasureRoomTemplate template,
        Guid roomId,
        VaultGenerationContext context)
    {
        // Only create puzzle for puzzle-locked vaults
        if (!template.RequiresPuzzle)
        {
            _logger.LogDebug("Vault '{Template}' does not require a puzzle", template.Id);
            return null;
        }

        if (string.IsNullOrEmpty(template.PuzzleTemplateId))
        {
            _logger.LogWarning(
                "Vault '{Template}' requires puzzle but PuzzleTemplateId is not set",
                template.Id);
            return null;
        }

        var puzzleContext = new PuzzlePlacementContext
        {
            RoomId = roomId,
            Depth = context.Depth,
            BiomeId = context.BiomeId,
            BiomeName = context.BiomeName,
            ArchitecturalStyleId = context.ArchitecturalStyleId,
            WorldSeed = context.WorldSeed,
            RoomType = RoomType.Treasure
        };

        var puzzle = _puzzlePlacementService.GeneratePuzzle(puzzleContext);

        if (puzzle != null)
        {
            _logger.LogDebug(
                "Created puzzle '{PuzzleTemplate}' for vault '{VaultTemplate}'",
                puzzle.TemplateId, template.Id);
        }
        else
        {
            _logger.LogWarning(
                "Failed to create puzzle for vault '{Template}'",
                template.Id);
        }

        return puzzle;
    }

    /// <summary>
    /// Creates traps for the vault.
    /// </summary>
    /// <param name="template">The vault template.</param>
    /// <param name="roomId">The room ID for the traps.</param>
    /// <param name="context">The generation context.</param>
    /// <returns>Generated trap instances.</returns>
    private IEnumerable<TrapInstance> CreateVaultTraps(
        TreasureRoomTemplate template,
        Guid roomId,
        VaultGenerationContext context)
    {
        if (template.TrapIds.Count == 0)
        {
            _logger.LogDebug("Vault '{Template}' has no trap definitions", template.Id);
            yield break;
        }

        var trapContext = new TrapPlacementContext
        {
            RoomId = roomId,
            Depth = context.Depth,
            BiomeId = context.BiomeId,
            BiomeName = context.BiomeName,
            ArchitecturalStyleId = context.ArchitecturalStyleId,
            WorldSeed = context.WorldSeed,
            RoomType = RoomType.Treasure
        };

        foreach (var trap in _trapPlacementService.GenerateTraps(trapContext))
        {
            _logger.LogDebug(
                "Created trap '{TrapDef}' for vault '{VaultTemplate}'",
                trap.DefinitionId, template.Id);
            yield return trap;
        }
    }

    /// <summary>
    /// Creates the vault configuration.
    /// </summary>
    /// <param name="template">The vault template.</param>
    /// <param name="puzzle">The puzzle instance (if any).</param>
    /// <param name="traps">The trap instances.</param>
    /// <param name="context">The generation context.</param>
    /// <returns>A VaultConfiguration capturing all vault details.</returns>
    private VaultConfiguration CreateConfiguration(
        TreasureRoomTemplate template,
        PuzzleInstance? puzzle,
        IEnumerable<TrapInstance> traps,
        VaultGenerationContext context)
    {
        var guardianLevel = template.Guardian?.GetLevel(context.Depth) ?? 0;

        var configuration = new VaultConfiguration
        {
            TemplateId = template.Id,
            LockType = template.LockType,
            PuzzleId = puzzle?.Id,
            GuardianDefinitionId = template.Guardian?.MonsterDefinitionId,
            GuardianLevel = guardianLevel,
            RequiredKeyId = null, // Key assignment is done separately
            LootTableId = template.LootTableId,
            RewardMultiplier = template.RewardMultiplier,
            TrapIds = traps.Select(t => t.Id).ToList()
        };

        _logger.LogDebug(
            "Created vault configuration: {Configuration}",
            configuration);

        return configuration;
    }
}
```

---

## 9. VaultGenerationContext Record

### 9.1 Purpose

The `VaultGenerationContext` record provides context information for vault generation decisions, including room details, position, biome, style, and world seed.

### 9.2 File Location

**File:** `src/Core/RuneAndRust.Application/DTOs/VaultGenerationContext.cs`

### 9.3 Implementation

```csharp
namespace RuneAndRust.Application.DTOs;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Context for vault generation during dungeon creation.
/// </summary>
/// <remarks>
/// Provides all information needed to select and generate
/// an appropriate vault for a treasure room.
/// </remarks>
public record VaultGenerationContext
{
    /// <summary>
    /// Gets the dungeon ID for the vault.
    /// </summary>
    public required Guid DungeonId { get; init; }

    /// <summary>
    /// Gets the room position in the dungeon.
    /// </summary>
    public required Position Position { get; init; }

    /// <summary>
    /// Gets the dungeon depth (Z coordinate).
    /// </summary>
    /// <remarks>
    /// Used for template filtering and guardian level calculation.
    /// </remarks>
    public required int Depth { get; init; }

    /// <summary>
    /// Gets the biome ID (if any).
    /// </summary>
    /// <remarks>
    /// Used for template filtering. Null if room has no biome.
    /// </remarks>
    public string? BiomeId { get; init; }

    /// <summary>
    /// Gets the biome display name.
    /// </summary>
    /// <remarks>
    /// Used for description placeholder replacement.
    /// </remarks>
    public string? BiomeName { get; init; }

    /// <summary>
    /// Gets the architectural style ID (if any).
    /// </summary>
    /// <remarks>
    /// Used for template filtering. Null if room has no style.
    /// </remarks>
    public string? ArchitecturalStyleId { get; init; }

    /// <summary>
    /// Gets the world seed for reproducibility.
    /// </summary>
    /// <remarks>
    /// Ensures consistent vault generation across regenerations.
    /// </remarks>
    public required int WorldSeed { get; init; }

    /// <summary>
    /// Gets the room type.
    /// </summary>
    /// <remarks>
    /// Only RoomType.Treasure rooms become vaults.
    /// </remarks>
    public RoomType? RoomType { get; init; }
}
```

### 9.4 Properties Summary

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `DungeonId` | `Guid` | Yes | The dungeon identifier |
| `Position` | `Position` | Yes | Room position in dungeon |
| `Depth` | `int` | Yes | Dungeon depth for scaling |
| `BiomeId` | `string?` | No | Biome ID for filtering |
| `BiomeName` | `string?` | No | Biome name for descriptions |
| `ArchitecturalStyleId` | `string?` | No | Style ID for filtering |
| `WorldSeed` | `int` | Yes | Seed for reproducibility |
| `RoomType` | `RoomType?` | No | Room type for vault eligibility |

---

## 10. VaultGenerationResult Record

### 10.1 Purpose

The `VaultGenerationResult` record captures the complete output of vault generation, including the room, template, puzzle, traps, and configuration.

### 10.2 File Location

**File:** `src/Core/RuneAndRust.Application/DTOs/VaultGenerationResult.cs`

### 10.3 Implementation

```csharp
namespace RuneAndRust.Application.DTOs;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of vault generation containing all vault components.
/// </summary>
/// <remarks>
/// Captures the complete vault including room, puzzle, traps,
/// and configuration for use by dungeon generator.
/// </remarks>
public record VaultGenerationResult
{
    /// <summary>
    /// Gets the generated vault room.
    /// </summary>
    public required Room Room { get; init; }

    /// <summary>
    /// Gets the template used for generation.
    /// </summary>
    public required TreasureRoomTemplate Template { get; init; }

    /// <summary>
    /// Gets the puzzle instance if puzzle-locked.
    /// </summary>
    /// <remarks>
    /// Null if vault does not require a puzzle.
    /// </remarks>
    public PuzzleInstance? Puzzle { get; init; }

    /// <summary>
    /// Gets the trap instances placed in the vault.
    /// </summary>
    /// <remarks>
    /// Empty if vault has no traps.
    /// </remarks>
    public required IReadOnlyList<TrapInstance> Traps { get; init; }

    /// <summary>
    /// Gets the vault configuration.
    /// </summary>
    /// <remarks>
    /// Contains all lock requirements and reward configuration.
    /// </remarks>
    public required VaultConfiguration Configuration { get; init; }

    /// <summary>
    /// Gets whether this vault has a puzzle.
    /// </summary>
    public bool HasPuzzle => Puzzle != null;

    /// <summary>
    /// Gets whether this vault has traps.
    /// </summary>
    public bool HasTraps => Traps.Count > 0;
}
```

### 10.4 Properties Summary

| Property | Type | Description |
|----------|------|-------------|
| `Room` | `Room` | The generated vault room |
| `Template` | `TreasureRoomTemplate` | Template used |
| `Puzzle` | `PuzzleInstance?` | Puzzle if puzzle-locked |
| `Traps` | `IReadOnlyList<TrapInstance>` | Trap instances |
| `Configuration` | `VaultConfiguration` | Complete vault config |
| `HasPuzzle` | `bool` | True if has puzzle (computed) |
| `HasTraps` | `bool` | True if has traps (computed) |

---

## 11. Configuration File Schemas

### 11.1 Vault Templates Configuration

**File:** `config/vaults.json`

```json
{
  "$schema": "schemas/vaults.schema.json",
  "treasureRoomTemplates": [
    {
      "id": "minor-cache",
      "name": "Hidden Cache",
      "descriptionTemplate": "A small chamber stacked with crates and forgotten supplies.",
      "minDepth": 1,
      "maxDepth": 5,
      "spawnProbability": 0.15,
      "lockType": "None",
      "puzzleTemplateId": null,
      "guardian": null,
      "lootTableId": "vault-minor",
      "rewardMultiplier": 1.0,
      "allowedBiomes": [],
      "allowedStyles": [],
      "trapIds": []
    },
    {
      "id": "guarded-treasury",
      "name": "Guarded Treasury",
      "descriptionTemplate": "An imposing chamber filled with gleaming treasure. A fearsome guardian stands watch.",
      "minDepth": 3,
      "maxDepth": 0,
      "spawnProbability": 0.08,
      "lockType": "Guardian",
      "puzzleTemplateId": null,
      "guardian": {
        "monsterDefinitionId": "guardian-construct",
        "name": "Treasury Guardian",
        "introductionText": "A massive construct stirs to life, ancient runes blazing.",
        "defeatText": "The guardian crumbles. The treasury is yours.",
        "levelOffset": 2,
        "bonusTraitIds": ["resilient"]
      },
      "lootTableId": "vault-guarded",
      "rewardMultiplier": 1.5,
      "allowedBiomes": [],
      "allowedStyles": ["carved-halls", "ancient-temple"],
      "trapIds": ["poison-dart", "pit-trap"]
    },
    {
      "id": "puzzle-vault",
      "name": "Sealed Vault",
      "descriptionTemplate": "A perfectly preserved vault sealed by ancient mechanisms.",
      "minDepth": 4,
      "maxDepth": 0,
      "spawnProbability": 0.06,
      "lockType": "Puzzle",
      "puzzleTemplateId": "combination-lock",
      "guardian": null,
      "lootTableId": "vault-sealed",
      "rewardMultiplier": 1.75,
      "allowedBiomes": [],
      "allowedStyles": ["ancient-temple"],
      "trapIds": ["fire-jet"]
    },
    {
      "id": "dragon-hoard",
      "name": "Dragon's Hoard",
      "descriptionTemplate": "A vast cavern glittering with gold and jewels. An ancient dragon guards this legendary treasure.",
      "minDepth": 8,
      "maxDepth": 0,
      "spawnProbability": 0.02,
      "lockType": "GuardianAndPuzzle",
      "puzzleTemplateId": "cave-riddle",
      "guardian": {
        "monsterDefinitionId": "ancient-dragon",
        "name": "Hoard Guardian",
        "introductionText": "Ancient eyes open. 'Who dares disturb my slumber?'",
        "defeatText": "The dragon falls. The legendary hoard is finally yours.",
        "levelOffset": 5,
        "bonusTraitIds": ["legendary", "fire-breath"]
      },
      "lootTableId": "vault-legendary",
      "rewardMultiplier": 3.0,
      "allowedBiomes": ["volcanic-caves"],
      "allowedStyles": ["natural-caves"],
      "trapIds": ["fire-jet", "cave-in"]
    }
  ]
}
```

### 11.2 JSON Schema

**File:** `config/schemas/vaults.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "vaults.schema.json",
  "title": "Vault Templates Configuration",
  "description": "Schema for treasure vault template definitions",
  "type": "object",
  "required": ["treasureRoomTemplates"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "treasureRoomTemplates": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/treasureRoomTemplate"
      }
    }
  },
  "$defs": {
    "treasureRoomTemplate": {
      "type": "object",
      "required": [
        "id",
        "name",
        "descriptionTemplate",
        "lockType",
        "lootTableId"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier using lowercase with hyphens"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name for the vault"
        },
        "descriptionTemplate": {
          "type": "string",
          "minLength": 1,
          "description": "Room description with optional placeholders"
        },
        "minDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Minimum dungeon depth for placement"
        },
        "maxDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Maximum dungeon depth (0 = no limit)"
        },
        "spawnProbability": {
          "type": "number",
          "minimum": 0.01,
          "maximum": 1.0,
          "default": 0.1,
          "description": "Selection probability weight"
        },
        "lockType": {
          "type": "string",
          "enum": ["None", "Guardian", "Puzzle", "GuardianAndPuzzle", "Key"],
          "description": "Vault lock type"
        },
        "puzzleTemplateId": {
          "type": ["string", "null"],
          "description": "Puzzle template ID for puzzle-locked vaults"
        },
        "guardian": {
          "oneOf": [
            { "type": "null" },
            { "$ref": "#/$defs/guardianAssignment" }
          ],
          "description": "Guardian configuration for guarded vaults"
        },
        "lootTableId": {
          "type": "string",
          "minLength": 1,
          "description": "Reference to loot table for rewards"
        },
        "rewardMultiplier": {
          "type": "number",
          "minimum": 1.0,
          "maximum": 5.0,
          "default": 1.0,
          "description": "Loot value multiplier"
        },
        "allowedBiomes": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Biome IDs where vault can appear (empty = all)"
        },
        "allowedStyles": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Architectural style IDs (empty = all)"
        },
        "trapIds": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Trap definition IDs to place in vault"
        }
      }
    },
    "guardianAssignment": {
      "type": "object",
      "required": ["monsterDefinitionId", "name"],
      "properties": {
        "monsterDefinitionId": {
          "type": "string",
          "minLength": 1,
          "description": "Reference to monster definition"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Guardian display name"
        },
        "introductionText": {
          "type": "string",
          "default": "",
          "description": "Narration when encountered"
        },
        "defeatText": {
          "type": "string",
          "default": "",
          "description": "Narration when defeated"
        },
        "levelOffset": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "default": 0,
          "description": "Level bonus from dungeon depth"
        },
        "bonusTraitIds": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Additional trait IDs for the guardian"
        }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `VaultGenerationService` | Information | Vault generated |
| `VaultGenerationService` | Debug | Template filtering, selection, room creation, puzzle/trap creation |
| `VaultGenerationService` | Warning | No valid templates, puzzle creation failure, fallback selection |
| `TreasureRoomTemplate` | Debug | Validation checks |
| `GuardianAssignment` | Debug | Level calculation |

### 12.2 Log Message Examples

```csharp
// Information
_logger.LogInformation(
    "Generated vault '{Template}' ({LockType}) at depth {Depth} with {TrapCount} traps",
    template.Id, template.LockType, context.Depth, traps.Count);

// Debug
_logger.LogDebug(
    "No valid vault templates for depth {Depth}, biome {Biome}, style {Style}",
    context.Depth, context.BiomeId, context.ArchitecturalStyleId);

_logger.LogDebug(
    "ShouldGenerateVault for depth {Depth}: {Result}",
    context.Depth, hasValidTemplates);

_logger.LogDebug(
    "Selected vault template '{Template}' (probability: {Probability}, roll: {Roll}/{Total})",
    template.Id, template.SpawnProbability, roll, totalProbability);

_logger.LogDebug(
    "Created vault room '{Name}' at position {Position}",
    template.Name, context.Position);

_logger.LogDebug(
    "Created puzzle '{PuzzleTemplate}' for vault '{VaultTemplate}'",
    puzzle.TemplateId, template.Id);

_logger.LogDebug(
    "Created trap '{TrapDef}' for vault '{VaultTemplate}'",
    trap.DefinitionId, template.Id);

_logger.LogDebug(
    "Created vault configuration: {Configuration}",
    configuration);

// Warning
_logger.LogWarning("Falling back to first vault template due to probability calculation issue");

_logger.LogWarning(
    "Vault '{Template}' requires puzzle but PuzzleTemplateId is not set",
    template.Id);

_logger.LogWarning(
    "Failed to create puzzle for vault '{Template}'",
    template.Id);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| VaultLockType enum | ~2 |
| TreasureRoomTemplate entity | ~4 |
| GuardianAssignment value object | ~3 |
| VaultConfiguration value object | ~3 |
| VaultGenerationService | ~5 |
| VaultGenerationContext record | ~2 |
| Configuration loading | ~2 |
| **Total** | **~21** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `VaultLockTypeTests.cs` | ~2 | Enum values, count |
| `TreasureRoomTemplateTests.cs` | ~4 | Create, IsValidFor, RequiresGuardian, RequiresPuzzle |
| `GuardianAssignmentTests.cs` | ~3 | Create, GetLevel, HasBonusTraits |
| `VaultConfigurationTests.cs` | ~3 | Properties, computed flags |
| `VaultGenerationServiceTests.cs` | ~5 | GenerateVault, ShouldGenerateVault, template selection, puzzle/trap integration |
| `VaultGenerationContextTests.cs` | ~2 | Required properties, optional properties |
| `VaultConfigurationLoadingTests.cs` | ~2 | JSON loading, schema validation |

### 13.3 Test Categories

**TreasureRoomTemplate Tests:**
```csharp
[Test]
public void Create_WithValidParameters_CreatesTemplate()

[Test]
public void Create_WithInvalidId_ThrowsArgumentException()

[Test]
public void IsValidFor_WhenDepthBelowMinimum_ReturnsFalse()

[Test]
public void IsValidFor_WhenDepthAboveMaximum_ReturnsFalse()

[Test]
public void RequiresGuardian_WhenLockTypeGuardian_ReturnsTrue()

[Test]
public void RequiresPuzzle_WhenLockTypePuzzle_ReturnsTrue()
```

**GuardianAssignment Tests:**
```csharp
[Test]
public void Create_WithValidParameters_CreatesAssignment()

[Test]
public void GetLevel_CalculatesDepthPlusOffset()

[Test]
public void HasBonusTraits_WhenTraitsExist_ReturnsTrue()
```

**VaultGenerationService Tests:**
```csharp
[Test]
public void GenerateVault_WithValidContext_ReturnsVaultResult()

[Test]
public void GenerateVault_WithNoValidTemplates_ReturnsNull()

[Test]
public void ShouldGenerateVault_ForTreasureRoom_ChecksTemplates()

[Test]
public void ShouldGenerateVault_ForNonTreasureRoom_ReturnsFalse()

[Test]
public void GenerateVault_ForPuzzleLockedVault_CreatesPuzzle()

[Test]
public void GenerateVault_WithTrapIds_CreatesTraps()
```

---

## 14. Use Cases

### UC-001: Generate Vault for Treasure Room

**Actor:** DungeonGeneratorService
**Flow:** Room created with RoomType.Treasure → DungeonGenerator creates VaultGenerationContext → Calls IVaultGenerationService.ShouldGenerateVault (returns true) → Calls GenerateVault → VaultGenerationResult returned with room, puzzle, traps, and configuration

### UC-002: Filter Templates by Depth

**Actor:** VaultGenerationService
**Flow:** Context has Depth=6 → GetTreasureRoomTemplates() returns all templates → IsValidFor filters by depth constraints → Templates with MinDepth <= 6 and (MaxDepth == 0 or MaxDepth >= 6) included

### UC-003: Generate Guardian-Locked Vault

**Actor:** VaultGenerationService
**Flow:** Selected template has LockType=Guardian → Guardian assignment extracted → GuardianLevel calculated as depth + LevelOffset → VaultConfiguration stores GuardianDefinitionId and GuardianLevel

### UC-004: Generate Puzzle-Locked Vault

**Actor:** VaultGenerationService
**Flow:** Selected template has LockType=Puzzle → PuzzleTemplateId extracted → PuzzlePlacementContext created → IPuzzlePlacementService.GeneratePuzzle called → PuzzleInstance stored in VaultGenerationResult

### UC-005: Generate Trapped Vault

**Actor:** VaultGenerationService
**Flow:** Selected template has TrapIds=["poison-dart", "pit-trap"] → TrapPlacementContext created → ITrapPlacementService.GenerateTraps called → TrapInstance list stored in VaultGenerationResult

### UC-006: Calculate Guardian Level

**Actor:** GuardianAssignment
**Flow:** Guardian has LevelOffset=2, context.Depth=5 → GetLevel(5) returns 5 + 2 = 7 → Guardian will be level 7

---

## 15. Deliverable Checklist

### Domain Layer

- [ ] `VaultLockType.cs` created with 5 enum values
- [ ] `TreasureRoomTemplate.cs` created with IDefinition
- [ ] `GuardianAssignment.cs` created as value object
- [ ] `VaultConfiguration.cs` created as value object

### Application Layer

- [ ] `IVaultGenerationService.cs` created
- [ ] `VaultGenerationService.cs` created
- [ ] `VaultGenerationContext.cs` created as record
- [ ] `VaultGenerationResult.cs` created as record

### Infrastructure Layer

- [ ] `IConfigurationProvider.cs` updated with GetTreasureRoomTemplates()
- [ ] `JsonConfigurationProvider.cs` updated to load vault templates

### Configuration Files

- [ ] `config/vaults.json` created with 4 template definitions
- [ ] `config/schemas/vaults.schema.json` created

### Testing

- [ ] `VaultLockTypeTests.cs` created (~2 tests)
- [ ] `TreasureRoomTemplateTests.cs` created (~4 tests)
- [ ] `GuardianAssignmentTests.cs` created (~3 tests)
- [ ] `VaultConfigurationTests.cs` created (~3 tests)
- [ ] `VaultGenerationServiceTests.cs` created (~5 tests)
- [ ] `VaultGenerationContextTests.cs` created (~2 tests)
- [ ] `VaultConfigurationLoadingTests.cs` created (~2 tests)
- [ ] All ~21 tests passing

### Documentation

- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 16. Acceptance Criteria

### Functional

- [ ] VaultLockType enum contains 5 types (None, Guardian, Puzzle, GuardianAndPuzzle, Key)
- [ ] TreasureRoomTemplate loads from `vaults.json` configuration
- [ ] TreasureRoomTemplate.IsValidFor correctly filters by depth, biome, and style
- [ ] TreasureRoomTemplate.RequiresGuardian returns true for Guardian/GuardianAndPuzzle locks
- [ ] TreasureRoomTemplate.RequiresPuzzle returns true for Puzzle/GuardianAndPuzzle locks
- [ ] GuardianAssignment.Create creates guardian configuration
- [ ] GuardianAssignment.GetLevel returns depth + LevelOffset
- [ ] VaultConfiguration captures all lock requirements
- [ ] VaultConfiguration.IsGuarded returns true for guardian-locked vaults
- [ ] VaultConfiguration.IsPuzzleLocked returns true for puzzle-locked vaults
- [ ] VaultGenerationService.ShouldGenerateVault returns false for non-Treasure rooms
- [ ] VaultGenerationService.ShouldGenerateVault checks template availability
- [ ] VaultGenerationService.GenerateVault returns null when no valid templates
- [ ] VaultGenerationService creates puzzles for puzzle-locked vaults via IPuzzlePlacementService
- [ ] VaultGenerationService creates traps for trapped vaults via ITrapPlacementService
- [ ] SelectTemplate uses probability-weighted random selection
- [ ] VaultGenerationResult contains room, template, puzzle, traps, and configuration

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~21 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on public members
- [ ] Code follows .editorconfig conventions
- [ ] No hardcoded vault data outside configuration

---

## 17. Dependencies

### 17.1 Prerequisites (v0.1.5c)

| Component | Purpose for v0.1.5d |
|-----------|---------------------|
| `Room` entity | Target for vault room creation |
| `RoomType` enum | Determines vault eligibility (RoomType.Treasure) |
| `Position` value object | Room position in dungeon |
| `BiomeDefinition` | Biome ID for template filtering |
| `ArchitecturalStyle` | Style ID for template filtering |
| `IConfigurationProvider` | Pattern for loading vault templates |
| `ISeededRandomService` | Reproducible random for selection |
| `IPuzzlePlacementService` | Puzzle generation for puzzle-locked vaults |
| `PuzzlePlacementContext` | Context for puzzle generation |
| `PuzzleInstance` | Generated puzzle entity |
| `ITrapPlacementService` | Trap generation for trapped vaults |
| `TrapPlacementContext` | Context for trap generation |
| `TrapInstance` | Generated trap entity |

### 17.2 Provides to Future Phases

| Component | Used By |
|-----------|---------|
| `TreasureRoomTemplate` | v0.4.0 (unlock mechanics, loot generation) |
| `GuardianAssignment` | v0.4.0 (guardian combat) |
| `VaultConfiguration` | v0.4.0 (unlock state, loot distribution) |
| `VaultLockType` | v0.4.0 (unlock mechanics) |
| `IVaultGenerationService` | DungeonGeneratorService |
| `VaultGenerationResult` | DungeonGeneratorService, v0.4.0 |

### 17.3 Dependency Diagram

```
v0.1.5a (Puzzle Placement System)
    │
    ├── PuzzleTemplate ──────────────────────────────────────────┐
    ├── PuzzleInstance ──────────────────────────────────────────┤
    ├── IPuzzlePlacementService ─────────────────────────────────┤
    └── PuzzlePlacementContext ──────────────────────────────────┤
                                                                 │
v0.1.5c (Trap Placement System)                                  │
    │                                                            │
    ├── TrapDefinition ──────────────────────────────────────────┤
    ├── TrapInstance ────────────────────────────────────────────┤
    ├── ITrapPlacementService ───────────────────────────────────┤
    └── TrapPlacementContext ────────────────────────────────────┘
                                                                 │
                                                                 ▼
v0.1.5d (Treasure Vault Generation)
    │
    ├── VaultLockType ───────────────────────────────────────────┐
    ├── TreasureRoomTemplate ────────────────────────────────────┤
    ├── GuardianAssignment ──────────────────────────────────────┤
    ├── VaultConfiguration ──────────────────────────────────────┤
    ├── VaultGenerationContext ──────────────────────────────────┤
    ├── VaultGenerationResult ───────────────────────────────────┤
    └── IVaultGenerationService ─────────────────────────────────┘
                                                                 │
                                                                 ▼
v0.4.0 (Interactive Environment & Puzzles)
    │
    └── Implements:
        ├── Unlock mechanics (guardian defeat, puzzle solve, key use)
        ├── Guardian combat integration
        ├── Loot distribution with reward multiplier
        ├── Vault state persistence (locked/unlocked)
        └── Key item discovery and usage
```

---

## 18. Future Considerations

### 18.1 Completes v0.1.5

v0.1.5d completes the v0.1.5 (Procedural Puzzles & Secrets) phase:
- v0.1.5a: Puzzle Placement System
- v0.1.5b: Secret Room Generation
- v0.1.5c: Trap Placement System
- v0.1.5d: Treasure Vault Generation (this document)

### 18.2 Deferred to v0.4.0 (Interaction)

- **Unlock mechanics** — Guardian defeat, puzzle solving, key usage
- **Guardian combat** — Combat system integration for guardian encounters
- **Loot distribution** — Applying reward multiplier to loot generation
- **Vault state** — Tracking locked/unlocked state across sessions
- **Key discovery** — Placing keys in dungeon, inventory integration

### 18.3 Out of Scope (Future Versions)

- **Multi-chamber vaults** — Vaults spanning multiple connected rooms
- **Progressive unlocking** — Vaults that unlock in stages
- **Dynamic guardians** — Guardians that patrol or respawn
- **Vault traps that reset** — Traps that rearm after vault is looted
- **Vault rankings/tiers** — Additional categorization beyond templates
- **Shared loot between players** — Multiplayer loot distribution

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
