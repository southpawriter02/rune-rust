# v0.18.3 Scope Breakdown: Trauma System

## Overview

v0.18.3 implements the **Trauma System** — the permanent consequence mechanic that occurs when characters fail Breaking Point checks at 100 Psychic Stress. Traumas are irremovable character-defining penalties that accumulate until the character becomes unplayable.

---

## Feature Tree

```
v0.18.3 — Trauma System
├── Domain Layer
│   ├── TraumaType (enum)
│   ├── TraumaDefinition (entity)
│   ├── CharacterTrauma (entity)
│   ├── TraumaCheckOutcome (enum)
│   └── TraumaCheckResult (record)
│
├── Application Layer
│   ├── ITraumaService (interface)
│   └── TraumaService (implementation)
│
├── Infrastructure Layer
│   ├── ITraumaProvider (interface)
│   ├── TraumaProvider (JSON loader)
│   └── Database schema
│
├── Configuration
│   ├── traumas.json
│   └── traumas.schema.json
│
└── Tests (~15 unit tests)
```

---

## In Scope

### Domain Layer

#### TraumaType Enum

```csharp
/// <summary>
/// Categorizes the types of permanent traumas a character can acquire.
/// </summary>
public enum TraumaType
{
    /// <summary>Fear of specific triggers causing dice penalties.</summary>
    Phobia,

    /// <summary>Compulsive behavior requiring WILL checks to resist.</summary>
    Compulsion,

    /// <summary>Gaps in memory and knowledge.</summary>
    MemoryFragmentation,

    /// <summary>False sensory input and hallucinations.</summary>
    PerceptionDistortion,

    /// <summary>Disturbed sleep affecting rest recovery.</summary>
    Nightmares,

    /// <summary>Inability to trust allies.</summary>
    Paranoia,

    /// <summary>Corruption-induced machine affinity.</summary>
    MachineAffinity,

    /// <summary>Physical manifestation of Blight exposure.</summary>
    BlightMutation
}
```

#### TraumaCheckOutcome Enum

```csharp
/// <summary>
/// Possible outcomes of a Trauma Check at Breaking Point.
/// </summary>
public enum TraumaCheckOutcome
{
    /// <summary>4+ successes: Heroic Moment. Stress to 60, gain Legend Point.</summary>
    CriticalSuccess,

    /// <summary>1-3 successes: Stabilized. Stress to 75, Disoriented 2 turns.</summary>
    Success,

    /// <summary>0 successes: Trauma acquired. Stress to 50, Stunned 1 turn.</summary>
    Failure,

    /// <summary>Botch: Severe Trauma or Stage 4. Stress to 50, Stunned 2 turns.</summary>
    CriticalFailure
}
```

#### TraumaDefinition Entity

```csharp
/// <summary>
/// Defines a type of permanent trauma that can be acquired.
/// </summary>
public sealed class TraumaDefinition
{
    /// <summary>Unique identifier for this trauma.</summary>
    public string Id { get; init; } = string.Empty;

    /// <summary>Display name of the trauma.</summary>
    public string Name { get; init; } = string.Empty;

    /// <summary>Category of trauma.</summary>
    public TraumaType Type { get; init; }

    /// <summary>Description of the trauma's effects.</summary>
    public string Description { get; init; } = string.Empty;

    /// <summary>Flavor text for narrative display.</summary>
    public string FlavorText { get; init; } = string.Empty;

    /// <summary>Mechanical effect description.</summary>
    public string MechanicalEffect { get; init; } = string.Empty;

    /// <summary>Dice penalty when trigger is active.</summary>
    public int DicePenalty { get; init; }

    /// <summary>Trigger condition for phobias.</summary>
    public string? TriggerCondition { get; init; }

    /// <summary>WILL DC to resist compulsions.</summary>
    public int? ResistDc { get; init; }

    /// <summary>Whether this is a severe trauma (counts as 2).</summary>
    public bool IsSevere { get; init; }

    /// <summary>Corruption source (for Machine Affinity, etc.).</summary>
    public string? CorruptionSource { get; init; }
}
```

#### CharacterTrauma Entity

```csharp
/// <summary>
/// Represents a permanent trauma acquired by a character.
/// Traumas are irremovable under normal gameplay conditions.
/// </summary>
public sealed class CharacterTrauma
{
    /// <summary>Unique instance ID.</summary>
    public Guid Id { get; init; }

    /// <summary>Character who has this trauma.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>Reference to the trauma definition.</summary>
    public string TraumaDefinitionId { get; init; } = string.Empty;

    /// <summary>When the trauma was acquired.</summary>
    public DateTime AcquiredAt { get; init; }

    /// <summary>Source event that caused the trauma.</summary>
    public string AcquiredFrom { get; init; } = string.Empty;

    /// <summary>Number of times the trauma has triggered.</summary>
    public int TriggerCount { get; private set; }

    /// <summary>Whether this is a severe trauma (counts as 2).</summary>
    public bool IsSevere { get; init; }

    /// <summary>Records a trigger of this trauma.</summary>
    public void RecordTrigger() => TriggerCount++;
}
```

#### TraumaCheckResult Record

```csharp
/// <summary>
/// Result of performing a Trauma Check at Breaking Point.
/// </summary>
public sealed record TraumaCheckResult
{
    /// <summary>Character who made the check.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>WILL dice rolled.</summary>
    public int DiceRolled { get; init; }

    /// <summary>DC for the check.</summary>
    public int Dc { get; init; }

    /// <summary>Number of successes achieved.</summary>
    public int Successes { get; init; }

    /// <summary>Whether a botch occurred.</summary>
    public bool Botched { get; init; }

    /// <summary>Outcome category.</summary>
    public TraumaCheckOutcome Outcome { get; init; }

    /// <summary>New stress value after check.</summary>
    public int NewStress { get; init; }

    /// <summary>Trauma acquired (null if none).</summary>
    public TraumaDefinition? TraumaAcquired { get; init; }

    /// <summary>Status effects applied.</summary>
    public IReadOnlyList<string> StatusEffects { get; init; } = Array.Empty<string>();

    /// <summary>Duration of status effects.</summary>
    public int StatusEffectDuration { get; init; }

    /// <summary>Whether character became unplayable.</summary>
    public bool CharacterRetired { get; init; }

    /// <summary>Whether Legend Point was gained.</summary>
    public bool GainedLegendPoint { get; init; }
}
```

### Application Layer

#### ITraumaService Interface

```csharp
/// <summary>
/// Service for managing the Trauma system.
/// </summary>
public interface ITraumaService
{
    /// <summary>Gets all traumas for a character.</summary>
    IReadOnlyList<CharacterTrauma> GetCharacterTraumas(Guid characterId);

    /// <summary>Gets the trauma count (severe traumas count as 2).</summary>
    int GetTraumaCount(Guid characterId);

    /// <summary>
    /// Performs a Trauma Check when Stress reaches 100.
    /// </summary>
    /// <param name="characterId">Character making the check.</param>
    /// <param name="dc">Difficulty class (default 3).</param>
    /// <returns>Result of the Trauma Check.</returns>
    TraumaCheckResult PerformTraumaCheck(Guid characterId, int dc = 3);

    /// <summary>
    /// Assigns a specific trauma to a character.
    /// </summary>
    CharacterTrauma AssignTrauma(
        Guid characterId,
        string traumaDefinitionId,
        string source);

    /// <summary>
    /// Assigns a random trauma from the trauma pool.
    /// </summary>
    CharacterTrauma AssignRandomTrauma(Guid characterId, string source);

    /// <summary>
    /// Checks if a character's trauma is triggered by a condition.
    /// </summary>
    TraumaTriggerResult CheckTraumaTrigger(
        Guid characterId,
        string triggerCondition);

    /// <summary>
    /// Checks if character has reached trauma limit (unplayable).
    /// </summary>
    bool IsCharacterRetired(Guid characterId);

    /// <summary>
    /// Gets all available trauma definitions.
    /// </summary>
    IReadOnlyList<TraumaDefinition> GetAllTraumaDefinitions();

    /// <summary>
    /// Records a trauma being triggered in combat/exploration.
    /// </summary>
    void RecordTraumaTrigger(Guid characterId, string traumaDefinitionId);
}
```

#### TraumaTriggerResult Record

```csharp
/// <summary>
/// Result of checking if a character's trauma is triggered.
/// </summary>
public sealed record TraumaTriggerResult
{
    /// <summary>Whether any trauma was triggered.</summary>
    public bool Triggered { get; init; }

    /// <summary>The triggered trauma (if any).</summary>
    public CharacterTrauma? TriggeredTrauma { get; init; }

    /// <summary>The trauma definition.</summary>
    public TraumaDefinition? TraumaDefinition { get; init; }

    /// <summary>Dice penalty to apply.</summary>
    public int DicePenalty { get; init; }

    /// <summary>Whether a WILL check is required.</summary>
    public bool RequiresWillCheck { get; init; }

    /// <summary>DC for the WILL check.</summary>
    public int? WillCheckDc { get; init; }
}
```

### Infrastructure Layer

#### ITraumaProvider Interface

```csharp
/// <summary>
/// Provider for loading trauma definitions from configuration.
/// </summary>
public interface ITraumaProvider
{
    /// <summary>Gets all trauma definitions.</summary>
    IReadOnlyList<TraumaDefinition> GetAllTraumas();

    /// <summary>Gets a trauma by ID.</summary>
    TraumaDefinition? GetTraumaById(string id);

    /// <summary>Gets traumas by type.</summary>
    IReadOnlyList<TraumaDefinition> GetTraumasByType(TraumaType type);

    /// <summary>Gets traumas that can be randomly assigned.</summary>
    IReadOnlyList<TraumaDefinition> GetRandomAssignableTraumas();
}
```

#### Database Schema

```sql
-- Character traumas table
CREATE TABLE IF NOT EXISTS character_traumas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    trauma_definition_id VARCHAR(50) NOT NULL,
    acquired_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    acquired_from VARCHAR(100) NOT NULL,
    trigger_count INT NOT NULL DEFAULT 0,
    is_severe BOOLEAN NOT NULL DEFAULT false,

    UNIQUE(character_id, trauma_definition_id)
);

CREATE INDEX idx_character_traumas_char ON character_traumas(character_id);

-- Trauma check history
CREATE TABLE IF NOT EXISTS trauma_check_history (
    id SERIAL PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    dice_rolled INT NOT NULL,
    dc INT NOT NULL,
    successes INT NOT NULL,
    botched BOOLEAN NOT NULL DEFAULT false,
    outcome VARCHAR(20) NOT NULL,
    trauma_acquired_id VARCHAR(50),
    new_stress INT NOT NULL,
    character_retired BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_trauma_check_history_char ON trauma_check_history(character_id);
```

### Configuration

#### traumas.json

```json
{
  "version": "1.0",
  "maxTraumaCount": 5,
  "severeTraumaCountsAs": 2,
  "traumaDefinitions": [
    {
      "id": "phobia_darkness",
      "name": "Nyctophobia",
      "type": "Phobia",
      "description": "Paralyzing fear of darkness and unlit spaces.",
      "flavorText": "The dark isn't empty. It's full of things that the light keeps away.",
      "mechanicalEffect": "-2 dice when in darkness or dim light.",
      "dicePenalty": 2,
      "triggerCondition": "darkness",
      "isSevere": false
    },
    {
      "id": "phobia_forlorn",
      "name": "Forlorn Terror",
      "type": "Phobia",
      "description": "Crippling fear of Forlorn entities.",
      "flavorText": "They used to be people. Now they're the static between channels.",
      "mechanicalEffect": "-2 dice when Forlorn are present.",
      "dicePenalty": 2,
      "triggerCondition": "forlorn_presence",
      "isSevere": false
    },
    {
      "id": "phobia_heights",
      "name": "Acrophobia",
      "type": "Phobia",
      "description": "Severe fear of heights and falling.",
      "flavorText": "The ground is the only thing that's real. Everything else is just waiting to drop you.",
      "mechanicalEffect": "-2 dice when at height or climbing.",
      "dicePenalty": 2,
      "triggerCondition": "heights",
      "isSevere": false
    },
    {
      "id": "compulsion_counting",
      "name": "Arithmomania",
      "type": "Compulsion",
      "description": "Must count things before acting.",
      "flavorText": "Three steps. Seven breaths. Twenty-one tiles. It has to be right.",
      "mechanicalEffect": "WILL DC 2 to avoid counting delay.",
      "resistDc": 2,
      "isSevere": false
    },
    {
      "id": "compulsion_checking",
      "name": "Verification Compulsion",
      "type": "Compulsion",
      "description": "Must repeatedly verify equipment and surroundings.",
      "flavorText": "Did I lock it? Check again. Are we alone? Check again.",
      "mechanicalEffect": "WILL DC 2 to avoid repeated checking.",
      "resistDc": 2,
      "isSevere": false
    },
    {
      "id": "memory_names",
      "name": "Name Blindness",
      "type": "MemoryFragmentation",
      "description": "Cannot remember names of people or places.",
      "flavorText": "I know your face. I know we've met. But the word for you is... gone.",
      "mechanicalEffect": "Cannot benefit from NPC relationship bonuses.",
      "isSevere": false
    },
    {
      "id": "memory_skills",
      "name": "Skill Amnesia",
      "type": "MemoryFragmentation",
      "description": "Random skill becomes unavailable each day.",
      "flavorText": "I used to know how to do this. Yesterday. I'm sure of it.",
      "mechanicalEffect": "One random skill locked per long rest.",
      "isSevere": true
    },
    {
      "id": "perception_shadows",
      "name": "Shadow Sight",
      "type": "PerceptionDistortion",
      "description": "See movement in shadows that isn't there.",
      "flavorText": "They're watching. In the corners. Always in the corners.",
      "mechanicalEffect": "Disadvantage on Perception in dim light.",
      "dicePenalty": 0,
      "triggerCondition": "dim_light",
      "isSevere": false
    },
    {
      "id": "perception_voices",
      "name": "The Whispers",
      "type": "PerceptionDistortion",
      "description": "Hear voices in ambient noise.",
      "flavorText": "The static speaks. Sometimes it even makes sense.",
      "mechanicalEffect": "Disadvantage on hearing-based checks.",
      "dicePenalty": 0,
      "isSevere": false
    },
    {
      "id": "nightmares_standard",
      "name": "The Recurring Dream",
      "type": "Nightmares",
      "description": "Disturbed sleep reduces rest effectiveness.",
      "flavorText": "Every night, the same place. The same screaming. The same falling.",
      "mechanicalEffect": "Long Rest may only restore 50% resources (WILL check).",
      "resistDc": 2,
      "isSevere": false
    },
    {
      "id": "nightmares_prophetic",
      "name": "Prophetic Terrors",
      "type": "Nightmares",
      "description": "Dreams that sometimes come true.",
      "flavorText": "I've seen tomorrow. I didn't like it.",
      "mechanicalEffect": "Long Rest 50% chance reduced recovery; occasional plot hooks.",
      "resistDc": 3,
      "isSevere": true
    },
    {
      "id": "paranoia_standard",
      "name": "Trust No One",
      "type": "Paranoia",
      "description": "Cannot trust allies or benefit from their presence.",
      "flavorText": "They're all waiting. Waiting for me to slip.",
      "mechanicalEffect": "Cannot benefit from ally adjacency bonuses.",
      "isSevere": false
    },
    {
      "id": "paranoia_severe",
      "name": "Everyone is an Enemy",
      "type": "Paranoia",
      "description": "Actively suspicious of all allies.",
      "flavorText": "Smiles hide knives. Kindness hides poison. Everyone wants something.",
      "mechanicalEffect": "Cannot benefit from ally healing/buffs. May refuse help.",
      "isSevere": true
    },
    {
      "id": "machine_affinity",
      "name": "Machine Affinity",
      "type": "MachineAffinity",
      "description": "Corruption-induced sympathy with machine entities.",
      "flavorText": "The machines understand. They don't judge. They just... process.",
      "mechanicalEffect": "+2 Tech checks, -2 Social checks with humans.",
      "corruptionSource": "corruption_75",
      "isSevere": false
    }
  ],
  "traumaCheckMechanics": {
    "defaultDc": 3,
    "outcomes": {
      "criticalSuccess": {
        "minSuccesses": 4,
        "stressReset": 60,
        "legendPoint": true,
        "statusEffects": [],
        "description": "Heroic Moment - character overcomes with resolve"
      },
      "success": {
        "minSuccesses": 1,
        "maxSuccesses": 3,
        "stressReset": 75,
        "statusEffects": ["Disoriented"],
        "statusDuration": 2,
        "description": "Stabilized - shaken but holding together"
      },
      "failure": {
        "successes": 0,
        "stressReset": 50,
        "traumaAssigned": true,
        "statusEffects": ["Stunned"],
        "statusDuration": 1,
        "description": "Breaking Point - trauma acquired"
      },
      "criticalFailure": {
        "botch": true,
        "stressReset": 50,
        "severeTrauma": true,
        "statusEffects": ["Stunned"],
        "statusDuration": 2,
        "description": "Catastrophic break - severe trauma or Stage 4"
      }
    }
  }
}
```

---

## Out of Scope

The following are explicitly **not** included in v0.18.3:

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Trauma removal/healing | v0.22.x | Quest/ritual system |
| Trauma-specific abilities | v0.20.x | Ability system |
| Retired character conversion to NPC | v0.21.x | Enemy/NPC system |
| Legend Point system | v0.23.x | Meta-progression |
| Nightmare plot hook generation | v0.24.x | Narrative system |

---

## Unit Tests (~15 tests)

### TraumaDefinition Tests

| Test | Description |
|------|-------------|
| `TraumaDefinition_LoadsFromJson` | Verify JSON deserialization |
| `TraumaDefinition_HasRequiredFields` | All required fields present |

### TraumaService Tests

| Test | Description |
|------|-------------|
| `GetTraumaCount_CountsSevereAsTwo` | Severe trauma = 2 count |
| `GetTraumaCount_ReturnsZeroForNoTraumas` | Clean character returns 0 |
| `PerformTraumaCheck_CriticalSuccess_ReturnsCorrectOutcome` | 4+ successes handled |
| `PerformTraumaCheck_Success_SetsStressTo75` | 1-3 successes handled |
| `PerformTraumaCheck_Failure_AssignsTrauma` | 0 successes assigns trauma |
| `PerformTraumaCheck_CriticalFailure_AssignsSevereTrauma` | Botch handled |
| `AssignTrauma_CreatesCharacterTrauma` | Trauma correctly linked |
| `AssignRandomTrauma_SelectsFromPool` | Random selection works |
| `CheckTraumaTrigger_ReturnsCorrectPenalty` | Trigger detection works |
| `IsCharacterRetired_TrueAtLimit` | 5+ traumas = retired |
| `IsCharacterRetired_FalseUnderLimit` | Under limit = active |
| `RecordTraumaTrigger_IncrementsCount` | Trigger count tracks |

---

## Acceptance Criteria

### Functional Requirements

- [ ] Trauma Check triggers at 100 stress
- [ ] WILL vs DC 3 determines outcome
- [ ] Critical Success (4+) resets stress to 60, grants Legend Point
- [ ] Success (1-3) resets stress to 75, applies Disoriented
- [ ] Failure (0) assigns random trauma, resets stress to 50
- [ ] Critical Failure (botch) assigns severe trauma
- [ ] Severe traumas count as 2 toward limit
- [ ] Character retired at 5+ trauma count
- [ ] Traumas correctly trigger on conditions

### Quality Requirements

- [ ] All trauma definitions have XML documentation
- [ ] Trauma configuration externalized to JSON
- [ ] Unit test coverage ≥ 90%
- [ ] Trauma history persisted for analytics

---

## Dependencies

### Requires

| Dependency | Purpose |
|------------|---------|
| Stress System (v0.18.0) | Breaking Point trigger |
| Dice System (v0.6.x) | WILL checks |
| Status Effect System (v0.10.x) | Stunned, Disoriented |
| Attribute System (v0.17.2) | WILL attribute |

### Provides

| Feature | Consumer |
|---------|----------|
| `TraumaCheckResult` | Stress system callback |
| `TraumaTriggerResult` | Combat/skill system |
| Character retirement | Character system |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial scope breakdown |
