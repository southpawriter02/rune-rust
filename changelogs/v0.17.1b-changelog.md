# Changelog: v0.17.1b - Background Skill Grants

**Release Date:** 2026-01-29
**Phase:** Background System (2/5)
**Status:** Complete

---

## Overview

Implements skill grants for the Background system. Each background now grants professional skill bonuses reflecting the character's pre-Silence occupation. This adds the `SkillGrantType` enum, `BackgroundSkillGrant` value object, and extends `BackgroundDefinition` with skill grant properties and helper methods.

Skill grants follow a standard pattern: each background provides a primary skill (+2) representing core professional expertise and a secondary skill (+1) representing related knowledge. All standard grants use the `Permanent` grant type, though the enum supports `StartingBonus` and `Proficiency` for future flexibility.

---

## Added

### Domain Layer

#### Enums

- **`SkillGrantType`** (`Enums/SkillGrantType.cs`)
    - Enum defining how skill grants are applied: `Permanent = 0`, `StartingBonus = 1`, `Proficiency = 2`
    - Explicit integer values for stable serialization
    - Comprehensive XML documentation with remarks and examples per value
    - `Permanent`: Added to base skill value, stacks with other bonuses
    - `StartingBonus`: Initial advantage, subsumed by later training
    - `Proficiency`: Removes -2 untrained penalty, no numeric bonus

#### Value Objects

- **`BackgroundSkillGrant`** (`ValueObjects/BackgroundSkillGrant.cs`)
    - `readonly record struct` with `SkillId`, `BonusAmount`, `GrantType`
    - Factory method `Create(...)` with full validation:
        - Null/whitespace skillId throws `ArgumentException`
        - Negative bonusAmount throws `ArgumentOutOfRangeException`
        - Normalizes skillId to lowercase via `ToLowerInvariant()`
    - Convenience factory methods:
        - `Permanent(skillId, bonusAmount)`: Creates a permanent grant
        - `Starting(skillId, bonusAmount)`: Creates a starting bonus grant
        - `Proficient(skillId)`: Creates a proficiency grant (bonus = 0)
    - Computed properties:
        - `IsPermanent`: True if grant type is Permanent
        - `IsStartingBonus`: True if grant type is StartingBonus
        - `IsProficiency`: True if grant type is Proficiency
        - `HasNumericBonus`: True if bonus amount is positive
    - `ToString()` formats as "skillId +N", "skillId +N (starting)", or "skillId (proficient)"
    - Structured logging at Debug and Information levels during creation

### Entity Extensions

- **`BackgroundDefinition`** (`Entities/BackgroundDefinition.cs`) — Extended
    - Added `SkillGrants` property (`IReadOnlyList<BackgroundSkillGrant>`)
    - Updated private constructor with default: `SkillGrants = Array.Empty<BackgroundSkillGrant>()`
    - Updated `Create()` factory: added `skillGrants` optional parameter
    - Added skill grant helper methods:
        - `HasSkillGrants()`: Returns true if any skill grants exist
        - `GetPrimarySkillGrant()`: Returns highest bonus grant (typically +2)
        - `GetSecondarySkillGrant()`: Returns second highest bonus grant (typically +1)
        - `GetSkillGrantSummary()`: Comma-separated display string (e.g., "craft +2, might +1")
        - `GetTotalSkillBonus()`: Sum of all bonus amounts (typically 3)
    - Updated `ToString()` to include `Skills={count}`
    - Updated logging to include SkillGrantCount
    - Version header bumped to 0.17.1b

### Configuration Files

- **`config/backgrounds.json`** — Updated
    - Added `skillGrants` array to all 6 backgrounds:
        - Village Smith: craft +2, might +1
        - Traveling Healer: medicine +2, herbalism +1
        - Ruin Delver: exploration +2, traps +1
        - Clan Guard: combat +2, vigilance +1
        - Wandering Skald: performance +2, lore +1
        - Outcast Scavenger: survival +2, stealth +1
    - All grants use `"grantType": "Permanent"`

- **`config/schemas/backgrounds.schema.json`** — Updated
    - Added `skillGrant` definition to `$defs` with:
        - `skillId`: pattern `^[a-z][a-z0-9-]*$`, maxLength 50
        - `bonusAmount`: integer, minimum 0, maximum 5
        - `grantType`: enum ["Permanent", "StartingBonus", "Proficiency"]
    - Added `skillGrants` array property to `backgroundDefinition` (maxItems: 5)

### Unit Tests

- **`SkillGrantTypeTests`** (`Enums/SkillGrantTypeTests.cs`) — 2 tests
    - `SkillGrantType_HasThreeValues_CountEquals3`: Verifies enum count
    - `SkillGrantType_ValuesHaveExpectedIntegers`: Verifies integer assignments

- **`BackgroundSkillGrantTests`** (`ValueObjects/BackgroundSkillGrantTests.cs`) — 12 tests
    - `Create_WithValidParameters_CreatesGrant`: Full creation with all properties
    - `Create_WithNullSkillId_ThrowsArgumentException`: Null validation
    - `Create_WithEmptySkillId_ThrowsArgumentException`: Empty string validation
    - `Create_WithWhitespaceSkillId_ThrowsArgumentException`: Whitespace validation
    - `Create_WithNegativeBonusAmount_ThrowsArgumentOutOfRangeException`: Negative validation
    - `Create_NormalizesSkillIdToLowercase`: Case normalization
    - `Permanent_CreatesPermanentGrant`: Convenience factory
    - `Starting_CreatesStartingBonusGrant`: Convenience factory
    - `Proficient_CreatesProficiencyGrant`: Convenience factory
    - `IsPermanent_WithPermanentType_ReturnsTrue`: Computed property
    - `HasNumericBonus_WithPositiveAmount_ReturnsTrue`: Computed property
    - `ToString_FormatsCorrectly`: All three format variants

- **`BackgroundDefinitionSkillGrantTests`** (`Entities/BackgroundDefinitionSkillGrantTests.cs`) — 12 tests
    - `Create_WithSkillGrants_StoresGrants`: Property storage
    - `Create_WithoutSkillGrants_DefaultsToEmptyList`: Optional parameter default
    - `HasSkillGrants_WithGrants_ReturnsTrue`: Helper method
    - `HasSkillGrants_WithoutGrants_ReturnsFalse`: Helper method
    - `GetPrimarySkillGrant_ReturnsHighestBonus`: Primary grant selection
    - `GetPrimarySkillGrant_WithNoGrants_ReturnsNull`: Edge case
    - `GetSecondarySkillGrant_ReturnsSecondHighestBonus`: Secondary grant selection
    - `GetSecondarySkillGrant_WithSingleGrant_ReturnsNull`: Edge case
    - `GetSkillGrantSummary_FormatsCorrectly`: Display formatting
    - `GetSkillGrantSummary_WithNoGrants_ReturnsFallbackText`: Fallback
    - `GetTotalSkillBonus_SumsAllBonuses`: Total calculation
    - `VillageSmith_GrantsCraftPlus2MightPlus1`: Background-specific verification
    - `ToString_IncludesSkillGrantCount`: Debug representation

---

## Design Decisions

### SkillGrantType Enum Values

- Three grant types support the full range of background skill interactions:
    - `Permanent` is used for all standard background grants
    - `StartingBonus` and `Proficiency` support future design flexibility
- Explicit integer values (0, 1, 2) ensure stable serialization

### Value Object Pattern

- `BackgroundSkillGrant` follows the same `readonly record struct` pattern as other value objects in the domain
- Factory methods with validation ensure all instances are valid
- SkillId normalization to lowercase prevents case-sensitivity issues in skill lookups

### BackgroundDefinition Extension Pattern

- The incremental extension pattern (v0.17.1a → b → c) allows each version to add properties without breaking existing code
- Optional parameters in `Create()` maintain backward compatibility with v0.17.1a tests
- Helper methods provide convenient access patterns for the creation UI

---

## Dependencies

### Prerequisites

- v0.17.1a (Background Enum & Definition) — Complete

### Provides to v0.17.1c

| Type | Usage |
| ---- | ----- |
| `BackgroundSkillGrant` | Referenced in BackgroundDefinition alongside EquipmentGrants |
| Extended `BackgroundDefinition` | Further extended with EquipmentGrants property |

### Provides to v0.17.1d-e

| Type | Usage |
| ---- | ----- |
| `BackgroundSkillGrant` | Applied during character creation by IBackgroundApplicationService |
| `SkillGrantType` | Determines how skill bonuses are mechanically applied |
