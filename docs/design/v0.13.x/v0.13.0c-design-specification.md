# v0.13.0c Design Specification: Combo System Display

**Version:** 0.13.0c
**Parent:** v0.13.0 (Combat UI)
**Prerequisites:** v0.12.1c Complete (Achievements & Leaderboards), v0.10.3b Complete (Combo Detection)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Combo Chain Indicator Component](#4-combo-chain-indicator-component)
   - 4.1 [ComboChainIndicator Class](#41-combochainindicator-class)
   - 4.2 [Chain Sequence Rendering](#42-chain-sequence-rendering)
   - 4.3 [Step State Visualization](#43-step-state-visualization)
5. [Combo Renderer](#5-combo-renderer)
   - 5.1 [ComboRenderer Class](#51-comborenderer-class)
   - 5.2 [Chain Step Formatting](#52-chain-step-formatting)
   - 5.3 [Color Mapping](#53-color-mapping)
6. [Combo Available Prompt](#6-combo-available-prompt)
   - 6.1 [Continuation Options Display](#61-continuation-options-display)
   - 6.2 [Window Timer Display](#62-window-timer-display)
7. [Combo Bonus Display](#7-combo-bonus-display)
   - 7.1 [Multiplier Display](#71-multiplier-display)
   - 7.2 [Bonus Effect Preview](#72-bonus-effect-preview)
8. [Combo Break Indicator](#8-combo-break-indicator)
   - 8.1 [Break Notification](#81-break-notification)
   - 8.2 [Final Bonus Summary](#82-final-bonus-summary)
9. [Data Model Changes](#9-data-model-changes)
10. [Configuration File Schemas](#10-configuration-file-schemas)
11. [CombatView Integration](#11-combatview-integration)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

This version implements the visual presentation layer for the combo system in combat. The combo system logic was fully implemented in v0.10.3a-b; this version adds the UI components to display combo chains, continuation prompts, accumulated bonuses, and break notifications during combat. Players will see their position in combo sequences, available next steps, and the bonus rewards for completing combos.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `ComboChainIndicator` |
| **Renderers** | `ComboRenderer` |
| **DTOs** | `ComboDisplayDto`, `ComboStepDisplayDto`, `ComboContinuationDto` |
| **View Updates** | `CombatView` integration |
| **Configuration** | `combo-display.json` |
| **Tests** | ~5 unit tests |

### Architectural Significance

This version follows the **Combat UI Component Pattern** established in v0.13.0a:
- UI Components receive data from services via DTOs
- Renderers handle symbol/color mapping and terminal output
- Components integrate with existing `CombatView` via defined integration points
- Configuration drives visual appearance (colors, symbols, formats)

---

## 2. Feature Overview

```
v0.13.0c Features
├── ComboChainIndicator (UI Component)
│   ├── RenderChain(progress)
│   ├── ShowAvailablePrompt(hints)
│   ├── DisplayBonus(multiplier, effects)
│   └── ShowChainBreak(result)
│
├── ComboRenderer (Renderer)
│   ├── FormatChainStep(step, state)
│   ├── FormatBonus(multiplier)
│   ├── GetStepColor(state)
│   ├── GetBonusColor(multiplier)
│   └── FormatWindowRemaining(turns)
│
├── Combo Available Prompt
│   ├── Continuation Options List
│   ├── Window Timer Display
│   └── Bonus Preview
│
├── Combo Bonus Display
│   ├── Accumulated Multiplier
│   └── Effect Descriptions
│
├── Combo Break Indicator
│   ├── Break Notification
│   └── Final Bonus Summary
│
└── CombatView Integration
    ├── Action Panel Placement
    ├── Turn-Based Refresh
    └── Event-Driven Updates
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Combo Chain Indicator | v0.13.0-scope-breakdown.md | Yes |
| Combo Available Prompt | v0.13.0-scope-breakdown.md | Yes |
| Combo Bonus Display | v0.13.0-scope-breakdown.md | Yes |
| Combo Break Indicator | v0.13.0-scope-breakdown.md (implied) | Yes |
| Status Effect Display | v0.13.0-scope-breakdown.md | No (v0.13.0a) |
| AoE Zone Overlay | v0.13.0-scope-breakdown.md | No (v0.13.0b) |
| Defense Action Prompts | v0.13.0-scope-breakdown.md | No (v0.13.0d) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │     CombatView          │      │  ComboChainIndicator    │               │
│  │     (existing)          │◄────▶│  (NEW)                  │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderCombatState()   │      │ - RenderChain()         │               │
│  │ - HandleAbilityUsed()   │      │ - ShowAvailablePrompt() │               │
│  │ - IntegrateComponents() │      │ - DisplayBonus()        │               │
│  └─────────────────────────┘      │ - ShowChainBreak()      │               │
│                                    └───────────┬─────────────┘               │
│                                                │                             │
│  ┌─────────────────────────┐                   │                             │
│  │    ComboRenderer        │◄──────────────────┘                             │
│  │    (NEW)                │                                                 │
│  ├─────────────────────────┤                                                 │
│  │ - FormatChainStep()     │                                                 │
│  │ - FormatBonus()         │                                                 │
│  │ - GetStepColor()        │                                                 │
│  │ - GetBonusColor()       │                                                 │
│  │ - FormatWindowRemaining()│                                                │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IComboService (existing v0.10.3)                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetActiveProgress(combatant) : IReadOnlyList<ComboProgress>      │    │
│  │ + GetComboHints(combatant) : IReadOnlyList<ComboHint>              │    │
│  │ + GetAvailableCombos(combatant) : IReadOnlyList<ComboDefinition>   │    │
│  │ + HasActiveProgress(combatant) : bool                               │    │
│  │ + GetCompletedComboCount(combatant) : int                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IComboProvider (existing v0.10.3)                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetCombo(comboId) : ComboDefinition?                              │    │
│  │ + GetAllCombos() : IReadOnlyList<ComboDefinition>                   │    │
│  │ + GetCombosContaining(abilityId) : IReadOnlyList<ComboDefinition>   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ComboResult DTO (existing v0.10.3)               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Actions: IReadOnlyList<ComboActionResult>                         │    │
│  │ + CompletedCombos: IReadOnlyList<ComboDefinition>                   │    │
│  │ + HasActions: bool                                                  │    │
│  │ + HasCompletions: bool                                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │   ComboDefinition       │      │    ComboProgress        │               │
│  │   (existing v0.10.3)    │      │    (existing v0.10.3)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + ComboId: string       │      │ + ComboId: string       │               │
│  │ + Name: string          │      │ + CurrentStep: int      │               │
│  │ + Description: string   │      │ + WindowRemaining: int  │               │
│  │ + WindowTurns: int      │      │ + LastTargetId: Guid?   │               │
│  │ + Steps: List<ComboStep>│      │ + StartedAt: DateTime   │               │
│  │ + BonusEffects: List<...>│     │ + GetProgressString()   │               │
│  │ + IconPath: string?     │      └─────────────────────────┘               │
│  │ + StepCount: int        │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │      ComboStep          │      │    ComboBonusEffect     │               │
│  │   (existing v0.10.3)    │      │    (existing v0.10.3)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + StepNumber: int       │      │ + EffectType: Bonus...  │               │
│  │ + AbilityId: string     │      │ + Value: string         │               │
│  │ + TargetRequirement: ...│      │ + DamageType: string?   │               │
│  │ + CustomRequirement: ...│      │ + StatusEffectId: ...?  │               │
│  │ + Matches(...): bool    │      │ + Target: BonusTarget   │               │
│  └─────────────────────────┘      │ + GetDescription(): str │               │
│                                    └─────────────────────────┘               │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │     ComboHint           │      │   ComboActionResult     │               │
│  │   (existing v0.10.3)    │      │   (existing v0.10.3)    │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + ComboId: string       │      │ + ActionType: Started/  │               │
│  │ + ComboName: string     │      │   Progressed/Completed/ │               │
│  │ + NextAbilityId: string │      │   Failed                │               │
│  │ + CurrentStep: int      │      │ + ComboId: string       │               │
│  │ + TotalSteps: int       │      │ + ComboName: string     │               │
│  │ + WindowRemaining: int  │      │ + CurrentStep: int?     │               │
│  │ + ProgressPercent: int  │      │ + TotalSteps: int?      │               │
│  │ + GetDisplayString(): ..│      └─────────────────────────┘               │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    ComboBonusType       │      │   ComboActionType       │               │
│  │   (existing v0.10.3)    │      │   (existing v0.10.3)    │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - ExtraDamage           │      │ - Started               │               │
│  │ - DamageMultiplier      │      │ - Progressed            │               │
│  │ - ApplyStatus           │      │ - Completed             │               │
│  │ - Heal                  │      │ - Failed                │               │
│  │ - ResetCooldown         │      └─────────────────────────┘               │
│  │ - RefundResource        │                                                 │
│  │ - AreaEffect            │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMBO DISPLAY DATA FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    Ability Used / Turn Update
           │
           ▼
┌─────────────────────────┐
│      CombatView         │
│  HandleAbilityUsed()    │
└───────────┬─────────────┘
            │
            │ 1. Request active combo progress
            ▼
┌─────────────────────────┐
│     IComboService       │
│  GetActiveProgress()    │
│  GetComboHints()        │
└───────────┬─────────────┘
            │
            │ 2. Returns List<ComboProgress>, List<ComboHint>
            ▼
┌─────────────────────────┐
│  ComboChainIndicator    │
│                         │
│  ┌───────────────────┐  │
│  │ MapToDisplayDto() │  │ 3. Transform to DTOs
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ BuildChainDisplay │  │ 4. Build step sequence
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ RenderChain()     │  │ 5. Render chain indicator
│  │ ShowAvailablePrompt│ │    Render available prompts
│  │ DisplayBonus()    │  │    Render bonus display
│  └─────────┬─────────┘  │
└────────────┼────────────┘
             │
             │ 6. Call renderer for each element
             ▼
┌─────────────────────────┐
│     ComboRenderer       │
├─────────────────────────┤
│ - FormatChainStep()     │ 7. Format "[Ability]" string
│ - GetStepColor()        │ 8. Map state → color
│ - FormatBonus()         │ 9. Format "+##%" string
│ - FormatWindowRemaining()│10. Format "X turns" string
└───────────┬─────────────┘
            │
            │ 11. Formatted strings
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘


        Combo Completed/Failed
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    COMBO EVENT FLOW                              │
└─────────────────────────────────────────────────────────────────┘
               │
               │ ComboCompletedEvent / ComboFailedEvent raised
               ▼
┌─────────────────────────┐
│      CombatView         │
│  OnComboEvent()         │
└───────────┬─────────────┘
            │
            │ 1. Route to combo indicator
            ▼
┌─────────────────────────┐
│  ComboChainIndicator    │
│  ShowChainBreak()       │
│  ShowCompletion()       │
└───────────┬─────────────┘
            │
            │ 2. Display notification
            ▼
┌─────────────────────────┐
│     ComboRenderer       │
│ - FormatCompletion()    │
│ - FormatBreakMessage()  │
│ - GetResultColor()      │
└───────────┬─────────────┘
            │
            │ 3. Formatted notification
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘
```

### 3.3 Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMBO UI COMPONENT INTERACTION                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│                              CombatView                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                                                                      │  │
│  │   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │  │
│  │   │  Combat Grid    │   │  Action Panel   │   │  Status Panel   │   │  │
│  │   │                 │   │                 │   │                 │   │  │
│  │   │                 │   │ ┌─────────────┐ │   │                 │   │  │
│  │   │                 │   │ │ COMBO       │ │   │                 │   │  │
│  │   │                 │   │ │ INDICATOR   │ │   │                 │   │  │
│  │   │                 │   │ │ ──────────  │ │   │                 │   │  │
│  │   │                 │   │ │ [Strike]→   │ │   │                 │   │  │
│  │   │                 │   │ │ [Slash]→    │ │   │                 │   │  │
│  │   │                 │   │ │ [?]         │ │   │                 │   │  │
│  │   │                 │   │ │             │ │   │                 │   │  │
│  │   │                 │   │ │ +25% bonus  │ │   │                 │   │  │
│  │   │                 │   │ │ Window: 2t  │ │   │                 │   │  │
│  │   │                 │   │ └─────────────┘ │   │                 │   │  │
│  │   │                 │   │                 │   │                 │   │  │
│  │   │                 │   │ ┌─────────────┐ │   │                 │   │  │
│  │   │                 │   │ │ CONTINUE:   │ │   │                 │   │  │
│  │   │                 │   │ │ [1] Thrust  │ │   │                 │   │  │
│  │   │                 │   │ │ [2] Cleave  │ │   │                 │   │  │
│  │   │                 │   │ └─────────────┘ │   │                 │   │  │
│  │   │                 │   │                 │   │                 │   │  │
│  │   └─────────────────┘   └─────────────────┘   └─────────────────┘   │  │
│  │                                                                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Combo Chain Indicator Component

### 4.1 ComboChainIndicator Class

**Purpose:** Renders the visual representation of active combo chains, showing the player's progress through combo sequences.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/ComboChainIndicator.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Presentation.Tui.Services;
using Microsoft.Extensions.Logging;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// UI component for displaying combo chain progress, available continuations,
/// accumulated bonuses, and chain break notifications.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// Receives data from IComboService via DTOs and delegates rendering to ComboRenderer.
/// </remarks>
public class ComboChainIndicator
{
    private readonly IComboService _comboService;
    private readonly IComboProvider _comboProvider;
    private readonly ComboRenderer _renderer;
    private readonly ITerminalService _terminal;
    private readonly ILogger<ComboChainIndicator> _logger;

    private IReadOnlyList<ComboDisplayDto> _activeChains = [];
    private IReadOnlyList<ComboContinuationDto> _availableContinuations = [];

    /// <summary>
    /// Creates a new ComboChainIndicator instance.
    /// </summary>
    /// <param name="comboService">Service for retrieving combo progress.</param>
    /// <param name="comboProvider">Provider for combo definitions.</param>
    /// <param name="renderer">Renderer for combo display elements.</param>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="logger">Logger for diagnostics.</param>
    public ComboChainIndicator(
        IComboService comboService,
        IComboProvider comboProvider,
        ComboRenderer renderer,
        ITerminalService terminal,
        ILogger<ComboChainIndicator> logger)
    {
        _comboService = comboService;
        _comboProvider = comboProvider;
        _renderer = renderer;
        _terminal = terminal;
        _logger = logger;
    }

    /// <summary>
    /// Renders the current combo chain progress for a combatant.
    /// </summary>
    /// <param name="combatant">The combatant to display combo progress for.</param>
    public void RenderChain(ICombatant combatant)
    {
        var progress = _comboService.GetActiveProgress(combatant);
        if (progress.Count == 0)
        {
            _activeChains = [];
            return;
        }

        _activeChains = progress
            .Select(p => MapToDisplayDto(p))
            .Where(dto => dto is not null)
            .Cast<ComboDisplayDto>()
            .ToList();

        foreach (var chain in _activeChains)
        {
            RenderSingleChain(chain);
        }

        _logger.LogDebug(
            "Rendered {ChainCount} active combo chain(s) for combatant {CombatantId}",
            _activeChains.Count,
            combatant.Id);
    }

    /// <summary>
    /// Shows available combo continuation options based on current progress.
    /// </summary>
    /// <param name="combatant">The combatant to show continuations for.</param>
    public void ShowAvailablePrompt(ICombatant combatant)
    {
        var hints = _comboService.GetComboHints(combatant);
        if (hints.Count == 0)
        {
            _availableContinuations = [];
            return;
        }

        _availableContinuations = hints
            .Select((h, index) => MapToContinuationDto(h, index + 1))
            .ToList();

        RenderContinuationPrompt();

        _logger.LogDebug(
            "Displayed {HintCount} combo continuation(s) for combatant {CombatantId}",
            _availableContinuations.Count,
            combatant.Id);
    }

    /// <summary>
    /// Displays the accumulated bonus for active combos.
    /// </summary>
    /// <param name="combatant">The combatant to display bonuses for.</param>
    public void DisplayBonus(ICombatant combatant)
    {
        foreach (var chain in _activeChains)
        {
            RenderBonusDisplay(chain);
        }
    }

    /// <summary>
    /// Shows the chain break notification when a combo fails or expires.
    /// </summary>
    /// <param name="result">The combo action result indicating failure.</param>
    public void ShowChainBreak(ComboActionResult result)
    {
        if (result.ActionType != ComboActionType.Failed)
        {
            return;
        }

        var breakDisplay = new ComboBreakDisplayDto(
            ComboName: result.ComboName,
            ChainLength: result.CurrentStep ?? 0,
            Reason: "Combo expired");

        RenderBreakNotification(breakDisplay);

        _logger.LogInformation(
            "Combo '{ComboName}' broken at step {Step}",
            result.ComboName,
            result.CurrentStep);
    }

    /// <summary>
    /// Shows the combo completion notification with final bonuses.
    /// </summary>
    /// <param name="result">The combo action result indicating completion.</param>
    /// <param name="definition">The completed combo's definition.</param>
    public void ShowCompletion(ComboActionResult result, ComboDefinition definition)
    {
        if (result.ActionType != ComboActionType.Completed)
        {
            return;
        }

        var completionDisplay = new ComboCompletionDisplayDto(
            ComboName: result.ComboName,
            TotalSteps: definition.StepCount,
            BonusEffects: definition.BonusEffects
                .Select(e => e.GetDescription())
                .ToList());

        RenderCompletionNotification(completionDisplay);

        _logger.LogInformation(
            "Combo '{ComboName}' completed with {EffectCount} bonus effect(s)",
            result.ComboName,
            definition.BonusEffects.Count);
    }

    /// <summary>
    /// Clears the combo display area.
    /// </summary>
    public void Clear()
    {
        _activeChains = [];
        _availableContinuations = [];
    }

    private ComboDisplayDto? MapToDisplayDto(ComboProgress progress)
    {
        var definition = _comboProvider.GetCombo(progress.ComboId);
        if (definition is null)
        {
            return null;
        }

        var steps = definition.Steps
            .Select(s => MapStepToDisplayDto(s, progress.CurrentStep))
            .ToList();

        return new ComboDisplayDto(
            ComboId: progress.ComboId,
            ComboName: definition.Name,
            Steps: steps,
            CurrentStep: progress.CurrentStep,
            TotalSteps: definition.StepCount,
            WindowRemaining: progress.WindowRemaining,
            BonusEffects: definition.BonusEffects
                .Select(e => e.GetDescription())
                .ToList(),
            ProgressPercent: (int)((progress.CurrentStep - 1) * 100.0 / definition.StepCount));
    }

    private ComboStepDisplayDto MapStepToDisplayDto(ComboStep step, int currentStep)
    {
        var state = step.StepNumber < currentStep
            ? ComboStepState.Completed
            : step.StepNumber == currentStep
                ? ComboStepState.Current
                : ComboStepState.Pending;

        return new ComboStepDisplayDto(
            StepNumber: step.StepNumber,
            AbilityId: step.AbilityId,
            AbilityName: GetAbilityDisplayName(step.AbilityId),
            State: state,
            TargetRequirement: step.TargetRequirement.ToString());
    }

    private ComboContinuationDto MapToContinuationDto(ComboHint hint, int optionNumber)
    {
        var definition = _comboProvider.GetCombo(hint.ComboId);
        var nextStep = definition?.GetStep(hint.CurrentStep + 1);

        return new ComboContinuationDto(
            OptionNumber: optionNumber,
            AbilityId: hint.NextAbilityId,
            AbilityName: GetAbilityDisplayName(hint.NextAbilityId),
            ComboName: hint.ComboName,
            StepProgress: $"{hint.CurrentStep}/{hint.TotalSteps}",
            WindowRemaining: hint.WindowRemaining,
            BonusPreview: GetBonusPreview(definition));
    }

    private string GetAbilityDisplayName(string abilityId)
    {
        // Format ability ID as display name (e.g., "strike" → "Strike")
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo
            .ToTitleCase(abilityId.Replace("_", " ").Replace("-", " "));
    }

    private string GetBonusPreview(ComboDefinition? definition)
    {
        if (definition is null || definition.BonusEffects.Count == 0)
        {
            return "No bonus";
        }

        var firstEffect = definition.BonusEffects[0];
        return firstEffect.GetDescription();
    }

    private void RenderSingleChain(ComboDisplayDto chain)
    {
        // Render header
        _terminal.WriteLine($"COMBO: {chain.ComboName}");

        // Render step sequence
        var stepDisplay = string.Join(
            " → ",
            chain.Steps.Select(s => _renderer.FormatChainStep(s.AbilityName, s.State)));

        _terminal.WriteLine(stepDisplay);

        // Render window timer
        var windowDisplay = _renderer.FormatWindowRemaining(chain.WindowRemaining);
        _terminal.WriteLine($"Window: {windowDisplay}");
    }

    private void RenderContinuationPrompt()
    {
        _terminal.WriteLine("");
        _terminal.WriteLine("Continue combo:");

        foreach (var continuation in _availableContinuations)
        {
            var line = _renderer.FormatContinuationOption(continuation);
            _terminal.WriteLine(line);
        }
    }

    private void RenderBonusDisplay(ComboDisplayDto chain)
    {
        if (chain.BonusEffects.Count == 0)
        {
            return;
        }

        var bonusLine = _renderer.FormatBonus(chain.ProgressPercent);
        _terminal.WriteLine(bonusLine);

        foreach (var effect in chain.BonusEffects)
        {
            _terminal.WriteLine($"  → {effect}");
        }
    }

    private void RenderBreakNotification(ComboBreakDisplayDto breakInfo)
    {
        _terminal.WriteLine("");
        var message = _renderer.FormatBreakMessage(breakInfo);
        _terminal.WriteLineWithColor(message, _renderer.GetBreakColor());
    }

    private void RenderCompletionNotification(ComboCompletionDisplayDto completion)
    {
        _terminal.WriteLine("");
        var message = _renderer.FormatCompletionMessage(completion);
        _terminal.WriteLineWithColor(message, _renderer.GetCompletionColor());

        foreach (var effect in completion.BonusEffects)
        {
            _terminal.WriteLineWithColor($"  ✓ {effect}", _renderer.GetCompletionColor());
        }
    }
}
```

### 4.2 Chain Sequence Rendering

**Purpose:** Renders the visual chain of abilities in the combo sequence.

#### Display Format

```
COMBO: Warrior's Fury
[✓Strike] → [✓Slash] → [?Thrust]    +25% bonus
Window: 2 turns remaining

Legend:
  [✓Step]  = Completed step (green)
  [>Step]  = Current step (yellow, highlighted)
  [?Step]  = Pending step (gray)
```

#### Step Rendering Logic

```csharp
// In ComboRenderer:
public string FormatChainStep(string abilityName, ComboStepState state)
{
    var prefix = state switch
    {
        ComboStepState.Completed => "✓",
        ComboStepState.Current => ">",
        ComboStepState.Pending => "?",
        _ => " "
    };

    return $"[{prefix}{abilityName}]";
}
```

### 4.3 Step State Visualization

**Step States:**

| State | Symbol | Color | Description |
|-------|--------|-------|-------------|
| `Completed` | `✓` | Green | Step has been executed |
| `Current` | `>` | Yellow | Next step to execute |
| `Pending` | `?` | Gray | Future step in sequence |

---

## 5. Combo Renderer

### 5.1 ComboRenderer Class

**Purpose:** Handles all formatting and color mapping for combo display elements.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Rendering/ComboRenderer.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Presentation.Tui.Configuration;
using Microsoft.Extensions.Options;

namespace RuneAndRust.Presentation.Tui.Rendering;

/// <summary>
/// Renderer for combo chain display elements including step formatting,
/// bonus display, and color mapping.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// All visual configuration is driven by combo-display.json.
/// </remarks>
public class ComboRenderer
{
    private readonly ComboDisplayConfiguration _config;

    /// <summary>
    /// Creates a new ComboRenderer with the specified configuration.
    /// </summary>
    /// <param name="config">Configuration options for combo display.</param>
    public ComboRenderer(IOptions<ComboDisplayConfiguration> config)
    {
        _config = config.Value;
    }

    /// <summary>
    /// Formats a combo chain step for display.
    /// </summary>
    /// <param name="abilityName">The ability name for this step.</param>
    /// <param name="state">The current state of this step.</param>
    /// <returns>Formatted step string with state indicator.</returns>
    public string FormatChainStep(string abilityName, ComboStepState state)
    {
        var prefix = state switch
        {
            ComboStepState.Completed => _config.Symbols.CompletedStep,
            ComboStepState.Current => _config.Symbols.CurrentStep,
            ComboStepState.Pending => _config.Symbols.PendingStep,
            _ => " "
        };

        return $"[{prefix}{abilityName}]";
    }

    /// <summary>
    /// Gets the color for a combo step based on its state.
    /// </summary>
    /// <param name="state">The step state.</param>
    /// <returns>Console color for the step.</returns>
    public ConsoleColor GetStepColor(ComboStepState state)
    {
        return state switch
        {
            ComboStepState.Completed => _config.Colors.CompletedStep,
            ComboStepState.Current => _config.Colors.CurrentStep,
            ComboStepState.Pending => _config.Colors.PendingStep,
            _ => ConsoleColor.White
        };
    }

    /// <summary>
    /// Formats the combo bonus percentage for display.
    /// </summary>
    /// <param name="progressPercent">Progress percentage (0-100).</param>
    /// <returns>Formatted bonus string.</returns>
    public string FormatBonus(int progressPercent)
    {
        if (progressPercent <= 0)
        {
            return "Building combo...";
        }

        // Calculate bonus based on progress
        // Each completed step adds to the bonus multiplier
        var bonusPercent = progressPercent * _config.BonusMultiplierPerStep / 100;
        return $"+{bonusPercent}% damage bonus";
    }

    /// <summary>
    /// Gets the color for bonus display based on multiplier value.
    /// </summary>
    /// <param name="progressPercent">Progress percentage.</param>
    /// <returns>Console color for the bonus display.</returns>
    public ConsoleColor GetBonusColor(int progressPercent)
    {
        return progressPercent switch
        {
            >= 75 => _config.Colors.HighBonus,
            >= 50 => _config.Colors.MediumBonus,
            >= 25 => _config.Colors.LowBonus,
            _ => _config.Colors.NoBonus
        };
    }

    /// <summary>
    /// Formats the remaining window time for display.
    /// </summary>
    /// <param name="turnsRemaining">Number of turns remaining.</param>
    /// <returns>Formatted window string.</returns>
    public string FormatWindowRemaining(int turnsRemaining)
    {
        if (turnsRemaining <= 0)
        {
            return "EXPIRED";
        }

        var turnWord = turnsRemaining == 1 ? "turn" : "turns";
        var urgency = turnsRemaining <= _config.UrgentWindowThreshold
            ? " (!)"
            : "";

        return $"{turnsRemaining} {turnWord}{urgency}";
    }

    /// <summary>
    /// Gets the color for window timer based on urgency.
    /// </summary>
    /// <param name="turnsRemaining">Number of turns remaining.</param>
    /// <returns>Console color for the window timer.</returns>
    public ConsoleColor GetWindowColor(int turnsRemaining)
    {
        return turnsRemaining switch
        {
            <= 1 => _config.Colors.UrgentWindow,
            <= 2 => _config.Colors.WarningWindow,
            _ => _config.Colors.NormalWindow
        };
    }

    /// <summary>
    /// Formats a continuation option for the available prompt.
    /// </summary>
    /// <param name="continuation">The continuation DTO.</param>
    /// <returns>Formatted continuation option string.</returns>
    public string FormatContinuationOption(ComboContinuationDto continuation)
    {
        return $"  [{continuation.OptionNumber}] {continuation.AbilityName} - {continuation.BonusPreview}";
    }

    /// <summary>
    /// Formats the combo break message.
    /// </summary>
    /// <param name="breakInfo">Break information DTO.</param>
    /// <returns>Formatted break message.</returns>
    public string FormatBreakMessage(ComboBreakDisplayDto breakInfo)
    {
        return $"COMBO BROKEN! {breakInfo.ComboName} ended at step {breakInfo.ChainLength}";
    }

    /// <summary>
    /// Gets the color for break notifications.
    /// </summary>
    /// <returns>Console color for break messages.</returns>
    public ConsoleColor GetBreakColor()
    {
        return _config.Colors.ComboBreak;
    }

    /// <summary>
    /// Formats the combo completion message.
    /// </summary>
    /// <param name="completion">Completion information DTO.</param>
    /// <returns>Formatted completion message.</returns>
    public string FormatCompletionMessage(ComboCompletionDisplayDto completion)
    {
        return $"COMBO COMPLETE! {completion.ComboName} ({completion.TotalSteps} steps)";
    }

    /// <summary>
    /// Gets the color for completion notifications.
    /// </summary>
    /// <returns>Console color for completion messages.</returns>
    public ConsoleColor GetCompletionColor()
    {
        return _config.Colors.ComboComplete;
    }

    /// <summary>
    /// Formats the chain arrow separator.
    /// </summary>
    /// <returns>Arrow string for chain display.</returns>
    public string GetChainSeparator()
    {
        return _config.Symbols.ChainArrow;
    }
}
```

### 5.2 Chain Step Formatting

#### Format Patterns

| Pattern | Example | Usage |
|---------|---------|-------|
| Step with state | `[✓Strike]` | Shows completed ability |
| Chain sequence | `[✓A] → [>B] → [?C]` | Full combo chain |
| Bonus display | `+25% damage bonus` | Accumulated multiplier |
| Window timer | `2 turns (!)` | Urgent time warning |

#### ASCII/Unicode Fallback

```csharp
// In ComboDisplayConfiguration:
public class SymbolConfiguration
{
    public string CompletedStep { get; set; } = "✓";
    public string CurrentStep { get; set; } = ">";
    public string PendingStep { get; set; } = "?";
    public string ChainArrow { get; set; } = " → ";

    // ASCII fallbacks for limited terminals
    public string CompletedStepAscii { get; set; } = "*";
    public string ChainArrowAscii { get; set; } = " -> ";
}
```

### 5.3 Color Mapping

#### Step State Colors

| State | Default Color | Meaning |
|-------|---------------|---------|
| `Completed` | Green | Step successfully executed |
| `Current` | Yellow | Active step to execute |
| `Pending` | DarkGray | Future step |

#### Bonus Colors

| Progress Range | Color | Meaning |
|----------------|-------|---------|
| 75-100% | Cyan | High bonus building |
| 50-74% | Green | Good progress |
| 25-49% | Yellow | Moderate progress |
| 0-24% | Gray | Just started |

#### Window Timer Colors

| Turns Remaining | Color | Meaning |
|-----------------|-------|---------|
| 1 turn | Red | Urgent - act now |
| 2 turns | Yellow | Warning - limited time |
| 3+ turns | White | Normal - time available |

---

## 6. Combo Available Prompt

### 6.1 Continuation Options Display

**Purpose:** Shows the player which abilities can continue their active combos.

#### Display Format

```
Continue combo:
  [1] Thrust  - Continues chain, +10% bonus
  [2] Cleave  - Finisher, applies full bonus
  [3] Feint   - Breaks chain, no bonus
```

#### Continuation DTO

```csharp
/// <summary>
/// Data transfer object for combo continuation options.
/// </summary>
/// <param name="OptionNumber">Selection number for this option.</param>
/// <param name="AbilityId">Ability ID that continues the combo.</param>
/// <param name="AbilityName">Display name of the ability.</param>
/// <param name="ComboName">Name of the combo being continued.</param>
/// <param name="StepProgress">Current progress string (e.g., "2/4").</param>
/// <param name="WindowRemaining">Turns remaining to continue.</param>
/// <param name="BonusPreview">Preview of bonus if combo continues.</param>
public record ComboContinuationDto(
    int OptionNumber,
    string AbilityId,
    string AbilityName,
    string ComboName,
    string StepProgress,
    int WindowRemaining,
    string BonusPreview);
```

### 6.2 Window Timer Display

**Purpose:** Shows the remaining time to continue the combo before it expires.

#### Display Format

```
Window: 2 turns remaining
```

**Urgent Display (1 turn):**
```
Window: 1 turn remaining (!)
```

#### Timer Rendering Logic

```csharp
public void RenderWindowTimer(int turnsRemaining)
{
    var formatted = _renderer.FormatWindowRemaining(turnsRemaining);
    var color = _renderer.GetWindowColor(turnsRemaining);

    _terminal.WriteWithColor($"Window: {formatted}", color);
}
```

---

## 7. Combo Bonus Display

### 7.1 Multiplier Display

**Purpose:** Shows the accumulated damage multiplier from combo progress.

#### Display Format

```
+25% damage bonus
```

#### Multiplier Calculation

The bonus multiplier is calculated based on:
1. Number of completed steps
2. Per-step bonus configured in combo definition
3. Any special multipliers from combo effects

```csharp
// Display uses ComboBonusEffect.GetDescription() for effect text
// Multiplier percentage comes from ComboDisplayDto.ProgressPercent
```

### 7.2 Bonus Effect Preview

**Purpose:** Shows what bonuses will be applied when the combo completes.

#### Display Format

```
Bonus Effects:
  → +2d6 extra damage
  → Apply Burning status
  → Reset Strike cooldown
```

#### Effect Types Display

| ComboBonusType | Display Format |
|----------------|----------------|
| `ExtraDamage` | `+{value} extra damage` |
| `DamageMultiplier` | `{value}x damage multiplier` |
| `ApplyStatus` | `Apply {statusName}` |
| `Heal` | `Heal {value} HP` |
| `ResetCooldown` | `Reset {abilityName} cooldown` |
| `RefundResource` | `Refund {value} {resource}` |
| `AreaEffect` | `Expand to {value} area` |

---

## 8. Combo Break Indicator

### 8.1 Break Notification

**Purpose:** Notifies the player when a combo chain breaks due to expiration or invalid action.

#### Display Format

```
COMBO BROKEN!
  Warrior's Fury ended at step 2/4
  Reason: Window expired
```

#### Break DTO

```csharp
/// <summary>
/// Data transfer object for combo break notifications.
/// </summary>
/// <param name="ComboName">Name of the broken combo.</param>
/// <param name="ChainLength">Steps completed before break.</param>
/// <param name="Reason">Reason for combo breaking.</param>
public record ComboBreakDisplayDto(
    string ComboName,
    int ChainLength,
    string Reason);
```

### 8.2 Final Bonus Summary

**Purpose:** Shows what partial bonus was applied when a combo breaks mid-chain.

#### Display Format (if partial bonus applies)

```
COMBO BROKEN!
  Warrior's Fury ended at step 2/4
  Partial bonus applied: +12% damage to last attack
```

#### Display Format (no partial bonus)

```
COMBO BROKEN!
  Warrior's Fury ended at step 2/4
  No bonus applied - combo must complete for rewards
```

---

## 9. Data Model Changes

### 9.1 New DTOs

#### ComboDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ComboDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object for combo chain display.
/// </summary>
/// <param name="ComboId">Unique identifier of the combo.</param>
/// <param name="ComboName">Display name of the combo.</param>
/// <param name="Steps">List of steps in the combo sequence.</param>
/// <param name="CurrentStep">Current step number (1-indexed).</param>
/// <param name="TotalSteps">Total number of steps in combo.</param>
/// <param name="WindowRemaining">Turns remaining to continue combo.</param>
/// <param name="BonusEffects">List of bonus effect descriptions.</param>
/// <param name="ProgressPercent">Completion progress as percentage.</param>
public record ComboDisplayDto(
    string ComboId,
    string ComboName,
    IReadOnlyList<ComboStepDisplayDto> Steps,
    int CurrentStep,
    int TotalSteps,
    int WindowRemaining,
    IReadOnlyList<string> BonusEffects,
    int ProgressPercent);
```

#### ComboStepDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ComboStepDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object for individual combo step display.
/// </summary>
/// <param name="StepNumber">Position in combo sequence (1-indexed).</param>
/// <param name="AbilityId">Ability ID for this step.</param>
/// <param name="AbilityName">Display name of the ability.</param>
/// <param name="State">Current state of this step.</param>
/// <param name="TargetRequirement">Target requirement description.</param>
public record ComboStepDisplayDto(
    int StepNumber,
    string AbilityId,
    string AbilityName,
    ComboStepState State,
    string TargetRequirement);
```

#### ComboStepState Enum

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ComboStepState.cs`

```csharp
/// <summary>
/// Represents the visual state of a combo step.
/// </summary>
public enum ComboStepState
{
    /// <summary>Step has been successfully executed.</summary>
    Completed,

    /// <summary>Step is the next one to execute.</summary>
    Current,

    /// <summary>Step is a future step in the sequence.</summary>
    Pending
}
```

#### ComboCompletionDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ComboCompletionDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object for combo completion notifications.
/// </summary>
/// <param name="ComboName">Name of the completed combo.</param>
/// <param name="TotalSteps">Total steps in the combo.</param>
/// <param name="BonusEffects">List of applied bonus effect descriptions.</param>
public record ComboCompletionDisplayDto(
    string ComboName,
    int TotalSteps,
    IReadOnlyList<string> BonusEffects);
```

### 9.2 Summary Table

| Type | Layer | Purpose |
|------|-------|---------|
| `ComboDisplayDto` | Presentation | Full combo chain display data |
| `ComboStepDisplayDto` | Presentation | Individual step display data |
| `ComboStepState` | Presentation | Step visual state enum |
| `ComboContinuationDto` | Presentation | Continuation option display |
| `ComboBreakDisplayDto` | Presentation | Break notification data |
| `ComboCompletionDisplayDto` | Presentation | Completion notification data |

---

## 10. Configuration File Schemas

### 10.1 combo-display.json

**File:** `config/combo-display.json`

```json
{
  "$schema": "./schemas/combo-display.schema.json",
  "symbols": {
    "completedStep": "✓",
    "currentStep": ">",
    "pendingStep": "?",
    "chainArrow": " → ",
    "completedStepAscii": "*",
    "currentStepAscii": ">",
    "pendingStepAscii": "?",
    "chainArrowAscii": " -> "
  },
  "colors": {
    "completedStep": "Green",
    "currentStep": "Yellow",
    "pendingStep": "DarkGray",
    "highBonus": "Cyan",
    "mediumBonus": "Green",
    "lowBonus": "Yellow",
    "noBonus": "Gray",
    "urgentWindow": "Red",
    "warningWindow": "Yellow",
    "normalWindow": "White",
    "comboBreak": "Red",
    "comboComplete": "Cyan"
  },
  "display": {
    "bonusMultiplierPerStep": 10,
    "urgentWindowThreshold": 2,
    "showBonusPreview": true,
    "showTargetRequirements": false,
    "maxContinuationOptions": 5
  },
  "messages": {
    "comboBreak": "COMBO BROKEN!",
    "comboComplete": "COMBO COMPLETE!",
    "windowExpired": "Window expired",
    "continuePrompt": "Continue combo:",
    "buildingCombo": "Building combo...",
    "noActiveCombo": ""
  }
}
```

### 10.2 Configuration Schema

**File:** `config/schemas/combo-display.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "combo-display.schema.json",
  "title": "Combo Display Configuration",
  "description": "Configuration for combo chain indicator display",
  "type": "object",
  "properties": {
    "symbols": {
      "type": "object",
      "description": "Symbol characters for combo display",
      "properties": {
        "completedStep": {
          "type": "string",
          "description": "Symbol for completed steps",
          "default": "✓"
        },
        "currentStep": {
          "type": "string",
          "description": "Symbol for current step",
          "default": ">"
        },
        "pendingStep": {
          "type": "string",
          "description": "Symbol for pending steps",
          "default": "?"
        },
        "chainArrow": {
          "type": "string",
          "description": "Arrow between chain steps",
          "default": " → "
        },
        "completedStepAscii": {
          "type": "string",
          "description": "ASCII fallback for completed steps",
          "default": "*"
        },
        "currentStepAscii": {
          "type": "string",
          "description": "ASCII fallback for current step",
          "default": ">"
        },
        "pendingStepAscii": {
          "type": "string",
          "description": "ASCII fallback for pending steps",
          "default": "?"
        },
        "chainArrowAscii": {
          "type": "string",
          "description": "ASCII fallback for chain arrow",
          "default": " -> "
        }
      },
      "required": ["completedStep", "currentStep", "pendingStep", "chainArrow"]
    },
    "colors": {
      "type": "object",
      "description": "Color mappings for combo display elements",
      "properties": {
        "completedStep": { "type": "string", "default": "Green" },
        "currentStep": { "type": "string", "default": "Yellow" },
        "pendingStep": { "type": "string", "default": "DarkGray" },
        "highBonus": { "type": "string", "default": "Cyan" },
        "mediumBonus": { "type": "string", "default": "Green" },
        "lowBonus": { "type": "string", "default": "Yellow" },
        "noBonus": { "type": "string", "default": "Gray" },
        "urgentWindow": { "type": "string", "default": "Red" },
        "warningWindow": { "type": "string", "default": "Yellow" },
        "normalWindow": { "type": "string", "default": "White" },
        "comboBreak": { "type": "string", "default": "Red" },
        "comboComplete": { "type": "string", "default": "Cyan" }
      }
    },
    "display": {
      "type": "object",
      "description": "Display behavior settings",
      "properties": {
        "bonusMultiplierPerStep": {
          "type": "integer",
          "description": "Bonus percentage added per completed step",
          "default": 10,
          "minimum": 0,
          "maximum": 100
        },
        "urgentWindowThreshold": {
          "type": "integer",
          "description": "Turns remaining to show urgent indicator",
          "default": 2,
          "minimum": 1
        },
        "showBonusPreview": {
          "type": "boolean",
          "description": "Whether to show bonus effect previews",
          "default": true
        },
        "showTargetRequirements": {
          "type": "boolean",
          "description": "Whether to show target requirements on steps",
          "default": false
        },
        "maxContinuationOptions": {
          "type": "integer",
          "description": "Maximum continuation options to display",
          "default": 5,
          "minimum": 1,
          "maximum": 10
        }
      }
    },
    "messages": {
      "type": "object",
      "description": "Customizable message strings",
      "properties": {
        "comboBreak": { "type": "string", "default": "COMBO BROKEN!" },
        "comboComplete": { "type": "string", "default": "COMBO COMPLETE!" },
        "windowExpired": { "type": "string", "default": "Window expired" },
        "continuePrompt": { "type": "string", "default": "Continue combo:" },
        "buildingCombo": { "type": "string", "default": "Building combo..." },
        "noActiveCombo": { "type": "string", "default": "" }
      }
    }
  },
  "required": ["symbols", "colors", "display"]
}
```

### 10.3 Configuration Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/ComboDisplayConfiguration.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration options for combo display rendering.
/// </summary>
public class ComboDisplayConfiguration
{
    /// <summary>
    /// Symbol characters for combo display elements.
    /// </summary>
    public SymbolConfiguration Symbols { get; set; } = new();

    /// <summary>
    /// Color mappings for combo display elements.
    /// </summary>
    public ColorConfiguration Colors { get; set; } = new();

    /// <summary>
    /// Display behavior settings.
    /// </summary>
    public DisplaySettings Display { get; set; } = new();

    /// <summary>
    /// Customizable message strings.
    /// </summary>
    public MessageConfiguration Messages { get; set; } = new();

    /// <summary>
    /// Bonus percentage added per completed step.
    /// </summary>
    public int BonusMultiplierPerStep => Display.BonusMultiplierPerStep;

    /// <summary>
    /// Turns remaining to trigger urgent indicator.
    /// </summary>
    public int UrgentWindowThreshold => Display.UrgentWindowThreshold;
}

/// <summary>
/// Symbol characters for combo display.
/// </summary>
public class SymbolConfiguration
{
    public string CompletedStep { get; set; } = "✓";
    public string CurrentStep { get; set; } = ">";
    public string PendingStep { get; set; } = "?";
    public string ChainArrow { get; set; } = " → ";
    public string CompletedStepAscii { get; set; } = "*";
    public string CurrentStepAscii { get; set; } = ">";
    public string PendingStepAscii { get; set; } = "?";
    public string ChainArrowAscii { get; set; } = " -> ";
}

/// <summary>
/// Color mappings for combo display.
/// </summary>
public class ColorConfiguration
{
    public ConsoleColor CompletedStep { get; set; } = ConsoleColor.Green;
    public ConsoleColor CurrentStep { get; set; } = ConsoleColor.Yellow;
    public ConsoleColor PendingStep { get; set; } = ConsoleColor.DarkGray;
    public ConsoleColor HighBonus { get; set; } = ConsoleColor.Cyan;
    public ConsoleColor MediumBonus { get; set; } = ConsoleColor.Green;
    public ConsoleColor LowBonus { get; set; } = ConsoleColor.Yellow;
    public ConsoleColor NoBonus { get; set; } = ConsoleColor.Gray;
    public ConsoleColor UrgentWindow { get; set; } = ConsoleColor.Red;
    public ConsoleColor WarningWindow { get; set; } = ConsoleColor.Yellow;
    public ConsoleColor NormalWindow { get; set; } = ConsoleColor.White;
    public ConsoleColor ComboBreak { get; set; } = ConsoleColor.Red;
    public ConsoleColor ComboComplete { get; set; } = ConsoleColor.Cyan;
}

/// <summary>
/// Display behavior settings.
/// </summary>
public class DisplaySettings
{
    public int BonusMultiplierPerStep { get; set; } = 10;
    public int UrgentWindowThreshold { get; set; } = 2;
    public bool ShowBonusPreview { get; set; } = true;
    public bool ShowTargetRequirements { get; set; } = false;
    public int MaxContinuationOptions { get; set; } = 5;
}

/// <summary>
/// Customizable message strings.
/// </summary>
public class MessageConfiguration
{
    public string ComboBreak { get; set; } = "COMBO BROKEN!";
    public string ComboComplete { get; set; } = "COMBO COMPLETE!";
    public string WindowExpired { get; set; } = "Window expired";
    public string ContinuePrompt { get; set; } = "Continue combo:";
    public string BuildingCombo { get; set; } = "Building combo...";
    public string NoActiveCombo { get; set; } = "";
}
```

---

## 11. CombatView Integration

### 11.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/CombatView.cs` (modifications)

```csharp
// Add to CombatView class:

private readonly ComboChainIndicator _comboIndicator;

/// <summary>
/// Integrates combo chain indicator into combat view.
/// </summary>
public void IntegrateComboIndicator(ComboChainIndicator indicator)
{
    _comboIndicator = indicator;
}

/// <summary>
/// Updates combo display after ability execution.
/// </summary>
/// <param name="combatant">The combatant who used an ability.</param>
/// <param name="result">The combo result from the ability.</param>
public void UpdateComboDisplay(ICombatant combatant, ComboResult result)
{
    // Handle combo events
    foreach (var action in result.Actions)
    {
        switch (action.ActionType)
        {
            case ComboActionType.Started:
            case ComboActionType.Progressed:
                _comboIndicator.RenderChain(combatant);
                _comboIndicator.ShowAvailablePrompt(combatant);
                _comboIndicator.DisplayBonus(combatant);
                break;

            case ComboActionType.Completed:
                var definition = _comboProvider.GetCombo(action.ComboId);
                if (definition is not null)
                {
                    _comboIndicator.ShowCompletion(action, definition);
                }
                break;

            case ComboActionType.Failed:
                _comboIndicator.ShowChainBreak(action);
                break;
        }
    }
}

/// <summary>
/// Refreshes combo display at turn start.
/// </summary>
/// <param name="combatant">The current combatant.</param>
public void RefreshComboDisplay(ICombatant combatant)
{
    if (_comboService.HasActiveProgress(combatant))
    {
        _comboIndicator.RenderChain(combatant);
        _comboIndicator.ShowAvailablePrompt(combatant);
        _comboIndicator.DisplayBonus(combatant);
    }
    else
    {
        _comboIndicator.Clear();
    }
}
```

### 11.2 Panel Placement

The combo indicator is placed in the **Action Panel** section of the combat view:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              COMBAT VIEW                                     │
├───────────────────────┬─────────────────────────┬───────────────────────────┤
│                       │                         │                           │
│    COMBAT GRID        │    ACTION PANEL         │    STATUS PANEL           │
│                       │                         │                           │
│    [Grid display]     │    COMBO: Warrior's Fury│    [Combatant stats]      │
│                       │    [✓Strike] → [>Slash] │                           │
│                       │    → [?Thrust]          │    [Status effects]       │
│                       │                         │                           │
│                       │    +25% damage bonus    │    [Equipment]            │
│                       │    Window: 2 turns      │                           │
│                       │                         │                           │
│                       │    Continue combo:      │                           │
│                       │    [1] Thrust - +10%    │                           │
│                       │    [2] Cleave - Finisher│                           │
│                       │                         │                           │
│                       │    ─────────────────    │                           │
│                       │    [Available actions]  │                           │
│                       │                         │                           │
└───────────────────────┴─────────────────────────┴───────────────────────────┘
```

### 11.3 Event Subscriptions

```csharp
// In CombatView initialization:

// Subscribe to combo events for real-time updates
_eventBus.Subscribe<ComboStartedEvent>(OnComboStarted);
_eventBus.Subscribe<ComboProgressedEvent>(OnComboProgressed);
_eventBus.Subscribe<ComboCompletedEvent>(OnComboCompleted);
_eventBus.Subscribe<ComboFailedEvent>(OnComboFailed);

private void OnComboStarted(ComboStartedEvent evt)
{
    if (evt.CombatantId == _currentCombatant?.Id)
    {
        RefreshComboDisplay(_currentCombatant);
    }
}

private void OnComboProgressed(ComboProgressedEvent evt)
{
    if (evt.CombatantId == _currentCombatant?.Id)
    {
        RefreshComboDisplay(_currentCombatant);
    }
}

private void OnComboCompleted(ComboCompletedEvent evt)
{
    if (evt.CombatantId == _currentCombatant?.Id)
    {
        var action = new ComboActionResult(
            ComboActionType.Completed,
            evt.ComboId,
            evt.ComboName,
            null,
            null);
        var definition = _comboProvider.GetCombo(evt.ComboId);
        if (definition is not null)
        {
            _comboIndicator.ShowCompletion(action, definition);
        }
    }
}

private void OnComboFailed(ComboFailedEvent evt)
{
    if (evt.CombatantId == _currentCombatant?.Id)
    {
        var action = new ComboActionResult(
            ComboActionType.Failed,
            evt.ComboId,
            evt.ComboName,
            null,
            null);
        _comboIndicator.ShowChainBreak(action);
    }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `ComboChainIndicator` | Information | Combo completion, combo break |
| `ComboChainIndicator` | Debug | Chain rendered, prompts displayed |
| `ComboRenderer` | Debug | Format operations |
| `CombatView` | Debug | Combo display refresh |

### 12.2 Log Message Examples

```csharp
// ComboChainIndicator
_logger.LogDebug(
    "Rendered {ChainCount} active combo chain(s) for combatant {CombatantId}",
    _activeChains.Count, combatant.Id);

_logger.LogDebug(
    "Displayed {HintCount} combo continuation(s) for combatant {CombatantId}",
    _availableContinuations.Count, combatant.Id);

_logger.LogInformation(
    "Combo '{ComboName}' broken at step {Step}",
    result.ComboName, result.CurrentStep);

_logger.LogInformation(
    "Combo '{ComboName}' completed with {EffectCount} bonus effect(s)",
    result.ComboName, definition.BonusEffects.Count);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| ComboChainIndicator | ~2 |
| ComboRenderer | ~2 |
| CombatView Integration | ~1 |
| **Total** | **~5** |

### 13.2 Test Specifications

#### ComboChainIndicatorTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/ComboChainIndicatorTests.cs`

```csharp
[TestFixture]
public class ComboChainIndicatorTests
{
    [Test]
    public void RenderChain_WithActiveProgress_DisplaysChainSequence();

    [Test]
    public void ShowAvailablePrompt_WithHints_DisplaysContinuationOptions();

    [Test]
    public void DisplayBonus_WithProgress_ShowsAccumulatedBonus();

    [Test]
    public void ShowChainBreak_WithFailedResult_DisplaysBreakNotification();

    [Test]
    public void ShowCompletion_WithCompletedResult_DisplaysCompletionMessage();

    [Test]
    public void Clear_RemovesAllDisplayData();

    [Test]
    public void RenderChain_NoActiveProgress_ClearsDisplay();
}
```

#### ComboRendererTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Rendering/ComboRendererTests.cs`

```csharp
[TestFixture]
public class ComboRendererTests
{
    [Test]
    public void FormatChainStep_CompletedState_ReturnsCheckmarkPrefix();

    [Test]
    public void FormatChainStep_CurrentState_ReturnsArrowPrefix();

    [Test]
    public void FormatChainStep_PendingState_ReturnsQuestionPrefix();

    [Test]
    public void GetStepColor_CompletedState_ReturnsGreen();

    [Test]
    public void GetStepColor_CurrentState_ReturnsYellow();

    [Test]
    public void FormatBonus_HighProgress_ReturnsPositivePercentage();

    [Test]
    public void FormatBonus_ZeroProgress_ReturnsBuildingMessage();

    [Test]
    public void FormatWindowRemaining_UrgentTurns_IncludesUrgencyIndicator();

    [Test]
    public void FormatWindowRemaining_ZeroTurns_ReturnsExpired();

    [Test]
    public void GetWindowColor_OneTurn_ReturnsRed();

    [Test]
    public void FormatContinuationOption_ValidDto_ReturnsFormattedString();
}
```

---

## 14. Use Cases

### UC-001: View Active Combo Chain

**Actor:** Player
**Flow:** Player uses ability → IComboService detects combo progress → CombatView calls ComboChainIndicator.RenderChain() → Chain sequence displayed with step states → Player sees current position in combo

### UC-002: Continue Combo from Prompt

**Actor:** Player
**Flow:** Active combo exists → CombatView calls ComboChainIndicator.ShowAvailablePrompt() → Continuation options displayed → Player selects option → Ability executed → Combo advances

### UC-003: View Combo Bonus

**Actor:** Player
**Flow:** Combo in progress → CombatView calls ComboChainIndicator.DisplayBonus() → Accumulated bonus percentage shown → Bonus effect descriptions displayed → Player understands reward for completion

### UC-004: Combo Window Expires

**Actor:** System
**Flow:** Turn ends → IComboService.TickCombos() decrements window → Window reaches 0 → ComboFailedEvent raised → CombatView calls ComboChainIndicator.ShowChainBreak() → Break notification displayed

### UC-005: Complete Combo

**Actor:** Player
**Flow:** Player uses final combo ability → IComboService detects completion → ComboCompletedEvent raised → CombatView calls ComboChainIndicator.ShowCompletion() → Completion notification with bonuses displayed

---

## 15. Deliverable Checklist

### Combo Chain Indicator

- [ ] `ComboChainIndicator.cs` created
- [ ] `RenderChain()` method implemented
- [ ] `ShowAvailablePrompt()` method implemented
- [ ] `DisplayBonus()` method implemented
- [ ] `ShowChainBreak()` method implemented
- [ ] `ShowCompletion()` method implemented
- [ ] `Clear()` method implemented

### Combo Renderer

- [ ] `ComboRenderer.cs` created
- [ ] `FormatChainStep()` method implemented
- [ ] `GetStepColor()` method implemented
- [ ] `FormatBonus()` method implemented
- [ ] `GetBonusColor()` method implemented
- [ ] `FormatWindowRemaining()` method implemented
- [ ] `GetWindowColor()` method implemented
- [ ] `FormatContinuationOption()` method implemented
- [ ] `FormatBreakMessage()` method implemented
- [ ] `FormatCompletionMessage()` method implemented

### DTOs

- [ ] `ComboDisplayDto.cs` created
- [ ] `ComboStepDisplayDto.cs` created
- [ ] `ComboStepState.cs` enum created
- [ ] `ComboContinuationDto.cs` created
- [ ] `ComboBreakDisplayDto.cs` created
- [ ] `ComboCompletionDisplayDto.cs` created

### Configuration

- [ ] `config/combo-display.json` created
- [ ] `config/schemas/combo-display.schema.json` created
- [ ] `ComboDisplayConfiguration.cs` created

### CombatView Integration

- [ ] `IntegrateComboIndicator()` method added
- [ ] `UpdateComboDisplay()` method added
- [ ] `RefreshComboDisplay()` method added
- [ ] Event subscriptions implemented

### Testing

- [ ] `ComboChainIndicatorTests.cs` created with ~2 tests
- [ ] `ComboRendererTests.cs` created with ~2 tests
- [ ] Integration test for CombatView (~1 test)
- [ ] All ~5 unit tests passing

---

## 16. Acceptance Criteria

### Functional

- [ ] Combo chain shows current position in sequence
- [ ] Completed steps show checkmark symbol
- [ ] Current step shows highlight/arrow symbol
- [ ] Future steps show placeholder symbol
- [ ] Combo available prompt shows when chain can continue
- [ ] Continuation options display ability names and bonus preview
- [ ] Combo bonus displays accumulated multiplier percentage
- [ ] Window timer displays remaining turns
- [ ] Window timer shows urgency indicator when low
- [ ] Chain break shows notification when combo expires
- [ ] Chain break shows final bonus summary (if applicable)
- [ ] Combo completion shows notification with applied bonuses

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~5 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] XML documentation complete on all public members

---

## 17. Dependencies

### 17.1 Required from Previous Versions

| Type | Location | Usage |
|------|----------|-------|
| `IComboService` | `Application/Interfaces/IComboService.cs` | Retrieve combo progress and hints |
| `IComboProvider` | `Application/Interfaces/IComboProvider.cs` | Get combo definitions |
| `ComboDefinition` | `Domain/Definitions/ComboDefinition.cs` | Combo sequence structure |
| `ComboStep` | `Domain/Definitions/ComboStep.cs` | Step details |
| `ComboBonusEffect` | `Domain/Definitions/ComboBonusEffect.cs` | Bonus effect descriptions |
| `ComboProgress` | `Application/Tracking/ComboProgress.cs` | Active combo state |
| `ComboHint` | `Application/DTOs/ComboHint.cs` | Continuation hints |
| `ComboResult` | `Application/DTOs/ComboResult.cs` | Ability result data |
| `ComboActionResult` | `Application/DTOs/ComboActionResult.cs` | Individual action data |
| `ComboActionType` | `Application/DTOs/ComboActionType.cs` | Action type enum |
| `CombatView` | `Presentation.Tui/Views/CombatView.cs` | Integration point |
| `ITerminalService` | `Presentation.Tui/Services/ITerminalService.cs` | Terminal output |

### 17.2 Provides to v0.13.0d

| Type | Usage |
|------|-------|
| `ComboChainIndicator` | Pattern reference for defense/stance indicators |
| `ComboRenderer` | Pattern reference for defense/stance renderers |
| `ComboDisplayConfiguration` | Pattern reference for configuration structure |

---

## 18. Future Considerations

### Deferred to Future Versions

- **Combo Preview Mode**: Showing full combo sequence before starting (not in v0.13.0 scope)
- **Combo History**: Displaying completed combos during combat session (not in v0.13.0 scope)
- **Animated Transitions**: Smooth animations for step progression (TUI limitation)
- **Combo Hotkeys**: Quick-select keys for common combos (v0.14.x consideration)
- **Multi-Combo Display**: Showing multiple active combos simultaneously (current scope shows one primary combo)

### Out of Scope

- **Combo Definition Editing**: This is configuration, not runtime UI
- **AI Combo Hints**: Suggestions for optimal combo usage (AI enhancement)
- **Combo Statistics**: Long-term combo usage tracking (achievement system)

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
