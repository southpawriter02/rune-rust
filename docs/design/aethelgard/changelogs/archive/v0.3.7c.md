# Changelog: v0.3.7c - The Archive (Journal UI)
**Release Date:** 2025-12-22

---

## Summary

This release implements a full-screen tabbed journal UI system following the established v0.3.7a Inventory and v0.3.7b Crafting UI patterns. The implementation introduces four immutable ViewModel records that transform Codex entry data into display-ready format with tab-based filtering, text redaction via the existing TextRedactor service, and stress-based glitch effects. The journal screen uses Spectre.Console Layout for a split-panel interface displaying tab-filtered entries (40% width) and detailed entry information with redacted content (60% width). Key architectural patterns include the ViewModel pattern for UI data transformation, static helper utilities for color/icon mapping and glitch effects, and the Renderer service pattern for layout composition. The UI supports keyboard-driven navigation with tab filtering hotkeys ([C]odex, [B]estiary, [F]ield Guide, [Q]uests), directional entry navigation (↑/↓), and seamless integration with the existing Data Capture and TextRedactor systems. The "archive" command routes to the journal screen via CommandParser extension.

**Layers Touched:**
- Core Layer: ViewModels, Interface definitions
- Engine Layer: JournalService ViewModel builder, CommandParser routing
- Terminal Layer: Spectre.Console renderer, static formatting helpers
- Test Layer: 45 new tests (15 ViewModel, 30 Renderer/Helper)

**Patterns Introduced:**
- Immutable ViewModel Records (JournalViewModel, JournalEntryView, JournalEntryDetailView)
- Static View Helper (JournalViewHelper for tab colors/icons/formatting/glitch effects)
- Spectre.Console Layout Renderer (4-row split with nested 2-column body)
- Async ViewModel Builder Pattern (BuildViewModelAsync in JournalService)

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/ViewModels/JournalViewModel.cs` | Four immutable records for journal UI data: `JournalTab` enum (Codex, Bestiary, FieldGuide, Contracts), `JournalViewModel` (main container with character name, stress level, active tab, filtered entry list, selection index, detail view), `JournalEntryView` (entry list summary with 1-based index, entry ID, title, category, completion percentage, completion flag), `JournalEntryDetailView` (detail panel with entry ID, title, category, completion percentage, redacted content via TextRedactor, unlocked threshold tags, fragment progress) |
| `RuneAndRust.Core/Interfaces/IJournalScreenRenderer.cs` | Contract for journal screen rendering with single method: `Render(JournalViewModel)` |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/JournalViewHelper.cs` | Static helper class with 13 formatting utilities: `GetTabDisplayName()` (maps tab to human-readable name), `GetTabHotkey()` (maps tab to keyboard character), `GetTabColor()` (maps tab to Spectre.Console color with active state handling), `GetCompletionIndicator()` (returns ★/● with color markup), `GetCompletionColor()` (returns green/yellow/grey based on percentage), `FormatCompletionPercent()` (formats percentage with color), `GetCategoryIcon()` (maps EntryCategory to Unicode icon), `GetCategoryDisplayName()` (maps category to human-readable name), `GetCategoryColor()` (maps category to Spectre.Console color), `FormatThreshold()` (converts SCREAMING_SNAKE_CASE to Title Case), `ApplyGlitchEffect()` (applies stress-based glitch characters using stable pseudo-random), `FormatFragmentProgress()` (formats X/Y fragments with color) |
| `RuneAndRust.Terminal/Services/JournalScreenRenderer.cs` | Spectre.Console Layout renderer implementing IJournalScreenRenderer. Builds 4-row layout (Header [3 lines], TabBar [1 line], Body [flex with EntryList 40% + Details 60%], Footer [1 line]). Renders tab-specific borders/colors, selection indicators, completion indicators, redacted content with glitch effects when stress > 50, unlocked threshold discoveries, fragment progress, and navigation hints |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/JournalViewModelTests.cs` | 15 tests for `JournalService.BuildViewModelAsync()`: tab filtering (Codex/Bestiary/FieldGuide/Contracts), completion percentage setting, completion flag logic, detail building for selected entry, null details on no entries or out-of-range index, text redaction integration, unlocked threshold inclusion, character name setting, active tab setting, stress level setting, selected index setting, 1-based index assignment |
| `RuneAndRust.Tests/Terminal/JournalScreenRendererTests.cs` | 30 tests for JournalScreenRenderer and JournalViewHelper: renderer edge cases (empty entries, null details, high stress, complete entries, contracts tab), helper tab name mapping (4 tests), helper hotkey mapping (4 tests), helper tab color logic (5 tests for active/inactive states), completion indicator logic (2 tests), completion color logic (5 tests), category icon mapping (6 tests), threshold formatting (3 tests), glitch effect logic (4 tests for stress thresholds/whitespace preservation/stability), fragment progress formatting (3 tests) |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/IJournalService.cs` | Added `BuildViewModelAsync(Guid, string, JournalTab, int, int)` method signature (lines 12-25) with XML documentation describing ViewModel construction for full-screen journal UI with tab filtering, entry selection, and stress-based glitch effects |
| `RuneAndRust.Engine/Services/JournalService.cs` | Implemented `BuildViewModelAsync()` (lines 44-89): retrieves discovered entries via `IDataCaptureService.GetDiscoveredEntriesAsync()`, filters entries by tab using `MapCategoryToTab()` helper (lines 96-101), maps to `JournalEntryView` list with 1-based indices and completion flags, builds `JournalEntryDetailView` for selected index via `BuildEntryDetailsAsync()` (lines 109-134). Helper applies TextRedactor to entry content and retrieves threshold/fragment data from capture services |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added `RequiresJournalScreen` property to ParseResult class (lines 185-187) and registered "archive" command alias (lines 773-775) with debug logging for full-screen journal UI request |
| `RuneAndRust.Terminal/Program.cs` | Registered `IJournalScreenRenderer` as Singleton with `JournalScreenRenderer` implementation in DI container (lines 135-136) |

---

## Code Implementation Details

### ViewModels (RuneAndRust.Core/ViewModels/JournalViewModel.cs)

**Enum: JournalTab**
```csharp
public enum JournalTab
{
    Codex = 0,        // BlightOrigin, Factions, Technical, Geography
    Bestiary = 1,     // Bestiary entries
    FieldGuide = 2,   // FieldGuide entries
    Contracts = 3     // Quests (future placeholder)
}
```
- Tab navigation for grouping related entries
- Maps to EntryCategory values via `MapCategoryToTab()`
- Codex tab aggregates multiple lore categories

**Record: JournalViewModel**
```csharp
public record JournalViewModel(
    string CharacterName,
    int StressLevel,
    JournalTab ActiveTab,
    List<JournalEntryView> Entries,
    int SelectedEntryIndex,
    JournalEntryDetailView? SelectedDetail
);
```
- Main container for all journal UI state
- Immutable record pattern ensures snapshot consistency
- StressLevel drives glitch effects when > 50
- SelectedEntryIndex is 0-based for internal navigation
- SelectedDetail nullable when no valid selection

**Record: JournalEntryView**
```csharp
public record JournalEntryView(
    int Index,
    Guid EntryId,
    string Title,
    EntryCategory Category,
    int CompletionPercent,
    bool IsComplete
);
```
- Display-ready entry for list panel
- Index is 1-based for user-facing display
- IsComplete derived from `CompletionPercent >= 100`
- Category preserved for icon/color mapping

**Record: JournalEntryDetailView**
```csharp
public record JournalEntryDetailView(
    Guid EntryId,
    string Title,
    EntryCategory Category,
    int CompletionPercent,
    string RedactedContent,
    List<string> UnlockedThresholds,
    int FragmentsCollected,
    int FragmentsRequired
);
```
- Detail panel with full entry information
- RedactedContent generated via `TextRedactor.RedactText(entry.FullText, CompletionPercent)`
- UnlockedThresholds retrieved via `IDataCaptureService.GetUnlockedThresholdsAsync()`
- Fragment counts retrieved via `IDataCaptureRepository.GetFragmentCountAsync()`

### Service Method: JournalService.BuildViewModelAsync

**Method Signature:**
```csharp
public async Task<JournalViewModel> BuildViewModelAsync(
    Guid characterId,
    string characterName,
    JournalTab tab,
    int selectedIndex = 0,
    int stressLevel = 0)
```

**Behavior:**
- Retrieves all discovered entries via `IDataCaptureService.GetDiscoveredEntriesAsync(characterId)`
- Filters entries by tab using `MapCategoryToTab()` helper
- Sorts filtered entries alphabetically by title
- Maps to `JournalEntryView` list with 1-based display indices
- Sets `IsComplete` flag based on `CompletionPercent >= 100`
- Builds `JournalEntryDetailView` only if selectedIndex is valid (0 to Count-1)
- Returns null SelectedDetail if index out of range or no entries
- Logs trace for ViewModel build start and debug for filtered entry count

**Private Helper: MapCategoryToTab**
```csharp
private static JournalTab MapCategoryToTab(EntryCategory category) => category switch
{
    EntryCategory.Bestiary => JournalTab.Bestiary,
    EntryCategory.FieldGuide => JournalTab.FieldGuide,
    _ => JournalTab.Codex // BlightOrigin, Factions, Technical, Geography
};
```

**Behavior:**
- Maps EntryCategory to JournalTab for filtering
- Codex tab aggregates BlightOrigin, Factions, Technical, Geography
- Contracts tab currently returns no entries (future quest system placeholder)

**Private Helper: BuildEntryDetailsAsync**
```csharp
private async Task<JournalEntryDetailView?> BuildEntryDetailsAsync(Guid characterId, Guid entryId)
```

**Behavior:**
- Retrieves full CodexEntry via `ICodexEntryRepository.GetByIdAsync(entryId)`
- Returns null with warning log if entry not found
- Retrieves completion percentage via `IDataCaptureService.GetCompletionPercentageAsync()`
- Retrieves unlocked thresholds via `IDataCaptureService.GetUnlockedThresholdsAsync()`
- Retrieves fragment count via `IDataCaptureRepository.GetFragmentCountAsync()`
- Applies TextRedactor to entry.FullText using completion percentage
- Logs trace for detail build start and warning for missing entries

### Static Helpers: JournalViewHelper

**Tab Color Mapping:**
- Codex → "gold1" (ancient knowledge/lore)
- Bestiary → "red" (danger/creatures)
- FieldGuide → "cyan" (mechanics/tutorials)
- Contracts → "green" (quests/objectives)
- Inactive tabs → "grey" (all tabs when not active)

**Tab Hotkey Mapping:**
- Codex → 'C'
- Bestiary → 'B'
- FieldGuide → 'F'
- Contracts → 'Q' (Quest)

**Category Icon Mapping (Unicode):**
- FieldGuide → "\u2139" (ℹ Information)
- BlightOrigin → "\u2623" (☣ Biohazard)
- Bestiary → "\u2620" (☠ Skull and crossbones)
- Factions → "\u2694" (⚔ Crossed swords)
- Technical → "\u2699" (⚙ Gear)
- Geography → "\u2302" (⌂ House/landmark)
- Unknown → "\u25CF" (● Bullet point)

**Category Color Mapping:**
- FieldGuide → "cyan"
- BlightOrigin → "magenta1"
- Bestiary → "red"
- Factions → "orange1"
- Technical → "blue"
- Geography → "green"

**Completion Indicators:**
- Complete (100%): `[green]★[/]` (filled star)
- Incomplete (<100%): `[grey]●[/]` (bullet point)

**Completion Colors:**
- 100%: "green" (fully discovered)
- 50-99%: "yellow" (partially discovered)
- 0-49%: "grey" (minimal discovery)

**Threshold Formatting: FormatThreshold**
```csharp
public static string FormatThreshold(string tag)
```
- **Algorithm:** Converts SCREAMING_SNAKE_CASE to Title Case
  - Splits on underscore
  - Capitalizes first letter of each word
  - Lowercases remaining letters
  - Joins with spaces
- Example: "WEAKNESS_REVEALED" → "Weakness Revealed"
- Returns empty string for null/empty input

**Glitch Effect: ApplyGlitchEffect**
```csharp
public static string ApplyGlitchEffect(string text, int stressLevel)
```
- **Algorithm:** Randomly replaces characters with glitch blocks when stress > 50
  - Glitch character set: "░▒▓█▀▄"
  - Glitch rate: (stressLevel - 50) / 100.0 (0% at stress 50, 50% at stress 100)
  - Uses stable pseudo-random seeded by text.GetHashCode() for consistent rendering
  - Preserves whitespace (spaces, newlines, etc.)
- Returns original text if stressLevel < 50
- Returns modified text with glitch characters replacing random non-whitespace characters
- **Stability:** Same input text + stress always produces same glitched output

**Fragment Progress: FormatFragmentProgress**
```csharp
public static string FormatFragmentProgress(int collected, int required)
```
- Format: `[color]collected[/]/[grey]required[/] fragments`
- Color: "green" if collected >= required, "yellow" otherwise
- Example: `[yellow]9[/]/[grey]12[/] fragments`

### Renderer: JournalScreenRenderer

**Layout Structure (Spectre.Console):**
```
Root
├── Header (Size: 3 lines)
│   └── Panel: Rule with "THE ARCHIVE - {CharacterName}"
├── TabBar (Size: 1 line)
│   └── Markup: Tab navigation with hotkeys and active highlight
├── Body (Flex)
│   ├── EntryList (Ratio: 4 = 40%)
│   │   └── Panel: Entry rows with selection indicator, completion indicator, percentage
│   └── Details (Ratio: 6 = 60%)
│       └── Panel: Title, category, progress, redacted content, thresholds, fragments
└── Footer (Size: 1 line)
    └── Markup: Navigation controls and tab switching hints
```

**Key Method: Render(JournalViewModel)**
- Clears screen with `AnsiConsole.Clear()`
- Builds layout with active tab-specific border colors
- Highlights selected entry with yellow ">" prefix
- Shows completion indicators (★ for complete, ● for incomplete)
- Displays completion percentages with color coding (green/yellow/grey)
- Renders category icons and colors in detail panel
- Applies glitch effect to redacted content when StressLevel > 50
- Shows unlocked threshold discoveries with green checkmarks
- Displays fragment progress with color-coded collected/required counts
- Shows tab-specific empty messages for Contracts ("coming soon") vs other tabs ("no entries")
- Footer shows navigation hints: [↑/↓] Navigate  [C/B/F/Q] Switch Tab  [ESC] Close

**Private Methods:**
- `CreateHeader()`: Rule panel with character name in gold1
- `CreateTabBar()`: Markup with tab hotkeys, active tab in bold with tab-specific color
- `CreateEntryListPanel()`: Entry rows with 1-based indices, selection indicator, completion status
- `CreateDetailsPanel()`: Full entry details with redacted content (glitched if stressed), thresholds, fragments
- `CreateFooter()`: Navigation controls markup in grey

---

## Logging Matrix

### JournalService (Engine Layer)

| Event | Level | Template |
|-------|-------|----------|
| ViewModel build start | Trace | `"[Journal] Building ViewModel for {CharacterId}, Tab={Tab}"` |
| Filtered entry count | Debug | `"[Journal] Found {Count} entries for {Tab}"` |
| Entry details build start | Trace | `"[Journal] Building details for Entry {EntryId}"` |
| Entry not found | Warning | `"[Journal] Entry {EntryId} not found"` |
| Journal list format start | Debug | `"Formatting journal list for Character {CharacterId}"` |
| No discovered entries | Debug | `"No discovered entries for Character {CharacterId}"` |
| Category processing | Trace | `"Processing category {Category} with {Count} entries"` |
| Journal list formatted | Debug | `"Formatted {Count} entries for journal list"` |
| Entry detail format start | Debug | `"Formatting entry detail for '{EntryTitle}'"` |
| Entry title not found | Debug | `"Entry '{EntryTitle}' not found"` |
| Entry detail metadata | Trace | `"Entry {EntryTitle} has {Pct}% completion and {ThresholdCount} unlocked thresholds"` |
| Entry detail formatted | Debug | `"Formatted entry detail for '{EntryTitle}' at {Pct}%"` |
| Unassigned captures format start | Debug | `"Formatting unassigned captures for Character {CharacterId}"` |
| No unassigned captures | Debug | `"No unassigned captures for Character {CharacterId}"` |
| Unassigned capture processing | Trace | `"Formatting unassigned capture {CaptureId}: {CaptureType}"` |
| Unassigned captures formatted | Debug | `"Formatted {Count} unassigned captures"` |

### JournalScreenRenderer (Terminal Layer)

| Event | Level | Template |
|-------|-------|----------|
| Render start | Trace | `"[Journal] Rendering screen for {Character}"` |
| Render complete | Trace | `"[Journal] Render complete"` |

### CommandParser (Engine Layer)

| Event | Level | Template |
|-------|-------|----------|
| Journal screen request | Debug | `"Full journal screen requested (v0.3.7c)."` |

---

## Test Coverage

**Summary:**
```
Total: 74 | Passed: 74 | Failed: 0 | Duration: 72ms
```

**Breakdown:**
- JournalViewModelTests: 15 tests
- JournalScreenRendererTests: 30 tests
- Pre-existing JournalService tests: 29 tests (from v0.3.6a)

### Complete Test Inventory

#### JournalViewModelTests (15 tests)

| Test Name | Description |
|-----------|-------------|
| `BuildViewModelAsync_FiltersByTab_Codex` | Verifies Codex tab contains only BlightOrigin, Factions, Technical, Geography categories (4 entries from 6 total) |
| `BuildViewModelAsync_FiltersByTab_Bestiary` | Verifies Bestiary tab contains only Bestiary category entries (2 entries from 3 total) |
| `BuildViewModelAsync_FiltersByTab_FieldGuide` | Verifies FieldGuide tab contains only FieldGuide category entries (2 entries from 3 total) |
| `BuildViewModelAsync_Contracts_ReturnsEmpty` | Asserts Contracts tab returns empty list (no EntryCategory maps to Contracts), SelectedDetail is null |
| `BuildViewModelAsync_SetsCompletionPercent` | Verifies CompletionPercent values (45%, 100%) are preserved in JournalEntryView records |
| `BuildViewModelAsync_SetsIsComplete_WhenPercentIs100` | Asserts IsComplete flag is true when CompletionPercent = 100, false otherwise |
| `BuildViewModelAsync_BuildsDetailsForSelectedEntry` | With selectedIndex=0, SelectedDetail.Title matches Entries[0].Title, CompletionPercent = 75, FragmentsCollected = 9, UnlockedThresholds contains "WEAKNESS_REVEALED" |
| `BuildViewModelAsync_NullDetails_WhenNoEntries` | With empty discovered entries list, Entries is empty and SelectedDetail is null |
| `BuildViewModelAsync_NullDetails_WhenIndexOutOfRange` | With selectedIndex=999, SelectedDetail is null even though entries exist |
| `BuildViewModelAsync_RedactsContent` | With CompletionPercent=50, SelectedDetail.RedactedContent contains `[grey]████[/]` redaction blocks from TextRedactor |
| `BuildViewModelAsync_IncludesUnlockedThresholds` | With CompletionPercent=100, SelectedDetail.UnlockedThresholds contains all 3 threshold tags ("WEAKNESS_REVEALED", "HABITAT_REVEALED", "FULL_ENTRY") |
| `BuildViewModelAsync_SetsCharacterName` | Asserts CharacterName = "Scholar Artemis" matches input parameter |
| `BuildViewModelAsync_SetsActiveTab` | Asserts ActiveTab = JournalTab.Bestiary matches input parameter |
| `BuildViewModelAsync_SetsStressLevel` | Asserts StressLevel = 75 matches input parameter |
| `BuildViewModelAsync_SetsSelectedEntryIndex` | Asserts SelectedEntryIndex = 2 matches input parameter |
| `BuildViewModelAsync_AssignsOneBasedIndices` | Verifies Entries[0].Index = 1, Entries[1].Index = 2, Entries[2].Index = 3 (1-based display indexing) |

#### JournalScreenRendererTests (30 tests)

| Test Name | Description |
|-----------|-------------|
| `Render_WithEmptyEntryList_DoesNotThrow` | Renderer handles empty Entries list without exceptions |
| `Render_WithEntries_DoesNotThrow` | Renderer handles ViewModel with 2 entries without exceptions |
| `Render_WithSelectedEntry_DoesNotThrow` | Renderer handles ViewModel with SelectedEntryIndex=1 without exceptions |
| `Render_WithEntryDetails_DoesNotThrow` | Renderer handles ViewModel with full JournalEntryDetailView without exceptions |
| `Render_WithNullDetails_DoesNotThrow` | Renderer handles ViewModel with SelectedDetail=null without exceptions |
| `Render_WithContractsTab_DoesNotThrow` | Renderer handles ViewModel with ActiveTab=Contracts (empty placeholder tab) without exceptions |
| `Render_WithHighStressLevel_DoesNotThrow` | Renderer handles ViewModel with StressLevel=75 (glitch effects active) without exceptions |
| `Render_WithCompleteEntry_DoesNotThrow` | Renderer handles entry with CompletionPercent=100 and IsComplete=true without exceptions |
| `GetTabDisplayName_ReturnsCorrectName` | Theory test (4 cases): Codex→"Codex", Bestiary→"Bestiary", FieldGuide→"Field Guide", Contracts→"Contracts" |
| `GetTabHotkey_ReturnsCorrectHotkey` | Theory test (4 cases): Codex→'C', Bestiary→'B', FieldGuide→'F', Contracts→'Q' |
| `GetTabColor_ReturnsGrey_WhenNotActive` | With isActive=false, color is "grey" regardless of tab |
| `GetTabColor_ReturnsCorrectColor_WhenActive` | Theory test (4 cases): Codex→"gold1", Bestiary→"red", FieldGuide→"cyan", Contracts→"green" when isActive=true |
| `GetCompletionIndicator_ReturnsStar_WhenComplete` | With isComplete=true, indicator contains "★" (U+2605) and "green" markup |
| `GetCompletionIndicator_ReturnsBullet_WhenIncomplete` | With isComplete=false, indicator contains "●" (U+25CF) and "grey" markup |
| `GetCompletionColor_ReturnsCorrectColor` | Theory test (5 cases): 100%→"green", 75%→"yellow", 50%→"yellow", 49%→"grey", 0%→"grey" |
| `GetCategoryIcon_ReturnsCorrectIcon` | Theory test (6 cases): FieldGuide→ℹ, BlightOrigin→☣, Bestiary→☠, Factions→⚔, Technical→⚙, Geography→⌂ |
| `FormatThreshold_ConvertsSnakeCaseToTitleCase` | "WEAKNESS_REVEALED" → "Weakness Revealed" |
| `FormatThreshold_HandlesSingleWord` | "COMPLETE" → "Complete" |
| `FormatThreshold_HandlesEmptyString` | "" → "" (returns empty string for empty input) |
| `ApplyGlitchEffect_ReturnsOriginal_WhenStressBelow50` | With stress=45, text returned unchanged |
| `ApplyGlitchEffect_ModifiesText_WhenStressAbove50` | With stress=80, text is modified but maintains same length |
| `ApplyGlitchEffect_PreservesWhitespace` | Spaces remain in glitched output |
| `ApplyGlitchEffect_IsStable_ForSameInput` | Same text + stress produces identical glitched output (stable pseudo-random) |
| `FormatFragmentProgress_ShowsCollectedAndRequired` | Output contains "5", "10", and "fragments" |
| `FormatFragmentProgress_UsesGreenWhenComplete` | With collected=10, required=10, output contains "green" markup |
| `FormatFragmentProgress_UsesYellowWhenIncomplete` | With collected=5, required=10, output contains "yellow" markup |

---

## DI Registration

**Location:** `RuneAndRust.Terminal/Program.cs` (lines 135-136)

```csharp
// Register Journal Screen Renderer (v0.3.7c)
services.AddSingleton<IJournalScreenRenderer, JournalScreenRenderer>();
```

**Lifetime:** Singleton (stateless renderer, safe for reuse)

---

## Verification Results

### Build Output

```
Build succeeded.

    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.94
```

**Notes:** Warning MSB3277 is a pre-existing EntityFrameworkCore version conflict, not introduced by this release.

### Test Output (Journal Tests Only)

```bash
dotnet test --filter "FullyQualifiedName~Journal"

Passed!  - Failed:     0, Passed:    74, Skipped:     0, Total:    74, Duration: 72 ms
```

**Breakdown:**
- JournalViewModelTests: 15 passed
- JournalScreenRendererTests: 30 passed
- Pre-existing JournalService tests: 29 passed (from v0.3.6a)

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Enums/
│   └── EntryCategory.cs
├── Interfaces/
│   ├── IJournalService.cs [MODIFIED]
│   └── IJournalScreenRenderer.cs [NEW]
└── ViewModels/
    └── JournalViewModel.cs [NEW]

RuneAndRust.Engine/Services/
├── JournalService.cs [MODIFIED]
└── CommandParser.cs [MODIFIED]

RuneAndRust.Terminal/
├── Program.cs [MODIFIED]
├── Rendering/
│   └── JournalViewHelper.cs [NEW]
└── Services/
    └── JournalScreenRenderer.cs [NEW]

RuneAndRust.Tests/
├── Engine/
│   └── JournalViewModelTests.cs [NEW]
└── Terminal/
    └── JournalScreenRendererTests.cs [NEW]
```

---

## Running Tests

### All Journal Tests
```bash
dotnet test --filter "FullyQualifiedName~Journal"
```

### Specific Test Classes
```bash
# ViewModel tests only
dotnet test --filter "FullyQualifiedName~JournalViewModelTests"

# Renderer tests only
dotnet test --filter "FullyQualifiedName~JournalScreenRendererTests"
```

### Full Test Suite
```bash
dotnet test RuneAndRust.Tests/RuneAndRust.Tests.csproj
```

---

## UI Layout Reference

### Header Section (3 lines)
```
══════════════════════════════════════════════════════════════
     THE ARCHIVE - {CharacterName}
══════════════════════════════════════════════════════════════
```

### Tab Bar Section (1 line)
```
  [C]odex  [b]estiary  [f]ield guide  [q]uests
```
*Active tab shown in bold with tab-specific color, inactive tabs in grey lowercase*

### Body Section (Split Layout)
```
╭──────────────────────────────╮╭─────────────────────────────╮
│ CODEX                        ││ DETAILS                     │
│  > 1. ★ The Glitch (100%)    ││ THE GLITCH                  │
│    2. ● Hrimthursar (80%)    ││                             │
│    3. ● Jötun Network (45%)  ││ Category: ☣ Blight Origin   │
│                              ││ Progress: 12/12 fragments   │
│                              ││           (100%)            │
│                              ││                             │
│                              ││ The Glitch is a catastrophic│
│                              ││ corruption event that severed│
│                              ││ post-human civilization...  │
│                              ││                             │
│                              ││ Discoveries:                │
│                              ││   ✓ Timeline Established    │
│                              ││   ✓ Cascade Mechanism       │
│                              ││   ✓ Full Entry              │
╰──────────────────────────────╯╰─────────────────────────────╯
```

*With high stress (>50), glitched content would appear:*
```
│ The Gl░tch ▒s a c▓t█strophic│
│ c▒rrupt░on ▓vent t▓at sever█d│
```

### Footer Section (1 line)
```
[↑/↓] Navigate  [C/B/F/Q] Switch Tab  [ESC] Close
```

---

## Commands Added

| Command | Description |
|---------|-------------|
| `archive` | Opens full-screen journal UI with tabbed navigation (primary alias) |

**Command Parser Logic:**
- Sets `ParseResult.RequiresJournalScreen = true`
- Logs: `"Full journal screen requested (v0.3.7c)."`
- Returns to caller for UI rendering loop integration

---

## Tab Filter Hotkeys

| Key | Tab | Color | Entry Types |
|-----|-----|-------|-------------|
| C | Codex | gold1 | BlightOrigin, Factions, Technical, Geography |
| B | Bestiary | red | Bestiary (creatures) |
| F | Field Guide | cyan | FieldGuide (mechanics/tutorials) |
| Q | Contracts | green | Quests (future placeholder) |

**Behavior:**
- Hotkey press rebuilds ViewModel with new tab filter
- Resets SelectedEntryIndex to 0 (first entry in new list)
- Active tab displayed in bold in tab bar
- Entry list panel borders use tab-specific color
- Inactive tabs displayed in lowercase grey

---

## Navigation Controls

| Key | Action |
|-----|--------|
| ↑ | Select previous entry (wraps to bottom) |
| ↓ | Select next entry (wraps to top) |
| C | Switch to Codex tab |
| B | Switch to Bestiary tab |
| F | Switch to Field Guide tab |
| Q | Switch to Contracts tab |
| ESC | Close journal screen |

---

## Category to Tab Mapping

**Codex Tab (Aggregates 4 categories):**
- BlightOrigin (☣ Biohazard icon, magenta1 color)
- Factions (⚔ Crossed swords icon, orange1 color)
- Technical (⚙ Gear icon, blue color)
- Geography (⌂ House icon, green color)

**Bestiary Tab:**
- Bestiary (☠ Skull icon, red color)

**Field Guide Tab:**
- FieldGuide (ℹ Information icon, cyan color)

**Contracts Tab:**
- *No current mapping (future quest system)*

---

## Text Redaction Integration

**TextRedactor Usage:**
- Applied in `JournalService.BuildEntryDetailsAsync()` via `_redactor.RedactText(entry.FullText, completionPercent)`
- Redaction level based on completion percentage (0-100)
- Redacted blocks appear as `[grey]████[/]` in Spectre.Console markup
- Words revealed progressively as fragments are collected

**Example Progression:**
- 0%: `[grey]████[/] [grey]████[/] [grey]████[/] [grey]████[/]`
- 50%: `The [grey]████[/] is a [grey]████[/] event`
- 100%: `The Glitch is a catastrophic event`

---

## Glitch Effect System

**Activation Threshold:**
- Stress level > 50 triggers glitch effects on detail panel content
- Glitch rate scales from 0% (stress 50) to 50% (stress 100)

**Glitch Algorithm:**
- Glitch character set: "░▒▓█▀▄" (Unicode block drawing characters)
- Pseudo-random seed derived from text hash for stability
- Whitespace preserved (spaces, newlines, punctuation)
- Same text + stress always produces identical glitched output

**Visual Examples:**
- Stress 50: No glitches (threshold not exceeded)
- Stress 65: `The Hrim░hursar roam▒ the frozen waste▓`
- Stress 80: `The H█imth▓rs░r r▒am▓ the f▓oz█n w▒ste▓`
- Stress 100: `T▓e H█im▓h▒rs█r ▓oam▓ t░e f█oz▓n w▒st▓▓`

**Implementation Note:**
- Glitch effect applied in `JournalScreenRenderer.CreateDetailsPanel()`
- Uses `JournalViewHelper.ApplyGlitchEffect(details.RedactedContent, stressLevel)`
- Only applied when StressLevel > 50

---

## Completion Indicator Logic

**Display Rules:**
- Complete (100%): `[green]★[/]` (filled star, green)
- Incomplete (<100%): `[grey]●[/]` (bullet point, grey)

**Completion Percentage Colors:**
- 100%: green (fully discovered)
- 50-99%: yellow (partially discovered)
- 0-49%: grey (minimal discovery)

**Fragment Progress Display:**
- Format: `X/Y fragments`
- Color: green when X >= Y, yellow otherwise
- Example: `[yellow]9[/]/[grey]12[/] fragments`

**Threshold Discovery Display:**
- Format: `✓ {Formatted Tag}` (green checkmark + title case tag)
- Example: `✓ Weakness Revealed` (from "WEAKNESS_REVEALED")
- Only shown when thresholds have been unlocked

---

## Next Steps

1. **Interactive Journal Loop (v0.3.7d)** - Implement interactive journal screen loop in Terminal layer with keyboard input handling, tab filtering, entry navigation, and seamless return to exploration
2. **Journal Search/Filter (v0.3.8a)** - Add text search box to filter entries by title or content keywords
3. **Entry Bookmarking (v0.3.8b)** - Allow players to bookmark important entries for quick access
4. **Comparison View (v0.3.8c)** - Side-by-side comparison of related entries (e.g., two creature variants)
5. **Export to File (v0.3.9a)** - Export discovered journal entries to markdown file for out-of-game reference
6. **Audio Log Playback (v0.4.0)** - Integrate audio log playback for special entries with voice acting

---

## Technical Notes

### Immutability Benefits
- ViewModels are immutable records, preventing accidental state mutation
- Renderer receives complete snapshot, eliminating partial update bugs
- Easy to test: construct ViewModel, verify output
- No defensive copying needed in renderer

### Performance Considerations
- ViewModel construction is O(n) where n = discovered entries count (typically 10-50)
- Tab filtering is O(n) linear scan, acceptable for small datasets
- Detail building is O(1) for single entry lookup
- Total complexity: O(n) per render, acceptable for UI update frequency
- Glitch effect is O(m) where m = text length, cached by stable random seed

### Nullability Handling
- `SelectedDetail` is nullable (`JournalEntryDetailView?`) when no valid selection
- Renderer gracefully displays "(Select an entry to view details)" for null case
- No `!` forgiveness used; all nullability is explicit
- Helper methods handle empty/null strings gracefully

### Color Accessibility
- Tab colors chosen for terminal visibility (gold1, red, cyan, green)
- Category colors follow semantic convention (red=danger, cyan=info, magenta=mystery)
- Completion colors use universal traffic light convention (green=complete, yellow=partial, grey=minimal)

### Unicode Icon Selection
- Icons chosen for cross-platform terminal compatibility
- All icons in Unicode Basic Multilingual Plane (U+2000-U+27FF)
- Fallback bullet (●) for unknown categories
- Tested on macOS Terminal, Windows Terminal, and Linux terminals

### Layout Ratios
- Entry list (40%): Optimized for 30-40 character entry titles + completion indicators
- Details panel (60%): Allows 8-10 lines of redacted text + metadata + thresholds
- Header (3 lines): Rule + title + padding for visual separation
- TabBar (1 line): Compact tab navigation with hotkeys
- Footer (1 line): Essential navigation hints

### Glitch Effect Stability
- Uses `text.GetHashCode()` as pseudo-random seed
- Same text always produces same glitched pattern at same stress level
- Prevents visual "flickering" on repeated renders
- Whitespace preservation maintains readability
- Glitch rate scales linearly with stress (0-50% character replacement)

### Async Pattern Consistency
- `BuildViewModelAsync()` follows established async naming convention
- Uses `await` for all database and service calls
- Returns `Task<JournalViewModel>` for async/await compatibility
- Consistent with `BuildViewModel()` patterns from CraftingService and InventoryService

---

**Release verified by:** The Chronicle-Smith
**Architectural patterns validated:** ViewModel, Renderer Service, Static Helper, Async Builder
**Code quality:** 0 build errors, 0 test failures, strict nullability enforced
**Documentation completeness:** 100% (all files, all methods, all tests documented)
