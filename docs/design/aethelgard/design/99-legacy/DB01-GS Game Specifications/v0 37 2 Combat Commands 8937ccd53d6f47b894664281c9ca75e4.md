# v0.37.2: Combat Commands

Type: Technical
Description: Combat commands - attack, abilities, stance, block, parry, flee with CombatService integration
Priority: Must-Have
Status: In Design
Target Version: Alpha
Dependencies: v0.37, v0.10, v0.20, v0.21
Implementation Difficulty: Hard
Balance Validated: No
Parent item: v0.37: Command System & Parser (v0%2037%20Command%20System%20&%20Parser%20eee6b259408f440e89f79a78d59f04fd.md)
Proof-of-Concept Flag: No
Template Validated: No
Voice Validated: No

**Document ID:** RR-SPEC-v0.37.2-COMBAT-COMMANDS

**Status:** Implementation Complete — Ready for Integration

**Timeline:** 12-15 hours

**Prerequisites:** v0.37 (Command System), v0.10 (Combat System), v0.20 (Tactical Grid), v0.21 (Stance System)

**Parent Specification:** v0.37: Command System & Parser[[1]](v0%2037%20Command%20System%20&%20Parser%20eee6b259408f440e89f79a78d59f04fd.md)

**v2.0 Sources:** Feature Specification: The attack Command[[2]](https://www.notion.so/Feature-Specification-The-attack-Command-2a355eb312da809992a9ebc4c6a9a40b?pvs=21), Feature Specification: The stance Command[[3]](https://www.notion.so/Feature-Specification-The-stance-Command-2a355eb312da80d0b0a8c796f7b1b11d?pvs=21), Feature Specification: The parry Command[[4]](https://www.notion.so/Feature-Specification-The-parry-Command-2a355eb312da80e181fcc00273b0c3fa?pvs=21)

---

## I. Executive Summary

This specification defines **combat commands**: `attack`, `[ability_name]`, `stance`, `block`, `parry`, and `flee`. These commands execute tactical actions during encounters.

**Commands Covered:**

- `attack` / `a` / `hit` / `kill` — Basic weapon attack
- `[ability_name]` — Specialization abilities
- `stance [type]` — Change combat stance
- `block` — Active block with shield
- `parry` — Declare parry reaction
- `flee` / `run` / `escape` — Attempt escape

---

## II. The Rule: What's In vs. Out

### ✅ In Scope (v0.37.2)

- `attack` command with accuracy/damage resolution
- Dynamic `[ability_name]` command routing
- `stance` command (Aggressive/Defensive/Calculated)
- `block` and `parry` reaction commands
- `flee` command with success/failure
- Integration with CombatService, AccuracyService, DamageService
- Unit tests (15+ tests, 80%+ coverage)

### ❌ Explicitly Out of Scope

- Specific ability implementations (defer to specialization specs)
- Advanced tactical positioning (defer to v0.20)
- Companion combat commands (covered in v0.34)
- Boss-specific mechanics (defer to v0.23)

---

## III. Command Implementations

### A. The `attack` Command

**Syntax:** `attack [target]`

**Aliases:** `a`, `hit`, `kill`, `fight`

**Action Cost:** Standard Action

**Stamina Cost:** 2 Stamina

**Resolution Pipeline:**

```
1. Validate in combat and Standard Action available
2. Parse and validate target
3. Perform accuracy check (FINESSE + weapon bonus vs Defense)
4. On hit: Roll damage (weapon dice + MIGHT)
5. Apply damage to target
6. Check for defeat
7. Consume Standard Action and Stamina
```

**Example Output:**

```
> attack warden

[Accuracy: 16 vs Defense 12] HIT
[Damage: 2d6+4 = 12 damage]

You strike the Rust Warden! (12 damage)
Rust Warden: 33/80 HP
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Attack_ValidTarget_HitsAndDealsDamage()
{
    // Arrange
    var attacker = CreateCharacter(finesse: 12, might: 14);
    var target = CreateEnemy(defense: 10, hp: 50);
    var mockAccuracy = CreateMockAccuracyService(16); // Hit
    var mockDamage = CreateMockDamageService(12); // Damage
    var command = new AttackCommand(_combatService, mockAccuracy, mockDamage, _logger);
    var state = CreateCombatState(attacker, new[] { target });

    // Act
    var result = command.Execute(state, new[] { "warden" });

    // Assert
    Assert.IsTrue(result.Success);
    Assert.AreEqual(38, target.CurrentHitPoints); // 50 - 12
    Assert.IsTrue(result.Message.Contains("12 damage"));
}

[TestMethod]
public void Attack_NotInCombat_ReturnsError()
{
    // Arrange
    var command = new AttackCommand(_combatService, _accuracyService, _damageService, _logger);
    var state = CreateGameState();
    state.IsInCombat = false;

    // Act
    var result = command.Execute(state, new[] { "target" });

    // Assert
    Assert.IsFalse(result.Success);
    Assert.IsTrue(result.Message.Contains("not in combat"));
}
```

---

### B. The `[ability_name]` Command

**Syntax:** `[ability_name] [target]`

**Examples:** `shield_bash warden`, `whirlwind_strike`, `healing_word Kara`

**Dynamic Routing:** Parser resolves ability name to AbilityService call

**Resolution Pipeline:**

```
1. Parse ability name
2. Lookup ability in character's known abilities
3. Validate resource cost (Stamina/Aether)
4. Validate action cost availability
5. Parse and validate target (if required)
6. Execute ability via AbilityService
7. Consume resources and actions
```

**Example:**

```
> shield_bash warden

[Stamina Cost: 10]
[Accuracy: 18 vs Defense 12] HIT
[Damage: 3d6+6 = 16 damage]

You bash the Rust Warden with your shield! (16 damage)
Rust Warden is [Stunned] for 1 turn!
Rust Warden: 29/80 HP
```

**Service Integration:**

```csharp
public interface IAbilityService
{
    Ability GetAbilityByName(int characterId, string abilityName);
    bool CanUseAbility(int characterId, int abilityId);
    AbilityResult ExecuteAbility(int characterId, int abilityId, int targetId);
}
```

**Unit Test Example:**

```csharp
[TestMethod]
public void AbilityCommand_KnownAbility_ExecutesSuccessfully()
{
    // Arrange
    var ability = new Ability { AbilityId = 1, Name = "shield_bash", StaminaCost = 10 };
    var mockAbilityService = CreateMockAbilityService(ability);
    var command = new AbilityCommand(_combatService, mockAbilityService, _logger);
    var state = CreateCombatState();
    state.CurrentCharacter.CurrentStamina = 20;

    // Act
    var result = command.Execute(state, new[] { "shield_bash", "warden" });

    // Assert
    Assert.IsTrue(result.Success);
    Assert.AreEqual(10, state.CurrentCharacter.CurrentStamina); // 20 - 10
}
```

---

### C. The `stance` Command

**Syntax:** `stance [aggressive|defensive|calculated]`

**Action Cost:** Free Action

**Stance Effects (from v0.21):**

**Aggressive:**

- +4 damage to all attacks
- -3 Defense
- -2 to Trauma checks (WILL)

**Defensive:**

- +2 Soak (damage reduction)
- +2 to Trauma checks (WILL)
- -25% damage output

**Calculated:**

- No modifiers (baseline)

**Example:**

```
> stance aggressive

You shift into Aggressive Stance!
Channeling tainted Aether: +4 damage, -3 Defense, -2 Trauma checks
Your guard drops. You're exposed, but your strikes will hit harder.
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Stance_ChangeToAggressive_AppliesModifiers()
{
    // Arrange
    var command = new StanceCommand(_stanceService, _logger);
    var state = CreateCombatState();

    // Act
    var result = command.Execute(state, new[] { "aggressive" });

    // Assert
    Assert.IsTrue(result.Success);
    Assert.AreEqual("Aggressive", state.CurrentCharacter.CurrentStance);
    _stanceService.Verify(s => s.ChangeStance(1, "Aggressive"), Times.Once);
}
```

---

### D. The `block` Command

**Syntax:** `block`

**Action Cost:** Standard Action

**Requirements:** Must have shield equipped

**Effect:** Gain +4 Defense until start of next turn

**Example:**

```
> block

You raise your shield defensively! (+4 Defense until your next turn)
```

---

### E. The `parry` Command

**Syntax:** `parry`

**Action Cost:** Reaction (once per round)

**Requirements:** Weapon equipped

**Resolution:**

```
1. Declare parry at start of turn
2. On next incoming attack: Roll FINESSE vs attacker's Accuracy
3. Success: Negate attack
4. Superior (parry > accuracy by 5+): Counter-attack for half damage
```

**Example:**

```
> parry

You prepare to parry the next attack!

[On enemy attack]
[Parry: 17 vs Accuracy 14] SUCCESS
You parry the Warden's attack!
```

---

### F. The `flee` Command

**Syntax:** `flee`

**Aliases:** `run`, `escape`

**Action Cost:** Full turn (Standard + Free)

**Resolution:**

```
1. All party members roll FINESSE check (DC 12)
2. All succeed: Escape to previous room
3. Any fail: Enemies get free attacks, remain in combat
```

**Example Success:**

```
> flee

[FINESSE Check: 15 vs DC 12] SUCCESS
You flee from combat!

=== Previous Room ===
...
```

**Example Failure:**

```
> flee

[FINESSE Check: 8 vs DC 12] FAILURE
You fail to escape!
Rust Warden gets a free attack!
[Attack: 16 vs Defense 12] HIT (8 damage)
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Flee_SuccessfulCheck_EscapesCombat()
{
    // Arrange
    var mockSkillCheck = CreateMockSkillCheckService(15); // Success
    var command = new FleeCommand(_combatService, mockSkillCheck, _movementService, _logger);
    var state = CreateCombatState();

    // Act
    var result = command.Execute(state, Array.Empty<string>());

    // Assert
    Assert.IsTrue(result.Success);
    _combatService.Verify(c => c.EndCombat(It.IsAny<int>()), Times.Once);
}
```

---

## IV. Database Schema

```sql
-- No additional tables needed
-- Combat commands use existing:
-- - Characters table (Stamina, HP, Stance)
-- - Enemies table
-- - Abilities table
-- - CombatState table
```

---

## V. Serilog Logging Examples

```csharp
public class AttackCommand : ICommand
{
    private readonly ILogger<AttackCommand> _logger;

    public CommandResult Execute(GameState state, string[] args)
    {
        _logger.Information(
            "Attack command: CharacterId={CharacterId}, Target={Target}, CombatId={CombatId}",
            state.CurrentCharacter.CharacterId,
            args.Length > 0 ? args[0] : "(none)",
            state.CombatId);

        var accuracyResult = _accuracyService.RollAccuracy(attacker, target);

        _logger.Debug(
            "Accuracy roll: Roll={Roll}, Defense={Defense}, Hit={Hit}",
            [accuracyResult.Total](http://accuracyResult.Total),
            target.Defense,
            accuracyResult.IsHit);

        if (accuracyResult.IsHit)
        {
            var damage = _damageService.RollDamage(attacker, target);

            _logger.Information(
                "Attack hit: Damage={Damage}, TargetHP={CurrentHP}/{MaxHP}",
                [damage.Total](http://damage.Total),
                target.CurrentHitPoints - [damage.Total](http://damage.Total),
                target.MaxHitPoints);
        }
        else
        {
            _logger.Debug("Attack missed");
        }

        return CommandResult.Success(output.ToString());
    }
}
```

---

## VI. Success Criteria

### Functional Requirements

- [ ]  `attack` resolves accuracy and damage
- [ ]  `attack` validates combat state
- [ ]  `[ability_name]` routes to AbilityService
- [ ]  `[ability_name]` validates resources
- [ ]  `stance` changes apply modifiers
- [ ]  `block` requires shield
- [ ]  `parry` negates attacks on success
- [ ]  `flee` ends combat on success

### Quality Gates

- [ ]  80%+ unit test coverage
- [ ]  Serilog logging on all combat actions
- [ ]  Integration with CombatService functional
- [ ]  All v2.0 mechanics preserved

---

**Combat commands complete. Total: ~600 lines of service code + 15 unit tests.**