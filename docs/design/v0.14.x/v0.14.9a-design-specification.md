# v0.14.9a Design Specification: Dialogue Schema

**Version:** 0.14.9a
**Parent:** v0.14.9 (Advanced Descriptor Configuration Schemas)
**Prerequisites:** v0.14.8 Complete (Dice Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Schema Root Definition](#4-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [Dialogue Tree Array Structure](#42-dialogue-tree-array-structure)
5. [DialogueNode Definition](#5-dialoguenode-definition)
   - 5.1 [Core Properties](#51-core-properties)
   - 5.2 [Node Behavior](#52-node-behavior)
   - 5.3 [Conditional Visibility](#53-conditional-visibility)
6. [DialogueOption Definition](#6-dialogueoption-definition)
   - 6.1 [Option Properties](#61-option-properties)
   - 6.2 [Skill Check Integration](#62-skill-check-integration)
   - 6.3 [Outcome Association](#63-outcome-association)
7. [SkillCheck Definition](#7-skillcheck-definition)
   - 7.1 [Attribute Types](#71-attribute-types)
   - 7.2 [Target Value Calculation](#72-target-value-calculation)
   - 7.3 [Optional Skill Bonus](#73-optional-skill-bonus)
8. [Outcome Definition](#8-outcome-definition)
   - 8.1 [Outcome Types](#81-outcome-types)
   - 8.2 [Reputation Effects](#82-reputation-effects)
   - 8.3 [Quest Integration](#83-quest-integration)
9. [Condition Definition](#9-condition-definition)
   - 9.1 [Condition Types](#91-condition-types)
   - 9.2 [Comparison Operators](#92-comparison-operators)
   - 9.3 [Condition Evaluation](#93-condition-evaluation)
10. [Validation Rules](#10-validation-rules)
    - 10.1 [Node ID Pattern](#101-node-id-pattern)
    - 10.2 [Cross-Reference Validation](#102-cross-reference-validation)
    - 10.3 [Cycle Detection](#103-cycle-detection)
11. [Configuration Schema](#11-configuration-schema)
12. [Existing Dialogue Files](#12-existing-dialogue-files)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)
20. [Appendix: Schema Validation Examples](#20-appendix-schema-validation-examples)

---

## 1. Executive Summary

Version 0.14.9a introduces the **Dialogue Schema** (`dialogue.schema.json`), which provides a comprehensive JSON schema for validating NPC dialogue trees. This schema enables full customization of conversation systems including dialogue nodes, response options, skill checks, and outcomes—all without code changes.

The Dialogue Schema validates the existing 8 dialogue files in `docs/design/descriptors/dialogues/` and establishes a standard structure for future NPC conversations, supporting branching dialogues, attribute-based skill checks, reputation effects, quest integration, and conditional option visibility.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `dialogue.schema.json` |
| **Schema Definitions** | `DialogueNode`, `DialogueOption`, `SkillCheck`, `Outcome`, `Condition` |
| **Configuration Updates** | 8 existing dialogue files updated with schema reference |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Structured dialogue trees** - Validated branching conversation flows
- **Skill check integration** - Attribute-based checks with configurable targets
- **Outcome system** - 8 outcome types covering combat, reputation, quests, and more
- **Conditional options** - Show/hide dialogue choices based on game state
- **Faction reputation** - Integrated reputation gain/loss tracking
- **Cross-reference validation** - Ensure NextNodeId references exist

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               v0.14.9 ADVANCED DESCRIPTOR CONFIGURATION SCHEMAS              │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.9a: dialogue.schema.json ◀── THIS VERSION (DIALOGUE TREES)      │
  │  v0.14.9b: ability-descriptors.schema.json (Galdr, weapon arts)        │
  │  v0.14.9c: npc-descriptors.schema.json (appearance, barks, reactions)  │
  │  v0.14.9d: psychological-descriptors.schema.json (stress, trauma)      │
  │  v0.14.9e: capture-templates.schema.json (lore fragments)              │
  └─────────────────────────────────────────────────────────────────────────┘

  Existing Dialogue Files (8 total):
  ├── docs/design/descriptors/dialogues/bjorn_dialogues.json
  ├── docs/design/descriptors/dialogues/sigrun_dialogues.json
  ├── docs/design/descriptors/dialogues/astrid_dialogues.json
  ├── docs/design/descriptors/dialogues/eydis_dialogues.json
  ├── docs/design/descriptors/dialogues/gunnar_dialogues.json
  ├── docs/design/descriptors/dialogues/kjartan_dialogues.json
  ├── docs/design/descriptors/dialogues/rolf_dialogues.json
  └── docs/design/descriptors/dialogues/thorvald_dialogues.json

  Related Systems:
  • Faction reputation (RustClans, MidgardCombine, etc.)
  • Quest system (quest_scrap_collection, etc.)
  • Combat initiation (enemy IDs)
  • World state flags
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DIALOGUE SCHEMA FEATURE TREE                            │
└─────────────────────────────────────────────────────────────────────────────┘

dialogue.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── Array of DialogueNode objects
│   └── Minimum 1 node required
│
├── DialogueNode Definition
│   ├── Core Properties
│   │   ├── Id (unique node identifier)
│   │   ├── Text (NPC dialogue text)
│   │   ├── Options[] (player response choices)
│   │   └── EndsConversation (boolean flag)
│   │
│   └── Optional Properties
│       └── Conditions[] (visibility conditions)
│
├── DialogueOption Definition
│   ├── Core Properties
│   │   ├── Text (player choice text)
│   │   └── NextNodeId (navigation target or null)
│   │
│   ├── Optional Properties
│   │   ├── SkillCheck (attribute test)
│   │   ├── Outcome (action result)
│   │   └── Conditions[] (option visibility)
│   │
│   └── Display Hints
│       └── [ATTRIBUTE N] prefix in Text
│
├── SkillCheck Definition
│   ├── Attribute (might, finesse, will, wits)
│   ├── TargetValue (difficulty number)
│   ├── Skill (optional skill name)
│   └── SkillRanks (optional bonus)
│
├── Outcome Definition
│   ├── Type (8 outcome types)
│   ├── Data (context-specific)
│   ├── ReputationChange (integer)
│   └── AffectedFaction (faction ID)
│
└── Condition Definition
    ├── Type (5 condition types)
    ├── Target (reference ID)
    ├── Value (comparison value)
    └── Operator (comparison type)
```

---

## 3. Architecture Diagrams

### 3.1 Dialogue Tree Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DIALOGUE TREE STRUCTURE                               │
└─────────────────────────────────────────────────────────────────────────────┘

                         [NPC_NAME]_dialogues.json
                  ┌──────────────────────────────────────┐
                  │  Array of DialogueNode objects       │
                  │  [                                   │
                  │    { Id: "npc_greeting", ... },      │
                  │    { Id: "npc_about", ... },         │
                  │    { Id: "npc_quest", ... },         │
                  │    ...                               │
                  │  ]                                   │
                  └──────────────┬───────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DialogueNode                                      │
│─────────────────────────────────────────────────────────────────────────────│
│  Id: "bjorn_greeting"                                                        │
│  Text: "This is MY territory. Leave your supplies and go, or things get..."  │
│  Options: [                                                                  │
│    { Text: "I'm not giving you anything. [Fight]", ... },                   │
│    { Text: "[WILL 4] Stand down. We don't have to do this.", ... },         │
│    { Text: "There's enough for both of us here.", ... }                     │
│  ]                                                                           │
│  EndsConversation: false                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ Options array
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DialogueOption                                     │
│─────────────────────────────────────────────────────────────────────────────│
│  Text: "[WILL 4] Stand down. We don't have to do this."                     │
│  SkillCheck: {                                                               │
│    Attribute: "will",                                                        │
│    TargetValue: 4,                                                           │
│    Skill: null,                                                              │
│    SkillRanks: 0                                                             │
│  }                                                                           │
│  NextNodeId: "bjorn_stand_down"                                              │
│  Outcome: {                                                                  │
│    Type: "ReputationChange",                                                 │
│    Data: "Successfully negotiated with Bjorn",                               │
│    ReputationChange: 10,                                                     │
│    AffectedFaction: "RustClans"                                              │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Dialogue Flow Navigation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       DIALOGUE FLOW NAVIGATION                               │
└─────────────────────────────────────────────────────────────────────────────┘

                     ┌───────────────────┐
                     │  bjorn_greeting   │
                     │  (Entry Node)     │
                     └─────────┬─────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
  │ Option 1       │  │ Option 2       │  │ Option 3       │
  │ [Fight]        │  │ [WILL 4]       │  │ Negotiate      │
  │                │  │ Skill Check    │  │                │
  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘
          │                   │                   │
          │ NextNodeId:       │ NextNodeId:       │ NextNodeId:
          │ null              │ bjorn_stand_down  │ bjorn_negotiate_fail
          │                   │                   │
          ▼                   ▼                   ▼
  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
  │ Outcome:       │  │ bjorn_stand    │  │ bjorn_negotiate│
  │ InitiateCombat │  │ _down          │  │ _fail          │
  │ (End)          │  │                │  │                │
  └────────────────┘  └───────┬────────┘  └───────┬────────┘
                              │                   │
                      ┌───────┴───────┐           │
                      │               │           │
                      ▼               ▼           ▼
              ┌────────────┐  ┌────────────┐  ┌────────────┐
              │ End with   │  │ bjorn_     │  │ End or     │
              │ Information│  │ reason     │  │ Fight      │
              └────────────┘  └────────────┘  └────────────┘

  Legend:
  ═══════
  ┌──────┐  DialogueNode
  └──────┘

  NextNodeId: null    → Conversation ends after outcome
  NextNodeId: "id"    → Navigate to specified node
  [ATTR N]            → Requires skill check to select
```

### 3.3 Skill Check Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SKILL CHECK FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

                    Player selects option with SkillCheck
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │ Option:                       │
                    │ "[WILL 4] Stand down..."      │
                    │ SkillCheck: {                 │
                    │   Attribute: "will",          │
                    │   TargetValue: 4,             │
                    │   Skill: null,                │
                    │   SkillRanks: 0               │
                    │ }                             │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │ Get player's attribute value  │
                    │ will_value = Player.Will      │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │ Add skill bonus if applicable │
                    │ total = will_value +          │
                    │         (Skill × SkillRanks)  │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │ Compare to TargetValue        │
                    │ success = total >= 4          │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
             Success                             Failure
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐         ┌───────────────────┐
        │ Navigate to       │         │ Option unavailable│
        │ NextNodeId        │         │ (grayed out) OR   │
        │ Execute Outcome   │         │ Failure text      │
        └───────────────────┘         └───────────────────┘

  Attribute Values (typical ranges):
  ═══════════════════════════════════
  • might:   1-10  (Physical strength, intimidation)
  • finesse: 1-10  (Dexterity, sleight of hand)
  • will:    1-10  (Mental fortitude, persuasion)
  • wits:    1-10  (Knowledge, perception, reasoning)

  Example Checks from Existing Dialogues:
  ═══════════════════════════════════════
  • [WILL 4]  - Moderate willpower check (Bjorn stand-down)
  • [WILL 3]  - Easy willpower check (Sigrun negotiation)
  • [WITS 4]  - Moderate knowledge check (Sigrun lore)
```

### 3.4 Outcome Types Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         OUTCOME TYPES FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                            Option Selected
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │ Outcome: {               │
                    │   Type: "...",           │
                    │   Data: "...",           │
                    │   ReputationChange: N,   │
                    │   AffectedFaction: "..." │
                    │ }                        │
                    └──────────────┬───────────┘
                                   │
    ┌──────────────┬───────────────┼───────────────┬──────────────┐
    │              │               │               │              │
    ▼              ▼               ▼               ▼              ▼
┌────────┐   ┌────────┐     ┌────────────┐   ┌────────┐    ┌────────┐
│Initiate│   │Reputa- │     │Information │   │  End   │    │ Quest  │
│Combat  │   │tion    │     │            │   │Conver- │    │ Given  │
│        │   │Change  │     │            │   │sation  │    │        │
└───┬────┘   └───┬────┘     └─────┬──────┘   └───┬────┘    └───┬────┘
    │            │                │              │             │
    ▼            ▼                ▼              ▼             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│ InitiateCombat  → Start combat with Data (enemy ID)                        │
│ ReputationChange→ Modify AffectedFaction by ReputationChange amount        │
│ Information     → Reveal lore/hint described in Data                       │
│ EndConversation → Close dialogue UI                                        │
│ QuestGiven      → Add quest specified in Data to player's journal          │
│ QuestUpdate     → Update quest progress described in Data                  │
│ ItemGiven       → Give item specified in Data to player                    │
│ ItemTaken       → Remove item specified in Data from player                │
│ FlagSet         → Set world state flag specified in Data                   │
└────────────────────────────────────────────────────────────────────────────┘

  Outcome Examples from Existing Dialogues:
  ═════════════════════════════════════════
  InitiateCombat:
    Type: "InitiateCombat"
    Data: "bjorn_exile"
    (Starts combat with Bjorn enemy definition)

  ReputationChange:
    Type: "ReputationChange"
    Data: "Successfully negotiated with Bjorn"
    ReputationChange: 10
    AffectedFaction: "RustClans"
    (Increases RustClans reputation by 10)

  Information:
    Type: "Information"
    Data: "Boss location revealed"
    (Reveals game information to player)

  EndConversation:
    Type: "EndConversation"
    Data: ""
    (Simply closes the dialogue)

  QuestGiven:
    Type: "QuestGiven"
    Data: "quest_scrap_collection"
    (Adds quest to journal)
```

### 3.5 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  Dialogue UI displays conversation to player                                 │
│  • NPC portrait and name                                                     │
│  • Dialogue text with variable substitution                                  │
│  • Option buttons with skill check indicators                                │
│  • Grayed-out options for failed/unavailable choices                         │
│  • Reputation change notifications                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  DialogueService manages conversation flow                                   │
│  • LoadDialogue(npcId) → DialogueTree                                        │
│  • GetCurrentNode() → DialogueNode                                           │
│  • GetAvailableOptions() → filtered by conditions                            │
│  • SelectOption(index) → execute outcome, navigate                           │
│  • EvaluateSkillCheck(option) → success/failure                              │
│  • ApplyOutcome(outcome) → trigger game effects                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  Dialogue definitions loaded from JSON                                       │
│  • DialogueNode (Id, Text, Options, EndsConversation)                        │
│  • DialogueOption (Text, NextNodeId, SkillCheck, Outcome, Conditions)        │
│  • SkillCheck (Attribute, TargetValue, Skill, SkillRanks)                    │
│  • Outcome (Type, Data, ReputationChange, AffectedFaction)                   │
│  • Condition (Type, Target, Value, Operator)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  DialogueProvider loads from JSON with schema validation                     │
│  • LoadDialogue(npcId) → reads dialogues/{npcId}_dialogues.json              │
│  • Validates against config/schemas/dialogue.schema.json                     │
│  • Builds node lookup by ID for fast navigation                              │
│  • Validates NextNodeId references exist                                     │
│  • Logs warnings for orphaned nodes                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/dialogue.schema.json                                         │
│  docs/design/descriptors/dialogues/*.json (8 files)                          │
│                                                                              │
│  Related Systems:                                                            │
│  • Faction system (reputation tracking)                                      │
│  • Quest system (quest initiation/updates)                                   │
│  • Combat system (enemy encounters)                                          │
│  • Inventory system (item transfers)                                         │
│  • World state (flags and triggers)                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Schema Root Definition

### 4.1 Root Configuration Properties

The dialogue schema defines a dialogue tree as an array of dialogue nodes. The root is a JSON array, not an object.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| (root) | array | **Yes** | - | Array of DialogueNode objects |

**Note:** Unlike most configuration files, dialogue files are arrays at the root level to match the existing structure of the 8 dialogue files.

### 4.2 Dialogue Tree Array Structure

The dialogue tree is an array of `DialogueNode` objects. At least one node must be defined.

```
dialogues.json: [
  DialogueNode (entry/greeting),
  DialogueNode (branch 1),
  DialogueNode (branch 2),
  DialogueNode (branch 3),
  ... (additional nodes)
]
```

---

## 5. DialogueNode Definition

### 5.1 Core Properties

Each dialogue node represents a single point in the conversation where the NPC speaks and the player can respond.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Id` | string | **Yes** | - | Unique node identifier (pattern: `^[a-z][a-z0-9_]*$`) |
| `Text` | string | **Yes** | - | NPC's dialogue text (minLength: 1) |
| `Options` | array | **Yes** | - | Array of DialogueOption (minItems: 1) |
| `EndsConversation` | boolean | No | false | Whether this node ends the conversation |

### 5.2 Node Behavior

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          NODE BEHAVIOR                                       │
└─────────────────────────────────────────────────────────────────────────────┘

  Standard Node (EndsConversation: false):
  ════════════════════════════════════════
  • Displays NPC text
  • Shows all available options
  • Player selects an option
  • Navigate to NextNodeId or end if null

  Terminal Node (EndsConversation: true):
  ═══════════════════════════════════════
  • Displays NPC text
  • Shows options (typically single "goodbye" option)
  • After selection, conversation closes

  Node ID Conventions:
  ════════════════════
  • {npc}_greeting    - Entry point for NPC conversation
  • {npc}_about       - Information about NPC
  • {npc}_quest_hook  - Quest-related dialogue
  • {npc}_faction_info- Faction information branch
  • {npc}_negotiate   - Negotiation branch
  • {npc}_reason      - Explanation/reasoning branch
```

### 5.3 Conditional Visibility

Nodes can optionally include conditions that control their visibility:

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Conditions` | array | No | - | Array of Condition objects for node visibility |

When conditions are present, the node is only accessible if all conditions evaluate to true.

---

## 6. DialogueOption Definition

### 6.1 Option Properties

Each dialogue option represents a player response choice.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Text` | string | **Yes** | - | Player's response text (minLength: 1) |
| `NextNodeId` | string or null | **Yes** | - | Target node ID or null to end |
| `SkillCheck` | object | No | null | SkillCheck object for attribute tests |
| `Outcome` | object | No | null | Outcome object for effects |
| `Conditions` | array | No | - | Array of Condition objects for visibility |

### 6.2 Skill Check Integration

Options with skill checks display an indicator in the text:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SKILL CHECK DISPLAY CONVENTIONS                           │
└─────────────────────────────────────────────────────────────────────────────┘

  Text Format:
  ════════════
  "[ATTRIBUTE N] action description"

  Examples from Existing Dialogues:
  ═════════════════════════════════
  "[WILL 4] Stand down. We don't have to do this."
  "[WILL 3] You'll need to offer more than that."
  "[WITS 4] These ruins are Jötun-Forged, pre-Glitch construction."

  Display Variations:
  ═══════════════════
  • [WILL 4]    - Willpower check, target 4
  • [MIGHT 5]   - Might check, target 5
  • [FINESSE 3] - Finesse check, target 3
  • [WITS 6]    - Wits check, target 6

  UI Behavior:
  ════════════
  • Option appears grayed out if player cannot pass check
  • Check indicator colored based on difficulty relative to player stat
  • Green: Easy (player stat >= target + 2)
  • Yellow: Moderate (player stat = target or target + 1)
  • Red: Hard (player stat < target)
```

### 6.3 Outcome Association

Options can trigger outcomes when selected:

```
Option Selected
      │
      ├─→ SkillCheck present?
      │         │
      │    Yes  │  No
      │         │
      │         ▼
      │   Pass check?
      │         │
      │    Yes  │  No
      │         ▼
      │   Option unavailable
      │
      ▼
Execute Outcome (if present)
      │
      ▼
Navigate to NextNodeId (or end if null)
```

---

## 7. SkillCheck Definition

### 7.1 Attribute Types

The skill check system uses four primary attributes:

| Attribute | Description | Example Use |
|-----------|-------------|-------------|
| `might` | Physical strength | Intimidation, breaking objects, feats of strength |
| `finesse` | Dexterity/agility | Sleight of hand, quick reactions, stealth |
| `will` | Mental fortitude | Persuasion, resist manipulation, determination |
| `wits` | Knowledge/reasoning | Recall lore, solve puzzles, perception, deduction |

### 7.2 Target Value Calculation

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Attribute` | string | **Yes** | - | Attribute to test (enum: might, finesse, will, wits) |
| `TargetValue` | integer | **Yes** | - | Difficulty number (minimum: 1) |
| `Skill` | string or null | No | null | Optional skill name for bonus |
| `SkillRanks` | integer | No | 0 | Skill ranks bonus (minimum: 0) |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TARGET VALUE DIFFICULTY SCALE                           │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────┬─────────────────┬───────────────────────────────────────────────┐
  │ Target  │ Difficulty      │ Description                                   │
  ├─────────┼─────────────────┼───────────────────────────────────────────────┤
  │ 1-2     │ Trivial         │ Almost anyone can succeed                     │
  │ 3-4     │ Easy            │ Slight challenge, most will succeed           │
  │ 5-6     │ Moderate        │ Requires some investment in attribute         │
  │ 7-8     │ Hard            │ Requires significant investment               │
  │ 9-10    │ Very Hard       │ Only specialists will succeed                 │
  │ 11+     │ Near Impossible │ Requires exceptional characters + bonuses     │
  └─────────┴─────────────────┴───────────────────────────────────────────────┘

  Check Formula:
  ══════════════
  success = (Player.Attribute + SkillBonus) >= TargetValue

  Where SkillBonus = Skill × SkillRanks (if skill specified)

  Example:
  ════════
  SkillCheck: { Attribute: "will", TargetValue: 4, Skill: null, SkillRanks: 0 }
  Player has Will: 5
  Check: 5 >= 4 → Success
```

### 7.3 Optional Skill Bonus

When a `Skill` is specified, the check can be modified by the player's ranks in that skill:

```
Example with Skill:
═══════════════════
SkillCheck: {
  Attribute: "wits",
  TargetValue: 6,
  Skill: "Lore",
  SkillRanks: 2
}

Player has Wits: 4, Lore skill: 3 ranks
Check: 4 + (3 × 0.5) = 5.5, rounded to 5
5 < 6 → Failure

Note: Skill bonus calculation is a runtime concern; the schema
only validates that SkillRanks is a non-negative integer.
```

---

## 8. Outcome Definition

### 8.1 Outcome Types

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Type` | string | **Yes** | - | Outcome type (enum) |
| `Data` | string | **Yes** | - | Context-specific data |
| `ReputationChange` | integer | No | 0 | Reputation modification amount |
| `AffectedFaction` | string or null | No | null | Faction ID for reputation change |

**Outcome Type Enum:**

| Type | Data Field | Effect |
|------|------------|--------|
| `InitiateCombat` | Enemy ID | Start combat with specified enemy |
| `ReputationChange` | Description text | Modify faction reputation |
| `Information` | Info description | Reveal lore/hint to player |
| `EndConversation` | Empty string | Close dialogue UI |
| `QuestGiven` | Quest ID | Add quest to player's journal |
| `QuestUpdate` | Quest state description | Update quest progress |
| `ItemGiven` | Item ID | Give item to player |
| `ItemTaken` | Item ID | Remove item from player |
| `FlagSet` | Flag name | Set world state flag |

### 8.2 Reputation Effects

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         REPUTATION EFFECTS                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Reputation System:
  ══════════════════
  • Each faction tracks player reputation as integer
  • Positive values = friendly/allied
  • Negative values = hostile/enemy
  • Zero = neutral

  Reputation Thresholds (typical):
  ════════════════════════════════
  ┌──────────────┬───────────────┬────────────────────────────────────────────┐
  │ Range        │ Status        │ Effects                                    │
  ├──────────────┼───────────────┼────────────────────────────────────────────┤
  │ -100 to -50  │ Hostile       │ Attack on sight, no dialogue               │
  │ -49 to -25   │ Unfriendly    │ Limited dialogue, higher prices            │
  │ -24 to 24    │ Neutral       │ Normal interactions                        │
  │ 25 to 49     │ Friendly      │ Better prices, more dialogue options       │
  │ 50 to 100    │ Allied        │ Quest access, faction benefits             │
  └──────────────┴───────────────┴────────────────────────────────────────────┘

  Existing Factions (from dialogues):
  ═══════════════════════════════════
  • RustClans     - Rust-Clan scavengers and survivors
  • MidgardCombine - Technology preservationists

  Example Reputation Changes:
  ═══════════════════════════
  +10  "Successfully negotiated with Bjorn" (RustClans)
  +5   "Impressed by knowledge" (MidgardCombine)
  +3   "Supportive of Combine goals" (MidgardCombine)
  +2   "Be careful out there" (MidgardCombine)
  -5   "Dismissed Combine goals" (MidgardCombine)
  -5   "Refused to help" (MidgardCombine)
  -10  "Rejected even better offer" (MidgardCombine)
```

### 8.3 Quest Integration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         QUEST INTEGRATION                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  Quest Outcomes:
  ═══════════════
  QuestGiven:
    Outcome: {
      Type: "QuestGiven",
      Data: "quest_scrap_collection",
      ReputationChange: 0,
      AffectedFaction: null
    }
    Effect: Adds quest to player's quest journal

  QuestGiven (Upgraded):
    Outcome: {
      Type: "QuestGiven",
      Data: "quest_scrap_collection_upgraded",
      ReputationChange: 0,
      AffectedFaction: null
    }
    Effect: Adds upgraded version of quest (better rewards)

  QuestUpdate:
    Outcome: {
      Type: "QuestUpdate",
      Data: "quest_scrap_collection:delivered",
      ReputationChange: 0,
      AffectedFaction: null
    }
    Effect: Updates quest state in journal

  Quest ID Conventions:
  ═════════════════════
  • quest_{name}           - Base quest ID
  • quest_{name}_upgraded  - Enhanced version from negotiation
  • quest_{name}:{state}   - Quest state update format
```

---

## 9. Condition Definition

### 9.1 Condition Types

Conditions control whether a node or option is visible to the player.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `Type` | string | **Yes** | - | Condition type (enum) |
| `Target` | string | **Yes** | - | Reference ID (item, faction, quest, flag, skill) |
| `Value` | string or integer | **Yes** | - | Comparison value |
| `Operator` | string | No | "equals" | Comparison operator |

**Condition Type Enum:**

| Type | Target | Value | Description |
|------|--------|-------|-------------|
| `HasItem` | Item ID | Quantity (integer) | Player has N or more of item |
| `HasReputation` | Faction ID | Reputation level (integer) | Faction reputation meets threshold |
| `HasQuestState` | Quest ID | Quest state (string) | Quest is in specified state |
| `HasFlag` | Flag name | Flag value (string/bool) | World flag is set to value |
| `SkillLevel` | Skill name | Minimum level (integer) | Player has skill at N or higher |

### 9.2 Comparison Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `equals` | Value exactly matches | HasReputation: RustClans = 50 |
| `notEquals` | Value does not match | HasFlag: boss_defeated != true |
| `greaterThan` | Value is greater than | HasReputation: MidgardCombine > 25 |
| `lessThan` | Value is less than | HasItem: gold < 100 |
| `greaterThanOrEquals` | Value is >= | SkillLevel: Persuasion >= 3 |
| `lessThanOrEquals` | Value is <= | HasReputation: RustClans <= -25 |

### 9.3 Condition Evaluation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CONDITION EVALUATION FLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

                      Node/Option with Conditions
                                  │
                                  ▼
                    ┌───────────────────────────┐
                    │ For each Condition:       │
                    │ {                         │
                    │   Type: "HasReputation",  │
                    │   Target: "RustClans",    │
                    │   Value: 25,              │
                    │   Operator: "greaterThan" │
                    │ }                         │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                    ┌───────────────────────────┐
                    │ Get current value         │
                    │ currentRep = Player       │
                    │   .GetReputation          │
                    │   ("RustClans")           │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                    ┌───────────────────────────┐
                    │ Apply operator            │
                    │ result = currentRep > 25  │
                    └─────────────┬─────────────┘
                                  │
              ┌───────────────────┴───────────────────┐
              │                                       │
       All conditions pass                   Any condition fails
              │                                       │
              ▼                                       ▼
    ┌───────────────────┐               ┌───────────────────┐
    │ Node/Option       │               │ Node/Option       │
    │ is VISIBLE        │               │ is HIDDEN         │
    └───────────────────┘               └───────────────────┘

  Example Conditional Option:
  ═══════════════════════════
  {
    "Text": "I've already helped your people.",
    "NextNodeId": "sigrun_grateful",
    "Conditions": [
      {
        "Type": "HasQuestState",
        "Target": "quest_scrap_collection",
        "Value": "completed",
        "Operator": "equals"
      }
    ]
  }
  → Only visible if player completed the scrap collection quest
```

---

## 10. Validation Rules

### 10.1 Node ID Pattern

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       NODE ID PATTERN VALIDATION                             │
└─────────────────────────────────────────────────────────────────────────────┘

  Pattern: ^[a-z][a-z0-9_]*$
  ═══════════════════════════
  • Starts with lowercase letter
  • Followed by lowercase letters, digits, or underscores
  • No uppercase letters
  • No hyphens (unlike kebab-case in other schemas)

  ✓ Valid:
    bjorn_greeting
    sigrun_about
    npc_quest_hook
    merchant_1_trade
    forlorn_warning_final

  ✗ Invalid:
    Bjorn_greeting    (uppercase)
    bjorn-greeting    (hyphen)
    1_greeting        (starts with number)
    bjorn greeting    (space)
    björn_greeting    (non-ASCII)

  Naming Conventions:
  ═══════════════════
  {npc_name}_{topic}
  {npc_name}_{topic}_{subtopic}
  {npc_name}_{topic}_{number}
```

### 10.2 Cross-Reference Validation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CROSS-REFERENCE VALIDATION                                │
└─────────────────────────────────────────────────────────────────────────────┘

  NextNodeId References:
  ══════════════════════
  Every NextNodeId that is not null must reference an existing node Id.

  Validation Process:
  ═══════════════════
  1. Build set of all node Ids in dialogue tree
  2. For each option's NextNodeId:
     - If null → valid (ends conversation)
     - If string → check exists in Id set

  Example Valid:
  ══════════════
  Nodes: [
    { Id: "npc_greeting", Options: [{ NextNodeId: "npc_about" }] },
    { Id: "npc_about", Options: [{ NextNodeId: null }] }
  ]
  → "npc_about" exists, reference valid

  Example Invalid:
  ════════════════
  Nodes: [
    { Id: "npc_greeting", Options: [{ NextNodeId: "npc_missing" }] }
  ]
  → "npc_missing" does not exist, validation error

  Warning Level:
  ══════════════
  • Invalid reference: ERROR (prevents loading)
  • Orphaned node (never referenced): WARNING (loaded but logged)
```

### 10.3 Cycle Detection

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CYCLE DETECTION                                      │
└─────────────────────────────────────────────────────────────────────────────┘

  Cycles in dialogue trees are ALLOWED but should be intentional.

  Valid Cycle Example (back to greeting):
  ═══════════════════════════════════════
  npc_greeting
       │
       ▼
  npc_info ───────┐
       │          │
       ▼          │
  npc_detail      │
       │          │
       └──────────┘ (back to npc_greeting)

  This allows:
  • "Start over" options
  • Returning to main menu
  • Recurring conversations

  Infinite Loop Warning:
  ══════════════════════
  • No option with NextNodeId: null in cycle → WARNING
  • All paths lead to same node without exit → WARNING
  • Runtime: Max dialogue turns limit prevents infinite loops
```

---

## 11. Configuration Schema

### Complete `dialogue.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/dialogue.schema.json",
  "title": "Dialogue Tree Configuration",
  "description": "Schema for NPC dialogue trees with branching conversations, skill checks, and outcomes",
  "type": "array",
  "items": {
    "$ref": "#/definitions/DialogueNode"
  },
  "minItems": 1,
  "definitions": {
    "DialogueNode": {
      "type": "object",
      "description": "A single node in the dialogue tree representing NPC speech and player response options",
      "properties": {
        "Id": {
          "type": "string",
          "description": "Unique identifier for this dialogue node",
          "pattern": "^[a-z][a-z0-9_]*$",
          "minLength": 1
        },
        "Text": {
          "type": "string",
          "description": "The NPC's dialogue text displayed to the player",
          "minLength": 1
        },
        "Options": {
          "type": "array",
          "description": "Array of player response options",
          "items": {
            "$ref": "#/definitions/DialogueOption"
          },
          "minItems": 1
        },
        "EndsConversation": {
          "type": "boolean",
          "description": "Whether selecting any option from this node ends the conversation",
          "default": false
        },
        "Conditions": {
          "type": "array",
          "description": "Conditions that must be met for this node to be accessible",
          "items": {
            "$ref": "#/definitions/Condition"
          }
        }
      },
      "required": ["Id", "Text", "Options"],
      "additionalProperties": false
    },
    "DialogueOption": {
      "type": "object",
      "description": "A player response option within a dialogue node",
      "properties": {
        "Text": {
          "type": "string",
          "description": "The player's response text. May include skill check indicator like [WILL 4]",
          "minLength": 1
        },
        "NextNodeId": {
          "type": ["string", "null"],
          "description": "The Id of the next dialogue node, or null to end conversation",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "SkillCheck": {
          "$ref": "#/definitions/SkillCheck",
          "description": "Optional skill check required to select this option"
        },
        "Outcome": {
          "$ref": "#/definitions/Outcome",
          "description": "Optional outcome triggered when this option is selected"
        },
        "Conditions": {
          "type": "array",
          "description": "Conditions that must be met for this option to be visible",
          "items": {
            "$ref": "#/definitions/Condition"
          }
        }
      },
      "required": ["Text", "NextNodeId"],
      "additionalProperties": false
    },
    "SkillCheck": {
      "type": "object",
      "description": "An attribute-based skill check for dialogue options",
      "properties": {
        "Attribute": {
          "type": "string",
          "description": "The attribute to test against",
          "enum": ["might", "finesse", "will", "wits"]
        },
        "TargetValue": {
          "type": "integer",
          "description": "The difficulty number the player must meet or exceed",
          "minimum": 1
        },
        "Skill": {
          "type": ["string", "null"],
          "description": "Optional skill name that provides bonus to the check"
        },
        "SkillRanks": {
          "type": "integer",
          "description": "Number of skill ranks to apply as bonus",
          "minimum": 0,
          "default": 0
        }
      },
      "required": ["Attribute", "TargetValue"],
      "additionalProperties": false
    },
    "Outcome": {
      "type": "object",
      "description": "The result of selecting a dialogue option",
      "properties": {
        "Type": {
          "type": "string",
          "description": "The type of outcome",
          "enum": [
            "InitiateCombat",
            "ReputationChange",
            "Information",
            "EndConversation",
            "QuestGiven",
            "QuestUpdate",
            "ItemGiven",
            "ItemTaken",
            "FlagSet"
          ]
        },
        "Data": {
          "type": "string",
          "description": "Context-specific data for the outcome (enemy ID, quest ID, item ID, flag name, or description)"
        },
        "ReputationChange": {
          "type": "integer",
          "description": "Amount to change faction reputation (positive or negative)",
          "default": 0
        },
        "AffectedFaction": {
          "type": ["string", "null"],
          "description": "The faction whose reputation is affected"
        }
      },
      "required": ["Type", "Data"],
      "additionalProperties": false
    },
    "Condition": {
      "type": "object",
      "description": "A condition that controls visibility of nodes or options",
      "properties": {
        "Type": {
          "type": "string",
          "description": "The type of condition to evaluate",
          "enum": [
            "HasItem",
            "HasReputation",
            "HasQuestState",
            "HasFlag",
            "SkillLevel"
          ]
        },
        "Target": {
          "type": "string",
          "description": "The target to check (item ID, faction ID, quest ID, flag name, or skill name)",
          "minLength": 1
        },
        "Value": {
          "type": ["string", "integer"],
          "description": "The value to compare against"
        },
        "Operator": {
          "type": "string",
          "description": "The comparison operator",
          "enum": [
            "equals",
            "notEquals",
            "greaterThan",
            "lessThan",
            "greaterThanOrEquals",
            "lessThanOrEquals"
          ],
          "default": "equals"
        }
      },
      "required": ["Type", "Target", "Value"],
      "additionalProperties": false
    }
  }
}
```

---

## 12. Existing Dialogue Files

### Current Dialogue Files (8 total)

The following dialogue files exist and should be validated against the new schema:

| File | NPC | Nodes | Key Features |
|------|-----|-------|--------------|
| `bjorn_dialogues.json` | Bjorn | 4 | Combat initiation, WILL checks, RustClans reputation |
| `sigrun_dialogues.json` | Sigrun | 8 | Quest giving, WILL/WITS checks, MidgardCombine reputation |
| `astrid_dialogues.json` | Astrid | ? | TBD |
| `eydis_dialogues.json` | Eydis | ? | TBD |
| `gunnar_dialogues.json` | Gunnar | ? | TBD |
| `kjartan_dialogues.json` | Kjartan | ? | TBD |
| `rolf_dialogues.json` | Rolf | ? | TBD |
| `thorvald_dialogues.json` | Thorvald | ? | TBD |

### Existing Structure Analysis

From analyzing `bjorn_dialogues.json` and `sigrun_dialogues.json`:

**Properties Used:**
- ✅ `Id` - Node identifier (snake_case pattern)
- ✅ `Text` - NPC dialogue text
- ✅ `Options` - Array of response options
- ✅ `EndsConversation` - Terminal node flag
- ✅ `Text` (option) - Player response text
- ✅ `NextNodeId` - Navigation target (string or null)
- ✅ `SkillCheck` - Attribute checks
- ✅ `Outcome` - Action results

**SkillCheck Fields:**
- ✅ `Attribute` - "will", "wits" (lowercase)
- ✅ `TargetValue` - Integer (3, 4 in examples)
- ✅ `Skill` - null in all current examples
- ✅ `SkillRanks` - 0 in all current examples

**Outcome Fields:**
- ✅ `Type` - "InitiateCombat", "ReputationChange", "Information", "EndConversation", "QuestGiven"
- ✅ `Data` - Various string values
- ✅ `ReputationChange` - Integer (-10 to +10 in examples)
- ✅ `AffectedFaction` - "RustClans", "MidgardCombine", null

### Schema Compatibility

The schema is designed to be fully compatible with existing dialogue files:

| Existing Feature | Schema Support | Notes |
|------------------|----------------|-------|
| PascalCase properties | ✅ Supported | `Id`, `Text`, `Options`, etc. |
| snake_case node IDs | ✅ Required | Pattern `^[a-z][a-z0-9_]*$` |
| lowercase attributes | ✅ Required | Enum: might, finesse, will, wits |
| null NextNodeId | ✅ Supported | Indicates conversation end |
| null Outcome | ✅ Supported | Option without side effects |
| null Skill | ✅ Supported | Pure attribute check |

---

## 13. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `Dialogue schema loaded from {path}` |
| Validation success | DEBUG | `Dialogue validated ({nodeCount} nodes, {optionCount} options)` |
| Validation failure | ERROR | `Dialogue configuration validation failed: {errors}` |
| Missing required | ERROR | `DialogueNode missing required field: {field}` |
| Invalid node ID | ERROR | `Node Id '{id}' does not match pattern ^[a-z][a-z0-9_]*$` |
| Invalid NextNodeId | ERROR | `Option NextNodeId '{id}' references non-existent node` |
| Invalid attribute | ERROR | `SkillCheck Attribute '{attr}' not in enum (might, finesse, will, wits)` |
| Invalid outcome type | ERROR | `Outcome Type '{type}' not in valid enum` |
| Orphaned node | WARN | `Node '{id}' is never referenced by any NextNodeId` |
| Cycle detected | INFO | `Dialogue contains cycle through nodes: {nodeIds}` |

### Runtime Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Dialogue loaded | DEBUG | `Loaded dialogue for NPC '{npcId}' ({nodeCount} nodes)` |
| Node entered | DEBUG | `Entered dialogue node '{nodeId}'` |
| Option selected | DEBUG | `Selected option {index} in node '{nodeId}'` |
| Skill check | INFO | `Skill check: {attribute} {playerValue} vs {targetValue} → {result}` |
| Outcome applied | INFO | `Applied outcome: {type} - {data}` |
| Reputation changed | INFO | `Reputation with {faction} changed by {delta} (now {total})` |
| Quest given | INFO | `Quest '{questId}' added to journal` |
| Combat initiated | INFO | `Initiating combat with '{enemyId}'` |

---

## 14. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| DLG-001 | ValidDialogueConfiguration | Validates complete dialogue with all features |
| DLG-002 | NodeStructureValidation | Validates node required/optional fields |
| DLG-003 | OptionStructureValidation | Validates option structure and types |
| DLG-004 | SkillCheckValidation | Validates skill check attributes and values |
| DLG-005 | OutcomeTypeValidation | Validates all outcome types |
| DLG-006 | NodeIdPatternValidation | Validates node ID pattern matching |

### Test Specifications

#### DLG-001: ValidDialogueConfiguration

```
Test: Valid complete dialogue configuration passes schema validation
Given: A dialogue JSON file with multiple nodes, skill checks, and outcomes
When: Schema validation is performed
Then: Validation passes with no errors
And: All nodes are accessible via navigation
And: Skill checks have valid attributes
And: Outcomes have valid types
```

#### DLG-002: NodeStructureValidation

```
Test: Dialogue node structure validates required and optional fields
Given: Dialogue nodes with various configurations
When: Schema validation is performed:
  - { "Id": "test", "Text": "Hello", "Options": [...] } → passes (minimal)
  - { "Id": "test", "Text": "Hello", "Options": [...], "EndsConversation": true } → passes
  - { "Text": "Hello", "Options": [...] } → fails (missing Id)
  - { "Id": "test", "Options": [...] } → fails (missing Text)
  - { "Id": "test", "Text": "Hello" } → fails (missing Options)
  - { "Id": "test", "Text": "Hello", "Options": [] } → fails (empty Options)
  - { "Id": "test", "Text": "", "Options": [...] } → fails (empty Text)
  - { "Id": "test", "Text": "Hello", "Options": [...], "Unknown": true } → fails
Then: Required fields enforced, optional fields allowed, unknown fields rejected
```

#### DLG-003: OptionStructureValidation

```
Test: Dialogue option structure validates correctly
Given: Dialogue options with various configurations
When: Schema validation is performed:
  - { "Text": "Reply", "NextNodeId": "node_2" } → passes (minimal)
  - { "Text": "Reply", "NextNodeId": null } → passes (ends conversation)
  - { "Text": "Reply", "NextNodeId": "node_2", "SkillCheck": {...} } → passes
  - { "Text": "Reply", "NextNodeId": "node_2", "Outcome": {...} } → passes
  - { "NextNodeId": "node_2" } → fails (missing Text)
  - { "Text": "Reply" } → fails (missing NextNodeId)
  - { "Text": "", "NextNodeId": "node_2" } → fails (empty Text)
Then: Required fields enforced, optional fields allowed
```

#### DLG-004: SkillCheckValidation

```
Test: Skill check validates attribute types and target values
Given: Skill checks with various configurations
When: Schema validation is performed:
  - { "Attribute": "might", "TargetValue": 5 } → passes
  - { "Attribute": "finesse", "TargetValue": 3 } → passes
  - { "Attribute": "will", "TargetValue": 4 } → passes
  - { "Attribute": "wits", "TargetValue": 6 } → passes
  - { "Attribute": "will", "TargetValue": 4, "Skill": "Persuasion", "SkillRanks": 2 } → passes
  - { "Attribute": "strength", "TargetValue": 5 } → fails (invalid attribute)
  - { "Attribute": "WILL", "TargetValue": 4 } → fails (uppercase)
  - { "Attribute": "will", "TargetValue": 0 } → fails (below minimum)
  - { "Attribute": "will", "TargetValue": -1 } → fails (negative)
  - { "TargetValue": 5 } → fails (missing Attribute)
  - { "Attribute": "will" } → fails (missing TargetValue)
Then: Attribute enum enforced, TargetValue minimum enforced
```

#### DLG-005: OutcomeTypeValidation

```
Test: Outcome types validate correctly
Given: Outcomes with various types
When: Schema validation is performed:
  - { "Type": "InitiateCombat", "Data": "enemy_id" } → passes
  - { "Type": "ReputationChange", "Data": "desc", "ReputationChange": 10, "AffectedFaction": "RustClans" } → passes
  - { "Type": "Information", "Data": "revealed info" } → passes
  - { "Type": "EndConversation", "Data": "" } → passes
  - { "Type": "QuestGiven", "Data": "quest_id" } → passes
  - { "Type": "QuestUpdate", "Data": "quest:state" } → passes
  - { "Type": "ItemGiven", "Data": "item_id" } → passes
  - { "Type": "ItemTaken", "Data": "item_id" } → passes
  - { "Type": "FlagSet", "Data": "flag_name" } → passes
  - { "Type": "InvalidType", "Data": "test" } → fails (invalid type)
  - { "Type": "InitiateCombat" } → fails (missing Data)
  - { "Data": "test" } → fails (missing Type)
Then: Type enum enforced, required fields enforced
```

#### DLG-006: NodeIdPatternValidation

```
Test: Node ID pattern validates correctly
Given: Dialogue nodes with various ID formats
When: Schema validation is performed:
  - Id: "npc_greeting" → passes
  - Id: "npc_quest_hook" → passes
  - Id: "merchant_1_trade" → passes
  - Id: "a" → passes (single letter)
  - Id: "abc123" → passes (letters and numbers)
  - Id: "NPC_greeting" → fails (uppercase)
  - Id: "npc-greeting" → fails (hyphen)
  - Id: "1_greeting" → fails (starts with number)
  - Id: "_greeting" → fails (starts with underscore)
  - Id: "npc greeting" → fails (space)
  - Id: "" → fails (empty)
Then: Pattern ^[a-z][a-z0-9_]*$ enforced
```

---

## 15. Use Cases

### UC-001: Load NPC Dialogue

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load NPC Dialogue                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Player interacts with NPC                                           │
│ Preconditions: Dialogue file exists for NPC                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads dialogue.schema.json                                         │
│ 2. System reads dialogues/{npcId}_dialogues.json                             │
│ 3. Validate configuration against schema                                     │
│ 4. Build node lookup by Id                                                   │
│ 5. Validate all NextNodeId references exist                                  │
│ 6. Find entry node (typically "{npc}_greeting")                              │
│ 7. Display entry node text and options                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Dialogue tree loaded, entry node displayed                   │
│ Exceptions: Invalid JSON → log error, show generic dialogue                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Select Dialogue Option

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Select Dialogue Option                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Player                                                               │
│ Trigger: Player clicks/selects dialogue option                               │
│ Preconditions: Dialogue node displayed with options                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Player selects option from current node                                   │
│ 2. If option has SkillCheck:                                                 │
│    a. Evaluate player attribute vs TargetValue                               │
│    b. If fails → show failure feedback, option unavailable                   │
│ 3. If option has Outcome:                                                    │
│    a. Execute outcome (reputation, combat, quest, etc.)                      │
│    b. Log outcome for history                                                │
│ 4. If NextNodeId is null → end conversation                                  │
│ 5. If NextNodeId is string → navigate to that node                           │
│ 6. Display new node text and options                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: New node displayed or conversation ended                     │
│ Exceptions: Invalid NextNodeId → log error, end conversation                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Evaluate Skill Check

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Evaluate Skill Check                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Option with SkillCheck selected                                     │
│ Preconditions: Player has attribute values                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Get SkillCheck from option                                                │
│ 2. Get player's value for Attribute                                          │
│ 3. If Skill specified:                                                       │
│    a. Get player's skill ranks                                               │
│    b. Calculate bonus (ranks × modifier)                                     │
│    c. Add bonus to attribute value                                           │
│ 4. Compare total to TargetValue                                              │
│ 5. Return success if total >= TargetValue                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Check result determined                                      │
│ Exceptions: Unknown attribute → default to 0, log warning                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Apply Reputation Change

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Apply Reputation Change                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Outcome with ReputationChange executed                              │
│ Preconditions: Faction system initialized                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Get Outcome from selected option                                          │
│ 2. If AffectedFaction is null → skip                                         │
│ 3. If ReputationChange is 0 → skip                                           │
│ 4. Get current reputation with AffectedFaction                               │
│ 5. Apply ReputationChange (can be negative)                                  │
│ 6. Clamp to valid range (-100 to 100)                                        │
│ 7. Display reputation change notification                                    │
│ 8. Check for faction status threshold changes                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Faction reputation updated                                   │
│ Exceptions: Unknown faction → log warning, skip change                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Initiate Combat from Dialogue

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Initiate Combat from Dialogue                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Outcome with Type "InitiateCombat" executed                         │
│ Preconditions: Combat system initialized, enemy definition exists            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Get Outcome from selected option                                          │
│ 2. Extract enemy ID from Data field                                          │
│ 3. Close dialogue UI                                                         │
│ 4. Load enemy definition from Data                                           │
│ 5. Create combat encounter                                                   │
│ 6. Transition to combat state                                                │
│ 7. Begin combat turn order                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Combat initiated with specified enemy                        │
│ Exceptions: Unknown enemy → log error, create generic enemy                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/dialogue.schema.json` | JSON Schema for dialogue validation |

### Configuration Updates

| Status | File | Description |
|--------|------|-------------|
| ☐ | `docs/design/descriptors/dialogues/bjorn_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/sigrun_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/astrid_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/eydis_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/gunnar_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/kjartan_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/rolf_dialogues.json` | Add $schema reference |
| ☐ | `docs/design/descriptors/dialogues/thorvald_dialogues.json` | Add $schema reference |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | DLG-001 | Valid complete dialogue configuration |
| ☐ | DLG-002 | Node structure validation |
| ☐ | DLG-003 | Option structure validation |
| ☐ | DLG-004 | Skill check validation |
| ☐ | DLG-005 | Outcome type validation |
| ☐ | DLG-006 | Node ID pattern validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |

---

## 17. Acceptance Criteria

### Functional Criteria

- [ ] `dialogue.schema.json` created in `config/schemas/`
- [ ] Schema validates existing 8 dialogue files without errors
- [ ] Node Id pattern validated (`^[a-z][a-z0-9_]*$`)
- [ ] Options array requires at least one option
- [ ] NextNodeId accepts string or null
- [ ] SkillCheck attributes validated (might, finesse, will, wits)
- [ ] SkillCheck TargetValue validated (minimum: 1)
- [ ] Outcome types validated (9 types)
- [ ] Condition types validated (5 types)
- [ ] Comparison operators validated (6 operators)
- [ ] ~6 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All properties include descriptive comments
- [ ] Default values documented for optional fields
- [ ] Pattern constraints clearly specified
- [ ] Existing dialogue files pass validation without modification

### Integration Criteria

- [ ] Schema follows patterns from v0.14.8 schemas
- [ ] Compatible with existing dialogue file structure
- [ ] Node IDs use snake_case (matching existing files)
- [ ] Property names use PascalCase (matching existing files)

---

## 18. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.8 | Dice Configuration Schemas | Schema infrastructure patterns |
| Existing | `docs/design/descriptors/dialogues/*.json` | 8 dialogue files to validate |
| Existing | Faction system | Reputation tracking for outcomes |
| Existing | Quest system | Quest initiation for outcomes |
| Existing | Combat system | Combat initiation for outcomes |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.9b | Ability Descriptor Schema | Schema pattern reference |
| v0.14.9c | NPC Descriptor Schema | Schema pattern reference |
| Future | DialogueService | Dialogue loading and validation |
| Future | NPCInteractionSystem | Conversation flow management |
| Future | ReputationService | Faction reputation changes |

---

## 19. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Ability descriptor schema | v0.14.9b scope |
| NPC descriptor schema | v0.14.9c scope |
| Dialogue execution logic | Runtime concern |
| Voice acting integration | Future audio version |
| Dialogue localization | Future i18n version |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Variable substitution | Support `{PlayerName}`, `{FactionName}` in text |
| Random text selection | Multiple text variants per node |
| Conditional text | Different text based on conditions |
| Dialogue history | Track previous conversation outcomes |
| Mood/tone indicators | NPC emotional state affecting dialogue |
| Time-based conditions | Dialogue changes based on game time |
| Multi-NPC dialogues | Conversations with multiple participants |
| Dialogue templates | Shared structures for common patterns |

---

## 20. Appendix: Schema Validation Examples

### Valid Dialogue Node (Minimal)

```json
{
  "Id": "npc_greeting",
  "Text": "Hello, traveler.",
  "Options": [
    {
      "Text": "Hello.",
      "NextNodeId": null
    }
  ]
}
```

### Valid Dialogue Node (Complete)

```json
{
  "Id": "bjorn_greeting",
  "Text": "This is MY territory. Leave your supplies and go, or things get bloody.",
  "Options": [
    {
      "Text": "I'm not giving you anything. [Fight]",
      "NextNodeId": null,
      "Outcome": {
        "Type": "InitiateCombat",
        "Data": "bjorn_exile",
        "ReputationChange": 0,
        "AffectedFaction": null
      }
    },
    {
      "Text": "[WILL 4] Stand down. We don't have to do this.",
      "SkillCheck": {
        "Attribute": "will",
        "TargetValue": 4,
        "Skill": null,
        "SkillRanks": 0
      },
      "NextNodeId": "bjorn_stand_down",
      "Outcome": {
        "Type": "ReputationChange",
        "Data": "Successfully negotiated with Bjorn",
        "ReputationChange": 10,
        "AffectedFaction": "RustClans"
      }
    }
  ],
  "EndsConversation": false
}
```

### Valid Option with Conditions

```json
{
  "Text": "I've already helped your people.",
  "NextNodeId": "sigrun_grateful",
  "Conditions": [
    {
      "Type": "HasQuestState",
      "Target": "quest_scrap_collection",
      "Value": "completed",
      "Operator": "equals"
    },
    {
      "Type": "HasReputation",
      "Target": "MidgardCombine",
      "Value": 25,
      "Operator": "greaterThanOrEquals"
    }
  ],
  "Outcome": {
    "Type": "ReputationChange",
    "Data": "Reminded of prior assistance",
    "ReputationChange": 5,
    "AffectedFaction": "MidgardCombine"
  }
}
```

### Valid Skill Check with Skill Bonus

```json
{
  "Attribute": "wits",
  "TargetValue": 6,
  "Skill": "Lore",
  "SkillRanks": 2
}
```

### Invalid Examples

```json
// Invalid: Missing Id
{
  "Text": "Hello",
  "Options": [{ "Text": "Hi", "NextNodeId": null }]
}
// Error: Missing required property 'Id'

// Invalid: Empty Options array
{
  "Id": "test",
  "Text": "Hello",
  "Options": []
}
// Error: 'Options' must have at least 1 item

// Invalid: Uppercase in Id
{
  "Id": "NPC_greeting",
  "Text": "Hello",
  "Options": [{ "Text": "Hi", "NextNodeId": null }]
}
// Error: 'Id' does not match pattern ^[a-z][a-z0-9_]*$

// Invalid: Invalid attribute in SkillCheck
{
  "Id": "test",
  "Text": "Hello",
  "Options": [{
    "Text": "[STRENGTH 5] Test",
    "NextNodeId": null,
    "SkillCheck": {
      "Attribute": "strength",
      "TargetValue": 5
    }
  }]
}
// Error: 'Attribute' must be one of: might, finesse, will, wits

// Invalid: Negative TargetValue
{
  "SkillCheck": {
    "Attribute": "will",
    "TargetValue": -1
  }
}
// Error: 'TargetValue' must be >= 1

// Invalid: Unknown Outcome Type
{
  "Outcome": {
    "Type": "GiveGold",
    "Data": "100"
  }
}
// Error: 'Type' must be one of the valid outcome types

// Invalid: Missing NextNodeId in Option
{
  "Text": "Reply"
}
// Error: Missing required property 'NextNodeId'

// Invalid: Unknown property
{
  "Id": "test",
  "Text": "Hello",
  "Options": [{ "Text": "Hi", "NextNodeId": null }],
  "Speaker": "Bjorn"
}
// Error: Additional properties not allowed: 'Speaker'
```

### Complete Dialogue File Example

```json
[
  {
    "Id": "merchant_greeting",
    "Text": "Welcome to my shop! What can I do for you today?",
    "Options": [
      {
        "Text": "What do you have for sale?",
        "NextNodeId": "merchant_inventory"
      },
      {
        "Text": "Tell me about this area.",
        "NextNodeId": "merchant_local_info"
      },
      {
        "Text": "[WILL 3] I hear you have special items for friends.",
        "SkillCheck": {
          "Attribute": "will",
          "TargetValue": 3,
          "Skill": null,
          "SkillRanks": 0
        },
        "NextNodeId": "merchant_secret_stock",
        "Conditions": [
          {
            "Type": "HasReputation",
            "Target": "MerchantGuild",
            "Value": 25,
            "Operator": "greaterThanOrEquals"
          }
        ]
      },
      {
        "Text": "Never mind.",
        "NextNodeId": null,
        "Outcome": {
          "Type": "EndConversation",
          "Data": "",
          "ReputationChange": 0,
          "AffectedFaction": null
        }
      }
    ],
    "EndsConversation": false
  },
  {
    "Id": "merchant_inventory",
    "Text": "I've got weapons, armor, and supplies. Take a look!",
    "Options": [
      {
        "Text": "Thanks, I'll browse.",
        "NextNodeId": null,
        "Outcome": {
          "Type": "FlagSet",
          "Data": "opened_merchant_shop",
          "ReputationChange": 0,
          "AffectedFaction": null
        }
      }
    ],
    "EndsConversation": false
  },
  {
    "Id": "merchant_local_info",
    "Text": "Dangerous times. Rust-Horrors have been spotted in the lower levels.",
    "Options": [
      {
        "Text": "Thanks for the warning.",
        "NextNodeId": null,
        "Outcome": {
          "Type": "Information",
          "Data": "Rust-Horrors in lower levels",
          "ReputationChange": 2,
          "AffectedFaction": "MerchantGuild"
        }
      }
    ],
    "EndsConversation": false
  },
  {
    "Id": "merchant_secret_stock",
    "Text": "Ah, a friend indeed. I have some... special items. Not for everyone.",
    "Options": [
      {
        "Text": "Show me what you've got.",
        "NextNodeId": null,
        "Outcome": {
          "Type": "FlagSet",
          "Data": "unlocked_secret_shop",
          "ReputationChange": 5,
          "AffectedFaction": "MerchantGuild"
        }
      },
      {
        "Text": "Maybe another time.",
        "NextNodeId": "merchant_greeting",
        "Outcome": null
      }
    ],
    "EndsConversation": false
  }
]
```

---

*End of v0.14.9a Design Specification*
