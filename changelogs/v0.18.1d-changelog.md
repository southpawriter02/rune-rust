# Changelog: v0.18.1d - CorruptionService Implementation

**Release Date:** 2026-02-01
**Phase:** Runic Blight Corruption (4/5)
**Status:** Complete

---

## Overview

Implements the `CorruptionService` class — the concrete implementation of the `ICorruptionService` interface (v0.18.1c) — along with the `ICorruptionRepository` persistence interface and comprehensive unit tests. This is the fourth phase of v0.18.1 (Runic Blight Corruption), bringing the corruption system to life by implementing all 9 interface methods plus 3 private helper methods.

The service manages the full lifecycle of Runic Blight Corruption: accumulation from heretical sources, Blot-Priest transfer between characters, rare corruption removal through narrative events, resource penalty queries, stage-based skill modifier calculations, and WILL-based Terminal Error survival checks. Follows the `StressService` (v0.18.0d) pattern with `═══` section separators, sync-over-async repository access, and structured logging at Debug/Information/Warning/Error levels.

Additionally creates the `ICorruptionRepository` interface and adds `InternalsVisibleTo` attributes to the Domain project, both prerequisites for the service implementation. The repository interface provides async persistence operations for per-character `CorruptionTracker` entities (get, add, update), matching the `IPlayerRepository` and `IStressHistoryRepository` patterns.

---

## Added

### Application Layer — Repository Interface

- **`ICorruptionRepository`** (`Application/Interfaces/ICorruptionRepository.cs`)
    - Box comment header with `═══` separators (Version: 0.18.1d)
    - File-scoped namespace: `RuneAndRust.Application.Interfaces`
    - Interface-level XML documentation with `<summary>`, `<remarks>` (Lifecycle Flow, One-to-One Relationship, Implementations), `<seealso>`
    - 3 async methods with full XML documentation including `<summary>`, `<param>`, `<returns>`, `<remarks>`, `<example>`:
        - `GetByCharacterIdAsync(Guid characterId, CancellationToken ct)` — retrieves tracker or null
        - `AddAsync(CorruptionTracker tracker, CancellationToken ct)` — persists new tracker
        - `UpdateAsync(CorruptionTracker tracker, CancellationToken ct)` — persists modified tracker

### Application Layer — Service

- **`CorruptionService`** (`Application/Services/CorruptionService.cs`)
    - Box comment header with `═══` separators (Version: 0.18.1d)
    - File-scoped namespace: `RuneAndRust.Application.Services`
    - Class-level XML documentation with `<summary>`, `<remarks>` (Core Mechanics, Penalty Formulas, Stages, Lifecycle Flow, Dependencies, Logging), `<example>`, `<seealso>`
    - Implements `ICorruptionService` with 9 public methods plus 3 private helpers

#### Section Structure (matching StressService pattern)

| Section | Contents |
|---------|----------|
| CONSTANTS | `TerminalErrorDc = 3`, `SurvivalCorruptionValue = 99` |
| DEPENDENCIES | `ICorruptionRepository`, `IPlayerRepository`, `IDiceService`, `ILogger<CorruptionService>` |
| CONSTRUCTOR | Null-check all 4 dependencies with `ArgumentNullException`, LogDebug initialization |
| QUERY METHODS | 5 methods delegating to tracker computed properties |
| COMMAND METHODS | `AddCorruption`, `TransferCorruption`, `RemoveCorruption` |
| TERMINAL ERROR METHODS | `PerformTerminalErrorCheck` |
| PRIVATE HELPER METHODS | `GetOrCreateTracker`, `GetPlayer`, `SaveTracker` |

#### Query Methods (5)

| Method | Returns | Implementation |
|--------|---------|----------------|
| `GetCorruptionState(Guid)` | `CorruptionState` | Delegates to `CorruptionState.Create(tracker.CurrentCorruption)` |
| `GetMaxHpPenaltyPercent(Guid)` | `int` | Delegates to `tracker.MaxHpPenaltyPercent` |
| `GetMaxApPenaltyPercent(Guid)` | `int` | Delegates to `tracker.MaxApPenaltyPercent` |
| `GetResolveDicePenalty(Guid)` | `int` | Delegates to `tracker.ResolveDicePenalty` |
| `GetSkillModifiers(Guid)` | `CorruptionSkillModifiers` | Creates via `CorruptionSkillModifiers.Create(tracker.TechBonus, tracker.SocialPenalty, tracker.IsFactionLocked)` |

#### Command Methods (3)

| Method | Returns | Key Logic |
|--------|---------|-----------|
| `AddCorruption(Guid, int, CorruptionSource)` | `CorruptionAddResult` | Validates amount >= 0, delegates to `tracker.AddCorruption()`, logs at Info/Warning/Error per event type, persists |
| `TransferCorruption(Guid, Guid, int)` | `CorruptionTransferResult` | Validates amount > 0 and not self-transfer, checks source has enough, `source.SetCorruption(current - amount)`, `target.AddCorruption(amount, BlightTransfer)`, persists both |
| `RemoveCorruption(Guid, int, string)` | `bool` | Validates amount > 0 and reason not empty/whitespace, checks tracker has enough, `SetCorruption(current - amount)`, logs at Warning, persists |

#### Terminal Error Methods (1)

| Method | Returns | Key Logic |
|--------|---------|-----------|
| `PerformTerminalErrorCheck(Guid)` | `TerminalErrorResult` | Validates `IsTerminalError`, gets player WILL, calculates `effectiveWill = max(1, baseWill - resolvePenalty)`, rolls `DicePool.D10(effectiveWill)`, compares `NetSuccesses >= DC 3`. Survived: `SetCorruption(99)`, persist. Failed: no persist (character becomes Forlorn) |

#### Private Helper Methods (3)

| Method | Returns | Logic |
|--------|---------|-------|
| `GetOrCreateTracker(Guid)` | `CorruptionTracker` | Query repo → if null, validate character via `GetPlayer()` → `CorruptionTracker.Create()` → `AddAsync` → return |
| `GetPlayer(Guid)` | `Player` | Query `IPlayerRepository` → throw `CharacterNotFoundException` if null |
| `SaveTracker(CorruptionTracker)` | `void` | Delegate to `_corruptionRepository.UpdateAsync().GetAwaiter().GetResult()` |

### Unit Tests

- **`CorruptionServiceTests`** (`Services/CorruptionServiceTests.cs`) — 65 test methods (97 test case executions)

| Section | Test Count | Key Cases |
|---------|------------|-----------|
| Constructor | 4 | Null check each of 4 dependencies |
| GetCorruptionState | 4 | Correct state, character not found, zero corruption, max corruption |
| GetMaxHpPenaltyPercent | 1 parameterized (9 cases) | Boundary cases: 0→0, 9→0, 10→5, 19→5, 20→10, 45→20, 50→25, 99→45, 100→50 |
| GetMaxApPenaltyPercent | 1 parameterized (9 cases) | Same 9 boundary cases as HP penalty |
| GetResolveDicePenalty | 1 parameterized (11 cases) | Boundary cases: 0→0, 19→0, 20→1, 39→1, 40→2, 59→2, 60→3, 79→3, 80→4, 99→4, 100→5 |
| GetSkillModifiers | 5 | One per stage: Uncorrupted, Tainted, Infected, Blighted, Corrupted |
| AddCorruption | 13 | Valid amount, clamping to 100, zero amount no-change, negative throws, threshold crossing, no threshold in same range, stage crossing, terminal error at 100, faction lock at 50, all 8 sources, persist verified, creates if not exists, character not found |
| TransferCorruption | 9 | Valid transfer, insufficient corruption, self-transfer throws, zero/negative amount throws, target reaches 100 terminal, uses BlightTransfer source, persists both trackers, character not found |
| RemoveCorruption | 10 | Valid removal, exact amount, exceeds current, zero corruption, zero/negative amount throws, null/empty/whitespace reason throws, persist verified |
| PerformTerminalErrorCheck | 11 | Pass sets to 99, fail stays at 100, not at terminal throws, effective WILL with penalty, min 1 die, critical success, exact DC survives, one-less-than-DC fails, survived persists, failed does not persist, high WILL with penalty |
| GetOrCreateTracker | 3 | Existing returns from repo, new creates and persists, no character throws |
| Integration Scenarios | 2 | Add-then-transfer, reach-100-then-check |

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries (sortOrder 99-100)
    - `corruption-repository`: Repository interface for CorruptionTracker persistence with get, add, and update operations
    - `corruption-service-implementation`: Concrete CorruptionService class implementing all 9 ICorruptionService methods for corruption management

---

## Changed

### Domain Layer — Project Configuration

- **`src/Core/RuneAndRust.Domain/RuneAndRust.Domain.csproj`** — Added 2 `InternalsVisibleTo` entries
    - `RuneAndRust.Application` — allows CorruptionService to call `CorruptionTracker.SetCorruption()` (internal) for transfer, removal, and terminal error survival
    - `RuneAndRust.Application.UnitTests` — allows tests to call `SetCorruption()` for test setup

### Documentation

- **`docs/design/v0.18.x/v0.18.1-scope-breakdown.md`** — Checked off v0.18.1d acceptance criteria
- **`docs/design/v0.18.x/v0.18.1d-design-specification.md`** — Checked off all deliverable and acceptance criteria items

---

## Design Decisions

### IPlayerRepository Instead of ICharacterRepository

The design specification references `ICharacterRepository` as a dependency for retrieving character WILL attributes. This interface does not exist in the codebase. `IPlayerRepository` (used by `StressService`) provides `GetByIdAsync(Guid)` returning a `Player` entity with a `Will` property, which is the correct existing API. The service uses `IPlayerRepository` following the same pattern as `StressService`.

### Moq Instead of NSubstitute

The design specification's test code uses `NSubstitute` (`Substitute.For<>()`, `.Returns()`). The actual test infrastructure in this codebase uses **Moq** (`Mock<>`, `.Setup().ReturnsAsync()`, `.Verify()`). `CorruptionServiceTests` follows the established `StressServiceTests` pattern using Moq for consistency.

### IDiceService.Roll(DicePool) Instead of RollAttributeCheck

The design specification references `_diceService.RollAttributeCheck(effectiveWill, TerminalErrorDc)`. The actual `IDiceService` interface exposes `Roll(DicePool pool)` returning a `DiceRollResult` with a `NetSuccesses` property. The implementation uses `DicePool.D10(effectiveWill)` to create the pool and compares `rollResult.NetSuccesses >= TerminalErrorDc`, matching the actual API.

### CorruptionSkillModifiers Uses Existing 3-Parameter Create Factory

The design specification defines `CorruptionSkillModifiers` with additional `Stage` and `CurrentCorruption` properties and a `FromTracker` factory. The existing v0.18.1c implementation has a 3-parameter `Create(techBonus, socialPenalty, factionLocked)` factory. The service uses the existing factory to avoid modifying v0.18.1c deliverables.

### CorruptionTransferResult Uses Existing 5-Parameter Create Factory

The design specification adds `SourceCharacterId` and `TargetCharacterId` properties to `CorruptionTransferResult` with `Transferred` and `Failed` factories. The existing v0.18.1c implementation has a 5-parameter `Create(success, amountTransferred, sourceNewCorruption, targetNewCorruption, targetTerminalError)` factory. The service uses the existing factory to avoid modifying v0.18.1c deliverables.

### Sync-Over-Async Repository Access

All repository calls use `.GetAwaiter().GetResult()` wrapping async methods, matching the established `StressService` pattern. A `// TODO: v0.19.x — Make service methods async to eliminate sync-over-async` comment documents the planned async refactoring.

### GetOrCreateTracker Validates Character Existence

When no tracker exists for a character ID, `GetOrCreateTracker` first validates the character exists via `IPlayerRepository` before creating a new tracker. This prevents orphaned trackers for invalid character IDs and throws `CharacterNotFoundException` consistently with other service methods.

### Failed Terminal Error Check Does Not Persist Tracker

When a character fails the Terminal Error check (becomes Forlorn), the tracker is NOT persisted — corruption stays at 100. The Forlorn state management is deferred to future versions (v0.21.x). This matches the design specification's note: "Actual Forlorn state is managed by Character entity (future version)."

### Test Count Far Exceeds Estimate

The design specification estimated ~5 tests for v0.18.1d. The implementation includes 65 test methods across 12 sections with 97 individual test case executions. This comprehensive coverage tests all boundary conditions, error paths, parameter validation, repository interactions, and integration scenarios.

---

## Logging Strategy

Comprehensive structured logging following the design specification section 8 log events table:

| Event | Level | Template |
|-------|-------|----------|
| Service initialized | Debug | `"CorruptionService initialized with {Dependencies}"` |
| State queried | Debug | `"Corruption state queried for {CharacterId}: {Corruption}/{Max} [{Stage}]"` |
| Modifiers queried | Debug | `"Skill modifiers queried for {CharacterId}: Tech+{TechBonus}, Social{SocialPenalty}, FactionLocked={FactionLocked}"` |
| Tracker created | Debug | `"Created new corruption tracker for {CharacterId}"` |
| Corruption added | Information | `"Corruption added: {CharacterId} +{Amount} [{Source}] ({Previous} → {New})"` |
| Stage changed | Information | `"Corruption stage changed for {CharacterId}: {PreviousStage} → {NewStage}"` |
| Transfer completed | Information | `"Corruption transferred: {FromId} → {ToId} amount={Amount} (Source: {SourceOld} → {SourceNew}, Target: {TargetOld} → {TargetNew})"` |
| Threshold crossed | Warning | `"Corruption threshold {Threshold}% crossed for {CharacterId}"` |
| Faction locked | Warning | `"Faction reputation LOCKED for {CharacterId}: Corruption at {Value}"` |
| Corruption removed | Warning | `"Corruption REMOVED: {CharacterId} -{Amount} ({Previous} → {New}). Reason: {Reason}"` |
| Terminal error check | Warning | `"Terminal Error check for {CharacterId}: WILL {BaseWill} - {Penalty} penalty = {Effective} dice vs DC {Dc}"` |
| Terminal error survived | Warning | `"Terminal Error SURVIVED: {CharacterId} rolled {Successes}/{Dc}, corruption set to {Value}"` |
| Transfer failed | Warning | `"Transfer FAILED: {FromId} has {Current} corruption, requested {Amount}"` |
| Removal failed | Warning | `"Corruption removal failed: {CharacterId} has {Current}, requested {Amount}"` |
| Terminal error triggered | Error | `"TERMINAL ERROR: {CharacterId} corruption reached 100"` |
| Terminal error failed | Error | `"Terminal Error FAILED: {CharacterId} rolled {Successes}/{Dc} — CHARACTER BECAME FORLORN"` |
| Transfer terminal error | Error | `"Transfer caused TERMINAL ERROR for target {CharacterId}"` |

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
|------|-------|-------|
| `CorruptionStage` | v0.18.1a | Stage enum for skill modifier calculations |
| `CorruptionState` | v0.18.1a | Return type for `GetCorruptionState` |
| `CorruptionSource` | v0.18.1b | Parameter type for `AddCorruption` |
| `CorruptionAddResult` | v0.18.1b | Return type for `AddCorruption` |
| `TerminalErrorResult` | v0.18.1b | Return type for `PerformTerminalErrorCheck` |
| `CorruptionTracker` | v0.18.1b | Domain entity managed by service |
| `ICorruptionService` | v0.18.1c | Interface implemented by CorruptionService |
| `CorruptionTransferResult` | v0.18.1c | Return type for `TransferCorruption` |
| `CorruptionSkillModifiers` | v0.18.1c | Return type for `GetSkillModifiers` |
| `CharacterNotFoundException` | v0.18.0d | Exception thrown when character not found |
| `StressService` | v0.18.0d | Pattern reference for service structure, logging, sync-over-async |
| `IPlayerRepository` | v0.4.x | Character WILL attribute for Terminal Error checks |
| `IDiceService` | v0.6.x | Dice rolling for WILL-based Terminal Error survival checks |
| `DicePool` | v0.6.x | D10 dice pool creation for Terminal Error rolls |
| `PlayerBuilder` | TestUtilities | Test helper for creating Player entities |

### Provides to Future Phases

| Type | Phase | Usage |
|------|-------|-------|
| `CorruptionService` | v0.18.1e | Service to be wired into DI container and configured |
| `ICorruptionRepository` | v0.18.1e | Interface to be implemented (InMemoryCorruptionRepository, EF Core) |
| `CorruptionService` | v0.18.5 | Consumed by resource integration service |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Interfaces/ICorruptionRepository.cs` | Repository interface for CorruptionTracker persistence (3 methods) |
| `src/Core/RuneAndRust.Application/Services/CorruptionService.cs` | CorruptionService implementation (9 public + 3 private methods) |
| `tests/RuneAndRust.Application.UnitTests/Services/CorruptionServiceTests.cs` | CorruptionService tests (65 methods, 97 executions) |
| `changelogs/v0.18.1d-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/RuneAndRust.Domain.csproj` | Added 2 InternalsVisibleTo entries (Application, Application.UnitTests) |
| `config/glossary.json` | Added 2 glossary entries (sortOrder 99-100) |
| `docs/design/v0.18.x/v0.18.1-scope-breakdown.md` | Checked off v0.18.1d acceptance criteria |
| `docs/design/v0.18.x/v0.18.1d-design-specification.md` | Checked off all deliverable and acceptance criteria items |

---

## Notes

- Total unit tests for v0.18.1d: 65 test methods across 1 test file (97 individual test case executions, far exceeding the ~5 estimate due to comprehensive boundary condition and error path coverage)
- All 97 new test executions pass; all existing tests unaffected (0 regressions)
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` box comment headers and section separators, `#region` directives for service sections, file-scoped namespaces, comprehensive XML documentation with `<summary>`, `<remarks>`, `<para>`, `<list>`, `<example>`, `<seealso>`, and `<value>` tags
- Pre-existing glossary schema validation failure at term #88 remains (unrelated to v0.18.1d changes)
- The CorruptionService follows the StressService (v0.18.0d) pattern: same section structure, same sync-over-async convention, same GetOrCreateTracker/GetPlayer/SaveTracker helper pattern, same null-check constructor pattern, same structured logging conventions
- Key design spec deviations documented: IPlayerRepository (not ICharacterRepository), Moq (not NSubstitute), IDiceService.Roll(DicePool) (not RollAttributeCheck), existing value object factories (not design spec's extended versions)
