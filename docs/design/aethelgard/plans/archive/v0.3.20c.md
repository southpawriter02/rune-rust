> **Archived** - This plan has been consolidated. See the complete version at [v0.3.20](../v0.3.x/v0.3.20.md).

Here is the comprehensive implementation plan for v0.3.20c: The Pathfinder (Fast Travel).
This sub-version introduces "Auto-Walk" functionality. In keeping with Domain 4 (No Magic), this is not teleportation. It is an automated execution of movement commands along a known, safe route. Time passes, resources are consumed (though often at a reduced "travel pace" rate), and the player watches their character traverse the map rapidly.

v0.3.20c: The Pathfinder
Goal: Implement PathfinderService to calculate A* routes through visited rooms and AutoTravelService to execute the movement loop, allowing players to automatically backtrack to known safe zones (Settlements/Anchors).
1. Architecture & Data Flow
	•	Graph Restriction: The pathfinding graph consists only of GameState.VisitedRoomIds. The player cannot auto-path through the Fog of War.
	•	Heuristic: Standard Manhattan Distance (|x1 - x2| + |y1 - y2| + |z1 - z2|) is sufficient for the grid-based layout defined in v0.0.5.
	•	Execution Loop: AutoTravelService orchestrates the journey. It does not "teleport" the coordinates; it iteratively calls NavigationService.MoveAsync() for each step. This ensures all side effects (Time passing, Passive Perception checks, Event triggers) still occur, just rapidly.
Data Flow: The Travel Pipeline
	1	Command: Player types travel utgard.
	2	Resolution: AutoTravelService searches VisitedRoomIds for a room named "Utgard" (or matching Settlement/Anchor tags).
	3	Pathfinding:
	◦	Load all visited rooms from IRoomRepository.
	◦	Build adjacency graph (filtering out locked doors or blocked paths if state is tracked).
	◦	Execute A* to find the shortest path.
	4	Execution:
	◦	Loop: For each room in path:
	▪	Check Stamina/Conditions.
	▪	Call NavigationService.MoveAsync(Direction).
	▪	Render brief update (e.g., "Walking... [||||| ]").
	▪	Delay (50ms) for visual feedback.
	◦	Arrival: Print full Room Description.

2. Logic Decision Trees
A. Target Resolution Logic Input: Argument "target"
	1	Is "target" a known location name? (Case-insensitive search on Visited Rooms).
	◦	Yes: Set DestinationID.
	2	Is "target" a category? (e.g., "home", "anchor", "surface").
	◦	Yes: Find nearest Visited Room with corresponding RoomFeature.
	3	Validation: Is DestinationID reachable? (Run Pathfinding).
	◦	No: Error "No known path to {target}."
B. Travel Safety Logic (Per Step) Input: Next Room ID
	1	Danger Check: Is NextRoom.DangerLevel == Lethal?
	◦	Yes: Abort. "Path too dangerous for auto-travel."
	2	Resource Check: Is Player [Overburdened] or [Exhausted]?
	◦	Yes: Abort. "Too tired to travel fast."
	3	Hazard Check: Does NextRoom have an active DynamicHazard?
	◦	Yes: Abort. "Hazard detected ahead."
	4	Action: Execute Move.

3. Code Implementation
A. A Pathfinder* File: RuneAndRust.Engine/Services/PathfinderService.cs
public class PathfinderService
{
    // A* implementation optimized for Grid Coordinates
    public List<Direction> FindPath(Room start, Room end, List<Room> allVisited)
    {
        var graph = allVisited.ToDictionary(r => r.Id);
        if (!graph.ContainsKey(end.Id)) return null;

        var frontier = new PriorityQueue<Room, int>();
        frontier.Enqueue(start, 0);

        var cameFrom = new Dictionary<Guid, Guid?>();
        var costSoFar = new Dictionary<Guid, int>();

        cameFrom[start.Id] = null;
        costSoFar[start.Id] = 0;

        while (frontier.Count > 0)
        {
            var current = frontier.Dequeue();
            if (current.Id == end.Id) break;

            foreach (var exit in current.Exits)
            {
                // Only traverse if we have visited the destination
                if (!graph.TryGetValue(exit.Value, out var neighbor)) continue;

                // Cost is 1 per move (could add weight for Hazards later)
                int newCost = costSoFar[current.Id] + 1;

                if (!costSoFar.ContainsKey(neighbor.Id) || newCost < costSoFar[neighbor.Id])
                {
                    costSoFar[neighbor.Id] = newCost;
                    int priority = newCost + Heuristic(neighbor, end);
                    frontier.Enqueue(neighbor, priority);
                    cameFrom[neighbor.Id] = current.Id;
                }
            }
        }

        return ReconstructPath(cameFrom, start, end, graph);
    }

    private int Heuristic(Room a, Room b)
        => Math.Abs(a.Position.X - b.Position.X)
         + Math.Abs(a.Position.Y - b.Position.Y)
         + Math.Abs(a.Position.Z - b.Position.Z);
}
B. AutoTravel Service File: RuneAndRust.Engine/Services/AutoTravelService.cs
public class AutoTravelService
{
    private readonly INavigationService _nav;
    private readonly IPathfinderService _pathfinder;
    private readonly IRoomRepository _repo;
    private readonly IInputHandler _input;

    public async Task TravelToAsync(string targetName)
    {
        var currentRoom = await _nav.GetCurrentRoomAsync();
        var visited = await _repo.GetVisitedRoomsAsync(); // Needs adding to Repo

        // 1. Resolve Target
        var target = visited.FirstOrDefault(r =>
            r.Name.Equals(targetName, StringComparison.OrdinalIgnoreCase));

        if (target == null)
        {
            _input.DisplayError($"You recall no place named '{targetName}'.");
            return;
        }

        // 2. Calculate Path
        var pathDirections = _pathfinder.FindPath(currentRoom, target, visited);
        if (pathDirections == null || !pathDirections.Any())
        {
            _input.DisplayError("No safe route found.");
            return;
        }

        // 3. Execute Loop
        _input.DisplayMessage($"Traveling to {target.Name} ({pathDirections.Count} steps)...");

        foreach (var dir in pathDirections)
        {
            // Check interrupts here (e.g. key press to cancel)
            await _nav.MoveAsync(dir);
            await Task.Delay(50); // Visual pacing
        }

        // Force full look on arrival
        await _nav.LookAsync();
    }
}

4. Deliverable Checklist (v0.3.20c)
	•	Core/Persistence:
	◦	[ ] Add GetVisitedRoomsAsync to IRoomRepository.
	◦	[ ] Ensure Room entity has Features initialized.
	•	Engine:
	◦	[ ] Implement PathfinderService (A* logic).
	◦	[ ] Implement AutoTravelService (Execution loop).
	◦	[ ] Update CommandParser to handle travel <name> command.
	•	Testing:
	◦	[ ] Validate pathfinding doesn't traverse unvisited rooms (Fog of War integrity).
	◦	[ ] Verify "Travel" loop stops if MoveAsync fails (e.g. sudden blockage).

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Travel
Route Calc
Debug
"[Path] Calculated route from {Start} to {End}: {Count} steps."
Start, End, Count
Travel
Step
Trace
"[Path] Auto-step {Direction}."
Direction
Travel
Interrupted
Warning
"[Path] Travel interrupted at {Room}. Reason: {Reason}."
Room, Reason

6. Testing Strategy
Unit Tests (PathfinderTests.cs):
	•	Avoid_Unvisited:
	◦	Setup: A 3x3 grid. Start (0,0), End (0,2). Middle (0,1) is unvisited.
	◦	Act: FindPath.
	◦	Assert: Path goes around (e.g., 1,0 -> 1,1 -> 1,2 -> 0,2) or fails if blocked.
	•	Respect_Z_Level:
	◦	Setup: Room A (Z=0), Room B (Z=1). Connected by Stairs.
	◦	Act: FindPath.
	◦	Assert: Path includes Direction.Up.
Integration Tests:
	•	Execution_Loop:
	◦	Setup: Simple linear path of 3 rooms.
	◦	Act: travel room3.
	◦	Assert: CurrentRoomId is Room3. TurnCount increased by 2.

7. Draft Changelog (v0.3.20)
# Changelog: v0.3.20 - The Cartographer II

**Release Date:** 2026-02-XX

## Summary
The "Cartographer II" update transforms navigation from manual inputs into a streamlined system. Players can now create persistent notes on their map, export their journey for external reference, and use "Auto-Travel" to automatically backtrack through explored territory.

## Changes
- **Map Notes:** Added `note <text>` command. Rooms with notes display a `!` icon on the minimap.
- **Atlas Export:** Added `map export` command to generate a `map_export.txt` file containing your entire explored map layout in ASCII.
- **Fast Travel:** Added `travel <name>` command. This automatically walks your character to any previously visited room with that name, provided a safe path exists.
This completes Milestone 4.9: The Long Polish in its entirety.
Would you like to proceed to Milestone 5: The Saga, starting with v0.4.0: Saga Progression?
