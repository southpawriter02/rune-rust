> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.2](../v0.3.x/v0.3.2.md).

# Changelog: v0.3.2c - The Dawn (Integration)

**Release Date:** 2025-12-20

## Summary

This release integrated the rest and ambush systems (v0.3.2a-b) into the player-facing command interface, completing the Rest & Recovery feature cycle. The Terminal Layer received a new RestScreenRenderer for rich TUI feedback using Spectre.Console, while CommandParser was extended to handle rest/camp/sleep commands with sanctuary detection and ambush transition logic. The Room entity gained a Features system to enable location-based rest types, and GameState was enhanced with PendingEncounter support for seamless ambush-to-combat flow. This release emphasizes integration testing with 10 dedicated CommandParserRestTests validating the full command-to-renderer pipeline and 7 edge-case tests ensuring phase-appropriate command handling.

---

## New Files Created

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Services/RestScreenRenderer.cs` | Spectre.Console-based rest result display with recovery tables, exhaustion warnings, and ambush alerts |

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/RoomFeature.cs` | Defines room features enabling gameplay mechanics (RunicAnchor, Workbench, AlchemyTable) |
| `RuneAndRust.Core/Interfaces/IRestScreenRenderer.cs` | Interface contract for rest result rendering with Render and RenderAmbushWarning methods |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CommandParserRestTests.cs` | Integration tests for rest/camp command parsing with 10 test cases covering sanctuary logic, ambush handling, and error conditions |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Room.cs` | Added Features property (List<RoomFeature>) and HasFeature(RoomFeature) method for feature detection |
| `RuneAndRust.Core/Models/GameState.cs` | Added PendingEncounter property (JsonIgnore) for ambush-to-combat transition, reset in Reset() method |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added rest/camp/sleep command handling, HandleRestCommandAsync() method, constructor parameters for IRestService/IRestScreenRenderer/IRoomRepository |
| `RuneAndRust.Terminal/Program.cs` | Registered IRestScreenRenderer -> RestScreenRenderer as Singleton, updated version banner to v0.3.2c |
| `RuneAndRust.Tests/Engine/CommandParserTests.cs` | Added 7 tests for rest/camp command validation (service availability, phase restrictions) |

---

## Code Implementation Details

### RestScreenRenderer (Spectre.Console)

**Constructor:**
```csharp
public RestScreenRenderer(ILogger<RestScreenRenderer> logger)
```

**Key Methods:**

**Render(RestResult result)**
- Displays yellow "Rest & Recovery" banner using Spectre.Console Rule
- Renders exhaustion warning panel (red, rounded border) if IsExhausted is true
- Creates recovery statistics table (40-width, rounded border):
  - Health: Green +HP or grey +0
  - Stamina: Cyan +Stamina or grey +0
  - Stress: Purple -Stress or grey -0
- Shows supply consumption message if SuppliesConsumed is true
- Calculates and displays time passage in hours (TimeAdvancedMinutes / 60)
- Blocks with Console.ReadKey(true) until player presses Enter
- Logs entry at Info level, debug for recovery deltas, trace for dismissal

**RenderAmbushWarning(AmbushResult ambushResult)**
- Displays red "AMBUSH!" banner using Spectre.Console Rule
- Shows escaped ambush message (protects against markup injection)
- Creates risk details table (40-width, rounded border):
  - Base Risk: Yellow percentage
  - Wits Mitigation: Green negative percentage
  - Final Risk: Red percentage
  - Roll: Grey d100 value
- Shows "Enemies approach..." and "Press Enter to engage." prompts
- Blocks with Console.ReadKey(true)
- Logs entry at Warning level with base/final risk and roll value

**Helper Methods:**
- RenderRestBanner(): Creates centered yellow Rule
- RenderAmbushBanner(): Creates centered red Rule
- RenderExhaustionWarning(): Creates red Panel with exhaustion text
- RenderRecoveryTable(RestResult): Builds attribute change table
- RenderSupplyConsumption(): Displays "Consumed: 1 Ration, 1 Water"
- RenderTimePassage(int minutes): Displays elapsed hours
- RenderRiskDetails(AmbushResult): Builds risk calculation table
- EscapeMarkup(string text): Replaces [ and ] with [[ and ]] for Spectre safety

### CommandParser Rest Handling

**Constructor Addition:**
```csharp
public CommandParser(
    ILogger<CommandParser> logger,
    IInputHandler inputHandler,
    GameState gameState,
    IJournalService? journalService = null,
    ICombatService? combatService = null,
    IVictoryScreenRenderer? victoryRenderer = null,
    IRestService? restService = null,              // v0.3.2c
    IRestScreenRenderer? restRenderer = null,       // v0.3.2c
    IRoomRepository? roomRepository = null)         // v0.3.2c
```

**HandleRestCommandAsync(GameState state, bool preferSanctuary)**
- Validates required services (RestService, RestRenderer, RoomRepository) and displays error if null
- Validates CurrentCharacter exists or displays "No active character"
- Validates CurrentRoomId exists or displays "You are nowhere. This should not happen."
- Retrieves Room entity from repository
- Determines RestType based on preferSanctuary and room.HasFeature(RoomFeature.RunicAnchor):
  - preferSanctuary && hasAnchor -> RestType.Sanctuary, displays "You rest at the Runic Anchor..."
  - Otherwise -> RestType.Wilderness, displays "You set up camp in the wilderness..."
- Calls RestService.PerformRestAsync(character, restType, room)
- On ambush (WasAmbushed is true):
  - Calls RestRenderer.RenderAmbushWarning(ambushDetails)
  - Sets GameState.PendingEncounter to ambushDetails.Encounter
  - Sets GamePhase to Combat
  - Logs warning about combat transition
- On success:
  - Calls RestRenderer.Render(result)
  - Increments TurnCount
  - Logs recovery deltas at Info level

**Command Mapping:**
- "rest" -> HandleRestCommandAsync(state, preferSanctuary: true)
- "camp" -> HandleRestCommandAsync(state, preferSanctuary: false)
- "sleep" -> HandleRestCommandAsync(state, preferSanctuary: false)

**Help Text Addition (DisplayExplorationHelp):**
```
Rest & Recovery:
  rest             - Rest (Sanctuary at anchors, Wilderness elsewhere)
  camp             - Set up camp in the wilderness (ambush risk)
  sleep            - Same as camp
```

### RoomFeature Enum

**Definition:**
```csharp
public enum RoomFeature
{
    None = 0,
    RunicAnchor = 1,    // Allows Sanctuary rest with full recovery
    Workbench = 2,      // Allows crafting activities
    AlchemyTable = 3    // Allows potion brewing
}
```

**Usage:**
- Room.Features is List<RoomFeature> (default empty list)
- Room.HasFeature(RoomFeature feature) returns Features.Contains(feature)

### GameState.PendingEncounter

**Property:**
```csharp
[JsonIgnore]
public EncounterDefinition? PendingEncounter { get; set; }
```

**Behavior:**
- Not serialized to save files
- Set by CommandParser when ambush occurs during rest
- Consumed by GameService when entering Combat phase
- Reset to null in GameState.Reset() method

### IRestScreenRenderer Interface

**Contract:**
```csharp
public interface IRestScreenRenderer
{
    void Render(RestResult result);
    void RenderAmbushWarning(AmbushResult ambushResult);
}
```

---

## Logging Matrix

### RestScreenRenderer
| Event | Level | Template |
|-------|-------|----------|
| Rest screen entry | Info | `"Rendering rest screen. HP+{Hp}, Stamina+{Stamina}, Stress-{Stress}, Exhausted: {Exhausted}"` |
| Recovery table rendered | Debug | `"Rendered recovery: HP+{Hp}, Stamina+{Stamina}, Stress-{Stress}"` |
| Rest screen dismissed | Trace | `"Rest screen rendered and dismissed"` |
| Ambush warning entry | Warning | `"Rendering ambush warning. BaseRisk: {Base}%, Final: {Final}%, Roll: {Roll}"` |
| Ambush risk details rendered | Debug | `"Rendered ambush details: Base {Base}%, Mitigation -{Mit}%, Final {Final}%, Roll {Roll}"` |
| Ambush warning dismissed | Trace | `"Ambush warning rendered and dismissed"` |

### CommandParser (Rest Commands)
| Event | Level | Template |
|-------|-------|----------|
| Rest command execution | Info | `"Player executed {Command} in {Room}."` |
| Rest type determination | Debug | `"Rest type determined: {RestType} (HasAnchor: {HasAnchor})"` |
| Ambush transition | Warning | `"Rest interrupted by ambush. Transitioning to Combat."` |
| Successful rest completion | Info | `"Rest complete. HP+{HP} Stamina+{Stamina} Stress-{Stress}."` |
| Missing services warning | Warning | `"Rest command attempted but required services are not configured."` |
| Missing room error | Error | `"Rest command attempted with null CurrentRoomId."` |
| Room not found error | Error | `"Room {RoomId} not found in database."` |

---

## Test Coverage

### Build Verification
```
Build succeeded.
    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.79
```

### Test Execution
```
Passed!  - Failed:     0, Passed:    10, Skipped:     0, Total:    10, Duration: 66 ms
```

### CommandParserRestTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| Rest_AtRunicAnchor_UsesSanctuaryType | Room with RunicAnchor feature triggers RestType.Sanctuary |
| Rest_WithoutAnchor_UsesWildernessType | Room without RunicAnchor feature triggers RestType.Wilderness |
| Camp_AlwaysUsesWildernessType | Camp command ignores RunicAnchor and always uses Wilderness rest |
| Camp_AmbushTriggered_SetsGamePhaseCombat | Ambush result sets GamePhase.Combat |
| Camp_AmbushTriggered_StoresPendingEncounter | Ambush result stores encounter in GameState.PendingEncounter |
| Camp_AmbushTriggered_RendersAmbushWarning | Ambush result calls RenderAmbushWarning and not Render |
| Camp_NoAmbush_RendersCalled | Successful rest calls Render and not RenderAmbushWarning |
| Rest_IncrementsTurnCount | Successful rest increments GameState.TurnCount by 1 |
| Rest_WithoutCharacter_DisplaysError | Missing CurrentCharacter displays error containing "character" |
| Rest_WithoutRoom_DisplaysError | Null CurrentRoomId displays error containing "nowhere" |

### CommandParserTests - Rest Region (7 tests)

| Test Name | Description |
|-----------|-------------|
| Rest_WithoutRequiredServices_DisplaysErrorMessage | Rest command without IRestService shows error containing "not available" |
| Camp_WithoutRequiredServices_DisplaysErrorMessage | Camp command without IRestService shows error containing "not available" |
| Sleep_WithoutRequiredServices_DisplaysErrorMessage | Sleep alias without IRestService shows error containing "not available" |
| Rest_InMainMenuPhase_DoesNotTriggerRestCommand | Rest command in MainMenu phase treated as unknown command |
| Camp_InMainMenuPhase_DoesNotTriggerCampCommand | Camp command in MainMenu phase treated as unknown command |
| Rest_InCombatPhase_DoesNotTriggerRestCommand | Rest command in Combat phase treated as unknown command |
| Camp_InCombatPhase_DoesNotTriggerCampCommand | Camp command in Combat phase treated as unknown command |

---

## DI Registration

**Added to RuneAndRust.Terminal/Program.cs:**
```csharp
// Register Rest Screen Renderer (v0.3.2c)
services.AddSingleton<IRestScreenRenderer, RestScreenRenderer>();
```

**Dependencies:**
- IRestScreenRenderer (Singleton) -> RestScreenRenderer
- CommandParser constructor accepts IRestService, IRestScreenRenderer, IRoomRepository (all optional)

---

## Verification Results

### Build Output
```
RuneAndRust.Core -> .../bin/Debug/net9.0/RuneAndRust.Core.dll
RuneAndRust.Persistence -> .../bin/Debug/net9.0/RuneAndRust.Persistence.dll
RuneAndRust.Engine -> .../bin/Debug/net9.0/RuneAndRust.Engine.dll
RuneAndRust.Terminal -> .../bin/Debug/net9.0/RuneAndRust.Terminal.dll
RuneAndRust.Tests -> .../bin/Debug/net9.0/RuneAndRust.Tests.dll

Build succeeded.
```

### Test Output
```
Test run for /Volumes/GitHub/github/southpawriter02/rune-rust/RuneAndRust.Tests/bin/Debug/net9.0/RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    10, Skipped:     0, Total:    10, Duration: 66 ms - RuneAndRust.Tests.dll (net9.0)
```

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   └── Room.cs                                         [MODIFIED]
│   ├── Enums/
│   │   └── RoomFeature.cs                                  [NEW]
│   ├── Interfaces/
│   │   └── IRestScreenRenderer.cs                          [NEW]
│   └── Models/
│       └── GameState.cs                                    [MODIFIED]
├── RuneAndRust.Engine/
│   └── Services/
│       └── CommandParser.cs                                [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Program.cs                                          [MODIFIED]
│   └── Services/
│       └── RestScreenRenderer.cs                           [NEW]
└── RuneAndRust.Tests/
    └── Engine/
        ├── CommandParserRestTests.cs                       [NEW]
        └── CommandParserTests.cs                           [MODIFIED]
```

---

## Running Tests

### Run All CommandParserRestTests
```bash
dotnet test --filter "FullyQualifiedName~CommandParserRestTests"
```

### Run Specific Test
```bash
dotnet test --filter "FullyQualifiedName~CommandParserRestTests.Rest_AtRunicAnchor_UsesSanctuaryType"
```

### Run All Rest-Related Tests
```bash
dotnet test --filter "FullyQualifiedName~Rest"
```

---

## Next Steps (v0.3.3)

- **Time Advancement Integration**: Wire WorldTime into RestService for persistent day/night cycle tracking
- **Sanctuary Discovery Mechanics**: Implement RunicAnchor unlocking through exploration or quest completion
- **Camp Craft Skill Bonus**: Apply Camp Craft attribute to ambush mitigation percentage
- **Watch Rotation System**: Multi-character party rest with watch assignments to reduce ambush risk
- **Rest Interruption Events**: Non-combat interruptions (weather, noise, discoveries)
- **Long Rest System**: Multi-day rest for trauma recovery and major healing
