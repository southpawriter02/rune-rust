> **Archived** - This plan has been consolidated. See the complete version at [v0.3.20](../v0.3.x/v0.3.20.md).

Here is the comprehensive implementation plan for v0.3.20b: The Atlas (Export & Legend).
This sub-version moves the map from a transient UI element to a persistent artifact. It allows players to dump their entire exploration progress into a shareable text file, complete with a legend and coordinates, useful for external tracking or community sharing.

v0.3.20b: The Atlas
Goal: Implement the MapExportService to generate a normalized ASCII grid of all visited rooms, including user notes and key landmarks, and save it to the local file system.
1. Architecture & Data Flow
	•	Normalization Engine: Unlike the Minimap (which is relative to the player), the Export must calculate the absolute bounds (Min/Max X and Y) of all visited rooms to create a fixed grid.
	•	Z-Level Flattening: The exporter will generate one map block per Z-level visited, stacking them vertically in the text file.
	•	File I/O: Maps are saved to data/exports/ with a timestamped filename (e.g., map_charname_20251224.txt).
Data Flow: The Export Pipeline
	1	Command: Player types map export.
	2	Fetch: Engine retrieves all Room entities corresponding to GameState.VisitedRoomIds.
	3	Analyze: Calculate MinX, MaxX, MinY, MaxY for each unique Z-level.
	4	Render:
	◦	Iterate Z-levels (Top to Bottom).
	◦	Iterate Y rows (North to South).
	◦	Iterate X columns (West to East).
	◦	Resolve symbol for each coordinate.
	5	Write: Stream StringBuilder content to file.
	6	Feedback: Notify user of file path.

2. Logic Decision Trees
A. Coordinate Normalization Logic Input: List of Rooms
	1	Group rooms by Z-index.
	2	For each Z-Group:
	◦	Find xMin, xMax, yMin, yMax.
	◦	Width = (xMax - xMin) + 1.
	◦	Height = (yMax - yMin) + 1.
	3	Offset Calculation:
	◦	To plot room at (x, y) in a 0-indexed array: Array[x - xMin, yMax - y]. (Inverting Y because console/text files print top-down, but coordinates are bottom-up).
B. ASCII Symbol Logic (Text File Friendly) Input: Room Entity
	1	Is Player Here? -> @
	2	Has Note? (UserNotes.ContainsKey) -> !
	3	Is Boss Lair? -> X
	4	Is Settlement? -> $
	5	Is Runic Anchor? -> *
	6	Has Stairs Up/Down? -> ^ / v
	7	Standard Room? -> #
	8	Empty Space? -> . (Dot for empty grid cells to maintain alignment)

3. Code Implementation
A. Map Export Service File: RuneAndRust.Engine/Services/MapExportService.cs
public class MapExportService
{
    private readonly IRoomRepository _roomRepo;
    private readonly GameState _gameState;

    public async Task<string> ExportMapAsync()
    {
        var visitedIds = _gameState.VisitedRoomIds;
        var rooms = await _roomRepo.GetBatchAsync(visitedIds); // Helper needed in Repo

        var sb = new StringBuilder();
        sb.AppendLine($"ATLAS EXPORT - {_gameState.CurrentCharacter?.Name}");
        sb.AppendLine($"Date: {DateTime.Now}");
        sb.AppendLine(new string('=', 40));

        // Group by Z level, order Top to Bottom
        var levels = rooms.GroupBy(r => r.Position.Z).OrderByDescending(g => g.Key);

        foreach (var level in levels)
        {
            sb.AppendLine($"\n[DEPTH Z: {level.Key}]");
            AppendLevelGrid(sb, level.ToList());
        }

        sb.AppendLine("\nLEGEND:");
        sb.AppendLine("@ : You are here");
        sb.AppendLine("! : Note Attached");
        sb.AppendLine("$ : Settlement");
        sb.AppendLine("* : Runic Anchor");
        sb.AppendLine("# : Explored Room");
        sb.AppendLine(". : Unexplored/Void");

        var filename = $"map_{_gameState.CurrentCharacter?.Name}_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
        var path = Path.Combine("data", "exports", filename);

        Directory.CreateDirectory(Path.GetDirectoryName(path)!);
        await File.WriteAllTextAsync(path, sb.ToString());

        return path;
    }

    private void AppendLevelGrid(StringBuilder sb, List<Room> rooms)
    {
        if (!rooms.Any()) return;

        int minX = rooms.Min(r => r.Position.X);
        int maxX = rooms.Max(r => r.Position.X);
        int minY = rooms.Min(r => r.Position.Y);
        int maxY = rooms.Max(r => r.Position.Y);

        // Y goes from Max down to Min (Top to Bottom rendering)
        for (int y = maxY; y >= minY; y--)
        {
            sb.Append("  "); // Margin
            for (int x = minX; x <= maxX; x++)
            {
                var room = rooms.FirstOrDefault(r => r.Position.X == x && r.Position.Y == y);
                sb.Append(GetRoomChar(room) + " "); // Space for aspect ratio
            }
            sb.AppendLine();
        }
    }

    private char GetRoomChar(Room? room)
    {
        if (room == null) return '.';
        if (_gameState.CurrentRoomId == room.Id) return '@';
        if (_gameState.UserNotes.ContainsKey(room.Id)) return '!';
        if (room.Features.Contains(RoomFeature.Settlement)) return '$';
        if (room.Features.Contains(RoomFeature.RunicAnchor)) return '*';
        return '#';
    }
}

4. Deliverable Checklist (v0.3.20b)
	•	Core/Persistence:
	◦	[ ] Add GetBatchAsync(IEnumerable<Guid> ids) to IRoomRepository (optimize fetching visited rooms).
	•	Engine:
	◦	[ ] Implement MapExportService.
	◦	[ ] Register MapExportService in DI.
	◦	[ ] Update CommandParser to handle map export command.
	•	Filesystem:
	◦	[ ] Ensure data/exports/ directory logic is robust.
	◦	[ ] Add data/exports/ to .gitignore.
	•	Testing:
	◦	[ ] Verify coordinate normalization handles negative coordinates correctly.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Map
Export Start
Info
"[Map] Starting atlas export for {Count} rooms."
Count
Map
Export Success
Info
"[Map] Exported to {Path}."
Path
Map
File Error
Error
"[Map] Failed to write export: {Error}"
Error

6. Testing Strategy
Unit Tests (MapExportTests.cs):
	•	Normalization_NegativeCoords:
	◦	Setup rooms at (-5, -5) and (-3, -3).
	◦	Act: Generate grid.
	◦	Assert: Grid width is 3 ((-3) - (-5) + 1). Relative indices 0 and 2 are populated.
	•	Z_Level_Separation:
	◦	Setup rooms at Z=0 and Z=1.
	◦	Act: Export.
	◦	Assert: Output string contains "[DEPTH Z: 1]" and "[DEPTH Z: 0]".
	•	Symbol_Priority:
	◦	Setup Room with Player AND Note.
	◦	Act: Get symbol.
	◦	Assert: Returns '@' (Player priority usually higher, or '!' if notes deemed more critical for archival. Current spec: Player > Note).
Integration Tests:
	•	File_Creation:
	◦	Run map export.
	◦	Verify file exists at expected path.
	◦	Verify file is not empty.

7. Draft Changelog (v0.3.20b)
# Changelog: v0.3.20b - The Atlas

**Release Date:** 2026-02-XX

## Summary
Phase two of "The Cartographer II" enables external map exporting. Players can now generate text-based maps of their entire exploration history, useful for keeping track of large dungeon layouts outside the game window.

## Changes
- **Commands:** Added `map export`. This generates a `.txt` file in the `data/exports/` directory.
- **Engine:** Added `MapExportService` which normalizes visited room coordinates into a readable 2D grid per Z-level.
- **Persistence:** Optimized room loading to support batch fetching of hundreds of visited rooms simultaneously.
Would you like to proceed to v0.3.20c: The Pathfinder (Fast Travel)?
