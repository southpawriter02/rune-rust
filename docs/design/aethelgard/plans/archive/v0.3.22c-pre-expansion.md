# v0.3.22c: The Forecast (Predictive UI)

**Status:** Planned
**Parent Plan:** [v0.3.22](./v0.3.22.md)
**Dependencies:** `v0.3.22a` (for ViewModel structure updates), `v0.3.22b` (uses Intel data)

## Overview
Tactical games thrive on informed decisions. Players shouldn't have to do mental math for hit chances or damage ranges. **v0.3.22c** introduces "Hover Intent" (simulated via TUI selection or command preview) to show the *probable* outcome of an action before it is committed.

## Goals
1.  **Predictive Calc:** `AttackResolutionService` needs "Dry Run" methods to calculate hit chance % and damage range without rolling.
2.  **ViewModel Update:** `CombatViewModel` needs a `Prediction` property.
3.  **UI Feedback:** Render a "Forecast Bar" showing: `Hit: 85% | Dmg: 4-10 (Physical)`.

---

## 1. Architecture & Data Flow

### The Prediction Loop
*   *Note on TUI limitations:* Since we might not have mouse hover, this might work via:
    -   Typing partial commands: `attack gob` -> UI updates forecast? (Complex)
    -   Or, selecting an ability in a menu (if we have a menu-based input mode).
    -   *Simplification:* For CLI, maybe it's `predict attack goblin`? Or just auto-show "Best Attack Option" stats?
    -   *Refined Design:* When the user is *prompted* for a target (e.g., after selecting Ability 1), show the forecast for the *current selection* (if using arrow keys) or require a `check` command.
    -   *Decision:* Let's support a `check <target>` or `forecast <ability> <target>` command, and also auto-display stats for the *last targeted enemy* if the input buffer is empty.

### Logic
1.  **Calculation:**
    -   `HitChance = (AttackerAccuracy - DefenderEvasion) + BaseChance`.
    -   `MinDmg = (BaseMin + Modifiers) * (1 - Mitigation)`.
    -   `MaxDmg = (BaseMax + Modifiers) * (1 - Mitigation)`.
2.  **Integration:** `AttackResolutionService` exposes `GetAttackForecast(attacker, defender, ability)`.

---

## 2. Implementation Steps

### Step 1: Engine Updates
*   **Update `AttackResolutionService`:**
    -   Add `CalculateHitChance(Combatant attacker, Combatant defender)`.
    -   Add `CalculateDamageRange(Combatant attacker, Combatant defender, AttackType/Ability ability)`.
    -   *Important:* Ensure this accounts for `KnowledgeTier` from v0.3.22b. If the enemy is "Unknown", the forecast should be wide or hidden (e.g., "Hit: ??? | Dmg: ???").

### Step 2: ViewModel Updates
*   **Update `CombatViewModel`:**
    -   Add `PredictionText` (string) or `PredictionData` (object).

### Step 3: Terminal Rendering
*   **Update `CombatScreenRenderer`:**
    -   Add a "Forecast" bar, perhaps above the input line or below the enemy list.
    -   Format: `[Attacking Rusted Draugr] Hit: [Green]85%[/] | Dmg: [Yellow]4-8[/] | Crit: [Red]5%[/]`

---

## 3. Detailed Changes

### A. `RuneAndRust.Engine/Services/AttackResolutionService.cs`
Extract the math from `ResolveAttack` into pure calculation methods that `ResolveAttack` also calls (to ensure consistency).
```csharp
public CombatForecast GetForecast(Combatant attacker, Combatant target, AttackType type) {
    // ... logic ...
}
```

### B. `RuneAndRust.Core/Models/Combat/CombatForecast.cs`
```csharp
public record CombatForecast(
    int HitChancePercent,
    int CritChancePercent,
    int MinDamage,
    int MaxDamage,
    DamageType Type
);
```

### C. `RuneAndRust.Terminal/Rendering/PredictionRenderer.cs`
Helper to draw the bar.

---

## 4. Verification & Testing

*   **Unit Tests:**
    -   `AttackResolutionServiceTests`: Verify `GetForecast` matches the logic of `ResolveAttack`.
    -   `Forecast_Respects_Defense`: Ensure defending enemies show lower hit chances.
*   **Manual Verification:**
    -   Use `check` command (or whatever trigger is decided) and verify numbers match the subsequent attack (within RNG bounds).

## 5. Pre-Commit Checks
-   [ ] Verify "Unknown" enemies don't reveal exact stats via forecast (exploit prevention).
