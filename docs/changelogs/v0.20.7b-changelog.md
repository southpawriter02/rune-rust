# v0.20.7b Changelog — Veiðimaðr (Hunter) Tier 2 Abilities

## Version: 0.20.7b

## Date: 2026-02-17

## Focus: Veiðimaðr (Hunter) Specialization — Tier 2 Abilities (Hunter's Eye, Trap Mastery, Predator's Patience)

---

## Added

### Domain Layer — Enums

- **`TrapType`** — 5 hunting trap variants: Spike (0), Net (1), PitFall (2), Deadfall (3), Snare (4)
- **`TrapStatus`** — 4 trap lifecycle states: Armed (0), Triggered (1), Disarmed (2), Destroyed (3)

### Domain Layer — Value Objects

- **`HuntersEyeResult`** — Immutable sealed record capturing the outcome of Hunter's Eye passive evaluation. Properties: HunterId, TargetId, TargetName, OriginalCoverType, CoverIgnored, BonusFromCoverIgnored, Distance. `private const PartialCoverPenalty = 2`. Static methods: `ShouldIgnoreCover(CoverType)` returns true for Partial only; `GetCoverPenalty(CoverType)` returns 2 for Partial, 0 otherwise. Instance methods: `WasCoverIgnored()`, `GetDescription()`.
- **`TrapInstance`** — Mutable sealed record tracking a single hunting trap through its lifecycle. Factory method `Create(Guid, int, int, TrapType)` with validation. Constants: `DefaultDetectionDc = 13`, `DefaultImmobilizeTurns = 1`, `DefaultDamageRoll = "1d8"`. Status/TriggeredAt/TriggeringTarget/TurnsPlaced have `private set`. Methods: `Trigger(Guid)` — Armed→Triggered, throws if not Armed; `Disarm()` — Armed→Disarmed, throws if not Armed; `Destroy()` — any→Destroyed; `IncrementTurn()` — TurnsPlaced++; `GetDescription()`, `GetDamageText()`.
- **`TrapMasteryResult`** — Immutable sealed record covering both placement and detection modes. Nested `ResultType` enum: TrapPlaced, TrapsDetected. Properties: Type, PlacedTrap (nullable), LocationX, LocationY, Success, DetectedTrapsCount, DetectedTrapDescriptions, Message, PerceptionRoll/Dc/Bonus (nullable, detection only). Static factories: `CreatePlacementSuccess()`, `CreatePlacementFailure()`, `CreateDetectionSuccess()`, `CreateDetectionFailure()`. Methods: `GetDescription()`, `WasSuccessful()`, `GetTrapCount()`.
- **`PredatorsPatienceState`** — Mutable sealed record tracking the Predator's Patience stance. Factory method `Create(Guid)` initializes inactive. `DefaultHitBonus = 3`. IsActive/HasMovedThisTurn/ActivatedAt/TurnsInStance have `private set`. Methods: `Activate()` — enables stance, resets movement; `Deactivate()` — disables stance; `RecordMovement()` — sets moved flag, calls Deactivate(); `ResetForNewTurn()` — resets movement, increments turns if active; `GetCurrentBonus()` — returns 3 if active && !moved, else 0; `GetDescription()`.

### Application Layer — Interface Changes

- **`IVeidimadurAbilityService`** — Extended with Tier 2 method signatures:
  - `HuntersEyeResult? ExecuteHuntersEye(Player, Guid, string, CoverType, int)` — Passive cover bypass evaluation
  - `TrapMasteryResult? ExecutePlaceTrap(Player, int, int, TrapType)` — Place hunting trap (2 AP)
  - `TrapMasteryResult? ExecuteDetectTraps(Player, int, int)` — Scan for enemy traps (2 AP)
  - `PredatorsPatienceState? ActivatePredatorsPatience(Player)` — Enter stance (1 AP)
  - `bool DeactivatePredatorsPatience(Player)` — Exit stance (0 AP)
  - `int GetPredatorsPatienceBonus(Player)` — Query current stance bonus
  - Updated class doc comment to reference Tier 2 abilities and v0.20.7b

### Application Layer — Service Changes

- **`VeidimadurAbilityService`** — Extended with Tier 2 implementation:
  - 8 new constants: `HuntersEyePartialCoverPenalty = 2`, `TrapMasteryPlaceApCost = 2`, `TrapMasteryDetectApCost = 2`, `TrapMasteryDetectionDc = 13`, `TrapMasteryDetectionBonus = 3`, `TrapMasteryMaxActiveTraps = 2`, `PredatorsPatienceApCost = 1`, `PredatorsPatienceHitBonus = 3`
  - `ExecuteHuntersEye`: Passive — no AP cost. Guard chain → evaluates cover via `HuntersEyeResult.ShouldIgnoreCover()` → builds result → logs with cover type and bonus info
  - `ExecutePlaceTrap`: 2 AP. Guard chain → validates max 2 armed traps → deducts AP → creates `TrapInstance.Create()` → `player.AddHuntingTrap()` → builds `TrapMasteryResult.CreatePlacementSuccess()` → logs trap details. Returns failure result (not null) when at max traps.
  - `ExecuteDetectTraps`: 2 AP. Guard chain → deducts AP → rolls 1d20 + TrapMasteryDetectionBonus(3) + KeenSensesBonus(0/1) vs DC 13 → builds success/failure result → logs roll details
  - `ActivatePredatorsPatience`: 1 AP. Guard chain → deducts AP → creates/activates stance → `player.SetPredatorsPatience()` → logs
  - `DeactivatePredatorsPatience`: No AP cost. Guard chain → validates stance is active → deactivates → logs turns held
  - `GetPredatorsPatienceBonus`: Returns `state.GetCurrentBonus()` or 0 if not active/unlocked
  - `internal virtual int Roll1D8()` — New dice method for trap damage (testable override)
  - `GetAbilityReadiness`: Updated switch with Tier 2 cases — HuntersEye (passive, always ready), TrapMastery (2 AP check), PredatorsPatience (1 AP check)

### Entity Extensions

- **`Player.cs`** — Veiðimaðr Tier 2 properties and methods:
  - `PredatorsPatienceState? PredatorsPatience` — Stance state tracker
  - `List<TrapInstance> _huntingTraps` — Private backing field for hunting traps
  - `IReadOnlyList<TrapInstance> HuntingTraps` — Read-only collection accessor
  - `SetPredatorsPatience(PredatorsPatienceState?)` — Direct state replacement
  - `InitializePredatorsPatience()` — Creates default inactive state
  - `AddHuntingTrap(TrapInstance)` — Adds trap with null check
  - `RemoveHuntingTrap(Guid)` — Removes by trap ID, returns bool
  - `GetArmedHuntingTraps()` — Filters to Status==Armed
  - `ClearAllHuntingTraps()` — Clears all traps

### Configuration

- Updated `config/abilities.json` with 3 Tier 2 abilities:
  - `hunters-eye`: Passive, 0 AP, 4 PP, ppPrerequisite 8, ignores Partial cover (+2 AC penalty negated)
  - `trap-mastery`: Active, 2 AP, 4 PP, ppPrerequisite 8, range 5 spaces, placement (max 2 traps, 1d8 piercing, 1-turn immobilize) + detection (bonus +3, DC 13)
  - `predators-patience`: Stance, 1 AP, 4 PP, ppPrerequisite 8, +3 to hit while stationary, breaks on movement

### Unit Tests

- **`HuntersEyeResultTests`** — 11 domain tests: ShouldIgnoreCover (Partial=true, Full=false, None=false), GetCoverPenalty (Partial=2, Full=0, None=0), GetDescription (cover ignored, full cover, no cover), WasCoverIgnored (true/false)
- **`TrapInstanceTests`** — 14 domain tests: Create (valid params, empty PlacedBy throws, all trap types), Trigger (armed→triggered, triggered throws, disarmed throws), Disarm (armed→disarmed, triggered throws), Destroy (armed, triggered, disarmed all→destroyed), IncrementTurn, GetDescription (armed text), GetDamageText
- **`TrapMasteryResultTests`** — 8 domain tests: CreatePlacementSuccess, CreatePlacementFailure, CreateDetectionSuccess, CreateDetectionFailure, GetDescription (placement success/failure, detection success/failure)
- **`PredatorsPatienceStateTests`** — 15 domain tests: Create (inactive), Activate (sets active, re-activate resets), Deactivate (sets inactive, already inactive), RecordMovement (active deactivates, inactive sets flag), GetCurrentBonus (active=3, after movement=0, inactive=0), ResetForNewTurn (active increments, inactive no increment, multiple turns), GetDescription (active/inactive)
- **`VeidimadurAbilityServiceTests`** — Extended with 24 new Tier 2 tests:
  - Hunter's Eye (6): partial cover ignores, full cover doesn't, no cover returns result, ability not unlocked, wrong spec, no AP cost
  - Trap Mastery Place (5): valid prereqs, at max traps failure, insufficient AP, ability not unlocked, multiple trap types
  - Trap Mastery Detect (4): high roll success, low roll failure, insufficient AP, without Keen Senses lower bonus
  - Predator's Patience (6): activate valid, activate insufficient AP, activate wrong spec, activate not unlocked, deactivate active, deactivate not active, deactivate wrong spec
  - Readiness/PP (3): readiness includes T2, readiness insufficient AP, PP invested returns 12, CanUnlockTier2 returns true

## Design Decisions

- **Passive Hunter's Eye**: The design spec proposed a duration-based Hunter's Eye (3 turns or until attack). The actual implementation follows the passive pattern established by Keen Senses — no duration, no AP cost, evaluated on each ranged attack. This is simpler and matches the existing CoverType enum (None/Partial/Full) rather than requiring new cover types.
- **2 AP for Trap Mastery** (both modes): The design spec suggested 3 AP for placement and 1 AP for detection. The implementation uses a consistent 2 AP for both modes, which is more balanced and follows the established AP cost pattern from prior specializations.
- **Detection bonus +3 (not +5)**: The design spec proposed +5 bonus. The implementation uses +3 base bonus + Keen Senses (+1 if unlocked) = +4 max, matching the Read the Signs pattern (base +4 + Keen Senses +1 = +5 max). This keeps detection DC 13 meaningful.
- **Separate HuntingTraps property**: Player already has `ActiveTraps` for Rúnasmiðr's RunicTrap. The Veiðimaðr uses a separate `HuntingTraps` list to avoid collisions, following the per-specialization naming convention.
- **Max trap check returns failure result (not null)**: When at max traps, `ExecutePlaceTrap` returns a `TrapMasteryResult` with `Success=false` rather than null. Null is reserved for prerequisite failures (wrong spec, ability not unlocked, insufficient AP). This allows the UI to show a descriptive failure message.
- **No async methods**: The design spec proposed async methods. The actual codebase uses synchronous methods throughout all specialization services (Berserkr, Bone-Setter, Veiðimaðr T1). We follow the established pattern.
- **Single service pattern**: The design spec proposed separate `ITrapMasteryService` and `IPredatorsPatienceService`. All abilities remain in `VeidimadurAbilityService`, matching every prior specialization's pattern.

## Test Results

```
Veiðimaðr tests: 115
     Passed: 115
     Failed: 0

Breakdown:
  HuntersEyeResultTests:               11 domain tests
  TrapInstanceTests:                    14 domain tests
  TrapMasteryResultTests:                8 domain tests
  PredatorsPatienceStateTests:          15 domain tests
  QuarryMarksResourceTests:             15 domain tests (v0.20.7a)
  VeidimadurAbilityServiceTests:        52 application tests (23 T1 + 29 T2)
                                   ──────
                                   Total: 115 (was 38 in v0.20.7a)
```
