# v0.15.2f Design Specification: Balance Checks

**Version:** 0.15.2f
**Theme:** Balance Checks
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Prerequisites:** v0.15.2a-e Complete (Climbing, Leaping, Fall Damage, Stealth Movement, Chase Sequences)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BalanceWidth Enum](#4-balancewidth-enum)
5. [SurfaceStability Enum](#5-surfacestability-enum)
6. [BalanceSurface Value Object](#6-balancesurface-value-object)
7. [BalanceContext Value Object](#7-balancecontext-value-object)
8. [BalanceCheckResult Value Object](#8-balancecheckresult-value-object)
9. [IBalanceService Interface](#9-ibalanceservice-interface)
10. [BalanceService Implementation](#10-balanceservice-implementation)
11. [Fall Integration](#11-fall-integration)
12. [Configuration](#12-configuration)
13. [Commands](#13-commands)
14. [User-Facing Changes](#14-user-facing-changes)
15. [Logging Specifications](#15-logging-specifications)
16. [Unit Testing Requirements](#16-unit-testing-requirements)
17. [Use Cases](#17-use-cases)
18. [Deliverable Checklist](#18-deliverable-checklist)
19. [Acceptance Criteria](#19-acceptance-criteria)
20. [Future Considerations](#20-future-considerations)
21. [Implementation Notes](#21-implementation-notes)
22. [Document Metadata](#22-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.2f, the Balance Checks phase. This phase introduces mechanics for traversing narrow or unstable surfaces where characters must maintain their balance. The key components are:

1. **BalanceWidth Enum**: Categorizes surface widths from wide (2+ feet) to razor-thin edges, each with corresponding DCs.

2. **SurfaceStability Enum**: Defines stability states (Stable, Unstable, Swaying) that modify balance difficulty.

3. **BalanceSurface Value Object**: Encapsulates all properties of a surface that affect balance checks, including width, stability, and length.

4. **BalanceService**: Orchestrates balance checks with width-based DCs, stability modifiers, and environmental factors.

This infrastructure enables tactical traversal challenges where players must weigh the risk of crossing dangerous surfaces against the time or resources to find safer routes.

### 1.2 Current vs. Target Implementation

| Aspect | Current Implementation | Target Implementation |
|--------|------------------------|----------------------|
| **Balance Checks** | Not implemented | Width-based DC system with modifiers |
| **Surface Width** | Not tracked | 4-tier classification (Wide/Narrow/Cable/Razor) |
| **Surface Stability** | Not tracked | Stable/Unstable/Swaying with DC modifiers |
| **Environmental Factors** | Not tracked | Wind, surface conditions, encumbrance |
| **Failure Consequences** | Not implemented | Fall from surface (height-dependent) |
| **Chase Integration** | Debris obstacles only | Balance obstacles with fall risk |

### 1.3 Scope

**In Scope:**
- Define `BalanceWidth` enum for surface width categories
- Define `SurfaceStability` enum for stability states
- Define `BalanceSurface` value object for surface properties
- Define `BalanceContext` value object for check modifiers
- Define `BalanceCheckResult` value object for outcomes
- Create `IBalanceService` interface for balance operations
- Implement `BalanceService` with width-based DC calculation
- Integration with fall damage system (v0.15.2c)
- Configuration file `balance-surfaces.json`
- Unit tests for balance mechanics (~2 tests)

**Out of Scope:**
- Specialization integration (Perfect Balance ability) - v0.15.2g
- Moving platforms / conveyor belts - future version
- Slippery surfaces (ice, oil) - future version
- Balance combat actions - future version

### 1.4 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 2 | `BalanceWidth`, `SurfaceStability` |
| Value Objects | 3 | `BalanceSurface`, `BalanceContext`, `BalanceCheckResult` |
| Interfaces | 1 | `IBalanceService` |
| Services | 1 | `BalanceService` |
| Configuration | 1 | `balance-surfaces.json` |
| Unit Tests | ~2 | Width sets DC, failure triggers fall |

---

## 2. Dependencies

### 2.1 Required from v0.15.0 (Dice Pool Refactor)

| Component | Location | Usage in v0.15.2f |
|-----------|----------|-------------------|
| `DiceRollResult` | `Domain/ValueObjects/DiceRollResult.cs` | Provides `NetSuccesses`, `IsFumble` for balance checks |
| `DiceConstants` | `Domain/Constants/DiceConstants.cs` | Success threshold (8), botch value (1) |
| `IDiceRollerService` | `Application/Interfaces/IDiceRollerService.cs` | Performs balance check dice rolls |

### 2.2 Required from v0.15.1a (Skill Context & Modifiers)

| Component | Location | Usage in v0.15.2f |
|-----------|----------|-------------------|
| `SkillContext` | `Domain/ValueObjects/SkillContext.cs` | Passed to balance checks with modifiers |
| `SkillContextBuilder` | `Application/Services/SkillContextBuilder.cs` | Builds context for balance attempts |
| `EnvironmentModifier` | `Domain/ValueObjects/EnvironmentModifier.cs` | Wind, conditions modifiers |

### 2.3 Required from v0.15.1b (Outcome Classification)

| Component | Location | Usage in v0.15.2f |
|-----------|----------|-------------------|
| `SkillOutcome` | `Domain/Enums/SkillOutcome.cs` | Balance result classification |
| `FumbleType` | `Domain/Enums/FumbleType.cs` | Balance fumble (uses `TheSlip`) |
| `FumbleConsequenceService` | `Application/Services/FumbleConsequenceService.cs` | Triggers fumble consequences |

### 2.4 Required from v0.15.2c (Fall Damage)

| Component | Location | Usage in v0.15.2f |
|-----------|----------|-------------------|
| `FallResult` | `Domain/ValueObjects/FallResult.cs` | Created when balance fails |
| `FallSource` | `Domain/Enums/FallSource.cs` | Extended with `Balance` source |
| `IFallDamageService` | `Application/Interfaces/IFallDamageService.cs` | Processes fall from failed balance |

### 2.5 Provides to Future Versions

| Version | Component | Usage |
|---------|-----------|-------|
| v0.15.2g | Specialization | `[Perfect Balance]` - Auto-succeed DC ≤ 4 |
| v0.15.2e | Chase Sequences | Debris obstacles use balance checks |
| v0.11.x | Combat System | Balance-based combat maneuvers |

---

## 3. Architecture Diagrams

### 3.1 Balance Check Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          BALANCE CHECK FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  BALANCE REQUEST                                                            │
│  Player: "balance" or "cross <surface>"                                     │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    BUILD BALANCE CONTEXT                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  BalanceSurface:                                                    │    │
│  │  ├── Width: Narrow (1 ft)                                           │    │
│  │  ├── Stability: Unstable                                            │    │
│  │  ├── Length: 20 ft                                                  │    │
│  │  └── HeightAboveGround: 30 ft                                       │    │
│  │                                                                      │    │
│  │  BalanceContext:                                                    │    │
│  │  ├── BaseDc: 3 (from Narrow width)                                  │    │
│  │  ├── StabilityModifier: +1 DC (Unstable)                            │    │
│  │  ├── WindModifier: +1 DC (Strong Wind)                              │    │
│  │  ├── EncumbranceModifier: 0 (Light Load)                            │    │
│  │  └── FinalDc: 5 successes                                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    PERFORM SKILL CHECK                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Dice Pool: 6d10 (Acrobatics 3 + Finesse 3)                         │    │
│  │  Roll: [8, 4, 10, 3, 9, 6] → 3 successes, 0 botches                 │    │
│  │  vs DC 5                                                            │    │
│  │                                                                      │    │
│  │  Net Successes: 3                                                   │    │
│  │  Margin: 3 - 5 = -2 (failure)                                       │    │
│  │                                                                      │    │
│  │  Outcome: Failure                                                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DETERMINE RESULT                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  SUCCESS OUTCOMES:                                                  │    │
│  │  ├── Critical (5+ over) → Cross with grace, no stamina cost         │    │
│  │  ├── Success (≥ DC)     → Cross safely                              │    │
│  │  └── Marginal (= DC)    → Cross slowly, double stamina              │    │
│  │                                                                      │    │
│  │  FAILURE OUTCOMES:                                                  │    │
│  │  ├── Failure (< DC)     → Fall from surface                         │    │
│  │  └── Fumble (0 + botch) → Fall + disorientation status              │    │
│  │                                                                      │    │
│  │  Result: Failure - Character falls from 30 ft height                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    PROCESS FALL                                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  FallResult:                                                        │    │
│  │  ├── Source: Balance                                                │    │
│  │  ├── HeightFeet: 30                                                 │    │
│  │  ├── AllowCrashLanding: true                                        │    │
│  │  └── BonusDamage: 0                                                 │    │
│  │                                                                      │    │
│  │  → Delegates to IFallDamageService.ProcessFall()                    │    │
│  │  → Crash Landing DC: 5 (2 + 30/10)                                  │    │
│  │  → Damage: 3d10 Bludgeoning                                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  OUTPUT: BalanceCheckResult.Crossed = false                                 │
│          Character has fallen and taken damage                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Width-Based DC Mapping

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        WIDTH-BASED DC MAPPING                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SURFACE WIDTH CATEGORIES (Success-Counting DCs):                           │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  WIDE (2+ feet)                                    DC: 2 successes  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Examples:                                                          │    │
│  │  ├── Wide planks across a gap                                       │    │
│  │  ├── Thick stone ledges                                             │    │
│  │  ├── Fallen tree trunks                                             │    │
│  │  └── Structural beams in warehouses                                 │    │
│  │                                                                      │    │
│  │  Difficulty: Easy - most characters can manage                      │    │
│  │  Typical Pool: 4d10 (Untrained) → ~50% success                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  NARROW (1 foot)                                   DC: 3 successes  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Examples:                                                          │    │
│  │  ├── Standard building ledges                                       │    │
│  │  ├── Thin walls between rooms                                       │    │
│  │  ├── Narrow rafters                                                 │    │
│  │  └── Bridge railings                                                │    │
│  │                                                                      │    │
│  │  Difficulty: Moderate - requires some skill                         │    │
│  │  Typical Pool: 5d10 (Trained) → ~50% success                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CABLE/PIPE (6 inches)                             DC: 4 successes  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Examples:                                                          │    │
│  │  ├── Power cables between buildings                                 │    │
│  │  ├── Water pipes along walls                                        │    │
│  │  ├── Tightropes                                                     │    │
│  │  └── Thin chains                                                    │    │
│  │                                                                      │    │
│  │  Difficulty: Hard - requires trained acrobatics                     │    │
│  │  Typical Pool: 6d10 (Expert) → ~50% success                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  RAZOR EDGE (< 6 inches)                           DC: 5 successes  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Examples:                                                          │    │
│  │  ├── Knife-thin structural edges                                    │    │
│  │  ├── Decorative blade motifs (Dvergr architecture)                  │    │
│  │  ├── Wire cables                                                    │    │
│  │  └── Barely-there ledges                                            │    │
│  │                                                                      │    │
│  │  Difficulty: Very Hard - master-level challenge                     │    │
│  │  Typical Pool: 7d10 (Master) → ~50% success                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  NOTE: Original sum-based DCs (8, 12, 16, 20) have been converted to       │
│        success-counting DCs (2, 3, 4, 5) per v0.15.0 dice refactor.        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Stability and Environmental Modifiers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STABILITY & ENVIRONMENTAL MODIFIERS                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SURFACE STABILITY (DC Modifiers):                                          │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  STABLE                                              +0 DC          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  The surface is fixed, solid, and predictable.                      │    │
│  │  Examples: Stone ledges, metal beams, sturdy planks                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  UNSTABLE                                            +1 DC          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  The surface shifts or wobbles under weight.                        │    │
│  │  Examples: Loose boards, crumbling ledges, debris piles             │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  SWAYING                                             +2 DC          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  The surface moves continuously in a rhythm.                        │    │
│  │  Examples: Rope bridges, hanging cables, suspended platforms        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ENVIRONMENTAL CONDITIONS (DC Modifiers):                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  WIND CONDITIONS                                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  None/Light           │  +0 DC                                      │    │
│  │  Moderate Wind        │  +0 DC (no effect)                          │    │
│  │  Strong Wind          │  +1 DC                                      │    │
│  │  Severe/Storm         │  +2 DC                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  SURFACE CONDITIONS                                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Dry                  │  +0 DC                                      │    │
│  │  Wet                  │  +1 DC                                      │    │
│  │  Icy                  │  +2 DC (future: slippery surfaces)          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ENCUMBRANCE                                                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  Light Load           │  +0 DC                                      │    │
│  │  Medium Load          │  +1 DC                                      │    │
│  │  Heavy Load           │  +2 DC                                      │    │
│  │  Over-encumbered      │  Cannot attempt balance                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  EXAMPLE CALCULATION:                                                       │
│  • Narrow ledge (DC 3) + Swaying (+2) + Strong Wind (+1) = DC 6             │
│  • Cable (DC 4) + Stable (+0) + Dry (+0) + Light Load (+0) = DC 4           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      BALANCE SYSTEM LAYER ARCHITECTURE                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                             │    │
│  │  ├── BalanceWidth.cs                   ←── NEW                      │    │
│  │  ├── SurfaceStability.cs               ←── NEW                      │    │
│  │  └── FallSource.cs                     ←── MODIFIED (add Balance)   │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                      │    │
│  │  ├── BalanceSurface.cs                 ←── NEW                      │    │
│  │  ├── BalanceContext.cs                 ←── NEW                      │    │
│  │  └── BalanceCheckResult.cs             ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    APPLICATION LAYER                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Interfaces/                                                        │    │
│  │  └── IBalanceService.cs                ←── NEW                      │    │
│  │                                                                      │    │
│  │  Services/                                                          │    │
│  │  └── BalanceService.cs                 ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  INFRASTRUCTURE LAYER                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                     │    │
│  │  ├── balance-surfaces.json             ←── NEW                      │    │
│  │  └── balance-surfaces.schema.json      ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EXTERNAL DEPENDENCIES:                                                     │
│  ├── IDiceRollerService        (from v0.15.0)                              │
│  ├── SkillContext              (from v0.15.1a)                             │
│  ├── IFallDamageService        (from v0.15.2c)                             │
│  └── FallResult                (from v0.15.2c)                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. BalanceWidth Enum

### 4.1 Definition

```csharp
namespace Rune.Domain.Enums;

/// <summary>
/// Categorizes the width of a surface for balance check DC calculation.
/// </summary>
/// <remarks>
/// Width is the primary factor determining balance difficulty. Narrower surfaces
/// require more precise footwork and are exponentially harder to traverse.
/// The DC values use the success-counting system from v0.15.0.
/// </remarks>
public enum BalanceWidth
{
    /// <summary>
    /// Wide surface (2+ feet). Relatively easy to traverse.
    /// </summary>
    /// <remarks>
    /// DC: 2 successes required.
    /// Examples: Wide planks, thick ledges, fallen tree trunks.
    /// Most characters can manage these surfaces with basic training.
    /// </remarks>
    Wide = 0,

    /// <summary>
    /// Narrow surface (approximately 1 foot). Requires concentration.
    /// </summary>
    /// <remarks>
    /// DC: 3 successes required.
    /// Examples: Standard ledges, thin walls, narrow rafters.
    /// Requires trained acrobatics for reliable success.
    /// </remarks>
    Narrow = 1,

    /// <summary>
    /// Cable or pipe width (approximately 6 inches). Challenging traverse.
    /// </summary>
    /// <remarks>
    /// DC: 4 successes required.
    /// Examples: Power cables, water pipes, tightropes, thin chains.
    /// Requires expert-level acrobatics for consistent success.
    /// </remarks>
    Cable = 2,

    /// <summary>
    /// Razor-thin edge (less than 6 inches). Extreme difficulty.
    /// </summary>
    /// <remarks>
    /// DC: 5 successes required.
    /// Examples: Knife edges, wire cables, barely-there ledges.
    /// Master-level challenge, high risk of failure.
    /// </remarks>
    RazorEdge = 3
}
```

### 4.2 DC Mapping

| Width | Approximate Size | Base DC | Original DC (Sum-Based) |
|-------|------------------|---------|-------------------------|
| `Wide` | 2+ feet | 2 successes | DC 8 |
| `Narrow` | ~1 foot | 3 successes | DC 12 |
| `Cable` | ~6 inches | 4 successes | DC 16 |
| `RazorEdge` | < 6 inches | 5 successes | DC 20 |

---

## 5. SurfaceStability Enum

### 5.1 Definition

```csharp
namespace Rune.Domain.Enums;

/// <summary>
/// Describes the stability of a surface being balanced upon.
/// </summary>
/// <remarks>
/// Stability modifies the base DC from width. An unstable or swaying surface
/// adds additional difficulty as the character must compensate for movement
/// while maintaining their own balance.
/// </remarks>
public enum SurfaceStability
{
    /// <summary>
    /// The surface is fixed and solid. No DC modifier.
    /// </summary>
    /// <remarks>
    /// DC Modifier: +0.
    /// Examples: Stone ledges, metal beams, sturdy wooden planks.
    /// The surface does not move or shift under the character's weight.
    /// </remarks>
    Stable = 0,

    /// <summary>
    /// The surface shifts or wobbles under weight. Moderate DC increase.
    /// </summary>
    /// <remarks>
    /// DC Modifier: +1.
    /// Examples: Loose boards, crumbling ledges, stacked debris.
    /// The surface moves unexpectedly when weight is applied.
    /// </remarks>
    Unstable = 1,

    /// <summary>
    /// The surface moves continuously. Significant DC increase.
    /// </summary>
    /// <remarks>
    /// DC Modifier: +2.
    /// Examples: Rope bridges, hanging cables, suspended platforms.
    /// The character must time their movements with the surface's rhythm.
    /// </remarks>
    Swaying = 2
}
```

### 5.2 Modifier Table

| Stability | DC Modifier | Description |
|-----------|-------------|-------------|
| `Stable` | +0 | Fixed, predictable surface |
| `Unstable` | +1 | Shifts under weight |
| `Swaying` | +2 | Continuous rhythmic movement |

---

## 6. BalanceSurface Value Object

### 6.1 Definition

```csharp
namespace Rune.Domain.ValueObjects;

using Rune.Domain.Enums;

/// <summary>
/// Represents a surface that requires balance checks to traverse.
/// </summary>
/// <remarks>
/// BalanceSurface encapsulates all physical properties of a surface that
/// affect balance difficulty. It is used to calculate the DC for balance
/// checks and to determine fall consequences on failure.
/// </remarks>
/// <param name="Width">The width category of the surface.</param>
/// <param name="Stability">The stability state of the surface.</param>
/// <param name="LengthFeet">The length of the surface to traverse.</param>
/// <param name="HeightAboveGround">The fall height if balance is lost.</param>
/// <param name="SurfaceCondition">Surface condition (dry, wet, etc.).</param>
/// <param name="Description">Optional descriptive text for the surface.</param>
public readonly record struct BalanceSurface(
    BalanceWidth Width,
    SurfaceStability Stability,
    int LengthFeet,
    int HeightAboveGround,
    SurfaceCondition SurfaceCondition = SurfaceCondition.Dry,
    string? Description = null)
{
    /// <summary>
    /// Gets the base DC from the width category.
    /// </summary>
    public int BaseDc => Width switch
    {
        BalanceWidth.Wide => 2,
        BalanceWidth.Narrow => 3,
        BalanceWidth.Cable => 4,
        BalanceWidth.RazorEdge => 5,
        _ => 3
    };

    /// <summary>
    /// Gets the DC modifier from stability.
    /// </summary>
    public int StabilityModifier => Stability switch
    {
        SurfaceStability.Stable => 0,
        SurfaceStability.Unstable => 1,
        SurfaceStability.Swaying => 2,
        _ => 0
    };

    /// <summary>
    /// Gets the DC modifier from surface condition.
    /// </summary>
    public int ConditionModifier => SurfaceCondition switch
    {
        SurfaceCondition.Dry => 0,
        SurfaceCondition.Wet => 1,
        SurfaceCondition.Icy => 2,
        _ => 0
    };

    /// <summary>
    /// Gets the total DC from surface properties alone (before environmental modifiers).
    /// </summary>
    public int SurfaceDc => BaseDc + StabilityModifier + ConditionModifier;

    /// <summary>
    /// Indicates whether falling from this surface would cause damage.
    /// </summary>
    public bool FallCausesDamage => HeightAboveGround >= 10;

    /// <summary>
    /// Gets a descriptive name for the surface width.
    /// </summary>
    public string WidthDescription => Width switch
    {
        BalanceWidth.Wide => "wide (2+ ft)",
        BalanceWidth.Narrow => "narrow (1 ft)",
        BalanceWidth.Cable => "cable-thin (6 in)",
        BalanceWidth.RazorEdge => "razor-thin (< 6 in)",
        _ => "unknown"
    };

    /// <summary>
    /// Creates a display string for the surface.
    /// </summary>
    /// <returns>Formatted surface description for UI display.</returns>
    public string ToDisplayString()
    {
        var stability = Stability != SurfaceStability.Stable
            ? $", {Stability.ToString().ToLowerInvariant()}"
            : "";

        var condition = SurfaceCondition != SurfaceCondition.Dry
            ? $", {SurfaceCondition.ToString().ToLowerInvariant()}"
            : "";

        return $"{WidthDescription} surface ({LengthFeet} ft long, {HeightAboveGround} ft up{stability}{condition})";
    }

    /// <summary>
    /// Creates a standard narrow ledge surface.
    /// </summary>
    public static BalanceSurface NarrowLedge(int lengthFeet, int heightFeet) =>
        new(BalanceWidth.Narrow, SurfaceStability.Stable, lengthFeet, heightFeet);

    /// <summary>
    /// Creates a rope bridge surface (narrow, swaying).
    /// </summary>
    public static BalanceSurface RopeBridge(int lengthFeet, int heightFeet) =>
        new(BalanceWidth.Narrow, SurfaceStability.Swaying, lengthFeet, heightFeet,
            Description: "A rope bridge sways gently in the wind.");

    /// <summary>
    /// Creates a cable or pipe surface.
    /// </summary>
    public static BalanceSurface Cable(int lengthFeet, int heightFeet) =>
        new(BalanceWidth.Cable, SurfaceStability.Stable, lengthFeet, heightFeet);

    /// <summary>
    /// Creates a crumbling ledge (narrow, unstable).
    /// </summary>
    public static BalanceSurface CrumblingLedge(int lengthFeet, int heightFeet) =>
        new(BalanceWidth.Narrow, SurfaceStability.Unstable, lengthFeet, heightFeet,
            Description: "Fragments of stone crumble away beneath your feet.");
}
```

### 6.2 SurfaceCondition Enum

```csharp
namespace Rune.Domain.Enums;

/// <summary>
/// Describes the surface condition affecting traction.
/// </summary>
/// <remarks>
/// Surface conditions modify balance DC by affecting how well
/// a character can maintain grip and footing.
/// </remarks>
public enum SurfaceCondition
{
    /// <summary>
    /// Normal dry surface. No DC modifier.
    /// </summary>
    Dry = 0,

    /// <summary>
    /// Wet surface (rain, water). DC +1.
    /// </summary>
    Wet = 1,

    /// <summary>
    /// Icy or frozen surface. DC +2.
    /// </summary>
    /// <remarks>
    /// Note: Full slippery surface mechanics are deferred to a future version.
    /// This provides basic support for icy conditions.
    /// </remarks>
    Icy = 2
}
```

---

## 7. BalanceContext Value Object

### 7.1 Definition

```csharp
namespace Rune.Domain.ValueObjects;

using Rune.Domain.Enums;

/// <summary>
/// Captures all contextual factors affecting a balance check.
/// </summary>
/// <remarks>
/// BalanceContext combines the surface properties with environmental and
/// character-specific modifiers to calculate the final DC. It also tracks
/// whether this is part of a longer traverse requiring multiple checks.
/// </remarks>
/// <param name="Surface">The surface being balanced upon.</param>
/// <param name="WindModifier">DC modifier from wind conditions (+0 to +2).</param>
/// <param name="EncumbranceModifier">DC modifier from character load (+0 to +2).</param>
/// <param name="HasBalancePole">Whether character has a balance pole (-1 DC).</param>
/// <param name="IsLongTraverse">Whether this requires multiple checks.</param>
/// <param name="CheckNumber">Current check number if IsLongTraverse (1-based).</param>
/// <param name="TotalChecksRequired">Total checks needed if IsLongTraverse.</param>
public readonly record struct BalanceContext(
    BalanceSurface Surface,
    int WindModifier = 0,
    int EncumbranceModifier = 0,
    bool HasBalancePole = false,
    bool IsLongTraverse = false,
    int CheckNumber = 1,
    int TotalChecksRequired = 1)
{
    /// <summary>
    /// Gets the total DC for the balance check.
    /// </summary>
    public int FinalDc
    {
        get
        {
            var dc = Surface.SurfaceDc + WindModifier + EncumbranceModifier;

            // Balance pole reduces DC by 1
            if (HasBalancePole)
                dc -= 1;

            // Minimum DC is 1
            return Math.Max(1, dc);
        }
    }

    /// <summary>
    /// Gets the fall height if balance is lost.
    /// </summary>
    public int FallHeight => Surface.HeightAboveGround;

    /// <summary>
    /// Indicates whether falling would cause damage.
    /// </summary>
    public bool FallIsDangerous => Surface.FallCausesDamage;

    /// <summary>
    /// Calculates progress percentage for long traverses.
    /// </summary>
    public double TraverseProgress => IsLongTraverse
        ? (double)(CheckNumber - 1) / TotalChecksRequired * 100
        : 0;

    /// <summary>
    /// Creates a display string for the balance context.
    /// </summary>
    public string ToDisplayString()
    {
        var modifiers = new List<string>();

        if (Surface.StabilityModifier > 0)
            modifiers.Add($"{Surface.Stability} (+{Surface.StabilityModifier} DC)");

        if (Surface.ConditionModifier > 0)
            modifiers.Add($"{Surface.SurfaceCondition} (+{Surface.ConditionModifier} DC)");

        if (WindModifier > 0)
            modifiers.Add($"Wind (+{WindModifier} DC)");

        if (EncumbranceModifier > 0)
            modifiers.Add($"Encumbered (+{EncumbranceModifier} DC)");

        if (HasBalancePole)
            modifiers.Add("Balance Pole (-1 DC)");

        var modString = modifiers.Count > 0
            ? $"\nModifiers: {string.Join(", ", modifiers)}"
            : "";

        var traverseInfo = IsLongTraverse
            ? $"\nProgress: Check {CheckNumber} of {TotalChecksRequired}"
            : "";

        return $"DC {FinalDc} ({Surface.WidthDescription}){modString}{traverseInfo}";
    }
}
```

---

## 8. BalanceCheckResult Value Object

### 8.1 Definition

```csharp
namespace Rune.Domain.ValueObjects;

using Rune.Domain.Enums;

/// <summary>
/// Represents the complete outcome of a balance check attempt.
/// </summary>
/// <remarks>
/// Contains all information needed to narrate the result and process
/// any consequences (such as falling and taking damage).
/// </remarks>
/// <param name="Context">The context used for the check.</param>
/// <param name="DiceRoll">The dice roll result.</param>
/// <param name="Outcome">The skill outcome classification.</param>
/// <param name="Crossed">Whether the character successfully crossed.</param>
/// <param name="FallTriggered">Whether a fall occurred.</param>
/// <param name="FallResult">The fall result if FallTriggered is true.</param>
/// <param name="StaminaCost">Movement stamina cost (doubled on marginal success).</param>
/// <param name="NarrativeDescription">Descriptive text for the outcome.</param>
public readonly record struct BalanceCheckResult(
    BalanceContext Context,
    DiceRollResult DiceRoll,
    SkillOutcome Outcome,
    bool Crossed,
    bool FallTriggered,
    FallResult? FallResult,
    int StaminaCost,
    string NarrativeDescription)
{
    /// <summary>
    /// Gets the margin of success or failure.
    /// </summary>
    public int Margin => DiceRoll.NetSuccesses - Context.FinalDc;

    /// <summary>
    /// Indicates whether this was a critical success.
    /// </summary>
    public bool IsCritical => Outcome == SkillOutcome.CriticalSuccess;

    /// <summary>
    /// Indicates whether this was a fumble.
    /// </summary>
    public bool IsFumble => Outcome == SkillOutcome.CriticalFailure;

    /// <summary>
    /// Indicates whether the traverse continues (for long traverses).
    /// </summary>
    public bool TraverseContinues => Crossed && Context.IsLongTraverse &&
        Context.CheckNumber < Context.TotalChecksRequired;

    /// <summary>
    /// Creates a successful balance result.
    /// </summary>
    public static BalanceCheckResult Success(
        BalanceContext context,
        DiceRollResult roll,
        SkillOutcome outcome,
        int staminaCost)
    {
        var narrative = outcome switch
        {
            SkillOutcome.CriticalSuccess =>
                "You cross with perfect grace, barely seeming to touch the surface.",
            SkillOutcome.ExceptionalSuccess =>
                "You traverse the surface with confident, measured steps.",
            SkillOutcome.FullSuccess =>
                "You carefully make your way across the surface.",
            SkillOutcome.MarginalSuccess =>
                "You wobble precariously but manage to keep your balance.",
            _ => "You cross the surface."
        };

        return new BalanceCheckResult(
            context,
            roll,
            outcome,
            Crossed: true,
            FallTriggered: false,
            FallResult: null,
            staminaCost,
            narrative);
    }

    /// <summary>
    /// Creates a failed balance result with fall.
    /// </summary>
    public static BalanceCheckResult Failure(
        BalanceContext context,
        DiceRollResult roll,
        SkillOutcome outcome,
        FallResult fallResult)
    {
        var narrative = outcome switch
        {
            SkillOutcome.CriticalFailure =>
                "Your foot slips catastrophically and you tumble into the void!",
            _ => "You lose your balance and fall from the surface."
        };

        return new BalanceCheckResult(
            context,
            roll,
            outcome,
            Crossed: false,
            FallTriggered: true,
            fallResult,
            StaminaCost: 0,
            narrative);
    }
}
```

---

## 9. IBalanceService Interface

### 9.1 Definition

```csharp
namespace Rune.Application.Interfaces;

using Rune.Domain.Enums;
using Rune.Domain.ValueObjects;

/// <summary>
/// Defines operations for balance check mechanics.
/// </summary>
/// <remarks>
/// The balance service handles traversal of narrow or unstable surfaces,
/// calculating DCs based on width and stability, processing skill checks,
/// and coordinating with the fall damage system on failures.
/// </remarks>
public interface IBalanceService
{
    /// <summary>
    /// Attempts to cross a balanced surface.
    /// </summary>
    /// <param name="characterId">The character attempting the balance.</param>
    /// <param name="surface">The surface to cross.</param>
    /// <param name="skillContext">Optional additional skill modifiers.</param>
    /// <returns>The result of the balance attempt.</returns>
    BalanceCheckResult AttemptBalance(
        string characterId,
        BalanceSurface surface,
        SkillContext? skillContext = null);

    /// <summary>
    /// Creates a balance context with all modifiers calculated.
    /// </summary>
    /// <param name="characterId">The character who would balance.</param>
    /// <param name="surface">The surface to analyze.</param>
    /// <returns>Complete balance context with DC calculation.</returns>
    BalanceContext CreateContext(
        string characterId,
        BalanceSurface surface);

    /// <summary>
    /// Calculates the DC for a balance check given the surface and conditions.
    /// </summary>
    /// <param name="surface">The surface being balanced upon.</param>
    /// <param name="windModifier">Wind condition modifier.</param>
    /// <param name="encumbranceModifier">Character encumbrance modifier.</param>
    /// <returns>The total DC in successes required.</returns>
    int CalculateDc(
        BalanceSurface surface,
        int windModifier = 0,
        int encumbranceModifier = 0);

    /// <summary>
    /// Determines if a surface requires balance checks based on width.
    /// </summary>
    /// <param name="widthInches">The surface width in inches.</param>
    /// <returns>True if balance check is required.</returns>
    bool RequiresBalanceCheck(int widthInches);

    /// <summary>
    /// Converts a width in inches to the appropriate BalanceWidth category.
    /// </summary>
    /// <param name="widthInches">The surface width in inches.</param>
    /// <returns>The corresponding balance width category.</returns>
    BalanceWidth GetWidthCategory(int widthInches);
}
```

---

## 10. BalanceService Implementation

### 10.1 Definition

```csharp
namespace Rune.Application.Services;

using Microsoft.Extensions.Logging;
using Rune.Application.Interfaces;
using Rune.Domain.Enums;
using Rune.Domain.ValueObjects;

/// <summary>
/// Implements balance check mechanics for traversing narrow surfaces.
/// </summary>
/// <remarks>
/// BalanceService coordinates width-based DC calculation, skill check
/// resolution, and fall damage processing for balance failures.
/// </remarks>
public class BalanceService : IBalanceService
{
    private readonly IDiceRollerService _diceRoller;
    private readonly ICharacterService _characterService;
    private readonly IFallDamageService _fallDamageService;
    private readonly IEnvironmentService _environmentService;
    private readonly ILogger<BalanceService> _logger;

    /// <summary>
    /// Width threshold (in inches) below which balance checks are required.
    /// Surfaces 24+ inches wide don't require checks.
    /// </summary>
    private const int BalanceRequiredThresholdInches = 24;

    /// <summary>
    /// Initializes a new instance of BalanceService.
    /// </summary>
    public BalanceService(
        IDiceRollerService diceRoller,
        ICharacterService characterService,
        IFallDamageService fallDamageService,
        IEnvironmentService environmentService,
        ILogger<BalanceService> logger)
    {
        _diceRoller = diceRoller ?? throw new ArgumentNullException(nameof(diceRoller));
        _characterService = characterService ?? throw new ArgumentNullException(nameof(characterService));
        _fallDamageService = fallDamageService ?? throw new ArgumentNullException(nameof(fallDamageService));
        _environmentService = environmentService ?? throw new ArgumentNullException(nameof(environmentService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public BalanceCheckResult AttemptBalance(
        string characterId,
        BalanceSurface surface,
        SkillContext? skillContext = null)
    {
        var context = CreateContext(characterId, surface);
        var character = _characterService.GetCharacter(characterId);

        // Build dice pool
        var acrobaticsRank = character.GetSkillRank("Acrobatics");
        var finesseAttribute = character.GetAttribute("Finesse");
        var poolSize = acrobaticsRank + finesseAttribute;

        // Apply skill context modifiers if provided
        if (skillContext?.PoolModifier != null)
            poolSize += skillContext.PoolModifier.Value;

        // Roll the check
        var roll = _diceRoller.RollPool(poolSize);
        var margin = roll.NetSuccesses - context.FinalDc;
        var outcome = ClassifyOutcome(margin, roll);

        _logger.LogDebug(
            "Balance check: {CharacterId} on {Width} surface, DC {Dc}, rolled {Successes} ({Outcome})",
            characterId, surface.Width, context.FinalDc, roll.NetSuccesses, outcome);

        // Determine result
        if (outcome >= SkillOutcome.MarginalSuccess)
        {
            var staminaCost = CalculateStaminaCost(surface, outcome);
            return BalanceCheckResult.Success(context, roll, outcome, staminaCost);
        }

        // Failed - create fall result
        var fallResult = FallResult.FromHeight(
            surface.HeightAboveGround,
            FallSource.Balance,
            allowCrashLanding: true,
            bonusDamage: outcome == SkillOutcome.CriticalFailure ? 1 : 0);

        _logger.LogInformation(
            "Balance failed: {CharacterId} falls {Height} ft from {Width} surface",
            characterId, surface.HeightAboveGround, surface.Width);

        return BalanceCheckResult.Failure(context, roll, outcome, fallResult);
    }

    /// <inheritdoc />
    public BalanceContext CreateContext(string characterId, BalanceSurface surface)
    {
        var character = _characterService.GetCharacter(characterId);
        var environment = _environmentService.GetCurrentEnvironment();

        // Calculate wind modifier
        var windModifier = environment.WindCondition switch
        {
            WindCondition.Strong => 1,
            WindCondition.Severe => 2,
            _ => 0
        };

        // Calculate encumbrance modifier
        var encumbranceModifier = character.EncumbranceLevel switch
        {
            EncumbranceLevel.Medium => 1,
            EncumbranceLevel.Heavy => 2,
            EncumbranceLevel.Overloaded => throw new InvalidOperationException(
                "Cannot attempt balance while over-encumbered."),
            _ => 0
        };

        // Check for balance pole equipment
        var hasBalancePole = character.HasEquipped("balance_pole") ||
                             character.HasEquipped("quarterstaff"); // Can serve as balance aid

        return new BalanceContext(
            surface,
            windModifier,
            encumbranceModifier,
            hasBalancePole);
    }

    /// <inheritdoc />
    public int CalculateDc(
        BalanceSurface surface,
        int windModifier = 0,
        int encumbranceModifier = 0)
    {
        var baseDc = surface.SurfaceDc;
        var finalDc = baseDc + windModifier + encumbranceModifier;
        return Math.Max(1, finalDc);
    }

    /// <inheritdoc />
    public bool RequiresBalanceCheck(int widthInches)
    {
        return widthInches < BalanceRequiredThresholdInches;
    }

    /// <inheritdoc />
    public BalanceWidth GetWidthCategory(int widthInches)
    {
        return widthInches switch
        {
            >= 24 => BalanceWidth.Wide,    // 2+ feet = wide
            >= 12 => BalanceWidth.Wide,    // 1-2 feet = still wide
            >= 6 => BalanceWidth.Narrow,   // 6-12 inches = narrow
            >= 3 => BalanceWidth.Cable,    // 3-6 inches = cable
            _ => BalanceWidth.RazorEdge    // < 3 inches = razor
        };
    }

    /// <summary>
    /// Classifies the skill outcome based on margin and roll.
    /// </summary>
    private SkillOutcome ClassifyOutcome(int margin, DiceRollResult roll)
    {
        // Fumble check first (0 successes + at least 1 botch)
        if (roll.NetSuccesses == 0 && roll.Botches > 0)
            return SkillOutcome.CriticalFailure;

        // Critical success (margin >= 5)
        if (margin >= 5)
            return SkillOutcome.CriticalSuccess;

        // Exceptional success (margin 3-4)
        if (margin >= 3)
            return SkillOutcome.ExceptionalSuccess;

        // Full success (margin 1-2)
        if (margin >= 1)
            return SkillOutcome.FullSuccess;

        // Marginal success (margin = 0)
        if (margin == 0)
            return SkillOutcome.MarginalSuccess;

        // Failure
        return SkillOutcome.Failure;
    }

    /// <summary>
    /// Calculates stamina cost based on surface and outcome.
    /// </summary>
    private int CalculateStaminaCost(BalanceSurface surface, SkillOutcome outcome)
    {
        // Base cost is 1 per 10 feet of length
        var baseCost = Math.Max(1, surface.LengthFeet / 10);

        return outcome switch
        {
            // Critical = no stamina cost
            SkillOutcome.CriticalSuccess => 0,
            // Marginal = double stamina cost
            SkillOutcome.MarginalSuccess => baseCost * 2,
            // Normal success = base cost
            _ => baseCost
        };
    }
}
```

---

## 11. Fall Integration

### 11.1 FallSource Enum Modification

```csharp
// In Domain/Enums/FallSource.cs - ADD new value:

/// <summary>
/// Fell from a balance surface (ledge, beam, rope, etc.).
/// </summary>
/// <remarks>
/// Triggered when a balance check fails. Always allows crash landing
/// attempts unless the surface was at ground level.
/// </remarks>
Balance = 2,
```

### 11.2 Fall Processing Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     BALANCE FAILURE → FALL PROCESSING                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  BALANCE CHECK FAILS                                                        │
│  BalanceService.AttemptBalance() returns failure                            │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    CREATE FALL RESULT                               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  FallResult.FromHeight(                                             │    │
│  │      heightFeet: surface.HeightAboveGround,                         │    │
│  │      source: FallSource.Balance,                                    │    │
│  │      allowCrashLanding: true,                                       │    │
│  │      bonusDamage: isFumble ? 1 : 0  // Fumble adds 1d10             │    │
│  │  )                                                                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    COMMAND HANDLER PROCESSES FALL                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  if (result.FallTriggered && result.FallResult != null)             │    │
│  │  {                                                                  │    │
│  │      var fallDamage = await _fallDamageService.ProcessFall(         │    │
│  │          characterId,                                               │    │
│  │          result.FallResult.Value,                                   │    │
│  │          attemptCrashLanding: true                                  │    │
│  │      );                                                             │    │
│  │                                                                      │    │
│  │      await _renderer.RenderFallDamageAsync(fallDamage);             │    │
│  │  }                                                                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  FALL DAMAGE APPLIED                                                        │
│  Character takes damage based on height fallen                              │
│  Crash landing may reduce damage (per v0.15.2c)                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 11.3 Fumble Consequences

Balance fumbles (0 successes + ≥1 botch) use the existing `TheSlip` fumble type from v0.15.1b:

- Fall from current height
- +1d10 bonus damage
- Potential disorientation status effect

---

## 12. Configuration

### 12.1 balance-surfaces.json

```json
{
  "$schema": "./balance-surfaces.schema.json",
  "version": "1.0.0",
  "description": "Balance surface definitions for v0.15.2f",
  "widthCategories": [
    {
      "name": "Wide",
      "minWidthInches": 24,
      "baseDc": 2,
      "description": "Wide surfaces (2+ feet) that most characters can traverse with basic training."
    },
    {
      "name": "Narrow",
      "minWidthInches": 6,
      "baseDc": 3,
      "description": "Narrow surfaces (6-24 inches) requiring concentration and trained acrobatics."
    },
    {
      "name": "Cable",
      "minWidthInches": 3,
      "baseDc": 4,
      "description": "Cable-thin surfaces (3-6 inches) like pipes and ropes."
    },
    {
      "name": "RazorEdge",
      "minWidthInches": 0,
      "baseDc": 5,
      "description": "Razor-thin edges (< 3 inches) representing extreme balance challenges."
    }
  ],
  "stabilityModifiers": {
    "Stable": 0,
    "Unstable": 1,
    "Swaying": 2
  },
  "conditionModifiers": {
    "Dry": 0,
    "Wet": 1,
    "Icy": 2
  },
  "environmentalModifiers": {
    "wind": {
      "None": 0,
      "Light": 0,
      "Moderate": 0,
      "Strong": 1,
      "Severe": 2
    },
    "encumbrance": {
      "Light": 0,
      "Medium": 1,
      "Heavy": 2,
      "Overloaded": -1
    }
  },
  "equipment": {
    "balancePole": {
      "dcModifier": -1,
      "description": "A pole held horizontally for improved balance"
    },
    "quarterstaff": {
      "dcModifier": -1,
      "description": "Can be used as an improvised balance aid"
    }
  },
  "staminaCosts": {
    "baseCostPer10Feet": 1,
    "marginalSuccessMultiplier": 2,
    "criticalSuccessCost": 0
  },
  "presetSurfaces": [
    {
      "id": "narrow_ledge",
      "name": "Narrow Stone Ledge",
      "width": "Narrow",
      "stability": "Stable",
      "description": "A narrow stone ledge along the building face."
    },
    {
      "id": "rope_bridge",
      "name": "Rope Bridge",
      "width": "Narrow",
      "stability": "Swaying",
      "description": "A rope bridge that sways with each step."
    },
    {
      "id": "power_cable",
      "name": "Power Cable",
      "width": "Cable",
      "stability": "Stable",
      "description": "A thick power cable strung between buildings."
    },
    {
      "id": "crumbling_beam",
      "name": "Crumbling Support Beam",
      "width": "Wide",
      "stability": "Unstable",
      "description": "An old support beam that shifts under weight."
    },
    {
      "id": "blade_edge",
      "name": "Dvergr Blade Motif",
      "width": "RazorEdge",
      "stability": "Stable",
      "description": "A decorative blade edge that serves as an unlikely path."
    }
  ]
}
```

### 12.2 balance-surfaces.schema.json

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://rune.game/schemas/balance-surfaces.schema.json",
  "title": "Balance Surfaces Configuration",
  "description": "Schema for balance surface definitions in RUNE",
  "type": "object",
  "required": ["version", "widthCategories", "stabilityModifiers", "conditionModifiers"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Configuration version (semver)"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description"
    },
    "widthCategories": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/widthCategory"
      },
      "minItems": 1
    },
    "stabilityModifiers": {
      "type": "object",
      "additionalProperties": {
        "type": "integer",
        "minimum": 0,
        "maximum": 5
      }
    },
    "conditionModifiers": {
      "type": "object",
      "additionalProperties": {
        "type": "integer",
        "minimum": 0,
        "maximum": 5
      }
    },
    "environmentalModifiers": {
      "type": "object",
      "properties": {
        "wind": {
          "type": "object",
          "additionalProperties": {
            "type": "integer"
          }
        },
        "encumbrance": {
          "type": "object",
          "additionalProperties": {
            "type": "integer"
          }
        }
      }
    },
    "equipment": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/equipmentItem"
      }
    },
    "staminaCosts": {
      "type": "object",
      "properties": {
        "baseCostPer10Feet": {
          "type": "integer",
          "minimum": 0
        },
        "marginalSuccessMultiplier": {
          "type": "integer",
          "minimum": 1
        },
        "criticalSuccessCost": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "presetSurfaces": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/presetSurface"
      }
    }
  },
  "$defs": {
    "widthCategory": {
      "type": "object",
      "required": ["name", "minWidthInches", "baseDc"],
      "properties": {
        "name": {
          "type": "string",
          "enum": ["Wide", "Narrow", "Cable", "RazorEdge"]
        },
        "minWidthInches": {
          "type": "integer",
          "minimum": 0
        },
        "baseDc": {
          "type": "integer",
          "minimum": 1,
          "maximum": 6
        },
        "description": {
          "type": "string"
        }
      }
    },
    "equipmentItem": {
      "type": "object",
      "required": ["dcModifier"],
      "properties": {
        "dcModifier": {
          "type": "integer"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "presetSurface": {
      "type": "object",
      "required": ["id", "name", "width", "stability"],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "width": {
          "type": "string",
          "enum": ["Wide", "Narrow", "Cable", "RazorEdge"]
        },
        "stability": {
          "type": "string",
          "enum": ["Stable", "Unstable", "Swaying"]
        },
        "description": {
          "type": "string"
        }
      }
    }
  }
}
```

---

## 13. Commands

### 13.1 Balance Commands

| Command | Description | Example |
|---------|-------------|---------|
| `balance` | Attempt to cross the current balance surface | `balance` |
| `cross <surface>` | Cross a specific surface | `cross ledge` |
| `examine <surface>` | View balance surface details | `examine rope bridge` |

### 13.2 Command Parsing

```csharp
// In ConsoleInputHandler.ParseCommand():

"balance" => new BalanceCommand(),
"cross" => new CrossSurfaceCommand(argument),

private GameCommand ParseCrossCommand(string? argument)
{
    if (string.IsNullOrWhiteSpace(argument))
        return new BalanceCommand(); // Default to current surface

    return new CrossSurfaceCommand(argument);
}
```

---

## 14. User-Facing Changes

### 14.1 Balance Check Display

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              BALANCE CHECK                                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  SURFACE: Narrow Stone Ledge                                                 ║
║  ┌─────────────────────────────────────────────────────────────────────┐     ║
║  │  Width: narrow (1 ft)              Length: 20 ft                    │     ║
║  │  Stability: Stable                 Height: 40 ft                    │     ║
║  │  Condition: Dry                                                     │     ║
║  └─────────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
║  DC CALCULATION:                                                             ║
║  ├── Base DC (Narrow): 3 successes                                          ║
║  ├── Stability (Stable): +0                                                  ║
║  ├── Strong Wind: +1                                                         ║
║  └── Final DC: 4 successes                                                   ║
║                                                                               ║
║  ACROBATICS CHECK:                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐     ║
║  │  Dice Pool: 6d10 (Acrobatics 3 + Finesse 3)                        │     ║
║  │  Roll: [10, 8, 9, 4, 6, 8] → 4 successes                           │     ║
║  │  vs DC 4 → SUCCESS                                                  │     ║
║  └─────────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
║  RESULT: You carefully make your way across the ledge.                       ║
║  Stamina Cost: 2                                                             ║
║                                                                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 14.2 Balance Failure Display

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              BALANCE CHECK                                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  SURFACE: Swaying Rope Bridge                                                ║
║  ┌─────────────────────────────────────────────────────────────────────┐     ║
║  │  Width: narrow (1 ft)              Length: 30 ft                    │     ║
║  │  Stability: Swaying (+2 DC)        Height: 50 ft                    │     ║
║  └─────────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
║  DC CALCULATION:                                                             ║
║  ├── Base DC (Narrow): 3 successes                                          ║
║  ├── Stability (Swaying): +2                                                 ║
║  └── Final DC: 5 successes                                                   ║
║                                                                               ║
║  ACROBATICS CHECK:                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐     ║
║  │  Dice Pool: 5d10 (Acrobatics 2 + Finesse 3)                        │     ║
║  │  Roll: [4, 6, 8, 3, 5] → 1 success                                 │     ║
║  │  vs DC 5 → FAILURE                                                  │     ║
║  └─────────────────────────────────────────────────────────────────────┘     ║
║                                                                               ║
║  ╔═══════════════════════════════════════════════════════════════════════╗   ║
║  ║  FALL!                                                                 ║   ║
║  ║  You lose your balance and plummet 50 feet!                           ║   ║
║  ║                                                                        ║   ║
║  ║  → Processing fall damage (see v0.15.2c)...                           ║   ║
║  ╚═══════════════════════════════════════════════════════════════════════╝   ║
║                                                                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 15. Logging Specifications

### 15.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Balance attempted | Debug | `Balance check: {CharacterId} on {Width} surface, DC {Dc}, rolled {Successes} ({Outcome})` |
| Balance succeeded | Debug | `Balance succeeded: {CharacterId} crossed {Length} ft {Width} surface` |
| Balance failed | Information | `Balance failed: {CharacterId} falls {Height} ft from {Width} surface` |
| Context created | Debug | `Balance context: DC {FinalDc} (base {Base} + stability {Stab} + wind {Wind} + enc {Enc})` |

### 15.2 Example Log Output

```
[12:34:56 DBG] Balance context: DC 5 (base 3 + stability 2 + wind 0 + enc 0)
[12:34:56 DBG] Balance check: player-1 on Narrow surface, DC 5, rolled 3 (Failure)
[12:34:56 INF] Balance failed: player-1 falls 50 ft from Narrow surface
[12:34:56 DBG] Fall processed: 50 ft, 5d10 damage, crash landing attempted
```

---

## 16. Unit Testing Requirements

### 16.1 Test Specifications (~2 tests)

#### BalanceServiceTests.cs

```csharp
[TestFixture]
public class BalanceServiceTests
{
    /// <summary>
    /// Verifies that surface width correctly determines the base DC.
    /// </summary>
    [Test]
    [TestCase(BalanceWidth.Wide, 2)]
    [TestCase(BalanceWidth.Narrow, 3)]
    [TestCase(BalanceWidth.Cable, 4)]
    [TestCase(BalanceWidth.RazorEdge, 5)]
    public void CalculateDc_WidthCategory_ReturnsCorrectBaseDc(
        BalanceWidth width, int expectedDc)
    {
        // Arrange
        var service = CreateBalanceService();
        var surface = new BalanceSurface(
            width,
            SurfaceStability.Stable,
            LengthFeet: 10,
            HeightAboveGround: 20);

        // Act
        var dc = service.CalculateDc(surface);

        // Assert
        Assert.That(dc, Is.EqualTo(expectedDc));
    }

    /// <summary>
    /// Verifies that balance failure triggers a fall result.
    /// </summary>
    [Test]
    public void AttemptBalance_Failure_TriggersFall()
    {
        // Arrange
        var diceRoller = CreateMockDiceRoller(successes: 1); // Below DC 3
        var service = CreateBalanceService(diceRoller);
        var surface = BalanceSurface.NarrowLedge(lengthFeet: 10, heightFeet: 30);

        // Act
        var result = service.AttemptBalance("player-1", surface);

        // Assert
        Assert.That(result.Crossed, Is.False);
        Assert.That(result.FallTriggered, Is.True);
        Assert.That(result.FallResult, Is.Not.Null);
        Assert.That(result.FallResult!.Value.HeightFeet, Is.EqualTo(30));
        Assert.That(result.FallResult!.Value.Source, Is.EqualTo(FallSource.Balance));
    }
}
```

---

## 17. Use Cases

### 17.1 Use Case 1: Cross Wide Ledge

```
GIVEN a character with Acrobatics 2, Finesse 3 (5d10 pool)
AND a wide stable surface (DC 2)
WHEN the character attempts to balance
AND rolls 2+ successes
THEN the character crosses successfully
AND stamina is consumed
```

### 17.2 Use Case 2: Fall from Swaying Bridge

```
GIVEN a character with Acrobatics 2, Finesse 2 (4d10 pool)
AND a narrow swaying rope bridge 50 feet up (DC 5)
WHEN the character attempts to balance
AND rolls fewer than 5 successes
THEN the character fails the balance check
AND a fall result is generated with 50 ft height
AND fall damage is processed per v0.15.2c
```

### 17.3 Use Case 3: Critical Balance Success

```
GIVEN a character with Acrobatics 4, Finesse 3 (7d10 pool)
AND a cable-width surface (DC 4)
WHEN the character attempts to balance
AND rolls 9+ successes (margin >= 5)
THEN the outcome is CriticalSuccess
AND no stamina is consumed
AND narrative describes graceful crossing
```

### 17.4 Use Case 4: Equipment Assistance

```
GIVEN a character with a balance pole equipped
AND a narrow unstable surface (DC 4 = 3 base + 1 unstable)
WHEN the balance context is created
THEN the balance pole reduces DC by 1
AND the final DC is 3 successes
```

---

## 18. Deliverable Checklist

### 18.1 Domain Layer

| Item | File | Status |
|------|------|--------|
| `BalanceWidth` enum | `Domain/Enums/BalanceWidth.cs` | [ ] |
| `SurfaceStability` enum | `Domain/Enums/SurfaceStability.cs` | [ ] |
| `SurfaceCondition` enum | `Domain/Enums/SurfaceCondition.cs` | [ ] |
| `FallSource.Balance` value | `Domain/Enums/FallSource.cs` | [ ] |
| `BalanceSurface` value object | `Domain/ValueObjects/BalanceSurface.cs` | [ ] |
| `BalanceContext` value object | `Domain/ValueObjects/BalanceContext.cs` | [ ] |
| `BalanceCheckResult` value object | `Domain/ValueObjects/BalanceCheckResult.cs` | [ ] |

### 18.2 Application Layer

| Item | File | Status |
|------|------|--------|
| `IBalanceService` interface | `Application/Interfaces/IBalanceService.cs` | [ ] |
| `BalanceService` implementation | `Application/Services/BalanceService.cs` | [ ] |

### 18.3 Configuration

| Item | File | Status |
|------|------|--------|
| Balance surfaces config | `Configuration/balance-surfaces.json` | [ ] |
| Balance surfaces schema | `Configuration/balance-surfaces.schema.json` | [ ] |

### 18.4 Tests

| Item | File | Status |
|------|------|--------|
| Balance service tests | `Tests/BalanceServiceTests.cs` | [ ] |

---

## 19. Acceptance Criteria

### 19.1 Functional Criteria

- [ ] Width correctly determines base DC (Wide=2, Narrow=3, Cable=4, Razor=5)
- [ ] Stability modifies DC (Stable=+0, Unstable=+1, Swaying=+2)
- [ ] Surface condition modifies DC (Dry=+0, Wet=+1, Icy=+2)
- [ ] Wind conditions modify DC (Strong=+1, Severe=+2)
- [ ] Encumbrance modifies DC (Medium=+1, Heavy=+2)
- [ ] Balance pole equipment reduces DC by 1
- [ ] Balance failure triggers fall with correct height
- [ ] Fumble adds bonus damage to fall
- [ ] Critical success eliminates stamina cost

### 19.2 Quality Criteria

- [ ] All ~2 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] Configuration validates against schema
- [ ] Falls integrate correctly with v0.15.2c FallDamageService

---

## 20. Future Considerations

### 20.1 Deferred to v0.15.2g (Specialization Integration)

- `[Perfect Balance]` - Master ability to auto-succeed DC ≤ 4 balance checks
- Gantry-Runner specialization bonuses to balance

### 20.2 Deferred to Future Versions

- Slippery surfaces (ice, oil) with additional mechanics
- Moving platforms and conveyor belts
- Balance combat actions (push/trip on balance surfaces)
- Long traverses requiring multiple checks
- Recovery from mid-balance wobbles

---

## 21. Implementation Notes

### 21.1 Integration Points

1. **Fall Damage System (v0.15.2c)**: Balance failures delegate to `IFallDamageService`
2. **Chase Sequences (v0.15.2e)**: Debris obstacles can use balance checks
3. **Environment Service**: Provides wind conditions for modifier calculation
4. **Character Service**: Provides encumbrance level and equipment status

### 21.2 Design Decisions

1. **DC Conversion**: Original sum-based DCs (8, 12, 16, 20) converted to success-counting (2, 3, 4, 5)
2. **Fumble Handling**: Uses existing `TheSlip` fumble type from v0.15.1b
3. **Equipment Support**: Balance pole and quarterstaff both provide -1 DC

### 21.3 Edge Cases

1. **Over-encumbered**: Cannot attempt balance checks (throws exception)
2. **Zero Height**: Falls from ground level cause no damage but still break balance
3. **Long Surfaces**: Currently single check; multi-check traverses deferred

---

## 22. Document Metadata

| Property | Value |
|----------|-------|
| **Document Version** | 1.0.0 |
| **Created** | 2026-01-17 |
| **Last Updated** | 2026-01-17 |
| **Author** | Claude |
| **Status** | Draft |
| **Review Status** | Pending |

### 22.1 Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2026-01-17 | Claude | Initial draft |

---

*This design specification provides the detailed blueprint for implementing v0.15.2f Balance Checks. The balance system enables tactical traversal of narrow surfaces with width-based DCs, stability modifiers, and integrated fall consequences.*
