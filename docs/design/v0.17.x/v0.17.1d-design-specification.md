# v0.17.1d Design Specification: Background Provider Service

**Version:** 0.17.1d  
**Phase Name:** Background Provider Service  
**Parent Version:** v0.17.1 (Background System)  
**Prerequisites:** v0.17.1c Complete (Equipment Grants)  
**Estimated Tests:** ~10 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IBackgroundProvider Interface](#4-ibackgroundprovider-interface)
5. [BackgroundProvider Implementation](#5-backgroundprovider-implementation)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration Loading](#7-configuration-loading)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IBackgroundProvider` interface and `BackgroundProvider` implementation that serve as the central access point for all background data. The provider loads background definitions from configuration and provides methods to retrieve backgrounds, skill grants, and equipment grants.

The provider pattern enables:

- **Centralized Access**: Single source for all background data
- **Configuration-Driven**: Backgrounds loaded from `backgrounds.json`
- **Caching**: Definitions loaded once and cached in memory
- **Testability**: Interface enables mocking for unit tests
- **Consistency**: Ensures all consumers use validated data

### 1.2 Key Deliverables

| Category           | Items                          |
| ------------------ | ------------------------------ |
| **Interfaces**     | `IBackgroundProvider`          |
| **Services**       | `BackgroundProvider`           |
| **Infrastructure** | Configuration loading, caching |
| **Tests**          | ~10 unit tests                 |

### 1.3 Architectural Significance

This version establishes the **Provider Pattern** for backgrounds:

- **Interface-Based Access**: `IBackgroundProvider` defines contract for background retrieval
- **Dependency Injection**: Provider registered in DI container
- **Lazy Loading**: Configuration loaded on first access
- **Immutable Caching**: Definitions cached after loading
- **Fallback Handling**: Graceful handling of missing backgrounds

---

## 2. Feature Overview

```
v0.17.1d Background Provider Service
├── IBackgroundProvider Interface
│   ├── GetAllBackgrounds(): IReadOnlyList<BackgroundDefinition>
│   ├── GetBackground(Background): BackgroundDefinition?
│   ├── GetSelectionText(Background): string
│   ├── GetSkillGrants(Background): IReadOnlyList<BackgroundSkillGrant>
│   └── GetEquipmentGrants(Background): IReadOnlyList<BackgroundEquipmentGrant>
└── BackgroundProvider Implementation
    ├── Configuration Loading (backgrounds.json)
    ├── Dictionary-Based Caching
    ├── Validation on Load
    └── Logging Integration
```

### 2.1 Scope Alignment

**In Scope:**

- `IBackgroundProvider` interface definition in Application layer
- `BackgroundProvider` implementation in Infrastructure layer
- Configuration loading from `backgrounds.json`
- Caching of loaded definitions
- Methods for retrieving all backgrounds, specific backgrounds, grants
- Logging for load events and lookups
- Unit tests for provider functionality

**Out of Scope:**

- BackgroundApplicationService → v0.17.1e
- Actual application of grants to characters → v0.17.1e
- Character creation workflow integration → v0.17.5
- Hot-reload of configuration → future enhancement

---

## 3. Architecture Diagrams

### 3.1 Provider System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                 BACKGROUND PROVIDER SYSTEM OVERVIEW                  │
└─────────────────────────────────────────────────────────────────────┘

    Application/Presentation Layer
           │
           │  Requests background data
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    IBackgroundProvider                               │
│                       (Interface)                                    │
├─────────────────────────────────────────────────────────────────────┤
│  + GetAllBackgrounds(): IReadOnlyList<BackgroundDefinition>         │
│  + GetBackground(Background): BackgroundDefinition?                 │
│  + GetSelectionText(Background): string                             │
│  + GetSkillGrants(Background): IReadOnlyList<BackgroundSkillGrant>  │
│  + GetEquipmentGrants(Background): IReadOnlyList<...>               │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Implemented by
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     BackgroundProvider                               │
│                    (Implementation)                                  │
├─────────────────────────────────────────────────────────────────────┤
│  - _backgrounds: Dictionary<Background, BackgroundDefinition>       │
│  - _logger: ILogger<BackgroundProvider>                             │
│  + Loads from backgrounds.json on construction                      │
│  + Caches all 6 backgrounds in memory                               │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Reads from
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     config/backgrounds.json                          │
├─────────────────────────────────────────────────────────────────────┤
│  {                                                                  │
│    "backgrounds": [                                                 │
│      { "backgroundId": "VillageSmith", ... },                       │
│      { "backgroundId": "TravelingHealer", ... },                    │
│      ...                                                            │
│    ]                                                                │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView                                               │
│  └── Uses IBackgroundProvider.GetAllBackgrounds() for selection     │
│                                                                      │
│  BackgroundSelectionPanel                                            │
│  └── Uses IBackgroundProvider.GetSelectionText() for display        │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    IBackgroundProvider                        │  │
│  │                       (Interface)                             │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetAllBackgrounds(): IReadOnlyList<BackgroundDefinition>   │  │
│  │  + GetBackground(Background): BackgroundDefinition?           │  │
│  │  + GetSelectionText(Background): string                       │  │
│  │  + GetSkillGrants(Background): IReadOnlyList<...>             │  │
│  │  + GetEquipmentGrants(Background): IReadOnlyList<...>         │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  IBackgroundApplicationService (v0.17.1e)                            │
│  └── Depends on IBackgroundProvider                                  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      INFRASTRUCTURE LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    BackgroundProvider                         │  │
│  │                    (Implementation)                           │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  - _backgrounds: Dictionary<Background, BackgroundDefinition> │  │
│  │  - _logger: ILogger<BackgroundProvider>                       │  │
│  │  + Constructor loads from IConfiguration                      │  │
│  │  + All methods query cached dictionary                        │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  Background (Enum)           BackgroundDefinition (Entity)          │
│  BackgroundSkillGrant (VO)   BackgroundEquipmentGrant (VO)          │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Configuration Loading Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  CONFIGURATION LOADING FLOW                          │
└─────────────────────────────────────────────────────────────────────┘

    Application Startup / First Provider Access
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  READ CONFIGURATION FILE                             │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get configuration section "Backgrounds"                         │
│  2. Deserialize JSON array to DTOs                                  │
│  3. Log: "Loading background definitions..."                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  VALIDATE EACH BACKGROUND                            │
├─────────────────────────────────────────────────────────────────────┤
│  For each background DTO:                                           │
│    1. Parse BackgroundId enum value                                 │
│    2. Validate required fields (DisplayName, Description, etc.)    │
│    3. Parse skill grants with SkillGrantType                        │
│    4. Parse equipment grants with EquipmentSlot                     │
│    5. Create BackgroundDefinition via factory method                │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────┐
    │ All 6 backgrounds    │──── No ────▶ Log Warning, Use Defaults
    │ loaded successfully? │
    └──────────┬───────────┘
              Yes
               │
               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  CACHE IN DICTIONARY                                 │
├─────────────────────────────────────────────────────────────────────┤
│  _backgrounds[Background.VillageSmith] = villageSmithDef;           │
│  _backgrounds[Background.TravelingHealer] = travelingHealerDef;     │
│  ...                                                                │
│  Log: "Loaded 6 background definitions successfully"                │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Provider Method Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  PROVIDER METHOD DECISION FLOW                       │
└─────────────────────────────────────────────────────────────────────┘

    Consumer Calls Provider Method
           │
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                    Which Method?                              │
    └──────────┬────────────────┬─────────────────┬────────────────┘
               │                │                 │
    ┌──────────▼────────┐ ┌─────▼─────┐ ┌────────▼─────────┐
    │ GetAllBackgrounds │ │GetBackground│ │GetSelectionText │
    └──────────┬────────┘ └─────┬─────┘ └────────┬─────────┘
               │                │                 │
               ▼                ▼                 ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Return           │ │ Lookup in    │ │ Get definition   │
    │ _backgrounds     │ │ dictionary   │ │ then return      │
    │ .Values.ToList() │ │ by enum key  │ │ .SelectionText   │
    └──────────────────┘ └──────┬───────┘ └──────────────────┘
                                │
                         ┌──────┴──────┐
                        YES            NO
                         │              │
                         ▼              ▼
                  ┌────────────┐  ┌────────────┐
                  │ Return     │  │ Return null│
                  │ definition │  │ Log warning│
                  └────────────┘  └────────────┘
```

### 3.5 Dependency Injection Registration

```
┌─────────────────────────────────────────────────────────────────────┐
│                  DEPENDENCY INJECTION SETUP                          │
└─────────────────────────────────────────────────────────────────────┘

    Program.cs / Startup.cs
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  REGISTER SERVICES                                   │
├─────────────────────────────────────────────────────────────────────┤
│  services.AddSingleton<IBackgroundProvider, BackgroundProvider>();  │
│                                                                      │
│  // Singleton because:                                               │
│  // - Configuration loaded once                                      │
│  // - Definitions are immutable                                      │
│  // - Shared across all character creation sessions                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
    Consumer Requests IBackgroundProvider via Constructor
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  DI CONTAINER RESOLVES                               │
├─────────────────────────────────────────────────────────────────────┤
│  1. First request: Create BackgroundProvider                        │
│  2. Constructor loads backgrounds.json                              │
│  3. Cache populated with 6 definitions                              │
│  4. Same instance returned for all subsequent requests              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. IBackgroundProvider Interface

### 4.1 Purpose

The `IBackgroundProvider` interface defines the contract for accessing background data. It provides methods to retrieve all backgrounds, specific backgrounds, and their associated grants.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IBackgroundProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to background definitions and their associated grants.
/// </summary>
/// <remarks>
/// <para>
/// IBackgroundProvider is the central access point for all background data.
/// Implementations load background definitions from configuration and cache
/// them for efficient access throughout the application lifetime.
/// </para>
/// <para>
/// This interface is designed for dependency injection. Register the
/// implementation as a singleton since background data is immutable after
/// loading.
/// </para>
/// </remarks>
public interface IBackgroundProvider
{
    /// <summary>
    /// Gets all available background definitions.
    /// </summary>
    /// <returns>
    /// A read-only list of all 6 background definitions.
    /// </returns>
    IReadOnlyList<BackgroundDefinition> GetAllBackgrounds();

    /// <summary>
    /// Gets a specific background definition by its enum ID.
    /// </summary>
    /// <param name="backgroundId">The background enum value to retrieve.</param>
    /// <returns>
    /// The background definition, or null if not found.
    /// </returns>
    BackgroundDefinition? GetBackground(Background backgroundId);

    /// <summary>
    /// Gets the selection text for a background, used in character creation UI.
    /// </summary>
    /// <param name="backgroundId">The background enum value.</param>
    /// <returns>
    /// The selection text, or a default message if background not found.
    /// </returns>
    string GetSelectionText(Background backgroundId);

    /// <summary>
    /// Gets the skill grants for a specific background.
    /// </summary>
    /// <param name="backgroundId">The background enum value.</param>
    /// <returns>
    /// A read-only list of skill grants, or empty if background not found.
    /// </returns>
    IReadOnlyList<BackgroundSkillGrant> GetSkillGrants(Background backgroundId);

    /// <summary>
    /// Gets the equipment grants for a specific background.
    /// </summary>
    /// <param name="backgroundId">The background enum value.</param>
    /// <returns>
    /// A read-only list of equipment grants, or empty if background not found.
    /// </returns>
    IReadOnlyList<BackgroundEquipmentGrant> GetEquipmentGrants(Background backgroundId);

    /// <summary>
    /// Gets the narrative hooks for a specific background.
    /// </summary>
    /// <param name="backgroundId">The background enum value.</param>
    /// <returns>
    /// A read-only list of narrative hook strings, or empty if not found.
    /// </returns>
    IReadOnlyList<string> GetNarrativeHooks(Background backgroundId);

    /// <summary>
    /// Checks if a background exists in the provider.
    /// </summary>
    /// <param name="backgroundId">The background enum value.</param>
    /// <returns>True if the background is loaded.</returns>
    bool HasBackground(Background backgroundId);
}
```

---

## 5. BackgroundProvider Implementation

### 5.1 Purpose

The `BackgroundProvider` class implements `IBackgroundProvider`, loading background definitions from JSON configuration and caching them for efficient access.

### 5.2 Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Providers/BackgroundProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to background definitions loaded from configuration.
/// </summary>
/// <remarks>
/// <para>
/// BackgroundProvider loads all background definitions from backgrounds.json
/// at construction time and caches them in a dictionary keyed by Background enum.
/// </para>
/// <para>
/// This class is designed to be registered as a singleton in the DI container.
/// All background data is immutable after loading.
/// </para>
/// </remarks>
public class BackgroundProvider : IBackgroundProvider
{
    private readonly Dictionary<Background, BackgroundDefinition> _backgrounds;
    private readonly ILogger<BackgroundProvider> _logger;

    /// <summary>
    /// Initializes a new instance of BackgroundProvider.
    /// </summary>
    /// <param name="configuration">Application configuration containing backgrounds.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public BackgroundProvider(
        IConfiguration configuration,
        ILogger<BackgroundProvider> logger)
    {
        _logger = logger;
        _backgrounds = new Dictionary<Background, BackgroundDefinition>();

        LoadBackgrounds(configuration);
    }

    /// <inheritdoc />
    public IReadOnlyList<BackgroundDefinition> GetAllBackgrounds()
    {
        _logger.LogDebug("Retrieving all {Count} backgrounds", _backgrounds.Count);
        return _backgrounds.Values.ToList();
    }

    /// <inheritdoc />
    public BackgroundDefinition? GetBackground(Background backgroundId)
    {
        if (_backgrounds.TryGetValue(backgroundId, out var definition))
        {
            _logger.LogDebug(
                "Retrieved background {BackgroundId}: {DisplayName}",
                backgroundId, definition.DisplayName);
            return definition;
        }

        _logger.LogWarning(
            "Background {BackgroundId} not found in provider",
            backgroundId);
        return null;
    }

    /// <inheritdoc />
    public string GetSelectionText(Background backgroundId)
    {
        var definition = GetBackground(backgroundId);
        return definition?.SelectionText ?? $"Unknown background: {backgroundId}";
    }

    /// <inheritdoc />
    public IReadOnlyList<BackgroundSkillGrant> GetSkillGrants(Background backgroundId)
    {
        var definition = GetBackground(backgroundId);
        return definition?.SkillGrants ?? Array.Empty<BackgroundSkillGrant>();
    }

    /// <inheritdoc />
    public IReadOnlyList<BackgroundEquipmentGrant> GetEquipmentGrants(Background backgroundId)
    {
        var definition = GetBackground(backgroundId);
        return definition?.EquipmentGrants ?? Array.Empty<BackgroundEquipmentGrant>();
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetNarrativeHooks(Background backgroundId)
    {
        var definition = GetBackground(backgroundId);
        return definition?.NarrativeHooks ?? Array.Empty<string>();
    }

    /// <inheritdoc />
    public bool HasBackground(Background backgroundId) =>
        _backgrounds.ContainsKey(backgroundId);

    /// <summary>
    /// Loads background definitions from configuration.
    /// </summary>
    private void LoadBackgrounds(IConfiguration configuration)
    {
        _logger.LogInformation("Loading background definitions from configuration...");

        var section = configuration.GetSection("Backgrounds");
        var backgroundDtos = section.Get<List<BackgroundDto>>() ?? new List<BackgroundDto>();

        foreach (var dto in backgroundDtos)
        {
            try
            {
                var definition = MapDtoToDefinition(dto);
                _backgrounds[definition.BackgroundId] = definition;

                _logger.LogDebug(
                    "Loaded background {BackgroundId}: {DisplayName} " +
                    "with {SkillCount} skills and {EquipCount} equipment",
                    definition.BackgroundId,
                    definition.DisplayName,
                    definition.SkillGrants.Count,
                    definition.EquipmentGrants.Count);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex,
                    "Failed to load background {BackgroundId}",
                    dto.BackgroundId);
            }
        }

        ValidateLoadedBackgrounds();
    }

    /// <summary>
    /// Maps a DTO to a BackgroundDefinition entity.
    /// </summary>
    private BackgroundDefinition MapDtoToDefinition(BackgroundDto dto)
    {
        var backgroundId = Enum.Parse<Background>(dto.BackgroundId);

        var skillGrants = dto.SkillGrants?
            .Select(s => BackgroundSkillGrant.Create(
                s.SkillId,
                s.BonusAmount,
                Enum.Parse<SkillGrantType>(s.GrantType)))
            .ToList() ?? new List<BackgroundSkillGrant>();

        var equipmentGrants = dto.EquipmentGrants?
            .Select(e => BackgroundEquipmentGrant.Create(
                e.ItemId,
                e.Quantity,
                e.IsEquipped,
                e.Slot != null ? Enum.Parse<EquipmentSlot>(e.Slot) : null))
            .ToList() ?? new List<BackgroundEquipmentGrant>();

        return BackgroundDefinition.Create(
            backgroundId,
            dto.DisplayName,
            dto.Description,
            dto.SelectionText,
            dto.ProfessionBefore,
            dto.SocialStanding,
            dto.NarrativeHooks,
            skillGrants,
            equipmentGrants);
    }

    /// <summary>
    /// Validates that all expected backgrounds were loaded.
    /// </summary>
    private void ValidateLoadedBackgrounds()
    {
        var expectedBackgrounds = Enum.GetValues<Background>();
        var missingBackgrounds = expectedBackgrounds
            .Where(b => !_backgrounds.ContainsKey(b))
            .ToList();

        if (missingBackgrounds.Count > 0)
        {
            _logger.LogWarning(
                "Missing background definitions: {MissingBackgrounds}",
                string.Join(", ", missingBackgrounds));
        }
        else
        {
            _logger.LogInformation(
                "Successfully loaded all {Count} background definitions",
                _backgrounds.Count);
        }
    }
}
```

### 5.3 Configuration DTOs

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Providers/BackgroundDto.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

/// <summary>
/// DTO for deserializing background configuration from JSON.
/// </summary>
public class BackgroundDto
{
    public string BackgroundId { get; set; } = string.Empty;
    public string DisplayName { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string SelectionText { get; set; } = string.Empty;
    public string ProfessionBefore { get; set; } = string.Empty;
    public string SocialStanding { get; set; } = string.Empty;
    public List<string>? NarrativeHooks { get; set; }
    public List<SkillGrantDto>? SkillGrants { get; set; }
    public List<EquipmentGrantDto>? EquipmentGrants { get; set; }
}

/// <summary>
/// DTO for skill grant configuration.
/// </summary>
public class SkillGrantDto
{
    public string SkillId { get; set; } = string.Empty;
    public int BonusAmount { get; set; }
    public string GrantType { get; set; } = "Permanent";
}

/// <summary>
/// DTO for equipment grant configuration.
/// </summary>
public class EquipmentGrantDto
{
    public string ItemId { get; set; } = string.Empty;
    public int Quantity { get; set; } = 1;
    public bool IsEquipped { get; set; }
    public string? Slot { get; set; }
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                  | Layer          | Category  | Description                      |
| --------------------- | -------------- | --------- | -------------------------------- |
| `IBackgroundProvider` | Application    | Interface | Contract for background access   |
| `BackgroundProvider`  | Infrastructure | Service   | Implementation loading from JSON |
| `BackgroundDto`       | Infrastructure | DTO       | JSON deserialization DTO         |
| `SkillGrantDto`       | Infrastructure | DTO       | Skill grant deserialization      |
| `EquipmentGrantDto`   | Infrastructure | DTO       | Equipment grant deserialization  |

### 6.2 File Locations

```
src/Core/RuneAndRust.Application/
└── Interfaces/
    └── IBackgroundProvider.cs                   ← NEW

src/Infrastructure/RuneAndRust.Infrastructure/
└── Providers/
    ├── BackgroundProvider.cs                    ← NEW
    └── BackgroundDto.cs                         ← NEW (includes all DTOs)
```

---

## 7. Configuration Loading

### 7.1 Configuration Binding

The provider reads from the `Backgrounds` configuration section, which is typically loaded from `backgrounds.json`:

```csharp
// In Program.cs or Startup.cs
builder.Configuration.AddJsonFile("config/backgrounds.json", optional: false);

// Register provider as singleton
builder.Services.AddSingleton<IBackgroundProvider, BackgroundProvider>();
```

### 7.2 Error Handling

| Scenario               | Behavior                            |
| ---------------------- | ----------------------------------- |
| Config file missing    | Throws on startup (optional: false) |
| Invalid background ID  | Logs error, skips that background   |
| Missing required field | Logs error, skips that background   |
| Missing backgrounds    | Logs warning, continues with loaded |
| All backgrounds loaded | Logs success message                |

---

## 8. Logging Specifications

### 8.1 Log Levels by Event

| Event                  | Level       | Template                                  |
| ---------------------- | ----------- | ----------------------------------------- |
| Starting load          | Information | "Loading background definitions..."       |
| Background loaded      | Debug       | "Loaded background {Id}: {Name}"          |
| All backgrounds loaded | Information | "Successfully loaded {Count} backgrounds" |
| Missing backgrounds    | Warning     | "Missing background definitions: {List}"  |
| Load error             | Error       | "Failed to load background {Id}"          |
| Background retrieved   | Debug       | "Retrieved background {Id}: {Name}"       |
| Background not found   | Warning     | "Background {Id} not found in provider"   |

### 8.2 Structured Logging Templates

```csharp
// Information - Starting load
_logger.LogInformation("Loading background definitions from configuration...");

// Debug - Individual background loaded
_logger.LogDebug(
    "Loaded background {BackgroundId}: {DisplayName} with {SkillCount} skills",
    backgroundId, displayName, skillCount);

// Information - All loaded successfully
_logger.LogInformation(
    "Successfully loaded all {Count} background definitions",
    count);

// Warning - Missing backgrounds
_logger.LogWarning(
    "Missing background definitions: {MissingBackgrounds}",
    missingList);

// Warning - Background not found
_logger.LogWarning(
    "Background {BackgroundId} not found in provider",
    backgroundId);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature             | Test Count |
| ------------------- | ---------- |
| IBackgroundProvider | ~2         |
| BackgroundProvider  | ~8         |
| **Total**           | **~10**    |

### 9.2 Test Specifications

#### BackgroundProviderTests.cs

```csharp
[TestFixture]
public class BackgroundProviderTests
{
    [Test]
    public void GetAllBackgrounds_ReturnsAllSixBackgrounds();

    [Test]
    public void GetAllBackgrounds_ReturnsImmutableList();

    [Test]
    public void GetBackground_WithValidId_ReturnsDefinition();

    [Test]
    public void GetBackground_WithInvalidId_ReturnsNull();

    [Test]
    public void GetSelectionText_WithValidId_ReturnsText();

    [Test]
    public void GetSelectionText_WithInvalidId_ReturnsDefaultMessage();

    [Test]
    public void GetSkillGrants_ReturnsCorrectGrants();

    [Test]
    public void GetSkillGrants_WithInvalidId_ReturnsEmptyList();

    [Test]
    public void GetEquipmentGrants_ReturnsCorrectGrants();

    [Test]
    public void HasBackground_WithLoadedBackground_ReturnsTrue();

    [Test]
    public void Constructor_LoadsAllBackgroundsFromConfiguration();

    [Test]
    public void Constructor_LogsSuccessOnFullLoad();
}
```

---

## 10. Use Cases

### UC-001: Retrieve All Backgrounds for Selection UI

**Actor:** Character Creation View  
**Flow:** Request all backgrounds → Provider returns list → Display in selection panel

### UC-002: Get Background Details for Preview

**Actor:** Background Selection Panel  
**Flow:** User hovers background → Call GetBackground → Display details and grants

### UC-003: Get Skill Grants for Application

**Actor:** BackgroundApplicationService  
**Flow:** Background selected → Call GetSkillGrants → Apply to character

### UC-004: Get Equipment Grants for Inventory

**Actor:** BackgroundApplicationService  
**Flow:** Background selected → Call GetEquipmentGrants → Create items

---

## 11. User Stories

### US-001: Access Background Data

**As a** character creation service  
**I want to** retrieve background definitions from a provider  
**So that** I can display options and apply selections

### US-002: Consistent Background Access

**As a** developer  
**I want** a single source for background data  
**So that** all parts of the application use the same definitions

### US-003: Configuration-Driven Backgrounds

**As a** game designer  
**I want** backgrounds defined in JSON  
**So that** I can modify them without code changes

---

## 12. Deliverable Checklist

### Application Layer

- [ ] `IBackgroundProvider.cs` interface created
- [ ] Interface has complete XML documentation

### Infrastructure Layer

- [ ] `BackgroundProvider.cs` implementation created
- [ ] `BackgroundDto.cs` DTOs created
- [ ] Provider registered in DI container
- [ ] All types have complete XML documentation

### Testing

- [ ] `BackgroundProviderTests.cs` created
- [ ] ~10 unit tests passing

### Documentation

- [ ] `v0.17.1d-changelog.md` created

---

## 13. Acceptance Criteria

### Functional

- [ ] `GetAllBackgrounds()` returns exactly 6 backgrounds
- [ ] `GetBackground()` returns correct definition for each enum value
- [ ] `GetBackground()` returns null for invalid enum values
- [ ] `GetSelectionText()` returns text or default message
- [ ] `GetSkillGrants()` returns grants for valid backgrounds
- [ ] `GetEquipmentGrants()` returns grants for valid backgrounds
- [ ] `GetNarrativeHooks()` returns hooks for valid backgrounds
- [ ] `HasBackground()` returns true for loaded backgrounds
- [ ] Provider loads all 6 backgrounds from configuration
- [ ] Provider logs load success/failure appropriately

### Quality

- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] ~10 unit tests pass
- [ ] All public types have XML documentation
- [ ] Provider is registered as singleton in DI

---

## 14. Dependencies

### Required from Prior Versions

| Type                       | Location     | Usage                      |
| -------------------------- | ------------ | -------------------------- |
| `Background`               | v0.17.1a     | Enum for dictionary key    |
| `BackgroundDefinition`     | v0.17.1a/b/c | Entity being provided      |
| `BackgroundSkillGrant`     | v0.17.1b     | Returned by GetSkillGrants |
| `BackgroundEquipmentGrant` | v0.17.1c     | Returned by GetEquipGrants |

### Provides to v0.17.1e

| Type                  | Usage                              |
| --------------------- | ---------------------------------- |
| `IBackgroundProvider` | Dependency for application service |

---

## 15. Future Considerations

### Deferred to v0.17.1e

- **IBackgroundApplicationService** using IBackgroundProvider
- **BackgroundApplicationResult** for grant application

### Out of Scope

- Hot-reload of configuration (requires application restart)
- Database storage of backgrounds (config-only for now)
- Custom background creation by players

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
