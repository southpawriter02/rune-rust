# Changelog: v0.17.0f - LineageApplicationService

**Release Date:** 2026-01-29
**Phase:** Lineage System (6/6)
**Status:** Complete

---

## Overview

Implements the LineageApplicationService that orchestrates applying lineage bonuses, traits, and trauma baselines to characters during creation. This service coordinates all lineage components from v0.17.0a-e and applies them atomically to a Player entity, completing the v0.17.0 Lineage System.

---

## Added

### Application Layer

#### Interfaces

- **`ILineageApplicationService`** (`Interfaces/ILineageApplicationService.cs`)
    - Interface defining lineage application contract
    - `ApplyLineage(Player, Lineage, CoreAttribute?)`: Applies all lineage components to a character
    - `ValidateLineageSelection(Player, Lineage, CoreAttribute?)`: Validates without side effects
    - `GetApplicableLineages(Player)`: Returns available lineages for character creation

#### DTOs

- **`LineageApplicationResult`** (`DTOs/LineageApplicationResult.cs`)
    - Immutable record capturing the result of lineage application
    - On success: contains applied lineage, attribute changes, bonuses, trait, and trauma baseline
    - On failure: contains failure reason with all other fields null
    - Static factory methods: `Success(...)` and `Failure(string)`

- **`LineageValidationResult`** (`DTOs/ValidationResult.cs`)
    - Immutable record for validation operation results
    - Named `LineageValidationResult` to avoid conflict with `Spectre.Console.ValidationResult`
    - Static factory methods: `Valid()` and `Fail(string)`

#### Services

- **`LineageApplicationService`** (`Services/LineageApplicationService.cs`)
    - Implements `ILineageApplicationService`
    - Constructor: `(ILineageProvider, ILogger<LineageApplicationService>)`
    - Application flow:
        1. Validate lineage selection (null check, duplicate check, existence check, flexible bonus check)
        2. Apply attribute modifiers (fixed + Clan-Born flexible bonus)
        3. Apply passive bonuses (HP, AP, Soak, Movement, Skills)
        4. Register unique lineage trait
        5. Set trauma baseline (Corruption, Stress, resistance modifiers)
        6. Set lineage on character entity
    - Returns detailed `LineageApplicationResult` for UI display
    - Exhaustive structured logging at Debug/Information/Warning levels

### Domain Layer

#### Player Entity Extensions

- **New Properties on `Player`**
    - `SelectedLineage` (Lineage?): The player's assigned lineage
    - `HasLineage` (bool): Whether a lineage has been assigned
    - `LineageTrait` (LineageTrait?): The registered lineage trait
    - `Corruption` (int): Current Corruption value
    - `PsychicStress` (int): Current Psychic Stress value
    - `CorruptionResistanceModifier` (int): Lineage resistance modifier
    - `StressResistanceModifier` (int): Lineage resistance modifier
    - `LineageMaxHpModifier` (int): Lineage HP bonus
    - `LineageMaxApModifier` (int): Lineage AP bonus
    - `LineageSoakModifier` (int): Lineage Soak bonus

- **New Methods on `Player`**
    - `SetLineage(Lineage)`: Sets lineage (throws if already set)
    - `ModifyAttribute(CoreAttribute, int)`: Adjusts core attribute via PlayerAttributes
    - `ModifyMaxHp(int)`: Adjusts lineage HP modifier
    - `ModifyMaxAp(int)`: Adjusts lineage AP modifier
    - `ModifySoak(int)`: Adjusts lineage Soak modifier
    - `ModifyMovement(int)`: Adjusts base movement speed
    - `ModifySkill(string, int)`: Adds/modifies skill bonus
    - `RegisterLineageTrait(LineageTrait)`: Stores lineage trait
    - `SetTraumaBaseline(int, int, int, int)`: Sets Corruption/Stress and resistance modifiers

### Infrastructure Layer

#### DI Registration

- **`LineageProvider`** registered as singleton in `AddInfrastructure()`
    - Loads from `config/lineages.json`
    - Deferred from v0.17.0e, now registered
- **`LineageApplicationService`** registered as scoped in `AddApplicationServices()`

### Unit Tests

- **`LineageApplicationServiceTests`** (~10 tests)
    - `ApplyLineage_WithValidCharacter_AppliesAllComponents`: Full application success with Rune-Marked
    - `ApplyLineage_CharacterAlreadyHasLineage_ReturnsFail`: Prevents duplicate lineage
    - `ApplyLineage_InvalidLineage_ReturnsFail`: Unknown lineage handling
    - `ApplyLineage_ClanBornWithFlexibleBonus_AppliesCorrectly`: Flexible +1 bonus applied
    - `ApplyLineage_ClanBornWithoutFlexibleBonus_ReturnsFail`: Clan-Born requires attribute choice
    - `ApplyLineage_NonClanBornWithFlexibleBonus_ReturnsFail`: Other lineages reject flexible bonus
    - `ValidateLineageSelection_NullCharacter_ReturnsFail`: Null validation
    - `ValidateLineageSelection_ValidSelection_ReturnsValid`: Valid selection passes
    - `GetApplicableLineages_CharacterHasLineage_ReturnsEmpty`: Already assigned
    - `GetApplicableLineages_NewCharacter_ReturnsAllFour`: All options available

---

## Design Decisions

### Naming: LineageValidationResult

- Named `LineageValidationResult` instead of `ValidationResult` to avoid ambiguity with `Spectre.Console.ValidationResult` used in the TUI presentation layer
- Both types share the same namespace path through transitive references

### Player Entity Methods

- Added lineage-related properties and methods directly to the `Player` entity
- `ModifyAttribute()` maps `CoreAttribute.Sturdiness` to the `PlayerAttributes.Fortitude` field
- `SetLineage()` throws `InvalidOperationException` if called twice (lineage is permanent)
- All methods use additive modifiers that accumulate

### Flexible Bonus Validation

- Clan-Born lineage requires `flexibleBonusAttribute` parameter (has `HasFlexibleBonus = true`)
- All other lineages reject this parameter if provided
- Validation is enforced in both `ValidateLineageSelection()` and `ApplyLineage()`

### CoreAttribute to PlayerAttributes Mapping

| CoreAttribute | PlayerAttributes Field |
|---------------|----------------------|
| Might         | Might                |
| Finesse       | Finesse              |
| Wits          | Wits                 |
| Will          | Will                 |
| Sturdiness    | Fortitude            |

---

## Dependencies

### Prerequisites

- v0.17.0e (LineageProvider) - Complete
- Domain types: `Lineage`, `LineageDefinition`, all value objects
- `ILineageProvider` interface and implementation

### Future Integration Points

- v0.17.5: Character Creation UI will use `GetApplicableLineages()` for selection
- v0.17.5: `CharacterFactory` will call `ApplyLineage()` during character initialization
- v0.17.5: UI will display `LineageApplicationResult` as confirmation summary
