## v0.15.1 - Skill System Infrastructure

**Focus:** Core framework enhancements enabling advanced skill mechanics

### Overview

This version establishes the infrastructure required by all four skill expansions. It provides contextual modifiers, outcome classification, fumble tracking, master abilities, and extended check mechanics that the individual skill systems will utilize.

**Note:** This version depends on v0.15.0 (Dice Pool Refactor) which provides the success-counting mechanics, fumble detection (0 successes + ≥1 botch), critical success (net ≥ 5), and degrees of success.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Value Objects | 4 | 8 |
| Enums | 2 | 4 |
| Services | 4 | 10 |
| Integration | 3 | 3 |
| **Total** | **13** | **~25** |

---

### v0.15.1a - Skill Context & Modifiers

#### SkillContext Value Object
**Purpose:** Container for all contextual modifiers affecting a skill check

```
SkillContext
├── EquipmentModifiers: List<EquipmentModifier>
├── SituationalModifiers: List<SituationalModifier>
├── EnvironmentModifiers: List<EnvironmentModifier>
├── TargetModifiers: List<TargetModifier>
├── TotalDiceModifier: int (calculated)
├── TotalDcModifier: int (calculated)
└── AppliedStatuses: List<StatusEffectId>
```

**Properties:**
- [ ] `EquipmentModifiers` - Tools, gear, weapons affecting the check
- [ ] `SituationalModifiers` - Time pressure, lighting, familiarity
- [ ] `EnvironmentModifiers` - Surface type, weather, corruption
- [ ] `TargetModifiers` - Target disposition, suspicion, resistance
- [ ] `TotalDiceModifier` - Sum of all dice pool adjustments
- [ ] `TotalDcModifier` - Sum of all DC adjustments
- [ ] `AppliedStatuses` - Status effects to apply on success/failure

**Methods:**
- [ ] `AddModifier(modifier)` - Add a modifier to appropriate category
- [ ] `CalculateTotals()` - Compute final modifier values
- [ ] `ToDescription()` - Human-readable modifier breakdown

#### EquipmentModifier Value Object
- [ ] `EquipmentId` - Reference to equipment item
- [ ] `DiceModifier` - Bonus/penalty to dice pool
- [ ] `DcModifier` - Bonus/penalty to DC
- [ ] `Category` - Equipment category (Tools, Weapons, Armor)
- [ ] `Description` - Flavor text for UI

#### SituationalModifier Value Object
- [ ] `ModifierId` - Unique identifier
- [ ] `DiceModifier` - Bonus/penalty to dice pool
- [ ] `DcModifier` - Bonus/penalty to DC
- [ ] `Source` - What caused this modifier
- [ ] `Duration` - How long it persists

#### EnvironmentModifier Value Object
- [ ] `ModifierId` - Unique identifier
- [ ] `SurfaceType` - Stable, Wet, Compromised, etc.
- [ ] `LightingLevel` - Bright, Dim, Dark
- [ ] `CorruptionTier` - Normal, Glitched, Blighted, Resonance
- [ ] `DiceModifier` / `DcModifier` - Calculated adjustments

**Unit Tests (~8):**
- [ ] SkillContext calculates total dice modifier correctly
- [ ] SkillContext calculates total DC modifier correctly
- [ ] Multiple equipment modifiers stack properly
- [ ] Situational modifiers combine with environment
- [ ] Corruption tier applies appropriate DC penalty
- [ ] Empty context returns zero modifiers
- [ ] ToDescription formats modifiers readably
- [ ] AppliedStatuses populated from context

---

### v0.15.1b - Outcome Classification

#### SkillOutcome Enum Expansion
**Note:** Uses degrees of success from v0.15.0 dice refactor

The base outcome calculation comes from `DiceRollResult.NetSuccesses` vs DC:
- Net < DC → Failure/CriticalFailure
- Net = DC → MarginalSuccess (PartialSuccess)
- Net = DC + 1-2 → FullSuccess (Success)
- Net = DC + 3-4 → ExceptionalSuccess
- Net ≥ DC + 5 OR IsCriticalSuccess → CriticalSuccess

```
SkillOutcome
├── CriticalFailure (Fumble) - IsFumble from v0.15.0
├── Failure - Net < DC
├── PartialSuccess - Net = DC (Marginal)
├── Success - Net = DC + 1-2 (Full)
├── CriticalSuccess - Net >= DC + 3 or IsCriticalSuccess
└── ExceptionalSuccess - Net >= DC + 5
```

**Properties per outcome:**
- [ ] `OutcomeType` - Enum value
- [ ] `Margin` - Net successes above/below DC
- [ ] `IsFumble` - From DiceRollResult.IsFumble
- [ ] `IsCritical` - From DiceRollResult.IsCriticalSuccess
- [ ] `DescriptorCategory` - For voice guidance lookup

#### FumbleConsequence Entity
**Purpose:** Tracks lasting effects from catastrophic failures

```
FumbleConsequence
├── ConsequenceId: string
├── CharacterId: string
├── SkillId: string
├── ConsequenceType: FumbleType enum
├── TargetId: string? (NPC, device, location)
├── IsActive: bool
├── AppliedAt: DateTime
├── ExpiresAt: DateTime?
├── Description: string
└── RecoveryCondition: string?
```

**FumbleType Enum:**
- [ ] `TrustShattered` - Persuasion locked with NPC
- [ ] `LieExposed` - Deception penalties with faction
- [ ] `ChallengeAccepted` - Combat initiated
- [ ] `MechanismJammed` - Lock permanently harder
- [ ] `SystemLockout` - Terminal disabled
- [ ] `ForcedExecution` - Trap triggered
- [ ] `TheSlip` - Fall from climb
- [ ] `TheLongFall` - Catastrophic leap failure
- [ ] `SystemWideAlert` - All enemies alerted

**Methods:**
- [ ] `IsExpired()` - Check if consequence has ended
- [ ] `CanRecover(condition)` - Check if recovery condition met
- [ ] `Deactivate()` - Mark consequence as resolved

**Unit Tests (~4):**
- [ ] SkillOutcome correctly maps from DiceRollResult
- [ ] SkillOutcome correctly identifies CriticalSuccess
- [ ] FumbleConsequence tracks expiration correctly
- [ ] FumbleConsequence recovery conditions work

---

### v0.15.1c - Master Abilities

#### MasterAbility Entity
**Purpose:** Rank 5 passive and active abilities

```
MasterAbility
├── AbilityId: string
├── SkillId: string
├── Name: string
├── Description: string
├── AbilityType: MasterAbilityType enum
├── AutoSucceedDc: int? (for auto-succeed abilities)
├── DiceBonus: int? (for bonus abilities)
├── SpecialEffect: string? (for unique effects)
└── IsPassive: bool
```

**MasterAbilityType Enum:**
- [ ] `AutoSucceed` - Automatically succeed below threshold
- [ ] `DiceBonus` - Permanent dice pool bonus
- [ ] `DamageReduction` - Reduce damage (falls, etc.)
- [ ] `DistanceBonus` - Increase range/distance
- [ ] `RerollFailure` - Re-roll one check
- [ ] `SpecialAction` - Unique action unlock

**Configuration (`master-abilities.json`):**
```json
{
  "masterAbilities": [
    {
      "id": "spider-climb",
      "skillId": "acrobatics",
      "name": "Spider Climb",
      "description": "Auto-succeed DC ≤ 12, climb at full speed",
      "abilityType": "AutoSucceed",
      "autoSucceedDc": 12,
      "isPassive": true
    }
  ]
}
```

**Defined Abilities:**

| Skill | Ability | Type | Effect |
|-------|---------|------|--------|
| Acrobatics | Spider Climb | AutoSucceed | DC ≤ 12 climbing |
| Acrobatics | Cat's Grace | DamageReduction | No damage ≤ 30ft fall |
| Acrobatics | Ghost Walk | AutoSucceed | DC ≤ 14 stealth |
| Acrobatics | Death-Defying Leap | DistanceBonus | +10ft leap distance |
| Acrobatics | Perfect Balance | AutoSucceed | DC ≤ 16 balance |
| Rhetoric | Polyglot | AutoSucceed | DC ≤ 14 cant checks |
| Rhetoric | Cultural Diplomat | AutoSucceed | DC ≤ 14 protocol |
| Rhetoric | Master Negotiator | RerollFailure | Once per conversation |
| Rhetoric | Silver Tongue | AutoSucceed | DC ≤ 12 persuasion |
| Rhetoric | Fearsome Reputation | DiceBonus | +2d10 intimidation |
| System Bypass | Auto-Bypass | AutoSucceed | DC ≤ 10 bypass |
| System Bypass | Salvage Expertise | SpecialAction | Always recover components |
| System Bypass | Silent Bypass | SpecialAction | No noise on success |
| System Bypass | Glitch Reader | DiceBonus | -2 to [Glitched] DC penalty |
| Wasteland Survival | Wasteland Cartographer | AutoSucceed | DC ≤ 10 navigation |
| Wasteland Survival | Apex Scavenger | SpecialAction | Never empty, +50% yield |
| Wasteland Survival | Master Tracker | SpecialAction | Track 48hr trails |
| Wasteland Survival | Hazard Sense | AutoSucceed | DC ≤ 16 hazard detection |

**Unit Tests (~3):**
- [ ] AutoSucceed abilities bypass checks correctly
- [ ] DiceBonus abilities add to pool correctly
- [ ] Only Rank 5 characters have master abilities

---

### v0.15.1d - Extended Check Mechanics

#### IExtendedSkillCheckService Interface
**Purpose:** Handle multi-round and accumulated checks

**Note:** Contested and extended checks were moved to v0.15.0d as part of the dice refactor. This section focuses on cooperative and chained checks that build on that infrastructure.

```csharp
public interface IExtendedSkillCheckService
{
    // Cooperative checks (party assists)
    CooperativeCheckResult ResolveCooperativeCheck(
        List<string> participantIds, string skillId,
        int dc, CooperationType type);

    // Chained checks (sequential requirements)
    ChainedCheckState StartChainedCheck(
        string characterId, List<ChainedCheckStep> steps);

    ChainedCheckResult ProcessChainStep(
        string checkId, SkillContext? stepContext = null);
}
```

#### CooperationType Enum
- [ ] `WeakestLink` - Lowest pool makes check (party stealth)
- [ ] `BestAttempt` - Highest roll counts
- [ ] `Combined` - Add all successes together
- [ ] `Assisted` - Primary + bonus from helpers

#### ChainedCheckState Entity
- [ ] `CheckId` - Unique identifier
- [ ] `CharacterId` - Who is making the checks
- [ ] `Steps` - List of required checks
- [ ] `CurrentStepIndex` - Progress
- [ ] `StepResults` - History of each step
- [ ] `Status` - InProgress, Succeeded, Failed

**Unit Tests (~10):**
- [ ] Cooperative WeakestLink uses lowest pool
- [ ] Cooperative BestAttempt uses highest result
- [ ] Cooperative Combined adds successes
- [ ] Cooperative Assisted grants helper bonus
- [ ] Chained check requires sequential success
- [ ] Chained check fails on any step failure
- [ ] Chained check tracks progress correctly
- [ ] Failed step can be retried (if allowed)
- [ ] Chained check completes when all steps pass
- [ ] Context modifiers apply per-step

---

### v0.15.1e - Integration Points

#### Trauma Economy Integration
- [ ] **Corruption tier stress costs** - Apply based on object type
- [ ] **Fumble bonus stress** - Add stress on catastrophic failures
- [ ] **Stress check triggers** - Breaking point after skill checks

#### Specialization Bonus Hooks
- [ ] **ISpecializationBonusProvider** - Interface for archetype bonuses
- [ ] **Skill-specific bonus registry** - Map specializations to skill bonuses
- [ ] **Conditional bonus evaluation** - Context-aware bonus application

#### Voice Guidance Integration
- [ ] **Outcome descriptor lookup** - Fetch narrative text by outcome
- [ ] **Skill-specific descriptor pools** - Per-skill flavor text
- [ ] **Context-aware selection** - Surface/target/situation influences text

**Unit Tests (~3):**
- [ ] Corruption applies correct stress
- [ ] Specialization bonuses apply to correct skills
- [ ] Voice guidance returns appropriate descriptors

---

### Configuration Files

| File | Purpose |
|------|---------|
| `master-abilities.json` | Master rank ability definitions |
| `equipment-modifiers.json` | Tool/gear bonus definitions |
| `fumble-consequences.json` | Fumble type definitions |
| `skill-descriptors.json` | Voice guidance text pools |

---

### Dependencies

**Requires:**
- v0.15.0: Dice pool refactor (success-counting, fumble/critical detection)
- v0.4.x-v0.5.x: Basic skill system
- v0.10.x: Status effect system
- v0.11.x: Combat system (for contested checks)

**Provides to:**
- v0.15.2-v0.15.5: All skill expansions use this infrastructure

---

### Acceptance Criteria

- [ ] SkillContext correctly aggregates all modifier types
- [ ] SkillOutcome correctly maps from DiceRollResult
- [ ] FumbleConsequence tracks and expires correctly
- [ ] MasterAbility auto-succeed abilities work
- [ ] CooperativeCheck uses correct combination method
- [ ] ChainedCheck requires sequential success
- [ ] Trauma integration applies stress
- [ ] Specialization bonuses hook in correctly
- [ ] ~25 unit tests pass
