# v0.14.7b Changelog - Combat Descriptor Schema

**Release Date:** 2026-01-21
**Version:** v0.14.7b
**Phase:** Configuration Consolidation (v0.14.x)
**Sub-Phase:** Descriptor Configuration (v0.14.7)

---

## Summary

Implemented the **Combat Descriptor Schema** (`combat-descriptors.schema.json`) for combat-specific descriptor configuration files. This schema provides specialized validation for combat-related text descriptors including hit descriptions, death descriptions, critical hits, and player death messages with variable substitution.

The combat schema includes:
- **CombatCategory enum** restricting categories to combat-related values
- **HitPoolTypes enum** (11 values) for weapon-based and outcome-based hit descriptions
- **DeathPoolTypes enum** (10 values) for creature-based and special death descriptions
- **CombatDescriptor definition** with combat-specific properties (`weaponTypes`, `damageTypes`, `isCritical`)
- Full base descriptor properties inherited for complete standalone validation

---

## Added

### Schema Files

| File | Description |
|------|-------------|
| `config/schemas/combat-descriptors.schema.json` | Combat-specific JSON Schema for hit/death descriptor validation |

### Schema Definitions

| Definition | Type | Description |
|------------|------|-------------|
| `CombatCategory` | enum | Valid combat categories: `combat-hits`, `combat-deaths`, `combat` |
| `HitPoolTypes` | enum | 11 valid pool IDs for combat-hits category |
| `DeathPoolTypes` | enum | 10 valid pool IDs for combat-deaths category |
| `CombatDescriptorPool` | object | Pool structure with combat descriptors |
| `CombatDescriptor` | object | Extended descriptor with combat-specific properties |
| `VariablePattern` | documentation | Documents variable substitution syntax |

### HitPoolTypes Enum Values (11 total)

| Pool ID | Description |
|---------|-------------|
| `hit_sword` | Sword attack hit descriptions |
| `hit_axe` | Axe attack hit descriptions |
| `hit_bow` | Bow/arrow hit descriptions |
| `hit_staff` | Staff attack hit descriptions |
| `hit_dagger` | Dagger attack hit descriptions |
| `hit_fist` | Unarmed attack hit descriptions |
| `hit_mace` | Mace attack hit descriptions |
| `hit_spear` | Spear attack hit descriptions |
| `critical_hit` | Critical hit descriptions |
| `miss_descriptions` | Missed attack descriptions |
| `fumble_descriptions` | Critical miss descriptions |

### DeathPoolTypes Enum Values (10 total)

| Pool ID | Description |
|---------|-------------|
| `death_humanoid` | Humanoid creature death descriptions |
| `death_undead` | Undead creature death descriptions |
| `death_beast` | Beast creature death descriptions |
| `death_construct` | Construct creature death descriptions |
| `death_elemental` | Elemental creature death descriptions |
| `death_demon` | Demon creature death descriptions |
| `critical_kill` | Critical kill prefix descriptions |
| `player_death` | Player death messages (uses `{player}`, `{killer}`) |
| `near_death_warning` | Low health (25%) warning messages |
| `near_death_critical` | Critical health (10%) warning messages |

### Combat-Specific Descriptor Properties

| Property | Type | Description |
|----------|------|-------------|
| `weaponTypes` | `string[]` | Weapon types this descriptor applies to |
| `damageTypes` | `string[]` | Damage types this descriptor applies to |
| `isCritical` | `boolean` | Whether descriptor is for critical hits/kills |

---

## Modified

### Configuration Files Updated

| File | Change |
|------|--------|
| `config/descriptors/combat-hits.json` | Updated `$schema` reference to `combat-descriptors.schema.json` |
| `config/descriptors/combat-deaths.json` | Updated `$schema` reference to `combat-descriptors.schema.json` |

---

## Unit Tests

### Test File

`tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/CombatDescriptorSchemaTests.cs`

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| CSC-001 | `CombatDescriptorSchema_LoadsSuccessfully_ReturnsValidSchema` | Verifies schema loads and has expected definitions |
| CSC-002 | `CombatDescriptorSchema_InvalidCategory_FailsValidation` | Verifies non-combat categories are rejected |
| CSC-002 | `CombatDescriptorSchema_ValidCategory_PassesValidation` | Parameterized test for all 3 valid categories |
| CSC-003 | `CombatHitsJson_ValidatesAgainstSchema_Succeeds` | Validates existing combat-hits.json (11 pools) |
| CSC-004 | `CombatDeathsJson_ValidatesAgainstSchema_Succeeds` | Validates existing combat-deaths.json (10 pools) |
| CSC-005 | `CombatDescriptor_InvalidDamageThreshold_FailsValidation` | Verifies damage thresholds outside 0-1 fail |
| CSC-005 | `CombatDescriptor_ValidDamageThreshold_PassesValidation` | Verifies valid damage thresholds pass |
| CSC-006 | `PlayerDeathPool_ContainsVariables_ValidatesSuccessfully` | Verifies variable placeholders validate |
| — | `CombatDescriptor_CombatSpecificProperties_PassesValidation` | Verifies weaponTypes/damageTypes/isCritical |
| — | `CombatDescriptor_UnknownProperty_FailsValidation` | Verifies unknown properties are rejected |
| — | `CombatDescriptor_WithTags_PassesValidation` | Verifies creature-specific tags validate |

**Total Tests:** 13 (all passing)

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `config/schemas/combat-descriptors.schema.json` | 220 | Combat descriptor JSON Schema |
| `tests/.../Schemas/CombatDescriptorSchemaTests.cs` | 455 | Unit tests for combat schema |
| `docs/changelogs/v0.14.7b-changelog.md` | — | This changelog |

---

## Files Modified

| File | Change |
|------|--------|
| `config/descriptors/combat-hits.json` | Schema reference updated |
| `config/descriptors/combat-deaths.json` | Schema reference updated |
| `docs/design/v0.14.x/v0.14.7-scope-breakdown.md` | Acceptance criteria marked complete |
| `docs/design/v0.14.x/v0.14.x-overview.md` | Checklist items marked complete |

---

## Schema Structure

```
combat-descriptors.schema.json
├── $schema: "http://json-schema.org/draft-07/schema#"
├── $id: "combat-descriptors.schema.json"
├── title: "Combat Descriptor Configuration Schema"
├── type: object
├── properties:
│   ├── $schema (string)
│   ├── version (string, optional)
│   ├── category → $ref: CombatCategory
│   └── pools → additionalProperties → $ref: CombatDescriptorPool
├── required: [category, pools]
├── additionalProperties: false
└── definitions:
    ├── CombatCategory (enum: 3 values)
    ├── HitPoolTypes (enum: 11 values)
    ├── DeathPoolTypes (enum: 10 values)
    ├── CombatDescriptorPool
    │   ├── id (string, pattern)
    │   ├── name (string)
    │   ├── description (string, optional)
    │   └── descriptors → items → $ref: CombatDescriptor
    ├── CombatDescriptor
    │   ├── id (string, pattern)
    │   ├── text (string)
    │   ├── weight (integer, min: 1, default: 100)
    │   ├── tags (string[], uniqueItems)
    │   ├── themes (string[], uniqueItems)
    │   ├── variables (string[], uniqueItems)
    │   ├── minDamagePercent (number, 0-1)
    │   ├── maxDamagePercent (number, 0-1)
    │   ├── minHealthPercent (number, 0-1)
    │   ├── maxHealthPercent (number, 0-1)
    │   ├── fallbackId (string, pattern)
    │   ├── weaponTypes (string[], uniqueItems) ← COMBAT-SPECIFIC
    │   ├── damageTypes (string[], uniqueItems) ← COMBAT-SPECIFIC
    │   └── isCritical (boolean, default: false) ← COMBAT-SPECIFIC
    └── VariablePattern (documentation)
```

---

## Key Design Decisions

### 1. Standalone Schema (No allOf Inheritance)

**Decision:** The combat schema is a complete standalone schema rather than using `allOf` to inherit from the master `descriptors.schema.json`.

**Rationale:** Using `allOf` with the base schema caused `additionalProperties: false` conflicts - the base schema's Descriptor definition would reject the combat-specific properties (`weaponTypes`, `damageTypes`, `isCritical`). By defining a complete `CombatDescriptor` that includes all base properties plus combat-specific extensions, we achieve the same validation goals without inheritance conflicts.

### 2. Pool Type Enums as Documentation

**Decision:** `HitPoolTypes` and `DeathPoolTypes` are defined as enum definitions within the schema but are not enforced on pool keys.

**Rationale:** Enforcing pool key validation would break flexibility for future weapon/creature types. The enums serve as documentation of expected pool IDs while allowing configuration files to define additional pools if needed.

### 3. Variable Documentation Pattern

**Decision:** Variables are documented in the `VariablePattern` definition and in the `variables` array property on descriptors.

**Rationale:** This provides both human-readable documentation and machine-readable metadata for tooling that processes descriptor files.

---

## Validation Rules Summary

| Rule | Validation |
|------|------------|
| Category | Must be one of: `combat-hits`, `combat-deaths`, `combat` |
| Pool ID pattern | `^[a-z][a-z0-9_]*$` (snake_case) |
| Descriptor ID pattern | `^[a-z][a-z0-9_]*$` (snake_case) |
| Weight | Integer, minimum 1 |
| Damage percentages | Number, 0-1 range |
| Health percentages | Number, 0-1 range |
| Arrays (tags, themes, etc.) | uniqueItems: true, minLength: 1 per item |
| additionalProperties | false on pools, descriptors (strict validation) |

---

## Example: Valid Combat Hits Entry

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-hits",
  "pools": {
    "hit_sword": {
      "id": "hit_sword",
      "name": "Sword Hit Descriptions",
      "descriptors": [
        {
          "id": "slashes_across",
          "text": "slashes across",
          "weight": 25
        },
        {
          "id": "cleaves_through",
          "text": "cleaves through",
          "weight": 15,
          "minDamagePercent": 0.5,
          "weaponTypes": ["sword", "axe"],
          "damageTypes": ["slashing"]
        }
      ]
    }
  }
}
```

---

## Example: Valid Player Death Entry with Variables

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-deaths",
  "pools": {
    "player_death": {
      "id": "player_death",
      "name": "Player Death Messages",
      "descriptors": [
        {
          "id": "falls_battle",
          "text": "{player} has fallen in battle against the {killer}...",
          "weight": 25,
          "variables": ["player", "killer"]
        }
      ]
    }
  }
}
```

---

## Dependencies

### Required from v0.14.7a

| Artifact | Usage |
|----------|-------|
| `descriptors.schema.json` | Reference for base descriptor properties (not inherited via allOf) |
| ID pattern conventions | Same patterns used in combat schema |
| Weight/percentage validation | Same rules applied in combat schema |

### Provides to v0.14.7c

| Artifact | Usage |
|----------|-------|
| Schema extension pattern | Template for environment descriptor schema |
| Pool type enum pattern | Reference for environment pool enums |

---

## Acceptance Criteria Status

| Criteria | Status |
|----------|--------|
| `combat-descriptors.schema.json` created in `config/schemas/` | ✅ Complete |
| Schema validates existing `combat-hits.json` (11 pools) | ✅ Complete |
| Schema validates existing `combat-deaths.json` (10 pools) | ✅ Complete |
| Category enum validates: combat-hits, combat-deaths, combat | ✅ Complete |
| HitPoolTypes enum defines 11 pool IDs | ✅ Complete |
| DeathPoolTypes enum defines 10 pool IDs | ✅ Complete |
| Damage thresholds validated in 0-1 range | ✅ Complete |
| Player death variables documented in schema | ✅ Complete |
| Build completes with 0 errors | ✅ Complete |
| ~6 unit tests pass | ✅ Complete (13 tests) |
| Schema follows JSON Schema Draft-07 | ✅ Complete |

---

*Document Version: 1.0*
*Last Updated: 2026-01-21*
*Author: Claude (AI Assistant)*
