# Changelog: v0.17.0e - LineageProvider Service

**Release Date:** 2026-01-29  
**Phase:** Lineage System (5/6)  
**Status:** Complete

---

## Overview

Implements the LineageProvider service that loads lineage definitions from JSON configuration, caches them in memory, and provides typed access methods for all lineage components. This enables character creation and other systems to access lineage data through a clean interface.

---

## Added

### Application Layer

#### Interfaces

- **`ILineageProvider`** (`Interfaces/ILineageProvider.cs`)
    - Interface defining lineage data access contract
    - `GetAllLineages()`: Returns all 4 lineage definitions
    - `GetLineage(Lineage)`: Returns specific lineage (nullable)
    - `GetAttributeModifiers(Lineage)`: Component access for attribute modifiers
    - `GetPassiveBonuses(Lineage)`: Component access for passive bonuses
    - `GetUniqueTrait(Lineage)`: Component access for unique trait
    - `GetTraumaBaseline(Lineage)`: Component access for trauma baseline

#### DTOs

- **`LineageConfigurationDto`** (`DTOs/LineageConfigurationDto.cs`)
    - Root DTO with `Version` and `Lineages` list
    - `LineageDefinitionDto` for single lineage with all properties
    - `AttributeModifiersDto` for attribute modifier values
    - `PassiveBonusesDto` with stat and skill bonus lists
    - `SkillBonusDto` for individual skill bonuses
    - `UniqueTraitDto` for lineage trait definition
    - `TraumaBaselineDto` for trauma baseline values

#### Exceptions

- **`LineageConfigurationException`** (`Exceptions/LineageConfigurationException.cs`)
    - Custom exception for configuration loading/validation errors
    - Two constructors: message only, message with inner exception

### Infrastructure Layer

#### Services

- **`LineageProvider`** (`Services/LineageProvider.cs`)
    - Thread-safe lazy initialization with double-checked locking
    - Configuration loading from `config/lineages.json`
    - Validation: exactly 4 lineages, no duplicates, valid enum values
    - In-memory caching by `Lineage` enum key
    - DTO to domain entity mapping for all components
    - Exhaustive structured logging at Info/Debug/Warning/Error levels

### Unit Tests

- **`LineageProviderTests`** (~16 tests)
    - Constructor validation tests
    - `GetAllLineages` returns exactly 4 lineages
    - `GetLineage` returns correct definition for each lineage
    - `GetAttributeModifiers` returns correct values (Rune-Marked, Clan-Born)
    - `GetPassiveBonuses` returns correct values (Clan-Born HP, Vargr-Kin movement)
    - `GetUniqueTrait` returns correct traits (Hazard Acclimation, Aether-Tainted)
    - `GetTraumaBaseline` returns correct values (Rune-Marked corruption, Iron-Blooded stress)
    - Error handling for missing config file
    - Caching behavior verification (reference equality)

---

## Design Decisions

### Provider Pattern

- Centralized data access through `ILineageProvider` interface
- Singleton registration recommended for DI container
- All methods synchronous (data cached in memory)

### Lazy Initialization

- Configuration loaded on first access, not at construction
- Thread-safe using double-checked locking pattern
- Efficient for both single-threaded and multi-threaded scenarios

### DTO Field Naming

- DTOs match actual JSON structure: `lineageType`, `might`, `finesse`
- JSON deserialization uses `PropertyNameCaseInsensitive = true`
- Clean separation between JSON structure and domain model

### Validation Rules

| Rule             | Behavior                                           |
| ---------------- | -------------------------------------------------- |
| Lineage count    | Must be exactly 4                                  |
| Duplicate check  | Throws if same lineage type appears twice          |
| Missing lineages | Throws if any Lineage enum value not present       |
| Invalid enum     | Throws if lineageType cannot parse to Lineage enum |

---

## Dependencies

### Prerequisites

- v0.17.0d (Trauma Baseline) - Complete
- Domain types: `Lineage`, `LineageDefinition`, `LineageAttributeModifiers`, `LineagePassiveBonuses`, `LineageTrait`, `LineageTraumaBaseline`

### Future Integration Points

- v0.17.0f: `LineageApplicationService` will use this for business logic
- v0.17.5: Character Creation UI will call `GetAllLineages()` for selection screen
- v0.17.5: `CharacterFactory` will apply lineage using `GetLineage()`
