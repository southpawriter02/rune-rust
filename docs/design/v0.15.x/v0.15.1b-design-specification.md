# v0.15.1b Design Specification: Outcome Classification

**Version:** 0.15.1b
**Theme:** Outcome Classification
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Prerequisites:** v0.15.0 Complete (Dice Pool Refactor), v0.15.1a Complete (Skill Context & Modifiers)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SkillOutcome Enum Expansion](#4-skilloutcome-enum-expansion)
5. [OutcomeDetails Value Object](#5-outcomedetails-value-object)
6. [FumbleConsequence Entity](#6-fumbleconsequence-entity)
7. [FumbleType Enum](#7-fumbletype-enum)
8. [IFumbleConsequenceService Interface](#8-ifumbleconsequenceservice-interface)
9. [FumbleConsequenceService Implementation](#9-fumbleconsequenceservice-implementation)
10. [IFumbleConsequenceRepository Interface](#10-ifumbleconsequencerepository-interface)
11. [InMemoryFumbleConsequenceRepository Implementation](#11-inmemoryfumbleconsequencerepository-implementation)
12. [SkillCheckResult Integration](#12-skillcheckresult-integration)
13. [Data Model Changes](#13-data-model-changes)
14. [Configuration](#14-configuration)
15. [Commands](#15-commands)
16. [User-Facing Changes](#16-user-facing-changes)
17. [Logging Specifications](#17-logging-specifications)
18. [Unit Testing Requirements](#18-unit-testing-requirements)
19. [Use Cases](#19-use-cases)
20. [Deliverable Checklist](#20-deliverable-checklist)
21. [Acceptance Criteria](#21-acceptance-criteria)
22. [Future Considerations](#22-future-considerations)
23. [Implementation Notes](#23-implementation-notes)
24. [Document Metadata](#24-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.1b, the Outcome Classification phase. This part extends the outcome system established in v0.15.0c with enhanced metadata and introduces the fumble consequence tracking system for catastrophic failures. The key components are:

1. **OutcomeDetails Value Object**: Enhanced outcome information including margin, descriptive category, and flags for fumble/critical states.

2. **FumbleConsequence Entity**: Tracks lasting effects from catastrophic skill check failures. Fumbles (0 successes + ≥1 botch) can result in persistent penalties, locked interactions, or triggered events.

3. **FumbleType Enum**: Categorizes fumble consequences by skill type (TrustShattered for persuasion, MechanismJammed for lockpicking, etc.).

4. **FumbleConsequenceService**: Manages the creation, activation, and recovery of fumble consequences.

This infrastructure enables the skill system to impose meaningful consequences for catastrophic failures while providing clear recovery paths.

### 1.2 Current vs. Target Implementation

| Aspect | Current Implementation | Target Implementation |
|--------|------------------------|----------------------|
| **Outcome Data** | `SkillOutcome` enum only | `OutcomeDetails` with margin, category, flags |
| **Fumble Tracking** | `IsFumble` flag on dice result | Persistent `FumbleConsequence` entities |
| **Fumble Effects** | Narrative text only | Mechanical penalties, locked interactions |
| **Consequence Duration** | Not tracked | `ExpiresAt`, `RecoveryCondition` |
| **Consequence Recovery** | Not implemented | Conditional deactivation |
| **Skill-Specific Fumbles** | Generic | Per-skill `FumbleType` consequences |

### 1.3 Scope

**In Scope:**
- Define `OutcomeDetails` value object with enhanced outcome metadata
- Extend outcome classification with `DescriptorCategory` for voice guidance
- Define `FumbleConsequence` entity for tracking lasting failure effects
- Define `FumbleType` enum for categorizing fumble consequences
- Create `IFumbleConsequenceService` interface for consequence management
- Implement `FumbleConsequenceService` for creating and managing consequences
- Create `IFumbleConsequenceRepository` interface for persistence
- Implement `InMemoryFumbleConsequenceRepository`
- Configuration file `fumble-consequences.json`
- Unit tests for outcome classification and fumble tracking (~4 tests)

**Out of Scope:**
- Master rank abilities - v0.15.1c
- Cooperative and chained checks - v0.15.1d
- Trauma economy integration - v0.15.1e
- Specialization bonus hooks - v0.15.1e
- Voice guidance integration - v0.15.1e
- Skill-specific fumble implementations (specific to each skill) - v0.15.2-v0.15.5
- UI for displaying active consequences - future version

### 1.4 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Value Objects | 1 | `OutcomeDetails` |
| Entities | 1 | `FumbleConsequence` |
| Enums | 2 | `FumbleType`, `DescriptorCategory` |
| Interfaces | 2 | `IFumbleConsequenceService`, `IFumbleConsequenceRepository` |
| Services | 1 | `FumbleConsequenceService` |
| Repositories | 1 | `InMemoryFumbleConsequenceRepository` |
| Configuration | 1 | `fumble-consequences.json` |
| Unit Tests | ~4 | Outcome mapping, fumble tracking, expiration, recovery |

---

## 2. Dependencies

### 2.1 Required from v0.15.0a (Core Dice Mechanics)

| Component | Location | Usage in v0.15.1b |
|-----------|----------|-------------------|
| `DiceRollResult` | `Domain/ValueObjects/DiceRollResult.cs` | Provides `IsFumble`, `IsCriticalSuccess`, `NetSuccesses` |
| `DiceConstants` | `Domain/Constants/DiceConstants.cs` | Threshold values for outcome determination |

### 2.2 Required from v0.15.0c (Skill Check Refactor)

| Component | Location | Usage in v0.15.1b |
|-----------|----------|-------------------|
| `SkillOutcome` | `Domain/Enums/SkillOutcome.cs` | Base 6-tier outcome classification |
| `SkillCheckResult` | `Domain/ValueObjects/SkillCheckResult.cs` | Extended to include `OutcomeDetails` |
| `SkillCheckService` | `Application/Services/SkillCheckService.cs` | Triggers fumble consequence creation |

### 2.3 Required from v0.15.1a (Skill Context & Modifiers)

| Component | Location | Usage in v0.15.1b |
|-----------|----------|-------------------|
| `SkillContext` | `Domain/ValueObjects/SkillContext.cs` | Provides context for consequence severity |

### 2.4 Current SkillOutcome Enum (from v0.15.0c)

```csharp
// Current SkillOutcome enum - to be enhanced with OutcomeDetails
public enum SkillOutcome
{
    CriticalFailure,    // Fumble - 0 successes + ≥1 botch
    Failure,            // Margin < 0
    MarginalSuccess,    // Margin = 0 (exactly met DC)
    FullSuccess,        // Margin 1-2
    ExceptionalSuccess, // Margin 3-4
    CriticalSuccess     // Margin ≥ 5
}
```

### 2.5 Provides to Future Versions

| Version | Component | Usage |
|---------|-----------|-------|
| v0.15.1e | Voice Guidance | Uses `DescriptorCategory` for narrative lookup |
| v0.15.2 | Acrobatics | Uses `TheSlip`, `TheLongFall` fumble types |
| v0.15.3 | Rhetoric | Uses `TrustShattered`, `LieExposed`, `ChallengeAccepted` fumble types |
| v0.15.4 | System Bypass | Uses `MechanismJammed`, `SystemLockout`, `ForcedExecution` fumble types |
| v0.15.5 | Wasteland Survival | Uses `SystemWideAlert` fumble type |

---

## 3. Architecture Diagrams

### 3.1 Outcome Classification Enhancement Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  OUTCOME CLASSIFICATION ENHANCEMENT FLOW                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  INPUT: SkillCheckResult (from v0.15.0c)                                    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  SKILL CHECK RESULT                                                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  DiceResult: { NetSuccesses: 2, IsFumble: false, IsCritical: false } │   │
│  │  DifficultyClass: 2                                                  │    │
│  │  SkillOutcome: MarginalSuccess                                       │    │
│  │  SkillId: "lockpicking"                                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CREATE OUTCOME DETAILS                                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  OutcomeDetails                                                      │    │
│  │  ├── OutcomeType: MarginalSuccess                                   │    │
│  │  ├── Margin: 0 (NetSuccesses - DC = 2 - 2)                          │    │
│  │  ├── IsFumble: false                                                │    │
│  │  ├── IsCritical: false                                              │    │
│  │  └── DescriptorCategory: MarginalSuccess                            │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CHECK FOR FUMBLE CONSEQUENCE                                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  if (outcomeDetails.IsFumble)                                       │    │
│  │  {                                                                   │    │
│  │      var consequence = FumbleConsequenceService.CreateConsequence(  │    │
│  │          characterId, skillId, context);                            │    │
│  │                                                                      │    │
│  │      FumbleConsequenceRepository.Add(consequence);                  │    │
│  │  }                                                                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  OUTPUT: SkillCheckResult with OutcomeDetails + Optional FumbleConsequence │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Fumble Consequence Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       FUMBLE CONSEQUENCE LIFECYCLE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  1. FUMBLE OCCURS                                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Skill Check: Persuasion                                            │    │
│  │  Roll: 4d10 → [1, 3, 4, 5]                                          │    │
│  │  Successes: 0, Botches: 1                                           │    │
│  │  Result: FUMBLE (CriticalFailure)                                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  2. CONSEQUENCE CREATED                                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  FumbleConsequence                                                  │    │
│  │  ├── ConsequenceId: "fc-001"                                        │    │
│  │  ├── CharacterId: "player-1"                                        │    │
│  │  ├── SkillId: "persuasion"                                          │    │
│  │  ├── ConsequenceType: TrustShattered                                │    │
│  │  ├── TargetId: "npc-merchant-001"                                   │    │
│  │  ├── IsActive: true                                                 │    │
│  │  ├── AppliedAt: 2026-01-17T10:30:00Z                                │    │
│  │  ├── ExpiresAt: null (permanent until recovery)                     │    │
│  │  ├── Description: "The merchant no longer trusts you"               │    │
│  │  └── RecoveryCondition: "Complete a favor for the merchant"         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  3. CONSEQUENCE EFFECT ACTIVE                                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Player attempts Persuasion on npc-merchant-001:                    │    │
│  │                                                                      │    │
│  │  FumbleConsequenceService.HasActiveConsequence(                     │    │
│  │      "player-1", "persuasion", "npc-merchant-001") → true           │    │
│  │                                                                      │    │
│  │  Result: Check automatically fails (TrustShattered blocks check)    │    │
│  │                                                                      │    │
│  │  Message: "The merchant refuses to listen to you. Your previous    │    │
│  │           attempt to deceive them has not been forgotten."          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼ (Player completes recovery condition)                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  4. RECOVERY CHECK                                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  FumbleConsequenceService.TryRecover(                               │    │
│  │      "fc-001",                                                       │    │
│  │      RecoveryContext { CompletedQuest: "merchant-favor-quest" })    │    │
│  │                                                                      │    │
│  │  RecoveryCondition: "Complete a favor for the merchant" ✓           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  5. CONSEQUENCE DEACTIVATED                                          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  consequence.Deactivate();                                          │    │
│  │                                                                      │    │
│  │  FumbleConsequence                                                  │    │
│  │  ├── IsActive: false                                                │    │
│  │  ├── DeactivatedAt: 2026-01-17T14:45:00Z                            │    │
│  │  └── DeactivationReason: "Recovery condition met"                   │    │
│  │                                                                      │    │
│  │  Message: "The merchant nods, 'You've made things right. I'll      │    │
│  │           give you another chance.'"                                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 FumbleType by Skill Category

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       FUMBLE TYPES BY SKILL CATEGORY                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        RHETORIC FUMBLES                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  TrustShattered                                                     │    │
│  │  ├── Skill: Persuasion                                              │    │
│  │  ├── Effect: Persuasion checks locked with target NPC               │    │
│  │  ├── Duration: Until recovery condition met                         │    │
│  │  └── Recovery: Complete a favor or quest for the NPC                │    │
│  │                                                                      │    │
│  │  LieExposed                                                         │    │
│  │  ├── Skill: Deception                                               │    │
│  │  ├── Effect: -2d10 penalty to Deception with target's faction       │    │
│  │  ├── Duration: Until faction reputation recovered                   │    │
│  │  └── Recovery: Improve faction standing or time passage             │    │
│  │                                                                      │    │
│  │  ChallengeAccepted                                                  │    │
│  │  ├── Skill: Intimidation                                            │    │
│  │  ├── Effect: Immediate combat initiated, enemy gains +1d10          │    │
│  │  ├── Duration: Until combat resolved                                │    │
│  │  └── Recovery: Win or escape the combat                             │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      SYSTEM BYPASS FUMBLES                           │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  MechanismJammed                                                    │    │
│  │  ├── Skill: Lockpicking                                             │    │
│  │  ├── Effect: Lock DC permanently +2, key cannot be used             │    │
│  │  ├── Duration: Permanent for this lock                              │    │
│  │  └── Recovery: Find alternate entry or specialized tools            │    │
│  │                                                                      │    │
│  │  SystemLockout                                                      │    │
│  │  ├── Skill: Terminal Hacking                                        │    │
│  │  ├── Effect: Terminal disabled, security alert triggered            │    │
│  │  ├── Duration: Until terminal reset or bypassed                     │    │
│  │  └── Recovery: Find admin credentials or hardware reset             │    │
│  │                                                                      │    │
│  │  ForcedExecution                                                    │    │
│  │  ├── Skill: Trap Disarmament                                        │    │
│  │  ├── Effect: Trap triggers on disarmer immediately                  │    │
│  │  ├── Duration: Instant (damage applied)                             │    │
│  │  └── Recovery: N/A (instant consequence)                            │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       ACROBATICS FUMBLES                             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  TheSlip                                                            │    │
│  │  ├── Skill: Climbing                                                │    │
│  │  ├── Effect: Fall from current height, take fall damage, stress     │    │
│  │  ├── Duration: Instant (damage applied)                             │    │
│  │  └── Recovery: N/A (instant consequence)                            │    │
│  │                                                                      │    │
│  │  TheLongFall                                                        │    │
│  │  ├── Skill: Leaping                                                 │    │
│  │  ├── Effect: Bonus fall damage, [Disoriented] status 2 rounds       │    │
│  │  ├── Duration: 2 rounds for status                                  │    │
│  │  └── Recovery: Wait out status duration                             │    │
│  │                                                                      │    │
│  │  SystemWideAlert                                                    │    │
│  │  ├── Skill: Stealth                                                 │    │
│  │  ├── Effect: All enemies in adjacent rooms converge on location     │    │
│  │  ├── Duration: Until enemies dealt with or escaped                  │    │
│  │  └── Recovery: Defeat enemies or successfully flee                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Entities/                                                          │    │
│  │  └── FumbleConsequence.cs  ←── NEW                                  │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                      │    │
│  │  └── OutcomeDetails.cs     ←── NEW                                  │    │
│  │                                                                      │    │
│  │  Enums/                                                             │    │
│  │  ├── FumbleType.cs         ←── NEW                                  │    │
│  │  ├── DescriptorCategory.cs ←── NEW                                  │    │
│  │  └── SkillOutcome.cs       ←── EXISTING (v0.15.0c)                  │    │
│  │                                                                      │    │
│  │  Interfaces/                                                        │    │
│  │  └── IFumbleConsequenceRepository.cs ←── NEW                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    APPLICATION LAYER                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Interfaces/                                                        │    │
│  │  └── IFumbleConsequenceService.cs ←── NEW                           │    │
│  │                                                                      │    │
│  │  Services/                                                          │    │
│  │  └── FumbleConsequenceService.cs  ←── NEW                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  INFRASTRUCTURE LAYER                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Repositories/                                                      │    │
│  │  └── InMemoryFumbleConsequenceRepository.cs ←── NEW                 │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. SkillOutcome Enum Expansion

### 4.1 Existing Enum (from v0.15.0c)

The `SkillOutcome` enum defined in v0.15.0c remains unchanged. This section documents the enum for reference and shows how `OutcomeDetails` enhances it with additional metadata.

**File:** `src/Core/RuneAndRust.Domain/Enums/SkillOutcome.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the degree of success or failure for a skill check using success-counting mechanics.
/// </summary>
/// <remarks>
/// Provides 6 tiers of outcomes for nuanced narrative and mechanical effects.
/// </remarks>
public enum SkillOutcome
{
    /// <summary>
    /// Fumble - catastrophic failure with additional consequences.
    /// Triggered when the dice roll is a fumble (0 successes AND ≥1 botch).
    /// </summary>
    CriticalFailure = 0,

    /// <summary>
    /// Standard failure - did not meet the difficulty class.
    /// NetSuccesses less than DifficultyClass.
    /// </summary>
    Failure = 1,

    /// <summary>
    /// Marginal success - barely succeeded, met DC exactly.
    /// NetSuccesses equals DifficultyClass (margin = 0).
    /// </summary>
    MarginalSuccess = 2,

    /// <summary>
    /// Full success - clear success, exceeded DC by 1-2.
    /// Margin of 1-2 above DifficultyClass.
    /// </summary>
    FullSuccess = 3,

    /// <summary>
    /// Exceptional success - outstanding performance, exceeded DC by 3-4.
    /// Margin of 3-4 above DifficultyClass.
    /// </summary>
    ExceptionalSuccess = 4,

    /// <summary>
    /// Critical success - masterful performance, exceeded DC by 5+.
    /// Margin of 5 or more above DifficultyClass.
    /// </summary>
    CriticalSuccess = 5
}
```

### 4.2 DescriptorCategory Enum (New)

**File:** `src/Core/RuneAndRust.Domain/Enums/DescriptorCategory.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categorizes skill check outcomes for voice guidance descriptor lookup.
/// </summary>
/// <remarks>
/// <para>
/// Maps to pools of narrative text that provide flavor descriptions for skill outcomes.
/// Each category has skill-specific descriptor pools in the voice guidance system.
/// </para>
/// <para>
/// Categories align with <see cref="SkillOutcome"/> but provide a semantic layer
/// for the voice guidance system to select appropriate narrative text.
/// </para>
/// </remarks>
public enum DescriptorCategory
{
    /// <summary>
    /// Catastrophic failure - fumble descriptors with consequence narratives.
    /// </summary>
    Catastrophic = 0,

    /// <summary>
    /// Standard failure - unsuccessful attempt descriptors.
    /// </summary>
    Failed = 1,

    /// <summary>
    /// Marginal success - barely succeeded, complications possible.
    /// </summary>
    Marginal = 2,

    /// <summary>
    /// Full success - competent execution descriptors.
    /// </summary>
    Competent = 3,

    /// <summary>
    /// Exceptional success - impressive performance descriptors.
    /// </summary>
    Impressive = 4,

    /// <summary>
    /// Critical success - masterful execution descriptors.
    /// </summary>
    Masterful = 5
}
```

---

## 5. OutcomeDetails Value Object

### 5.1 Class Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/OutcomeDetails.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Provides detailed metadata about a skill check outcome beyond the basic <see cref="SkillOutcome"/> enum.
/// </summary>
/// <remarks>
/// <para>
/// <see cref="OutcomeDetails"/> encapsulates all outcome-related information in a single immutable object,
/// enabling rich narrative feedback and mechanical effects without requiring multiple property lookups.
/// </para>
/// <para>
/// This value object is created during skill check resolution and attached to <see cref="SkillCheckResult"/>.
/// </para>
/// </remarks>
public sealed class OutcomeDetails
{
    /// <summary>
    /// Gets the classified outcome tier from the 6-tier scale.
    /// </summary>
    public SkillOutcome OutcomeType { get; }

    /// <summary>
    /// Gets the margin of success or failure (NetSuccesses - DifficultyClass).
    /// </summary>
    /// <remarks>
    /// Positive values indicate success degree, negative values indicate failure severity.
    /// </remarks>
    public int Margin { get; }

    /// <summary>
    /// Gets a value indicating whether this outcome is a fumble (0 successes + ≥1 botch).
    /// </summary>
    public bool IsFumble { get; }

    /// <summary>
    /// Gets a value indicating whether this outcome is a critical success (net ≥ 5 or margin ≥ 5).
    /// </summary>
    public bool IsCritical { get; }

    /// <summary>
    /// Gets the descriptor category for voice guidance narrative lookup.
    /// </summary>
    public DescriptorCategory DescriptorCategory { get; }

    /// <summary>
    /// Gets a value indicating whether the check was successful (met or exceeded DC).
    /// </summary>
    public bool IsSuccess => OutcomeType >= SkillOutcome.MarginalSuccess;

    /// <summary>
    /// Gets a value indicating whether the check was a failure (did not meet DC).
    /// </summary>
    public bool IsFailure => OutcomeType <= SkillOutcome.Failure;

    /// <summary>
    /// Initializes a new instance of the <see cref="OutcomeDetails"/> class.
    /// </summary>
    /// <param name="outcomeType">The classified outcome tier.</param>
    /// <param name="margin">The margin of success/failure.</param>
    /// <param name="isFumble">Whether this is a fumble.</param>
    /// <param name="isCritical">Whether this is a critical success.</param>
    public OutcomeDetails(
        SkillOutcome outcomeType,
        int margin,
        bool isFumble,
        bool isCritical)
    {
        OutcomeType = outcomeType;
        Margin = margin;
        IsFumble = isFumble;
        IsCritical = isCritical;
        DescriptorCategory = MapToDescriptorCategory(outcomeType);
    }

    /// <summary>
    /// Creates an <see cref="OutcomeDetails"/> from a dice roll result and difficulty class.
    /// </summary>
    /// <param name="diceResult">The dice roll result.</param>
    /// <param name="difficultyClass">The difficulty class to compare against.</param>
    /// <returns>A new <see cref="OutcomeDetails"/> instance.</returns>
    public static OutcomeDetails FromDiceResult(DiceRollResult diceResult, int difficultyClass)
    {
        var margin = diceResult.NetSuccesses - difficultyClass;
        var outcomeType = ClassifyOutcome(diceResult, margin);

        return new OutcomeDetails(
            outcomeType,
            margin,
            diceResult.IsFumble,
            diceResult.IsCriticalSuccess || margin >= 5);
    }

    /// <summary>
    /// Classifies the outcome based on fumble detection and margin calculation.
    /// </summary>
    private static SkillOutcome ClassifyOutcome(DiceRollResult diceResult, int margin)
    {
        // Fumble always results in CriticalFailure regardless of DC
        if (diceResult.IsFumble)
        {
            return SkillOutcome.CriticalFailure;
        }

        return margin switch
        {
            < 0 => SkillOutcome.Failure,
            0 => SkillOutcome.MarginalSuccess,
            1 or 2 => SkillOutcome.FullSuccess,
            3 or 4 => SkillOutcome.ExceptionalSuccess,
            _ => SkillOutcome.CriticalSuccess // margin >= 5
        };
    }

    /// <summary>
    /// Maps SkillOutcome to the corresponding DescriptorCategory for voice guidance.
    /// </summary>
    private static DescriptorCategory MapToDescriptorCategory(SkillOutcome outcome)
    {
        return outcome switch
        {
            SkillOutcome.CriticalFailure => DescriptorCategory.Catastrophic,
            SkillOutcome.Failure => DescriptorCategory.Failed,
            SkillOutcome.MarginalSuccess => DescriptorCategory.Marginal,
            SkillOutcome.FullSuccess => DescriptorCategory.Competent,
            SkillOutcome.ExceptionalSuccess => DescriptorCategory.Impressive,
            SkillOutcome.CriticalSuccess => DescriptorCategory.Masterful,
            _ => DescriptorCategory.Failed
        };
    }

    /// <summary>
    /// Returns a human-readable description of the outcome.
    /// </summary>
    public string ToDescription()
    {
        var baseDescription = OutcomeType switch
        {
            SkillOutcome.CriticalFailure => "Critical Failure (Fumble)",
            SkillOutcome.Failure => "Failure",
            SkillOutcome.MarginalSuccess => "Marginal Success",
            SkillOutcome.FullSuccess => "Success",
            SkillOutcome.ExceptionalSuccess => "Exceptional Success",
            SkillOutcome.CriticalSuccess => "Critical Success",
            _ => "Unknown"
        };

        if (Margin != 0 && OutcomeType != SkillOutcome.CriticalFailure)
        {
            var marginText = Margin > 0 ? $"+{Margin}" : Margin.ToString();
            return $"{baseDescription} (Margin: {marginText})";
        }

        return baseDescription;
    }
}
```

---

## 6. FumbleConsequence Entity

### 6.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/FumbleConsequence.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Tracks a lasting consequence from a fumbled (catastrophically failed) skill check.
/// </summary>
/// <remarks>
/// <para>
/// Fumble consequences persist beyond the immediate skill check, affecting future
/// interactions until they expire or their recovery condition is met.
/// </para>
/// <para>
/// Examples:
/// <list type="bullet">
///   <item><description>TrustShattered: Persuasion locked with an NPC until a favor is completed</description></item>
///   <item><description>MechanismJammed: Lock DC permanently +2 for this specific lock</description></item>
///   <item><description>SystemLockout: Terminal disabled until admin reset</description></item>
/// </list>
/// </para>
/// </remarks>
public sealed class FumbleConsequence
{
    /// <summary>
    /// Gets the unique identifier for this consequence.
    /// </summary>
    public string ConsequenceId { get; }

    /// <summary>
    /// Gets the identifier of the character who fumbled.
    /// </summary>
    public string CharacterId { get; }

    /// <summary>
    /// Gets the identifier of the skill that was fumbled.
    /// </summary>
    public string SkillId { get; }

    /// <summary>
    /// Gets the type of fumble consequence.
    /// </summary>
    public FumbleType ConsequenceType { get; }

    /// <summary>
    /// Gets the optional identifier of the target affected by the consequence.
    /// </summary>
    /// <remarks>
    /// This may be an NPC ID, device ID, location ID, or null for area-wide effects.
    /// </remarks>
    public string? TargetId { get; }

    /// <summary>
    /// Gets or sets a value indicating whether this consequence is currently active.
    /// </summary>
    public bool IsActive { get; private set; }

    /// <summary>
    /// Gets the timestamp when this consequence was applied.
    /// </summary>
    public DateTime AppliedAt { get; }

    /// <summary>
    /// Gets the optional timestamp when this consequence expires automatically.
    /// </summary>
    /// <remarks>
    /// Null indicates the consequence does not expire automatically and requires recovery.
    /// </remarks>
    public DateTime? ExpiresAt { get; }

    /// <summary>
    /// Gets the human-readable description of this consequence.
    /// </summary>
    public string Description { get; }

    /// <summary>
    /// Gets the optional condition that must be met to recover from this consequence.
    /// </summary>
    public string? RecoveryCondition { get; }

    /// <summary>
    /// Gets the timestamp when this consequence was deactivated, if applicable.
    /// </summary>
    public DateTime? DeactivatedAt { get; private set; }

    /// <summary>
    /// Gets the reason this consequence was deactivated, if applicable.
    /// </summary>
    public string? DeactivationReason { get; private set; }

    /// <summary>
    /// Initializes a new instance of the <see cref="FumbleConsequence"/> class.
    /// </summary>
    public FumbleConsequence(
        string consequenceId,
        string characterId,
        string skillId,
        FumbleType consequenceType,
        string? targetId,
        DateTime appliedAt,
        DateTime? expiresAt,
        string description,
        string? recoveryCondition)
    {
        if (string.IsNullOrWhiteSpace(consequenceId))
            throw new ArgumentException("Consequence ID is required.", nameof(consequenceId));
        if (string.IsNullOrWhiteSpace(characterId))
            throw new ArgumentException("Character ID is required.", nameof(characterId));
        if (string.IsNullOrWhiteSpace(skillId))
            throw new ArgumentException("Skill ID is required.", nameof(skillId));
        if (string.IsNullOrWhiteSpace(description))
            throw new ArgumentException("Description is required.", nameof(description));

        ConsequenceId = consequenceId;
        CharacterId = characterId;
        SkillId = skillId;
        ConsequenceType = consequenceType;
        TargetId = targetId;
        IsActive = true;
        AppliedAt = appliedAt;
        ExpiresAt = expiresAt;
        Description = description;
        RecoveryCondition = recoveryCondition;
    }

    /// <summary>
    /// Determines if this consequence has expired based on the current time.
    /// </summary>
    /// <param name="currentTime">The current time to check against.</param>
    /// <returns>True if the consequence has expired; otherwise, false.</returns>
    public bool IsExpired(DateTime currentTime)
    {
        return ExpiresAt.HasValue && currentTime >= ExpiresAt.Value;
    }

    /// <summary>
    /// Determines if the recovery condition has been met.
    /// </summary>
    /// <param name="completedConditions">List of condition identifiers that have been completed.</param>
    /// <returns>True if the recovery condition is met; otherwise, false.</returns>
    public bool CanRecover(IEnumerable<string> completedConditions)
    {
        if (string.IsNullOrWhiteSpace(RecoveryCondition))
        {
            return false; // No recovery possible without a condition
        }

        return completedConditions.Contains(RecoveryCondition, StringComparer.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Deactivates this consequence, marking it as resolved.
    /// </summary>
    /// <param name="reason">The reason for deactivation.</param>
    /// <param name="deactivatedAt">The timestamp of deactivation.</param>
    public void Deactivate(string reason, DateTime deactivatedAt)
    {
        if (!IsActive)
        {
            return; // Already deactivated
        }

        IsActive = false;
        DeactivatedAt = deactivatedAt;
        DeactivationReason = reason;
    }

    /// <summary>
    /// Determines if this consequence blocks a skill check against a specific target.
    /// </summary>
    /// <param name="skillId">The skill being used.</param>
    /// <param name="targetId">The target of the skill check.</param>
    /// <returns>True if this consequence blocks the check; otherwise, false.</returns>
    public bool BlocksCheck(string skillId, string? targetId)
    {
        if (!IsActive)
        {
            return false;
        }

        // Must match skill
        if (!string.Equals(SkillId, skillId, StringComparison.OrdinalIgnoreCase))
        {
            return false;
        }

        // If consequence has no target, it blocks all checks of this skill
        if (string.IsNullOrWhiteSpace(TargetId))
        {
            return ConsequenceType.BlocksAllTargets();
        }

        // If consequence has a target, only block checks against that target
        return string.Equals(TargetId, targetId, StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets any dice penalty applied by this consequence.
    /// </summary>
    /// <returns>The dice pool penalty (negative value) or 0 if no penalty.</returns>
    public int GetDicePenalty()
    {
        if (!IsActive)
        {
            return 0;
        }

        return ConsequenceType switch
        {
            FumbleType.LieExposed => -2,
            FumbleType.ChallengeAccepted => 0, // Enemy gets bonus, not player penalty
            _ => 0
        };
    }

    /// <summary>
    /// Gets any DC modifier applied by this consequence.
    /// </summary>
    /// <returns>The DC modifier (positive = harder) or 0 if no modifier.</returns>
    public int GetDcModifier()
    {
        if (!IsActive)
        {
            return 0;
        }

        return ConsequenceType switch
        {
            FumbleType.MechanismJammed => 2,
            _ => 0
        };
    }
}
```

---

## 7. FumbleType Enum

### 7.1 Enum Definition

**File:** `src/Core/RuneAndRust.Domain/Enums/FumbleType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categorizes types of fumble consequences by skill and effect.
/// </summary>
/// <remarks>
/// <para>
/// Each fumble type is associated with specific skills and has defined mechanical effects:
/// <list type="bullet">
///   <item><description>Blocking effects: Prevent skill checks entirely</description></item>
///   <item><description>Penalty effects: Apply dice or DC modifiers</description></item>
///   <item><description>Instant effects: Trigger immediate events (damage, combat)</description></item>
/// </list>
/// </para>
/// </remarks>
public enum FumbleType
{
    /// <summary>
    /// Rhetoric/Persuasion: Trust completely lost with target NPC.
    /// Persuasion checks are locked until recovery condition met.
    /// </summary>
    TrustShattered = 0,

    /// <summary>
    /// Rhetoric/Deception: Lie has been exposed to the target.
    /// -2d10 penalty to Deception checks with target's faction.
    /// </summary>
    LieExposed = 1,

    /// <summary>
    /// Rhetoric/Intimidation: Target accepts the challenge.
    /// Immediate combat initiated, enemy gains +1d10 to attacks.
    /// </summary>
    ChallengeAccepted = 2,

    /// <summary>
    /// System Bypass/Lockpicking: Lock mechanism has been jammed.
    /// Lock DC permanently +2, key cannot be used on this lock.
    /// </summary>
    MechanismJammed = 3,

    /// <summary>
    /// System Bypass/Terminal Hacking: Terminal has locked out the user.
    /// Terminal disabled and security alert triggered.
    /// </summary>
    SystemLockout = 4,

    /// <summary>
    /// System Bypass/Trap Disarmament: Trap triggered during disarmament.
    /// Trap immediately executes on the disarmer.
    /// </summary>
    ForcedExecution = 5,

    /// <summary>
    /// Acrobatics/Climbing: Lost grip and fell.
    /// Fall from current height, take fall damage plus stress.
    /// </summary>
    TheSlip = 6,

    /// <summary>
    /// Acrobatics/Leaping: Catastrophic landing failure.
    /// Bonus fall damage plus [Disoriented] status for 2 rounds.
    /// </summary>
    TheLongFall = 7,

    /// <summary>
    /// Acrobatics/Stealth: Alerted all nearby enemies.
    /// All enemies in adjacent rooms converge on location.
    /// </summary>
    SystemWideAlert = 8
}

/// <summary>
/// Extension methods for <see cref="FumbleType"/>.
/// </summary>
public static class FumbleTypeExtensions
{
    /// <summary>
    /// Determines if this fumble type blocks all targets or only the specific target.
    /// </summary>
    public static bool BlocksAllTargets(this FumbleType fumbleType)
    {
        return fumbleType switch
        {
            FumbleType.TrustShattered => false, // Only blocks specific NPC
            FumbleType.LieExposed => false,     // Only affects specific faction
            FumbleType.ChallengeAccepted => false, // Only affects specific enemy
            FumbleType.MechanismJammed => false, // Only affects specific lock
            FumbleType.SystemLockout => false,  // Only affects specific terminal
            FumbleType.ForcedExecution => false, // Only affects specific trap
            FumbleType.TheSlip => false,        // Instant effect
            FumbleType.TheLongFall => false,    // Instant effect
            FumbleType.SystemWideAlert => true, // Affects all enemies in area
            _ => false
        };
    }

    /// <summary>
    /// Determines if this fumble type is an instant effect (no duration).
    /// </summary>
    public static bool IsInstant(this FumbleType fumbleType)
    {
        return fumbleType switch
        {
            FumbleType.ForcedExecution => true,
            FumbleType.TheSlip => true,
            FumbleType.TheLongFall => false, // Has status duration
            _ => false
        };
    }

    /// <summary>
    /// Gets the associated skill ID for this fumble type.
    /// </summary>
    public static string GetAssociatedSkillId(this FumbleType fumbleType)
    {
        return fumbleType switch
        {
            FumbleType.TrustShattered => "persuasion",
            FumbleType.LieExposed => "deception",
            FumbleType.ChallengeAccepted => "intimidation",
            FumbleType.MechanismJammed => "lockpicking",
            FumbleType.SystemLockout => "hacking",
            FumbleType.ForcedExecution => "trap-disarmament",
            FumbleType.TheSlip => "climbing",
            FumbleType.TheLongFall => "leaping",
            FumbleType.SystemWideAlert => "stealth",
            _ => "unknown"
        };
    }

    /// <summary>
    /// Gets a human-readable name for this fumble type.
    /// </summary>
    public static string GetDisplayName(this FumbleType fumbleType)
    {
        return fumbleType switch
        {
            FumbleType.TrustShattered => "Trust Shattered",
            FumbleType.LieExposed => "Lie Exposed",
            FumbleType.ChallengeAccepted => "Challenge Accepted",
            FumbleType.MechanismJammed => "Mechanism Jammed",
            FumbleType.SystemLockout => "System Lockout",
            FumbleType.ForcedExecution => "Forced Execution",
            FumbleType.TheSlip => "The Slip",
            FumbleType.TheLongFall => "The Long Fall",
            FumbleType.SystemWideAlert => "System-Wide Alert",
            _ => "Unknown Fumble"
        };
    }
}
```

---

## 8. IFumbleConsequenceService Interface

### 8.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IFumbleConsequenceService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service interface for managing fumble consequences.
/// </summary>
public interface IFumbleConsequenceService
{
    /// <summary>
    /// Creates a new fumble consequence based on the skill check context.
    /// </summary>
    /// <param name="characterId">The character who fumbled.</param>
    /// <param name="skillId">The skill that was fumbled.</param>
    /// <param name="targetId">The optional target of the skill check.</param>
    /// <param name="context">The skill context for additional information.</param>
    /// <returns>The created fumble consequence.</returns>
    FumbleConsequence CreateConsequence(
        string characterId,
        string skillId,
        string? targetId,
        SkillContext? context);

    /// <summary>
    /// Gets all active consequences for a character.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of active fumble consequences.</returns>
    IReadOnlyList<FumbleConsequence> GetActiveConsequences(string characterId);

    /// <summary>
    /// Gets active consequences that affect a specific skill check.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="skillId">The skill being used.</param>
    /// <param name="targetId">The optional target of the skill check.</param>
    /// <returns>List of consequences affecting the check.</returns>
    IReadOnlyList<FumbleConsequence> GetConsequencesAffectingCheck(
        string characterId,
        string skillId,
        string? targetId);

    /// <summary>
    /// Determines if any active consequence blocks a skill check.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="skillId">The skill being used.</param>
    /// <param name="targetId">The optional target of the skill check.</param>
    /// <returns>True if the check is blocked; otherwise, false.</returns>
    bool IsCheckBlocked(string characterId, string skillId, string? targetId);

    /// <summary>
    /// Attempts to recover from a consequence by checking completed conditions.
    /// </summary>
    /// <param name="consequenceId">The consequence to recover from.</param>
    /// <param name="completedConditions">List of completed condition identifiers.</param>
    /// <returns>True if recovery was successful; otherwise, false.</returns>
    bool TryRecover(string consequenceId, IEnumerable<string> completedConditions);

    /// <summary>
    /// Deactivates a consequence manually (e.g., by GM or special ability).
    /// </summary>
    /// <param name="consequenceId">The consequence to deactivate.</param>
    /// <param name="reason">The reason for deactivation.</param>
    void DeactivateConsequence(string consequenceId, string reason);

    /// <summary>
    /// Processes time-based expiration of consequences.
    /// </summary>
    /// <param name="currentTime">The current game time.</param>
    /// <returns>List of consequences that were expired.</returns>
    IReadOnlyList<FumbleConsequence> ProcessExpirations(DateTime currentTime);

    /// <summary>
    /// Gets the total dice penalty from all active consequences for a skill check.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="skillId">The skill being used.</param>
    /// <param name="targetId">The optional target of the skill check.</param>
    /// <returns>The total dice penalty (negative value).</returns>
    int GetTotalDicePenalty(string characterId, string skillId, string? targetId);

    /// <summary>
    /// Gets the total DC modifier from all active consequences for a skill check.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="skillId">The skill being used.</param>
    /// <param name="targetId">The optional target of the skill check.</param>
    /// <returns>The total DC modifier (positive = harder).</returns>
    int GetTotalDcModifier(string characterId, string skillId, string? targetId);
}
```

---

## 9. FumbleConsequenceService Implementation

### 9.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/FumbleConsequenceService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for managing fumble consequences.
/// </summary>
public sealed class FumbleConsequenceService : IFumbleConsequenceService
{
    private readonly IFumbleConsequenceRepository _repository;
    private readonly IFumbleConsequenceConfigurationProvider _configProvider;
    private readonly ILogger<FumbleConsequenceService> _logger;

    public FumbleConsequenceService(
        IFumbleConsequenceRepository repository,
        IFumbleConsequenceConfigurationProvider configProvider,
        ILogger<FumbleConsequenceService> logger)
    {
        _repository = repository ?? throw new ArgumentNullException(nameof(repository));
        _configProvider = configProvider ?? throw new ArgumentNullException(nameof(configProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public FumbleConsequence CreateConsequence(
        string characterId,
        string skillId,
        string? targetId,
        SkillContext? context)
    {
        var fumbleType = DetermineFumbleType(skillId);
        var config = _configProvider.GetConfiguration(fumbleType);

        var consequence = new FumbleConsequence(
            consequenceId: GenerateConsequenceId(),
            characterId: characterId,
            skillId: skillId,
            consequenceType: fumbleType,
            targetId: targetId,
            appliedAt: DateTime.UtcNow,
            expiresAt: config.Duration.HasValue
                ? DateTime.UtcNow.Add(config.Duration.Value)
                : null,
            description: config.Description,
            recoveryCondition: config.RecoveryCondition);

        _repository.Add(consequence);

        _logger.LogInformation(
            "Created fumble consequence {ConsequenceId} of type {FumbleType} for character {CharacterId} " +
            "on skill {SkillId} targeting {TargetId}",
            consequence.ConsequenceId,
            fumbleType,
            characterId,
            skillId,
            targetId ?? "none");

        return consequence;
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetActiveConsequences(string characterId)
    {
        return _repository.GetActiveByCharacter(characterId);
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetConsequencesAffectingCheck(
        string characterId,
        string skillId,
        string? targetId)
    {
        var activeConsequences = _repository.GetActiveByCharacter(characterId);

        return activeConsequences
            .Where(c => c.BlocksCheck(skillId, targetId) ||
                       c.GetDicePenalty() != 0 ||
                       c.GetDcModifier() != 0)
            .ToList();
    }

    /// <inheritdoc />
    public bool IsCheckBlocked(string characterId, string skillId, string? targetId)
    {
        var activeConsequences = _repository.GetActiveByCharacter(characterId);

        var blockingConsequence = activeConsequences
            .FirstOrDefault(c => c.BlocksCheck(skillId, targetId) &&
                                 c.ConsequenceType == FumbleType.TrustShattered);

        if (blockingConsequence != null)
        {
            _logger.LogDebug(
                "Skill check blocked by consequence {ConsequenceId} ({FumbleType}) " +
                "for character {CharacterId} on skill {SkillId}",
                blockingConsequence.ConsequenceId,
                blockingConsequence.ConsequenceType,
                characterId,
                skillId);
            return true;
        }

        return false;
    }

    /// <inheritdoc />
    public bool TryRecover(string consequenceId, IEnumerable<string> completedConditions)
    {
        var consequence = _repository.GetById(consequenceId);
        if (consequence == null || !consequence.IsActive)
        {
            return false;
        }

        if (consequence.CanRecover(completedConditions))
        {
            consequence.Deactivate("Recovery condition met", DateTime.UtcNow);
            _repository.Update(consequence);

            _logger.LogInformation(
                "Consequence {ConsequenceId} recovered by character {CharacterId} - condition met",
                consequenceId,
                consequence.CharacterId);

            return true;
        }

        return false;
    }

    /// <inheritdoc />
    public void DeactivateConsequence(string consequenceId, string reason)
    {
        var consequence = _repository.GetById(consequenceId);
        if (consequence == null || !consequence.IsActive)
        {
            return;
        }

        consequence.Deactivate(reason, DateTime.UtcNow);
        _repository.Update(consequence);

        _logger.LogInformation(
            "Consequence {ConsequenceId} deactivated manually: {Reason}",
            consequenceId,
            reason);
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> ProcessExpirations(DateTime currentTime)
    {
        var allActive = _repository.GetAllActive();
        var expired = new List<FumbleConsequence>();

        foreach (var consequence in allActive)
        {
            if (consequence.IsExpired(currentTime))
            {
                consequence.Deactivate("Expired", currentTime);
                _repository.Update(consequence);
                expired.Add(consequence);

                _logger.LogDebug(
                    "Consequence {ConsequenceId} expired at {CurrentTime}",
                    consequence.ConsequenceId,
                    currentTime);
            }
        }

        return expired;
    }

    /// <inheritdoc />
    public int GetTotalDicePenalty(string characterId, string skillId, string? targetId)
    {
        var consequences = GetConsequencesAffectingCheck(characterId, skillId, targetId);
        return consequences.Sum(c => c.GetDicePenalty());
    }

    /// <inheritdoc />
    public int GetTotalDcModifier(string characterId, string skillId, string? targetId)
    {
        var consequences = GetConsequencesAffectingCheck(characterId, skillId, targetId);
        return consequences.Sum(c => c.GetDcModifier());
    }

    /// <summary>
    /// Determines the appropriate fumble type based on skill ID.
    /// </summary>
    private static FumbleType DetermineFumbleType(string skillId)
    {
        return skillId.ToLowerInvariant() switch
        {
            "persuasion" => FumbleType.TrustShattered,
            "deception" => FumbleType.LieExposed,
            "intimidation" => FumbleType.ChallengeAccepted,
            "lockpicking" => FumbleType.MechanismJammed,
            "hacking" or "terminal-hacking" => FumbleType.SystemLockout,
            "trap-disarmament" or "disarm-trap" => FumbleType.ForcedExecution,
            "climbing" or "climb" => FumbleType.TheSlip,
            "leaping" or "leap" or "jump" => FumbleType.TheLongFall,
            "stealth" or "sneak" => FumbleType.SystemWideAlert,
            _ => FumbleType.TrustShattered // Default fallback
        };
    }

    /// <summary>
    /// Generates a unique consequence ID.
    /// </summary>
    private static string GenerateConsequenceId()
    {
        return $"fc-{Guid.NewGuid():N}";
    }
}
```

### 9.2 Configuration Provider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IFumbleConsequenceConfigurationProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Provides configuration data for fumble consequences.
/// </summary>
public interface IFumbleConsequenceConfigurationProvider
{
    /// <summary>
    /// Gets the configuration for a specific fumble type.
    /// </summary>
    FumbleConsequenceConfiguration GetConfiguration(FumbleType fumbleType);
}

/// <summary>
/// Configuration record for a fumble consequence type.
/// </summary>
public record FumbleConsequenceConfiguration(
    string Description,
    TimeSpan? Duration,
    string? RecoveryCondition);
```

---

## 10. IFumbleConsequenceRepository Interface

### 10.1 Interface Definition

**File:** `src/Core/RuneAndRust.Domain/Interfaces/IFumbleConsequenceRepository.cs`

```csharp
namespace RuneAndRust.Domain.Interfaces;

using RuneAndRust.Domain.Entities;

/// <summary>
/// Repository interface for persisting fumble consequences.
/// </summary>
public interface IFumbleConsequenceRepository
{
    /// <summary>
    /// Adds a new fumble consequence.
    /// </summary>
    void Add(FumbleConsequence consequence);

    /// <summary>
    /// Updates an existing fumble consequence.
    /// </summary>
    void Update(FumbleConsequence consequence);

    /// <summary>
    /// Gets a fumble consequence by its ID.
    /// </summary>
    FumbleConsequence? GetById(string consequenceId);

    /// <summary>
    /// Gets all active consequences for a character.
    /// </summary>
    IReadOnlyList<FumbleConsequence> GetActiveByCharacter(string characterId);

    /// <summary>
    /// Gets all active consequences in the system.
    /// </summary>
    IReadOnlyList<FumbleConsequence> GetAllActive();

    /// <summary>
    /// Gets all consequences (active and inactive) for a character.
    /// </summary>
    IReadOnlyList<FumbleConsequence> GetAllByCharacter(string characterId);

    /// <summary>
    /// Gets consequences affecting a specific target.
    /// </summary>
    IReadOnlyList<FumbleConsequence> GetByTarget(string targetId);

    /// <summary>
    /// Removes a consequence from the repository.
    /// </summary>
    void Remove(string consequenceId);
}
```

---

## 11. InMemoryFumbleConsequenceRepository Implementation

### 11.1 Repository Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryFumbleConsequenceRepository.cs`

```csharp
namespace RuneAndRust.Infrastructure.Repositories;

using System.Collections.Concurrent;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Interfaces;

/// <summary>
/// In-memory implementation of the fumble consequence repository.
/// </summary>
public sealed class InMemoryFumbleConsequenceRepository : IFumbleConsequenceRepository
{
    private readonly ConcurrentDictionary<string, FumbleConsequence> _consequences = new();

    /// <inheritdoc />
    public void Add(FumbleConsequence consequence)
    {
        if (consequence == null)
            throw new ArgumentNullException(nameof(consequence));

        if (!_consequences.TryAdd(consequence.ConsequenceId, consequence))
        {
            throw new InvalidOperationException(
                $"Consequence with ID {consequence.ConsequenceId} already exists.");
        }
    }

    /// <inheritdoc />
    public void Update(FumbleConsequence consequence)
    {
        if (consequence == null)
            throw new ArgumentNullException(nameof(consequence));

        _consequences[consequence.ConsequenceId] = consequence;
    }

    /// <inheritdoc />
    public FumbleConsequence? GetById(string consequenceId)
    {
        _consequences.TryGetValue(consequenceId, out var consequence);
        return consequence;
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetActiveByCharacter(string characterId)
    {
        return _consequences.Values
            .Where(c => c.CharacterId == characterId && c.IsActive)
            .ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetAllActive()
    {
        return _consequences.Values
            .Where(c => c.IsActive)
            .ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetAllByCharacter(string characterId)
    {
        return _consequences.Values
            .Where(c => c.CharacterId == characterId)
            .ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<FumbleConsequence> GetByTarget(string targetId)
    {
        return _consequences.Values
            .Where(c => c.TargetId == targetId && c.IsActive)
            .ToList();
    }

    /// <inheritdoc />
    public void Remove(string consequenceId)
    {
        _consequences.TryRemove(consequenceId, out _);
    }
}
```

---

## 12. SkillCheckResult Integration

### 12.1 Modified SkillCheckResult

The `SkillCheckResult` value object from v0.15.0c is extended to include `OutcomeDetails`.

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SkillCheckResult.cs` (modifications)

```csharp
// Add to existing SkillCheckResult class

/// <summary>
/// Gets the detailed outcome information including margin, fumble status, and descriptor category.
/// </summary>
public OutcomeDetails OutcomeDetails { get; init; }

// Modify constructor or factory method to include OutcomeDetails
public static SkillCheckResult Create(
    string skillId,
    string skillName,
    DiceRollResult diceResult,
    int attributeBonus,
    int otherBonus,
    int difficultyClass,
    string difficultyName,
    SkillContext? context = null)
{
    var outcomeDetails = OutcomeDetails.FromDiceResult(diceResult, difficultyClass);

    return new SkillCheckResult
    {
        SkillId = skillId,
        SkillName = skillName,
        DiceResult = diceResult,
        AttributeBonus = attributeBonus,
        OtherBonus = otherBonus,
        DifficultyClass = difficultyClass,
        DifficultyName = difficultyName,
        Outcome = outcomeDetails.OutcomeType,
        OutcomeDetails = outcomeDetails,
        Context = context
    };
}
```

---

## 13. Data Model Changes

### 13.1 New Entity Relationships

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA MODEL RELATIONSHIPS                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SkillCheckResult                                                           │
│  ├── DiceResult: DiceRollResult                                             │
│  ├── Outcome: SkillOutcome                                                  │
│  ├── OutcomeDetails: OutcomeDetails  ←── NEW                                │
│  └── Context: SkillContext?                                                 │
│                                                                              │
│  OutcomeDetails                                                             │
│  ├── OutcomeType: SkillOutcome                                              │
│  ├── Margin: int                                                            │
│  ├── IsFumble: bool                                                         │
│  ├── IsCritical: bool                                                       │
│  └── DescriptorCategory: DescriptorCategory                                 │
│                                                                              │
│  FumbleConsequence                                                          │
│  ├── ConsequenceId: string                                                  │
│  ├── CharacterId: string  ──────────→ Player                                │
│  ├── SkillId: string  ──────────────→ Skill                                 │
│  ├── ConsequenceType: FumbleType                                            │
│  ├── TargetId: string?  ────────────→ NPC / Device / Location               │
│  ├── IsActive: bool                                                         │
│  ├── AppliedAt: DateTime                                                    │
│  ├── ExpiresAt: DateTime?                                                   │
│  ├── Description: string                                                    │
│  └── RecoveryCondition: string?                                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 14. Configuration

### 14.1 Fumble Consequences Configuration

**File:** `config/fumble-consequences.json`

```json
{
  "fumbleConsequences": [
    {
      "fumbleType": "TrustShattered",
      "skillId": "persuasion",
      "description": "Your attempt at persuasion has backfired catastrophically. The target no longer trusts you.",
      "duration": null,
      "recoveryCondition": "complete-favor-for-target",
      "blocksCheck": true,
      "dicePenalty": 0,
      "dcModifier": 0
    },
    {
      "fumbleType": "LieExposed",
      "skillId": "deception",
      "description": "Your lie has been exposed. Word of your deception spreads through the faction.",
      "duration": null,
      "recoveryCondition": "restore-faction-reputation",
      "blocksCheck": false,
      "dicePenalty": -2,
      "dcModifier": 0
    },
    {
      "fumbleType": "ChallengeAccepted",
      "skillId": "intimidation",
      "description": "Your intimidation attempt has been taken as a challenge. The target attacks!",
      "duration": null,
      "recoveryCondition": "resolve-combat",
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 0,
      "triggersEvent": "combat-initiated"
    },
    {
      "fumbleType": "MechanismJammed",
      "skillId": "lockpicking",
      "description": "Your pick snapped inside the lock, jamming the mechanism.",
      "duration": null,
      "recoveryCondition": null,
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 2,
      "permanentForTarget": true
    },
    {
      "fumbleType": "SystemLockout",
      "skillId": "hacking",
      "description": "The terminal has detected your intrusion and locked you out. Security has been alerted.",
      "duration": null,
      "recoveryCondition": "find-admin-credentials",
      "blocksCheck": true,
      "dicePenalty": 0,
      "dcModifier": 0,
      "triggersEvent": "security-alert"
    },
    {
      "fumbleType": "ForcedExecution",
      "skillId": "trap-disarmament",
      "description": "The trap triggers while you attempt to disarm it!",
      "duration": null,
      "recoveryCondition": null,
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 0,
      "triggersEvent": "trap-triggered",
      "isInstant": true
    },
    {
      "fumbleType": "TheSlip",
      "skillId": "climbing",
      "description": "You lose your grip and fall!",
      "duration": null,
      "recoveryCondition": null,
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 0,
      "triggersEvent": "fall-damage",
      "isInstant": true
    },
    {
      "fumbleType": "TheLongFall",
      "skillId": "leaping",
      "description": "You misjudge the leap and land badly.",
      "duration": "00:00:12",
      "recoveryCondition": null,
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 0,
      "appliesStatus": "Disoriented",
      "triggersEvent": "fall-damage"
    },
    {
      "fumbleType": "SystemWideAlert",
      "skillId": "stealth",
      "description": "You've been spotted! Enemies from adjacent areas converge on your location.",
      "duration": null,
      "recoveryCondition": "escape-or-defeat-enemies",
      "blocksCheck": false,
      "dicePenalty": 0,
      "dcModifier": 0,
      "triggersEvent": "mass-alert"
    }
  ]
}
```

---

## 15. Commands

### 15.1 No New Commands

This version does not introduce new user-facing commands. Fumble consequences are automatically created and tracked when fumbles occur during skill checks.

### 15.2 Future Command Considerations

Future versions may add commands such as:
- `consequences` - List active fumble consequences
- `consequence-info <id>` - View details of a specific consequence
- `recover <consequence-id>` - Attempt to recover from a consequence

---

## 16. User-Facing Changes

### 16.1 Enhanced Skill Check Output

When a fumble occurs, the skill check output includes consequence information:

```
> check persuasion merchant-001

Rolling Persuasion check against DC 2 (Moderate)...

Dice: [1, 3, 4, 5] (4d10)
Successes: 0 | Botches: 1 | Net: 0

FUMBLE! Critical Failure

═══════════════════════════════════════════
  CONSEQUENCE: Trust Shattered

  Your attempt at persuasion has backfired
  catastrophically. The merchant no longer
  trusts you.

  Effect: Persuasion checks blocked with
          this NPC until recovery.

  Recovery: Complete a favor for the merchant
═══════════════════════════════════════════
```

### 16.2 Blocked Check Output

When a check is blocked by an active consequence:

```
> check persuasion merchant-001

Cannot perform Persuasion check on Merchant.

═══════════════════════════════════════════
  BLOCKED BY: Trust Shattered

  The merchant refuses to listen to you.
  Your previous attempt to deceive them
  has not been forgotten.

  Recovery: Complete a favor for the merchant
═══════════════════════════════════════════
```

---

## 17. Logging Specifications

### 17.1 Consequence Created Log

```
[INF] Created fumble consequence fc-abc123 of type TrustShattered
      for character player-1 on skill persuasion targeting npc-merchant-001
```

### 17.2 Check Blocked Log

```
[DBG] Skill check blocked by consequence fc-abc123 (TrustShattered)
      for character player-1 on skill persuasion
```

### 17.3 Recovery Log

```
[INF] Consequence fc-abc123 recovered by character player-1 - condition met
```

### 17.4 Expiration Log

```
[DBG] Consequence fc-xyz789 expired at 2026-01-17T14:00:00Z
```

---

## 18. Unit Testing Requirements

### 18.1 Test Summary

| Test Category | Test Name | Description |
|---------------|-----------|-------------|
| Outcome Mapping | `SkillOutcome_CorrectlyMaps_FromDiceRollResult` | Verify outcome classification from dice results |
| Critical Detection | `SkillOutcome_CorrectlyIdentifies_CriticalSuccess` | Verify critical success detection |
| Expiration | `FumbleConsequence_TracksExpiration_Correctly` | Verify time-based expiration |
| Recovery | `FumbleConsequence_RecoveryConditions_Work` | Verify condition-based recovery |

### 18.2 Test Implementations

**File:** `tests/RuneAndRust.Domain.Tests/ValueObjects/OutcomeDetailsTests.cs`

```csharp
namespace RuneAndRust.Domain.Tests.ValueObjects;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;
using Xunit;

public class OutcomeDetailsTests
{
    [Theory]
    [InlineData(0, true, 2, SkillOutcome.CriticalFailure)]  // Fumble
    [InlineData(1, false, 2, SkillOutcome.Failure)]         // Below DC
    [InlineData(2, false, 2, SkillOutcome.MarginalSuccess)] // Exact DC
    [InlineData(3, false, 2, SkillOutcome.FullSuccess)]     // Margin 1
    [InlineData(4, false, 2, SkillOutcome.FullSuccess)]     // Margin 2
    [InlineData(5, false, 2, SkillOutcome.ExceptionalSuccess)] // Margin 3
    [InlineData(6, false, 2, SkillOutcome.ExceptionalSuccess)] // Margin 4
    [InlineData(7, false, 2, SkillOutcome.CriticalSuccess)] // Margin 5+
    public void SkillOutcome_CorrectlyMaps_FromDiceRollResult(
        int netSuccesses,
        bool isFumble,
        int dc,
        SkillOutcome expectedOutcome)
    {
        // Arrange
        var diceResult = CreateMockDiceResult(netSuccesses, isFumble);

        // Act
        var details = OutcomeDetails.FromDiceResult(diceResult, dc);

        // Assert
        Assert.Equal(expectedOutcome, details.OutcomeType);
    }

    [Fact]
    public void SkillOutcome_CorrectlyIdentifies_CriticalSuccess()
    {
        // Arrange - Net successes of 7 vs DC 2 = margin 5
        var diceResult = CreateMockDiceResult(netSuccesses: 7, isFumble: false, isCritical: true);

        // Act
        var details = OutcomeDetails.FromDiceResult(diceResult, dc: 2);

        // Assert
        Assert.Equal(SkillOutcome.CriticalSuccess, details.OutcomeType);
        Assert.True(details.IsCritical);
        Assert.Equal(5, details.Margin);
    }

    private static DiceRollResult CreateMockDiceResult(
        int netSuccesses,
        bool isFumble,
        bool isCritical = false)
    {
        // Create a mock DiceRollResult with the specified values
        // Implementation depends on DiceRollResult structure from v0.15.0a
        return new DiceRollResult(
            diceRolled: new[] { 8, 8, 8 }, // Placeholder
            successes: netSuccesses,
            botches: isFumble ? 1 : 0,
            netSuccesses: netSuccesses,
            isFumble: isFumble,
            isCriticalSuccess: isCritical);
    }
}
```

**File:** `tests/RuneAndRust.Domain.Tests/Entities/FumbleConsequenceTests.cs`

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using Xunit;

public class FumbleConsequenceTests
{
    [Fact]
    public void FumbleConsequence_TracksExpiration_Correctly()
    {
        // Arrange
        var appliedAt = new DateTime(2026, 1, 17, 10, 0, 0, DateTimeKind.Utc);
        var expiresAt = appliedAt.AddHours(1);

        var consequence = new FumbleConsequence(
            consequenceId: "fc-001",
            characterId: "player-1",
            skillId: "stealth",
            consequenceType: FumbleType.SystemWideAlert,
            targetId: null,
            appliedAt: appliedAt,
            expiresAt: expiresAt,
            description: "Test consequence",
            recoveryCondition: null);

        // Act & Assert
        var beforeExpiry = appliedAt.AddMinutes(30);
        Assert.False(consequence.IsExpired(beforeExpiry));

        var atExpiry = expiresAt;
        Assert.True(consequence.IsExpired(atExpiry));

        var afterExpiry = expiresAt.AddMinutes(1);
        Assert.True(consequence.IsExpired(afterExpiry));
    }

    [Fact]
    public void FumbleConsequence_RecoveryConditions_Work()
    {
        // Arrange
        var consequence = new FumbleConsequence(
            consequenceId: "fc-002",
            characterId: "player-1",
            skillId: "persuasion",
            consequenceType: FumbleType.TrustShattered,
            targetId: "npc-merchant-001",
            appliedAt: DateTime.UtcNow,
            expiresAt: null,
            description: "Trust lost with merchant",
            recoveryCondition: "complete-merchant-favor-quest");

        // Act & Assert - No matching conditions
        var noMatchConditions = new[] { "some-other-quest", "another-quest" };
        Assert.False(consequence.CanRecover(noMatchConditions));

        // Act & Assert - Matching condition
        var matchingConditions = new[] { "complete-merchant-favor-quest" };
        Assert.True(consequence.CanRecover(matchingConditions));

        // Act - Deactivate via recovery
        consequence.Deactivate("Recovery condition met", DateTime.UtcNow);

        // Assert
        Assert.False(consequence.IsActive);
        Assert.NotNull(consequence.DeactivatedAt);
        Assert.Equal("Recovery condition met", consequence.DeactivationReason);
    }
}
```

---

## 19. Use Cases

### 19.1 Use Case: Fumble Creates Consequence

**Scenario:** Player fumbles a persuasion check against an NPC merchant.

```
1. Player initiates: check persuasion merchant-001
2. SkillCheckService rolls dice: [1, 3, 4, 5]
3. DiceRollResult: Successes=0, Botches=1, NetSuccesses=0, IsFumble=true
4. OutcomeDetails.FromDiceResult() returns CriticalFailure
5. SkillCheckService detects fumble, calls FumbleConsequenceService
6. FumbleConsequenceService.CreateConsequence() creates TrustShattered
7. Consequence stored in repository
8. User sees fumble message with consequence details
```

### 19.2 Use Case: Consequence Blocks Check

**Scenario:** Player attempts persuasion on NPC with active TrustShattered consequence.

```
1. Player initiates: check persuasion merchant-001
2. SkillCheckService calls FumbleConsequenceService.IsCheckBlocked()
3. Service finds active TrustShattered consequence for this NPC
4. Service returns true (blocked)
5. SkillCheckService returns blocked result without rolling
6. User sees blocked message with recovery information
```

### 19.3 Use Case: Consequence Recovery

**Scenario:** Player completes quest that satisfies recovery condition.

```
1. Quest system marks "complete-merchant-favor-quest" as completed
2. Quest system calls FumbleConsequenceService.TryRecover()
3. Service finds matching consequence for player
4. Service verifies recovery condition matches
5. Consequence deactivated with reason "Recovery condition met"
6. User sees recovery message
7. Future persuasion checks against merchant allowed
```

### 19.4 Use Case: Time-Based Expiration

**Scenario:** System processes consequence expirations during game tick.

```
1. Game tick triggers ProcessExpirations(currentTime)
2. Service iterates all active consequences
3. Finds TheLongFall consequence with ExpiresAt in the past
4. Consequence deactivated with reason "Expired"
5. [Disoriented] status removed from character
6. Consequence remains in history but inactive
```

---

## 20. Deliverable Checklist

### 20.1 Domain Layer

- [ ] `OutcomeDetails` value object created
- [ ] `FumbleConsequence` entity created
- [ ] `FumbleType` enum created
- [ ] `DescriptorCategory` enum created
- [ ] `FumbleTypeExtensions` class created
- [ ] `IFumbleConsequenceRepository` interface created

### 20.2 Application Layer

- [ ] `IFumbleConsequenceService` interface created
- [ ] `IFumbleConsequenceConfigurationProvider` interface created
- [ ] `FumbleConsequenceService` implementation created
- [ ] `SkillCheckResult` modified to include `OutcomeDetails`

### 20.3 Infrastructure Layer

- [ ] `InMemoryFumbleConsequenceRepository` implementation created

### 20.4 Configuration

- [ ] `fumble-consequences.json` configuration file created

### 20.5 Tests

- [ ] `OutcomeDetailsTests.SkillOutcome_CorrectlyMaps_FromDiceRollResult` passing
- [ ] `OutcomeDetailsTests.SkillOutcome_CorrectlyIdentifies_CriticalSuccess` passing
- [ ] `FumbleConsequenceTests.FumbleConsequence_TracksExpiration_Correctly` passing
- [ ] `FumbleConsequenceTests.FumbleConsequence_RecoveryConditions_Work` passing

---

## 21. Acceptance Criteria

### 21.1 Outcome Classification

- [ ] `OutcomeDetails.FromDiceResult()` correctly classifies all 6 outcome tiers
- [ ] Fumble (0 successes + ≥1 botch) always maps to CriticalFailure
- [ ] Margin calculation correct: NetSuccesses - DC
- [ ] DescriptorCategory correctly mapped from SkillOutcome

### 21.2 Fumble Consequence Tracking

- [ ] Consequences created when fumbles occur
- [ ] Consequences stored in repository
- [ ] Consequences block appropriate skill checks
- [ ] Consequences apply dice penalties where specified
- [ ] Consequences apply DC modifiers where specified

### 21.3 Expiration and Recovery

- [ ] Time-based expiration works correctly
- [ ] Recovery conditions checked correctly
- [ ] Deactivated consequences remain in history
- [ ] Deactivation reason and timestamp recorded

### 21.4 Integration

- [ ] `SkillCheckService` creates consequences on fumble
- [ ] `SkillCheckService` checks for blocking consequences
- [ ] Consequence penalties applied to skill checks
- [ ] ~4 unit tests pass

---

## 22. Future Considerations

### 22.1 Persistence

The current in-memory repository will need to be replaced with a persistent storage solution for save/load functionality.

### 22.2 UI Integration

Future versions should display active consequences in the player's status panel.

### 22.3 Skill-Specific Fumble Logic

Individual skill expansions (v0.15.2-v0.15.5) will implement skill-specific fumble logic, such as:
- **TheSlip**: Calculate fall damage based on climbing height
- **ForcedExecution**: Trigger trap effect on player
- **ChallengeAccepted**: Initiate combat encounter

### 22.4 Consequence Severity Scaling

Future versions may scale consequence severity based on:
- Margin of failure (how badly the fumble missed)
- Skill context (corruption tier, hostile environment)
- Character specializations (some may reduce consequences)

---

## 23. Implementation Notes

### 23.1 Thread Safety

`InMemoryFumbleConsequenceRepository` uses `ConcurrentDictionary` for thread-safe access.

### 23.2 Immutability

`OutcomeDetails` is immutable once created. `FumbleConsequence` is mostly immutable with controlled mutation for `IsActive`, `DeactivatedAt`, and `DeactivationReason`.

### 23.3 Null Safety

Nullable reference types are used throughout. `TargetId`, `ExpiresAt`, and `RecoveryCondition` may be null.

### 23.4 Configuration Provider Implementation

The `IFumbleConsequenceConfigurationProvider` should be implemented to read from `fumble-consequences.json`. A simple JSON-based implementation is recommended.

---

## 24. Document Metadata

| Property | Value |
|----------|-------|
| **Document Version** | 1.0 |
| **Last Updated** | 2026-01-17 |
| **Author** | Claude |
| **Status** | Draft |
| **Review Status** | Pending |
| **Implementation Status** | Not Started |
| **Related Specifications** | v0.15.0c (SkillOutcome), v0.15.1a (SkillContext) |
