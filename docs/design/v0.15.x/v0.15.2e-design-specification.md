# v0.15.2e Design Specification: Chase Sequences

**Version:** 0.15.2e
**Theme:** Chase Sequences
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Prerequisites:** v0.15.2a-d Complete (Climbing, Leaping, Fall Damage, Stealth Movement Systems)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ChaseStatus Enum](#4-chasestatus-enum)
5. [ObstacleType Enum](#5-obstacletype-enum)
6. [ChaseObstacle Value Object](#6-chaseobstacle-value-object)
7. [ChaseRoundResult Value Object](#7-chaseroundresult-value-object)
8. [ChaseState Entity](#8-chasestate-entity)
9. [IChaseService Interface](#9-ichaseservice-interface)
10. [ChaseService Implementation](#10-chaseservice-implementation)
11. [Distance Track System](#11-distance-track-system)
12. [Configuration](#12-configuration)
13. [Commands](#13-commands)
14. [User-Facing Changes](#14-user-facing-changes)
15. [Logging Specifications](#15-logging-specifications)
16. [Unit Testing Requirements](#16-unit-testing-requirements)
17. [Use Cases](#17-use-cases)
18. [Deliverable Checklist](#18-deliverable-checklist)
19. [Acceptance Criteria](#19-acceptance-criteria)
20. [Future Considerations](#20-future-considerations)
21. [Implementation Notes](#21-implementation-notes)
22. [Document Metadata](#22-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.2e, the Chase Sequences phase. This phase introduces a structured chase encounter system where characters pursue or flee from each other across a distance track. The key components are:

1. **ChaseState Entity**: Tracks the complete state of a chase encounter, including participants, distance, obstacles encountered, and round count.

2. **ChaseObstacle Value Object**: Represents dynamically generated obstacles that both participants must navigate during a chase round.

3. **Distance Track System**: A 0-6 position scale where 0 means caught and 6+ means escaped, with movement based on obstacle check outcomes.

4. **ChaseService**: Orchestrates chase encounters, generates obstacles, processes rounds, and determines chase outcomes.

This infrastructure enables dramatic pursuit sequences with meaningful skill checks and dynamic obstacle generation.

### 1.2 Current vs. Target Implementation

| Aspect | Current Implementation | Target Implementation |
|--------|------------------------|----------------------|
| **Chase Encounters** | Not implemented | Full chase state tracking with distance track |
| **Obstacles** | Not implemented | Dynamic obstacle generation (Gap, Climb, Debris, Crowd, Hazard) |
| **Distance Tracking** | Not implemented | 0-6 track with catch/escape thresholds |
| **Round Processing** | Not implemented | Both participants attempt obstacles each round |
| **Chase Resolution** | Not implemented | Caught, Escaped, Abandoned, TimedOut outcomes |

### 1.3 Scope

**In Scope:**
- Define `ChaseStatus` enum for chase outcome states
- Define `ObstacleType` enum for obstacle categories
- Define `ChaseObstacle` value object for obstacle configuration
- Define `ChaseRoundResult` value object for round outcomes
- Define `ChaseState` entity for chase encounter tracking
- Create `IChaseService` interface for chase operations
- Implement `ChaseService` with distance track and obstacle mechanics
- Configuration file `chase-obstacles.json`
- Unit tests for chase mechanics (~4 tests)

**Out of Scope:**
- Balance checks - v0.15.2f
- Specialization integration (Gantry-Runner chase abilities) - v0.15.2g
- Multi-pursuer chases - future version
- Vehicle chases - future version
- Environmental hazard damage during chases - future version

### 1.4 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 2 | `ChaseStatus`, `ObstacleType` |
| Entities | 1 | `ChaseState` |
| Value Objects | 2 | `ChaseObstacle`, `ChaseRoundResult` |
| Interfaces | 1 | `IChaseService` |
| Services | 1 | `ChaseService` |
| Configuration | 1 | `chase-obstacles.json` |
| Unit Tests | ~4 | Start distance, success movement, caught trigger, escaped trigger |

---

## 2. Dependencies

### 2.1 Required from v0.15.0 (Dice Pool Refactor)

| Component | Location | Usage in v0.15.2e |
|-----------|----------|-------------------|
| `DiceRollResult` | `Domain/ValueObjects/DiceRollResult.cs` | Provides `NetSuccesses`, `IsCritical` for obstacle checks |
| `DiceConstants` | `Domain/Constants/DiceConstants.cs` | Success threshold (8), botch value (1) |
| `IDiceRollerService` | `Application/Interfaces/IDiceRollerService.cs` | Performs obstacle check dice rolls |

### 2.2 Required from v0.15.1a (Skill Context & Modifiers)

| Component | Location | Usage in v0.15.2e |
|-----------|----------|-------------------|
| `SkillContext` | `Domain/ValueObjects/SkillContext.cs` | Passed to obstacle checks |
| `SkillContextBuilder` | `Application/Services/SkillContextBuilder.cs` | Builds context for obstacle attempts |

### 2.3 Required from v0.15.1b (Outcome Classification)

| Component | Location | Usage in v0.15.2e |
|-----------|----------|-------------------|
| `SkillOutcome` | `Domain/Enums/SkillOutcome.cs` | Obstacle check result classification |

### 2.4 Required from v0.15.2a-c (Acrobatics Systems)

| Component | Location | Usage in v0.15.2e |
|-----------|----------|-------------------|
| `IClimbingService` | `Application/Interfaces/IClimbingService.cs` | Climb obstacle type checks |
| `ILeapService` | `Application/Interfaces/ILeapService.cs` | Gap obstacle type checks |

### 2.5 Provides to Future Versions

| Version | Component | Usage |
|---------|-----------|-------|
| v0.15.2g | Gantry-Runner | `[Death-Defying Leap]`, `[Wall-Run]` chase abilities |
| v0.11.x | Combat System | Chase initiation from combat flee actions |
| v0.16.x | Encounter System | Chase encounter type integration |

---

## 3. Architecture Diagrams

### 3.1 Chase Sequence Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CHASE SEQUENCE FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CHASE INITIATION                                                           │
│  Trigger: flee command, combat escape, or narrative event                   │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    START CHASE                                      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  ChaseService.StartChase(fleeingId, pursuerId, startDistance)       │    │
│  │                                                                      │    │
│  │  ChaseState Created:                                                 │    │
│  │  ├── ChaseId: "chase-001"                                           │    │
│  │  ├── FleeingId: "player-1"                                          │    │
│  │  ├── PursuerId: "guard-1"                                           │    │
│  │  ├── Distance: 3 (starting position)                                │    │
│  │  ├── ObstacleHistory: []                                            │    │
│  │  ├── RoundNumber: 0                                                 │    │
│  │  ├── Status: InProgress                                             │    │
│  │  └── MaxRounds: null (no limit)                                     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ROUND LOOP                                       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  WHILE Status == InProgress:                                        │    │
│  │                                                                      │    │
│  │  1. Generate Obstacle                                               │    │
│  │     └── ChaseService.GenerateObstacle(state)                        │    │
│  │                                                                      │    │
│  │  2. Both Participants Attempt Obstacle                              │    │
│  │     └── ChaseService.ProcessRound(chaseId, fleeAttempt, pursueAttempt) │ │
│  │                                                                      │    │
│  │  3. Update Distance Based on Results                                │    │
│  │     ├── Fleeing Success: Distance +1                                │    │
│  │     ├── Fleeing Failure: Distance -1                                │    │
│  │     ├── Fleeing Critical: Distance +2                               │    │
│  │     ├── Pursuer Success: Distance -1                                │    │
│  │     ├── Pursuer Failure: Distance +1                                │    │
│  │     └── Pursuer Critical: Distance -2                               │    │
│  │                                                                      │    │
│  │  4. Check End Conditions                                            │    │
│  │     ├── Distance ≤ 0: Status = Caught                               │    │
│  │     ├── Distance ≥ 6: Status = Escaped                              │    │
│  │     └── MaxRounds reached: Status = TimedOut                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    CHASE RESOLUTION                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  CAUGHT (Distance ≤ 0):                                             │    │
│  │  └── Pursuer catches fleeing character                              │    │
│  │      └── Combat resumes or narrative consequence                    │    │
│  │                                                                      │    │
│  │  ESCAPED (Distance ≥ 6):                                            │    │
│  │  └── Fleeing character escapes successfully                         │    │
│  │      └── Pursuer loses track                                        │    │
│  │                                                                      │    │
│  │  ABANDONED:                                                         │    │
│  │  └── Either participant gives up the chase                          │    │
│  │      └── AbandonChase(chaseId, byCharacterId)                       │    │
│  │                                                                      │    │
│  │  TIMED OUT:                                                         │    │
│  │  └── MaxRounds reached without resolution                           │    │
│  │      └── Narrative determines outcome                               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Distance Track Visualization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CHASE DISTANCE TRACK                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  DISTANCE POSITIONS:                                                        │
│                                                                              │
│     0        1        2        3        4        5        6+                │
│     │        │        │        │        │        │        │                 │
│     ▼        ▼        ▼        ▼        ▼        ▼        ▼                 │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │
│  │CATCH│ │CLOSE│ │CLOSE│ │NEAR │ │ FAR │ │ FAR │ │LOST │                   │
│  │  ED │ │     │ │     │ │     │ │     │ │     │ │     │                   │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                   │
│     ▲                       ▲                       ▲                       │
│     │                       │                       │                       │
│  Pursuer                 Starting              Fleeing                      │
│  catches               Position 3             escapes                       │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  POSITION ZONES:                                                            │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CLOSE (0-1)                                                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  • Pursuer can attempt to capture                                   │    │
│  │  • Fleeing character is in immediate danger                         │    │
│  │  • Position 0: Chase ends, caught                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  NEAR (2-3)                                                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  • Within striking distance                                         │    │
│  │  • Chase is contested                                               │    │
│  │  • Default starting position: 3                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  FAR (4-5)                                                          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  • Fleeing character is safe for now                                │    │
│  │  • Pursuer is losing ground                                         │    │
│  │  • One more success to escape                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  LOST (6+)                                                          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  • Chase ends, fleeing character escapes                            │    │
│  │  • Pursuer has lost the trail                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Obstacle Check Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OBSTACLE CHECK FLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  OBSTACLE GENERATED                                                         │
│  ChaseObstacle:                                                             │
│  ├── Type: Gap                                                              │
│  ├── SkillRequired: Acrobatics                                              │
│  ├── Dc: 3 successes                                                        │
│  ├── SuccessEffect: "Clear the gap smoothly"                                │
│  └── FailureEffect: "Stumble at the edge"                                   │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    FLEEING CHARACTER ATTEMPT                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Pool: 6d10 (Acrobatics 3 + Finesse 3)                              │    │
│  │  Roll: [10, 8, 4, 9, 2, 7] → 3 successes                            │    │
│  │  vs DC 3                                                            │    │
│  │                                                                      │    │
│  │  Margin: 3 - 3 = 0 (success)                                        │    │
│  │  Distance Change: +1 (success increases distance)                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    PURSUER CHARACTER ATTEMPT                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Pool: 5d10 (Acrobatics 2 + Finesse 3)                              │    │
│  │  Roll: [3, 6, 8, 5, 10] → 2 successes                               │    │
│  │  vs DC 3                                                            │    │
│  │                                                                      │    │
│  │  Margin: 2 - 3 = -1 (failure)                                       │    │
│  │  Distance Change: +1 (pursuer failure increases distance)           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ROUND RESULT                                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  ChaseRoundResult:                                                  │    │
│  │  ├── RoundNumber: 1                                                 │    │
│  │  ├── Obstacle: Gap (DC 3)                                           │    │
│  │  ├── FleeingOutcome: Success (+1)                                   │    │
│  │  ├── PursuerOutcome: Failure (+1)                                   │    │
│  │  ├── DistanceChange: +2 (net)                                       │    │
│  │  ├── NewDistance: 5                                                 │    │
│  │  └── ChaseStatus: InProgress                                        │    │
│  │                                                                      │    │
│  │  MESSAGE: "You vault the gap cleanly while the guard stumbles       │    │
│  │           at the edge. You're pulling ahead!"                       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  CRITICAL SUCCESS (5+ successes above DC):                                  │
│  └── Distance change doubled: +2 for fleeing, -2 for pursuer               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CHASE SYSTEM LAYER ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                             │    │
│  │  ├── ChaseStatus.cs                    ←── NEW                      │    │
│  │  └── ObstacleType.cs                   ←── NEW                      │    │
│  │                                                                      │    │
│  │  Entities/                                                          │    │
│  │  └── ChaseState.cs                     ←── NEW                      │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                      │    │
│  │  ├── ChaseObstacle.cs                  ←── NEW                      │    │
│  │  └── ChaseRoundResult.cs               ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    APPLICATION LAYER                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Interfaces/                                                        │    │
│  │  └── IChaseService.cs                  ←── NEW                      │    │
│  │                                                                      │    │
│  │  Services/                                                          │    │
│  │  └── ChaseService.cs                   ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ uses                                      │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  INFRASTRUCTURE LAYER                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                     │    │
│  │  ├── chase-obstacles.json              ←── NEW                      │    │
│  │  └── chase-obstacles.schema.json       ←── NEW                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EXTERNAL DEPENDENCIES:                                                     │
│  ├── IDiceRollerService       (from v0.15.0)                               │
│  ├── SkillContext             (from v0.15.1a)                              │
│  ├── IClimbingService         (from v0.15.2a)                              │
│  └── ILeapService             (from v0.15.2b)                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ChaseStatus Enum

### 4.1 Definition

```csharp
namespace Rune.Domain.Enums;

/// <summary>
/// Represents the possible outcomes and states of a chase encounter.
/// </summary>
/// <remarks>
/// A chase begins in InProgress and ends when one of the terminal states
/// (Caught, Escaped, Abandoned, TimedOut) is reached. The status determines
/// what actions are available and how the chase should be resolved narratively.
/// </remarks>
public enum ChaseStatus
{
    /// <summary>
    /// The chase is ongoing. Both participants are still actively involved.
    /// </summary>
    /// <remarks>
    /// While InProgress, rounds continue to be processed and obstacles generated.
    /// Distance changes affect the outcome until a terminal state is reached.
    /// </remarks>
    InProgress = 0,

    /// <summary>
    /// The fleeing character has been caught. Distance reached 0 or below.
    /// </summary>
    /// <remarks>
    /// The pursuer has successfully closed the gap completely. Combat may resume
    /// or narrative consequences apply. The fleeing character cannot escape
    /// without a new opportunity.
    /// </remarks>
    Caught = 1,

    /// <summary>
    /// The fleeing character has escaped. Distance reached 6 or above.
    /// </summary>
    /// <remarks>
    /// The fleeing character has successfully evaded pursuit. The pursuer has
    /// lost the trail and cannot continue the chase without new information
    /// about the target's location.
    /// </remarks>
    Escaped = 2,

    /// <summary>
    /// One of the participants voluntarily abandoned the chase.
    /// </summary>
    /// <remarks>
    /// Either the pursuer gave up pursuit or the fleeing character stopped running.
    /// The chase ends without a definitive caught/escaped resolution.
    /// </remarks>
    Abandoned = 3,

    /// <summary>
    /// The chase exceeded its maximum round limit without resolution.
    /// </summary>
    /// <remarks>
    /// Only applies when MaxRounds is set on the ChaseState. The narrative
    /// context determines the outcome (e.g., fleeing character escapes by
    /// default, or situation changes).
    /// </remarks>
    TimedOut = 4
}
```

### 4.2 Usage Context

| Status | Distance | Trigger | Narrative Outcome |
|--------|----------|---------|-------------------|
| `InProgress` | 1-5 | Initial state | Chase continues |
| `Caught` | ≤ 0 | Distance drops to 0 | Pursuer catches target |
| `Escaped` | ≥ 6 | Distance reaches 6+ | Target escapes cleanly |
| `Abandoned` | Any | Explicit abandon call | Chase ends inconclusively |
| `TimedOut` | Any | MaxRounds reached | Narrative resolution |

---

## 5. ObstacleType Enum

### 5.1 Definition

```csharp
namespace Rune.Domain.Enums;

/// <summary>
/// Categorizes the types of obstacles that can appear during a chase sequence.
/// </summary>
/// <remarks>
/// Each obstacle type maps to a specific skill check. The environment and
/// context determine which obstacle types are available for generation.
/// Obstacle types integrate with existing acrobatics systems where applicable.
/// </remarks>
public enum ObstacleType
{
    /// <summary>
    /// A gap that must be leaped across. Uses Acrobatics (leap) check.
    /// </summary>
    /// <remarks>
    /// Examples: rooftop gaps, broken bridges, chasms.
    /// Integrates with ILeapService for check resolution.
    /// DC typically 2-4 successes based on gap width.
    /// </remarks>
    Gap = 0,

    /// <summary>
    /// A vertical surface that must be climbed. Uses Acrobatics (climb) check.
    /// </summary>
    /// <remarks>
    /// Examples: walls, fences, scaffolding.
    /// Integrates with IClimbingService for check resolution.
    /// DC typically 2-4 successes based on surface difficulty.
    /// </remarks>
    Climb = 1,

    /// <summary>
    /// Scattered debris that must be navigated. Uses Acrobatics (balance) check.
    /// </summary>
    /// <remarks>
    /// Examples: rubble, broken glass, fallen crates.
    /// Requires careful footing to traverse quickly.
    /// DC typically 2-3 successes.
    /// </remarks>
    Debris = 2,

    /// <summary>
    /// A crowd or group of obstacles to weave through. Uses Acrobatics (dodge) check.
    /// </summary>
    /// <remarks>
    /// Examples: marketplace crowds, fleeing civilians, patrol groups.
    /// Tests ability to maneuver through moving obstacles.
    /// DC typically 3-4 successes in dense crowds.
    /// </remarks>
    Crowd = 3,

    /// <summary>
    /// An environmental hazard to avoid. Uses Acrobatics (avoid) check.
    /// </summary>
    /// <remarks>
    /// Examples: steam vents, electrified floors, collapsing structures.
    /// Represents dangers that must be evaded rather than traversed.
    /// DC varies widely (2-5) based on hazard severity.
    /// </remarks>
    Hazard = 4
}
```

### 5.2 Obstacle Skill Mapping

| Type | Primary Skill | Check Type | Base DC Range |
|------|---------------|------------|---------------|
| `Gap` | Acrobatics | Leap | 2-4 successes |
| `Climb` | Acrobatics | Climb | 2-4 successes |
| `Debris` | Acrobatics | Balance | 2-3 successes |
| `Crowd` | Acrobatics | Dodge | 3-4 successes |
| `Hazard` | Acrobatics | Avoid | 2-5 successes |

---

## 6. ChaseObstacle Value Object

### 6.1 Definition

```csharp
namespace Rune.Domain.ValueObjects;

using Rune.Domain.Enums;

/// <summary>
/// Represents an obstacle encountered during a chase sequence that both
/// participants must attempt to overcome.
/// </summary>
/// <remarks>
/// Obstacles are generated dynamically each round based on the environment
/// and chase context. Both the fleeing character and pursuer must make
/// skill checks against the same obstacle, with outcomes affecting distance.
/// </remarks>
/// <param name="ObstacleType">The category of obstacle.</param>
/// <param name="SkillRequired">The skill used for the check (typically Acrobatics).</param>
/// <param name="Dc">The DC in successes needed to overcome the obstacle.</param>
/// <param name="SuccessDescription">Narrative text for successful navigation.</param>
/// <param name="FailureDescription">Narrative text for failed navigation.</param>
/// <param name="EnvironmentTag">Optional tag indicating environment context.</param>
public readonly record struct ChaseObstacle(
    ObstacleType ObstacleType,
    string SkillRequired,
    int Dc,
    string SuccessDescription,
    string FailureDescription,
    string? EnvironmentTag = null)
{
    /// <summary>
    /// Gets the display name for this obstacle type.
    /// </summary>
    public string TypeName => ObstacleType switch
    {
        ObstacleType.Gap => "Gap",
        ObstacleType.Climb => "Climb",
        ObstacleType.Debris => "Debris",
        ObstacleType.Crowd => "Crowd",
        ObstacleType.Hazard => "Hazard",
        _ => "Unknown"
    };

    /// <summary>
    /// Determines if this obstacle requires special handling from an
    /// existing acrobatics service (climb, leap).
    /// </summary>
    public bool RequiresSpecializedService => ObstacleType is
        ObstacleType.Gap or ObstacleType.Climb;

    /// <summary>
    /// Creates a display string for obstacle presentation.
    /// </summary>
    /// <returns>Formatted obstacle description for UI display.</returns>
    public string ToDisplayString() =>
        $"{TypeName} (DC {Dc}) - {SkillRequired}";

    /// <summary>
    /// Creates a Gap obstacle with default parameters.
    /// </summary>
    /// <param name="dc">The DC in successes needed.</param>
    /// <param name="gapWidth">Optional gap width description.</param>
    /// <returns>A new Gap obstacle.</returns>
    public static ChaseObstacle CreateGap(int dc, string? gapWidth = null)
    {
        var width = gapWidth ?? $"{dc * 5} feet";
        return new ChaseObstacle(
            ObstacleType.Gap,
            "Acrobatics",
            dc,
            $"You clear the {width} gap with a powerful leap.",
            $"You misjudge the {width} gap and lose momentum.");
    }

    /// <summary>
    /// Creates a Climb obstacle with default parameters.
    /// </summary>
    /// <param name="dc">The DC in successes needed.</param>
    /// <param name="surface">Optional surface description.</param>
    /// <returns>A new Climb obstacle.</returns>
    public static ChaseObstacle CreateClimb(int dc, string? surface = null)
    {
        var desc = surface ?? "wall";
        return new ChaseObstacle(
            ObstacleType.Climb,
            "Acrobatics",
            dc,
            $"You scale the {desc} without breaking stride.",
            $"You slip on the {desc} and lose precious seconds.");
    }

    /// <summary>
    /// Creates a Debris obstacle with default parameters.
    /// </summary>
    /// <param name="dc">The DC in successes needed.</param>
    /// <param name="debris">Optional debris description.</param>
    /// <returns>A new Debris obstacle.</returns>
    public static ChaseObstacle CreateDebris(int dc, string? debris = null)
    {
        var desc = debris ?? "scattered rubble";
        return new ChaseObstacle(
            ObstacleType.Debris,
            "Acrobatics",
            dc,
            $"You weave through the {desc} with nimble footwork.",
            $"The {desc} trips you up momentarily.");
    }

    /// <summary>
    /// Creates a Crowd obstacle with default parameters.
    /// </summary>
    /// <param name="dc">The DC in successes needed.</param>
    /// <param name="crowd">Optional crowd description.</param>
    /// <returns>A new Crowd obstacle.</returns>
    public static ChaseObstacle CreateCrowd(int dc, string? crowd = null)
    {
        var desc = crowd ?? "panicking civilians";
        return new ChaseObstacle(
            ObstacleType.Crowd,
            "Acrobatics",
            dc,
            $"You slip through the {desc} like water.",
            $"The {desc} slow you down as you push through.");
    }

    /// <summary>
    /// Creates a Hazard obstacle with default parameters.
    /// </summary>
    /// <param name="dc">The DC in successes needed.</param>
    /// <param name="hazard">Optional hazard description.</param>
    /// <returns>A new Hazard obstacle.</returns>
    public static ChaseObstacle CreateHazard(int dc, string? hazard = null)
    {
        var desc = hazard ?? "steam vent";
        return new ChaseObstacle(
            ObstacleType.Hazard,
            "Acrobatics",
            dc,
            $"You dodge the {desc} with split-second timing.",
            $"The {desc} forces you to take a longer route.");
    }
}
```

### 6.2 Factory Method Examples

```csharp
// Create obstacles from configuration
var gap = ChaseObstacle.CreateGap(dc: 3, gapWidth: "15 feet");
var climb = ChaseObstacle.CreateClimb(dc: 2, surface: "chain-link fence");
var debris = ChaseObstacle.CreateDebris(dc: 2, debris: "overturned market stalls");
var crowd = ChaseObstacle.CreateCrowd(dc: 4, crowd: "rush hour commuters");
var hazard = ChaseObstacle.CreateHazard(dc: 3, hazard: "exposed electrical cables");
```

---

## 7. ChaseRoundResult Value Object

### 7.1 Definition

```csharp
namespace Rune.Domain.ValueObjects;

using Rune.Domain.Enums;

/// <summary>
/// Captures the complete outcome of a single chase round, including both
/// participants' obstacle attempts and the resulting distance change.
/// </summary>
/// <remarks>
/// Each chase round consists of an obstacle generated, both participants
/// attempting to overcome it, and distance adjustments based on their results.
/// This value object provides all information needed to narrate the round
/// and update the chase state.
/// </remarks>
/// <param name="RoundNumber">The sequential round number (1-based).</param>
/// <param name="Obstacle">The obstacle both participants attempted.</param>
/// <param name="FleeingRoll">The fleeing character's dice roll result.</param>
/// <param name="FleeingOutcome">The fleeing character's check outcome.</param>
/// <param name="FleeingDistanceChange">Distance change from fleeing result.</param>
/// <param name="PursuerRoll">The pursuer's dice roll result.</param>
/// <param name="PursuerOutcome">The pursuer's check outcome.</param>
/// <param name="PursuerDistanceChange">Distance change from pursuer result.</param>
/// <param name="PreviousDistance">Distance before this round.</param>
/// <param name="NewDistance">Distance after this round.</param>
/// <param name="ChaseStatus">The chase status after this round.</param>
public readonly record struct ChaseRoundResult(
    int RoundNumber,
    ChaseObstacle Obstacle,
    DiceRollResult FleeingRoll,
    SkillOutcome FleeingOutcome,
    int FleeingDistanceChange,
    DiceRollResult PursuerRoll,
    SkillOutcome PursuerOutcome,
    int PursuerDistanceChange,
    int PreviousDistance,
    int NewDistance,
    ChaseStatus ChaseStatus)
{
    /// <summary>
    /// Gets the net distance change this round (positive = fleeing gained ground).
    /// </summary>
    public int NetDistanceChange => NewDistance - PreviousDistance;

    /// <summary>
    /// Indicates whether the chase ended this round.
    /// </summary>
    public bool IsChaseEnded => ChaseStatus is not ChaseStatus.InProgress;

    /// <summary>
    /// Indicates whether the fleeing character escaped this round.
    /// </summary>
    public bool FleeingEscaped => ChaseStatus == ChaseStatus.Escaped;

    /// <summary>
    /// Indicates whether the fleeing character was caught this round.
    /// </summary>
    public bool FleeingCaught => ChaseStatus == ChaseStatus.Caught;

    /// <summary>
    /// Determines if the fleeing character won this round (gained ground).
    /// </summary>
    public bool FleeingWonRound => NetDistanceChange > 0;

    /// <summary>
    /// Determines if the pursuer won this round (closed gap).
    /// </summary>
    public bool PursuerWonRound => NetDistanceChange < 0;

    /// <summary>
    /// Creates a display string summarizing the round outcome.
    /// </summary>
    /// <returns>Formatted round summary for UI display.</returns>
    public string ToDisplayString()
    {
        var change = NetDistanceChange switch
        {
            > 0 => $"+{NetDistanceChange} (pulling ahead)",
            < 0 => $"{NetDistanceChange} (pursuer closing)",
            _ => "0 (neck and neck)"
        };

        return $"Round {RoundNumber}: {Obstacle.TypeName} - Distance {change} → {NewDistance}";
    }

    /// <summary>
    /// Gets a narrative description of the round outcome.
    /// </summary>
    /// <param name="fleeingName">Name of the fleeing character.</param>
    /// <param name="pursuerName">Name of the pursuer.</param>
    /// <returns>Narrative text describing what happened.</returns>
    public string GetNarrative(string fleeingName, string pursuerName)
    {
        var fleeingResult = FleeingOutcome >= SkillOutcome.Success
            ? Obstacle.SuccessDescription
            : Obstacle.FailureDescription;

        var pursuerResult = PursuerOutcome >= SkillOutcome.Success
            ? $"{pursuerName} clears the obstacle."
            : $"{pursuerName} struggles with the obstacle.";

        var distance = ChaseStatus switch
        {
            ChaseStatus.Caught => $"{pursuerName} catches {fleeingName}!",
            ChaseStatus.Escaped => $"{fleeingName} escapes into the shadows!",
            _ when NetDistanceChange > 0 => $"{fleeingName} pulls ahead!",
            _ when NetDistanceChange < 0 => $"{pursuerName} closes the gap!",
            _ => "They remain neck and neck!"
        };

        return $"{fleeingResult} {pursuerResult} {distance}";
    }
}
```

---

## 8. ChaseState Entity

### 8.1 Definition

```csharp
namespace Rune.Domain.Entities;

using Rune.Domain.Enums;
using Rune.Domain.ValueObjects;

/// <summary>
/// Represents the complete state of an active or completed chase encounter.
/// </summary>
/// <remarks>
/// ChaseState is an entity that tracks all aspects of a chase: participants,
/// distance, obstacle history, and outcome. It maintains invariants such as
/// distance bounds and proper status transitions. The entity is mutable to
/// allow round-by-round updates during chase resolution.
/// </remarks>
public class ChaseState
{
    /// <summary>
    /// Gets the unique identifier for this chase encounter.
    /// </summary>
    public string ChaseId { get; private set; }

    /// <summary>
    /// Gets the ID of the character attempting to flee.
    /// </summary>
    public string FleeingId { get; private set; }

    /// <summary>
    /// Gets the ID of the character pursuing.
    /// </summary>
    public string PursuerId { get; private set; }

    /// <summary>
    /// Gets the current distance on the chase track (0-6+).
    /// </summary>
    /// <remarks>
    /// Distance 0 or below means caught, distance 6 or above means escaped.
    /// Default starting position is 3 (Near zone).
    /// </remarks>
    public int Distance { get; private set; }

    /// <summary>
    /// Gets the history of obstacles encountered during this chase.
    /// </summary>
    public IReadOnlyList<ChaseObstacle> ObstacleHistory => _obstacleHistory.AsReadOnly();
    private readonly List<ChaseObstacle> _obstacleHistory;

    /// <summary>
    /// Gets the history of round results.
    /// </summary>
    public IReadOnlyList<ChaseRoundResult> RoundHistory => _roundHistory.AsReadOnly();
    private readonly List<ChaseRoundResult> _roundHistory;

    /// <summary>
    /// Gets the current round number (0 before first round, 1+ during chase).
    /// </summary>
    public int RoundNumber { get; private set; }

    /// <summary>
    /// Gets the current chase status.
    /// </summary>
    public ChaseStatus Status { get; private set; }

    /// <summary>
    /// Gets the optional maximum round limit for this chase.
    /// </summary>
    /// <remarks>
    /// If set and RoundNumber reaches MaxRounds without resolution,
    /// Status transitions to TimedOut.
    /// </remarks>
    public int? MaxRounds { get; private set; }

    /// <summary>
    /// Gets the ID of the character who abandoned the chase, if applicable.
    /// </summary>
    public string? AbandonedById { get; private set; }

    /// <summary>
    /// Gets when the chase started.
    /// </summary>
    public DateTime StartedAt { get; private set; }

    /// <summary>
    /// Gets when the chase ended, if it has ended.
    /// </summary>
    public DateTime? EndedAt { get; private set; }

    // Private constructor for EF Core
    private ChaseState()
    {
        ChaseId = string.Empty;
        FleeingId = string.Empty;
        PursuerId = string.Empty;
        _obstacleHistory = new List<ChaseObstacle>();
        _roundHistory = new List<ChaseRoundResult>();
    }

    /// <summary>
    /// Creates a new chase encounter.
    /// </summary>
    /// <param name="chaseId">Unique identifier for this chase.</param>
    /// <param name="fleeingId">ID of the fleeing character.</param>
    /// <param name="pursuerId">ID of the pursuing character.</param>
    /// <param name="startDistance">Starting position on distance track (default 3).</param>
    /// <param name="maxRounds">Optional maximum round limit.</param>
    /// <returns>A new ChaseState instance.</returns>
    /// <exception cref="ArgumentException">If IDs are invalid or startDistance out of range.</exception>
    public static ChaseState Create(
        string chaseId,
        string fleeingId,
        string pursuerId,
        int startDistance = 3,
        int? maxRounds = null)
    {
        if (string.IsNullOrWhiteSpace(chaseId))
            throw new ArgumentException("Chase ID cannot be empty.", nameof(chaseId));

        if (string.IsNullOrWhiteSpace(fleeingId))
            throw new ArgumentException("Fleeing ID cannot be empty.", nameof(fleeingId));

        if (string.IsNullOrWhiteSpace(pursuerId))
            throw new ArgumentException("Pursuer ID cannot be empty.", nameof(pursuerId));

        if (fleeingId == pursuerId)
            throw new ArgumentException("Fleeing and pursuer cannot be the same character.");

        if (startDistance < 1 || startDistance > 5)
            throw new ArgumentOutOfRangeException(nameof(startDistance),
                "Start distance must be between 1 and 5.");

        if (maxRounds.HasValue && maxRounds.Value < 1)
            throw new ArgumentOutOfRangeException(nameof(maxRounds),
                "Max rounds must be at least 1.");

        return new ChaseState
        {
            ChaseId = chaseId,
            FleeingId = fleeingId,
            PursuerId = pursuerId,
            Distance = startDistance,
            _obstacleHistory = { },
            _roundHistory = { },
            RoundNumber = 0,
            Status = ChaseStatus.InProgress,
            MaxRounds = maxRounds,
            StartedAt = DateTime.UtcNow
        };
    }

    /// <summary>
    /// Records an obstacle for the current round.
    /// </summary>
    /// <param name="obstacle">The obstacle to add to history.</param>
    /// <exception cref="InvalidOperationException">If chase is not in progress.</exception>
    public void AddObstacle(ChaseObstacle obstacle)
    {
        if (Status != ChaseStatus.InProgress)
            throw new InvalidOperationException("Cannot add obstacles to a completed chase.");

        _obstacleHistory.Add(obstacle);
    }

    /// <summary>
    /// Processes the results of a chase round and updates state.
    /// </summary>
    /// <param name="fleeingDistanceChange">Distance change from fleeing result.</param>
    /// <param name="pursuerDistanceChange">Distance change from pursuer result.</param>
    /// <param name="roundResult">The complete round result to record.</param>
    /// <exception cref="InvalidOperationException">If chase is not in progress.</exception>
    public void ProcessRoundResult(
        int fleeingDistanceChange,
        int pursuerDistanceChange,
        ChaseRoundResult roundResult)
    {
        if (Status != ChaseStatus.InProgress)
            throw new InvalidOperationException("Cannot process rounds for a completed chase.");

        RoundNumber++;
        Distance += fleeingDistanceChange + pursuerDistanceChange;
        _roundHistory.Add(roundResult);

        UpdateStatus();
    }

    /// <summary>
    /// Marks the chase as abandoned by the specified character.
    /// </summary>
    /// <param name="characterId">ID of the character abandoning.</param>
    /// <exception cref="InvalidOperationException">If chase is not in progress.</exception>
    /// <exception cref="ArgumentException">If character is not a participant.</exception>
    public void Abandon(string characterId)
    {
        if (Status != ChaseStatus.InProgress)
            throw new InvalidOperationException("Cannot abandon a completed chase.");

        if (characterId != FleeingId && characterId != PursuerId)
            throw new ArgumentException("Only chase participants can abandon.", nameof(characterId));

        AbandonedById = characterId;
        Status = ChaseStatus.Abandoned;
        EndedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Gets the current zone description based on distance.
    /// </summary>
    /// <returns>Zone name (Close, Near, Far, or Lost).</returns>
    public string GetCurrentZone() => Distance switch
    {
        <= 0 => "Caught",
        <= 1 => "Close",
        <= 3 => "Near",
        <= 5 => "Far",
        _ => "Lost"
    };

    /// <summary>
    /// Determines if the pursuer can attempt capture (at distance 0-1).
    /// </summary>
    public bool CanAttemptCapture => Distance <= 1 && Status == ChaseStatus.InProgress;

    /// <summary>
    /// Determines if the fleeing character is close to escape (at distance 5).
    /// </summary>
    public bool NearEscape => Distance == 5 && Status == ChaseStatus.InProgress;

    /// <summary>
    /// Updates the chase status based on current distance and round count.
    /// </summary>
    private void UpdateStatus()
    {
        if (Distance <= 0)
        {
            Status = ChaseStatus.Caught;
            EndedAt = DateTime.UtcNow;
        }
        else if (Distance >= 6)
        {
            Status = ChaseStatus.Escaped;
            EndedAt = DateTime.UtcNow;
        }
        else if (MaxRounds.HasValue && RoundNumber >= MaxRounds.Value)
        {
            Status = ChaseStatus.TimedOut;
            EndedAt = DateTime.UtcNow;
        }
    }
}
```

---

## 9. IChaseService Interface

### 9.1 Definition

```csharp
namespace Rune.Application.Interfaces;

using Rune.Domain.Entities;
using Rune.Domain.ValueObjects;

/// <summary>
/// Defines operations for managing chase encounters.
/// </summary>
/// <remarks>
/// The chase service orchestrates chase sequences from initiation through
/// resolution. It generates obstacles, processes rounds, and determines
/// outcomes based on participant skill checks and distance tracking.
/// </remarks>
public interface IChaseService
{
    /// <summary>
    /// Initiates a new chase encounter between two characters.
    /// </summary>
    /// <param name="fleeingId">ID of the character attempting to flee.</param>
    /// <param name="pursuerId">ID of the character pursuing.</param>
    /// <param name="startDistance">Starting position on distance track (default 3).</param>
    /// <param name="maxRounds">Optional maximum round limit.</param>
    /// <returns>The newly created chase state.</returns>
    /// <exception cref="ArgumentException">If character IDs are invalid.</exception>
    ChaseState StartChase(
        string fleeingId,
        string pursuerId,
        int startDistance = 3,
        int? maxRounds = null);

    /// <summary>
    /// Generates an appropriate obstacle for the current chase round.
    /// </summary>
    /// <param name="state">The current chase state.</param>
    /// <param name="environmentTag">Optional environment context for obstacle selection.</param>
    /// <returns>A chase obstacle for both participants to attempt.</returns>
    /// <exception cref="InvalidOperationException">If chase is not in progress.</exception>
    ChaseObstacle GenerateObstacle(ChaseState state, string? environmentTag = null);

    /// <summary>
    /// Processes a complete chase round with both participants' attempts.
    /// </summary>
    /// <param name="chaseId">ID of the chase to process.</param>
    /// <param name="fleeingAttempts">Whether the fleeing character attempts the obstacle.</param>
    /// <param name="pursuerAttempts">Whether the pursuer attempts the obstacle.</param>
    /// <returns>The result of the round including distance changes and status.</returns>
    /// <exception cref="InvalidOperationException">If chase is not in progress or not found.</exception>
    ChaseRoundResult ProcessRound(
        string chaseId,
        bool fleeingAttempts = true,
        bool pursuerAttempts = true);

    /// <summary>
    /// Marks a chase as abandoned by the specified character.
    /// </summary>
    /// <param name="chaseId">ID of the chase to abandon.</param>
    /// <param name="byCharacterId">ID of the character abandoning.</param>
    /// <exception cref="InvalidOperationException">If chase is not in progress or not found.</exception>
    /// <exception cref="ArgumentException">If character is not a participant.</exception>
    void AbandonChase(string chaseId, string byCharacterId);

    /// <summary>
    /// Gets the current state of a chase encounter.
    /// </summary>
    /// <param name="chaseId">ID of the chase to retrieve.</param>
    /// <returns>The chase state, or null if not found.</returns>
    ChaseState? GetChase(string chaseId);

    /// <summary>
    /// Gets all active (in progress) chase encounters.
    /// </summary>
    /// <returns>Collection of active chase states.</returns>
    IReadOnlyList<ChaseState> GetActiveChases();
}
```

---

## 10. ChaseService Implementation

### 10.1 Definition

```csharp
namespace Rune.Application.Services;

using Microsoft.Extensions.Logging;
using Rune.Application.Interfaces;
using Rune.Domain.Entities;
using Rune.Domain.Enums;
using Rune.Domain.ValueObjects;

/// <summary>
/// Implements chase encounter management including obstacle generation,
/// round processing, and chase resolution.
/// </summary>
/// <remarks>
/// The ChaseService maintains a registry of active chases and orchestrates
/// the round-by-round resolution of chase encounters. It integrates with
/// the dice system for skill checks and the acrobatics services for
/// specialized obstacle types.
/// </remarks>
public class ChaseService : IChaseService
{
    private readonly IDiceRollerService _diceRoller;
    private readonly ICharacterService _characterService;
    private readonly IChaseObstacleProvider _obstacleProvider;
    private readonly ILogger<ChaseService> _logger;

    private readonly Dictionary<string, ChaseState> _activeChases;
    private int _nextChaseId;

    /// <summary>
    /// Initializes a new instance of the ChaseService.
    /// </summary>
    /// <param name="diceRoller">Service for performing dice rolls.</param>
    /// <param name="characterService">Service for accessing character data.</param>
    /// <param name="obstacleProvider">Provider for obstacle configurations.</param>
    /// <param name="logger">Logger for diagnostics.</param>
    public ChaseService(
        IDiceRollerService diceRoller,
        ICharacterService characterService,
        IChaseObstacleProvider obstacleProvider,
        ILogger<ChaseService> logger)
    {
        _diceRoller = diceRoller ?? throw new ArgumentNullException(nameof(diceRoller));
        _characterService = characterService ?? throw new ArgumentNullException(nameof(characterService));
        _obstacleProvider = obstacleProvider ?? throw new ArgumentNullException(nameof(obstacleProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));

        _activeChases = new Dictionary<string, ChaseState>();
        _nextChaseId = 1;
    }

    /// <inheritdoc />
    public ChaseState StartChase(
        string fleeingId,
        string pursuerId,
        int startDistance = 3,
        int? maxRounds = null)
    {
        var chaseId = $"chase-{_nextChaseId++:D4}";

        var chase = ChaseState.Create(
            chaseId,
            fleeingId,
            pursuerId,
            startDistance,
            maxRounds);

        _activeChases[chaseId] = chase;

        _logger.LogInformation(
            "Chase {ChaseId} started: {FleeingId} fleeing from {PursuerId}, distance {Distance}",
            chaseId, fleeingId, pursuerId, startDistance);

        return chase;
    }

    /// <inheritdoc />
    public ChaseObstacle GenerateObstacle(ChaseState state, string? environmentTag = null)
    {
        if (state.Status != ChaseStatus.InProgress)
            throw new InvalidOperationException("Cannot generate obstacles for a completed chase.");

        // Get available obstacles for environment
        var availableObstacles = _obstacleProvider.GetObstaclesForEnvironment(environmentTag);

        // Select based on round progression and variety
        var obstacle = SelectObstacle(availableObstacles, state.ObstacleHistory);

        state.AddObstacle(obstacle);

        _logger.LogDebug(
            "Chase {ChaseId} round {Round}: Generated {ObstacleType} obstacle (DC {Dc})",
            state.ChaseId, state.RoundNumber + 1, obstacle.ObstacleType, obstacle.Dc);

        return obstacle;
    }

    /// <inheritdoc />
    public ChaseRoundResult ProcessRound(
        string chaseId,
        bool fleeingAttempts = true,
        bool pursuerAttempts = true)
    {
        if (!_activeChases.TryGetValue(chaseId, out var chase))
            throw new InvalidOperationException($"Chase {chaseId} not found.");

        if (chase.Status != ChaseStatus.InProgress)
            throw new InvalidOperationException($"Chase {chaseId} is not in progress.");

        // Get the current obstacle (most recently added)
        var obstacle = chase.ObstacleHistory.Last();

        // Get character info
        var fleeing = _characterService.GetCharacter(chase.FleeingId);
        var pursuer = _characterService.GetCharacter(chase.PursuerId);

        // Process fleeing character's attempt
        var (fleeingRoll, fleeingOutcome, fleeingDistanceChange) = ProcessObstacleAttempt(
            fleeing, obstacle, fleeingAttempts, isFleeingCharacter: true);

        // Process pursuer's attempt
        var (pursuerRoll, pursuerOutcome, pursuerDistanceChange) = ProcessObstacleAttempt(
            pursuer, obstacle, pursuerAttempts, isFleeingCharacter: false);

        // Calculate new distance
        var previousDistance = chase.Distance;
        var newDistance = previousDistance + fleeingDistanceChange + pursuerDistanceChange;
        newDistance = Math.Clamp(newDistance, 0, 10); // Allow going past 6 for clarity

        // Determine status after this round
        var newStatus = DetermineStatus(chase, newDistance);

        // Create round result
        var roundResult = new ChaseRoundResult(
            RoundNumber: chase.RoundNumber + 1,
            Obstacle: obstacle,
            FleeingRoll: fleeingRoll,
            FleeingOutcome: fleeingOutcome,
            FleeingDistanceChange: fleeingDistanceChange,
            PursuerRoll: pursuerRoll,
            PursuerOutcome: pursuerOutcome,
            PursuerDistanceChange: pursuerDistanceChange,
            PreviousDistance: previousDistance,
            NewDistance: newDistance,
            ChaseStatus: newStatus);

        // Update chase state
        chase.ProcessRoundResult(fleeingDistanceChange, pursuerDistanceChange, roundResult);

        // Remove from active chases if completed
        if (chase.Status != ChaseStatus.InProgress)
        {
            _logger.LogInformation(
                "Chase {ChaseId} ended with status {Status} after {Rounds} rounds",
                chaseId, chase.Status, chase.RoundNumber);
        }

        return roundResult;
    }

    /// <inheritdoc />
    public void AbandonChase(string chaseId, string byCharacterId)
    {
        if (!_activeChases.TryGetValue(chaseId, out var chase))
            throw new InvalidOperationException($"Chase {chaseId} not found.");

        chase.Abandon(byCharacterId);

        _logger.LogInformation(
            "Chase {ChaseId} abandoned by {CharacterId}",
            chaseId, byCharacterId);
    }

    /// <inheritdoc />
    public ChaseState? GetChase(string chaseId)
    {
        return _activeChases.TryGetValue(chaseId, out var chase) ? chase : null;
    }

    /// <inheritdoc />
    public IReadOnlyList<ChaseState> GetActiveChases()
    {
        return _activeChases.Values
            .Where(c => c.Status == ChaseStatus.InProgress)
            .ToList()
            .AsReadOnly();
    }

    /// <summary>
    /// Processes a single character's obstacle attempt.
    /// </summary>
    private (DiceRollResult Roll, SkillOutcome Outcome, int DistanceChange) ProcessObstacleAttempt(
        Character character,
        ChaseObstacle obstacle,
        bool attempts,
        bool isFleeingCharacter)
    {
        if (!attempts)
        {
            // Character doesn't attempt - automatic failure
            return (DiceRollResult.Empty, SkillOutcome.Failure, isFleeingCharacter ? -1 : 1);
        }

        // Build dice pool
        var acrobaticsRank = character.GetSkillRank("Acrobatics");
        var finesseAttribute = character.GetAttribute("Finesse");
        var poolSize = acrobaticsRank + finesseAttribute;

        // Roll dice
        var roll = _diceRoller.RollPool(poolSize);

        // Determine outcome
        var margin = roll.NetSuccesses - obstacle.Dc;
        var outcome = ClassifyOutcome(margin, roll);

        // Calculate distance change
        var distanceChange = CalculateDistanceChange(outcome, isFleeingCharacter);

        return (roll, outcome, distanceChange);
    }

    /// <summary>
    /// Classifies the skill outcome based on margin and roll properties.
    /// </summary>
    private SkillOutcome ClassifyOutcome(int margin, DiceRollResult roll)
    {
        if (roll.IsFumble)
            return SkillOutcome.Fumble;

        if (margin >= 5)
            return SkillOutcome.Critical;

        if (margin >= 0)
            return SkillOutcome.Success;

        return SkillOutcome.Failure;
    }

    /// <summary>
    /// Calculates distance change based on outcome and which character.
    /// </summary>
    private int CalculateDistanceChange(SkillOutcome outcome, bool isFleeingCharacter)
    {
        // For fleeing: success = +distance (getting away)
        // For pursuer: success = -distance (catching up)
        var baseChange = outcome switch
        {
            SkillOutcome.Critical => 2,  // Exceptional performance
            SkillOutcome.Success => 1,   // Standard success
            SkillOutcome.Failure => -1,  // Stumble
            SkillOutcome.Fumble => -2,   // Major mishap
            _ => 0
        };

        // Invert for pursuer (pursuer success decreases distance)
        return isFleeingCharacter ? baseChange : -baseChange;
    }

    /// <summary>
    /// Determines the chase status based on new distance.
    /// </summary>
    private ChaseStatus DetermineStatus(ChaseState chase, int newDistance)
    {
        if (newDistance <= 0)
            return ChaseStatus.Caught;

        if (newDistance >= 6)
            return ChaseStatus.Escaped;

        if (chase.MaxRounds.HasValue && chase.RoundNumber + 1 >= chase.MaxRounds.Value)
            return ChaseStatus.TimedOut;

        return ChaseStatus.InProgress;
    }

    /// <summary>
    /// Selects an obstacle avoiding recent repetition.
    /// </summary>
    private ChaseObstacle SelectObstacle(
        IReadOnlyList<ChaseObstacle> available,
        IReadOnlyList<ChaseObstacle> history)
    {
        // Avoid repeating the last 2 obstacle types
        var recentTypes = history
            .TakeLast(2)
            .Select(o => o.ObstacleType)
            .ToHashSet();

        var candidates = available
            .Where(o => !recentTypes.Contains(o.ObstacleType))
            .ToList();

        if (candidates.Count == 0)
            candidates = available.ToList();

        // Random selection from candidates
        var index = Random.Shared.Next(candidates.Count);
        return candidates[index];
    }
}
```

---

## 11. Distance Track System

### 11.1 Distance Positions

| Position | Zone | Description | Gameplay Effect |
|----------|------|-------------|-----------------|
| 0 | Caught | Pursuer has caught the target | Chase ends, pursuer wins |
| 1 | Close | Immediate danger | Pursuer can attempt capture actions |
| 2 | Near | Contested distance | Standard chase mechanics |
| 3 | Near | Default starting position | Standard chase mechanics |
| 4 | Far | Target pulling ahead | Pursuer losing ground |
| 5 | Far | Near escape | One more success to escape |
| 6+ | Lost | Target escaped | Chase ends, fleeing character wins |

### 11.2 Movement Rules

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DISTANCE MOVEMENT RULES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  FLEEING CHARACTER OUTCOMES:                                                │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ┌─────────────┬─────────────────┬─────────────────────────────────────┐    │
│  │  Outcome    │  Distance Δ     │  Description                        │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Critical   │  +2             │  Exceptional performance, gains     │    │
│  │  (5+ over)  │                 │  significant ground                 │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Success    │  +1             │  Clears obstacle, pulls ahead       │    │
│  │  (≥ DC)     │                 │                                     │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Failure    │  -1             │  Stumbles, pursuer gains ground     │    │
│  │  (< DC)     │                 │                                     │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Fumble     │  -2             │  Major mishap, pursuer closes       │    │
│  │  (0 + botch)│                 │  rapidly                            │    │
│  └─────────────┴─────────────────┴─────────────────────────────────────┘    │
│                                                                              │
│  PURSUER OUTCOMES:                                                          │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ┌─────────────┬─────────────────┬─────────────────────────────────────┐    │
│  │  Outcome    │  Distance Δ     │  Description                        │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Critical   │  -2             │  Exceptional pursuit, closes        │    │
│  │  (5+ over)  │                 │  rapidly                            │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Success    │  -1             │  Clears obstacle, gains ground      │    │
│  │  (≥ DC)     │                 │                                     │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Failure    │  +1             │  Stumbles, target pulls ahead       │    │
│  │  (< DC)     │                 │                                     │    │
│  ├─────────────┼─────────────────┼─────────────────────────────────────┤    │
│  │  Fumble     │  +2             │  Major mishap, loses significant    │    │
│  │  (0 + botch)│                 │  ground                             │    │
│  └─────────────┴─────────────────┴─────────────────────────────────────┘    │
│                                                                              │
│  NET DISTANCE CHANGE:                                                       │
│  ─────────────────────────────────────────────────────────────────────────  │
│  Both characters' results are combined each round.                          │
│                                                                              │
│  Example Round:                                                             │
│  • Fleeing: Success (+1)                                                    │
│  • Pursuer: Failure (+1)                                                    │
│  • Net Change: +2 (fleeing gains 2 positions)                               │
│                                                                              │
│  Example Round:                                                             │
│  • Fleeing: Failure (-1)                                                    │
│  • Pursuer: Critical (-2)                                                   │
│  • Net Change: -3 (pursuer closes 3 positions)                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. Configuration

### 12.1 chase-obstacles.json

```json
{
  "$schema": "./chase-obstacles.schema.json",
  "version": "1.0.0",
  "description": "Chase obstacle definitions for v0.15.2e",
  "defaultEnvironment": "urban",
  "environments": {
    "urban": {
      "name": "Urban Environment",
      "description": "City streets, rooftops, and alleys",
      "obstacles": [
        {
          "type": "Gap",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You vault the gap between buildings effortlessly.",
          "failureDescription": "You hesitate at the edge, losing precious momentum."
        },
        {
          "type": "Climb",
          "dc": 2,
          "skillRequired": "Acrobatics",
          "successDescription": "You scale the fire escape in seconds.",
          "failureDescription": "Your foot slips on the wet metal rungs."
        },
        {
          "type": "Debris",
          "dc": 2,
          "skillRequired": "Acrobatics",
          "successDescription": "You weave through the overturned market stalls.",
          "failureDescription": "You trip over scattered produce."
        },
        {
          "type": "Crowd",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You slip through the crowd like a ghost.",
          "failureDescription": "The crowd slows you down as you push through."
        },
        {
          "type": "Hazard",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You dodge the steam vent with perfect timing.",
          "failureDescription": "The scalding steam forces you to detour."
        }
      ]
    },
    "industrial": {
      "name": "Industrial Zone",
      "description": "Factories, warehouses, and machinery",
      "obstacles": [
        {
          "type": "Gap",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You leap across the conveyor gap.",
          "failureDescription": "The moving belts throw off your timing."
        },
        {
          "type": "Climb",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You scramble up the scaffolding quickly.",
          "failureDescription": "The rusted scaffolding creaks and shifts."
        },
        {
          "type": "Debris",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You navigate the machinery debris nimbly.",
          "failureDescription": "Sharp metal edges slow your progress."
        },
        {
          "type": "Hazard",
          "dc": 4,
          "skillRequired": "Acrobatics",
          "successDescription": "You time your dash between the grinding gears.",
          "failureDescription": "The mechanical hazard forces a lengthy detour."
        }
      ]
    },
    "wilderness": {
      "name": "Wilderness",
      "description": "Forests, hills, and natural terrain",
      "obstacles": [
        {
          "type": "Gap",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You leap the ravine with room to spare.",
          "failureDescription": "You land awkwardly on the far edge."
        },
        {
          "type": "Climb",
          "dc": 2,
          "skillRequired": "Acrobatics",
          "successDescription": "You scramble up the rocky outcrop.",
          "failureDescription": "Loose rocks slide beneath your feet."
        },
        {
          "type": "Debris",
          "dc": 2,
          "skillRequired": "Acrobatics",
          "successDescription": "You duck through the fallen branches.",
          "failureDescription": "Thorny underbrush catches your clothing."
        },
        {
          "type": "Hazard",
          "dc": 3,
          "skillRequired": "Acrobatics",
          "successDescription": "You skirt the edge of the sinkhole.",
          "failureDescription": "Unstable ground forces you to backtrack."
        }
      ]
    }
  },
  "defaultDcs": {
    "Gap": 3,
    "Climb": 2,
    "Debris": 2,
    "Crowd": 3,
    "Hazard": 3
  }
}
```

### 12.2 chase-obstacles.schema.json

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://rune.game/schemas/chase-obstacles.schema.json",
  "title": "Chase Obstacles Configuration",
  "description": "Schema for chase obstacle definitions in RUNE",
  "type": "object",
  "required": ["version", "environments", "defaultDcs"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Configuration version (semver)"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of this configuration"
    },
    "defaultEnvironment": {
      "type": "string",
      "description": "Default environment when none specified"
    },
    "environments": {
      "type": "object",
      "description": "Environment-specific obstacle sets",
      "additionalProperties": {
        "$ref": "#/$defs/environment"
      }
    },
    "defaultDcs": {
      "type": "object",
      "description": "Default DCs by obstacle type",
      "additionalProperties": {
        "type": "integer",
        "minimum": 1,
        "maximum": 6
      }
    }
  },
  "$defs": {
    "environment": {
      "type": "object",
      "required": ["name", "obstacles"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Display name for the environment"
        },
        "description": {
          "type": "string",
          "description": "Environment description"
        },
        "obstacles": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/obstacle"
          },
          "minItems": 1
        }
      }
    },
    "obstacle": {
      "type": "object",
      "required": ["type", "dc", "skillRequired", "successDescription", "failureDescription"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["Gap", "Climb", "Debris", "Crowd", "Hazard"],
          "description": "Obstacle category"
        },
        "dc": {
          "type": "integer",
          "minimum": 1,
          "maximum": 6,
          "description": "Successes needed to overcome"
        },
        "skillRequired": {
          "type": "string",
          "description": "Skill used for the check"
        },
        "successDescription": {
          "type": "string",
          "description": "Narrative text for success"
        },
        "failureDescription": {
          "type": "string",
          "description": "Narrative text for failure"
        }
      }
    }
  }
}
```

---

## 13. Commands

### 13.1 Chase Commands

| Command | Description | Example |
|---------|-------------|---------|
| `flee` | Initiates a chase (fleeing from combat) | `flee` |
| `chase <target>` | Initiates pursuit of a fleeing target | `chase goblin` |
| `abandon` | Abandons current chase | `abandon` |
| `chase status` | Shows current chase state | `chase status` |

### 13.2 Command Parsing

```csharp
// In ConsoleInputHandler.ParseCommand():

"flee" => new FleeCommand(),
"chase" => ParseChaseCommand(argument),
"abandon" => new AbandonChaseCommand(),

private GameCommand ParseChaseCommand(string? argument)
{
    if (string.IsNullOrWhiteSpace(argument))
        return new ChaseStatusCommand();

    if (argument.Equals("status", StringComparison.OrdinalIgnoreCase))
        return new ChaseStatusCommand();

    return new InitiateChaseCommand(argument);
}
```

---

## 14. User-Facing Changes

### 14.1 Chase Start Display

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              CHASE INITIATED                                  ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  You break away from the guard and start running!                            ║
║                                                                               ║
║  DISTANCE TRACK:                                                             ║
║  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┐                          ║
║  │CAUGHT│CLOSE │CLOSE │ NEAR │ FAR  │ FAR  │ LOST │                          ║
║  │  0   │  1   │  2   │  3   │  4   │  5   │  6+  │                          ║
║  └──────┴──────┴──────┴──▲───┴──────┴──────┴──────┘                          ║
║                          │                                                    ║
║                       YOU ARE HERE                                           ║
║                                                                               ║
║  Pursuer: City Guard                                                         ║
║  Starting Distance: NEAR (3)                                                 ║
║                                                                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 14.2 Chase Round Display

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              CHASE - ROUND 2                                  ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  OBSTACLE: Gap (DC 3 successes)                                              ║
║  A yawning gap between rooftops stretches before you!                        ║
║                                                                               ║
║  YOUR ATTEMPT:                                                               ║
║  ┌────────────────────────────────────────────────────────────────────┐      ║
║  │  Acrobatics Check: 6d10                                            │      ║
║  │  Roll: [10, 8, 4, 9, 2, 7] → 3 successes                          │      ║
║  │  vs DC 3 → SUCCESS                                                 │      ║
║  │                                                                    │      ║
║  │  You vault the gap between buildings effortlessly.                │      ║
║  │  Distance: +1                                                      │      ║
║  └────────────────────────────────────────────────────────────────────┘      ║
║                                                                               ║
║  PURSUER'S ATTEMPT:                                                          ║
║  ┌────────────────────────────────────────────────────────────────────┐      ║
║  │  The guard hesitates at the edge, losing momentum.                │      ║
║  │  Distance: +1 (pursuer failed)                                    │      ║
║  └────────────────────────────────────────────────────────────────────┘      ║
║                                                                               ║
║  DISTANCE TRACK:                                                             ║
║  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┐                          ║
║  │CAUGHT│CLOSE │CLOSE │ NEAR │ FAR  │ FAR  │ LOST │                          ║
║  │  0   │  1   │  2   │  3   │  4   │  5   │  6+  │                          ║
║  └──────┴──────┴──────┴──────┴──────┴──▲───┴──────┘                          ║
║                                         │                                     ║
║                     Previous: 3 ───────► NEW: 5 (+2)                         ║
║                                                                               ║
║  You're pulling ahead! One more good round and you'll escape!                ║
║                                                                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 14.3 Chase Resolution Display

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              CHASE COMPLETE                                   ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║                              ★ ESCAPED! ★                                    ║
║                                                                               ║
║  After 3 rounds, you've lost your pursuer in the maze of alleyways!         ║
║                                                                               ║
║  CHASE SUMMARY:                                                              ║
║  ├── Rounds: 3                                                               ║
║  ├── Obstacles Cleared: 2 Gap, 1 Climb                                       ║
║  ├── Final Distance: 6 (LOST)                                                ║
║  └── Pursuer: City Guard (lost the trail)                                    ║
║                                                                               ║
║  The guard's shouts fade into the distance as you slip into the shadows.     ║
║                                                                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 15. Logging Specifications

### 15.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Chase started | Information | `Chase {ChaseId} started: {FleeingId} fleeing from {PursuerId}, distance {Distance}` |
| Obstacle generated | Debug | `Chase {ChaseId} round {Round}: Generated {ObstacleType} obstacle (DC {Dc})` |
| Round processed | Debug | `Chase {ChaseId} round {Round}: Fleeing {FleeingOutcome}, Pursuer {PursuerOutcome}, Distance {PrevDist} → {NewDist}` |
| Chase ended | Information | `Chase {ChaseId} ended with status {Status} after {Rounds} rounds` |
| Chase abandoned | Information | `Chase {ChaseId} abandoned by {CharacterId}` |

### 15.2 Example Log Output

```
[12:34:56 INF] Chase chase-0001 started: player-1 fleeing from guard-1, distance 3
[12:34:56 DBG] Chase chase-0001 round 1: Generated Gap obstacle (DC 3)
[12:34:57 DBG] Chase chase-0001 round 1: Fleeing Success, Pursuer Failure, Distance 3 → 5
[12:34:58 DBG] Chase chase-0001 round 2: Generated Climb obstacle (DC 2)
[12:34:58 DBG] Chase chase-0001 round 2: Fleeing Success, Pursuer Success, Distance 5 → 5
[12:34:59 DBG] Chase chase-0001 round 3: Generated Debris obstacle (DC 2)
[12:34:59 DBG] Chase chase-0001 round 3: Fleeing Success, Pursuer Failure, Distance 5 → 7
[12:34:59 INF] Chase chase-0001 ended with status Escaped after 3 rounds
```

---

## 16. Unit Testing Requirements

### 16.1 Test Specifications (~4 tests)

#### ChaseServiceTests.cs

```csharp
[TestFixture]
public class ChaseServiceTests
{
    /// <summary>
    /// Verifies that a new chase starts at the specified distance.
    /// </summary>
    [Test]
    public void StartChase_WithStartDistance_CreatesChaseAtSpecifiedDistance()
    {
        // Arrange
        var service = CreateChaseService();
        var fleeingId = "player-1";
        var pursuerId = "guard-1";
        var startDistance = 4;

        // Act
        var chase = service.StartChase(fleeingId, pursuerId, startDistance);

        // Assert
        Assert.That(chase.Distance, Is.EqualTo(startDistance));
        Assert.That(chase.Status, Is.EqualTo(ChaseStatus.InProgress));
        Assert.That(chase.FleeingId, Is.EqualTo(fleeingId));
        Assert.That(chase.PursuerId, Is.EqualTo(pursuerId));
    }

    /// <summary>
    /// Verifies that successful obstacle attempts correctly modify distance.
    /// </summary>
    [Test]
    public void ProcessRound_FleeingSuccess_IncreasesDistance()
    {
        // Arrange
        var diceRoller = CreateMockDiceRoller(successes: 4); // Above DC 3
        var service = CreateChaseService(diceRoller);
        var chase = service.StartChase("player-1", "guard-1", startDistance: 3);
        service.GenerateObstacle(chase);

        // Act
        var result = service.ProcessRound(chase.ChaseId);

        // Assert
        Assert.That(result.FleeingOutcome, Is.EqualTo(SkillOutcome.Success));
        Assert.That(result.FleeingDistanceChange, Is.GreaterThan(0));
    }

    /// <summary>
    /// Verifies that distance reaching 0 triggers Caught status.
    /// </summary>
    [Test]
    public void ProcessRound_DistanceReachesZero_TriggersChaseStatusCaught()
    {
        // Arrange - Set up so pursuer succeeds and fleeing fails
        var service = CreateChaseServiceWithOutcomes(
            fleeingSuccesses: 0, pursuerSuccesses: 5);
        var chase = service.StartChase("player-1", "guard-1", startDistance: 1);
        service.GenerateObstacle(chase);

        // Act
        var result = service.ProcessRound(chase.ChaseId);

        // Assert
        Assert.That(result.ChaseStatus, Is.EqualTo(ChaseStatus.Caught));
        Assert.That(chase.Status, Is.EqualTo(ChaseStatus.Caught));
    }

    /// <summary>
    /// Verifies that distance reaching 6+ triggers Escaped status.
    /// </summary>
    [Test]
    public void ProcessRound_DistanceReachesSix_TriggersChaseStatusEscaped()
    {
        // Arrange - Set up so fleeing succeeds critically and pursuer fails
        var service = CreateChaseServiceWithOutcomes(
            fleeingSuccesses: 8, pursuerSuccesses: 0); // Critical + failure = +3
        var chase = service.StartChase("player-1", "guard-1", startDistance: 5);
        service.GenerateObstacle(chase);

        // Act
        var result = service.ProcessRound(chase.ChaseId);

        // Assert
        Assert.That(result.ChaseStatus, Is.EqualTo(ChaseStatus.Escaped));
        Assert.That(chase.Status, Is.EqualTo(ChaseStatus.Escaped));
    }
}
```

---

## 17. Use Cases

### 17.1 Use Case 1: Initiate Chase from Combat

```
GIVEN a player is in combat with a guard
WHEN the player issues the "flee" command
THEN a chase encounter is created
AND the starting distance is set to 3 (Near)
AND the chase status is InProgress
AND the first obstacle is generated
```

### 17.2 Use Case 2: Process Standard Chase Round

```
GIVEN a chase is in progress with distance 3
AND a Gap obstacle (DC 3) has been generated
WHEN the round is processed
AND the fleeing character rolls 3 successes (Success)
AND the pursuer rolls 2 successes (Failure)
THEN the distance increases by 2 (1 + 1)
AND the new distance is 5
AND the chase status remains InProgress
```

### 17.3 Use Case 3: Escape Successfully

```
GIVEN a chase is in progress with distance 5
AND a Debris obstacle (DC 2) has been generated
WHEN the round is processed
AND the fleeing character rolls 4 successes (Success, +1)
AND the pursuer rolls 1 success (Failure, +1)
THEN the distance increases to 7
AND the chase status becomes Escaped
AND the chase ends
```

### 17.4 Use Case 4: Get Caught

```
GIVEN a chase is in progress with distance 2
AND a Climb obstacle (DC 3) has been generated
WHEN the round is processed
AND the fleeing character rolls 1 success (Failure, -1)
AND the pursuer rolls 5 successes (Critical, -2)
THEN the distance decreases to -1
AND the chase status becomes Caught
AND the chase ends
```

### 17.5 Use Case 5: Abandon Chase

```
GIVEN a chase is in progress with distance 4
WHEN the pursuer issues the "abandon" command
THEN the chase status becomes Abandoned
AND the chase ends
AND the fleeing character is no longer being pursued
```

---

## 18. Deliverable Checklist

### 18.1 Domain Layer

| Item | File | Status |
|------|------|--------|
| `ChaseStatus` enum | `Domain/Enums/ChaseStatus.cs` | [ ] |
| `ObstacleType` enum | `Domain/Enums/ObstacleType.cs` | [ ] |
| `ChaseObstacle` value object | `Domain/ValueObjects/ChaseObstacle.cs` | [ ] |
| `ChaseRoundResult` value object | `Domain/ValueObjects/ChaseRoundResult.cs` | [ ] |
| `ChaseState` entity | `Domain/Entities/ChaseState.cs` | [ ] |

### 18.2 Application Layer

| Item | File | Status |
|------|------|--------|
| `IChaseService` interface | `Application/Interfaces/IChaseService.cs` | [ ] |
| `ChaseService` implementation | `Application/Services/ChaseService.cs` | [ ] |

### 18.3 Infrastructure Layer

| Item | File | Status |
|------|------|--------|
| `IChaseObstacleProvider` interface | `Application/Interfaces/IChaseObstacleProvider.cs` | [ ] |
| `ChaseObstacleProvider` implementation | `Infrastructure/Providers/ChaseObstacleProvider.cs` | [ ] |

### 18.4 Configuration

| Item | File | Status |
|------|------|--------|
| Chase obstacles config | `Configuration/chase-obstacles.json` | [ ] |
| Chase obstacles schema | `Configuration/chase-obstacles.schema.json` | [ ] |

### 18.5 Tests

| Item | File | Status |
|------|------|--------|
| Chase service tests | `Tests/ChaseServiceTests.cs` | [ ] |
| Chase state tests | `Tests/ChaseStateTests.cs` | [ ] |

---

## 19. Acceptance Criteria

### 19.1 Functional Criteria

- [ ] Chase can be initiated with specified participants and start distance
- [ ] Obstacles are generated dynamically based on environment
- [ ] Both participants make skill checks each round
- [ ] Distance changes correctly based on check outcomes
- [ ] Critical success gives +2/-2 distance bonus
- [ ] Distance ≤ 0 triggers Caught status
- [ ] Distance ≥ 6 triggers Escaped status
- [ ] Chase can be abandoned by either participant
- [ ] MaxRounds triggers TimedOut when reached

### 19.2 Quality Criteria

- [ ] All ~4 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] No circular dependencies introduced
- [ ] Configuration validates against schema

---

## 20. Future Considerations

### 20.1 Deferred to v0.15.2g (Specialization Integration)

- `[Death-Defying Leap]` - Bonus to Gap obstacles
- `[Wall-Run]` - Can bypass Climb obstacles
- `[Double Jump]` - Re-roll failed Gap attempts

### 20.2 Deferred to Future Versions

- Multi-pursuer chases (multiple characters chasing one target)
- Multi-target chases (splitting party)
- Vehicle-based chases
- Environmental hazard damage during chases
- Chase combat actions (throwing obstacles, ranged attacks)
- Stealth-based chase variants

---

## 21. Implementation Notes

### 21.1 Integration Points

1. **Combat System**: The `flee` command in combat should trigger chase initiation
2. **Stealth System**: Hidden characters may have advantage when initiating chases
3. **Zone System**: Zone environment tags determine available obstacles

### 21.2 Performance Considerations

1. Active chases are stored in-memory in a dictionary for fast access
2. Obstacle selection avoids recent repetition for variety
3. Chase state history is maintained for replay/logging purposes

### 21.3 Edge Cases

1. **Both Critical**: If both participants get critical success, effects cancel out
2. **Both Fumble**: If both participants fumble, effects cancel out
3. **MaxRounds = 1**: Single-round chases are valid (quick escape attempts)

---

## 22. Document Metadata

| Property | Value |
|----------|-------|
| **Document Version** | 1.0.0 |
| **Created** | 2026-01-17 |
| **Last Updated** | 2026-01-17 |
| **Author** | Claude |
| **Status** | Draft |
| **Review Status** | Pending |

### 22.1 Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2026-01-17 | Claude | Initial draft |

---

*This design specification provides the detailed blueprint for implementing v0.15.2e Chase Sequences. The chase system creates dynamic pursuit encounters with obstacle-based skill challenges and a distance track that determines victory conditions.*
