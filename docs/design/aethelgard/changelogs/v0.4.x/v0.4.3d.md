# Changelog: v0.4.3d - The Backlash

**Release Date:** December 31, 2025

---

## Summary

Version 0.4.3d introduces the **Risk & Corruption System**, a comprehensive magical backlash framework that transforms spellcasting into a high-stakes risk management mechanic. This release implements a complete backlash pipeline spanning the Core domain layer (severity enums, corruption levels, backlash result models), Engine layer (BacklashService with risk calculation, severity determination, and effect application), and Event layer (BacklashEvent and CorruptionChangedEvent for UI/audio integration).

Key architectural patterns introduced: **Severity-Based Progression** with three backlash tiers (Minor, Major, Catastrophic), **Permanent Soul Degradation** through corruption accumulation, **Threshold-Based Penalties** that scale with corruption level, and **Event-Driven Notification** for tier changes and backlash occurrences. The system enforces a critical Flux threshold of 50, beyond which spellcasting carries a percentage risk equal to (Flux - 50), capped at 50% maximum risk.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/BacklashSeverity.cs` | Defines 4-value enum (None, Minor, Major, Catastrophic) for backlash intensity levels |
| `RuneAndRust.Core/Enums/CorruptionLevel.cs` | Defines 5-value enum (Untouched, Tainted, Afflicted, Blighted, Lost) for soul degradation tiers |
| `RuneAndRust.Core/Models/Magic/BacklashResult.cs` | Result record containing backlash outcome, damage dealt, Aether Sickness duration, corruption gained |
| `RuneAndRust.Core/Models/Magic/CorruptionPenalties.cs` | Penalties record with MaxAP multiplier, Will/Wits penalties, casting prohibition |
| `RuneAndRust.Core/Events/BacklashEvent.cs` | Event published when backlash occurs, consumed by UI and audio systems |
| `RuneAndRust.Core/Events/CorruptionChangedEvent.cs` | Event published when corruption value or tier changes |
| `RuneAndRust.Core/Interfaces/IBacklashService.cs` | 10-method service contract for backlash mechanics and corruption tracking |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/BacklashService.cs` | Complete backlash service implementation with risk calculation, effect application, and corruption management |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/Services/BacklashServiceTests.cs` | Comprehensive unit tests for BacklashService (49 tests) |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/StatusEffectType.cs` | Added `AetherSickness = 10` debuff with GameDocument attribute describing magical feedback condition |
| `RuneAndRust.Core/Enums/CastFailureReason.cs` | Added `SoulLost = 11` failure reason for corruption level Lost (75+ corruption) |
| `RuneAndRust.Core/Models/Magic/MagicResult.cs` | Added `IsBacklash` property, `BacklashSeverity` property, and `Backlash()` factory method |
| `RuneAndRust.Engine/Services/MagicService.cs` | Added `IBacklashService` dependency, integrated backlash checks in `CastSpell()`, `InitiateCharge()`, and `ReleaseCharge()` |
| `RuneAndRust.Terminal/Program.cs` | Registered `IBacklashService` as Singleton in DI container |
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added `IBacklashService` mock registration for test infrastructure |
| `RuneAndRust.Tests/Engine/Services/MagicServiceTests.cs` | Added `IBacklashService` mock dependency to existing test setup |

---

## Code Implementation Details

### Core Layer: Backlash Enums

#### BacklashSeverity Enum

Four intensity levels for magical backlash:

```csharp
public enum BacklashSeverity
{
    None = 0,          // No backlash occurred
    Minor = 1,         // 1-10 fail margin
    Major = 2,         // 11-25 fail margin
    Catastrophic = 3   // 26+ fail margin
}
```

**Severity Determination:**
- **None**: Flux below critical threshold (50) or risk roll succeeded
- **Minor**: Fail margin 1-10 → 1d6 damage
- **Major**: Fail margin 11-25 → 2d6 damage + Aether Sickness (2 turns)
- **Catastrophic**: Fail margin 26+ → 3d6 damage + Aether Sickness (5 turns) + 1 Corruption

#### CorruptionLevel Enum

Five soul degradation tiers:

```csharp
public enum CorruptionLevel
{
    Untouched = 0,   // 0-9 corruption
    Tainted = 1,     // 10-24 corruption
    Afflicted = 2,   // 25-49 corruption
    Blighted = 3,    // 50-74 corruption
    Lost = 4         // 75-100 corruption
}
```

**Corruption Thresholds and Penalties:**

| Level | Range | MaxAP Multiplier | Will Penalty | Wits Penalty | Can Cast | Description |
|-------|-------|------------------|--------------|--------------|----------|-------------|
| Untouched | 0-9 | 1.0 (no penalty) | 0 | 0 | Yes | "Your soul remains untouched by the weave's corruption." |
| Tainted | 10-24 | 0.9 (-1 AP) | 0 | 0 | Yes | "A faint darkness lingers at the edge of your vision." |
| Afflicted | 25-49 | 0.8 (-2 AP) | -1 | 0 | Yes | "The corruption whispers in quiet moments." |
| Blighted | 50-74 | 0.7 (-3 AP) | -2 | -1 | Yes | "Your flesh bears the marks of arcane scarring." |
| Lost | 75-100 | 0.0 (no AP) | -2 | -1 | No | "Your soul has been consumed. Magic no longer answers." |

### Core Layer: Backlash Models

#### BacklashResult Record

**Properties:**
- `bool Triggered` - Whether backlash occurred
- `BacklashSeverity Severity` - Intensity level of backlash
- `int DamageDealt` - Damage dealt to caster
- `int AetherSicknessDuration` - Duration of Aether Sickness (0 if none)
- `int CorruptionAdded` - Corruption points gained (0 or 1)
- `string Message` - Narrative description of backlash
- `int RiskChance` - Calculated risk percentage (Flux - 50)
- `int Roll` - d100 roll result
- `int FailMargin` - Computed property: `RiskChance - Roll`

**Factory Methods:**
```csharp
BacklashResult NoBacklash(int riskChance = 0, int roll = 0)
```
- Returns safe cast result with `Triggered = false`
- Used when Flux below critical or roll succeeded

```csharp
BacklashResult Backlash(
    BacklashSeverity severity,
    int damage,
    int sicknessDuration,
    int corruption,
    string message,
    int riskChance,
    int roll)
```
- Returns triggered backlash with all effects
- `Triggered = true`, severity determines damage dice and duration

#### CorruptionPenalties Record

**Properties:**
- `CorruptionLevel Level` - Current corruption tier
- `int CorruptionValue` - Raw corruption value (0-100)
- `double MaxApMultiplier` - Multiplier for MaxAP calculation
- `int WillPenalty` - Negative modifier to Will attribute
- `int WitsPenalty` - Negative modifier to Wits attribute
- `bool CanCastSpells` - False only at Lost level
- `string Description` - Domain 4 compliant description
- `int EffectiveApPenalty` - Computed: `(1.0 - MaxApMultiplier) * 10`
- `bool HasPenalties` - Computed: `Level != Untouched`

**Factory Methods:**
```csharp
CorruptionPenalties Untouched(int corruption)
CorruptionPenalties Tainted(int corruption)
CorruptionPenalties Afflicted(int corruption)
CorruptionPenalties Blighted(int corruption)
CorruptionPenalties Lost(int corruption)
```
- Each factory returns penalties record for specific corruption level
- Multipliers and penalties match tier thresholds

### Core Layer: Backlash Events

#### BacklashEvent Record

**Parameters:**
- `Guid CasterId` - Unique identifier of caster
- `string CasterName` - Display name of caster
- `BacklashSeverity Severity` - Backlash intensity
- `int DamageDealt` - Damage dealt to caster
- `int AetherSicknessDuration` - Duration of Aether Sickness
- `int CorruptionAdded` - Corruption points gained
- `int RiskChance` - Calculated risk percentage
- `int Roll` - d100 roll result
- `int CurrentFlux` - Flux level at time of cast
- `string? SpellAttempted` - Optional spell name

**Computed Properties:**
- `bool GainedCorruption` - Whether corruption was gained
- `string SeverityDisplay` - Uppercase severity string
- `int FailMargin` - How badly roll failed
- `bool WasLethal` - Whether caster knocked unconscious

#### CorruptionChangedEvent Record

**Parameters:**
- `Guid CharacterId` - Unique identifier of character
- `string CharacterName` - Display name of character
- `int PreviousCorruption` - Corruption before change
- `int NewCorruption` - Corruption after change
- `CorruptionLevel PreviousLevel` - Tier before change
- `CorruptionLevel NewLevel` - Tier after change
- `string Source` - Description of corruption source

**Computed Properties:**
- `bool TierChanged` - Whether corruption tier changed
- `bool BecameLost` - Whether character became Lost
- `int CorruptionDelta` - Amount added or removed
- `bool WasCorruptionGained` - Whether corruption increased

### Engine Layer: BacklashService

**Dependencies:**
- `IAetherService` - For current Flux level queries
- `IDiceService` - For d100 backlash rolls and damage dice
- `IStatusEffectService` - For applying Aether Sickness
- `IEventBus` - For publishing BacklashEvent and CorruptionChangedEvent
- `ILogger<BacklashService>` - For structured logging

**Constants:**
```csharp
private const int CriticalThreshold = 50;
private const int MinorMaxMargin = 10;
private const int MajorMaxMargin = 25;
private const int TaintedThreshold = 10;
private const int AfflictedThreshold = 25;
private const int BlightedThreshold = 50;
private const int LostThreshold = 75;
private const int MajorSicknessDuration = 2;
private const int CatastrophicSicknessDuration = 5;
```

**Key Method Signatures:**

```csharp
BacklashResult CheckBacklash(Combatant caster, string? spellName = null)
```
- Calculates risk based on current Flux
- Returns `NoBacklash()` if Flux below critical (50) or roll succeeded
- Rolls d100, compares to risk percentage
- Determines severity from fail margin
- Applies damage (1d6 × severity dice count)
- Applies Aether Sickness for Major/Catastrophic
- Adds 1 corruption for Catastrophic (if caster has CharacterSource)
- Publishes BacklashEvent
- Returns BacklashResult with all effects

```csharp
int GetCurrentRisk()
```
- Formula: `Math.Max(0, CurrentFlux - CriticalThreshold)`
- Returns 0 if Flux ≤ 50
- Returns 1-50 if Flux 51-100

```csharp
bool IsAtRisk()
```
- Returns `GetCurrentRisk() > 0`

```csharp
CorruptionLevel GetCorruptionLevel(Character character)
```
- Maps corruption value to enum tier
- Returns Untouched (0-9), Tainted (10-24), Afflicted (25-49), Blighted (50-74), Lost (75-100)

```csharp
CorruptionPenalties GetCorruptionPenalties(Character character)
```
- Determines corruption level
- Returns penalties record with multipliers and restrictions

```csharp
void AddCorruption(Character character, int amount, string source)
```
- Increments corruption, clamped to 0-100
- Publishes CorruptionChangedEvent if tier changed
- Logs Warning for tier changes, Error for "Lost" state

```csharp
bool PurgeCorruption(Character character, int amount, string source)
```
- Decrements corruption, clamped to 0
- Returns false if character had no corruption
- Publishes CorruptionChangedEvent if tier changed
- Rare mechanic requiring special items/rituals

```csharp
bool CanCastSpells(Character character)
```
- Returns false if corruption level is Lost (75+)
- Returns true otherwise

```csharp
string GetRiskWarning()
```
- Returns Spectre.Console formatted warning message
- Returns empty string if no risk
- Tiers: Caution (≤10%), Warning (≤25%), Danger (≤40%), Critical (>40%)

**Behavioral Details:**
- Damage dice count: Minor (1d6), Major (2d6), Catastrophic (3d6)
- Aether Sickness duration: None (Minor), 2 turns (Major), 5 turns (Catastrophic)
- Corruption gain: Only Catastrophic adds +1 corruption
- Severity determination: Fail margin maps to tier (1-10 → Minor, 11-25 → Major, 26+ → Catastrophic)
- Backlash applies damage to caster's CurrentHp before status effects
- BacklashEvent includes `WasLethal` flag if backlash knocked caster unconscious
- Corruption clamped to [0, 100] range on all operations
- CorruptionChangedEvent only published if value actually changed

### Integration with MagicService

**Modified Methods:**

`CastSpell()`:
1. Validates SoulLost status via `_backlashService.CanCastSpells()`
2. If at risk (`_backlashService.IsAtRisk()`), calls `CheckBacklash()` before spell execution
3. If backlash triggered, returns `MagicResult.Backlash()` with damage and severity
4. If no backlash or safe cast, proceeds with normal spell execution

`InitiateCharge()`:
1. Validates SoulLost status before charge initiation
2. Checks backlash risk before applying Chanting status

`ReleaseCharge()`:
1. Validates SoulLost status before charge release
2. Checks backlash risk before spell execution

---

## Logging Matrix

### BacklashService

| Event | Level | Template |
|-------|-------|----------|
| Service initialization | Debug | `"[Backlash] BacklashService initialized. Critical threshold: {Threshold}"` |
| Backlash check entry | Debug | `"[Backlash] Checking backlash for {Caster}. Flux: {Flux}, Spell: {Spell}"` |
| Flux below critical | Debug | `"[Backlash] Flux {Flux} below critical ({Threshold}). No risk."` |
| Risk cast attempt | Information | `"[Backlash] {Caster} casting at {Risk}% risk (Flux: {Flux})"` |
| Safe cast result | Debug | `"[Backlash] Roll {Roll} > Risk {Risk}. Safe cast."` |
| Backlash triggered | Warning | `"[Backlash] BACKLASH! {Caster} rolled {Roll} <= {Risk}"` |
| Severity determined | Information | `"[Backlash] Severity: {Severity} (margin: {Margin})"` |
| Damage applied | Warning | `"[Backlash] {Caster} takes {Damage} backlash damage ({Dice}d6). HP: {Previous} -> {Current}"` |
| Aether Sickness applied | Warning | `"[Backlash] {Caster} afflicted with Aether Sickness for {Duration} turns"` |
| Event published | Debug | `"[Backlash] Published BacklashEvent: {Severity} for {Caster}"` |
| Lethal backlash | Error | `"[Backlash] {Caster} was knocked unconscious by backlash damage!"` |
| Corruption gained | Warning | `"[Corruption] {Character} gained {Amount} corruption from {Source}. Total: {Total} ({Level})"` |
| Corruption tier change | Warning | `"[Corruption] TIER CHANGE: {Character} is now {Level}"` |
| Soul lost | Error | `"[Corruption] {Character} has been LOST to corruption! Soul consumed. Cannot cast spells."` |
| Purge attempt (no corruption) | Debug | `"[Corruption] {Character} has no corruption to purge"` |
| Purge success | Information | `"[Corruption] {Character} purged {Amount} corruption via {Source}. Total: {Total} ({Level})"` |
| Purge tier improvement | Information | `"[Corruption] TIER IMPROVEMENT: {Character} recovered to {Level}"` |
| Cast check (Lost) | Debug | `"[Corruption] {Character} is Lost - cannot cast spells"` |

---

## Test Coverage

**Total:** 49 tests | **Passed:** 49 | **Failed:** 0 | **Duration:** 129ms

### Complete Test Inventory

#### BacklashServiceTests (49 tests)

| Test Name | Description |
|-----------|-------------|
| `GetCurrentRisk_FluxBelowCritical_ReturnsZero` | Flux 40 returns 0% risk |
| `GetCurrentRisk_FluxAtCritical_ReturnsZero` | Flux 50 returns 0% risk (threshold is exclusive) |
| `GetCurrentRisk_FluxAboveCritical_ReturnsCorrectRisk` | Flux 60 returns 10% risk |
| `GetCurrentRisk_FluxAtMax_ReturnsFifty` | Flux 100 returns 50% risk (maximum) |
| `IsAtRisk_FluxBelowCritical_ReturnsFalse` | Flux 40 returns false for risk check |
| `IsAtRisk_FluxAboveCritical_ReturnsTrue` | Flux 70 returns true for risk check |
| `CheckBacklash_FluxBelowCritical_ReturnsNoBacklash` | Flux 45 returns NoBacklash result |
| `CheckBacklash_RollBeatRisk_ReturnsNoBacklash` | Roll 30 > Risk 20 returns NoBacklash |
| `CheckBacklash_MinorBacklash_AppliesCorrectEffects` | Fail margin 5 applies 1d6 damage, no status, no corruption |
| `CheckBacklash_MajorBacklash_AppliesCorrectEffects` | Fail margin 15 applies 2d6 damage, 2 turns Aether Sickness, no corruption |
| `CheckBacklash_CatastrophicBacklash_AppliesCorrectEffects` | Fail margin 30 applies 3d6 damage, 5 turns Aether Sickness, 1 corruption |
| `CheckBacklash_Catastrophic_PublishesCorruptionEvent` | Catastrophic backlash publishes CorruptionChangedEvent |
| `CheckBacklash_BacklashTriggered_PublishesBacklashEvent` | Any backlash publishes BacklashEvent with correct properties |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 0, expected: Untouched)` | Corruption 0 maps to Untouched |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 5, expected: Untouched)` | Corruption 5 maps to Untouched |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 9, expected: Untouched)` | Corruption 9 maps to Untouched (boundary) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 10, expected: Tainted)` | Corruption 10 maps to Tainted (threshold) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 20, expected: Tainted)` | Corruption 20 maps to Tainted |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 24, expected: Tainted)` | Corruption 24 maps to Tainted (boundary) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 25, expected: Afflicted)` | Corruption 25 maps to Afflicted (threshold) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 40, expected: Afflicted)` | Corruption 40 maps to Afflicted |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 49, expected: Afflicted)` | Corruption 49 maps to Afflicted (boundary) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 50, expected: Blighted)` | Corruption 50 maps to Blighted (threshold) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 60, expected: Blighted)` | Corruption 60 maps to Blighted |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 74, expected: Blighted)` | Corruption 74 maps to Blighted (boundary) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 75, expected: Lost)` | Corruption 75 maps to Lost (threshold) |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 90, expected: Lost)` | Corruption 90 maps to Lost |
| `GetCorruptionLevel_ReturnsCorrectLevel(corruption: 100, expected: Lost)` | Corruption 100 maps to Lost (maximum) |
| `GetCorruptionLevel_CombatantWithoutCharacter_ReturnsUntouched` | Combatant without CharacterSource returns Untouched |
| `GetCorruptionPenalties_Untouched_NoPenalties` | Untouched level has MaxApMultiplier 1.0, no penalties, CanCastSpells true |
| `GetCorruptionPenalties_Tainted_ApReduction` | Tainted level has MaxApMultiplier 0.9, EffectiveApPenalty 1, CanCastSpells true |
| `GetCorruptionPenalties_Afflicted_ApAndWillPenalty` | Afflicted level has MaxApMultiplier 0.8, WillPenalty -1, CanCastSpells true |
| `GetCorruptionPenalties_Blighted_AllPenalties` | Blighted level has MaxApMultiplier 0.7, WillPenalty -2, WitsPenalty -1, CanCastSpells true |
| `GetCorruptionPenalties_Lost_CannotCast` | Lost level has MaxApMultiplier 0.0, WillPenalty -2, WitsPenalty -1, CanCastSpells false |
| `AddCorruption_IncreasesCorruption` | AddCorruption increases character corruption value |
| `AddCorruption_ClampsTo100` | Adding corruption beyond 100 clamps to 100 |
| `AddCorruption_TierChange_PublishesEvent` | Crossing tier threshold publishes CorruptionChangedEvent |
| `PurgeCorruption_ReducesCorruption` | PurgeCorruption decreases character corruption value |
| `PurgeCorruption_ClampsToZero` | Purging corruption below 0 clamps to 0 |
| `PurgeCorruption_NoCorruption_ReturnsFalse` | Purging character with 0 corruption returns false |
| `CanCastSpells_BelowLost_ReturnsTrue` | Characters with corruption <75 can cast spells |
| `CanCastSpells_AtLost_ReturnsFalse` | Characters with corruption ≥75 cannot cast spells |
| `GetRiskWarning_NoRisk_ReturnsEmpty` | Flux below critical returns empty string |
| `GetRiskWarning_LowRisk_ReturnsCaution` | Risk 5% returns yellow caution message |
| `GetRiskWarning_HighRisk_ReturnsCritical` | Risk 45% returns red bold critical message |
| `BacklashResult_NoBacklash_CorrectValues` | NoBacklash factory creates result with Triggered false |
| `BacklashResult_Backlash_CorrectValues` | Backlash factory creates result with Triggered true and effects |
| `CorruptionPenalties_Untouched_HasCorrectDescription` | Untouched penalties have correct Domain 4 description |
| `CorruptionPenalties_Lost_HasCorrectDescription` | Lost penalties have correct Domain 4 description |

---

## DI Registration

Added to `RuneAndRust.Terminal/Program.cs`:

```csharp
// Register Backlash Service
services.AddSingleton<IBacklashService, BacklashService>();
```

**Lifetime Choice:**
- `IBacklashService`: Singleton - Stateless service relying on IAetherService for Flux state

---

## Verification Results

### Build Output

```
Build succeeded.
    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:02.38
```

**Note:** Warning MSB3277 regarding EntityFrameworkCore.Relational version conflict (9.0.1 vs 9.0.4) is pre-existing and does not affect backlash functionality.

### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    49, Skipped:     0, Total:    49, Duration: 129 ms
```

**BacklashServiceTests:** 49/49 passed
**MagicServiceTests (with backlash integration):** 35/35 passed (verified separately)
**Full Test Suite (excluding PostgreSQL integration):** 3820/3820 passed

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   ├── BacklashSeverity.cs          # NEW
│   │   ├── CastFailureReason.cs         # MODIFIED (added SoulLost)
│   │   ├── CorruptionLevel.cs           # NEW
│   │   └── StatusEffectType.cs          # MODIFIED (added AetherSickness)
│   ├── Events/
│   │   ├── BacklashEvent.cs             # NEW
│   │   └── CorruptionChangedEvent.cs    # NEW
│   ├── Interfaces/
│   │   └── IBacklashService.cs          # NEW
│   └── Models/Magic/
│       ├── BacklashResult.cs            # NEW
│       ├── CorruptionPenalties.cs       # NEW
│       └── MagicResult.cs               # MODIFIED (added IsBacklash, BacklashSeverity, Backlash factory)
├── RuneAndRust.Engine/
│   └── Services/
│       ├── BacklashService.cs           # NEW
│       └── MagicService.cs              # MODIFIED (integrated IBacklashService)
├── RuneAndRust.Terminal/
│   └── Program.cs                       # MODIFIED (registered IBacklashService)
├── RuneAndRust.Tests/
│   ├── Engine/Services/
│   │   ├── BacklashServiceTests.cs     # NEW
│   │   └── MagicServiceTests.cs        # MODIFIED (added IBacklashService mock)
│   └── Infrastructure/
│       └── TestGameHost.cs              # MODIFIED (registered IBacklashService)
└── docs/changelogs/v0.4.x/
    └── v0.4.3d.md                       # NEW
```

---

## Running Tests

### Run All Backlash Tests
```bash
dotnet test --filter "FullyQualifiedName~BacklashServiceTests"
```

### Run Specific Test Categories
```bash
# Risk calculation tests
dotnet test --filter "FullyQualifiedName~BacklashServiceTests.GetCurrentRisk"

# Corruption level tests
dotnet test --filter "FullyQualifiedName~BacklashServiceTests.GetCorruptionLevel"

# Corruption penalty tests
dotnet test --filter "FullyQualifiedName~BacklashServiceTests.GetCorruptionPenalties"

# Backlash trigger tests
dotnet test --filter "FullyQualifiedName~BacklashServiceTests.CheckBacklash"
```

### Run Magic Service Integration Tests
```bash
dotnet test --filter "FullyQualifiedName~MagicServiceTests"
```

---

## Next Steps

Potential features for v0.4.4a or v0.5.0a:

### Backlash System Enhancements
- Corruption visualization in character sheet UI
- Backlash history log (recent backlash events)
- Corruption-based visual effects in combat UI
- Audio cues for backlash severity levels

### Corruption Mechanics Expansion
- Corruption purge items/rituals (rare consumables)
- Corruption-based story triggers at tier thresholds
- NPC dialogue reactions to visible corruption
- Sanctuary-based corruption stabilization (slow purge)

### Risk Management Tools
- Risk prediction display before spell cast
- "Safe cast" mode (blocks casts above 25% risk)
- Corruption tracker widget in HUD
- Backlash statistics (total backlash count, highest severity)

### Balance Adjustments
- Playtesting corruption accumulation rate
- Adjust Aether Sickness penalties if needed
- Consider corruption decay at Sanctuaries (slow, expensive)
- Evaluate Lost threshold (75 may be too punishing)

### Integration with Existing Systems
- Bind corruption penalties to character attribute calculations
- Apply MaxAP multiplier to Aether Point pool
- Enforce SoulLost check in all spell casting paths
- Add corruption display to character creation summary

---

## Risk & Corruption Quick Reference

### Backlash Trigger Conditions
1. Flux > 50 (Critical threshold)
2. Risk = Flux - 50 (range: 1-50%)
3. Roll d100
4. If Roll ≤ Risk → Backlash triggered

### Severity Determination
- Fail Margin = Risk - Roll
- 1-10 → Minor (1d6 damage)
- 11-25 → Major (2d6 damage + 2 turns Aether Sickness)
- 26+ → Catastrophic (3d6 damage + 5 turns Aether Sickness + 1 Corruption)

### Corruption Accumulation
- Only source: Catastrophic backlash (+1 per occurrence)
- Permanent: No natural healing
- Purge requires rare items/rituals
- Clamped to [0, 100] range

### Corruption Penalties by Tier

| Tier | Range | AP Penalty | Will | Wits | Casting |
|------|-------|------------|------|------|---------|
| Untouched | 0-9 | None | - | - | Allowed |
| Tainted | 10-24 | -10% (-1 AP) | - | - | Allowed |
| Afflicted | 25-49 | -20% (-2 AP) | -1 | - | Allowed |
| Blighted | 50-74 | -30% (-3 AP) | -2 | -1 | Allowed |
| Lost | 75-100 | -100% (0 AP) | -2 | -1 | Forbidden |

### Aether Sickness Effects
- Duration: 2 turns (Major), 5 turns (Catastrophic)
- Penalties: -2 Will, -1 Wits
- Blocks concentration spells
- Cannot be stacked (reapplication refreshes duration)
