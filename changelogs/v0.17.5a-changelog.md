# Changelog: v0.17.5a - Creation Step Enum & State

**Release Date:** 2026-01-30
**Phase:** Character Creation Workflow (1/7)
**Status:** Complete

---

## Overview

Implements the foundational enumeration and state management infrastructure for the Character Creation Workflow: the `CharacterCreationStep` enum with 6 values, `CharacterCreationStepExtensions` with 8 extension methods, and the `CharacterCreationState` entity that tracks all player selections across the six-step creation wizard. The `creation-workflow.json` configuration file defines step order, navigation rules, name validation parameters, and character initialization defaults.

This phase establishes the type-safe step identification, navigation control, and state persistence foundation for all subsequent Character Creation components (v0.17.5b-v0.17.5g).

**Creation Workflow Steps:**

| Step | Enum Value | Display Name | Permanent | Can Go Back |
| ---- | ---------- | ------------ | --------- | ----------- |
| 1 | Lineage (0) | Choose Your Lineage | No | No (first step) |
| 2 | Background (1) | Choose Your Background | No | Yes |
| 3 | Attributes (2) | Allocate Attributes | No | Yes |
| 4 | Archetype (3) | Choose Your Archetype | **Yes** | Yes |
| 5 | Specialization (4) | Choose Your Specialization | No | Yes |
| 6 | Summary (5) | Confirm Your Survivor | No | Yes |

---

## Added

### Domain Layer

#### Enums

- **`CharacterCreationStep`** (`Enums/CharacterCreationStep.cs`)
    - Enum with 6 values: `Lineage` (0), `Background` (1), `Attributes` (2), `Archetype` (3), `Specialization` (4), `Summary` (5)
    - Explicit integer assignments (0-5) for stable serialization and arithmetic navigation
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<list>`, `<para>`, `<seealso>` tags
    - Per-value remarks detailing step purpose, requirements, and permanent choice flags
    - `<seealso>` cross-references to `CharacterCreationState`, `CharacterCreationStepExtensions`

#### Extensions

- **`CharacterCreationStepExtensions`** (`Extensions/CharacterCreationStepExtensions.cs`)
    - `public static class` with 8 methods:
        - `GetStepNumber(this CharacterCreationStep)` → `int`: Returns 1-based step number (1-6)
        - `GetTotalSteps()` → `int`: Returns total step count (6) — static utility method
        - `CanGoBack(this CharacterCreationStep)` → `bool`: Returns false only for Lineage
        - `IsPermanentChoice(this CharacterCreationStep)` → `bool`: Returns true only for Archetype
        - `GetNextStep(this CharacterCreationStep)` → `CharacterCreationStep?`: Returns next step or null at Summary
        - `GetPreviousStep(this CharacterCreationStep)` → `CharacterCreationStep?`: Returns previous step or null at Lineage
        - `GetDisplayName(this CharacterCreationStep)` → `string`: Human-readable step names matching configuration
        - `GetDescription(this CharacterCreationStep)` → `string`: Atmospheric step descriptions matching configuration
    - Section separators: Step Order Methods, Navigation Methods, Display Methods
    - Full XML documentation with `<summary>`, `<param>`, `<returns>`, `<remarks>`, `<example>`, `<seealso>`
    - Copyright header pattern matching existing extension files

#### Entities

- **`CharacterCreationState`** (`Entities/CharacterCreationState.cs`)
    - `public class CharacterCreationState : IEntity`
    - Properties (private set): `Id` (Guid), `SessionId` (string), `CreatedAt` (DateTime)
    - Properties (public set): `CurrentStep`, `SelectedLineage`, `FlexibleAttributeBonus`, `SelectedBackground`, `AttributeAllocationMode`, `Attributes`, `SelectedArchetype`, `SelectedSpecialization`, `CharacterName`, `LastModifiedAt`, `ValidationErrors`
    - Computed property: `IsComplete` — returns true when all selections present and no validation errors
    - Private constructor for EF Core materialization
    - Factory method `Create(ILogger<CharacterCreationState>? logger = null)`:
        - Generates unique `Id` (Guid.NewGuid()) and `SessionId` (32-char hex string)
        - Initializes `CurrentStep` to Lineage, `AttributeAllocationMode` to Simple
        - Sets timestamps to current UTC time
        - Logs session creation at Information level
    - Navigation methods:
        - `TryAdvance()` → `bool`: Validates step completion via `IsStepComplete`, advances on success
        - `TryGoBack()` → `bool`: Returns to previous step, preserves all selections
        - `IsStepComplete(CharacterCreationStep)` → `bool`: Per-step validation including Clan-Born flexible bonus requirement
        - `Reset()`: Clears all selections, returns to Lineage, preserves session identity
    - Static `ILogger<CharacterCreationState>?` field for diagnostic output
    - Exhaustive logging: Debug level for navigation attempts and results, Information level for creation and reset
    - Section separators: PRIVATE FIELDS, PROPERTIES (by step), METADATA, CONSTRUCTORS, FACTORY METHODS, NAVIGATION METHODS, DEBUGGING
    - `ToString()` override with all key state properties
    - Comprehensive XML documentation with `<summary>`, `<value>`, `<remarks>`, `<example>`, `<seealso>`

### Configuration Files

- **`config/creation-workflow.json`** — Character creation workflow configuration
    - `$schema` reference to `./schemas/creation-workflow.schema.json`
    - `workflow.steps` array with 6 entries: step name, order (1-6), displayName, description, canGoBack, isPermanent
    - Archetype step (order 4) includes `permanentWarning` text
    - `nameValidation` section: minLength (2), maxLength (20), allowedPattern (ASCII letters/spaces/hyphens), profanityFilter (empty)
    - `initialization` section: startingLegend (0), startingPP (0), startingMilestone (0), legendToNextMilestone (500), startingStress (0), resourcesAtMax (true)

- **`config/schemas/creation-workflow.schema.json`** — JSON Schema Draft-07 validation
    - `WorkflowStep` definition with 6 required properties and optional `permanentWarning`
    - `NameValidation` definition with 3 required properties and optional `profanityFilter`
    - `Initialization` definition with 6 required properties
    - `step` property constrained to enum of all 6 step names
    - `additionalProperties: false` at all object levels
    - Top-level requires `workflow`, `nameValidation`, `initialization`

### Unit Tests

- **`CharacterCreationStepTests`** (`Enums/CharacterCreationStepTests.cs`) — 14 test methods (38 test cases with parameterization)
    - **Enum Value Tests (2 methods):**
        - `CharacterCreationStep_ShouldHave_ExactlySixValues`: All 6 values present
        - `CharacterCreationStep_HasCorrectIntegerValues`: Parameterized for all 6 (0-5)
    - **Step Number Tests (2 methods):**
        - `GetStepNumber_ReturnsCorrectOneBasedNumber`: Parameterized for all 6 steps
        - `GetTotalSteps_ReturnsSix`
    - **Permanent Choice Tests (1 method):**
        - `IsPermanentChoice_OnlyArchetypeReturnsTrue`: Iterates all 6 steps
    - **Navigation Tests (5 methods):**
        - `CanGoBack_ReturnsFalseOnlyForLineage`: Iterates all 6 steps
        - `GetNextStep_ReturnsNullForSummary`
        - `GetNextStep_ReturnsCorrectNextStep`: Parameterized for 5 non-Summary steps
        - `GetPreviousStep_ReturnsNullForLineage`
        - `GetPreviousStep_ReturnsCorrectPreviousStep`: Parameterized for 5 non-Lineage steps
    - **Display Tests (3 methods):**
        - `GetDisplayName_ReturnsCorrectName`: Parameterized for all 6 steps
        - `GetDescription_ReturnsCorrectDescription`: Parameterized for all 6 steps
        - `AllSteps_HaveNonEmptyDisplayNamesAndDescriptions`: Iterates all 6 steps
    - All tests use `FluentAssertions` with `[TestFixture]` and `[Test]`/`[TestCase]` NUnit attributes

- **`CharacterCreationStateTests`** (`Entities/CharacterCreationStateTests.cs`) — 27 test methods
    - **Create Factory Tests (2 methods):**
        - `Create_InitializesWithCorrectDefaults`: Full property verification including timestamps
        - `Create_GeneratesUniqueSessionIds`: Two creates produce different IDs
    - **TryAdvance Tests (6 methods):**
        - `TryAdvance_FromLineage_WhenLineageNotSelected_ReturnsFalse`
        - `TryAdvance_FromLineage_WhenLineageSelected_ReturnsTrue`
        - `TryAdvance_FromLineage_WhenClanBornWithoutFlexibleBonus_ReturnsFalse`
        - `TryAdvance_FromLineage_WhenClanBornWithFlexibleBonus_ReturnsTrue`
        - `TryAdvance_FromSummary_ReturnsFalse`
        - `TryAdvance_OnSuccess_UpdatesLastModifiedAt`
    - **TryGoBack Tests (3 methods):**
        - `TryGoBack_FromLineage_ReturnsFalse`
        - `TryGoBack_FromBackground_ReturnsTrue_PreservesSelections`
        - `TryGoBack_FromSpecialization_PreservesAllEarlierSelections`
    - **Reset Tests (1 method):**
        - `Reset_ClearsAllSelectionsAndReturnsToLineage`: Verifies all selections cleared and session identity preserved
    - **IsComplete Tests (4 methods):**
        - `IsComplete_ReturnsFalse_WhenAnySelectionMissing`
        - `IsComplete_ReturnsTrue_WhenAllSelectionsPresent`
        - `IsComplete_ReturnsFalse_WhenValidationErrorsPresent`
        - `IsComplete_ReturnsFalse_WhenCharacterNameIsWhitespace`
    - **IsStepComplete Tests (7 methods):**
        - `IsStepComplete_Lineage_NonClanBorn_ReturnsTrue`
        - `IsStepComplete_Lineage_NoSelection_ReturnsFalse`
        - `IsStepComplete_Background_WithSelection_ReturnsTrue`
        - `IsStepComplete_Attributes_WithCompleteAllocation_ReturnsTrue`
        - `IsStepComplete_Attributes_Null_ReturnsFalse`
        - `IsStepComplete_Summary_WithName_ReturnsTrue`
        - `IsStepComplete_Summary_WithoutName_ReturnsFalse`
    - **ToString Tests (1 method):**
        - `ToString_ReturnsFormattedStateString`
    - **Test Helpers:**
        - Uses `AttributeAllocationState.CreateFromRecommendedBuild("Warrior", 4, 3, 2, 2, 4, 15)` for complete allocation state

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries
    - `character-creation-step`: Enum defining the six sequential steps in the character creation wizard (sortOrder: 49)
    - `character-creation-state`: Transient entity maintaining all player selections during character creation (sortOrder: 50)
    - `creation-workflow-config`: JSON configuration file defining workflow steps, validation rules, and initialization defaults (sortOrder: 51)

---

## Changed

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5a unit test items
    - `[x] CharacterCreationStep enum has 6 values`
    - `[x] State maintains all selections correctly`
    - `[x] Navigation preserves previous choices`
    - Acceptance criteria: `[x] CharacterCreationStep enum has 6 values`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5 deliverables
    - `[x] CharacterCreationStep enum`
    - `[x] CharacterCreationState entity`
    - `[x] Configuration file: creation-workflow.json`

---

## Design Decisions

### Extension File Location: Extensions/ (Not Enums/)

The design specification places `CharacterCreationStepExtensions.cs` in the `Enums/` folder with namespace `RuneAndRust.Domain.Enums`. However, all 35+ existing extension files in the codebase are in the `Extensions/` folder with namespace `RuneAndRust.Domain.Extensions`. The codebase convention was followed for consistency.

### `Attributes.IsValid` → `Attributes.Value.IsComplete`

The design specification references `Attributes.IsValid` in the `IsStepComplete` method. The `AttributeAllocationState` value object does not have an `IsValid` property — it has `IsComplete` (true when `PointsRemaining == 0`). Additionally, since `Attributes` is `AttributeAllocationState?` (nullable value type), direct property access requires `.Value`. The implementation uses `Attributes.HasValue && Attributes.Value.IsComplete`.

### `AttributeAllocationState.CreateDefault()` Does Not Exist

The design specification's test code references `AttributeAllocationState.CreateDefault()`. This method does not exist. The actual factory methods are `CreateAdvancedDefault(int totalPoints = 15)` for Advanced mode and `CreateFromRecommendedBuild(string archetypeId, int might, int finesse, int wits, int will, int sturdiness, int totalPoints)` for Simple mode. Tests use `CreateFromRecommendedBuild("Warrior", 4, 3, 2, 2, 4, 15)` to produce a complete allocation state where `IsComplete` returns true.

### IsComplete Checks Presence, Not Detailed Validity

The `IsComplete` computed property checks that all selections have been set (`Attributes.HasValue`) but does not check `Attributes.Value.IsComplete`. This is intentional — `IsComplete` serves as a quick "are all fields filled in" check, while `IsStepComplete` handles detailed per-step validation including business rules (Clan-Born flexible bonus, attribute point allocation completion).

### GetTotalSteps as Static Method (Not Extension)

The design specification defines `GetTotalSteps()` without a `this` parameter, making it a regular static method rather than an extension method. This is implemented as specified — callers use `CharacterCreationStepExtensions.GetTotalSteps()` syntax. This is acceptable since the total step count is a fixed constant, not a per-step property.

### Logger in Entity Per Codebase Convention

The design specification shows logging examples in a controller context (Section 9). The entity includes a static `ILogger<CharacterCreationState>?` field per the established entity pattern from `SpecializationDefinition`, `ArchetypeDefinition`, and `AttributeAllocationState`. The `Create()` factory method accepts an optional logger parameter.

### JSON Schema Draft-07 (Not Draft 2020-12)

The configuration schema uses JSON Schema Draft-07 with `definitions` keyword, matching all existing schemas in the codebase (`archetypes.schema.json`, `backgrounds.schema.json`, `specializations.schema.json`, etc.). The `additionalProperties: false` constraint is applied at all object levels per codebase convention.

### Comprehensive Test Coverage

The design specification estimates ~3 tests for v0.17.5a. 41 test methods were implemented (14 enum + 27 state) expanding to 65 test cases with parameterization. This matches the established codebase test density from v0.17.4a-e. Coverage includes enum values, integer assignments, all extension methods, factory creation, navigation success/failure, step completion for all steps, Clan-Born special case, reset behavior, IsComplete edge cases, and ToString formatting.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `Lineage` | v0.17.0 | Step 1 selection storage |
| `CoreAttribute` | v0.17.0 | Clan-Born flexible bonus storage |
| `Background` | v0.17.1 | Step 2 selection storage |
| `AttributeAllocationMode` | v0.17.2 | Step 3 mode selection |
| `AttributeAllocationState` | v0.17.2 | Step 3 allocation storage (IsComplete, CreateFromRecommendedBuild) |
| `Archetype` | v0.17.3 | Step 4 selection storage |
| `SpecializationId` | v0.17.4 | Step 5 selection storage |
| `IEntity` | Domain | Interface for entity identification |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationStep` | v0.17.5b | ViewModel step display |
| `CharacterCreationState` | v0.17.5b | Source data for ViewModel |
| `CharacterCreationStep` | v0.17.5d | Controller step navigation |
| `CharacterCreationState` | v0.17.5d | Controller state management |
| `CharacterCreationState` | v0.17.5e | Factory input for character creation |
| `CharacterCreationStep` | v0.17.5f | TUI screen selection |

---

## Logging Strategy

| Level | When |
|---|---|
| Information | Character creation session started (SessionId, CurrentStep, Mode, Timestamp) |
| Information | Character creation session reset (SessionId, CurrentStep) |
| Debug | State creation initialization (pre-creation) |
| Debug | TryAdvance attempts (current step, SessionId) |
| Debug | TryAdvance success (from → to step, SessionId) |
| Debug | TryAdvance failure — at final step or step incomplete |
| Debug | TryGoBack attempts (current step, SessionId) |
| Debug | TryGoBack success (from → to step, SessionId) |
| Debug | TryGoBack failure — at first step |
| Debug | Reset initiation (previous step, SessionId) |

All navigation methods log at Debug level for diagnostic tracing. The `Create()` factory and `Reset()` log at Information level to mark significant lifecycle events.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/CharacterCreationStep.cs` | CharacterCreationStep enum with 6 values |
| `src/Core/RuneAndRust.Domain/Extensions/CharacterCreationStepExtensions.cs` | 8 extension methods for step navigation and display |
| `src/Core/RuneAndRust.Domain/Entities/CharacterCreationState.cs` | State entity with navigation methods and IsComplete |
| `config/creation-workflow.json` | Workflow steps, name validation, initialization config |
| `config/schemas/creation-workflow.schema.json` | JSON Schema Draft-07 validation for workflow config |
| `tests/RuneAndRust.Domain.UnitTests/Enums/CharacterCreationStepTests.cs` | 14 test methods (38 cases) for enum and extensions |
| `tests/RuneAndRust.Domain.UnitTests/Entities/CharacterCreationStateTests.cs` | 27 test methods for state entity |
| `changelogs/v0.17.5a-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 3 glossary entries (sortOrder 49-51) |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off v0.17.5a deliverables and acceptance criteria |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.5 deliverable checkboxes |

---

## Notes

- Total unit tests for v0.17.5a: 41 test methods expanding to 65 test cases via parameterization
- Build: 0 errors, 0 warnings
- The design specification estimated ~3 tests; 41 methods (65 cases) were implemented for comprehensive coverage
- `CharacterCreationState` is a transient entity — not persisted to the database. Only the final character entity is saved upon creation confirmation
- Clan-Born lineage requires a `FlexibleAttributeBonus` selection before the player can advance from Step 1
- Only the Archetype step (Step 4) is a permanent choice — all other selections can be changed via backward navigation
- The `IsComplete` property checks for presence of selections, not detailed validity — per-step validation is handled by `IsStepComplete`
- Navigation backward preserves all existing selections — no data is lost when going back
- `SessionId` is a 32-character hexadecimal string (GUID with no hyphens) for compact session tracking
- Extension file placed in `Extensions/` folder (not `Enums/`) per codebase convention (35+ existing extension files follow this pattern)
- `AttributeAllocationState.IsComplete` (not `IsValid`) is used for Step 3 validation, matching the actual API of the value object
- All new files follow established codebase patterns: `═══════` section separators, copyright headers, comprehensive XML documentation, exhaustive structured logging
