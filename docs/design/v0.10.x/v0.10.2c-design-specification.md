# v0.10.2c Design Specification: Prerequisites & Respec

**Version:** 0.10.2c
**Parent:** v0.10.2 (Ability Trees)
**Prerequisites:** v0.10.2b Complete (Talent Point Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~14

---

## 1. Overview

### Purpose

Implement prerequisite validation for talent nodes and the respec system for reallocating points. Prerequisites can be other nodes that must be unlocked first or stat requirements that must be met. The respec system refunds all spent points and removes granted abilities, allowing players to completely reallocate their talent build for a configurable gold cost.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `IPrerequisiteValidator`, `IRespecService`, `IRespecConfiguration` |
| **Services** | `PrerequisiteValidator`, `RespecService` |
| **DTOs** | `PrerequisiteResult`, `RespecResult` |
| **Events** | `RespecCompletedEvent` |
| **Configuration** | `respec.json` |
| **Tests** | ~14 unit tests |

---

## 2. Feature Overview

```
v0.10.2c Features
├── IPrerequisiteValidator Interface
│   ├── ValidatePrerequisites(player, node)
│   ├── AreNodePrerequisitesMet(player, node)
│   ├── AreStatPrerequisitesMet(player, node)
│   └── GetMissingPrerequisites(player, node)
│
├── PrerequisiteValidator Implementation
│   ├── Check node prerequisites (required talents)
│   ├── Check stat prerequisites (STR >= 14)
│   └── Return detailed failure reasons
│
├── IRespecService Interface
│   ├── CanAffordRespec(player)
│   ├── GetRespecCost(player)
│   ├── Respec(player)
│   └── GetRefundAmount(player)
│
├── RespecService Implementation
│   ├── Calculate cost: base + (level * multiplier)
│   ├── Refund all spent points
│   ├── Clear all allocations
│   ├── Remove unlocked abilities
│   └── Deduct gold cost
│
├── Ability Rank Scaling
│   ├── ValuePerRank configuration
│   ├── Scale effects based on rank
│   └── Higher ranks = enhanced abilities
│
├── Result Types
│   ├── PrerequisiteResult (IsValid, FailureReasons)
│   └── RespecResult (Success, PointsRefunded, GoldSpent)
│
├── Events
│   └── RespecCompletedEvent
│
└── Configuration (respec.json)
    ├── BaseRespecCost: 100
    └── LevelMultiplier: 10
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 PREREQUISITE VALIDATION ARCHITECTURE                    │
└─────────────────────────────────────────────────────────────────────────┘

                          SpendPoint request
                                 │
                                 ▼
                    ┌───────────────────────────┐
                    │  IPrerequisiteValidator    │
                    ├───────────────────────────┤
                    │ + ValidatePrerequisites   │
                    └───────────────┬───────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            ▼                       ▼                       ▼
   [Node Prerequisites]    [Stat Prerequisites]    [Tier Requirements]
            │                       │                       │
            ▼                       ▼                       ▼
   ┌────────────────┐     ┌────────────────┐     ┌────────────────┐
   │ Has "frenzy"   │     │ STR >= 14?     │     │ Tier 1 nodes   │
   │ allocated?     │     │                │     │ unlocked?      │
   └────────────────┘     └────────────────┘     └────────────────┘
            │                       │                       │
            └───────────────────────┴───────────────────────┘
                                    │
                                    ▼
                          PrerequisiteResult
                          (IsValid, Reasons)


    RESPEC FLOW
    ───────────

    Before Respec:                      After Respec:
    ┌─────────────────────────┐        ┌─────────────────────────┐
    │ Player                  │        │ Player                  │
    │ UnspentPoints: 0        │        │ UnspentPoints: 8        │
    │ Gold: 500               │        │ Gold: 380               │
    │ Allocations:            │ ─────▶ │ Allocations:            │
    │   frenzy: rank 2        │ Respec │   (empty)               │
    │   shield-wall: rank 3   │        │                         │
    │   taunt: rank 1         │        │ Abilities Removed:      │
    │   iron-skin: rank 1     │        │   frenzy, shield-wall,  │
    │ (8 points spent)        │        │   taunt, iron-skin      │
    └─────────────────────────┘        └─────────────────────────┘

    Cost: 100 + (10 * level) gold
```

---

## 4. IPrerequisiteValidator Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IPrerequisiteValidator.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Validates prerequisites for talent node allocation.
/// </summary>
public interface IPrerequisiteValidator
{
    /// <summary>Validates all prerequisites for a node.</summary>
    /// <param name="player">The player attempting allocation.</param>
    /// <param name="node">The node to validate.</param>
    /// <returns>Validation result with detailed failure reasons.</returns>
    PrerequisiteResult ValidatePrerequisites(Player player, AbilityTreeNode node);

    /// <summary>Checks if node prerequisites are met.</summary>
    /// <param name="player">The player.</param>
    /// <param name="node">The node to check.</param>
    /// <returns>True if all required nodes are unlocked.</returns>
    bool AreNodePrerequisitesMet(Player player, AbilityTreeNode node);

    /// <summary>Checks if stat prerequisites are met.</summary>
    /// <param name="player">The player.</param>
    /// <param name="node">The node to check.</param>
    /// <returns>True if all stat requirements are met.</returns>
    bool AreStatPrerequisitesMet(Player player, AbilityTreeNode node);

    /// <summary>Gets a list of missing prerequisite node IDs.</summary>
    /// <param name="player">The player.</param>
    /// <param name="node">The node to check.</param>
    /// <returns>List of node IDs that are not yet unlocked.</returns>
    IReadOnlyList<string> GetMissingPrerequisites(Player player, AbilityTreeNode node);

    /// <summary>Gets a list of unmet stat prerequisites.</summary>
    /// <param name="player">The player.</param>
    /// <param name="node">The node to check.</param>
    /// <returns>List of stat requirements not met.</returns>
    IReadOnlyList<StatPrerequisite> GetUnmetStatPrerequisites(Player player, AbilityTreeNode node);
}
```

---

## 5. PrerequisiteValidator Implementation

**File:** `src/Core/RuneAndRust.Application/Services/PrerequisiteValidator.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class PrerequisiteValidator : IPrerequisiteValidator
{
    private readonly ITalentPointService _talentService;
    private readonly IAbilityTreeProvider _treeProvider;
    private readonly ILogger<PrerequisiteValidator> _logger;

    public PrerequisiteValidator(
        ITalentPointService talentService,
        IAbilityTreeProvider treeProvider,
        ILogger<PrerequisiteValidator> logger)
    {
        _talentService = talentService;
        _treeProvider = treeProvider;
        _logger = logger;
    }

    public PrerequisiteResult ValidatePrerequisites(Player player, AbilityTreeNode node)
    {
        var failureReasons = new List<string>();

        // Check node prerequisites
        foreach (var prereqNodeId in node.PrerequisiteNodeIds)
        {
            var prereqRank = _talentService.GetNodeRank(player, prereqNodeId);
            if (prereqRank == 0)
            {
                var prereqNode = _treeProvider.FindNode(prereqNodeId);
                var prereqName = prereqNode?.Name ?? prereqNodeId;
                failureReasons.Add($"Requires '{prereqName}' to be unlocked");
            }
        }

        // Check stat prerequisites
        foreach (var statPrereq in node.StatPrerequisites)
        {
            var statValue = player.GetStatValue(statPrereq.StatId);
            if (statValue < statPrereq.MinValue)
            {
                failureReasons.Add($"Requires {statPrereq.StatId.ToUpperInvariant()} >= {statPrereq.MinValue} (have {statValue})");
            }
        }

        if (failureReasons.Any())
        {
            _logger.LogDebug("Prerequisites not met for {Node}: {Reasons}",
                node.NodeId, string.Join(", ", failureReasons));
            return PrerequisiteResult.Failed(failureReasons);
        }

        return PrerequisiteResult.Valid();
    }

    public bool AreNodePrerequisitesMet(Player player, AbilityTreeNode node)
    {
        return node.PrerequisiteNodeIds.All(prereqId =>
            _talentService.GetNodeRank(player, prereqId) > 0);
    }

    public bool AreStatPrerequisitesMet(Player player, AbilityTreeNode node)
    {
        return node.StatPrerequisites.All(prereq =>
            player.GetStatValue(prereq.StatId) >= prereq.MinValue);
    }

    public IReadOnlyList<string> GetMissingPrerequisites(Player player, AbilityTreeNode node)
    {
        return node.PrerequisiteNodeIds
            .Where(prereqId => _talentService.GetNodeRank(player, prereqId) == 0)
            .ToList();
    }

    public IReadOnlyList<StatPrerequisite> GetUnmetStatPrerequisites(Player player, AbilityTreeNode node)
    {
        return node.StatPrerequisites
            .Where(prereq => player.GetStatValue(prereq.StatId) < prereq.MinValue)
            .ToList();
    }
}
```

---

## 6. PrerequisiteResult Record

**File:** `src/Core/RuneAndRust.Application/DTOs/PrerequisiteResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of prerequisite validation.
/// </summary>
public record PrerequisiteResult(
    bool IsValid,
    IReadOnlyList<string> FailureReasons)
{
    public static PrerequisiteResult Valid()
        => new(true, Array.Empty<string>());

    public static PrerequisiteResult Failed(IEnumerable<string> reasons)
        => new(false, reasons.ToList());

    public static PrerequisiteResult Failed(string reason)
        => new(false, new[] { reason });

    /// <summary>Whether there are any failure reasons.</summary>
    public bool HasFailures => FailureReasons.Any();

    /// <summary>Gets a combined failure message.</summary>
    public string GetCombinedMessage()
        => string.Join("; ", FailureReasons);
}
```

---

## 7. IRespecService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IRespecService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for respeccing talent allocations.
/// </summary>
public interface IRespecService
{
    /// <summary>Checks if player can afford respec.</summary>
    /// <param name="player">The player.</param>
    /// <returns>True if player has enough gold.</returns>
    bool CanAffordRespec(Player player);

    /// <summary>Gets the cost to respec.</summary>
    /// <param name="player">The player.</param>
    /// <returns>Gold cost for respec.</returns>
    int GetRespecCost(Player player);

    /// <summary>Performs a full respec, refunding all points.</summary>
    /// <param name="player">The player to respec.</param>
    /// <returns>Result of the respec operation.</returns>
    RespecResult Respec(Player player);

    /// <summary>Gets number of points that would be refunded.</summary>
    /// <param name="player">The player.</param>
    /// <returns>Total points to refund.</returns>
    int GetRefundAmount(Player player);

    /// <summary>Gets the list of abilities that would be removed.</summary>
    /// <param name="player">The player.</param>
    /// <returns>List of ability IDs that would be removed.</returns>
    IReadOnlyList<string> GetAbilitiesToRemove(Player player);

    /// <summary>Checks if player has any allocations to reset.</summary>
    /// <param name="player">The player.</param>
    /// <returns>True if player has allocations.</returns>
    bool HasAllocations(Player player);
}
```

---

## 8. IRespecConfiguration Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IRespecConfiguration.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Configuration for respec costs.
/// </summary>
public interface IRespecConfiguration
{
    /// <summary>Base gold cost for respec.</summary>
    int BaseRespecCost { get; }

    /// <summary>Additional gold per player level.</summary>
    int LevelMultiplier { get; }

    /// <summary>Whether respec is enabled.</summary>
    bool IsRespecEnabled { get; }

    /// <summary>Minimum level required to respec.</summary>
    int MinimumLevelToRespec { get; }
}
```

---

## 9. RespecService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/RespecService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class RespecService : IRespecService
{
    private readonly IAbilityTreeProvider _treeProvider;
    private readonly IAbilityService _abilityService;
    private readonly IEventBus _eventBus;
    private readonly IRespecConfiguration _config;
    private readonly ILogger<RespecService> _logger;

    public RespecService(
        IAbilityTreeProvider treeProvider,
        IAbilityService abilityService,
        IEventBus eventBus,
        IRespecConfiguration config,
        ILogger<RespecService> logger)
    {
        _treeProvider = treeProvider;
        _abilityService = abilityService;
        _eventBus = eventBus;
        _config = config;
        _logger = logger;
    }

    public bool CanAffordRespec(Player player)
    {
        return player.Gold >= GetRespecCost(player);
    }

    public int GetRespecCost(Player player)
    {
        // Cost = Base + (Level * Multiplier)
        return _config.BaseRespecCost + (player.Level * _config.LevelMultiplier);
    }

    public RespecResult Respec(Player player)
    {
        // Check if enabled
        if (!_config.IsRespecEnabled)
        {
            return RespecResult.Disabled();
        }

        // Check minimum level
        if (player.Level < _config.MinimumLevelToRespec)
        {
            return RespecResult.LevelTooLow(_config.MinimumLevelToRespec, player.Level);
        }

        // Check if has allocations
        if (!HasAllocations(player))
        {
            return RespecResult.NothingToRespec();
        }

        // Check if can afford
        var cost = GetRespecCost(player);
        if (!CanAffordRespec(player))
        {
            return RespecResult.CannotAfford(cost, player.Gold);
        }

        // Calculate refund
        var pointsToRefund = GetRefundAmount(player);

        // Collect abilities to remove (distinct list)
        var abilitiesToRemove = GetAbilitiesToRemove(player);

        _logger.LogInformation("{Player} initiating respec: {Points} points, {Abilities} abilities, {Cost} gold",
            player.Name, pointsToRefund, abilitiesToRemove.Count, cost);

        // Refund points (before clearing allocations for safety)
        player.RefundAllTalentPoints();

        // Clear all allocations
        player.ClearTalentAllocations();

        // Deduct gold
        player.SpendGold(cost);

        // Remove abilities granted by talents
        foreach (var abilityId in abilitiesToRemove)
        {
            _abilityService.RemoveAbility(player, abilityId);
            _logger.LogDebug("Removed ability {AbilityId} from {Player}", abilityId, player.Name);
        }

        _logger.LogInformation("{Player} respec complete: refunded {Points} points, cost {Cost} gold, removed {Count} abilities",
            player.Name, pointsToRefund, cost, abilitiesToRemove.Count);

        _eventBus.Publish(new RespecCompletedEvent(
            player.Id,
            pointsToRefund,
            cost,
            abilitiesToRemove.ToList()));

        return RespecResult.Success(pointsToRefund, cost, abilitiesToRemove.Count);
    }

    public int GetRefundAmount(Player player)
    {
        return player.TalentAllocations.Sum(a => a.GetTotalPointsSpent());
    }

    public IReadOnlyList<string> GetAbilitiesToRemove(Player player)
    {
        return player.TalentAllocations
            .Select(a => _treeProvider.FindNode(a.NodeId)?.AbilityId)
            .Where(id => id is not null)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList()!;
    }

    public bool HasAllocations(Player player)
    {
        return player.TalentAllocations.Any();
    }
}
```

---

## 10. RespecResult Record

**File:** `src/Core/RuneAndRust.Application/DTOs/RespecResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of a respec operation.
/// </summary>
public record RespecResult(
    bool IsSuccess,
    RespecResultType ResultType,
    int PointsRefunded,
    int GoldSpent,
    int AbilitiesRemoved,
    string? FailureReason)
{
    public static RespecResult Success(int points, int gold, int abilities)
        => new(true, RespecResultType.Success, points, gold, abilities, null);

    public static RespecResult CannotAfford(int cost, int available)
        => new(false, RespecResultType.CannotAfford, 0, 0, 0,
            $"Need {cost} gold, have {available}");

    public static RespecResult NothingToRespec()
        => new(false, RespecResultType.NoAllocations, 0, 0, 0,
            "No talent allocations to reset");

    public static RespecResult Disabled()
        => new(false, RespecResultType.Disabled, 0, 0, 0,
            "Respec is currently disabled");

    public static RespecResult LevelTooLow(int required, int current)
        => new(false, RespecResultType.LevelTooLow, 0, 0, 0,
            $"Must be level {required} to respec (currently {current})");
}

/// <summary>
/// Types of respec results.
/// </summary>
public enum RespecResultType
{
    /// <summary>Respec completed successfully.</summary>
    Success,

    /// <summary>Not enough gold.</summary>
    CannotAfford,

    /// <summary>No allocations to reset.</summary>
    NoAllocations,

    /// <summary>Respec feature is disabled.</summary>
    Disabled,

    /// <summary>Player level too low to respec.</summary>
    LevelTooLow
}
```

---

## 11. RespecCompletedEvent

**File:** `src/Core/RuneAndRust.Application/Events/RespecCompletedEvent.cs`

```csharp
namespace RuneAndRust.Application.Events;

/// <summary>Published when a player completes a respec.</summary>
public record RespecCompletedEvent(
    Guid PlayerId,
    int PointsRefunded,
    int GoldSpent,
    IReadOnlyList<string> AbilitiesRemoved);
```

---

## 12. RespecConfiguration

**File:** `src/Core/RuneAndRust.Infrastructure/Configuration/RespecConfiguration.cs`

```csharp
namespace RuneAndRust.Infrastructure.Configuration;

public class RespecConfiguration : IRespecConfiguration
{
    public int BaseRespecCost { get; set; } = 100;
    public int LevelMultiplier { get; set; } = 10;
    public bool IsRespecEnabled { get; set; } = true;
    public int MinimumLevelToRespec { get; set; } = 2;
}
```

---

## 13. Configuration File

**File:** `config/respec.json`

```json
{
  "$schema": "./schemas/respec.schema.json",
  "respec": {
    "baseRespecCost": 100,
    "levelMultiplier": 10,
    "isRespecEnabled": true,
    "minimumLevelToRespec": 2
  }
}
```

---

## 14. Ability Rank Scaling

**Updates to:** `src/Core/RuneAndRust.Application/Services/AbilityService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public partial class AbilityService
{
    private readonly ITalentPointService _talentPointService;
    private readonly IAbilityTreeProvider _treeProvider;

    /// <summary>Gets the scaled value for an ability based on talent rank.</summary>
    public int GetScaledAbilityValue(Player player, AbilityDefinition ability, string nodeId)
    {
        var rank = _talentPointService.GetNodeRank(player, nodeId);
        if (rank <= 0) return ability.BaseValue;

        // Scale: BaseValue + (ValuePerRank * (rank - 1))
        return ability.BaseValue + (ability.ValuePerRank * (rank - 1));
    }

    /// <summary>Finds the node ID that grants an ability.</summary>
    public string? GetNodeIdForAbility(string abilityId)
    {
        var trees = _treeProvider.GetAllTrees();
        foreach (var tree in trees)
        {
            var node = tree.GetAllNodes().FirstOrDefault(n =>
                n.AbilityId.Equals(abilityId, StringComparison.OrdinalIgnoreCase));
            if (node is not null)
            {
                return node.NodeId;
            }
        }
        return null;
    }
}
```

---

## 15. Rank Scaling Visualization

```
ABILITY RANK SCALING:
═══════════════════════════════════════════════════════════════════════

    FRENZY (Multi-rank talent)
    ─────────────────────────
    
    ┌──────────┬────────────────────┬───────────────────────────────┐
    │ Rank     │ Cost               │ Effect                        │
    ├──────────┼────────────────────┼───────────────────────────────┤
    │ 0        │ -                  │ Ability not available         │
    │ 1        │ 1 point            │ +10% attack speed (base)      │
    │ 2        │ +1 point (2 total) │ +15% attack speed             │
    │ 3        │ +1 point (3 total) │ +20% attack speed (max)       │
    └──────────┴────────────────────┴───────────────────────────────┘

    Formula: BaseValue + (ValuePerRank * (Rank - 1))
    Example: 10 + (5 * (3 - 1)) = 10 + 10 = 20% at rank 3


RESPEC COST SCALING:
═══════════════════════════════════════════════════════════════════════

    Formula: BaseRespecCost + (Level * LevelMultiplier)
    Config:  Base = 100, Multiplier = 10

    ┌──────────┬────────────────────────────────┐
    │ Level    │ Respec Cost                    │
    ├──────────┼────────────────────────────────┤
    │ 1        │ 100 + (1 * 10) = 110 gold      │
    │ 5        │ 100 + (5 * 10) = 150 gold      │
    │ 10       │ 100 + (10 * 10) = 200 gold     │
    │ 20       │ 100 + (20 * 10) = 300 gold     │
    └──────────┴────────────────────────────────┘


FULL RESPEC FLOW:
═══════════════════════════════════════════════════════════════════════

    Player (Level 10) with allocations:
    ├── frenzy: rank 3 (3 pts spent)
    ├── bloodlust: rank 1 (1 pt spent)
    ├── shield-wall: rank 2 (2 pts spent)
    ├── taunt: rank 1 (1 pt spent)
    └── UnspentPoints: 0, Gold: 500

    Respec():
    ├── Calculate cost: 100 + (10 * 10) = 200 gold
    ├── Check can afford: 500 >= 200 ✓
    ├── Calculate refund: 3 + 1 + 2 + 1 = 7 points
    ├── Get abilities to remove: [frenzy, bloodlust, shield-wall, taunt]
    ├── RefundAllTalentPoints(): UnspentPoints += 7
    ├── ClearTalentAllocations(): Remove all
    ├── SpendGold(200): Gold = 300
    ├── RemoveAbility(): For each ability
    └── Publish RespecCompletedEvent

    After Respec:
    ├── Allocations: (empty)
    ├── UnspentPoints: 7
    ├── Gold: 300
    └── Abilities: removed from player
```

---

## 16. Unit Testing Requirements (~14 tests)

| Feature | Tests |
|---------|-------|
| ValidatePrerequisites returns Valid when met | 1 |
| ValidatePrerequisites returns Failed for missing node | 1 |
| ValidatePrerequisites returns Failed for unmet stat | 1 |
| AreNodePrerequisitesMet returns true when all unlocked | 1 |
| AreNodePrerequisitesMet returns false when missing | 1 |
| AreStatPrerequisitesMet returns true when met | 1 |
| AreStatPrerequisitesMet returns false when unmet | 1 |
| GetMissingPrerequisites lists missing nodes | 1 |
| GetRespecCost calculates correctly | 1 |
| CanAffordRespec returns true when enough gold | 1 |
| CanAffordRespec returns false when insufficient | 1 |
| Respec refunds all points | 1 |
| Respec removes abilities | 1 |
| Respec fails when no allocations | 1 |

---

## 17. Acceptance Criteria

- [ ] Node prerequisites checked before allocation
- [ ] Cannot allocate without meeting node prerequisites
- [ ] Stat prerequisites checked before allocation
- [ ] Cannot allocate without meeting stat prerequisites
- [ ] ValidatePrerequisites returns detailed failure reasons
- [ ] GetMissingPrerequisites lists unmet node requirements
- [ ] GetUnmetStatPrerequisites lists unmet stat requirements
- [ ] Respec refunds all spent points
- [ ] Respec clears all allocations
- [ ] Respec removes abilities granted by talents
- [ ] Respec costs gold (base + level * multiplier)
- [ ] Respec cost scales with player level
- [ ] CanAffordRespec checks gold correctly
- [ ] Respec fails gracefully when no allocations
- [ ] Respec fails when insufficient gold
- [ ] RespecCompletedEvent fires with full details
- [ ] Higher talent ranks provide enhanced effects
- [ ] Rank scaling is configurable per ability
- [ ] ~14 unit tests pass

---

## 18. Dependencies

| From | Required |
|------|----------|
| v0.10.2a | `IAbilityTreeProvider`, `AbilityTreeNode` |
| v0.10.2b | `ITalentPointService`, `TalentAllocation` |
| Domain | `Player`, stat system |
| Application | `IAbilityService`, `IEventBus` |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
