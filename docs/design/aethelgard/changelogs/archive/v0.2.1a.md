> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.1](../v0.2.x/v0.2.1.md).

# Changelog: v0.2.1a - The Gear (Equipment Integration)

**Release Date:** 2025-12-19
**Total Tests:** 1292 (6 new tests, 5 updated tests)

## Summary

This release connects the inventory system to the combat engine, transitioning combat from "Debug Mode" (hardcoded damage dice and Sturdiness-based soak) to "Live Mode" (variable damage from equipped weapons and soak from armor). The implementation introduces equipment snapshotting on Combatant creation, refactors AttackResolutionService to use combatant-cached equipment stats, adds a CombatResult record for end-of-combat rewards, and integrates the LootService for victory loot generation. Key architectural changes include replacing the hardcoded `WeaponDice` dictionary with `Combatant.WeaponDamageDie`, changing soak calculation from `Sturdiness` attribute to `Combatant.ArmorSoak`, and transitioning attack types from die-size modifiers to flat damage bonuses (+0/+2/+4).

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/Combat/CombatResult.cs` | Record encapsulating combat outcome including victory state, XP earned, loot found, and summary message |

---

## Files Modified

### Core Layer

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Enemy.cs` | Added equipment properties: `WeaponDamageDie` (default 4), `WeaponAccuracyBonus` (default 0), `ArmorSoak` (default 0), `WeaponName` (default "Claws") |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added equipment snapshot properties; updated `FromCharacter` factory to query equipped MainHand weapon and sum armor SoakBonus; updated `FromEnemy` factory to copy enemy equipment stats |
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Changed `EndCombat()` return type from `void` to `CombatResult?` |

### Engine Layer

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `ILootService` dependency; implemented loot generation on victory in `EndCombat`; returns `CombatResult` with XP and loot |
| `RuneAndRust.Engine/Services/AttackResolutionService.cs` | Replaced `WeaponDice` dictionary with `DamageBonuses`; refactored damage calculation to use `attacker.WeaponDamageDie` and `defender.ArmorSoak`; attack types now add damage bonuses instead of changing die size |

### Test Layer

| File | Change |
|------|--------|
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `ILootService` mock to constructor with default `LootResult.Empty()` setup |
| `RuneAndRust.Tests/Engine/AttackResolutionServiceTests.cs` | Updated helper methods with equipment parameters; updated 5 damage/soak tests for new mechanics; added 3 new equipment integration tests |

---

## Code Implementation Details

### CombatResult Record

**File:** `RuneAndRust.Core/Models/Combat/CombatResult.cs`

```csharp
public record CombatResult(
    bool Victory,
    int XpEarned,
    List<Item> LootFound,
    string Summary
);
```

**Properties:**
- `Victory`: Whether the player won the combat encounter
- `XpEarned`: Experience points earned (placeholder: 50 XP)
- `LootFound`: Items dropped by defeated enemies via LootService
- `Summary`: Human-readable outcome message

### Enemy Equipment Properties

**File:** `RuneAndRust.Core/Entities/Enemy.cs`

```csharp
#region Equipment Stats (Snapshot for Combat)

public int WeaponDamageDie { get; set; } = 4;      // Default d4 (claws/unarmed)
public int WeaponAccuracyBonus { get; set; } = 0;
public int ArmorSoak { get; set; } = 0;
public string WeaponName { get; set; } = "Claws";

#endregion
```

**Purpose:** Provides equipment stats for enemy combatants without requiring the full Equipment entity system.

### Combatant Equipment Snapshot

**File:** `RuneAndRust.Core/Models/Combat/Combatant.cs`

**New Properties:**
```csharp
#region Equipment Snapshot

public int WeaponDamageDie { get; set; } = 4;      // Default unarmed d4
public int WeaponAccuracyBonus { get; set; } = 0;
public int ArmorSoak { get; set; } = 0;
public string WeaponName { get; set; } = "Fists";

#endregion
```

**Updated FromCharacter Factory:**
```csharp
public static Combatant FromCharacter(CharacterEntity c)
{
    // Find equipped weapon (MainHand slot)
    var weapon = c.Inventory?
        .Where(i => i.IsEquipped && i.Item is Equipment eq && eq.Slot == EquipmentSlot.MainHand)
        .Select(i => i.Item as Equipment)
        .FirstOrDefault();

    // Calculate total soak from all equipped armor pieces
    var totalSoak = c.Inventory?
        .Where(i => i.IsEquipped && i.Item is Equipment)
        .Sum(i => ((Equipment)i.Item!).SoakBonus) ?? 0;

    return new Combatant
    {
        Name = c.Name,
        IsPlayer = true,
        CharacterSource = c,
        CurrentHp = c.CurrentHP,
        MaxHp = c.MaxHP,
        CurrentStamina = c.CurrentStamina,
        MaxStamina = c.MaxStamina,
        // Equipment snapshot
        WeaponDamageDie = weapon?.DamageDie ?? 4,
        WeaponAccuracyBonus = 0,
        ArmorSoak = totalSoak,
        WeaponName = weapon?.Name ?? "Fists"
    };
}
```

**Updated FromEnemy Factory:**
```csharp
public static Combatant FromEnemy(Enemy e) => new()
{
    Name = e.Name,
    IsPlayer = false,
    EnemySource = e,
    CurrentHp = e.CurrentHp,
    MaxHp = e.MaxHp,
    CurrentStamina = e.CurrentStamina,
    MaxStamina = e.MaxStamina,
    // Enemy equipment stats
    WeaponDamageDie = e.WeaponDamageDie,
    WeaponAccuracyBonus = e.WeaponAccuracyBonus,
    ArmorSoak = e.ArmorSoak,
    WeaponName = e.WeaponName
};
```

**Equipment Priority Logic:**
- Weapon: MainHand equipped item → Unarmed fallback (d4, "Fists")
- Armor Soak: Sum of all equipped items' SoakBonus

### AttackResolutionService Refactoring

**File:** `RuneAndRust.Engine/Services/AttackResolutionService.cs`

**Old Configuration (Removed):**
```csharp
// REMOVED: Attack type determined weapon die
private static readonly Dictionary<AttackType, int> WeaponDice = new()
{
    { AttackType.Light, 4 },    // d4
    { AttackType.Standard, 6 }, // d6
    { AttackType.Heavy, 8 }     // d8
};
```

**New Configuration (Added):**
```csharp
// NEW: Attack type adds damage bonus
private static readonly Dictionary<AttackType, int> DamageBonuses = new()
{
    { AttackType.Light, 0 },    // No bonus
    { AttackType.Standard, 2 }, // +2 damage
    { AttackType.Heavy, 4 }     // +4 damage
};
```

**Updated Attack Type Properties:**

| Type | Stamina Cost | Weapon Die | Damage Bonus | Hit Modifier |
|------|--------------|------------|--------------|--------------|
| Light | 15 | From Combatant | +0 | +1 |
| Standard | 25 | From Combatant | +2 | 0 |
| Heavy | 40 | From Combatant | +4 | -1 |

**Updated Damage Calculation:**
```csharp
// Roll weapon damage using attacker's equipped weapon die
var weaponDamage = _dice.RollSingle(attacker.WeaponDamageDie,
    $"{attacker.Name} Weapon ({attacker.WeaponName})");

// Raw damage = Might + Weapon Roll + Attack Type Bonus
var damageBonus = DamageBonuses[attackType];
rawDamage = attacker.GetAttribute(CharacterAttribute.Might) + weaponDamage + damageBonus;

// Apply outcome modifiers (glancing halves, critical doubles)
rawDamage = ApplyDamageModifier(rawDamage, outcome);

// Calculate soak from defender's armor (was: Sturdiness attribute)
var soak = defender.ArmorSoak;

// Final damage (minimum 1 on hit)
finalDamage = Math.Max(1, rawDamage - soak);
```

**Damage Formula Comparison:**

| Version | Raw Damage Formula | Soak Source |
|---------|-------------------|-------------|
| v0.2.0b | `Might + WeaponDice[AttackType]` | `Sturdiness` attribute |
| v0.2.1a | `Might + WeaponDamageDie + DamageBonus[AttackType]` | `ArmorSoak` property |

### CombatService EndCombat Update

**File:** `RuneAndRust.Engine/Services/CombatService.cs`

**New Dependency:**
```csharp
private readonly ILootService _lootService;
```

**Updated EndCombat Implementation:**
```csharp
public CombatResult? EndCombat()
{
    if (_gameState.CombatState == null)
    {
        _logger.LogWarning("EndCombat called but no combat is active");
        return null;
    }

    var victory = CheckVictoryCondition();
    var loot = new List<Item>();
    var xp = 0;

    if (victory)
    {
        var character = _gameState.CurrentCharacter;
        var witsBonus = character?.GetEffectiveAttribute(CharacterAttribute.Wits) ?? 0;

        xp = 50; // Placeholder XP

        var lootContext = new LootGenerationContext(
            BiomeType: BiomeType.Industrial,
            DangerLevel: DangerLevel.Unstable,
            LootTier: null,
            WitsBonus: witsBonus
        );

        var lootResult = _lootService.GenerateLoot(lootContext);
        loot = lootResult.Items.ToList();

        _logger.LogInformation("Combat Victory! XP: {Xp}, Loot: {Count} items", xp, loot.Count);
    }

    _gameState.Phase = GamePhase.Exploration;
    _gameState.CombatState = null;

    return new CombatResult(
        Victory: victory,
        XpEarned: xp,
        LootFound: loot,
        Summary: victory ? "Victory! All enemies defeated." : "Combat ended."
    );
}
```

---

## Damage Calculation Examples

### Example 1: Standard Attack with Equipped Sword (d6)

**Setup:**
- Attacker: Might 5, Sword (d6)
- Defender: ArmorSoak 2
- Attack Type: Standard (+2 damage bonus)
- Weapon Roll: 4

**Calculation:**
```
Raw = Might(5) + Weapon(4) + StandardBonus(2) = 11
Final = Max(1, 11 - 2) = 9 damage
```

### Example 2: Heavy Attack with Greataxe (d8)

**Setup:**
- Attacker: Might 5, Greataxe (d8)
- Defender: ArmorSoak 5
- Attack Type: Heavy (+4 damage bonus)
- Weapon Roll: 6

**Calculation:**
```
Raw = Might(5) + Weapon(6) + HeavyBonus(4) = 15
Final = Max(1, 15 - 5) = 10 damage
```

### Example 3: Unarmed Light Attack

**Setup:**
- Attacker: Might 3, Fists (d4)
- Defender: ArmorSoak 10
- Attack Type: Light (+0 damage bonus)
- Weapon Roll: 2

**Calculation:**
```
Raw = Might(3) + Weapon(2) + LightBonus(0) = 5
Final = Max(1, 5 - 10) = 1 damage (minimum enforced)
```

---

## Logging Matrix (v0.2.1a)

### AttackResolutionService Logs

| Event | Level | Template |
|-------|-------|----------|
| Raw damage calculation | Debug | `"Raw damage: Might {Might} + {WeaponName} d{Die} ({Roll}) + Bonus {Bonus} = {Raw}"` |
| Soak application | Debug | `"Damage reduced by soak: {Raw} - {Soak} = {Final}"` |
| Minimum damage enforced | Debug | `"Minimum damage enforced: {Calculated} -> 1"` |

### CombatService Logs

| Event | Level | Template |
|-------|-------|----------|
| Combat victory rewards | Information | `"Combat Victory! XP: {Xp}, Loot: {Count} items"` |
| EndCombat no combat | Warning | `"EndCombat called but no combat is active"` |
| EndCombat non-victory | Information | `"Combat Ended (non-victory)"` |

---

## Test Coverage

### New Tests Added

#### AttackResolutionServiceTests - Equipment Integration (3 tests)

| Test Name | Description |
|-----------|-------------|
| `ResolveMeleeAttack_UsesAttackerWeaponDamageDie` | Validates d8 weapon uses d8 die, not default d6 |
| `ResolveMeleeAttack_AppliesDefenderArmorSoak` | Validates ArmorSoak reduces damage (11 - 10 = 1) |
| `ResolveMeleeAttack_SoakCannotReduceBelowOne` | Validates 100 soak still results in 1 minimum damage |

### Updated Tests

#### AttackResolutionServiceTests - Updated for New Mechanics (5 tests)

| Test Name | Change |
|-----------|--------|
| `ResolveMeleeAttack_GlancingBlow_HalvesDamage` | Updated formula to include +2 standard bonus; expects 5 damage (was 4) |
| `ResolveMeleeAttack_SolidHit_FullDamage` | Updated to use ArmorSoak instead of Sturdiness; expects 9 damage (was 7) |
| `ResolveMeleeAttack_CriticalHit_DoublesDamage` | Updated with new damage formula; expects 20 damage (was 16) |
| `ResolveMeleeAttack_LightAttack_NoDamageBonus` (renamed) | Changed from `UsesD4AndBonusToHit`; now validates weapon die not attack type |
| `ResolveMeleeAttack_HeavyAttack_AddsDamageBonus` (renamed) | Changed from `UsesD8AndPenaltyToHit`; now validates +4 damage bonus |
| `ResolveMeleeAttack_StandardAttack_UsesWeaponDieAndDamageBonus` (renamed) | Changed from `UsesD6AndNoModifier`; now validates weapon die + +2 bonus |
| `ResolveMeleeAttack_ArmorSoakReducesDamage` (renamed) | Changed from `SoakReducesDamage`; uses ArmorSoak property |
| `ResolveMeleeAttack_MinimumOneDamage_WhenHit` | Updated to use ArmorSoak instead of Sturdiness |
| `ResolveMeleeAttack_LowMightWithHeavyPenalty_MinimumOneDie` | Updated to use ArmorSoak instead of Sturdiness |

### Updated Helper Methods

```csharp
private static Combatant CreatePlayerCombatant(
    int might = 5,
    int finesse = 5,
    int sturdiness = 5,
    int stamina = 60,
    int weaponDamageDie = 6,    // NEW
    int armorSoak = 0,          // NEW
    string weaponName = "Sword" // NEW
)

private static Combatant CreateEnemyCombatant(
    int might = 5,
    int finesse = 3,
    int sturdiness = 5,
    int hp = 50,
    int stamina = 35,
    int weaponDamageDie = 4,    // NEW
    int armorSoak = 0,          // NEW
    string weaponName = "Claws" // NEW
)
```

---

## DI Registration Changes

**File:** `RuneAndRust.Terminal/Program.cs`

No new registrations required - `ILootService` was already registered in v0.1.2c.

---

## Build Verification

```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Test run:
  Passed: 1292
  Failed: 0
  Skipped: 0
```

---

## Directory Structure Changes

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   └── Enemy.cs                         [MODIFIED - Equipment stats]
│   ├── Interfaces/
│   │   └── ICombatService.cs                [MODIFIED - EndCombat returns CombatResult]
│   └── Models/
│       └── Combat/
│           ├── Combatant.cs                 [MODIFIED - Equipment snapshot]
│           └── CombatResult.cs              [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── AttackResolutionService.cs       [MODIFIED - Uses Combatant stats]
│       └── CombatService.cs                 [MODIFIED - LootService, EndCombat]
└── RuneAndRust.Tests/
    └── Engine/
        ├── AttackResolutionServiceTests.cs  [MODIFIED - Equipment tests]
        └── CombatServiceTests.cs            [MODIFIED - ILootService mock]
```

---

## Breaking Changes

### ICombatService.EndCombat Signature

**Before:**
```csharp
void EndCombat();
```

**After:**
```csharp
CombatResult? EndCombat();
```

Consumers of `EndCombat()` must handle the new return type.

### Damage Calculation Semantics

**Before (v0.2.0b):**
- Attack type determines weapon die (Light=d4, Standard=d6, Heavy=d8)
- Soak comes from Sturdiness attribute

**After (v0.2.1a):**
- Weapon die comes from `Combatant.WeaponDamageDie` (equipped weapon or default d4)
- Attack type adds flat damage bonus (Light=+0, Standard=+2, Heavy=+4)
- Soak comes from `Combatant.ArmorSoak` (sum of equipped armor SoakBonus)

---

## Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.2.1a affected tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~AttackResolutionServiceTests|FullyQualifiedName~CombatServiceTests"

# Run only equipment integration tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~Equipment"
```

---

## Test Summary by Category

| Category | Test Count |
|----------|------------|
| AttackResolutionServiceTests | 31 (3 new, 5 updated) |
| CombatServiceTests | 70 |
| Other combat tests | 101 (total combat-related) |
| Other tests | 1191 |
| **Total** | **1292** |

---

## Next Steps (v0.2.1b: The Data-Slate - Enemy AI)

Planned features for the next release:
- Enemy AI turn execution with attack selection
- Threat assessment for target selection
- Enemy attack type preference based on stamina
- Enemy turn messaging in combat log
