# v0.16.3 Smart Loot Generation - Scope Breakdown

**Version:** 0.16.3  
**Theme:** Smart Loot Generation  
**Prerequisites:** v0.16.2 Complete (Armor Proficiency System)  
**Total Estimated Tests:** ~15 new tests

---

## Executive Summary

This version implements "smart loot" - a class-biased drop system that ensures 60% of drops are appropriate for the player's archetype. This reduces frustration from constantly receiving unusable gear while still allowing 40% of drops to be random for experimentation, companion gearing, or trading.

The work is divided into **5 sub-phases**:

| Phase    | Name                      | Focus                                                | Est. Tests |
| -------- | ------------------------- | ---------------------------------------------------- | ---------- |
| v0.16.3a | Equipment Class Mapping   | EquipmentClassAffinity, EquipmentClassMapping        | ~2         |
| v0.16.3b | Smart Loot Algorithm      | SmartLootContext, SmartLootResult, ISmartLootService | ~3         |
| v0.16.3c | Weighted Item Selection   | WeightedItemPool, WeightedItem, selection algorithm  | ~3         |
| v0.16.3d | Loot Service Integration  | Enhanced LootService, LootDrop updates               | ~4         |
| v0.16.3e | Stat Verification Service | IStatVerificationService, StatRange                  | ~3         |

---

## Feature Analysis & Categorization

### Class Mapping

| Feature                      | Complexity | Dependencies           | Assigned Phase |
| ---------------------------- | ---------- | ---------------------- | -------------- |
| EquipmentClassAffinity enum  | Low        | None                   | **v0.16.3a**   |
| EquipmentClassMapping VO     | Medium     | EquipmentClassAffinity | **v0.16.3a**   |
| equipment-class-mapping.json | Low        | EquipmentClassMapping  | **v0.16.3a**   |

### Smart Loot Algorithm

| Feature                  | Complexity | Dependencies      | Assigned Phase |
| ------------------------ | ---------- | ----------------- | -------------- |
| SmartLootContext VO      | Low        | QualityTier       | **v0.16.3b**   |
| SmartLootResult VO       | Low        | SmartLootContext  | **v0.16.3b**   |
| ISmartLootService        | Medium     | All VOs           | **v0.16.3b**   |
| 60% class bias algorithm | Medium     | ISmartLootService | **v0.16.3b**   |

### Weighted Selection

| Feature                   | Complexity | Dependencies           | Assigned Phase |
| ------------------------- | ---------- | ---------------------- | -------------- |
| WeightedItemPool entity   | Medium     | EquipmentClassAffinity | **v0.16.3c**   |
| WeightedItem VO           | Low        | WeightedItemPool       | **v0.16.3c**   |
| Weighted random selection | Medium     | WeightedItemPool       | **v0.16.3c**   |

### Integration

| Feature                      | Complexity | Dependencies      | Assigned Phase |
| ---------------------------- | ---------- | ----------------- | -------------- |
| Enhanced LootService         | Medium     | ISmartLootService | **v0.16.3d**   |
| LootDrop.WasClassAppropriate | Low        | LootService       | **v0.16.3d**   |
| Monster death integration    | Medium     | LootService       | **v0.16.3d**   |

### Stat Verification

| Feature                   | Complexity | Dependencies             | Assigned Phase |
| ------------------------- | ---------- | ------------------------ | -------------- |
| IStatVerificationService  | Medium     | QualityTier              | **v0.16.3e**   |
| StatRange VO              | Low        | IStatVerificationService | **v0.16.3e**   |
| Tier scaling verification | Medium     | StatRange                | **v0.16.3e**   |

---

## Phase Definitions

---

## v0.16.3a: Equipment Class Mapping

[v0.16.3a Design Specification](v0.16.3a-design-specification.md)

### Overview

Defines which equipment categories are appropriate for which archetypes.

### Scope

**In Scope:**

- EquipmentClassAffinity enum (Warrior, Skirmisher, Mystic, Adept, Universal)
- EquipmentClassMapping value object
- equipment-class-mapping.json configuration

**Out of Scope:**

- Smart loot algorithm (v0.16.3b)
- Weighted selection (v0.16.3c)

### Key Deliverables

| Type                 | Count | Details                        |
| -------------------- | ----- | ------------------------------ |
| Domain Enums         | 1     | `EquipmentClassAffinity`       |
| Domain Value Objects | 1     | `EquipmentClassMapping`        |
| Configuration        | 1     | `equipment-class-mapping.json` |
| Unit Tests           | ~2    |                                |

### Weapon to Class Mapping

| Category                   | Primary Affinity | Attribute |
| -------------------------- | ---------------- | --------- |
| Axes, Greatswords, Hammers | Warrior          | MIGHT     |
| Daggers, Blades, Bows      | Skirmisher       | FINESSE   |
| Staves, Focus/Orbs         | Mystic           | WILL      |
| Crossbows, Arc-Cannon      | Adept            | WITS      |
| Light Armor                | Universal        | All       |

### Acceptance Criteria

- [ ] Axes map to Warrior affinity
- [ ] Light armor maps to Universal
- [ ] ~2 unit tests pass

---

## v0.16.3b: Smart Loot Algorithm

[v0.16.3b Design Specification](v0.16.3b-design-specification.md)

### Overview

Implements the 60% class-appropriate loot bias algorithm.

### Scope

**In Scope:**

- SmartLootContext value object
- SmartLootResult value object
- ISmartLootService interface
- 60% class bias with fallback to random

**Out of Scope:**

- Weighted selection (v0.16.3c)
- Service integration (v0.16.3d)

### Key Deliverables

| Type                   | Count | Details                               |
| ---------------------- | ----- | ------------------------------------- |
| Domain Value Objects   | 2     | `SmartLootContext`, `SmartLootResult` |
| Application Interfaces | 1     | `ISmartLootService`                   |
| Unit Tests             | ~3    |                                       |

### Smart Loot Algorithm

```
Roll 0-99
If roll < 60:
  Filter for PlayerClass items
  If items found: Select from filtered pool
  Else: Fall through to random
Else (40%) OR no class items:
  Select from all items of QualityTier
```

### Acceptance Criteria

- [ ] 60% of drops are class-appropriate over large sample
- [ ] Falls back to random when no class items exist
- [ ] Universal items included for all classes
- [ ] ~3 unit tests pass

---

## v0.16.3c: Weighted Item Selection

[v0.16.3c Design Specification](v0.16.3c-design-specification.md)

### Overview

Implements weighted random selection for item drops.

### Scope

**In Scope:**

- WeightedItemPool entity
- WeightedItem value object
- Weighted random selection algorithm

**Out of Scope:**

- Service integration (v0.16.3d)

### Key Deliverables

| Type                 | Count | Details            |
| -------------------- | ----- | ------------------ |
| Domain Entities      | 1     | `WeightedItemPool` |
| Domain Value Objects | 1     | `WeightedItem`     |
| Unit Tests           | ~3    |                    |

### Weight Distribution

| Rarity    | Weight | Notes                 |
| --------- | ------ | --------------------- |
| Common    | 100    | Basic weapons/armor   |
| Uncommon  | 50     | Slightly better stats |
| Rare      | 25     | Notable upgrades      |
| Very Rare | 10     | Significant finds     |
| Unique    | 5      | Special items         |

### Acceptance Criteria

- [ ] Weighted selection favors higher-weight items
- [ ] Zero-weight items never selected
- [ ] Distribution matches expected weights over large sample
- [ ] ~3 unit tests pass

---

## v0.16.3d: Loot Service Integration

[v0.16.3d Design Specification](v0.16.3d-design-specification.md)

### Overview

Integrates smart loot into the existing LootService.

### Scope

**In Scope:**

- Enhanced LootService with smart loot
- LootDrop.WasClassAppropriate flag
- LootDrop.PlayerArchetype field
- Monster death integration

**Out of Scope:**

- Container loot (v0.16.4)
- Unique items (v0.16.5)

### Key Deliverables

| Type                   | Count | Details              |
| ---------------------- | ----- | -------------------- |
| Modified Services      | 1     | Update `LootService` |
| Modified Value Objects | 1     | Update `LootDrop`    |
| Unit Tests             | ~4    |                      |

### Acceptance Criteria

- [ ] GenerateLoot uses smart loot when player provided
- [ ] GenerateLoot falls back to random without player
- [ ] WasClassAppropriate flag set correctly
- [ ] Biome modifiers applied when present
- [ ] ~4 unit tests pass

---

## v0.16.3e: Stat Verification Service

[v0.16.3e Design Specification](v0.16.3e-design-specification.md)

### Overview

Verifies generated items have tier-appropriate stats.

### Scope

**In Scope:**

- IStatVerificationService interface
- StatRange value object
- Tier scaling verification

**Out of Scope:**

- Container loot (v0.16.4)

### Key Deliverables

| Type                   | Count | Details                    |
| ---------------------- | ----- | -------------------------- |
| Application Interfaces | 1     | `IStatVerificationService` |
| Domain Value Objects   | 1     | `StatRange`                |
| Unit Tests             | ~3    |                            |

### Acceptance Criteria

- [ ] Tier 0 items have 1d6 damage
- [ ] Tier 4 items have 2d6+4 damage
- [ ] Attribute bonuses within tier range
- [ ] ~3 unit tests pass

---

## Dependencies & Prerequisites

```
v0.16.2 (Armor Proficiency System) - REQUIRED
    │
    └── v0.16.0: Quality tier system
            │
            ▼
v0.16.3 (Smart Loot Generation)
    │
    ├── v0.16.3a: Equipment Class Mapping ──────────┐
    │       Dependencies: v0.16.1, v0.16.2           │
    │                                                │
    ├── v0.16.3b: Smart Loot Algorithm ─────────────┤
    │       Dependencies: v0.16.3a, v0.16.0          │
    │                                                │
    ├── v0.16.3c: Weighted Item Selection ──────────┤
    │       Dependencies: v0.16.3a                   │
    │                                                │
    ├── v0.16.3d: Loot Service Integration ─────────┤
    │       Dependencies: v0.16.3b, v0.16.3c         │
    │                                                │
    └── v0.16.3e: Stat Verification Service ────────┘
            Dependencies: v0.16.0, v0.16.3d
```

---

## Configuration Files

| File                           | Purpose                         | Phase    |
| ------------------------------ | ------------------------------- | -------- |
| `equipment-class-mapping.json` | Item category to class affinity | v0.16.3a |
| `weighted-items.json`          | Item weights by tier            | v0.16.3c |
| `stat-ranges.json`             | Expected stat ranges per tier   | v0.16.3e |

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.16.3a  | ~3        | 0              | ~2         | Low        |
| v0.16.3b  | ~3        | 0              | ~3         | Medium     |
| v0.16.3c  | ~3        | 0              | ~3         | Medium     |
| v0.16.3d  | ~1        | ~2             | ~4         | Medium     |
| v0.16.3e  | ~2        | 0              | ~3         | Low        |
| **Total** | **~12**   | **~2**         | **~15**    |            |

---

## Risk Assessment

| Risk                          | Impact | Probability | Mitigation                             |
| ----------------------------- | ------ | ----------- | -------------------------------------- |
| 60% bias feels forced         | Low    | Low         | Allow option to disable smart loot     |
| Weight distribution imbalance | Medium | Medium      | Configurable weights, thorough testing |

---

_This scope breakdown provides a structured approach to implementing v0.16.3 Smart Loot Generation. Each sub-phase builds on the previous, allowing for incremental development and testing._
