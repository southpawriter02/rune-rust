> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.5](../v0.3.x/v0.3.5.md).

# Changelog: v0.3.5b - The Cartographer (Minimap)

**Release Date:** 2025-12-21

## Summary

This release implements the MinimapRenderer to display a 3x3 grid of rooms centered on the player's position, with Fog of War visibility tracking. The minimap replaces the placeholder sidebar from v0.3.5a and introduces room symbol resolution based on features (stairs, bosses, settlements, anchors) and danger levels. A new `VisitedRoomIds` HashSet in GameState tracks explored rooms for the Fog of War system. The RoomFeature enum is extended with StairsUp, StairsDown, BossLair, and Settlement values. A batch query `GetRoomsInGridAsync()` is added to IRoomRepository to efficiently fetch the 3x3 grid without N+1 queries. This release includes 22 unit tests for symbol resolution, color logic, and Z-level indicators.

---

## New Files Created

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/MinimapRenderer.cs` | Static helper for 3x3 grid rendering with Fog of War and symbol resolution |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/MinimapRendererTests.cs` | 22 unit tests for symbol/color logic, Fog of War, and Z-level indicators |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/RoomFeature.cs` | Added StairsUp (4), StairsDown (5), BossLair (6), Settlement (7) enum values |
| `RuneAndRust.Core/Models/GameState.cs` | Added `HashSet<Guid> VisitedRoomIds` property for Fog of War tracking |
| `RuneAndRust.Core/Interfaces/IRoomRepository.cs` | Added `GetRoomsInGridAsync(z, minX, maxX, minY, maxY)` batch query method |
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Added PlayerPosition, LocalMapRooms, VisitedRoomIds properties for minimap data |
| `RuneAndRust.Persistence/Repositories/RoomRepository.cs` | Implemented `GetRoomsInGridAsync()` using EF Core LINQ query |
| `RuneAndRust.Engine/Services/NavigationService.cs` | Added `VisitedRoomIds.Add(nextRoomId)` after each successful move |
| `RuneAndRust.Engine/Services/GameService.cs` | Updated `BuildExplorationViewModelAsync()` to fetch 3x3 grid data |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Replaced minimap placeholder with MinimapRenderer.Render() call |
| `RuneAndRust.Terminal/Program.cs` | Added starting room to VisitedRoomIds, updated version to v0.3.5b |

---

## Code Implementation Details

### RoomFeature Enum Extension

```csharp
public enum RoomFeature
{
    None = 0,
    RunicAnchor = 1,    // Sanctuary rest
    Workbench = 2,      // Crafting
    AlchemyTable = 3,   // Potion brewing
    StairsUp = 4,       // Vertical navigation (v0.3.5b)
    StairsDown = 5,     // Vertical navigation (v0.3.5b)
    BossLair = 6,       // Boss encounter room (v0.3.5b)
    Settlement = 7      // Safe zone/vendor (v0.3.5b)
}
```

### GameState VisitedRoomIds

```csharp
/// <summary>
/// Tracks which rooms the player has visited for Fog of War (v0.3.5b).
/// Used by MinimapRenderer to determine visibility.
/// </summary>
public HashSet<Guid> VisitedRoomIds { get; set; } = new();

// In Reset() method:
VisitedRoomIds.Clear();
```

### ExplorationViewModel Extension

```csharp
public record ExplorationViewModel(
    // Existing properties from v0.3.5a...
    string CharacterName,
    int CurrentHp,
    int MaxHp,
    int CurrentStamina,
    int MaxStamina,
    int CurrentStress,
    int MaxStress,
    int CurrentCorruption,
    int MaxCorruption,
    string RoomName,
    string RoomDescription,
    int TurnCount,

    // NEW: Minimap data (v0.3.5b)
    Coordinate PlayerPosition,
    List<Room> LocalMapRooms,
    HashSet<Guid> VisitedRoomIds
);
```

### GetRoomsInGridAsync Repository Method

```csharp
/// <inheritdoc/>
public async Task<IEnumerable<Room>> GetRoomsInGridAsync(int z, int minX, int maxX, int minY, int maxY)
{
    _roomLogger.LogDebug(
        "[Room] Fetching rooms in grid Z={Z}, X=[{MinX},{MaxX}], Y=[{MinY},{MaxY}]",
        z, minX, maxX, minY, maxY);

    var rooms = await _dbSet
        .Where(r => r.Position.Z == z
                 && r.Position.X >= minX && r.Position.X <= maxX
                 && r.Position.Y >= minY && r.Position.Y <= maxY)
        .ToListAsync();

    _roomLogger.LogDebug("[Room] Retrieved {Count} rooms in grid", rooms.Count);

    return rooms;
}
```

### NavigationService Room Visitation Tracking

```csharp
// After line 85 (TurnCount++), added:
_gameState.VisitedRoomIds.Add(nextRoomId);

_logger.LogDebug("[Navigation] Room {RoomId} marked as visited. Total visited: {Count}",
    nextRoomId, _gameState.VisitedRoomIds.Count);
```

### MinimapRenderer Implementation

```csharp
namespace RuneAndRust.Terminal.Rendering;

/// <summary>
/// Renders a 3x3 minimap grid centered on the player position (v0.3.5b).
/// </summary>
public static class MinimapRenderer
{
    private const int Radius = 1;  // 3x3 grid (center ± 1)

    /// <summary>
    /// Renders the minimap panel for the exploration HUD sidebar.
    /// </summary>
    public static Panel Render(Coordinate center, List<Room> localMap, HashSet<Guid> visited)
    {
        var grid = new Grid();

        // Add 3 columns for the 3x3 grid
        for (int i = 0; i < (Radius * 2) + 1; i++)
        {
            grid.AddColumn(new GridColumn().Width(3).NoWrap());
        }

        // Iterate Y from top to bottom (Y+ at top, Y- at bottom)
        for (int y = center.Y + Radius; y >= center.Y - Radius; y--)
        {
            var rowItems = new List<IRenderable>();

            for (int x = center.X - Radius; x <= center.X + Radius; x++)
            {
                var cellPos = new Coordinate(x, y, center.Z);
                var room = localMap.FirstOrDefault(r =>
                    r.Position.X == x && r.Position.Y == y && r.Position.Z == center.Z);

                rowItems.Add(ResolveTile(room, center, cellPos, visited));
            }

            grid.AddRow(rowItems.ToArray());
        }

        // Add Z-level indicator row
        var zIndicator = GetZLevelIndicator(center, localMap);
        grid.AddRow(new Markup(zIndicator), new Text(""), new Text(""));

        return new Panel(grid)
            .Header("[yellow]Sector Map[/]")
            .Border(BoxBorder.Rounded);
    }

    /// <summary>
    /// Resolves the symbol and color for a minimap tile.
    /// </summary>
    public static Markup ResolveTile(Room? room, Coordinate center, Coordinate cellPos, HashSet<Guid> visited)
    {
        // Player position - always visible
        if (cellPos.X == center.X && cellPos.Y == center.Y && cellPos.Z == center.Z)
            return new Markup("[cyan]@[/]");

        // No room at this position
        if (room == null)
            return new Markup("[grey]·[/]");

        // Fog of War - room exists but not visited
        if (!visited.Contains(room.Id))
            return new Markup("[grey]░[/]");

        // Visited room - resolve by feature priority
        var (symbol, color) = GetRoomSymbol(room);
        return new Markup($"[{color}]{symbol}[/]");
    }

    /// <summary>
    /// Gets the symbol and color for a visited room based on its features.
    /// Priority order: Boss > Stairs > Settlement > Anchor > Workstation > Standard
    /// </summary>
    public static (string Symbol, string Color) GetRoomSymbol(Room room)
    {
        if (room.HasFeature(RoomFeature.BossLair))
            return ("☠", "red");

        if (room.HasFeature(RoomFeature.StairsUp))
            return ("▲", "white");

        if (room.HasFeature(RoomFeature.StairsDown))
            return ("▼", "white");

        if (room.HasFeature(RoomFeature.Settlement))
            return ("⌂", "blue");

        if (room.HasFeature(RoomFeature.RunicAnchor))
            return ("◆", "cyan");

        if (room.HasFeature(RoomFeature.Workbench) || room.HasFeature(RoomFeature.AlchemyTable))
            return ("⚒", "yellow");

        // Danger level coloring for standard rooms
        return room.DangerLevel switch
        {
            DangerLevel.Lethal => ("O", "red"),
            DangerLevel.Hostile => ("O", "orange1"),
            DangerLevel.Unstable => ("O", "yellow"),
            _ => ("O", "grey")  // Safe
        };
    }

    /// <summary>
    /// Renders Z-level context indicator showing available vertical movement.
    /// </summary>
    public static string GetZLevelIndicator(Coordinate center, List<Room> localMap)
    {
        var hasUp = localMap.Any(r => r.HasFeature(RoomFeature.StairsUp));
        var hasDown = localMap.Any(r => r.HasFeature(RoomFeature.StairsDown));

        return (hasUp, hasDown) switch
        {
            (true, true) => $"[grey]Z:{center.Z} ▲▼[/]",
            (true, false) => $"[grey]Z:{center.Z} ▲[/]",
            (false, true) => $"[grey]Z:{center.Z} ▼[/]",
            _ => $"[grey]Z:{center.Z}[/]"
        };
    }
}
```

### ExplorationScreenRenderer Minimap Integration

```csharp
// Replaced placeholder code with:
// 3. Update Sidebar (Minimap - v0.3.5b)
var minimapPanel = MinimapRenderer.Render(
    vm.PlayerPosition,
    vm.LocalMapRooms,
    vm.VisitedRoomIds);
rootLayout["Sidebar"].Update(minimapPanel);
```

### GameService ViewModel Building Update

```csharp
private async Task<ExplorationViewModel?> BuildExplorationViewModelAsync()
{
    // ... existing validation ...

    Coordinate playerPosition = Coordinate.Origin;
    List<Room> localMapRooms = new();

    if (_state.CurrentRoomId.HasValue)
    {
        using var scope = _scopeFactory.CreateScope();
        var roomRepo = scope.ServiceProvider.GetRequiredService<IRoomRepository>();
        var room = await roomRepo.GetByIdAsync(_state.CurrentRoomId.Value);
        if (room != null)
        {
            roomName = room.Name;
            roomDescription = room.Description;
            playerPosition = room.Position;

            // Fetch 3x3 grid around player for minimap (v0.3.5b)
            const int radius = 1;
            localMapRooms = (await roomRepo.GetRoomsInGridAsync(
                playerPosition.Z,
                playerPosition.X - radius,
                playerPosition.X + radius,
                playerPosition.Y - radius,
                playerPosition.Y + radius
            )).ToList();

            _logger.LogTrace("[HUD] Fetched {Count} rooms for minimap grid", localMapRooms.Count);
        }
    }

    return new ExplorationViewModel(
        // ... existing properties ...
        PlayerPosition: playerPosition,
        LocalMapRooms: localMapRooms,
        VisitedRoomIds: _state.VisitedRoomIds
    );
}
```

### Program.cs Starting Room Visitation

```csharp
// After: gameState.CurrentRoomId = startRoomId;
gameState.VisitedRoomIds.Add(startRoomId);  // Mark starting room as visited (v0.3.5b)

// For loaded games:
gameState.VisitedRoomIds = loadedState.VisitedRoomIds;  // Restore fog of war (v0.3.5b)
```

---

## Symbol Reference Table

| Symbol | Color | Meaning | RoomFeature/Condition |
|--------|-------|---------|----------------------|
| `@` | Cyan | Player position | Center of grid |
| `░` | Grey | Fog of War | Room not in VisitedRoomIds |
| `·` | Grey | Empty/Void | No room at position |
| `☠` | Red | Boss Lair | BossLair feature |
| `▲` | White | Stairs Up | StairsUp feature |
| `▼` | White | Stairs Down | StairsDown feature |
| `⌂` | Blue | Settlement | Settlement feature |
| `◆` | Cyan | Runic Anchor | RunicAnchor feature |
| `⚒` | Yellow | Workstation | Workbench or AlchemyTable |
| `O` | Red | Lethal Room | DangerLevel.Lethal |
| `O` | Orange | Hostile Room | DangerLevel.Hostile |
| `O` | Yellow | Unstable Room | DangerLevel.Unstable |
| `O` | Grey | Safe Room | DangerLevel.Safe |

---

## User Interface

### Minimap Visual Example

```
┌────────────────┐
│ Sector Map     │
├────────────────┤
│  ░   O   ·     │   ← Y+1 (North)
│  O   @   ▲     │   ← Y=0 (Player row)
│  ⌂   O   O     │   ← Y-1 (South)
│                │
│ Z:0 ▲          │   ← Z-level indicator
└────────────────┘
```

### Complete Exploration HUD (v0.3.5b)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Ragnar     HP: ██████████████░░░░░░ 70/100  STA: ████████████████████ 50/50│
│                                                         Stress: 15%        │
│                                                                             │
├──────────────────────────────────────────────────────┬──────────────────────┤
│ Entry Hall                                           │ Sector Map           │
│ ──────────────────────────────────────────────────── │ ────────────────     │
│                                                      │                      │
│ A vast chamber of corroded iron and crumbling        │   ░   O   ·          │
│ stone. The air is thick with the scent of ozone      │   O   @   ▲          │
│ and ancient dust. Shadows pool in the corners,       │   ⌂   O   O          │
│ and the faint hum of dormant machinery echoes        │                      │
│ from somewhere below.                                │  Z:0 ▲               │
│                                                      │                      │
│                                                      │                      │
├──────────────────────────────────────────────────────┴──────────────────────┤
│ Turn 1                                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Minimap Grid Structure

```
       X-1    X=0    X+1
      ┌─────┬─────┬─────┐
Y+1   │  ░  │  O  │  ·  │   North (Y+)
      ├─────┼─────┼─────┤
Y=0   │  O  │  @  │  ▲  │   Player row
      ├─────┼─────┼─────┤
Y-1   │  ⌂  │  O  │  O  │   South (Y-)
      └─────┴─────┴─────┘
              ↓
          Z:0 ▲  (Z-level indicator)
```

---

## Test Coverage

### MinimapRendererTests (22 tests)

| Test Name | Description |
|-----------|-------------|
| `ResolveTile_PlayerPosition_ReturnsCyanAt` | Center position → "@" cyan |
| `ResolveTile_NullRoom_ReturnsGreyDot` | No room → "·" grey |
| `ResolveTile_UnvisitedRoom_ReturnsGreyFog` | Not visited → "░" grey |
| `ResolveTile_VisitedRoom_ReturnsSymbol` | Visited → appropriate symbol |
| `GetRoomSymbol_BossLair_ReturnsSkullRed` | BossLair → "☠" red |
| `GetRoomSymbol_StairsUp_ReturnsArrowWhite` | StairsUp → "▲" white |
| `GetRoomSymbol_StairsDown_ReturnsArrowWhite` | StairsDown → "▼" white |
| `GetRoomSymbol_Settlement_ReturnsHouseBlue` | Settlement → "⌂" blue |
| `GetRoomSymbol_RunicAnchor_ReturnsDiamondCyan` | RunicAnchor → "◆" cyan |
| `GetRoomSymbol_Workbench_ReturnsHammerYellow` | Workbench → "⚒" yellow |
| `GetRoomSymbol_AlchemyTable_ReturnsHammerYellow` | AlchemyTable → "⚒" yellow |
| `GetRoomSymbol_LethalDanger_ReturnsRedO` | Lethal → "O" red |
| `GetRoomSymbol_HostileDanger_ReturnsOrangeO` | Hostile → "O" orange1 |
| `GetRoomSymbol_UnstableDanger_ReturnsYellowO` | Unstable → "O" yellow |
| `GetRoomSymbol_SafeRoom_ReturnsGreyO` | Safe → "O" grey |
| `GetRoomSymbol_BossOverridesStairs_ReturnsSkull` | Boss takes priority over other features |
| `GetZLevelIndicator_HasBothStairs_ShowsBothArrows` | Both stairs → "Z:0 ▲▼" |
| `GetZLevelIndicator_OnlyStairsUp_ShowsUpArrow` | Only up → "Z:0 ▲" |
| `GetZLevelIndicator_OnlyStairsDown_ShowsDownArrow` | Only down → "Z:0 ▼" |
| `GetZLevelIndicator_NoStairs_ShowsOnlyZLevel` | No stairs → "Z:5" |
| `Render_EmptyMap_ReturnsPanel` | Empty map returns valid panel |
| `Render_WithRooms_ReturnsPanel` | Map with rooms returns valid panel |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Room Visited | Debug | `"[Navigation] Room {RoomId} marked as visited. Total visited: {Count}"` |
| Grid Query Start | Debug | `"[Room] Fetching rooms in grid Z={Z}, X=[{MinX},{MaxX}], Y=[{MinY},{MaxY}]"` |
| Grid Query Result | Debug | `"[Room] Retrieved {Count} rooms in grid"` |
| Minimap Data Fetch | Trace | `"[HUD] Fetched {Count} rooms for minimap grid"` |

---

## Architecture Notes

### Fog of War System

1. **VisitedRoomIds HashSet**: O(1) lookup for visited status
2. **Persisted to save files**: JSON serializes HashSet as array
3. **Cleared on Reset()**: New game starts with no visited rooms
4. **Starting room marked immediately**: Before prologue plays
5. **Rooms marked on movement**: In NavigationService.MoveAsync()

### Batch Query Optimization

- `GetRoomsInGridAsync()` fetches all 9 potential rooms in single query
- Avoids N+1 queries (fetching each room individually)
- EF Core translates to efficient SQL WHERE clause
- Returns only rooms within coordinate bounds

### Symbol Priority Order

When a room has multiple features, symbol resolution follows this priority:
1. BossLair (☠) - Highest priority, always shows boss indicator
2. StairsUp/StairsDown (▲/▼) - Important for navigation
3. Settlement (⌂) - Safe zone indicator
4. RunicAnchor (◆) - Rest point
5. Workbench/AlchemyTable (⚒) - Crafting stations
6. DangerLevel-based (O) - Default with color coding

### Y-Axis Inversion

- Grid renders Y+ at top, Y- at bottom (standard map convention)
- Iteration: `for (int y = center.Y + Radius; y >= center.Y - Radius; y--)`
- Matches player expectation: "North is up"

---

## Build Verification

```
Build succeeded.
    0 Error(s)
    (Existing warnings only)

Test run:
  Passed: 1984 (non-PostgreSQL)
  Failed: 0
  Skipped: 0

New tests: 22 (MinimapRendererTests)
```

---

## Directory Structure Changes

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   └── RoomFeature.cs                         [MODIFIED: +4 values]
│   ├── Interfaces/
│   │   └── IRoomRepository.cs                     [MODIFIED: +GetRoomsInGridAsync]
│   ├── Models/
│   │   └── GameState.cs                           [MODIFIED: +VisitedRoomIds]
│   └── ViewModels/
│       └── ExplorationViewModel.cs                [MODIFIED: +3 properties]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── GameService.cs                         [MODIFIED: +minimap data fetch]
│       └── NavigationService.cs                   [MODIFIED: +room visitation]
├── RuneAndRust.Persistence/
│   └── Repositories/
│       └── RoomRepository.cs                      [MODIFIED: +GetRoomsInGridAsync]
├── RuneAndRust.Terminal/
│   ├── Program.cs                                 [MODIFIED: +start room visited]
│   └── Rendering/
│       ├── ExplorationScreenRenderer.cs           [MODIFIED: +MinimapRenderer call]
│       └── MinimapRenderer.cs                     [NEW]
└── RuneAndRust.Tests/
    └── Terminal/
        └── MinimapRendererTests.cs                [NEW: 22 tests]
```

---

## Next Steps (v0.3.5c: The Room View)

Planned features for the next sub-release:
- Enhanced room description panel with object lists
- Exit direction indicators in room view
- Interactable object highlighting
- Container contents preview
- NPC presence indicators

---

## Notes

- Unicode block characters (░, ▲, ▼, ☠, ⌂, ◆, ⚒) work in all modern terminals
- MinimapRenderer is a static class (no DI needed) for simplicity
- Grid uses fixed 3-character column width for consistent alignment
- Z-level indicator updates dynamically based on local map content
- Loaded games restore VisitedRoomIds from save file for persistent fog of war
- Starting room is marked visited before prologue plays
- Version string updated to v0.3.5b in Program.cs boot message
