# v0.1.2b Design Specification: Biome Content Pools

**Version:** 0.1.2b
**Phase Name:** Biome Content Pools
**Parent Version:** v0.1.2 (Dungeon Theming & Biomes)
**Prerequisites:** v0.1.2a Complete (Biome System Core)
**Estimated Tests:** ~25 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BiomeSpawnTable Entity](#4-biomespawntable-entity)
5. [SpawnEntry Value Object](#5-spawnentry-value-object)
6. [LootModifiers Value Object](#6-lootmodifiers-value-object)
7. [BiomeSpawnTableService](#7-biomespawntableservice)
8. [ContentPlacementService Integration](#8-contentplacementservice-integration)
9. [LootService Integration](#9-lootservice-integration)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement biome-specific spawn tables that define which monsters, items, and crafting materials appear in each themed zone. This phase extends the biome system to control content distribution, creating distinct exploration experiences where catacombs feature undead creatures while volcanic caverns spawn fire elementals.

### 1.2 Current State

| Area | Current State (v0.1.2a) | Target State (v0.1.2b) |
|------|------------------------|------------------------|
| Monster spawning | Generic pool selection | Biome-filtered spawn tables |
| Item distribution | Global item pool | Biome-specific item pools |
| Loot quality | Uniform drop rates | Biome loot modifiers |
| Exclusive content | None | Biome-exclusive monsters and items |
| Crafting materials | Global materials | Biome-specific resource drops |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `BiomeSpawnTable` |
| **Value Objects** | `SpawnEntry`, `LootModifiers` |
| **Services** | `BiomeSpawnTableService` (with `IBiomeSpawnTableService` interface) |
| **Service Updates** | `ContentPlacementService`, `LootService` |
| **Configuration** | `biome-spawn-tables.json`, `biome-spawn-tables-schema.json` |
| **Tests** | ~25 new unit tests |

### 1.4 Architectural Significance

This version establishes the **biome content distribution pattern** that will be used for:
- Themed monster encounters based on biome
- Biome-appropriate loot and treasure
- Exclusive content driving exploration goals
- Configurable spawn weights and depth constraints

---

## 2. Feature Overview

```
v0.1.2b Biome Content Pools
├── BiomeSpawnTable Entity
│   ├── Biome ID reference
│   ├── Monster spawn pool (weighted)
│   ├── Item spawn pool (weighted)
│   ├── Hazard spawn pool (weighted, placeholder)
│   ├── Loot modifiers
│   ├── Exclusive items list
│   ├── Exclusive monsters list
│   └── Crafting materials list
├── SpawnEntry Value Object
│   ├── Entity ID (monster/item/hazard)
│   ├── Spawn weight
│   ├── Minimum depth constraint
│   ├── Maximum depth constraint
│   ├── Additional constraints
│   └── Required tags
├── LootModifiers Value Object
│   ├── Gold multiplier
│   ├── Drop rate multiplier
│   ├── Quality tier bonus
│   └── Rare chance modifier
├── BiomeSpawnTableService
│   ├── GetSpawnTable(biomeId)
│   ├── GetAllSpawnTables()
│   ├── GetValidMonsters(biomeId, depth)
│   ├── GetValidItems(biomeId, depth)
│   ├── SelectMonster(biomeId, depth, position)
│   ├── SelectItem(biomeId, depth, position)
│   ├── GetCraftingMaterials(biomeId)
│   └── GetExclusiveContent(biomeId)
├── ContentPlacementService Integration
│   ├── FillMonsterSlot biome filtering
│   ├── FillItemSlot biome filtering
│   └── Exclusive content spawn logic
├── LootService Integration
│   └── Apply biome loot modifiers
└── Configuration
    ├── biome-spawn-tables.json (6 biome tables)
    └── biome-spawn-tables-schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Combat displays biome-appropriate monsters                                  │
│  ├── Loot displays biome-modified rewards                                   │
│  └── Item drops show biome-exclusive content                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  BiomeSpawnTableService                ContentPlacementService (Updated)     │
│  ├── GetSpawnTable(biomeId)            ├── FillMonsterSlot() // biome-aware │
│  ├── GetAllSpawnTables()               └── FillItemSlot() // biome-aware    │
│  ├── GetValidMonsters(biomeId, depth)                                       │
│  ├── GetValidItems(biomeId, depth)     LootService (Updated)                │
│  ├── SelectMonster(biomeId, depth, pos)├── GenerateLoot() // biome modifiers│
│  ├── SelectItem(biomeId, depth, pos)   └── ApplyBiomeLootModifiers()        │
│  ├── GetCraftingMaterials(biomeId)                                          │
│  └── GetExclusiveContent(biomeId)                                           │
│                                                                              │
│  Interfaces:                         Configuration:                          │
│  └── IBiomeSpawnTableService         └── BiomeSpawnTableConfigurationDto    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions:                  Value Objects:                                │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                   │
│  │ BiomeSpawnTable         │  │ SpawnEntry              │                   │
│  │ ├── BiomeId: string     │  │ ├── Id: string          │                   │
│  │ ├── MonsterPool         │  │ ├── Weight: int         │                   │
│  │ ├── ItemPool            │  │ ├── MinDepth: int       │                   │
│  │ ├── HazardPool          │  │ ├── MaxDepth: int?      │                   │
│  │ ├── LootModifiers       │  │ ├── Constraints: dict   │                   │
│  │ ├── ExclusiveItems      │  │ └── RequiredTags: list  │                   │
│  │ ├── ExclusiveMonsters   │  └─────────────────────────┘                   │
│  │ └── CraftingMaterials   │  ┌─────────────────────────┐                   │
│  └─────────────────────────┘  │ LootModifiers           │                   │
│                               │ ├── GoldMultiplier      │                   │
│                               │ ├── DropRateMultiplier  │                   │
│                               │ ├── QualityBonus        │                   │
│                               │ └── RareChanceModifier  │                   │
│                               └─────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetBiomeSpawnTables(): IReadOnlyList<BiomeSpawnTable>                  │
│  └── Loads and deserializes config/biome-spawn-tables.json                  │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/biome-spawn-tables.json (6 biome spawn tables)                  │
│  └── config/schemas/biome-spawn-tables-schema.json (validation schema)      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Monster Selection Flow

```
┌───────────────────────────────────────┐
│ ContentPlacementService fills monster │
│ slot at Position3D in Room            │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Get Room's Biome                                      │
├───────────────────────────────────────────────────────────────┤
│ room.BiomeId → "catacombs"                                    │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Get Spawn Table for Biome                             │
├───────────────────────────────────────────────────────────────┤
│ BiomeSpawnTableService.GetSpawnTable("catacombs")             │
│ └── Returns BiomeSpawnTable with MonsterPool                  │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Filter Monsters by Depth                              │
├───────────────────────────────────────────────────────────────┤
│ GetValidMonsters("catacombs", depth=2)                        │
│                                                               │
│ MonsterPool entries:                                          │
│ ├── skeleton-warrior (minDepth: 0, weight: 100) ✓             │
│ ├── skeleton-archer (minDepth: 0, weight: 80) ✓               │
│ ├── zombie (minDepth: 0, weight: 70) ✓                        │
│ ├── ghost (minDepth: 1, weight: 40) ✓                         │
│ ├── wight (minDepth: 2, weight: 30) ✓                         │
│ └── lich (minDepth: 4, weight: 10) ✗ (minDepth > current)     │
│                                                               │
│ Valid monsters at depth 2: 5 entries                          │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Weighted Random Selection                             │
├───────────────────────────────────────────────────────────────┤
│ SeededRandomService.SelectWeighted(position, entries, "mon")  │
│                                                               │
│ Total weight: 320                                             │
│ Seeded roll for position → 0.35 × 320 = 112                   │
│ ├── 0-99: skeleton-warrior                                    │
│ ├── 100-179: skeleton-archer ← Selected (112 in range)        │
│ ├── 180-249: zombie                                           │
│ ├── 250-289: ghost                                            │
│ └── 290-319: wight                                            │
│                                                               │
│ Selected: skeleton-archer                                     │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Create Monster                                        │
├───────────────────────────────────────────────────────────────┤
│ MonsterService.CreateMonster("skeleton-archer", levelBonus)   │
│ └── Returns Monster instance                                  │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Loot Generation with Biome Modifiers

```
┌───────────────────────────────────────┐
│ Monster defeated in Room with biome   │
│ BiomeId = "volcanic-caverns"          │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Get Base Loot from Monster                            │
├───────────────────────────────────────────────────────────────┤
│ LootService.GenerateLoot(monster, position)                   │
│ ├── Base gold: 50                                             │
│ ├── Drop chance: 0.30                                         │
│ └── Item pool: monster's loot table                           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Get Biome Loot Modifiers                              │
├───────────────────────────────────────────────────────────────┤
│ BiomeSpawnTableService.GetSpawnTable("volcanic-caverns")      │
│ └── LootModifiers:                                            │
│     ├── GoldMultiplier: 1.5                                   │
│     ├── DropRateMultiplier: 0.8                               │
│     ├── QualityBonus: 1                                       │
│     └── RareChanceModifier: 1.3                               │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Apply Modifiers                                       │
├───────────────────────────────────────────────────────────────┤
│ Modified loot:                                                │
│ ├── Gold: 50 × 1.5 = 75                                       │
│ ├── Drop chance: 0.30 × 0.8 = 0.24                            │
│ ├── Quality tier: base + 1 bonus                              │
│ └── Rare chance: base × 1.3                                   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Check for Exclusive Items                             │
├───────────────────────────────────────────────────────────────┤
│ ExclusiveItems: ["heart-of-the-mountain", "phoenix-feather",  │
│                  "lava-core"]                                 │
│                                                               │
│ Roll for exclusive drop (low chance)                          │
│ └── Add to loot pool if successful                            │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Return Final Loot                                     │
├───────────────────────────────────────────────────────────────┤
│ LootDrop {                                                    │
│   Gold: 75,                                                   │
│   Items: [{ Id: "fire-opal", Quality: Uncommon }]             │
│ }                                                             │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. BiomeSpawnTable Entity

### 4.1 Purpose

The `BiomeSpawnTable` entity defines which monsters, items, and resources can appear in a specific biome. Each biome has exactly one spawn table that controls content distribution with weighted pools and depth constraints.

### 4.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Definitions/BiomeSpawnTable.cs`

### 4.3 Implementation

```csharp
namespace RuneAndRust.Domain.Definitions;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines monster and item spawn pools for a biome.
/// </summary>
/// <remarks>
/// Each biome has one spawn table that controls what content appears.
/// Pools use weighted entries with optional depth constraints.
/// </remarks>
public class BiomeSpawnTable
{
    /// <summary>
    /// Gets the biome ID this table applies to.
    /// </summary>
    /// <remarks>
    /// Must match an existing BiomeDefinition.Id.
    /// </remarks>
    public string BiomeId { get; init; } = string.Empty;

    /// <summary>
    /// Gets the monster spawn entries for this biome.
    /// </summary>
    /// <remarks>
    /// Weighted pool of monsters that can spawn. Entry IDs must match
    /// existing MonsterDefinition.Id values.
    /// </remarks>
    public IReadOnlyList<SpawnEntry> MonsterPool { get; init; } = Array.Empty<SpawnEntry>();

    /// <summary>
    /// Gets the item spawn entries for this biome.
    /// </summary>
    /// <remarks>
    /// Weighted pool of items that can drop. Entry IDs must match
    /// existing ItemDefinition.Id values.
    /// </remarks>
    public IReadOnlyList<SpawnEntry> ItemPool { get; init; } = Array.Empty<SpawnEntry>();

    /// <summary>
    /// Gets the hazard spawn entries for this biome.
    /// </summary>
    /// <remarks>
    /// Placeholder for v0.1.2c. Weighted pool of environmental hazards.
    /// </remarks>
    public IReadOnlyList<SpawnEntry> HazardPool { get; init; } = Array.Empty<SpawnEntry>();

    /// <summary>
    /// Gets loot modifiers for this biome.
    /// </summary>
    /// <remarks>
    /// Affects gold drops, item rates, quality, and rare chances.
    /// </remarks>
    public LootModifiers LootModifiers { get; init; } = LootModifiers.Default;

    /// <summary>
    /// Gets biome-exclusive items that only drop here.
    /// </summary>
    /// <remarks>
    /// Item IDs that can only be obtained in this biome.
    /// Provides unique rewards for exploring specific zones.
    /// </remarks>
    public IReadOnlyList<string> ExclusiveItems { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets biome-exclusive monsters that only spawn here.
    /// </summary>
    /// <remarks>
    /// Monster IDs that only appear in this biome.
    /// Creates unique encounters for each themed zone.
    /// </remarks>
    public IReadOnlyList<string> ExclusiveMonsters { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets crafting materials specific to this biome.
    /// </summary>
    /// <remarks>
    /// Material IDs that can be gathered in this biome.
    /// Enables biome-specific crafting recipes.
    /// </remarks>
    public IReadOnlyList<string> CraftingMaterials { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Private constructor for EF Core and factory method.
    /// </summary>
    private BiomeSpawnTable() { }

    /// <summary>
    /// Creates a biome spawn table from configuration.
    /// </summary>
    /// <param name="biomeId">Biome identifier.</param>
    /// <param name="monsterPool">Monster spawn entries.</param>
    /// <param name="itemPool">Item spawn entries.</param>
    /// <param name="hazardPool">Hazard spawn entries (optional).</param>
    /// <param name="lootModifiers">Loot modifier settings.</param>
    /// <param name="exclusiveItems">Biome-exclusive item IDs.</param>
    /// <param name="exclusiveMonsters">Biome-exclusive monster IDs.</param>
    /// <param name="craftingMaterials">Available crafting material IDs.</param>
    /// <returns>A new BiomeSpawnTable instance.</returns>
    /// <exception cref="ArgumentException">Thrown when biomeId is null or empty.</exception>
    public static BiomeSpawnTable Create(
        string biomeId,
        IEnumerable<SpawnEntry>? monsterPool = null,
        IEnumerable<SpawnEntry>? itemPool = null,
        IEnumerable<SpawnEntry>? hazardPool = null,
        LootModifiers? lootModifiers = null,
        IEnumerable<string>? exclusiveItems = null,
        IEnumerable<string>? exclusiveMonsters = null,
        IEnumerable<string>? craftingMaterials = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(biomeId, nameof(biomeId));

        return new BiomeSpawnTable
        {
            BiomeId = biomeId,
            MonsterPool = monsterPool?.ToList() ?? new List<SpawnEntry>(),
            ItemPool = itemPool?.ToList() ?? new List<SpawnEntry>(),
            HazardPool = hazardPool?.ToList() ?? new List<SpawnEntry>(),
            LootModifiers = lootModifiers ?? LootModifiers.Default,
            ExclusiveItems = exclusiveItems?.ToList() ?? new List<string>(),
            ExclusiveMonsters = exclusiveMonsters?.ToList() ?? new List<string>(),
            CraftingMaterials = craftingMaterials?.ToList() ?? new List<string>()
        };
    }

    /// <summary>
    /// Gets monsters valid for a specific depth.
    /// </summary>
    /// <param name="depth">The Z-level depth to check.</param>
    /// <returns>Spawn entries valid for the depth.</returns>
    public IEnumerable<SpawnEntry> GetMonstersForDepth(int depth)
    {
        return MonsterPool.Where(e => e.IsValidForDepth(depth));
    }

    /// <summary>
    /// Gets items valid for a specific depth.
    /// </summary>
    /// <param name="depth">The Z-level depth to check.</param>
    /// <returns>Spawn entries valid for the depth.</returns>
    public IEnumerable<SpawnEntry> GetItemsForDepth(int depth)
    {
        return ItemPool.Where(e => e.IsValidForDepth(depth));
    }

    /// <summary>
    /// Checks if a monster ID is exclusive to this biome.
    /// </summary>
    /// <param name="monsterId">The monster ID to check.</param>
    /// <returns>True if the monster is exclusive to this biome.</returns>
    public bool IsExclusiveMonster(string monsterId)
    {
        return ExclusiveMonsters.Contains(monsterId, StringComparer.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Checks if an item ID is exclusive to this biome.
    /// </summary>
    /// <param name="itemId">The item ID to check.</param>
    /// <returns>True if the item is exclusive to this biome.</returns>
    public bool IsExclusiveItem(string itemId)
    {
        return ExclusiveItems.Contains(itemId, StringComparer.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets the total spawn weight for monsters at a depth.
    /// </summary>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>Sum of weights for valid monster entries.</returns>
    public int GetTotalMonsterWeight(int depth)
    {
        return GetMonstersForDepth(depth).Sum(e => e.Weight);
    }

    /// <summary>
    /// Gets the total spawn weight for items at a depth.
    /// </summary>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>Sum of weights for valid item entries.</returns>
    public int GetTotalItemWeight(int depth)
    {
        return GetItemsForDepth(depth).Sum(e => e.Weight);
    }

    /// <summary>
    /// Gets a string representation of the spawn table.
    /// </summary>
    public override string ToString() =>
        $"SpawnTable[{BiomeId}] Monsters:{MonsterPool.Count} Items:{ItemPool.Count}";
}
```

### 4.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `BiomeId` | `string` | Referenced biome identifier | Required |
| `MonsterPool` | `IReadOnlyList<SpawnEntry>` | Weighted monster spawn entries | Empty |
| `ItemPool` | `IReadOnlyList<SpawnEntry>` | Weighted item spawn entries | Empty |
| `HazardPool` | `IReadOnlyList<SpawnEntry>` | Weighted hazard entries (placeholder) | Empty |
| `LootModifiers` | `LootModifiers` | Loot quality/quantity modifiers | Default |
| `ExclusiveItems` | `IReadOnlyList<string>` | Biome-only item IDs | Empty |
| `ExclusiveMonsters` | `IReadOnlyList<string>` | Biome-only monster IDs | Empty |
| `CraftingMaterials` | `IReadOnlyList<string>` | Available material IDs | Empty |

---

## 5. SpawnEntry Value Object

### 5.1 Purpose

The `SpawnEntry` value object represents a single weighted entry in a spawn pool. Each entry specifies an entity ID, spawn weight, depth constraints, and optional filtering constraints.

### 5.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SpawnEntry.cs`

### 5.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// A weighted spawn table entry with depth constraints.
/// </summary>
/// <remarks>
/// Used in BiomeSpawnTable pools for monsters, items, and hazards.
/// Higher weights increase selection probability.
/// </remarks>
public readonly record struct SpawnEntry
{
    /// <summary>
    /// Gets the ID of the monster/item/hazard.
    /// </summary>
    /// <remarks>
    /// Must match an existing definition ID (MonsterDefinition.Id,
    /// ItemDefinition.Id, or HazardDefinition.Id).
    /// </remarks>
    public string Id { get; init; }

    /// <summary>
    /// Gets the spawn weight (higher = more common).
    /// </summary>
    /// <remarks>
    /// Weight is relative to other entries in the same pool.
    /// A weight of 100 is twice as likely as 50.
    /// </remarks>
    public int Weight { get; init; }

    /// <summary>
    /// Gets the minimum depth where this can spawn.
    /// </summary>
    /// <remarks>
    /// Entry is excluded from pools at depths below this value.
    /// Default 0 means available from the start.
    /// </remarks>
    public int MinDepth { get; init; }

    /// <summary>
    /// Gets the maximum depth where this can spawn.
    /// </summary>
    /// <remarks>
    /// Entry is excluded from pools at depths above this value.
    /// Null means no maximum depth limit.
    /// </remarks>
    public int? MaxDepth { get; init; }

    /// <summary>
    /// Gets additional spawn constraints.
    /// </summary>
    /// <remarks>
    /// Key-value pairs for filtering (e.g., "tier": "boss").
    /// Constraints are checked during content placement.
    /// </remarks>
    public IReadOnlyDictionary<string, string> Constraints { get; init; }

    /// <summary>
    /// Gets required tags for this entry to spawn.
    /// </summary>
    /// <remarks>
    /// Entry only spawns if context has all required tags.
    /// Empty list means no tag requirements.
    /// </remarks>
    public IReadOnlyList<string> RequiredTags { get; init; }

    /// <summary>
    /// Creates default spawn entry values.
    /// </summary>
    public static SpawnEntry Default => new()
    {
        Id = string.Empty,
        Weight = 100,
        MinDepth = 0,
        MaxDepth = null,
        Constraints = new Dictionary<string, string>(),
        RequiredTags = Array.Empty<string>()
    };

    /// <summary>
    /// Creates a spawn entry with required values.
    /// </summary>
    /// <param name="id">Entity ID.</param>
    /// <param name="weight">Spawn weight.</param>
    /// <param name="minDepth">Minimum depth constraint.</param>
    /// <param name="maxDepth">Maximum depth constraint (null = unlimited).</param>
    /// <param name="constraints">Additional constraints.</param>
    /// <param name="requiredTags">Required context tags.</param>
    /// <returns>A new SpawnEntry instance.</returns>
    public static SpawnEntry Create(
        string id,
        int weight = 100,
        int minDepth = 0,
        int? maxDepth = null,
        IDictionary<string, string>? constraints = null,
        IEnumerable<string>? requiredTags = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id, nameof(id));

        if (weight <= 0)
            throw new ArgumentOutOfRangeException(nameof(weight), "Weight must be positive.");

        if (minDepth < 0)
            throw new ArgumentOutOfRangeException(nameof(minDepth), "MinDepth cannot be negative.");

        if (maxDepth.HasValue && maxDepth.Value < minDepth)
            throw new ArgumentException("MaxDepth cannot be less than MinDepth.", nameof(maxDepth));

        return new SpawnEntry
        {
            Id = id,
            Weight = weight,
            MinDepth = minDepth,
            MaxDepth = maxDepth,
            Constraints = constraints != null
                ? new Dictionary<string, string>(constraints)
                : new Dictionary<string, string>(),
            RequiredTags = requiredTags?.ToList() ?? new List<string>()
        };
    }

    /// <summary>
    /// Checks if this entry is valid for a given depth.
    /// </summary>
    /// <param name="depth">The Z-level depth to check.</param>
    /// <returns>True if the entry can spawn at this depth.</returns>
    public bool IsValidForDepth(int depth)
    {
        if (depth < MinDepth)
            return false;

        if (MaxDepth.HasValue && depth > MaxDepth.Value)
            return false;

        return true;
    }

    /// <summary>
    /// Checks if a constraint matches a given value.
    /// </summary>
    /// <param name="key">Constraint key.</param>
    /// <param name="value">Value to match.</param>
    /// <returns>True if constraint matches or doesn't exist.</returns>
    public bool MatchesConstraint(string key, string value)
    {
        if (!Constraints.TryGetValue(key, out var constraintValue))
            return true; // No constraint means it matches

        return string.Equals(constraintValue, value, StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Checks if all required tags are present in a tag set.
    /// </summary>
    /// <param name="contextTags">Tags available in current context.</param>
    /// <returns>True if all required tags are present.</returns>
    public bool HasRequiredTags(IEnumerable<string> contextTags)
    {
        if (RequiredTags.Count == 0)
            return true;

        var tagSet = new HashSet<string>(contextTags, StringComparer.OrdinalIgnoreCase);
        return RequiredTags.All(tag => tagSet.Contains(tag));
    }
}
```

### 5.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `string` | Entity identifier to spawn | Required |
| `Weight` | `int` | Spawn probability weight | 100 |
| `MinDepth` | `int` | Minimum Z-level | 0 |
| `MaxDepth` | `int?` | Maximum Z-level | null (unlimited) |
| `Constraints` | `IReadOnlyDictionary<string, string>` | Additional filtering | Empty |
| `RequiredTags` | `IReadOnlyList<string>` | Required context tags | Empty |

---

## 6. LootModifiers Value Object

### 6.1 Purpose

The `LootModifiers` value object defines how loot quality and quantity are modified within a biome. These multipliers affect gold drops, item drop rates, quality tiers, and rare item chances.

### 6.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/LootModifiers.cs`

### 6.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Loot quality and quantity modifiers for a biome.
/// </summary>
/// <remarks>
/// Multipliers are applied to base loot values during generation.
/// Values of 1.0 mean no modification.
/// </remarks>
public readonly record struct LootModifiers
{
    /// <summary>
    /// Gets the gold drop multiplier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Applied to base gold drops. A value of 1.5 means 50% more gold.
    /// </remarks>
    public float GoldMultiplier { get; init; }

    /// <summary>
    /// Gets the item drop rate multiplier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Applied to base drop chance. A value of 0.8 means 20% fewer drops.
    /// </remarks>
    public float DropRateMultiplier { get; init; }

    /// <summary>
    /// Gets the quality tier bonus.
    /// </summary>
    /// <remarks>
    /// Added to item quality tier rolls. A value of 1 shifts results
    /// toward higher quality tiers.
    /// </remarks>
    public int QualityBonus { get; init; }

    /// <summary>
    /// Gets the rare item chance modifier (1.0 = normal).
    /// </summary>
    /// <remarks>
    /// Applied to rare/legendary drop chances. A value of 1.3 means
    /// 30% higher chance for rare items.
    /// </remarks>
    public float RareChanceModifier { get; init; }

    /// <summary>
    /// Creates default loot modifiers (no modification).
    /// </summary>
    public static LootModifiers Default => new()
    {
        GoldMultiplier = 1.0f,
        DropRateMultiplier = 1.0f,
        QualityBonus = 0,
        RareChanceModifier = 1.0f
    };

    /// <summary>
    /// Creates loot modifiers with specified values.
    /// </summary>
    /// <param name="goldMultiplier">Gold amount multiplier.</param>
    /// <param name="dropRateMultiplier">Drop chance multiplier.</param>
    /// <param name="qualityBonus">Quality tier bonus.</param>
    /// <param name="rareChanceModifier">Rare drop chance multiplier.</param>
    /// <returns>A new LootModifiers instance.</returns>
    public static LootModifiers Create(
        float goldMultiplier = 1.0f,
        float dropRateMultiplier = 1.0f,
        int qualityBonus = 0,
        float rareChanceModifier = 1.0f)
    {
        if (goldMultiplier < 0)
            throw new ArgumentOutOfRangeException(nameof(goldMultiplier), "Cannot be negative.");

        if (dropRateMultiplier < 0)
            throw new ArgumentOutOfRangeException(nameof(dropRateMultiplier), "Cannot be negative.");

        if (rareChanceModifier < 0)
            throw new ArgumentOutOfRangeException(nameof(rareChanceModifier), "Cannot be negative.");

        return new LootModifiers
        {
            GoldMultiplier = goldMultiplier,
            DropRateMultiplier = dropRateMultiplier,
            QualityBonus = qualityBonus,
            RareChanceModifier = rareChanceModifier
        };
    }

    /// <summary>
    /// Applies the gold multiplier to a base amount.
    /// </summary>
    /// <param name="baseGold">Base gold amount.</param>
    /// <returns>Modified gold amount (rounded down).</returns>
    public int ApplyGoldMultiplier(int baseGold)
    {
        return (int)(baseGold * GoldMultiplier);
    }

    /// <summary>
    /// Applies the drop rate multiplier to a base chance.
    /// </summary>
    /// <param name="baseChance">Base drop chance (0.0-1.0).</param>
    /// <returns>Modified drop chance (capped at 1.0).</returns>
    public float ApplyDropRateMultiplier(float baseChance)
    {
        return Math.Min(1.0f, baseChance * DropRateMultiplier);
    }

    /// <summary>
    /// Applies the quality bonus to a base tier.
    /// </summary>
    /// <param name="baseTier">Base quality tier.</param>
    /// <returns>Modified quality tier.</returns>
    public int ApplyQualityBonus(int baseTier)
    {
        return baseTier + QualityBonus;
    }

    /// <summary>
    /// Applies the rare chance modifier to a base chance.
    /// </summary>
    /// <param name="baseChance">Base rare drop chance (0.0-1.0).</param>
    /// <returns>Modified rare chance (capped at 1.0).</returns>
    public float ApplyRareChanceModifier(float baseChance)
    {
        return Math.Min(1.0f, baseChance * RareChanceModifier);
    }

    /// <summary>
    /// Checks if these modifiers provide any bonuses.
    /// </summary>
    /// <returns>True if any modifier improves loot.</returns>
    public bool HasBonuses =>
        GoldMultiplier > 1.0f ||
        DropRateMultiplier > 1.0f ||
        QualityBonus > 0 ||
        RareChanceModifier > 1.0f;

    /// <summary>
    /// Checks if these modifiers provide any penalties.
    /// </summary>
    /// <returns>True if any modifier reduces loot.</returns>
    public bool HasPenalties =>
        GoldMultiplier < 1.0f ||
        DropRateMultiplier < 1.0f ||
        QualityBonus < 0 ||
        RareChanceModifier < 1.0f;
}
```

### 6.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `GoldMultiplier` | `float` | Gold amount modifier | 1.0 |
| `DropRateMultiplier` | `float` | Drop chance modifier | 1.0 |
| `QualityBonus` | `int` | Quality tier adjustment | 0 |
| `RareChanceModifier` | `float` | Rare drop chance modifier | 1.0 |

### 6.5 Modifier Application

| Biome | Gold | Drop Rate | Quality | Rare Chance | Theme |
|-------|------|-----------|---------|-------------|-------|
| Dungeon | 1.0 | 1.0 | 0 | 1.0 | Baseline |
| Catacombs | 1.2 | 1.0 | 0 | 1.1 | Ancient wealth |
| Sewers | 0.8 | 1.2 | -1 | 0.9 | Trash but plentiful |
| Mines | 1.1 | 0.9 | 0 | 1.0 | Ore-rich |
| Ancient Ruins | 1.5 | 0.7 | 1 | 1.5 | Rare treasures |
| Frozen Depths | 1.0 | 1.0 | 0 | 1.2 | Preserved valuables |
| Volcanic Caverns | 1.5 | 0.8 | 1 | 1.3 | High risk, high reward |

---

## 7. BiomeSpawnTableService

### 7.1 Purpose

The `BiomeSpawnTableService` provides access to biome spawn tables and handles weighted selection of monsters and items based on biome and depth. It integrates with the seeded random service for reproducible content generation.

### 7.2 File Locations

**Interface:** `src/Core/RuneAndRust.Application/Interfaces/IBiomeSpawnTableService.cs`
**Implementation:** `src/Core/RuneAndRust.Application/Services/BiomeSpawnTableService.cs`

### 7.3 Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for accessing biome spawn tables and selecting content.
/// </summary>
public interface IBiomeSpawnTableService
{
    /// <summary>
    /// Gets a spawn table by biome ID.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>The spawn table, or null if not found.</returns>
    BiomeSpawnTable? GetSpawnTable(string biomeId);

    /// <summary>
    /// Gets all loaded spawn tables.
    /// </summary>
    /// <returns>All biome spawn tables.</returns>
    IReadOnlyList<BiomeSpawnTable> GetAllSpawnTables();

    /// <summary>
    /// Gets monsters valid for a biome and depth.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>Valid spawn entries.</returns>
    IEnumerable<SpawnEntry> GetValidMonsters(string biomeId, int depth);

    /// <summary>
    /// Gets items valid for a biome and depth.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="depth">The Z-level depth.</param>
    /// <returns>Valid spawn entries.</returns>
    IEnumerable<SpawnEntry> GetValidItems(string biomeId, int depth);

    /// <summary>
    /// Selects a monster from the biome pool using weighted random selection.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="depth">The Z-level depth.</param>
    /// <param name="position">Position for seeded random.</param>
    /// <param name="contextTags">Optional context tags for filtering.</param>
    /// <returns>Selected monster ID, or null if pool is empty.</returns>
    string? SelectMonster(string biomeId, int depth, Position3D position, IEnumerable<string>? contextTags = null);

    /// <summary>
    /// Selects an item from the biome pool using weighted random selection.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <param name="depth">The Z-level depth.</param>
    /// <param name="position">Position for seeded random.</param>
    /// <param name="contextTags">Optional context tags for filtering.</param>
    /// <returns>Selected item ID, or null if pool is empty.</returns>
    string? SelectItem(string biomeId, int depth, Position3D position, IEnumerable<string>? contextTags = null);

    /// <summary>
    /// Gets crafting materials available in a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>List of crafting material IDs.</returns>
    IReadOnlyList<string> GetCraftingMaterials(string biomeId);

    /// <summary>
    /// Gets exclusive items for a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>List of exclusive item IDs.</returns>
    IReadOnlyList<string> GetExclusiveItems(string biomeId);

    /// <summary>
    /// Gets exclusive monsters for a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>List of exclusive monster IDs.</returns>
    IReadOnlyList<string> GetExclusiveMonsters(string biomeId);

    /// <summary>
    /// Gets loot modifiers for a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>Loot modifiers, or default if biome not found.</returns>
    LootModifiers GetLootModifiers(string biomeId);
}
```

### 7.4 Implementation

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for accessing biome spawn tables and selecting content.
/// </summary>
public class BiomeSpawnTableService : IBiomeSpawnTableService
{
    private readonly IConfigurationProvider _configurationProvider;
    private readonly ISeededRandomService _randomService;
    private readonly ILogger<BiomeSpawnTableService> _logger;
    private readonly Dictionary<string, BiomeSpawnTable> _spawnTables;

    /// <summary>
    /// Initializes a new instance of BiomeSpawnTableService.
    /// </summary>
    public BiomeSpawnTableService(
        IConfigurationProvider configurationProvider,
        ISeededRandomService randomService,
        ILogger<BiomeSpawnTableService> logger)
    {
        _configurationProvider = configurationProvider;
        _randomService = randomService;
        _logger = logger;

        _spawnTables = LoadSpawnTables();
        _logger.LogInformation("Loaded {Count} biome spawn tables", _spawnTables.Count);
    }

    private Dictionary<string, BiomeSpawnTable> LoadSpawnTables()
    {
        var tables = _configurationProvider.GetBiomeSpawnTables();
        return tables.ToDictionary(t => t.BiomeId, StringComparer.OrdinalIgnoreCase);
    }

    /// <inheritdoc />
    public BiomeSpawnTable? GetSpawnTable(string biomeId)
    {
        if (string.IsNullOrWhiteSpace(biomeId))
            return null;

        if (_spawnTables.TryGetValue(biomeId, out var table))
        {
            _logger.LogDebug("Retrieved spawn table for biome {BiomeId}", biomeId);
            return table;
        }

        _logger.LogWarning("Spawn table not found for biome {BiomeId}", biomeId);
        return null;
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeSpawnTable> GetAllSpawnTables()
    {
        return _spawnTables.Values.ToList();
    }

    /// <inheritdoc />
    public IEnumerable<SpawnEntry> GetValidMonsters(string biomeId, int depth)
    {
        var table = GetSpawnTable(biomeId);
        if (table == null)
            return Enumerable.Empty<SpawnEntry>();

        return table.GetMonstersForDepth(depth);
    }

    /// <inheritdoc />
    public IEnumerable<SpawnEntry> GetValidItems(string biomeId, int depth)
    {
        var table = GetSpawnTable(biomeId);
        if (table == null)
            return Enumerable.Empty<SpawnEntry>();

        return table.GetItemsForDepth(depth);
    }

    /// <inheritdoc />
    public string? SelectMonster(
        string biomeId,
        int depth,
        Position3D position,
        IEnumerable<string>? contextTags = null)
    {
        var validEntries = GetValidMonsters(biomeId, depth).ToList();

        // Apply context tag filtering
        if (contextTags != null)
        {
            validEntries = validEntries
                .Where(e => e.HasRequiredTags(contextTags))
                .ToList();
        }

        if (validEntries.Count == 0)
        {
            _logger.LogWarning(
                "No valid monsters for biome {BiomeId} at depth {Depth}",
                biomeId, depth);
            return null;
        }

        var selected = _randomService.SelectWeighted(
            position,
            validEntries.Select(e => (e, e.Weight)),
            "monster_select");

        _logger.LogDebug(
            "Selected monster {MonsterId} from {BiomeId} at depth {Depth}",
            selected.Id, biomeId, depth);

        return selected.Id;
    }

    /// <inheritdoc />
    public string? SelectItem(
        string biomeId,
        int depth,
        Position3D position,
        IEnumerable<string>? contextTags = null)
    {
        var validEntries = GetValidItems(biomeId, depth).ToList();

        // Apply context tag filtering
        if (contextTags != null)
        {
            validEntries = validEntries
                .Where(e => e.HasRequiredTags(contextTags))
                .ToList();
        }

        if (validEntries.Count == 0)
        {
            _logger.LogWarning(
                "No valid items for biome {BiomeId} at depth {Depth}",
                biomeId, depth);
            return null;
        }

        var selected = _randomService.SelectWeighted(
            position,
            validEntries.Select(e => (e, e.Weight)),
            "item_select");

        _logger.LogDebug(
            "Selected item {ItemId} from {BiomeId} at depth {Depth}",
            selected.Id, biomeId, depth);

        return selected.Id;
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetCraftingMaterials(string biomeId)
    {
        var table = GetSpawnTable(biomeId);
        return table?.CraftingMaterials ?? Array.Empty<string>();
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetExclusiveItems(string biomeId)
    {
        var table = GetSpawnTable(biomeId);
        return table?.ExclusiveItems ?? Array.Empty<string>();
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetExclusiveMonsters(string biomeId)
    {
        var table = GetSpawnTable(biomeId);
        return table?.ExclusiveMonsters ?? Array.Empty<string>();
    }

    /// <inheritdoc />
    public LootModifiers GetLootModifiers(string biomeId)
    {
        var table = GetSpawnTable(biomeId);
        return table?.LootModifiers ?? LootModifiers.Default;
    }
}
```

---

## 8. ContentPlacementService Integration

### 8.1 Purpose

Update `ContentPlacementService` to use biome spawn tables when filling monster and item slots. This ensures content placed in rooms matches the biome theme.

### 8.2 File Location

**File:** `src/Core/RuneAndRust.Application/Services/ContentPlacementService.cs`

### 8.3 Updated Methods

```csharp
// Add to existing ContentPlacementService class

private readonly IBiomeSpawnTableService _biomeSpawnTableService;

/// <summary>
/// Fills a template slot with biome-appropriate monster content.
/// </summary>
/// <param name="slot">The template slot to fill.</param>
/// <param name="difficulty">Current difficulty rating.</param>
/// <param name="position">Position for seeded random.</param>
/// <param name="environment">Environmental context.</param>
/// <param name="biomeId">The biome ID for content filtering.</param>
/// <returns>Monsters to place in the slot.</returns>
public IEnumerable<Monster> FillMonsterSlot(
    TemplateSlot slot,
    DifficultyRating difficulty,
    Position3D position,
    EnvironmentContext environment,
    string biomeId)
{
    // Check if slot should be filled
    var fillRoll = _randomService.NextFloatForPosition(position, "monster_fill");
    if (!slot.IsRequired && fillRoll > slot.FillProbability)
    {
        _logger.LogDebug("Skipping optional monster slot at {Position}", position);
        yield break;
    }

    // Get biome spawn table
    var spawnTable = _biomeSpawnTableService.GetSpawnTable(biomeId);
    if (spawnTable == null)
    {
        _logger.LogWarning("No spawn table for biome {BiomeId}", biomeId);
        yield break;
    }

    // Filter monsters valid for this depth
    var validMonsters = spawnTable.GetMonstersForDepth(position.Z).ToList();

    // Apply slot constraints
    if (slot.Constraints.TryGetValue("maxTier", out var maxTier))
    {
        validMonsters = validMonsters
            .Where(e => !e.Constraints.TryGetValue("tier", out var tier) ||
                        TierOrder(tier) <= TierOrder(maxTier))
            .ToList();
    }

    if (validMonsters.Count == 0)
    {
        _logger.LogWarning(
            "No valid monsters for biome {BiomeId} at depth {Depth}",
            biomeId, position.Z);
        yield break;
    }

    // Determine quantity
    var quantity = _randomService.NextForPosition(
        position,
        slot.MinQuantity,
        slot.MaxQuantity + 1,
        "monster_quantity");

    for (int i = 0; i < quantity; i++)
    {
        var entry = _randomService.SelectWeighted(
            position,
            validMonsters.Select(e => (e, e.Weight)),
            $"monster_select_{i}");

        var monster = _monsterService.CreateMonster(
            entry.Id,
            difficulty.MonsterLevelBonus);

        if (monster != null)
        {
            _logger.LogDebug(
                "Placed monster {MonsterId} at {Position}",
                entry.Id, position);
            yield return monster;
        }
    }
}

/// <summary>
/// Fills a template slot with biome-appropriate item content.
/// </summary>
/// <param name="slot">The template slot to fill.</param>
/// <param name="position">Position for seeded random.</param>
/// <param name="biomeId">The biome ID for content filtering.</param>
/// <returns>Items to place in the slot.</returns>
public IEnumerable<Item> FillItemSlot(
    TemplateSlot slot,
    Position3D position,
    string biomeId)
{
    // Check if slot should be filled
    var fillRoll = _randomService.NextFloatForPosition(position, "item_fill");
    if (!slot.IsRequired && fillRoll > slot.FillProbability)
    {
        _logger.LogDebug("Skipping optional item slot at {Position}", position);
        yield break;
    }

    // Get biome spawn table
    var spawnTable = _biomeSpawnTableService.GetSpawnTable(biomeId);
    if (spawnTable == null)
    {
        _logger.LogWarning("No spawn table for biome {BiomeId}", biomeId);
        yield break;
    }

    // Filter items valid for this depth
    var validItems = spawnTable.GetItemsForDepth(position.Z).ToList();

    if (validItems.Count == 0)
    {
        _logger.LogWarning(
            "No valid items for biome {BiomeId} at depth {Depth}",
            biomeId, position.Z);
        yield break;
    }

    // Determine quantity
    var quantity = _randomService.NextForPosition(
        position,
        slot.MinQuantity,
        slot.MaxQuantity + 1,
        "item_quantity");

    for (int i = 0; i < quantity; i++)
    {
        var entry = _randomService.SelectWeighted(
            position,
            validItems.Select(e => (e, e.Weight)),
            $"item_select_{i}");

        var item = _itemService.CreateItem(entry.Id);

        if (item != null)
        {
            _logger.LogDebug("Placed item {ItemId} at {Position}", entry.Id, position);
            yield return item;
        }
    }
}

/// <summary>
/// Tries to spawn an exclusive item for the biome.
/// </summary>
/// <param name="biomeId">The biome identifier.</param>
/// <param name="position">Position for seeded random.</param>
/// <param name="exclusiveChance">Base chance for exclusive drop.</param>
/// <returns>Exclusive item if rolled, null otherwise.</returns>
public Item? TrySpawnExclusiveItem(
    string biomeId,
    Position3D position,
    float exclusiveChance = 0.01f)
{
    var exclusiveItems = _biomeSpawnTableService.GetExclusiveItems(biomeId);
    if (exclusiveItems.Count == 0)
        return null;

    var roll = _randomService.NextFloatForPosition(position, "exclusive_item");
    if (roll > exclusiveChance)
        return null;

    // Select random exclusive item
    var index = _randomService.NextForPosition(
        position,
        0,
        exclusiveItems.Count,
        "exclusive_select");

    var itemId = exclusiveItems[index];
    var item = _itemService.CreateItem(itemId);

    if (item != null)
    {
        _logger.LogInformation(
            "Spawned exclusive item {ItemId} from biome {BiomeId}",
            itemId, biomeId);
    }

    return item;
}

private static int TierOrder(string tier) => tier.ToLowerInvariant() switch
{
    "common" => 0,
    "uncommon" => 1,
    "rare" => 2,
    "elite" => 3,
    "boss" => 4,
    "legendary" => 5,
    _ => 0
};
```

---

## 9. LootService Integration

### 9.1 Purpose

Update `LootService` to apply biome loot modifiers when generating drops from defeated monsters or containers.

### 9.2 File Location

**File:** `src/Core/RuneAndRust.Application/Services/LootService.cs`

### 9.3 Updated Methods

```csharp
// Add to existing LootService class

private readonly IBiomeSpawnTableService _biomeSpawnTableService;

/// <summary>
/// Generates loot from a defeated monster with biome modifiers.
/// </summary>
/// <param name="monster">The defeated monster.</param>
/// <param name="position">Position for seeded random.</param>
/// <param name="biomeId">The biome where the monster was defeated.</param>
/// <returns>Generated loot drop.</returns>
public LootDrop GenerateLoot(Monster monster, Position3D position, string biomeId)
{
    // Get base loot from monster definition
    var baseLoot = GetBaseLoot(monster);

    // Get biome loot modifiers
    var modifiers = _biomeSpawnTableService.GetLootModifiers(biomeId);

    // Apply gold modifier
    var gold = modifiers.ApplyGoldMultiplier(baseLoot.Gold);

    // Apply drop rate modifier
    var adjustedDropChance = modifiers.ApplyDropRateMultiplier(baseLoot.DropChance);

    var items = new List<DroppedItem>();

    // Roll for item drop
    var dropRoll = _randomService.NextFloatForPosition(position, "loot_drop");
    if (dropRoll <= adjustedDropChance)
    {
        // Select item from biome pool
        var itemId = _biomeSpawnTableService.SelectItem(
            biomeId,
            position.Z,
            position);

        if (itemId != null)
        {
            // Determine quality with biome bonus
            var baseQuality = RollQuality(position);
            var adjustedQuality = modifiers.ApplyQualityBonus(baseQuality);

            // Roll for rare item
            var rareChance = GetBaseRareChance(monster);
            var adjustedRareChance = modifiers.ApplyRareChanceModifier(rareChance);
            var rareRoll = _randomService.NextFloatForPosition(position, "rare_roll");

            if (rareRoll <= adjustedRareChance)
            {
                adjustedQuality = Math.Max(adjustedQuality, (int)QualityTier.Rare);
            }

            items.Add(new DroppedItem
            {
                ItemId = itemId,
                QualityTier = adjustedQuality
            });

            _logger.LogDebug(
                "Generated loot: {ItemId} (quality {Quality}) from {BiomeId}",
                itemId, adjustedQuality, biomeId);
        }
    }

    // Check for exclusive item drop
    var exclusiveItem = TryGenerateExclusiveItem(biomeId, position);
    if (exclusiveItem != null)
    {
        items.Add(exclusiveItem);
    }

    // Check for crafting material drop
    var craftingMaterial = TryGenerateCraftingMaterial(biomeId, position);
    if (craftingMaterial != null)
    {
        items.Add(craftingMaterial);
    }

    return new LootDrop
    {
        Gold = gold,
        Items = items,
        BiomeId = biomeId
    };
}

/// <summary>
/// Tries to generate a biome-exclusive item drop.
/// </summary>
private DroppedItem? TryGenerateExclusiveItem(string biomeId, Position3D position)
{
    var exclusiveItems = _biomeSpawnTableService.GetExclusiveItems(biomeId);
    if (exclusiveItems.Count == 0)
        return null;

    // Very low base chance for exclusive items
    const float exclusiveChance = 0.005f;
    var roll = _randomService.NextFloatForPosition(position, "exclusive_loot");

    if (roll > exclusiveChance)
        return null;

    var index = _randomService.NextForPosition(
        position,
        0,
        exclusiveItems.Count,
        "exclusive_select");

    _logger.LogInformation(
        "Dropped exclusive item {ItemId} from biome {BiomeId}",
        exclusiveItems[index], biomeId);

    return new DroppedItem
    {
        ItemId = exclusiveItems[index],
        QualityTier = (int)QualityTier.Rare,
        IsExclusive = true
    };
}

/// <summary>
/// Tries to generate a biome-specific crafting material.
/// </summary>
private DroppedItem? TryGenerateCraftingMaterial(string biomeId, Position3D position)
{
    var materials = _biomeSpawnTableService.GetCraftingMaterials(biomeId);
    if (materials.Count == 0)
        return null;

    // Moderate chance for crafting materials
    const float materialChance = 0.15f;
    var roll = _randomService.NextFloatForPosition(position, "material_loot");

    if (roll > materialChance)
        return null;

    var index = _randomService.NextForPosition(
        position,
        0,
        materials.Count,
        "material_select");

    _logger.LogDebug(
        "Dropped crafting material {MaterialId} from biome {BiomeId}",
        materials[index], biomeId);

    return new DroppedItem
    {
        ItemId = materials[index],
        QualityTier = (int)QualityTier.Common,
        IsCraftingMaterial = true
    };
}

private BaseLoot GetBaseLoot(Monster monster)
{
    // Retrieve base loot from monster definition
    var definition = _monsterService.GetDefinition(monster.DefinitionId);
    return new BaseLoot
    {
        Gold = definition?.BaseGold ?? 0,
        DropChance = definition?.DropChance ?? 0.1f
    };
}

private int RollQuality(Position3D position)
{
    var roll = _randomService.NextFloatForPosition(position, "quality_roll");

    return roll switch
    {
        <= 0.60f => (int)QualityTier.Common,
        <= 0.85f => (int)QualityTier.Uncommon,
        <= 0.95f => (int)QualityTier.Rare,
        <= 0.99f => (int)QualityTier.Epic,
        _ => (int)QualityTier.Legendary
    };
}

private float GetBaseRareChance(Monster monster)
{
    var definition = _monsterService.GetDefinition(monster.DefinitionId);
    return definition?.Tier switch
    {
        "elite" => 0.15f,
        "boss" => 0.30f,
        _ => 0.05f
    };
}
```

---

## 10. Data Model Changes

### 10.1 New Entities

| Entity | Layer | Description |
|--------|-------|-------------|
| `BiomeSpawnTable` | Domain | Spawn pools and modifiers for a biome |

### 10.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `SpawnEntry` | Domain | Weighted spawn pool entry with constraints |
| `LootModifiers` | Domain | Loot quality/quantity multipliers |

### 10.3 Updated DTOs

#### DroppedItem DTO Update

**File:** `src/Core/RuneAndRust.Application/DTOs/LootDropDto.cs`

```csharp
/// <summary>
/// Represents an item dropped as loot.
/// </summary>
public record DroppedItem
{
    /// <summary>
    /// Gets the item definition ID.
    /// </summary>
    public string ItemId { get; init; } = string.Empty;

    /// <summary>
    /// Gets the quality tier (0 = Common, 4 = Legendary).
    /// </summary>
    public int QualityTier { get; init; }

    /// <summary>
    /// Gets whether this is a biome-exclusive item.
    /// </summary>
    public bool IsExclusive { get; init; }

    /// <summary>
    /// Gets whether this is a crafting material.
    /// </summary>
    public bool IsCraftingMaterial { get; init; }
}

/// <summary>
/// Represents a complete loot drop.
/// </summary>
public record LootDrop
{
    /// <summary>
    /// Gets the gold amount dropped.
    /// </summary>
    public int Gold { get; init; }

    /// <summary>
    /// Gets the items dropped.
    /// </summary>
    public IReadOnlyList<DroppedItem> Items { get; init; } = Array.Empty<DroppedItem>();

    /// <summary>
    /// Gets the biome where loot was generated.
    /// </summary>
    public string BiomeId { get; init; } = string.Empty;
}
```

### 10.4 Configuration DTOs

**File:** `src/Core/RuneAndRust.Application/Configuration/BiomeSpawnTableConfigurationDto.cs`

```csharp
namespace RuneAndRust.Application.Configuration;

/// <summary>
/// DTO for deserializing biome spawn table configuration.
/// </summary>
public class BiomeSpawnTableConfigurationDto
{
    public List<BiomeSpawnTableDto> SpawnTables { get; set; } = new();
}

public class BiomeSpawnTableDto
{
    public string BiomeId { get; set; } = string.Empty;
    public List<SpawnEntryDto> MonsterPool { get; set; } = new();
    public List<SpawnEntryDto> ItemPool { get; set; } = new();
    public List<SpawnEntryDto> HazardPool { get; set; } = new();
    public LootModifiersDto? LootModifiers { get; set; }
    public List<string> ExclusiveItems { get; set; } = new();
    public List<string> ExclusiveMonsters { get; set; } = new();
    public List<string> CraftingMaterials { get; set; } = new();
}

public class SpawnEntryDto
{
    public string Id { get; set; } = string.Empty;
    public int Weight { get; set; } = 100;
    public int MinDepth { get; set; } = 0;
    public int? MaxDepth { get; set; }
    public Dictionary<string, string> Constraints { get; set; } = new();
    public List<string> RequiredTags { get; set; } = new();
}

public class LootModifiersDto
{
    public float GoldMultiplier { get; set; } = 1.0f;
    public float DropRateMultiplier { get; set; } = 1.0f;
    public int QualityBonus { get; set; } = 0;
    public float RareChanceModifier { get; set; } = 1.0f;
}
```

---

## 11. Configuration File Schemas

### 11.1 Biome Spawn Tables Configuration

**File:** `config/biome-spawn-tables.json`

```json
{
  "$schema": "schemas/biome-spawn-tables-schema.json",
  "spawnTables": [
    {
      "biomeId": "dungeon",
      "monsterPool": [
        { "id": "rat", "weight": 100, "minDepth": 0, "maxDepth": 2 },
        { "id": "giant-spider", "weight": 80, "minDepth": 0 },
        { "id": "goblin", "weight": 70, "minDepth": 0 },
        { "id": "goblin-archer", "weight": 50, "minDepth": 1 },
        { "id": "orc", "weight": 40, "minDepth": 2 }
      ],
      "itemPool": [
        { "id": "rusty-sword", "weight": 60, "minDepth": 0 },
        { "id": "leather-armor", "weight": 50, "minDepth": 0 },
        { "id": "health-potion", "weight": 80, "minDepth": 0 },
        { "id": "torch", "weight": 100, "minDepth": 0 }
      ],
      "exclusiveItems": [],
      "exclusiveMonsters": [],
      "craftingMaterials": ["iron-ore", "leather-scraps", "cloth-scraps"],
      "lootModifiers": {
        "goldMultiplier": 1.0,
        "dropRateMultiplier": 1.0,
        "qualityBonus": 0,
        "rareChanceModifier": 1.0
      }
    },
    {
      "biomeId": "catacombs",
      "monsterPool": [
        { "id": "skeleton-warrior", "weight": 100, "minDepth": 0 },
        { "id": "skeleton-archer", "weight": 80, "minDepth": 0 },
        { "id": "zombie", "weight": 70, "minDepth": 0 },
        { "id": "ghost", "weight": 40, "minDepth": 1 },
        { "id": "wight", "weight": 30, "minDepth": 2 },
        { "id": "lich", "weight": 10, "minDepth": 4, "constraints": { "tier": "boss" } }
      ],
      "itemPool": [
        { "id": "bone-dagger", "weight": 50, "minDepth": 0 },
        { "id": "skull-amulet", "weight": 30, "minDepth": 0 },
        { "id": "grave-dust", "weight": 80, "minDepth": 0 },
        { "id": "holy-water", "weight": 40, "minDepth": 0 },
        { "id": "silver-ring", "weight": 25, "minDepth": 1 }
      ],
      "exclusiveItems": ["crypt-key", "death-shroud", "phylactery-shard"],
      "exclusiveMonsters": ["tomb-guardian", "crypt-keeper"],
      "craftingMaterials": ["bone-fragment", "grave-dust", "ectoplasm", "burial-cloth"],
      "lootModifiers": {
        "goldMultiplier": 1.2,
        "dropRateMultiplier": 1.0,
        "qualityBonus": 0,
        "rareChanceModifier": 1.1
      }
    },
    {
      "biomeId": "sewers",
      "monsterPool": [
        { "id": "giant-rat", "weight": 100, "minDepth": 0 },
        { "id": "slime", "weight": 80, "minDepth": 0 },
        { "id": "plague-rat", "weight": 60, "minDepth": 0 },
        { "id": "crocodile", "weight": 40, "minDepth": 1 },
        { "id": "ooze", "weight": 35, "minDepth": 1 },
        { "id": "sewer-king", "weight": 10, "minDepth": 3, "constraints": { "tier": "boss" } }
      ],
      "itemPool": [
        { "id": "rusty-knife", "weight": 70, "minDepth": 0 },
        { "id": "tattered-cloak", "weight": 60, "minDepth": 0 },
        { "id": "antidote", "weight": 80, "minDepth": 0 },
        { "id": "waterproof-bag", "weight": 40, "minDepth": 0 }
      ],
      "exclusiveItems": ["sewer-map", "rat-kings-crown", "slime-core"],
      "exclusiveMonsters": ["sewer-beast", "plague-lord"],
      "craftingMaterials": ["slime-residue", "rat-tail", "corroded-metal", "sewer-moss"],
      "lootModifiers": {
        "goldMultiplier": 0.8,
        "dropRateMultiplier": 1.2,
        "qualityBonus": -1,
        "rareChanceModifier": 0.9
      }
    },
    {
      "biomeId": "mines",
      "monsterPool": [
        { "id": "kobold", "weight": 100, "minDepth": 2 },
        { "id": "cave-bat", "weight": 80, "minDepth": 2 },
        { "id": "rock-elemental", "weight": 50, "minDepth": 3 },
        { "id": "mine-spider", "weight": 60, "minDepth": 2 },
        { "id": "cave-troll", "weight": 30, "minDepth": 4 },
        { "id": "deep-dweller", "weight": 15, "minDepth": 5, "constraints": { "tier": "elite" } }
      ],
      "itemPool": [
        { "id": "pickaxe", "weight": 50, "minDepth": 2 },
        { "id": "mining-helmet", "weight": 40, "minDepth": 2 },
        { "id": "ore-chunk", "weight": 100, "minDepth": 2 },
        { "id": "gem-rough", "weight": 30, "minDepth": 3 }
      ],
      "exclusiveItems": ["master-pickaxe", "heart-of-the-mountain", "miners-luck-charm"],
      "exclusiveMonsters": ["mine-foreman", "crystal-golem"],
      "craftingMaterials": ["iron-ore", "copper-ore", "silver-ore", "gold-nugget", "coal"],
      "lootModifiers": {
        "goldMultiplier": 1.1,
        "dropRateMultiplier": 0.9,
        "qualityBonus": 0,
        "rareChanceModifier": 1.0
      }
    },
    {
      "biomeId": "ancient-ruins",
      "monsterPool": [
        { "id": "stone-guardian", "weight": 80, "minDepth": 3 },
        { "id": "animated-armor", "weight": 70, "minDepth": 3 },
        { "id": "arcane-construct", "weight": 50, "minDepth": 4 },
        { "id": "spirit-warden", "weight": 40, "minDepth": 4 },
        { "id": "ancient-sentinel", "weight": 20, "minDepth": 5, "constraints": { "tier": "elite" } },
        { "id": "ruin-keeper", "weight": 10, "minDepth": 6, "constraints": { "tier": "boss" } }
      ],
      "itemPool": [
        { "id": "ancient-scroll", "weight": 60, "minDepth": 3 },
        { "id": "runic-stone", "weight": 50, "minDepth": 3 },
        { "id": "enchanted-ring", "weight": 30, "minDepth": 4 },
        { "id": "spellbook-fragment", "weight": 40, "minDepth": 3 }
      ],
      "exclusiveItems": ["keystone-fragment", "ancient-relic", "arcane-focus"],
      "exclusiveMonsters": ["awakened-colossus", "eternal-guardian"],
      "craftingMaterials": ["runic-dust", "enchanted-stone", "ancient-metal", "spirit-essence"],
      "lootModifiers": {
        "goldMultiplier": 1.5,
        "dropRateMultiplier": 0.7,
        "qualityBonus": 1,
        "rareChanceModifier": 1.5
      }
    },
    {
      "biomeId": "frozen-depths",
      "monsterPool": [
        { "id": "ice-elemental", "weight": 80, "minDepth": 4 },
        { "id": "frost-spider", "weight": 70, "minDepth": 4 },
        { "id": "frozen-corpse", "weight": 60, "minDepth": 4 },
        { "id": "ice-wraith", "weight": 40, "minDepth": 5 },
        { "id": "yeti", "weight": 25, "minDepth": 5, "constraints": { "tier": "elite" } },
        { "id": "frost-wyrm", "weight": 10, "minDepth": 6, "constraints": { "tier": "boss" } }
      ],
      "itemPool": [
        { "id": "frost-blade", "weight": 40, "minDepth": 4 },
        { "id": "warm-cloak", "weight": 60, "minDepth": 4 },
        { "id": "ice-crystal", "weight": 80, "minDepth": 4 },
        { "id": "frost-resistance-potion", "weight": 70, "minDepth": 4 }
      ],
      "exclusiveItems": ["heart-of-winter", "frozen-tear", "permafrost-shard"],
      "exclusiveMonsters": ["ice-queen", "glacier-titan"],
      "craftingMaterials": ["ice-crystal", "frozen-essence", "yeti-fur", "permafrost-ore"],
      "lootModifiers": {
        "goldMultiplier": 1.0,
        "dropRateMultiplier": 1.0,
        "qualityBonus": 0,
        "rareChanceModifier": 1.2
      }
    },
    {
      "biomeId": "volcanic-caverns",
      "monsterPool": [
        { "id": "fire-elemental", "weight": 100, "minDepth": 6 },
        { "id": "magma-slime", "weight": 80, "minDepth": 6 },
        { "id": "salamander", "weight": 60, "minDepth": 6 },
        { "id": "fire-drake", "weight": 30, "minDepth": 7 },
        { "id": "lava-golem", "weight": 25, "minDepth": 7, "constraints": { "tier": "elite" } },
        { "id": "phoenix", "weight": 10, "minDepth": 8, "constraints": { "tier": "boss" } }
      ],
      "itemPool": [
        { "id": "fire-opal", "weight": 40, "minDepth": 6 },
        { "id": "obsidian-blade", "weight": 30, "minDepth": 6 },
        { "id": "volcanic-glass", "weight": 80, "minDepth": 6 },
        { "id": "fire-resistance-potion", "weight": 60, "minDepth": 6 }
      ],
      "exclusiveItems": ["heart-of-the-volcano", "phoenix-feather", "lava-core"],
      "exclusiveMonsters": ["magma-lord", "volcanic-titan"],
      "craftingMaterials": ["obsidian-shard", "sulfite-crystal", "ash-residue", "fire-essence"],
      "lootModifiers": {
        "goldMultiplier": 1.5,
        "dropRateMultiplier": 0.8,
        "qualityBonus": 1,
        "rareChanceModifier": 1.3
      }
    }
  ]
}
```

### 11.2 JSON Schema

**File:** `config/schemas/biome-spawn-tables-schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "biome-spawn-tables-schema.json",
  "title": "Biome Spawn Tables",
  "description": "Schema for biome spawn table configuration",
  "type": "object",
  "required": ["spawnTables"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "spawnTables": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/biomeSpawnTable"
      }
    }
  },
  "$defs": {
    "biomeSpawnTable": {
      "type": "object",
      "required": ["biomeId"],
      "properties": {
        "biomeId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Biome identifier (must match BiomeDefinition.Id)"
        },
        "monsterPool": {
          "type": "array",
          "items": { "$ref": "#/$defs/spawnEntry" },
          "description": "Weighted monster spawn entries"
        },
        "itemPool": {
          "type": "array",
          "items": { "$ref": "#/$defs/spawnEntry" },
          "description": "Weighted item spawn entries"
        },
        "hazardPool": {
          "type": "array",
          "items": { "$ref": "#/$defs/spawnEntry" },
          "description": "Weighted hazard spawn entries (v0.1.2c)"
        },
        "lootModifiers": {
          "$ref": "#/$defs/lootModifiers"
        },
        "exclusiveItems": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Biome-exclusive item IDs"
        },
        "exclusiveMonsters": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Biome-exclusive monster IDs"
        },
        "craftingMaterials": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Available crafting material IDs"
        }
      }
    },
    "spawnEntry": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Entity ID to spawn"
        },
        "weight": {
          "type": "integer",
          "minimum": 1,
          "default": 100,
          "description": "Spawn probability weight"
        },
        "minDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Minimum depth for spawning"
        },
        "maxDepth": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Maximum depth for spawning (null = unlimited)"
        },
        "constraints": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Additional spawn constraints"
        },
        "requiredTags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required context tags"
        }
      }
    },
    "lootModifiers": {
      "type": "object",
      "properties": {
        "goldMultiplier": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "default": 1.0,
          "description": "Gold amount multiplier"
        },
        "dropRateMultiplier": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "default": 1.0,
          "description": "Item drop chance multiplier"
        },
        "qualityBonus": {
          "type": "integer",
          "minimum": -5,
          "maximum": 5,
          "default": 0,
          "description": "Quality tier adjustment"
        },
        "rareChanceModifier": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "default": 1.0,
          "description": "Rare drop chance multiplier"
        }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `BiomeSpawnTableService` | Information | Spawn tables loaded, exclusive item dropped |
| `BiomeSpawnTableService` | Debug | Spawn table lookup, monster/item selection |
| `BiomeSpawnTableService` | Warning | Spawn table not found, no valid entries for depth |
| `BiomeSpawnTableService` | Error | Configuration loading failure |
| `ContentPlacementService` | Information | Content placed in biome |
| `ContentPlacementService` | Debug | Slot fill decisions, monster/item selection |
| `ContentPlacementService` | Warning | Empty spawn pool, fallback behavior |
| `LootService` | Information | Exclusive item dropped, rare item generated |
| `LootService` | Debug | Loot modifier application, quality rolls |

### 12.2 Log Message Examples

```csharp
// Information
_logger.LogInformation("Loaded {Count} biome spawn tables", tables.Count);
_logger.LogInformation("Spawned exclusive item {ItemId} from biome {BiomeId}", itemId, biomeId);
_logger.LogInformation("Dropped exclusive item {ItemId} from biome {BiomeId}", itemId, biomeId);

// Debug
_logger.LogDebug("Retrieved spawn table for biome {BiomeId}", biomeId);
_logger.LogDebug("Selected monster {MonsterId} from {BiomeId} at depth {Depth}", monsterId, biomeId, depth);
_logger.LogDebug("Selected item {ItemId} from {BiomeId} at depth {Depth}", itemId, biomeId, depth);
_logger.LogDebug("Applied loot modifiers: gold {Gold}, quality {Quality}", gold, quality);
_logger.LogDebug("Generated loot: {ItemId} (quality {Quality}) from {BiomeId}", itemId, quality, biomeId);

// Warning
_logger.LogWarning("Spawn table not found for biome {BiomeId}", biomeId);
_logger.LogWarning("No valid monsters for biome {BiomeId} at depth {Depth}", biomeId, depth);
_logger.LogWarning("No valid items for biome {BiomeId} at depth {Depth}", biomeId, depth);

// Error
_logger.LogError(ex, "Failed to load biome spawn tables from {Path}", configPath);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| BiomeSpawnTable entity | ~6 |
| SpawnEntry value object | ~5 |
| LootModifiers value object | ~5 |
| BiomeSpawnTableService | ~6 |
| ContentPlacementService integration | ~3 |
| **Total** | **~25** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `BiomeSpawnTableTests.cs` | ~6 | Create, GetMonstersForDepth, GetItemsForDepth, IsExclusive |
| `SpawnEntryTests.cs` | ~5 | Create, IsValidForDepth, MatchesConstraint, HasRequiredTags |
| `LootModifiersTests.cs` | ~5 | Create, Apply* methods, HasBonuses, HasPenalties |
| `BiomeSpawnTableServiceTests.cs` | ~6 | GetSpawnTable, SelectMonster, SelectItem, GetLootModifiers |
| `ContentPlacementIntegrationTests.cs` | ~3 | Biome filtering, exclusive spawning |

### 13.3 Test Categories

**BiomeSpawnTable Tests:**
```csharp
[Test]
public void Create_WithValidBiomeId_CreatesBiomeSpawnTable()

[Test]
public void Create_WithNullBiomeId_ThrowsArgumentException()

[Test]
public void GetMonstersForDepth_ReturnsOnlyValidEntries()

[Test]
public void GetMonstersForDepth_WithDepthBelowMin_ReturnsEmpty()

[Test]
public void GetItemsForDepth_ReturnsOnlyValidEntries()

[Test]
public void IsExclusiveMonster_WithExclusiveId_ReturnsTrue()

[Test]
public void IsExclusiveItem_WithNonExclusiveId_ReturnsFalse()

[Test]
public void GetTotalMonsterWeight_SumsValidEntryWeights()
```

**SpawnEntry Tests:**
```csharp
[Test]
public void Create_WithValidId_CreatesSpawnEntry()

[Test]
public void Create_WithNegativeWeight_ThrowsArgumentOutOfRangeException()

[Test]
public void IsValidForDepth_WithDepthInRange_ReturnsTrue()

[Test]
public void IsValidForDepth_WithDepthBelowMin_ReturnsFalse()

[Test]
public void IsValidForDepth_WithDepthAboveMax_ReturnsFalse()

[Test]
public void MatchesConstraint_WithExistingConstraint_ChecksValue()

[Test]
public void MatchesConstraint_WithNoConstraint_ReturnsTrue()

[Test]
public void HasRequiredTags_WithAllTagsPresent_ReturnsTrue()

[Test]
public void HasRequiredTags_WithMissingTag_ReturnsFalse()
```

**LootModifiers Tests:**
```csharp
[Test]
public void Default_HasNeutralValues()

[Test]
public void ApplyGoldMultiplier_MultipliesBaseGold()

[Test]
public void ApplyDropRateMultiplier_CapsAtOne()

[Test]
public void ApplyQualityBonus_AddsToBaseTier()

[Test]
public void ApplyRareChanceModifier_MultipliesBaseChance()

[Test]
public void HasBonuses_WithImprovedModifiers_ReturnsTrue()

[Test]
public void HasPenalties_WithReducedModifiers_ReturnsTrue()
```

**BiomeSpawnTableService Tests:**
```csharp
[Test]
public void GetSpawnTable_WithExistingBiome_ReturnsTable()

[Test]
public void GetSpawnTable_WithNonExistingBiome_ReturnsNull()

[Test]
public void GetValidMonsters_FiltersbyDepth()

[Test]
public void SelectMonster_ReturnsWeightedSelection()

[Test]
public void SelectItem_FiltersbyContextTags()

[Test]
public void GetLootModifiers_WithNonExistingBiome_ReturnsDefault()

[Test]
public void GetCraftingMaterials_ReturnsBiomeMaterials()

[Test]
public void GetExclusiveItems_ReturnsBiomeExclusives()
```

---

## 14. Use Cases

### UC-001: Spawn Biome-Appropriate Monster

**Actor:** System (Content Placement)
**Flow:** Room generated → ContentPlacementService.FillMonsterSlot(slot, biomeId) → GetSpawnTable(biomeId) → Filter by depth → Weighted selection → Monster created

### UC-002: Generate Biome-Modified Loot

**Actor:** System (Combat/Loot)
**Flow:** Monster defeated → LootService.GenerateLoot(monster, biomeId) → GetLootModifiers(biomeId) → Apply modifiers → Return loot

### UC-003: Drop Exclusive Item

**Actor:** System (Loot)
**Flow:** Loot generated → Roll for exclusive → GetExclusiveItems(biomeId) → Select random → Add to loot

### UC-004: Harvest Crafting Material

**Actor:** System (Loot)
**Flow:** Monster defeated → Roll for material → GetCraftingMaterials(biomeId) → Select random → Add to loot

### UC-005: Place Biome-Specific Items

**Actor:** System (Content Placement)
**Flow:** Room generated → ContentPlacementService.FillItemSlot(slot, biomeId) → GetSpawnTable(biomeId) → Select from ItemPool → Item placed

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `BiomeSpawnTable.cs` created
- [ ] `SpawnEntry.cs` created
- [ ] `LootModifiers.cs` created

### Application Layer
- [ ] `IBiomeSpawnTableService.cs` created
- [ ] `BiomeSpawnTableService.cs` created
- [ ] `ContentPlacementService.cs` updated with biome filtering
- [ ] `LootService.cs` updated with biome modifiers
- [ ] `BiomeSpawnTableConfigurationDto.cs` created
- [ ] `LootDropDto.cs` updated with new properties

### Infrastructure Layer
- [ ] `IConfigurationProvider.cs` updated
- [ ] `JsonConfigurationProvider.cs` updated to load spawn tables

### Configuration Files
- [ ] `config/biome-spawn-tables.json` created with 7 biome tables
- [ ] `config/schemas/biome-spawn-tables-schema.json` created

### Testing
- [ ] `BiomeSpawnTableTests.cs` created (~6 tests)
- [ ] `SpawnEntryTests.cs` created (~5 tests)
- [ ] `LootModifiersTests.cs` created (~5 tests)
- [ ] `BiomeSpawnTableServiceTests.cs` created (~6 tests)
- [ ] `ContentPlacementIntegrationTests.cs` created (~3 tests)
- [ ] All ~25 tests passing

### Documentation
- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 16. Acceptance Criteria

### Functional

- [ ] BiomeSpawnTable entity stores monster/item pools
- [ ] SpawnEntry supports depth constraints and weights
- [ ] SpawnEntry supports additional constraints and required tags
- [ ] LootModifiers adjusts gold, drop rate, quality, and rare chance
- [ ] BiomeSpawnTableService loads tables from JSON configuration
- [ ] BiomeSpawnTableService.GetSpawnTable returns table by biome ID
- [ ] BiomeSpawnTableService.GetValidMonsters filters by depth
- [ ] BiomeSpawnTableService.SelectMonster uses weighted selection
- [ ] BiomeSpawnTableService.SelectItem uses weighted selection
- [ ] ContentPlacementService filters monsters by biome
- [ ] ContentPlacementService filters items by biome
- [ ] LootService applies biome loot modifiers
- [ ] Exclusive items only drop in their designated biome
- [ ] Crafting materials are biome-specific
- [ ] Seven biome spawn tables configured with unique content

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~25 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on public members
- [ ] Code follows .editorconfig conventions
- [ ] Loot modifiers correctly affect all applicable values

---

## 17. Dependencies

### 17.1 Prerequisites (v0.1.2a)

| Component | Purpose for v0.1.2b |
|-----------|---------------------|
| `BiomeDefinition` | Biome identification for spawn tables |
| `BiomeService` | Biome lookup for content placement |
| `Room.BiomeId` | Room biome identification |
| `SeededRandomService` | Reproducible weighted selection |
| `IConfigurationProvider` | Configuration loading pattern |
| `Position3D` | Position-based seeded randomization |

### 17.2 Provides to Future Phases

| Component | Used By |
|-----------|---------|
| `BiomeSpawnTable` | v0.1.2c (Hazards via HazardPool) |
| `SpawnEntry` | v0.1.2c (Hazard entries) |
| `LootModifiers` | v0.1.2c (Hazard-specific modifiers) |
| `BiomeSpawnTableService` | All subsequent biome content phases |
| `ContentPlacementService.FillMonsterSlot` | Room generation |
| `LootService.GenerateLoot` | Combat rewards |

### 17.3 Dependency Diagram

```
v0.1.2a (Biome System Core)
    │
    ├── BiomeDefinition ─────────────────────────────────┐
    ├── BiomeService ────────────────────────────────────┤
    ├── Room.BiomeId ────────────────────────────────────┤
    └── SeededRandomService ─────────────────────────────┘
                                                         │
                                                         ▼
v0.1.2b (Biome Content Pools)
    │
    ├── BiomeSpawnTable ─────────────────────────────────────────────┐
    ├── SpawnEntry ──────────────────────────────────────────────────│
    ├── LootModifiers ───────────────────────────────────────────────│
    ├── BiomeSpawnTableService ──────────────────────────────────────│
    ├── ContentPlacementService (biome filtering) ───────────────────┤
    └── LootService (biome modifiers) ───────────────────────────────┘
                                                                     │
                                                                     ▼
                                                         v0.1.2c (Environmental Hazards)
                                                             │
                                                             ├── HazardPool usage
                                                             └── BiomeDamageModifier
```

---

## 18. Future Considerations

### 18.1 Deferred to v0.1.2c

- **HazardPool usage** - BiomeSpawnTable.HazardPool is defined but not processed
- **BiomeHazard** - Environmental dangers per biome
- **BiomeDamageModifier** - Elemental resistance/vulnerability by biome
- **Hazard spawning** - ContentPlacementService hazard slot filling

### 18.2 Deferred to v0.1.2d

- **BiomeTransition** - Rules for zone connections
- **Cross-biome spawn blending** - Transition zones with mixed content
- **BiomeProgress** - Player discovery tracking
- **Codex integration** - Biome-specific bestiary entries

### 18.3 Out of Scope (Future Versions)

- **Dynamic spawn table modification** - Runtime pool adjustments
- **Player reputation per biome** - Faction-influenced spawns
- **Seasonal content pools** - Time-based spawn variations
- **Custom spawn table editor** - Player/modder tools
- **Spawn table difficulty scaling** - Automatic adjustment based on player level

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
