# Changelog: v0.17.5e - Character Factory

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (5/7)
**Status:** Complete

---

## Overview

Implements the Character Factory phase: 1 value object (`FactoryValidationResult`), 1 updated interface (`ICharacterFactory` — replaced stub from v0.17.5d), 1 application service (`CharacterFactory`), and comprehensive unit tests (38 test methods across the test file). The `CharacterFactory` transforms a completed `CharacterCreationState` into a fully initialized `Player` entity via a 13-step initialization sequence, coordinating with five providers and one calculator.

The factory provides two operations: `ValidateState()` checks that all required selections are present and internally consistent (8 validation rules), and `CreateCharacterAsync()` executes the complete character assembly pipeline from state validation through saga progression initialization.

---

## Added

### Domain Layer

#### Value Objects

- **`FactoryValidationResult`** (`ValueObjects/FactoryValidationResult.cs`)
    - `readonly record struct` with 2 properties: `IsValid` (bool), `Errors` (IReadOnlyList\<string\>)
    - Factory methods: `Valid()`, `Invalid(params string[])`, `Invalid(IReadOnlyList<string>)`
    - `ToString()` override: "Valid" or "Invalid: {count} error(s)"
    - Section separators: PROPERTIES, FACTORY METHODS, DEBUGGING

### Application Layer

#### Services

- **`CharacterFactory`** (`Services/CharacterFactory.cs`)
    - `public class CharacterFactory : ICharacterFactory`
    - Constructor: 6 required dependencies (`ILineageProvider`, `IBackgroundProvider`, `IArchetypeProvider`, `ISpecializationProvider`, `IDerivedStatCalculator`, `ILogger<CharacterFactory>`)
    - `ArgumentNullException.ThrowIfNull()` for all 6 parameters
    - 8 error message constants for validation failures
    - Compiled `PascalCaseSplitter` regex for PascalCase-to-kebab-case conversion
    - **`ValidateState(CharacterCreationState)`** — 8 validation checks:
        1. Lineage is selected
        2. Background is selected
        3. Attributes allocated and complete (`IsComplete`)
        4. Archetype is selected
        5. Specialization is selected
        6. Character name not null/whitespace
        7. Clan-Born lineage has flexible attribute bonus
        8. Specialization belongs to selected archetype (via `ISpecializationProvider.GetBySpecializationId`)
    - **`CreateCharacterAsync(CharacterCreationState, CancellationToken)`** — 13-step initialization:
        1. Validate state completeness and consistency
        2. Construct Player entity with base attributes (Sturdiness → Fortitude mapping)
        3. Set lineage on Player (once-only via `Player.SetLineage`)
        4. Set background on Player (once-only via `Player.SetBackground`)
        5. Apply lineage attribute modifiers (via `GetEffectiveModifier` with flexible bonus support)
        6. Apply lineage passive bonuses (Max HP, Max AP, Soak, Movement, Skills)
        7. Register lineage trait (via `Player.RegisterLineageTrait`)
        8. Set trauma baseline (4 params: corruption, stress, resistance modifiers)
        9. Grant background skill bonuses (via `Player.ModifySkill`)
        10. Set archetype and calculate/apply derived stats (via `IDerivedStatCalculator.CalculateDerivedStats`)
        11. Initialize resource pools — Stamina and Aether Pool at maximum (via `Player.InitializeResource`)
        12. Grant 3 archetype starting abilities (via `Player.GrantAbility`)
        13. Apply specialization (Tier 1 abilities, special resource, PP: 0, Rank: 1)
    - Private helper methods for each step with exhaustive structured logging
    - `ConvertToKebabCase()` helper matching `ViewModelBuilder` pattern
    - Section separators: PRIVATE FIELDS, VALIDATION ERROR MESSAGES, KEBAB-CASE CONVERSION, CONSTRUCTOR, ICharacterFactory IMPLEMENTATION, PRIVATE INITIALIZATION STEPS, PRIVATE HELPER METHODS

### Unit Tests

- **`CharacterFactoryTests`** (`Services/CharacterFactoryTests.cs`) — 38 test methods
    - **Constructor Tests (6 methods):**
        - `Constructor_NullLineageProvider_Throws`: ArgumentNullException with parameterName
        - `Constructor_NullBackgroundProvider_Throws`: ArgumentNullException with parameterName
        - `Constructor_NullArchetypeProvider_Throws`: ArgumentNullException with parameterName
        - `Constructor_NullSpecializationProvider_Throws`: ArgumentNullException with parameterName
        - `Constructor_NullDerivedStatCalculator_Throws`: ArgumentNullException with parameterName
        - `Constructor_NullLogger_Throws`: ArgumentNullException with parameterName
    - **ValidateState Happy Path (2 methods):**
        - `ValidateState_CompleteState_ReturnsValid`: All fields present → IsValid, empty errors
        - `ValidateState_NullState_Throws`: ArgumentNullException
    - **ValidateState Missing Fields (7 methods):**
        - `ValidateState_MissingLineage_ReturnsInvalid`: "Lineage is required."
        - `ValidateState_MissingBackground_ReturnsInvalid`: "Background is required."
        - `ValidateState_NullAttributes_ReturnsInvalid`: "Complete attribute allocation is required."
        - `ValidateState_IncompleteAttributes_ReturnsInvalid`: PointsRemaining > 0
        - `ValidateState_MissingArchetype_ReturnsInvalid`: "Archetype is required."
        - `ValidateState_MissingSpecialization_ReturnsInvalid`: "Specialization is required."
        - `ValidateState_MissingName_ReturnsInvalid` / `ValidateState_WhitespaceName_ReturnsInvalid`: "Character name is required."
    - **ValidateState Clan-Born (2 methods):**
        - `ValidateState_ClanBorn_WithoutFlexibleBonus_ReturnsInvalid`: Missing flexible bonus error
        - `ValidateState_ClanBorn_WithFlexibleBonus_ReturnsValid`: Passes with bonus selected
    - **ValidateState Specialization-Archetype (2 methods):**
        - `ValidateState_SpecializationArchetypeMismatch_ReturnsInvalid`: Skald (Adept) with Warrior
        - `ValidateState_MultipleFieldsMissing_ReturnsAllErrors`: Empty state → 5+ errors
    - **CreateCharacterAsync Tests (19 methods):**
        - Player construction, name trimming, lineage/background set
        - Attribute modifier application, Clan-Born flexible bonus
        - Passive bonus application, trait registration, trauma baseline
        - Background skill grants, derived stat calculation
        - Resource pool initialization, archetype ability grants (3)
        - Specialization application with Tier 1 abilities (3), special resource
        - Saga progression (PP: 0, Rank: 1)
        - Invalid state throws `InvalidOperationException`, null state throws `ArgumentNullException`
        - Full integration test verifying all 13 steps
    - Mock helper methods with realistic data: Rune-Marked Warrior Berserkr defaults
    - All tests use `FluentAssertions` with `[TestFixture]` and `[Test]` NUnit attributes
    - `#pragma warning disable NUnit2045` for readable multi-assertion tests

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `character-factory`: Application service for creating Player entities from creation state (sortOrder: 64)
    - `factory-validation-result`: Validation result value object for creation state completeness (sortOrder: 65)

---

## Changed

### Application Layer

- **`ICharacterFactory`** (`Interfaces/ICharacterFactory.cs`) — Replaced v0.17.5d stub with full interface
    - Added `ValidateState(CharacterCreationState state)` method returning `FactoryValidationResult`
    - Added `CancellationToken ct = default` parameter to `CreateCharacterAsync`
    - Updated version from `0.17.5d (stub)` to `0.17.5e`
    - Added `using RuneAndRust.Domain.ValueObjects;` for `FactoryValidationResult`
    - Comprehensive XML documentation with validation rules, responsibilities, usage examples

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5e unit test items
    - `[x] CreateCharacter produces valid character`
    - `[x] All modifiers applied correctly`
    - `[x] Starting resources at maximum`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5e deliverables
    - `[x] ICharacterFactory interface`
    - `[x] CharacterFactory implementation`

- **`docs/design/v0.17.x/v0.17.5e-design-specification.md`** — Checked off all deliverable and acceptance criteria items

---

## Design Decisions

### No Player.Create() Factory Method

The design specification calls `Player.Create(name, lineage, background, attributes)`. The actual `Player` entity has no static `Create()` method — it uses a standard constructor: `new Player(name, raceId, backgroundId, attributes)`. The implementation uses the constructor directly.

| Aspect | Design Spec | Implementation |
|---|---|---|
| Construction | `Player.Create(name, lineage, bg, attrs)` | `new Player(name: name, raceId: lineageKebab, backgroundId: bgKebab, attributes: playerAttributes)` |
| Reason | Factory method doesn't exist | Player uses standard constructor |

### Sturdiness → Fortitude Mapping

`CoreAttribute.Sturdiness` maps to `PlayerAttributes.Fortitude` in the constructor. The design specification references `Sturdiness` throughout, but `PlayerAttributes` expects `fortitude` as the parameter name. The factory performs this mapping: `fortitude: attributes.CurrentSturdiness`.

### Synchronous Provider Methods

All provider interfaces (`ILineageProvider`, `IBackgroundProvider`, `IArchetypeProvider`, `ISpecializationProvider`) use synchronous methods, not async. The design specification shows `await _lineageProvider.GetByIdAsync()`. The implementation calls synchronous methods directly (e.g., `_lineageProvider.GetAttributeModifiers(lineage)`).

### SetTraumaBaseline Takes 4 Parameters

The design specification shows `player.SetTraumaBaseline(corruption, stress)` with 2 parameters. The actual method signature is `SetTraumaBaseline(int startingCorruption, int startingStress, int corruptionResistanceModifier, int stressResistanceModifier)` — 4 parameters including resistance modifiers.

### No SetResourcesToMaximum() Method

The design specification calls `player.SetResourcesToMaximum()` which does not exist. Resources are initialized individually:
- **HP:** Automatically at maximum via `Player.SetStats()` (sets Health = MaxHealth when player was at full health)
- **Stamina/Aether Pool:** Via `Player.InitializeResource(id, max, startAtZero: false)`

### ArchetypeAbilityGrant Uses AbilityName Not DisplayName

The `ArchetypeAbilityGrant` record struct uses `AbilityName` as its display property, not `DisplayName`. The initial implementation referenced `DisplayName` which was corrected during the build phase.

### SpecializationAbilityTier? Requires .Value Access

Since `SpecializationDefinition.GetTier(1)` returns `SpecializationAbilityTier?` (nullable struct), accessing `Abilities` requires unwrapping via `.Value` after the null check. The initial implementation used `tier1.Abilities` directly which was corrected during the build phase.

### DerivedStats Calculated Twice

The factory calls `IDerivedStatCalculator.CalculateDerivedStats()` twice — once in Step 10 (for Stats/HP) and once in Step 11 (for Stamina/Aether Pool maximum values). Since `DerivedStats` is a value type with no caching, this is a minor cost for clarity of step separation.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationState` | v0.17.5a | Input state for factory |
| `AttributeAllocationState` | v0.17.1 | Attribute values and `IsComplete` |
| `Player` | Core Entity | Target entity constructed by factory |
| `PlayerAttributes` | Core VO | Constructor parameter (Sturdiness→Fortitude) |
| `Stats` | Core VO | Applied via `Player.SetStats()` |
| `DerivedStats` | v0.17.2d | Calculator output for HP/Stamina/AP |
| `ILineageProvider` | v0.17.0 | Attribute modifiers, passives, traits, trauma |
| `IBackgroundProvider` | v0.17.1 | Skill grants |
| `IArchetypeProvider` | v0.17.3 | Starting abilities |
| `ISpecializationProvider` | v0.17.4 | Spec definitions, Tier 1 abilities |
| `IDerivedStatCalculator` | v0.17.2d | HP, Stamina, Aether Pool calculations |
| `ICharacterFactory` (stub) | v0.17.5d | Interface replaced with full implementation |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterFactory` | v0.17.5f | Controller calls factory on ConfirmCharacter |
| `FactoryValidationResult` | v0.17.5f | Pre-creation validation feedback |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | CharacterFactory initialized with all providers |
| Debug | Validating creation state (SessionId) |
| Debug | State validation failed (ErrorCount, Errors, SessionId) |
| Debug | State validation passed (SessionId) |
| Debug | Converted IDs — kebab-case lineage, background, archetype (SessionId) |
| Debug | Player entity created (PlayerId, Name, BaseAttributes, SessionId) |
| Debug | Lineage set (Lineage, SessionId) |
| Debug | Background set (Background, SessionId) |
| Debug | Applying lineage attribute modifiers (Lineage, FlexibleBonus, SessionId) |
| Debug | Applied lineage modifier per attribute (Attribute, Modifier, SessionId) |
| Debug | Applying lineage passive bonuses (Lineage, HasHp, HasAp, HasSoak, HasMovement, SkillCount, SessionId) |
| Debug | Applied each passive bonus: Max HP, Max AP, Soak, Movement, Skill (SessionId) |
| Debug | Registered lineage trait (TraitName, SessionId) |
| Debug | Trauma baseline set (Corruption, Stress, CorruptionResist, StressResist, SessionId) |
| Debug | Granting background skills (Background, GrantCount, SessionId) |
| Debug | Granted background skill per grant (SkillId, Bonus, SessionId) |
| Debug | Archetype set (Archetype, ArchetypeId, SessionId) |
| Debug | Derived stats calculated (MaxHp, MaxStamina, MaxAetherPool, Initiative, Soak, SessionId) |
| Debug | Stats applied (MaxHealth, Attack, Defense, Health, SessionId) |
| Debug | Stamina pool initialized (MaxStamina, SessionId) |
| Debug | Aether Pool initialized (MaxAetherPool, SessionId) |
| Debug | Granting archetype abilities (Archetype, AbilityCount, SessionId) |
| Debug | Granted archetype ability per grant (AbilityId, AbilityName, SessionId) |
| Debug | Specialization added (Specialization, DisplayName, PathType, SessionId) |
| Debug | Special resource initialized (ResourceId, DisplayName, MaxValue, SessionId) |
| Debug | Granting Tier 1 abilities (Specialization, AbilityCount, SessionId) |
| Debug | Granted Tier 1 ability per grant (AbilityId, DisplayName, SessionId) |
| Debug | Saga progression initialized (PP, Rank, SessionId) |
| Information | Creating character (Name, Lineage, Archetype, Specialization, SessionId) |
| Information | Character created successfully (Name, HP, MaxHP, Lineage, Archetype, Specialization, AbilityCount, SessionId) |
| Warning | Specialization definition not found — skipping (Specialization, SessionId) |
| Error | Cannot create character: state validation failed (Errors, SessionId) |

All logging uses structured format with `{Named}` parameters for efficient log aggregation. SessionId is included in all log messages for session correlation.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/FactoryValidationResult.cs` | Factory validation result with IsValid and Errors |
| `src/Core/RuneAndRust.Application/Services/CharacterFactory.cs` | 13-step character initialization factory |
| `tests/RuneAndRust.Application.UnitTests/Services/CharacterFactoryTests.cs` | 38 test methods for factory behaviors |
| `changelogs/v0.17.5e-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Interfaces/ICharacterFactory.cs` | Replaced stub with full interface (ValidateState, CancellationToken) |
| `config/glossary.json` | Added 2 glossary entries (sortOrder 64-65) |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off v0.17.5e unit test items |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off factory deliverables |
| `docs/design/v0.17.x/v0.17.5e-design-specification.md` | Checked off all deliverable and acceptance criteria items |

---

## Notes

- Total unit tests for v0.17.5e: 38 test methods (design spec estimated ~5)
- Build: 0 errors, 0 warnings
- The design specification had 8+ API discrepancies with the actual codebase (see Design Decisions above)
- The `FactoryValidationResult` uses `readonly record struct` for immutability and value equality
- `CharacterFactory` uses `Task.FromResult()` since all provider methods are synchronous — the async interface is maintained for future compatibility
- The `ConvertToKebabCase()` helper uses the same compiled regex pattern as `ViewModelBuilder`
- The `CoreAttribute.Sturdiness` → `PlayerAttributes.Fortitude` mapping is a key implementation detail not documented in the design spec
- DerivedStats are calculated twice (Steps 10 and 11) for clarity of step separation
- All new files follow established codebase patterns: `═══════` section separators, file headers with Version tag, comprehensive XML documentation, exhaustive structured logging
