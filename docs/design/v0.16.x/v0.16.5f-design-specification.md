# v0.16.5f Design Specification: Achievement Integration

## Document Information

| Field               | Value                         |
| ------------------- | ----------------------------- |
| **Version**         | v0.16.5f                      |
| **Feature**         | Achievement Integration       |
| **Status**          | Draft                         |
| **Dependencies**    | v0.16.5c (UniqueItemRegistry) |
| **Estimated Tests** | 8                             |

---

## 1. Executive Summary

Version 0.16.5f provides hooks for future achievement system integration with the unique item system. This phase establishes the `UniqueItemAchievements` value object structure, defines the `IUniqueItemCollectionTracker` interface for tracking collection progress, and prepares achievement definitions for future implementation. The actual achievement awarding and UI are deferred to a future version.

### 1.1 Feature Overview

```
v0.16.5f: Achievement Integration
├── Domain Layer
│   ├── UniqueItemAchievements Value Object
│   │   ├── TotalUniquesFound: int
│   │   ├── UniquesByClass: Dictionary<string, int>
│   │   ├── FirstMythForgedAt: DateTime?
│   │   └── CollectionProgress: decimal (0.0 - 1.0)
│   ├── UniqueAchievementType Enum
│   │   ├── FirstMythForged
│   │   ├── CollectorBronze (5 items)
│   │   ├── CollectorSilver (15 items)
│   │   ├── CollectorGold (all items)
│   │   └── ClassMaster
│   └── AchievementThreshold Value Object
│       ├── Type: UniqueAchievementType
│       ├── RequiredCount: int
│       └── ClassId: string? (for ClassMaster)
├── Application Layer
│   └── IUniqueItemCollectionTracker Interface
│       ├── OnUniqueDropped(event) → void
│       ├── GetCollectionStats() → UniqueItemAchievements
│       ├── GetEarnedAchievements() → List<UniqueAchievementType>
│       └── GetProgressToward(type) → decimal
└── Integration Points
    ├── UniqueItemRegistry (v0.16.5c)
    └── MythForgedDropEvent (v0.16.5e)
```

### 1.2 Goals

1. Define `UniqueItemAchievements` value object structure
2. Define `UniqueAchievementType` enum with 5 achievement types
3. Define `IUniqueItemCollectionTracker` interface
4. Establish achievement thresholds and requirements
5. Prepare integration hooks for future achievement system

### 1.3 Non-Goals (Deferred)

- Actual achievement awarding logic (future)
- Achievement notification UI (future)
- Achievement persistence (future)
- Achievement rewards (future)

---

## 2. Architecture

### 2.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    FUTURE: ACHIEVEMENT SYSTEM                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              (Deferred to future version)                   ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ AchievementService                                      │││
│  │  │ AchievementNotificationUI                               │││
│  │  │ AchievementPersistence                                  │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (Future integration)
┌─────────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │          IUniqueItemCollectionTracker Interface             ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ OnUniqueDropped(MythForgedDropEvent) → void             │││
│  │  │ GetCollectionStats() → UniqueItemAchievements           │││
│  │  │ GetEarnedAchievements() → List<UniqueAchievementType>   │││
│  │  │ GetProgressToward(type) → decimal                       │││
│  │  │ GetNextMilestone() → AchievementThreshold?              │││
│  │  │ IsAchievementEarned(type) → bool                        │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                  │
│             ┌────────────────┼────────────────┐                 │
│             ▼                ▼                ▼                 │
│  ┌──────────────────┐ ┌─────────────┐ ┌──────────────────────┐  │
│  │ IUniqueItem      │ │ IUniqueItem │ │ (Future)             │  │
│  │ Registry         │ │ Repository  │ │ IAchievementService  │  │
│  │ (v0.16.5c)       │ │             │ │                      │  │
│  └──────────────────┘ └─────────────┘ └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │            UniqueItemAchievements (VO)                    │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ TotalUniquesFound: int                              │  │  │
│  │  │ TotalUniquesAvailable: int                          │  │  │
│  │  │ UniquesByClass: IReadOnlyDictionary<string, int>    │  │  │
│  │  │ FirstMythForgedAt: DateTime?                        │  │  │
│  │  │ LastDropAt: DateTime?                               │  │  │
│  │  │ CollectionProgress: decimal (0.0 - 1.0)             │  │  │
│  │  │ FoundItemIds: IReadOnlySet<string>                  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │             UniqueAchievementType (Enum)                  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ None = 0                                            │  │  │
│  │  │ FirstMythForged = 1    (First legendary drop)       │  │  │
│  │  │ CollectorBronze = 2    (5 unique items)             │  │  │
│  │  │ CollectorSilver = 3    (15 unique items)            │  │  │
│  │  │ CollectorGold = 4      (All unique items)           │  │  │
│  │  │ ClassMaster = 5        (All class-specific uniques) │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │             AchievementThreshold (VO)                     │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Type: UniqueAchievementType                         │  │  │
│  │  │ DisplayName: string                                 │  │  │
│  │  │ Description: string                                 │  │  │
│  │  │ RequiredCount: int                                  │  │  │
│  │  │ ClassId: string? (for ClassMaster)                  │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Collection Tracking Flow

```
┌─────────────────────────────────────────────────────────────────┐
│              COLLECTION TRACKING FLOW (Future)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  MYTH-FORGED DROP OCCURS                                        │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 1: Create MythForgedDropEvent (v0.16.5e)            │   │
│  └────────────────────────────┬─────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 2: Notify Collection Tracker                        │   │
│  │                                                          │   │
│  │  tracker.OnUniqueDropped(dropEvent)                      │   │
│  │                                                          │   │
│  │  Actions:                                                │   │
│  │  ├─ Add item ID to found set                             │   │
│  │  ├─ Increment total found count                          │   │
│  │  ├─ Update class-specific counts                         │   │
│  │  ├─ Set first drop timestamp (if first)                  │   │
│  │  └─ Update last drop timestamp                           │   │
│  │                                                          │   │
│  └────────────────────────────┬─────────────────────────────┘   │
│                               │                                 │
│                               ▼                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ STEP 3: Check Achievement Thresholds (Future)            │   │
│  │                                                          │   │
│  │  For each threshold:                                     │   │
│  │  ├─ FirstMythForged: stats.TotalUniquesFound >= 1?       │   │
│  │  ├─ CollectorBronze: stats.TotalUniquesFound >= 5?       │   │
│  │  ├─ CollectorSilver: stats.TotalUniquesFound >= 15?      │   │
│  │  ├─ CollectorGold: stats.CollectionProgress == 1.0?      │   │
│  │  └─ ClassMaster: All class uniques for classId found?    │   │
│  │                                                          │   │
│  │  If newly earned:                                        │   │
│  │      → Queue achievement notification                    │   │
│  │      → Award achievement (future)                        │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Achievement Progress Calculation

```
┌─────────────────────────────────────────────────────────────────┐
│              ACHIEVEMENT PROGRESS CALCULATION                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GetProgressToward(UniqueAchievementType type)                  │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ SWITCH on achievement type:                              │   │
│  │                                                          │   │
│  │ ┌──────────────────────────────────────────────────────┐ │   │
│  │ │ FirstMythForged:                                     │ │   │
│  │ │   return TotalUniquesFound >= 1 ? 1.0 : 0.0          │ │   │
│  │ └──────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │ ┌──────────────────────────────────────────────────────┐ │   │
│  │ │ CollectorBronze:                                     │ │   │
│  │ │   threshold = 5                                      │ │   │
│  │ │   return Min(1.0, TotalUniquesFound / threshold)     │ │   │
│  │ └──────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │ ┌──────────────────────────────────────────────────────┐ │   │
│  │ │ CollectorSilver:                                     │ │   │
│  │ │   threshold = 15                                     │ │   │
│  │ │   return Min(1.0, TotalUniquesFound / threshold)     │ │   │
│  │ └──────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │ ┌──────────────────────────────────────────────────────┐ │   │
│  │ │ CollectorGold:                                       │ │   │
│  │ │   return TotalUniquesFound / TotalUniquesAvailable   │ │   │
│  │ └──────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  │ ┌──────────────────────────────────────────────────────┐ │   │
│  │ │ ClassMaster:                                         │ │   │
│  │ │   classTotal = GetClassUniqueCount(classId)          │ │   │
│  │ │   classFound = UniquesByClass[classId]               │ │   │
│  │ │   return classFound / classTotal                     │ │   │
│  │ └──────────────────────────────────────────────────────┘ │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Data Model

### 3.1 UniqueAchievementType Enum

**Location:** `src/Core/RuneAndRust.Domain/Enums/UniqueAchievementType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Achievement types related to unique item collection.
/// Defines milestones for tracking Myth-Forged item discoveries.
/// </summary>
public enum UniqueAchievementType
{
    /// <summary>No achievement (default).</summary>
    None = 0,

    /// <summary>First Myth-Forged item ever found.</summary>
    FirstMythForged = 1,

    /// <summary>Found 5 unique items (bronze tier).</summary>
    CollectorBronze = 2,

    /// <summary>Found 15 unique items (silver tier).</summary>
    CollectorSilver = 3,

    /// <summary>Found all unique items in the game (gold tier).</summary>
    CollectorGold = 4,

    /// <summary>Found all class-specific unique items for a class.</summary>
    ClassMaster = 5
}
```

### 3.2 AchievementThreshold Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/AchievementThreshold.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the requirements for earning a unique item achievement.
/// </summary>
public readonly record struct AchievementThreshold
{
    /// <summary>The achievement type.</summary>
    public UniqueAchievementType Type { get; }

    /// <summary>Display name for the achievement.</summary>
    public string DisplayName { get; }

    /// <summary>Description of how to earn this achievement.</summary>
    public string Description { get; }

    /// <summary>Number of items required (0 for non-count based).</summary>
    public int RequiredCount { get; }

    /// <summary>Class ID for ClassMaster achievement (null for others).</summary>
    public string? ClassId { get; }

    private AchievementThreshold(
        UniqueAchievementType type,
        string displayName,
        string description,
        int requiredCount,
        string? classId)
    {
        Type = type;
        DisplayName = displayName;
        Description = description;
        RequiredCount = requiredCount;
        ClassId = classId;
    }

    /// <summary>Creates a count-based achievement threshold.</summary>
    public static AchievementThreshold CreateCountBased(
        UniqueAchievementType type,
        string displayName,
        string description,
        int requiredCount)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName, nameof(displayName));
        ArgumentOutOfRangeException.ThrowIfNegative(requiredCount, nameof(requiredCount));

        return new AchievementThreshold(type, displayName, description, requiredCount, null);
    }

    /// <summary>Creates a class-specific achievement threshold.</summary>
    public static AchievementThreshold CreateClassBased(
        string displayName,
        string description,
        string classId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName, nameof(displayName));
        ArgumentException.ThrowIfNullOrWhiteSpace(classId, nameof(classId));

        return new AchievementThreshold(
            UniqueAchievementType.ClassMaster,
            displayName,
            description,
            requiredCount: 0,
            classId.ToLowerInvariant());
    }

    /// <summary>Pre-defined thresholds for standard achievements.</summary>
    public static class Defaults
    {
        public static readonly AchievementThreshold FirstMythForged =
            CreateCountBased(
                UniqueAchievementType.FirstMythForged,
                "First Legend",
                "Find your first Myth-Forged item",
                requiredCount: 1);

        public static readonly AchievementThreshold CollectorBronze =
            CreateCountBased(
                UniqueAchievementType.CollectorBronze,
                "Collector: Bronze",
                "Find 5 unique Myth-Forged items",
                requiredCount: 5);

        public static readonly AchievementThreshold CollectorSilver =
            CreateCountBased(
                UniqueAchievementType.CollectorSilver,
                "Collector: Silver",
                "Find 15 unique Myth-Forged items",
                requiredCount: 15);

        public static readonly AchievementThreshold CollectorGold =
            CreateCountBased(
                UniqueAchievementType.CollectorGold,
                "Collector: Gold",
                "Find all Myth-Forged items in the game",
                requiredCount: 0);  // Dynamically determined

        /// <summary>Gets all default thresholds.</summary>
        public static IReadOnlyList<AchievementThreshold> All =>
            new[] { FirstMythForged, CollectorBronze, CollectorSilver, CollectorGold };
    }

    public override string ToString() =>
        $"AchievementThreshold[{Type}: {DisplayName}]";
}
```

### 3.3 UniqueItemAchievements Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/UniqueItemAchievements.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Tracks a player's unique item collection progress and achievements.
/// Provides statistics for achievement calculations.
/// </summary>
public sealed class UniqueItemAchievements
{
    private readonly HashSet<string> _foundItemIds;
    private readonly Dictionary<string, int> _uniquesByClass;

    /// <summary>Total number of unique items found across all runs.</summary>
    public int TotalUniquesFound => _foundItemIds.Count;

    /// <summary>Total number of unique items available in the game.</summary>
    public int TotalUniquesAvailable { get; private set; }

    /// <summary>Count of unique items found per class.</summary>
    public IReadOnlyDictionary<string, int> UniquesByClass => _uniquesByClass;

    /// <summary>When the first Myth-Forged item was found (null if none).</summary>
    public DateTime? FirstMythForgedAt { get; private set; }

    /// <summary>When the most recent unique item was found.</summary>
    public DateTime? LastDropAt { get; private set; }

    /// <summary>
    /// Collection completion progress (0.0 = none, 1.0 = complete).
    /// </summary>
    public decimal CollectionProgress =>
        TotalUniquesAvailable > 0
            ? (decimal)TotalUniquesFound / TotalUniquesAvailable
            : 0m;

    /// <summary>Set of all found unique item IDs.</summary>
    public IReadOnlySet<string> FoundItemIds => _foundItemIds;

    /// <summary>Whether the player has found at least one unique.</summary>
    public bool HasFoundAny => TotalUniquesFound > 0;

    private UniqueItemAchievements()
    {
        _foundItemIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        _uniquesByClass = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
    }

    /// <summary>Creates a new achievements tracker.</summary>
    public static UniqueItemAchievements Create(int totalUniquesAvailable)
    {
        ArgumentOutOfRangeException.ThrowIfNegative(totalUniquesAvailable, nameof(totalUniquesAvailable));

        return new UniqueItemAchievements
        {
            TotalUniquesAvailable = totalUniquesAvailable
        };
    }

    /// <summary>Creates from existing data (for persistence loading).</summary>
    public static UniqueItemAchievements CreateFromData(
        int totalUniquesAvailable,
        IEnumerable<string> foundItemIds,
        Dictionary<string, int> uniquesByClass,
        DateTime? firstMythForgedAt,
        DateTime? lastDropAt)
    {
        var achievements = Create(totalUniquesAvailable);

        foreach (var itemId in foundItemIds)
        {
            achievements._foundItemIds.Add(itemId.ToLowerInvariant());
        }

        foreach (var kvp in uniquesByClass)
        {
            achievements._uniquesByClass[kvp.Key.ToLowerInvariant()] = kvp.Value;
        }

        achievements.FirstMythForgedAt = firstMythForgedAt;
        achievements.LastDropAt = lastDropAt;

        return achievements;
    }

    /// <summary>
    /// Records a unique item drop.
    /// </summary>
    /// <param name="itemId">The unique item's ID.</param>
    /// <param name="classAffinities">Classes the item has affinity for.</param>
    /// <param name="droppedAt">When the item dropped.</param>
    /// <returns>True if this was a new item, false if already found.</returns>
    public bool RecordDrop(
        string itemId,
        IReadOnlyList<string> classAffinities,
        DateTime? droppedAt = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));

        var normalizedId = itemId.ToLowerInvariant();
        var timestamp = droppedAt ?? DateTime.UtcNow;

        // Check if already found
        if (!_foundItemIds.Add(normalizedId))
        {
            return false;  // Already found
        }

        // Update timestamps
        FirstMythForgedAt ??= timestamp;
        LastDropAt = timestamp;

        // Update class counts
        foreach (var classId in classAffinities)
        {
            var normalizedClassId = classId.ToLowerInvariant();
            _uniquesByClass.TryGetValue(normalizedClassId, out var count);
            _uniquesByClass[normalizedClassId] = count + 1;
        }

        return true;
    }

    /// <summary>
    /// Checks if a specific unique item has been found.
    /// </summary>
    public bool HasFound(string itemId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));
        return _foundItemIds.Contains(itemId.ToLowerInvariant());
    }

    /// <summary>
    /// Gets the progress toward a specific achievement (0.0 - 1.0).
    /// </summary>
    public decimal GetProgressToward(UniqueAchievementType type, string? classId = null)
    {
        return type switch
        {
            UniqueAchievementType.FirstMythForged =>
                HasFoundAny ? 1.0m : 0.0m,

            UniqueAchievementType.CollectorBronze =>
                Math.Min(1.0m, TotalUniquesFound / 5.0m),

            UniqueAchievementType.CollectorSilver =>
                Math.Min(1.0m, TotalUniquesFound / 15.0m),

            UniqueAchievementType.CollectorGold =>
                CollectionProgress,

            UniqueAchievementType.ClassMaster when classId != null =>
                GetClassProgress(classId),

            _ => 0m
        };
    }

    /// <summary>
    /// Checks if an achievement has been earned.
    /// </summary>
    public bool IsAchievementEarned(UniqueAchievementType type, string? classId = null) =>
        GetProgressToward(type, classId) >= 1.0m;

    /// <summary>
    /// Gets all earned achievements.
    /// </summary>
    public IReadOnlyList<UniqueAchievementType> GetEarnedAchievements()
    {
        var earned = new List<UniqueAchievementType>();

        if (IsAchievementEarned(UniqueAchievementType.FirstMythForged))
            earned.Add(UniqueAchievementType.FirstMythForged);

        if (IsAchievementEarned(UniqueAchievementType.CollectorBronze))
            earned.Add(UniqueAchievementType.CollectorBronze);

        if (IsAchievementEarned(UniqueAchievementType.CollectorSilver))
            earned.Add(UniqueAchievementType.CollectorSilver);

        if (IsAchievementEarned(UniqueAchievementType.CollectorGold))
            earned.Add(UniqueAchievementType.CollectorGold);

        return earned;
    }

    private decimal GetClassProgress(string classId)
    {
        // This would require knowing total class-specific items
        // For now, return based on found count only
        var normalizedClassId = classId.ToLowerInvariant();
        if (!_uniquesByClass.TryGetValue(normalizedClassId, out var found))
        {
            return 0m;
        }

        // Placeholder: actual implementation would need class-specific total
        return found > 0 ? 0.5m : 0m;
    }

    public override string ToString() =>
        $"UniqueItemAchievements[Found: {TotalUniquesFound}/{TotalUniquesAvailable}, Progress: {CollectionProgress:P0}]";
}
```

### 3.4 IUniqueItemCollectionTracker Interface

**Location:** `src/Core/RuneAndRust.Application/Interfaces/IUniqueItemCollectionTracker.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Interface for tracking unique item collection progress and achievements.
/// Provides hooks for the future achievement system.
/// </summary>
public interface IUniqueItemCollectionTracker
{
    /// <summary>
    /// Called when a unique item drops.
    /// Records the drop and updates collection statistics.
    /// </summary>
    /// <param name="dropEvent">The drop event from v0.16.5e.</param>
    void OnUniqueDropped(MythForgedDropEvent dropEvent);

    /// <summary>
    /// Gets the current collection statistics.
    /// </summary>
    /// <returns>Achievement progress data.</returns>
    UniqueItemAchievements GetCollectionStats();

    /// <summary>
    /// Gets all achievements that have been earned.
    /// </summary>
    /// <returns>List of earned achievement types.</returns>
    IReadOnlyList<UniqueAchievementType> GetEarnedAchievements();

    /// <summary>
    /// Gets progress toward a specific achievement.
    /// </summary>
    /// <param name="type">The achievement type.</param>
    /// <param name="classId">Class ID for ClassMaster achievements.</param>
    /// <returns>Progress from 0.0 to 1.0.</returns>
    decimal GetProgressToward(UniqueAchievementType type, string? classId = null);

    /// <summary>
    /// Gets the next unearned achievement milestone.
    /// </summary>
    /// <returns>The next threshold, or null if all are earned.</returns>
    AchievementThreshold? GetNextMilestone();

    /// <summary>
    /// Checks if a specific achievement has been earned.
    /// </summary>
    bool IsAchievementEarned(UniqueAchievementType type, string? classId = null);

    /// <summary>
    /// Checks if a specific unique item has been found.
    /// </summary>
    bool HasFoundItem(string itemId);

    /// <summary>
    /// Gets items remaining to find for full collection.
    /// </summary>
    int GetRemainingItemCount();
}
```

---

## 4. User Stories

### 4.1 Collection Tracking

**As a** completionist player  
**I want** my unique item discoveries to be tracked across runs  
**So that** I can work toward 100% collection completion

**Acceptance:**

- Drops recorded across runs
- Progress visible (X/Y items found)
- Duplicate tracking (already found indicator)

### 4.2 Achievement Progress

**As a** player  
**I want** to see progress toward collector achievements  
**So that** I know how close I am to the next milestone

**Acceptance:**

- Progress shown as percentage
- Next milestone displayed
- Clear indication when earned

---

## 5. Logging Specification

### 5.1 Log Events

| Event                | Level       | Template                                               |
| -------------------- | ----------- | ------------------------------------------------------ |
| Drop recorded        | Debug       | `"Recorded unique drop {ItemId}, total: {TotalFound}"` |
| New item found       | Information | `"New unique item discovered: {ItemId}"`               |
| Achievement progress | Debug       | `"Progress toward {Achievement}: {Progress:P0}"`       |
| Achievement earned   | Information | `"Achievement earned: {AchievementType}"`              |
| Milestone reached    | Information | `"Collection milestone: {Milestone}"`                  |

---

## 6. Unit Testing

### 6.1 Test Classes

| Test Class                    | Location                         | Tests |
| ----------------------------- | -------------------------------- | ----- |
| `UniqueAchievementTypeTests`  | `Domain.UnitTests/Enums/`        | 2     |
| `AchievementThresholdTests`   | `Domain.UnitTests/ValueObjects/` | 3     |
| `UniqueItemAchievementsTests` | `Domain.UnitTests/ValueObjects/` | 6     |

### 6.2 AchievementThresholdTests

```csharp
[TestFixture]
public class AchievementThresholdTests
{
    [Test]
    public void CreateCountBased_WithValidData_CreatesThreshold()
    {
        // Act
        var threshold = AchievementThreshold.CreateCountBased(
            UniqueAchievementType.CollectorBronze,
            "Collector: Bronze",
            "Find 5 unique items",
            requiredCount: 5);

        // Assert
        threshold.Type.Should().Be(UniqueAchievementType.CollectorBronze);
        threshold.DisplayName.Should().Be("Collector: Bronze");
        threshold.RequiredCount.Should().Be(5);
        threshold.ClassId.Should().BeNull();
    }

    [Test]
    public void CreateClassBased_WithValidData_CreatesThreshold()
    {
        // Act
        var threshold = AchievementThreshold.CreateClassBased(
            "Warrior Master",
            "Find all warrior uniques",
            "warrior");

        // Assert
        threshold.Type.Should().Be(UniqueAchievementType.ClassMaster);
        threshold.ClassId.Should().Be("warrior");
    }

    [Test]
    public void Defaults_ContainsAllStandardThresholds()
    {
        // Assert
        AchievementThreshold.Defaults.All.Should().HaveCount(4);
        AchievementThreshold.Defaults.All.Should().Contain(t =>
            t.Type == UniqueAchievementType.FirstMythForged);
        AchievementThreshold.Defaults.All.Should().Contain(t =>
            t.Type == UniqueAchievementType.CollectorGold);
    }
}
```

### 6.3 UniqueItemAchievementsTests

```csharp
[TestFixture]
public class UniqueItemAchievementsTests
{
    [Test]
    public void Create_InitializesWithZeroProgress()
    {
        // Act
        var achievements = UniqueItemAchievements.Create(totalUniquesAvailable: 20);

        // Assert
        achievements.TotalUniquesFound.Should().Be(0);
        achievements.TotalUniquesAvailable.Should().Be(20);
        achievements.CollectionProgress.Should().Be(0m);
        achievements.HasFoundAny.Should().BeFalse();
    }

    [Test]
    public void RecordDrop_FirstDrop_SetsTimestamps()
    {
        // Arrange
        var achievements = UniqueItemAchievements.Create(20);

        // Act
        var isNew = achievements.RecordDrop("shadowfang-blade", Array.Empty<string>());

        // Assert
        isNew.Should().BeTrue();
        achievements.TotalUniquesFound.Should().Be(1);
        achievements.FirstMythForgedAt.Should().NotBeNull();
        achievements.HasFoundAny.Should().BeTrue();
    }

    [Test]
    public void RecordDrop_DuplicateItem_ReturnsFalse()
    {
        // Arrange
        var achievements = UniqueItemAchievements.Create(20);
        achievements.RecordDrop("shadowfang-blade", Array.Empty<string>());

        // Act
        var isNew = achievements.RecordDrop("shadowfang-blade", Array.Empty<string>());

        // Assert
        isNew.Should().BeFalse();
        achievements.TotalUniquesFound.Should().Be(1);  // Not incremented
    }

    [Test]
    public void CollectionProgress_CalculatesCorrectly()
    {
        // Arrange
        var achievements = UniqueItemAchievements.Create(totalUniquesAvailable: 10);
        achievements.RecordDrop("item-1", Array.Empty<string>());
        achievements.RecordDrop("item-2", Array.Empty<string>());

        // Assert
        achievements.CollectionProgress.Should().Be(0.2m);  // 2/10
    }

    [Test]
    public void GetProgressToward_CollectorBronze_CalculatesCorrectly()
    {
        // Arrange
        var achievements = UniqueItemAchievements.Create(20);
        for (int i = 0; i < 3; i++)
        {
            achievements.RecordDrop($"item-{i}", Array.Empty<string>());
        }

        // Act
        var progress = achievements.GetProgressToward(UniqueAchievementType.CollectorBronze);

        // Assert
        progress.Should().Be(0.6m);  // 3/5
    }

    [Test]
    public void IsAchievementEarned_FirstMythForged_TrueAfterFirstDrop()
    {
        // Arrange
        var achievements = UniqueItemAchievements.Create(20);

        // Assert - before drop
        achievements.IsAchievementEarned(UniqueAchievementType.FirstMythForged)
            .Should().BeFalse();

        // Act
        achievements.RecordDrop("item-1", Array.Empty<string>());

        // Assert - after drop
        achievements.IsAchievementEarned(UniqueAchievementType.FirstMythForged)
            .Should().BeTrue();
    }
}
```

---

## 7. Acceptance Criteria

| #   | Criterion                                           | Verification |
| --- | --------------------------------------------------- | ------------ |
| 1   | `UniqueAchievementType` defines 5 achievement types | Unit test    |
| 2   | `AchievementThreshold` defines default thresholds   | Unit test    |
| 3   | `UniqueItemAchievements` tracks found items         | Unit test    |
| 4   | Duplicate drops are not counted twice               | Unit test    |
| 5   | Collection progress calculates correctly            | Unit test    |
| 6   | `FirstMythForged` earned after first drop           | Unit test    |
| 7   | `CollectorBronze` requires 5 items                  | Unit test    |
| 8   | `IUniqueItemCollectionTracker` interface defined    | Code review  |

---

## 8. Deliverable Checklist

### 8.1 Domain Layer

- [ ] `UniqueAchievementType.cs` - Enum with 5 types
- [ ] `AchievementThreshold.cs` - Value object with defaults
- [ ] `UniqueItemAchievements.cs` - Collection tracking value object

### 8.2 Application Layer

- [ ] `IUniqueItemCollectionTracker.cs` - Interface for tracking

### 8.3 Tests

- [ ] `UniqueAchievementTypeTests.cs` - Enum tests
- [ ] `AchievementThresholdTests.cs` - Threshold tests
- [ ] `UniqueItemAchievementsTests.cs` - Achievement tracking tests

---

## 9. Dependencies

### 9.1 Required

| Dependency          | Version  | Purpose               |
| ------------------- | -------- | --------------------- |
| UniqueItemRegistry  | v0.16.5c | Drop tracking per run |
| MythForgedDropEvent | v0.16.5e | Drop event data       |

### 9.2 Dependents (Future)

| Feature             | Version | Relationship                        |
| ------------------- | ------- | ----------------------------------- |
| Achievement System  | Future  | Consumes hooks and interfaces       |
| Achievement UI      | Future  | Displays progress                   |
| Achievement Rewards | Future  | Awards based on earned achievements |

---

## 10. Future Considerations

### 10.1 Deferred to Future Versions

- **Achievement Service Implementation** - Actual awarding logic
- **Achievement Notifications** - UI popups when achievements unlock
- **Achievement Persistence** - Cross-session tracking in save data
- **Achievement Rewards** - Bonus effects for earning achievements
- **Leaderboard Integration** - Track collection speed across players
- **ClassMaster Tracking** - Per-class unique item totals

### 10.2 Integration Points Prepared

The interfaces and structures defined in this phase are designed for future integration:

```csharp
// Future: Achievement service can subscribe to drops
services.AddScoped<IUniqueItemCollectionTracker, UniqueItemCollectionTracker>();

// Future: Achievement service listens to events
mythForgedService.OnDrop += (event) => {
    collectionTracker.OnUniqueDropped(event);
    achievementService.CheckAchievements(collectionTracker.GetCollectionStats());
};
```

---

## 11. v0.16.5 Completion Summary

With v0.16.5f complete, the entire Myth-Forged Unique Items system is fully designed:

| Phase    | Feature                      | Status       |
| -------- | ---------------------------- | ------------ |
| v0.16.5a | Unique Item Definition       | ✅ Specified |
| v0.16.5b | Special Effect System        | ✅ Specified |
| v0.16.5c | Unique Item Registry         | ✅ Specified |
| v0.16.5d | Myth-Forged Drop Integration | ✅ Specified |
| v0.16.5e | Legendary Drop Presentation  | ✅ Specified |
| v0.16.5f | Achievement Integration      | ✅ Specified |

**Total Estimated Tests:** ~74 across all phases
