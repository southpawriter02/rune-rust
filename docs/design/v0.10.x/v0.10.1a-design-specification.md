# v0.10.1a Design Specification: Defense Actions

**Version:** 0.10.1a
**Parent:** v0.10.1 (Combat Actions)
**Prerequisites:** v0.10.0c Complete (Status Effects System - Effect Triggers & Cleanse)
**Status:** Design Complete
**Estimated Unit Tests:** ~15

---

## 1. Overview

### Purpose

Implement defensive combat actions that allow combatants to react to incoming attacks. Block reduces damage when using a shield, dodge provides a chance to avoid attacks entirely, and parry allows deflecting an attack and counter-attacking. These consume the combatant's reaction for the round.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `IDefenseActionService` |
| **Services** | `DefenseActionService` |
| **Enums** | `DefenseActionType` |
| **Result Types** | `BlockResult`, `DodgeResult`, `ParryResult` |
| **Entity Updates** | Reaction tracking on `ICombatant` |
| **Configuration** | `defense-actions.json` |
| **Tests** | ~15 unit tests |

---

## 2. Feature Overview

```
v0.10.1a Features
â”œâ”€â”€ DefenseActionType Enum
â”‚   â”œâ”€â”€ Block
â”‚   â”œâ”€â”€ Dodge
â”‚   â””â”€â”€ Parry
â”‚
â”œâ”€â”€ IDefenseActionService Interface
â”‚   â”œâ”€â”€ CanBlock(target): bool
â”‚   â”œâ”€â”€ CanDodge(target): bool
â”‚   â”œâ”€â”€ CanParry(target): bool
â”‚   â”œâ”€â”€ UseBlock(target, damage): BlockResult
â”‚   â”œâ”€â”€ UseDodge(target, attackRoll): DodgeResult
â”‚   â”œâ”€â”€ UseParry(target, attacker, attackRoll): ParryResult
â”‚   â”œâ”€â”€ ResetReaction(combatant)
â”‚   â””â”€â”€ HasReaction(combatant): bool
â”‚
â”œâ”€â”€ Block Action
â”‚   â”œâ”€â”€ Requires shield equipped
â”‚   â”œâ”€â”€ Reduces damage by 50% + shield bonus
â”‚   â”œâ”€â”€ Can be used as action or reaction
â”‚   â””â”€â”€ No cooldown
â”‚
â”œâ”€â”€ Dodge Action
â”‚   â”œâ”€â”€ DEX-based roll vs attack roll
â”‚   â”œâ”€â”€ Avoids attack entirely on success
â”‚   â”œâ”€â”€ Consumes reaction
â”‚   â”œâ”€â”€ Cannot use with heavy armor
â”‚   â””â”€â”€ Once per round
â”‚
â”œâ”€â”€ Parry Action
â”‚   â”œâ”€â”€ DEX vs attack roll +2 (harder than dodge)
â”‚   â”œâ”€â”€ Requires melee weapon
â”‚   â”œâ”€â”€ Deflects attack and counter-attacks on success
â”‚   â”œâ”€â”€ Consumes reaction
â”‚   â””â”€â”€ Once per round
â”‚
â”œâ”€â”€ Reaction System
â”‚   â”œâ”€â”€ ICombatant.HasReaction property
â”‚   â”œâ”€â”€ ICombatant.UseReaction() method
â”‚   â”œâ”€â”€ ICombatant.ResetReaction() method
â”‚   â””â”€â”€ Reset at turn start
â”‚
â””â”€â”€ Configuration (defense-actions.json)
    â”œâ”€â”€ Block settings
    â”œâ”€â”€ Dodge settings
    â””â”€â”€ Parry settings
```

---

## 3. Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEFENSE ACTION ARCHITECTURE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      Combat System         â”‚
                      â”‚   (AttackService, AI)      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ OnAttackIncoming
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   IDefenseActionService    â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + CanBlock(target): bool  â”‚
                      â”‚ + CanDodge(target): bool  â”‚
                      â”‚ + CanParry(target): bool  â”‚
                      â”‚ + UseBlock(target): resultâ”‚
                      â”‚ + UseDodge(target): resultâ”‚
                      â”‚ + UseParry(target): resultâ”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚    DefenseActionService    â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ - CheckReactionAvailable  â”‚
                      â”‚ - ConsumeReaction         â”‚
                      â”‚ - RollDefense             â”‚
                      â”‚ - CalculateDamageReductionâ”‚
                      â”‚ - TriggerCounterAttack    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


     BLOCK                    DODGE                    PARRY
     â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   ğŸ›¡    â”‚              â”‚   ğŸ’¨    â”‚              â”‚   âš”ğŸ›¡   â”‚
     â”‚  BLOCK  â”‚              â”‚  DODGE  â”‚              â”‚  PARRY  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     
     Effect:                  Effect:                  Effect:
     Reduce damage by         Chance to avoid          Deflect attack
     50% (+ shield)           attack entirely          and counter
     
     Requires:                Requires:                Requires:
     Shield equipped          DEX check                Melee weapon
     Action or Reaction       Reaction                 Reaction + DEX
     
     Cooldown: None           Cooldown: 1/round        Cooldown: 1/round
```

---

## 4. DefenseActionType Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/DefenseActionType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of defensive combat actions.
/// </summary>
public enum DefenseActionType
{
    /// <summary>Block incoming damage with a shield.</summary>
    Block,

    /// <summary>Attempt to dodge an attack entirely.</summary>
    Dodge,

    /// <summary>Deflect an attack and counter-attack.</summary>
    Parry
}
```

---

## 5. Defense Action Results

**File:** `src/Core/RuneAndRust.Application/DTOs/DefenseActionResults.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of a block action.
/// </summary>
public record BlockResult
{
    public bool IsSuccess { get; init; }
    public int FinalDamage { get; init; }
    public int DamagePrevented { get; init; }
    public int ShieldBonus { get; init; }
    public string? FailureReason { get; init; }

    public static BlockResult Success(int finalDamage, int prevented, int shieldBonus)
        => new() { IsSuccess = true, FinalDamage = finalDamage, DamagePrevented = prevented, ShieldBonus = shieldBonus };

    public static BlockResult Failed(string reason)
        => new() { IsSuccess = false, FailureReason = reason };
}

/// <summary>
/// Result of a dodge action.
/// </summary>
public record DodgeResult
{
    public bool IsSuccess { get; init; }
    public bool AvoidedAttack { get; init; }
    public int DodgeRoll { get; init; }
    public int AttackRoll { get; init; }
    public string? FailureReason { get; init; }

    public static DodgeResult Success(int dodgeRoll, int attackRoll)
        => new() { IsSuccess = true, AvoidedAttack = true, DodgeRoll = dodgeRoll, AttackRoll = attackRoll };

    public static DodgeResult Failure(int dodgeRoll, int attackRoll)
        => new() { IsSuccess = true, AvoidedAttack = false, DodgeRoll = dodgeRoll, AttackRoll = attackRoll };

    public static DodgeResult NotAllowed(string reason)
        => new() { IsSuccess = false, FailureReason = reason };
}

/// <summary>
/// Result of a parry action.
/// </summary>
public record ParryResult
{
    public bool IsSuccess { get; init; }
    public bool Deflected { get; init; }
    public int ParryRoll { get; init; }
    public int DC { get; init; }
    public AttackResult? CounterAttack { get; init; }
    public string? FailureReason { get; init; }

    public static ParryResult SuccessWithCounter(int parryRoll, int dc, AttackResult counter)
        => new() { IsSuccess = true, Deflected = true, ParryRoll = parryRoll, DC = dc, CounterAttack = counter };

    public static ParryResult Failure(int parryRoll, int dc)
        => new() { IsSuccess = true, Deflected = false, ParryRoll = parryRoll, DC = dc };

    public static ParryResult NotAllowed(string reason)
        => new() { IsSuccess = false, FailureReason = reason };
}
```

---

## 6. ICombatant Reaction Extensions

**Updates to:** `src/Core/RuneAndRust.Domain/Interfaces/ICombatant.cs`

```csharp
namespace RuneAndRust.Domain.Interfaces;

public interface ICombatant
{
    // ... existing members ...

    /// <summary>Gets whether this combatant has their reaction available.</summary>
    bool HasReaction { get; }

    /// <summary>Consumes the combatant's reaction.</summary>
    void UseReaction();

    /// <summary>Resets the combatant's reaction to available.</summary>
    void ResetReaction();
}
```

---

## 7. IDefenseActionService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IDefenseActionService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for defensive combat actions.
/// </summary>
public interface IDefenseActionService
{
    /// <summary>Checks if target can use block.</summary>
    /// <param name="target">The combatant to check.</param>
    /// <returns>True if target can block.</returns>
    bool CanBlock(ICombatant target);

    /// <summary>Checks if target can use dodge.</summary>
    /// <param name="target">The combatant to check.</param>
    /// <returns>True if target can dodge.</returns>
    bool CanDodge(ICombatant target);

    /// <summary>Checks if target can use parry.</summary>
    /// <param name="target">The combatant to check.</param>
    /// <returns>True if target can parry.</returns>
    bool CanParry(ICombatant target);

    /// <summary>Uses block against incoming damage.</summary>
    /// <param name="target">The target using block.</param>
    /// <param name="incomingDamage">The damage to reduce.</param>
    /// <returns>Result with reduced damage.</returns>
    BlockResult UseBlock(ICombatant target, int incomingDamage);

    /// <summary>Attempts to dodge an incoming attack.</summary>
    /// <param name="target">The target attempting dodge.</param>
    /// <param name="attackRoll">The attacker's roll.</param>
    /// <returns>Result indicating success/failure.</returns>
    DodgeResult UseDodge(ICombatant target, int attackRoll);

    /// <summary>Attempts to parry an incoming attack.</summary>
    /// <param name="target">The target attempting parry.</param>
    /// <param name="attacker">The attacking combatant.</param>
    /// <param name="attackRoll">The attacker's roll.</param>
    /// <returns>Result with counter-attack info.</returns>
    ParryResult UseParry(ICombatant target, ICombatant attacker, int attackRoll);

    /// <summary>Resets reaction availability at turn start.</summary>
    /// <param name="combatant">The combatant to reset.</param>
    void ResetReaction(ICombatant combatant);

    /// <summary>Checks if combatant has reaction available.</summary>
    /// <param name="combatant">The combatant to check.</param>
    /// <returns>True if reaction is available.</returns>
    bool HasReaction(ICombatant combatant);

    /// <summary>Gets available defense actions for a combatant.</summary>
    /// <param name="target">The combatant to check.</param>
    /// <returns>List of available defense action types.</returns>
    IReadOnlyList<DefenseActionType> GetAvailableDefenses(ICombatant target);
}
```

---

## 8. DefenseActionService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/DefenseActionService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class DefenseActionService : IDefenseActionService
{
    private readonly IDiceService _diceService;
    private readonly IEquipmentService _equipmentService;
    private readonly IAttackService _attackService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<DefenseActionService> _logger;

    // Configuration
    private const float BlockBaseReduction = 0.5f;
    private const int ParryDCBonus = 2;

    public DefenseActionService(
        IDiceService diceService,
        IEquipmentService equipmentService,
        IAttackService attackService,
        IEventBus eventBus,
        ILogger<DefenseActionService> logger)
    {
        _diceService = diceService;
        _equipmentService = equipmentService;
        _attackService = attackService;
        _eventBus = eventBus;
        _logger = logger;
    }

    public bool CanBlock(ICombatant target)
    {
        // Requires shield equipped
        var hasShield = _equipmentService.HasShieldEquipped(target);
        _logger.LogDebug("{Target} can block: {CanBlock} (shield: {HasShield})",
            target.Name, hasShield, hasShield);
        return hasShield;
    }

    public bool CanDodge(ICombatant target)
    {
        // Requires reaction available and no heavy armor
        var hasReaction = target.HasReaction;
        var hasHeavyArmor = _equipmentService.HasHeavyArmor(target);
        var canDodge = hasReaction && !hasHeavyArmor;

        _logger.LogDebug("{Target} can dodge: {CanDodge} (reaction: {Reaction}, heavy: {Heavy})",
            target.Name, canDodge, hasReaction, hasHeavyArmor);
        return canDodge;
    }

    public bool CanParry(ICombatant target)
    {
        // Requires reaction available and melee weapon
        var hasReaction = target.HasReaction;
        var hasMelee = _equipmentService.HasMeleeWeapon(target);
        var canParry = hasReaction && hasMelee;

        _logger.LogDebug("{Target} can parry: {CanParry} (reaction: {Reaction}, melee: {Melee})",
            target.Name, canParry, hasReaction, hasMelee);
        return canParry;
    }

    public BlockResult UseBlock(ICombatant target, int incomingDamage)
    {
        if (!CanBlock(target))
        {
            _logger.LogWarning("{Target} cannot block without a shield", target.Name);
            return BlockResult.Failed("Cannot block without a shield");
        }

        var shield = _equipmentService.GetEquippedShield(target);
        var shieldBonus = shield?.DefenseBonus ?? 0;

        // Calculate reduced damage: 50% base + shield bonus flat reduction
        var reducedByPercent = (int)(incomingDamage * BlockBaseReduction);
        var finalDamage = Math.Max(0, reducedByPercent - shieldBonus);
        var prevented = incomingDamage - finalDamage;

        _logger.LogInformation("{Target} blocked: {Incoming} â†’ {Final} damage ({Prevented} prevented, shield +{Shield})",
            target.Name, incomingDamage, finalDamage, prevented, shieldBonus);

        _eventBus.Publish(new BlockedEvent(target.Id, incomingDamage, finalDamage, prevented));

        return BlockResult.Success(finalDamage, prevented, shieldBonus);
    }

    public DodgeResult UseDodge(ICombatant target, int attackRoll)
    {
        if (!CanDodge(target))
        {
            var reason = !target.HasReaction ? "No reaction available" : "Cannot dodge in heavy armor";
            _logger.LogWarning("{Target} cannot dodge: {Reason}", target.Name, reason);
            return DodgeResult.NotAllowed(reason);
        }

        // Consume reaction
        target.UseReaction();

        // Roll DEX + proficiency vs attack roll
        var dexMod = target.GetModifier("dexterity");
        var dodgeRoll = _diceService.Roll("1d20") + dexMod;
        var success = dodgeRoll >= attackRoll;

        _logger.LogInformation("{Target} dodge: rolled {Roll} (1d20+{Dex}) vs {Attack} - {Result}",
            target.Name, dodgeRoll, dexMod, attackRoll, success ? "SUCCESS" : "FAILED");

        _eventBus.Publish(new DodgeAttemptedEvent(target.Id, dodgeRoll, attackRoll, success));

        return success
            ? DodgeResult.Success(dodgeRoll, attackRoll)
            : DodgeResult.Failure(dodgeRoll, attackRoll);
    }

    public ParryResult UseParry(ICombatant target, ICombatant attacker, int attackRoll)
    {
        if (!CanParry(target))
        {
            var reason = !target.HasReaction ? "No reaction available" : "Requires melee weapon";
            _logger.LogWarning("{Target} cannot parry: {Reason}", target.Name, reason);
            return ParryResult.NotAllowed(reason);
        }

        // Consume reaction
        target.UseReaction();

        // Roll DEX vs attack roll + DC bonus (harder than dodge)
        var dexMod = target.GetModifier("dexterity");
        var parryRoll = _diceService.Roll("1d20") + dexMod;
        var parryDC = attackRoll + ParryDCBonus;
        var success = parryRoll >= parryDC;

        if (success)
        {
            // Counter-attack!
            var counterAttack = _attackService.MakeAttack(target, attacker);

            _logger.LogInformation("{Target} parried and counter-attacked {Attacker}! Rolled {Roll} vs DC {DC}",
                target.Name, attacker.Name, parryRoll, parryDC);

            _eventBus.Publish(new ParrySuccessEvent(target.Id, attacker.Id, parryRoll, parryDC, counterAttack.Damage));

            return ParryResult.SuccessWithCounter(parryRoll, parryDC, counterAttack);
        }

        _logger.LogInformation("{Target} failed to parry: rolled {Roll} vs DC {DC}",
            target.Name, parryRoll, parryDC);

        _eventBus.Publish(new ParryFailedEvent(target.Id, parryRoll, parryDC));

        return ParryResult.Failure(parryRoll, parryDC);
    }

    public void ResetReaction(ICombatant combatant)
    {
        combatant.ResetReaction();
        _logger.LogDebug("{Combatant} reaction reset", combatant.Name);
    }

    public bool HasReaction(ICombatant combatant)
    {
        return combatant.HasReaction;
    }

    public IReadOnlyList<DefenseActionType> GetAvailableDefenses(ICombatant target)
    {
        var available = new List<DefenseActionType>();

        if (CanBlock(target))
            available.Add(DefenseActionType.Block);
        if (CanDodge(target))
            available.Add(DefenseActionType.Dodge);
        if (CanParry(target))
            available.Add(DefenseActionType.Parry);

        return available;
    }
}
```

---

## 9. Defense Action Events

**File:** `src/Core/RuneAndRust.Application/Events/DefenseActionEvents.cs`

```csharp
namespace RuneAndRust.Application.Events;

/// <summary>Published when a combatant blocks an attack.</summary>
public record BlockedEvent(
    Guid DefenderId,
    int IncomingDamage,
    int FinalDamage,
    int DamagePrevented);

/// <summary>Published when a combatant attempts to dodge.</summary>
public record DodgeAttemptedEvent(
    Guid DefenderId,
    int DodgeRoll,
    int AttackRoll,
    bool Success);

/// <summary>Published when a parry succeeds.</summary>
public record ParrySuccessEvent(
    Guid DefenderId,
    Guid AttackerId,
    int ParryRoll,
    int DC,
    int CounterDamage);

/// <summary>Published when a parry fails.</summary>
public record ParryFailedEvent(
    Guid DefenderId,
    int ParryRoll,
    int DC);

/// <summary>Published when a combatant's reaction is consumed.</summary>
public record ReactionUsedEvent(
    Guid CombatantId,
    DefenseActionType ActionType);
```

---

## 10. Configuration File

**File:** `config/defense-actions.json`

```json
{
  "$schema": "./schemas/defense-actions.schema.json",
  "defenseActions": {
    "block": {
      "name": "Block",
      "description": "Reduce incoming damage by 50% plus shield bonus",
      "requiresShield": true,
      "consumesReaction": false,
      "baseReduction": 0.5,
      "cooldown": 0,
      "icon": "icons/actions/block.png"
    },
    "dodge": {
      "name": "Dodge",
      "description": "Attempt to completely avoid an attack",
      "requiresReaction": true,
      "blockedByHeavyArmor": true,
      "rollStat": "dexterity",
      "cooldownPerRound": 1,
      "icon": "icons/actions/dodge.png"
    },
    "parry": {
      "name": "Parry",
      "description": "Deflect an attack and counter-attack",
      "requiresMeleeWeapon": true,
      "requiresReaction": true,
      "rollStat": "dexterity",
      "dcBonus": 2,
      "triggersCounterAttack": true,
      "cooldownPerRound": 1,
      "icon": "icons/actions/parry.png"
    }
  }
}
```

---

## 11. Defense Action Flow Visualization

```
BLOCK FLOW:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Incoming Attack (20 damage)
              â”‚
              â–¼
  CanBlock(target)? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Check shield equipped
              â”‚                                   â”‚
              â–¼                                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Shield: YES   â”‚              â”‚ Shield: NO            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                  â”‚
              â–¼                                  â–¼
      UseBlock(20 damage)              BlockResult.Failed
              â”‚
              â”œâ”€â”€ Base reduction: 50% â†’ 10 remaining
              â”œâ”€â”€ Shield bonus: 3 â†’ 7 remaining
              â””â”€â”€ Final: 7 damage
              â”‚
              â–¼
      BlockResult.Success(7, 13, 3)


DODGE FLOW:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Incoming Attack (Roll: 18)
              â”‚
              â–¼
  CanDodge(target)? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Check reaction + armor
              â”‚                                   â”‚
              â–¼                                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Has Reaction  â”‚              â”‚ No Reaction / Heavy   â”‚
      â”‚ + Light Armor â”‚              â”‚ Armor Equipped        â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                  â”‚
              â–¼                                  â–¼
      target.UseReaction()             DodgeResult.NotAllowed
              â”‚
              â–¼
      Roll 1d20 + DEX mod = 15
              â”‚
              â”œâ”€â”€ 15 >= 18? NO
              â”‚
              â–¼
      DodgeResult.Failure(15, 18)


PARRY FLOW:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Incoming Attack (Roll: 16)
              â”‚
              â–¼
  CanParry(target)? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Check reaction + melee
              â”‚                                   â”‚
              â–¼                                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Has Reaction  â”‚              â”‚ No Reaction / No      â”‚
      â”‚ + Melee Wpn   â”‚              â”‚ Melee Weapon          â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                  â”‚
              â–¼                                  â–¼
      target.UseReaction()             ParryResult.NotAllowed
              â”‚
              â–¼
      Roll 1d20 + DEX mod = 20
      DC = 16 + 2 = 18
              â”‚
              â”œâ”€â”€ 20 >= 18? YES
              â”‚
              â–¼
      Counter-Attack! â†’ MakeAttack(target, attacker)
              â”‚
              â–¼
      ParryResult.SuccessWithCounter(20, 18, counterAttack)
```

---

## 12. Unit Testing Requirements (~15 tests)

| Feature | Tests |
|---------|-------|
| CanBlock returns true with shield | 1 |
| CanBlock returns false without shield | 1 |
| UseBlock reduces damage by 50% | 1 |
| UseBlock adds shield bonus | 1 |
| UseBlock fails without shield | 1 |
| CanDodge returns true with reaction | 1 |
| CanDodge returns false in heavy armor | 1 |
| UseDodge succeeds when roll >= attack | 1 |
| UseDodge fails when roll < attack | 1 |
| UseDodge consumes reaction | 1 |
| CanParry returns true with melee weapon | 1 |
| UseParry triggers counter on success | 1 |
| UseParry has higher DC than dodge | 1 |
| UseParry consumes reaction | 1 |
| ResetReaction restores reaction | 1 |

---

## 13. Acceptance Criteria

- [ ] Block reduces damage by 50% + shield bonus
- [ ] Block requires shield equipped
- [ ] Block can be used without reaction (as action)
- [ ] Dodge rolls DEX vs attack roll
- [ ] Successful dodge avoids attack entirely
- [ ] Dodge consumes reaction
- [ ] Dodge blocked by heavy armor
- [ ] Parry rolls DEX vs attack roll + 2
- [ ] Successful parry triggers counter-attack
- [ ] Parry requires melee weapon
- [ ] Parry consumes reaction
- [ ] Reaction resets on turn start
- [ ] Cannot use dodge/parry without reaction
- [ ] GetAvailableDefenses returns correct list
- [ ] Events published for all defense actions
- [ ] ~15 unit tests pass

---

## 14. Dependencies

| From | Required |
|------|----------|
| Domain | `ICombatant`, `DefenseActionType` |
| Application | `IDiceService`, `IEquipmentService`, `IAttackService`, `IEventBus` |
| Prior versions | Stats system, equipment system |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
