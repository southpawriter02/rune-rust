# v0.16.4c Design Specification: Biome Loot Modifiers

## Document Information

| Field            | Value                                                                |
| ---------------- | -------------------------------------------------------------------- |
| Version          | v0.16.4c                                                             |
| Parent Version   | v0.16.4 - Container Loot Generation                                  |
| Epic             | v0.16.x - Advanced Loot & Proficiency Systems                        |
| Status           | Draft                                                                |
| Created          | 2025-01-27                                                           |
| Scope Breakdown  | [v0.16.4-scope-breakdown.md](v0.16.4-scope-breakdown.md)             |
| Previous Version | [v0.16.4b-design-specification.md](v0.16.4b-design-specification.md) |

---

## 1. Executive Summary

### 1.1 Overview

Version 0.16.4c introduces the **Biome Loot Modifiers** system, which applies location-specific adjustments to container loot generation. This sub-phase creates the `BiomeLootModifiers` value object and the `biome-loot-modifiers.json` configuration file that defines modifiers for each biome/location type.

### 1.2 Key Deliverables

| Category             | Count | Artifact                           |
| -------------------- | ----- | ---------------------------------- |
| Domain Value Objects | 1     | `BiomeLootModifiers`               |
| Configuration Files  | 1     | `biome-loot-modifiers.json`        |
| JSON Schemas         | 1     | `biome-loot-modifiers.schema.json` |
| Unit Tests           | ~2    | Modifier application tests         |

### 1.3 Success Metrics

- Gold amounts correctly scaled by biome multiplier
- Quality tier bonuses applied correctly
- Drop rate modifiers affect item counts
- Rare item chance bonuses function properly

---

## 2. Feature Overview

### 2.1 Feature Tree

```
v0.16.4c: Biome Loot Modifiers
├── BiomeLootModifiers Value Object
│   ├── BiomeId identifier
│   ├── GoldMultiplier (1.0 = normal)
│   ├── DropRateMultiplier (1.0 = normal)
│   ├── QualityBonus (+0 to +2 tiers)
│   └── RareChanceBonus (+0% to +25%)
├── Modifier Application Logic
│   ├── ApplyToGold(baseAmount) → scaledAmount
│   ├── ApplyToItemCount(baseCount) → scaledCount
│   ├── ApplyToTier(baseTier) → adjustedTier
│   └── GetRareChanceBonus() → bonusPercentage
└── Configuration
    ├── biome-loot-modifiers.json
    └── biome-loot-modifiers.schema.json
```

### 2.2 Scope Boundaries

**In Scope:**

- `BiomeLootModifiers` value object with all modifier properties
- Modifier application methods
- `biome-loot-modifiers.json` configuration for 5 biomes
- `biome-loot-modifiers.schema.json` validation schema
- Unit tests for modifier application

**Out of Scope:**

- Loot generation service integration (v0.16.4d)
- Biome detection/context (assumes biome ID is known)
- Dynamic modifier stacking

---

## 3. Architecture Diagrams

### 3.1 Component Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    CONFIGURATION LAYER                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              biome-loot-modifiers.json                     │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐             │  │
│  │  │ The Roots  │ │ Muspelheim │ │  Alfheim   │ ...         │  │
│  │  │ Gold: 1.0  │ │ Gold: 1.2  │ │ Gold: 1.5  │             │  │
│  │  │ Drop: 1.0  │ │ Drop: 0.9  │ │ Drop: 0.7  │             │  │
│  │  │ Tier: +0   │ │ Tier: +0   │ │ Tier: +1   │             │  │
│  │  │ Rare: +0%  │ │ Rare: +5%  │ │ Rare: +15% │             │  │
│  │  └────────────┘ └────────────┘ └────────────┘             │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ Loaded by (future v0.16.4d)
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  BiomeLootModifiers                        │  │
│  │                  (Value Object)                            │  │
│  │                                                            │  │
│  │  • string BiomeId                                          │  │
│  │  • decimal GoldMultiplier                                  │  │
│  │  • decimal DropRateMultiplier                              │  │
│  │  • int QualityBonus                                        │  │
│  │  • int RareChanceBonusPercent                              │  │
│  │                                                            │  │
│  │  + ApplyToGold(int base) → int                             │  │
│  │  + ApplyToItemCount(int base, int max) → int               │  │
│  │  + ApplyToTier(int base, int max) → int                    │  │
│  │  + GetRareChanceBonus() → decimal                          │  │
│  │  + static Default → BiomeLootModifiers                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Modifier Application Flow

```
┌──────────────────┐     ┌───────────────────┐     ┌─────────────────────┐
│ ContainerType    │     │ BiomeLootModifiers│     │ Final Loot Values   │
│ Definition       │────▶│                   │────▶│                     │
│                  │     │ Apply modifiers   │     │                     │
│ • Items: 2-4     │     │ to base values    │     │ • Items: 1-3 (×0.7) │
│ • Tier: 1-2      │     │                   │     │ • Tier: 2-3 (+1)    │
│ • Gold: 25-75    │     │ Alfheim:          │     │ • Gold: 37-112 (×1.5)│
│                  │     │ • Gold: 1.5       │     │ • Rare: +15%        │
└──────────────────┘     │ • Drop: 0.7       │     └─────────────────────┘
                         │ • Tier: +1        │
                         │ • Rare: +15%      │
                         └───────────────────┘
```

### 3.3 Decision Tree: Apply Quality Bonus

```
                    ┌─────────────────┐
                    │ ApplyToTier()   │
                    │ baseTier, maxTier│
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ adjustedTier =  │
                    │ baseTier +      │
                    │ QualityBonus    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ adjustedTier    │
                    │ > maxTier?      │
                    └────────┬────────┘
                      Yes    │    No
                    ┌────────┴────────┐
                    ▼                 ▼
           ┌────────────────┐ ┌────────────────┐
           │ Return maxTier │ │ Return         │
           │ (capped)       │ │ adjustedTier   │
           └────────────────┘ └────────────────┘
```

---

## 4. Feature Section: BiomeLootModifiers Value Object

### 4.1 Purpose

The `BiomeLootModifiers` value object encapsulates all loot-affecting modifiers for a specific biome or location type.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/BiomeLootModifiers.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents biome-specific modifiers that affect container loot generation.
/// </summary>
/// <remarks>
/// Modifiers are applied during loot generation to scale gold amounts,
/// adjust item counts, shift quality tiers, and modify rare item chances.
/// All multipliers use 1.0 as the baseline (no modification).
/// </remarks>
/// <param name="BiomeId">Unique identifier for the biome.</param>
/// <param name="GoldMultiplier">Multiplier for gold amounts (1.0 = normal).</param>
/// <param name="DropRateMultiplier">Multiplier for item counts (1.0 = normal).</param>
/// <param name="QualityBonus">Additive bonus to quality tier (0 = no bonus).</param>
/// <param name="RareChanceBonusPercent">Additive bonus to rare chance as percentage (0-100).</param>
public readonly record struct BiomeLootModifiers(
    string BiomeId,
    decimal GoldMultiplier,
    decimal DropRateMultiplier,
    int QualityBonus,
    int RareChanceBonusPercent)
{
    /// <summary>
    /// Gets the default modifiers with no adjustments.
    /// </summary>
    /// <remarks>
    /// Used when no biome-specific modifiers are defined or as a fallback.
    /// All values represent no modification to base loot values.
    /// </remarks>
    public static BiomeLootModifiers Default { get; } = new(
        BiomeId: "default",
        GoldMultiplier: 1.0m,
        DropRateMultiplier: 1.0m,
        QualityBonus: 0,
        RareChanceBonusPercent: 0);

    /// <summary>
    /// Gets whether this modifier increases gold amounts.
    /// </summary>
    public bool IncreasesGold => GoldMultiplier > 1.0m;

    /// <summary>
    /// Gets whether this modifier reduces drop rates.
    /// </summary>
    public bool ReducesDropRate => DropRateMultiplier < 1.0m;

    /// <summary>
    /// Gets whether this modifier improves item quality.
    /// </summary>
    public bool ImprovesQuality => QualityBonus > 0;

    /// <summary>
    /// Gets whether this modifier increases rare item chances.
    /// </summary>
    public bool IncreasesRareChance => RareChanceBonusPercent > 0;

    /// <summary>
    /// Applies the gold multiplier to a base gold amount.
    /// </summary>
    /// <param name="baseGold">The base gold amount before modification.</param>
    /// <returns>The scaled gold amount, rounded down. Minimum 0.</returns>
    public int ApplyToGold(int baseGold)
    {
        if (baseGold <= 0)
        {
            return 0;
        }

        var scaled = (int)Math.Floor(baseGold * GoldMultiplier);
        return Math.Max(0, scaled);
    }

    /// <summary>
    /// Applies the drop rate multiplier to calculate adjusted item count.
    /// </summary>
    /// <param name="baseCount">The base item count before modification.</param>
    /// <param name="minCount">The minimum allowed item count.</param>
    /// <returns>The adjusted item count, respecting minimum. Floored.</returns>
    public int ApplyToItemCount(int baseCount, int minCount = 0)
    {
        if (baseCount <= 0)
        {
            return minCount;
        }

        var scaled = (int)Math.Floor(baseCount * DropRateMultiplier);
        return Math.Max(minCount, scaled);
    }

    /// <summary>
    /// Applies the quality bonus to a base tier.
    /// </summary>
    /// <param name="baseTier">The base quality tier (0-4).</param>
    /// <param name="maxTier">The maximum allowed tier (default 4).</param>
    /// <returns>The adjusted tier, capped at maxTier.</returns>
    public int ApplyToTier(int baseTier, int maxTier = 4)
    {
        var adjusted = baseTier + QualityBonus;
        return Math.Min(adjusted, maxTier);
    }

    /// <summary>
    /// Gets the rare chance bonus as a decimal multiplier.
    /// </summary>
    /// <returns>Bonus percentage as decimal (e.g., 15 returns 0.15).</returns>
    public decimal GetRareChanceBonus() => RareChanceBonusPercent / 100m;

    /// <summary>
    /// Creates a new BiomeLootModifiers instance with validation.
    /// </summary>
    /// <exception cref="ArgumentException">Thrown when biomeId is null or whitespace.</exception>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when multipliers are negative or bonus values invalid.</exception>
    public static BiomeLootModifiers Create(
        string biomeId,
        decimal goldMultiplier,
        decimal dropRateMultiplier,
        int qualityBonus,
        int rareChanceBonusPercent)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(biomeId, nameof(biomeId));
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(goldMultiplier, nameof(goldMultiplier));
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(dropRateMultiplier, nameof(dropRateMultiplier));
        ArgumentOutOfRangeException.ThrowIfNegative(qualityBonus, nameof(qualityBonus));
        ArgumentOutOfRangeException.ThrowIfGreaterThan(qualityBonus, 4, nameof(qualityBonus));
        ArgumentOutOfRangeException.ThrowIfNegative(rareChanceBonusPercent, nameof(rareChanceBonusPercent));
        ArgumentOutOfRangeException.ThrowIfGreaterThan(rareChanceBonusPercent, 100, nameof(rareChanceBonusPercent));

        return new BiomeLootModifiers(
            biomeId.ToLowerInvariant(),
            goldMultiplier,
            dropRateMultiplier,
            qualityBonus,
            rareChanceBonusPercent);
    }

    /// <inheritdoc />
    public override string ToString() =>
        $"[{BiomeId}] Gold: ×{GoldMultiplier:F1}, Drop: ×{DropRateMultiplier:F1}, " +
        $"Tier: +{QualityBonus}, Rare: +{RareChanceBonusPercent}%";
}
```

### 4.3 Design Decisions

| Decision                  | Rationale                                             |
| ------------------------- | ----------------------------------------------------- |
| `readonly record struct`  | Immutable value semantics, efficient memory usage     |
| `decimal` for multipliers | Precision for fractional multipliers (1.2, 0.9, etc.) |
| `int` for bonuses         | Simple additive bonuses, no fractional tiers          |
| Static `Default` property | Reusable fallback when no biome modifiers defined     |
| Normalized biome ID       | Case-insensitive matching for biome lookups           |
| Clamped outputs           | Prevents negative gold, respects tier caps            |
| Floor rounding            | Consistent rounding behavior for scaled values        |

---

## 5. Biome Specifications

### 5.1 Defined Biomes

| Biome      | Gold Mult | Drop Rate | Quality | Rare Chance | Design Intent                       |
| ---------- | --------- | --------- | ------- | ----------- | ----------------------------------- |
| the-roots  | 1.0       | 1.0       | +0      | +0%         | Baseline area, no modifiers         |
| muspelheim | 1.2       | 0.9       | +0      | +5%         | Higher risk, more gold, fewer items |
| alfheim    | 1.5       | 0.7       | +1      | +15%        | Premium loot, reduced quantity      |
| jotunheim  | 2.0       | 0.8       | +1      | +20%        | High reward, slightly fewer items   |
| boss-room  | 1.5       | 1.0       | +1      | +25%        | Boss encounters, premium drops      |

### 5.2 Modifier Effects Examples

**Example: MediumChest in Alfheim**

| Property | Base Value | Modifier | Result      |
| -------- | ---------- | -------- | ----------- |
| Gold     | 50         | ×1.5     | 75          |
| Items    | 3          | ×0.7     | 2 (floored) |
| Tier     | 1          | +1       | 2           |
| Rare     | Base 5%    | +15%     | 20% chance  |

---

## 6. Data Model Changes

### 6.1 New Value Objects

| Value Object         | File Path                                                        | Purpose                  |
| -------------------- | ---------------------------------------------------------------- | ------------------------ |
| `BiomeLootModifiers` | `src/Core/RuneAndRust.Domain/ValueObjects/BiomeLootModifiers.cs` | Biome-specific loot mods |

---

## 7. Configuration File Schemas

### 7.1 biome-loot-modifiers.json

**File:** `config/biome-loot-modifiers.json`

```json
{
    "$schema": "./schemas/biome-loot-modifiers.schema.json",
    "biomeModifiers": [
        {
            "biomeId": "the-roots",
            "goldMultiplier": 1.0,
            "dropRateMultiplier": 1.0,
            "qualityBonus": 0,
            "rareChanceBonusPercent": 0
        },
        {
            "biomeId": "muspelheim",
            "goldMultiplier": 1.2,
            "dropRateMultiplier": 0.9,
            "qualityBonus": 0,
            "rareChanceBonusPercent": 5
        },
        {
            "biomeId": "alfheim",
            "goldMultiplier": 1.5,
            "dropRateMultiplier": 0.7,
            "qualityBonus": 1,
            "rareChanceBonusPercent": 15
        },
        {
            "biomeId": "jotunheim",
            "goldMultiplier": 2.0,
            "dropRateMultiplier": 0.8,
            "qualityBonus": 1,
            "rareChanceBonusPercent": 20
        },
        {
            "biomeId": "boss-room",
            "goldMultiplier": 1.5,
            "dropRateMultiplier": 1.0,
            "qualityBonus": 1,
            "rareChanceBonusPercent": 25
        }
    ]
}
```

### 7.2 biome-loot-modifiers.schema.json

**File:** `config/schemas/biome-loot-modifiers.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "biome-loot-modifiers.schema.json",
    "title": "Biome Loot Modifiers Configuration",
    "description": "Defines biome-specific modifiers for container loot generation.",
    "type": "object",
    "required": ["biomeModifiers"],
    "properties": {
        "biomeModifiers": {
            "type": "array",
            "description": "Array of biome modifier definitions.",
            "items": {
                "$ref": "#/$defs/biomeLootModifier"
            },
            "minItems": 1
        }
    },
    "$defs": {
        "biomeLootModifier": {
            "type": "object",
            "required": [
                "biomeId",
                "goldMultiplier",
                "dropRateMultiplier",
                "qualityBonus",
                "rareChanceBonusPercent"
            ],
            "properties": {
                "biomeId": {
                    "type": "string",
                    "description": "Unique identifier for the biome (kebab-case).",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "goldMultiplier": {
                    "type": "number",
                    "description": "Multiplier for gold amounts (1.0 = no change).",
                    "minimum": 0.1,
                    "maximum": 10.0
                },
                "dropRateMultiplier": {
                    "type": "number",
                    "description": "Multiplier for item counts (1.0 = no change).",
                    "minimum": 0.1,
                    "maximum": 10.0
                },
                "qualityBonus": {
                    "type": "integer",
                    "description": "Additive bonus to quality tier.",
                    "minimum": 0,
                    "maximum": 4
                },
                "rareChanceBonusPercent": {
                    "type": "integer",
                    "description": "Additive bonus to rare chance (0-100%).",
                    "minimum": 0,
                    "maximum": 100
                }
            }
        }
    }
}
```

---

## 8. Logging Specifications

| Component             | Level       | Event                                                   |
| --------------------- | ----------- | ------------------------------------------------------- |
| Configuration Loading | Information | "Loaded {Count} biome loot modifier definitions"        |
| Configuration Loading | Debug       | "Biome {BiomeId}: Gold×{Mult}, Drop×{Rate}"             |
| Modifier Application  | Debug       | "Applied {BiomeId} modifiers: Gold {Base}→{Result}"     |
| Modifier Application  | Debug       | "Applied tier bonus: {Base}+{Bonus}={Result}"           |
| Modifier Lookup       | Warning     | "No modifiers found for biome {BiomeId}, using default" |

---

## 9. Unit Testing Requirements

### 9.1 Test Summary

| Test Class                | Test Count | Focus Area                 |
| ------------------------- | ---------- | -------------------------- |
| `BiomeLootModifiersTests` | ~2         | Modifier application logic |

### 9.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/BiomeLootModifiersTests.cs`

```csharp
using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.UnitTests.ValueObjects;

[TestFixture]
public class BiomeLootModifiersTests
{
    [Test]
    public void ApplyToGold_WithMultiplier_ScalesCorrectly()
    {
        // Arrange
        var modifiers = BiomeLootModifiers.Create(
            biomeId: "alfheim",
            goldMultiplier: 1.5m,
            dropRateMultiplier: 1.0m,
            qualityBonus: 0,
            rareChanceBonusPercent: 0);

        // Act
        var result = modifiers.ApplyToGold(100);

        // Assert
        result.Should().Be(150);
    }

    [Test]
    public void ApplyToTier_WithBonus_CapsAtMaxTier()
    {
        // Arrange
        var modifiers = BiomeLootModifiers.Create(
            biomeId: "jotunheim",
            goldMultiplier: 1.0m,
            dropRateMultiplier: 1.0m,
            qualityBonus: 2,
            rareChanceBonusPercent: 0);

        // Act
        var result = modifiers.ApplyToTier(baseTier: 3, maxTier: 4);

        // Assert
        result.Should().Be(4); // 3 + 2 = 5, capped at 4
    }

    [Test]
    public void ApplyToItemCount_WithReducedDropRate_FloorsResult()
    {
        // Arrange
        var modifiers = BiomeLootModifiers.Create(
            biomeId: "alfheim",
            goldMultiplier: 1.0m,
            dropRateMultiplier: 0.7m,
            qualityBonus: 0,
            rareChanceBonusPercent: 0);

        // Act
        var result = modifiers.ApplyToItemCount(baseCount: 5, minCount: 1);

        // Assert
        result.Should().Be(3); // 5 * 0.7 = 3.5 → 3
    }

    [Test]
    public void Default_ReturnsNoModification()
    {
        // Arrange
        var defaultMod = BiomeLootModifiers.Default;

        // Act & Assert
        defaultMod.ApplyToGold(100).Should().Be(100);
        defaultMod.ApplyToItemCount(5, 0).Should().Be(5);
        defaultMod.ApplyToTier(2, 4).Should().Be(2);
        defaultMod.GetRareChanceBonus().Should().Be(0m);
    }
}
```

---

## 10. Use Cases

### UC-001: Apply Biome Modifiers to Container Loot

| Field   | Value                                                                                                                                                                                                                     |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Actor   | Container Loot Service (future v0.16.4d)                                                                                                                                                                                  |
| Trigger | Container loot generation in a specific biome                                                                                                                                                                             |
| Flow    | 1. Get BiomeLootModifiers for current biome<br>2. Apply gold multiplier to base currency<br>3. Apply drop rate to item count<br>4. Apply quality bonus to tier selection<br>5. Add rare chance bonus to drop calculations |
| Outcome | Loot values adjusted according to biome                                                                                                                                                                                   |

### UC-002: Use Default Modifiers

| Field   | Value                                                                                        |
| ------- | -------------------------------------------------------------------------------------------- |
| Actor   | Container Loot Service (future v0.16.4d)                                                     |
| Trigger | Loot generation in unrecognized or default biome                                             |
| Flow    | 1. Attempt to find biome modifiers<br>2. No match found<br>3. Use BiomeLootModifiers.Default |
| Outcome | Loot generated with no modifications                                                         |

---

## 11. Deliverable Checklist

### 11.1 Domain Layer

- [ ] `BiomeLootModifiers` value object (`src/Core/RuneAndRust.Domain/ValueObjects/BiomeLootModifiers.cs`)

### 11.2 Configuration

- [ ] `biome-loot-modifiers.json` (`config/biome-loot-modifiers.json`)
- [ ] `biome-loot-modifiers.schema.json` (`config/schemas/biome-loot-modifiers.schema.json`)

### 11.3 Tests

- [ ] `BiomeLootModifiersTests` (`tests/RuneAndRust.Domain.UnitTests/ValueObjects/BiomeLootModifiersTests.cs`)

---

## 12. Acceptance Criteria

### 12.1 Functional Criteria

| ID    | Criterion                                 | Verification  |
| ----- | ----------------------------------------- | ------------- |
| AC-01 | Gold scaled by biome multiplier correctly | Unit test     |
| AC-02 | Quality bonus shifts tier correctly       | Unit test     |
| AC-03 | Drop rate multiplier adjusts item count   | Unit test     |
| AC-04 | Rare chance bonus returns correct decimal | Unit test     |
| AC-05 | Default modifiers apply no changes        | Unit test     |
| AC-06 | All 5 biomes defined in configuration     | Configuration |

### 12.2 Quality Criteria

| ID    | Criterion                                   | Verification      |
| ----- | ------------------------------------------- | ----------------- |
| QC-01 | All code has XML documentation              | Code inspection   |
| QC-02 | Configuration validates against JSON schema | Schema validation |
| QC-03 | ~2 unit tests pass                          | Test execution    |

---

## 13. Dependencies

### 13.1 Prerequisites

| Dependency | Description                           | Status   |
| ---------- | ------------------------------------- | -------- |
| v0.16.4a   | ContainerTypeDefinition (base values) | Complete |
| v0.16.0    | QualityTier enum (tier 0-4 scale)     | Complete |

### 13.2 Provides To

| Consumer | Description                            |
| -------- | -------------------------------------- |
| v0.16.4d | ContainerLootService applies modifiers |

---

## 14. Future Considerations

### 14.1 Deferred to v0.16.4d

- `IContainerLootService` integration
- Biome modifier lookup by room/location
- Full loot generation pipeline

### 14.2 Potential Future Enhancements

- Time-based modifiers (night bonuses)
- Weather-based modifiers (storm loot)
- Stacking modifiers (biome + event)
- Player reputation affecting modifiers
- Seasonal event modifiers
