> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.5](../v0.3.x/v0.3.5.md).

# Changelog: v0.3.5c - The Surveyor (Room Rendering)

**Release Date:** 2025-12-21
**Codename:** The Surveyor
**Status:** Complete

---

## Summary

Version 0.3.5c implements the `RoomRenderer` component, which displays a rich, formatted view of the current room in the exploration HUD Body panel. This replaces the raw text room description with a structured display showing room name with biome-themed coloring, description text, visible objects with color-coded formatting, enemy listings with health status, and available exits.

---

## New Features

### RoomRenderer (Terminal Layer)
A static helper class that renders the complete room view panel for the exploration HUD Body section.

**Key capabilities:**
- Biome-themed room name headers (Industrial=orange, Organic=green, Void=purple, Ruin=grey)
- Grey-wrapped room descriptions with markup escaping
- Color-coded object listings (containers in gold, locked items with indicator)
- Enemy listings with narrative health status (Healthy, Wounded, Bloodied, Critical, Dead)
- Exit directions in lowercase comma-separated format

### RoomViewHelper (Engine Layer)
A static helper class providing formatting utilities used by both GameService and RoomRenderer.

**Key methods:**
- `GetBiomeColor(BiomeType)` - Maps biome to Spectre.Console color name
- `FormatObjectName(name, isContainer, isLocked)` - Formats object with markup coloring
- `FormatEnemyName(name, currentHp, maxHp)` - Formats enemy with health status
- `GetNarrativeHealth(percent)` - Converts HP percentage to narrative descriptor

### ExplorationViewModel Extension
Four new properties added to support room rendering:

| Property | Type | Description |
|----------|------|-------------|
| `VisibleObjects` | `List<string>` | Pre-formatted object names with markup |
| `VisibleEnemies` | `List<string>` | Pre-formatted enemy names with health |
| `Exits` | `string` | Comma-separated lowercase exit directions |
| `BiomeColor` | `string` | Spectre.Console color name for biome theming |

---

## Visual Example

```
+--[orange1]Industrial Forge[/]----------------------+
|                                                     |
| [grey]The forge's ancient machinery lies dormant,  |
| pistons seized with centuries of rust. Faint       |
| heat still emanates from somewhere deep within.[/] |
|                                                     |
| -------------------------------------------------  |
|                                                     |
| [yellow]You see:[/]                                 |
|   [gold1]Iron Coffer[/] [grey](locked)[/]          |
|   [grey]Broken Anvil[/]                             |
|                                                     |
| -------------------------------------------------  |
|                                                     |
| [white]Exits:[/] [grey]north, east, down[/]         |
+-----------------------------------------------------+
```

---

## Color Coding Reference

### Entity Colors
| Entity Type | Color | Example |
|-------------|-------|---------|
| Containers | Gold | `[gold1]Rusty Chest[/]` |
| Locked containers | Gold + Grey | `[gold1]Locked Box[/] [grey](locked)[/]` |
| Generic objects | Grey | `[grey]Pile of Debris[/]` |
| Enemies | Red | `[red]Blight-Wolf[/] [grey](Wounded)[/]` |
| Exits | White + Grey | `[white]Exits:[/] [grey]north, east[/]` |

### Biome Colors
| BiomeType | Color | Header Example |
|-----------|-------|----------------|
| Ruin | grey | `[grey]Collapsed Atrium[/]` |
| Industrial | orange1 | `[orange1]Forge Chamber[/]` |
| Organic | green | `[green]Fungal Cavern[/]` |
| Void | purple | `[purple]Void Rift[/]` |

### Health Status Thresholds
| HP Percentage | Status |
|---------------|--------|
| > 75% | Healthy |
| 51-75% | Wounded |
| 26-50% | Bloodied |
| 1-25% | Critical |
| 0% | Dead |

---

## Files Created

| File | Layer | Purpose |
|------|-------|---------|
| `RuneAndRust.Terminal/Rendering/RoomRenderer.cs` | Terminal | Room view panel rendering |
| `RuneAndRust.Engine/Helpers/RoomViewHelper.cs` | Engine | Formatting utilities |
| `RuneAndRust.Tests/Terminal/RoomRendererTests.cs` | Tests | 33 unit tests |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Added VisibleObjects, VisibleEnemies, Exits, BiomeColor properties |
| `RuneAndRust.Engine/Services/GameService.cs` | Updated BuildExplorationViewModelAsync() to fetch objects and format room data |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Replaced raw description panel with RoomRenderer.Render() call |
| `RuneAndRust.Terminal/Program.cs` | Updated version to v0.3.5c |

---

## Test Coverage

### RoomRendererTests (33 tests)
| Test Category | Test Count | Description |
|---------------|------------|-------------|
| GetBiomeColor | 5 | BiomeType to color mapping |
| FormatObjectName | 5 | Object formatting with containers and locks |
| FormatEnemyName | 4 | Enemy formatting with health status |
| GetNarrativeHealth | 7 | HP percentage to narrative descriptor |
| BuildExitsSection | 3 | Exit formatting and empty state |
| BuildEntitySection | 4 | Object/enemy list rendering |
| BuildDescription | 2 | Description rendering with escaping |
| Render Integration | 3 | Full panel rendering |

---

## Implementation Details

### Architecture Decision: RoomViewHelper
The formatting logic was extracted to `RoomViewHelper` in the Engine layer to avoid circular dependencies. The Engine layer cannot reference the Terminal layer, so GameService uses RoomViewHelper directly while RoomRenderer delegates to it for consistency.

```
[GameService (Engine)]
       |
       +---> [RoomViewHelper.FormatObjectName()]
       +---> [RoomViewHelper.GetBiomeColor()]
                     |
[RoomRenderer (Terminal)]
       |
       +---> [RoomViewHelper.*] (delegates)
```

### Object Fetching
Objects are fetched via `IInteractionService.GetVisibleObjectsAsync()` which returns all `InteractableObject` entities in the current room. The objects are then formatted using `RoomViewHelper.FormatObjectName()` with container and lock detection.

### Enemy Visibility
During the Exploration phase, `VisibleEnemies` remains empty. Enemies are only spawned by `AmbushService` when entering rooms that trigger combat. Future versions may add room-based enemy presence tracking.

### Markup Escaping
All user-facing text (room names, descriptions, object names) is escaped using either `Markup.Escape()` in RoomRenderer or custom bracket escaping in RoomViewHelper to prevent Spectre.Console markup injection.

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Object Fetch | Trace | `"[HUD] Found {ObjectCount} visible objects in room"` |
| ViewModel Build | Debug | `"[HUD] Building exploration ViewModel for {Character} in {Room}"` |

---

## Dependencies

- `Spectre.Console` - Panel, Markup, Rows, Rule for room rendering
- `RuneAndRust.Core.Entities.InteractableObject` - Object data (Name, IsContainer, IsLocked)
- `RuneAndRust.Core.Enums.BiomeType` - Biome color mapping
- `RuneAndRust.Core.Interfaces.IInteractionService` - Object fetching

---

## Breaking Changes

None. The ExplorationViewModel record was extended with new properties, but all existing code continues to work.

---

## Known Limitations

1. **Enemies not shown during Exploration** - VisibleEnemies remains empty until combat is triggered
2. **No machinery detection** - Cyan coloring for machinery depends on future ObjectType categorization
3. **No NPC support yet** - Green coloring for NPCs awaits NPC entity implementation

---

## Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.5a | The Cartographer's Easel | ExplorationScreenRenderer foundation |
| v0.3.5b | The Cartographer | MinimapRenderer with Fog of War |
| v0.3.5c | The Surveyor | RoomRenderer with entity display |

---

## Next Steps (v0.3.5d Candidates)

1. **CommandBarRenderer** - Display available commands at the bottom
2. **ContextualHelpPanel** - Show context-sensitive help based on room contents
3. **NotificationToast** - Display transient messages for actions
