# v0.38.14: Trauma Descriptor Library - Integration Guide

## Overview

The Trauma Descriptor Library extends the v0.38 Descriptor Framework with comprehensive trauma manifestation descriptions. Instead of abstract trauma effects, v0.38.14 provides visceral, contextual narrative for psychological horror:

- **55+ Trauma Type Descriptors** (acquisition and ongoing manifestations)
- **40+ Trauma Trigger Descriptors** (contextual triggering)
- **44+ Breaking Point Descriptors** (stress warnings and breaking moments)
- **45+ Recovery Descriptors** (suppression and removal)
- **Total: 180+ narrative descriptors** for trauma system

## Quick Start

### 1. Run Database Migrations

Execute the v0.38.14 SQL scripts in order:

```bash
# 1. Schema (tables for trauma descriptors)
sqlite3 rune_and_rust.db < Data/v0.38.14_trauma_descriptor_library_schema.sql

# 2. Trauma type descriptors (acquisition + manifestation)
sqlite3 rune_and_rust.db < Data/v0.38.14_trauma_type_descriptors_content.sql

# 3. Trauma trigger descriptors (contextual triggers)
sqlite3 rune_and_rust.db < Data/v0.38.14_trauma_trigger_descriptors_content.sql

# 4. Breaking point descriptors (stress warnings + breaking)
sqlite3 rune_and_rust.db < Data/v0.38.14_breaking_point_descriptors_content.sql

# 5. Recovery descriptors (suppression + removal)
sqlite3 rune_and_rust.db < Data/v0.38.14_recovery_descriptors_content.sql
```

### 2. Verify Installation

```sql
-- Check trauma descriptors
SELECT descriptor_type, COUNT(*)
FROM Trauma_Descriptors
GROUP BY descriptor_type;
-- Expected: Acquisition (20), Manifestation (35), Trigger (40+)

-- Check breaking point descriptors
SELECT phase, COUNT(*)
FROM Breaking_Point_Descriptors
GROUP BY phase;
-- Expected: Warning (13), Breaking (9), ResolveSuccess (6), etc.

-- Check recovery descriptors
SELECT recovery_type, COUNT(*)
FROM Recovery_Descriptors
GROUP BY recovery_type;
-- Expected: 45+ total across 7 recovery types
```

### 3. Initialize Services (C#)

```csharp
using RuneAndRust.Core.Descriptors;
using RuneAndRust.Persistence;
using RuneAndRust.Engine;

// Create repositories
var traumaRepository = new TraumaRepository(connectionString);
var descriptorRepository = new DescriptorRepository(connectionString);

// Create services
var traumaDescriptorService = new TraumaDescriptorService(descriptorRepository);
var traumaEconomyService = new TraumaEconomyService(traumaRepository, traumaDescriptorService);
```

## Trauma Descriptor Types

v0.38.14 provides six types of trauma descriptors:

| Type | Purpose | Count | Example Usage |
|------|---------|-------|---------------|
| **Acquisition** | Breaking Point → Trauma gained | 20+ | "Your mind shatters. Suddenly you're back there..." |
| **Manifestation** | Ongoing effects during gameplay | 35+ | "Mid-combat, a flashback strikes. [Stunned 1 turn]" |
| **Trigger** | Contextual activation | 40+ | "A Forlorn. Just like the one that nearly killed you." |
| **BreakingPoint** | Stress threshold warnings | 44+ | "Your vision narrows. Reality feels thin, like paper." |
| **Suppression** | Cognitive Stabilizer usage | 11+ | "The Stabilizer takes effect. Your racing thoughts slow." |
| **Recovery** | Saga Quest trauma removal | 34+ | "[TRAUMA REMOVED] You are free." |

## Usage Examples

### Example 1: Trauma Acquisition (Breaking Point)

```csharp
// Player reaches 100 stress
if (player.PsychicStress >= 100)
{
    // Display warning descriptor
    var warningDescriptor = traumaDescriptorService.GetBreakingPointDescriptor(
        player.PsychicStress,
        BreakingPointPhase.Breaking);

    Console.WriteLine(warningDescriptor.DescriptorText);
    // Output: "Your mind can't take anymore. The psychic pressure exceeds your capacity. You BREAK."

    // Resolve check
    var resolveCheck = player.MakeResolveCheck(DC: 16);

    if (resolveCheck.Failed)
    {
        // Acquire trauma
        var traumaId = traumaLibrary.SelectTraumaForSource(breakingPointSource);
        var acquisitionDescriptor = traumaDescriptorService.GetTraumaDescriptor(
            traumaId,
            TraumaDescriptorType.Acquisition,
            contextTag: "Combat");

        Console.WriteLine(acquisitionDescriptor.DescriptorText);
        // Output: "Your mind shatters. Suddenly you're back there—the moment when you thought you'd die..."

        // Reveal trauma
        var revealDescriptor = traumaDescriptorService.GetBreakingPointDescriptor(
            100,
            BreakingPointPhase.TraumaReveal,
            traumaId: "flashbacks");

        Console.WriteLine(revealDescriptor.DescriptorText);
        // Output: "[TRAUMA ACQUIRED: Flashbacks] Combat will trigger vivid memories..."

        player.AddTrauma(new Trauma { TraumaId = traumaId, ... });
        player.PsychicStress = 50; // Reset
    }
}
```

### Example 2: Trauma Manifestation (During Combat)

```csharp
// Each turn, check for trauma manifestations
foreach (var trauma in player.Traumas)
{
    // Random chance to manifest (based on trauma type)
    if (Random.Chance(trauma.ManifestationChance))
    {
        var manifestationDescriptor = traumaDescriptorService.GetTraumaDescriptor(
            trauma.TraumaId,
            TraumaDescriptorType.Manifestation,
            contextTag: "Combat",
            progressionLevel: trauma.ProgressionLevel);

        Console.WriteLine(manifestationDescriptor.DescriptorText);
        // Output: "Mid-combat, a flashback strikes. For a moment, you're not here..."

        // Apply mechanical effect
        var mechanicalContext = manifestationDescriptor.GetMechanicalContext();
        if (mechanicalContext.ContainsKey("effect") && mechanicalContext["effect"].ToString() == "stunned")
        {
            var duration = Convert.ToInt32(mechanicalContext["duration"]);
            player.ApplyStatus(new StunnedStatus { Duration = duration });
        }
    }
}
```

### Example 3: Trauma Trigger (Contextual)

```csharp
// Player health drops below 25%
if (player.HealthPercent < 0.25 && player.HasTrauma("flashbacks"))
{
    var triggerDescriptor = traumaDescriptorService.GetTraumaDescriptor(
        "flashbacks",
        TraumaDescriptorType.Trigger,
        contextTag: "Combat");

    // Filter by mechanical context
    var lowHealthTriggers = triggerDescriptor
        .Where(d => d.GetMechanicalContext()?.ContainsKey("trigger") == true
                 && d.GetMechanicalContext()["trigger"].ToString() == "low_health");

    var selectedTrigger = lowHealthTriggers.RandomWeighted(d => d.SpawnWeight);

    Console.WriteLine(selectedTrigger.DescriptorText);
    // Output: "You're injured badly. Just like before. The fear is overwhelming."

    // Apply trigger effect
    player.ApplyStatus(new StunnedStatus { Duration = 1 });
}
```

### Example 4: Breaking Point Warning (75-99% Stress)

```csharp
// Display warning as stress approaches breaking point
if (player.PsychicStress >= 75 && player.PsychicStress < 100)
{
    // Random chance to display warning each turn
    if (Random.Chance(0.3f)) // 30% per turn
    {
        var warningDescriptor = traumaDescriptorService.GetBreakingPointDescriptor(
            player.PsychicStress,
            BreakingPointPhase.Warning);

        Console.WriteLine($"[WARNING] {warningDescriptor.DescriptorText}");
        // Output: "[WARNING] Your vision narrows. Reality feels thin, like paper."
    }
}
```

### Example 5: Cognitive Stabilizer Usage

```csharp
// Player uses Cognitive Stabilizer
public void UseCognitiveStabilizer(Player player)
{
    // Application descriptor
    var applicationDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Stabilizer_Application,
        traumaId: null); // Generic application

    Console.WriteLine(applicationDescriptor.DescriptorText);
    // Output: "You inject the Cognitive Stabilizer. The chemicals flood your system."

    // Apply suppression effect
    player.ApplyTraumaSuppression(duration: 1); // 1 combat

    // Duration descriptor
    var durationDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Stabilizer_Duration);

    Console.WriteLine(durationDescriptor.DescriptorText);
    // Output: "You have temporary reprieve from your psychological scars."
}

// When stabilizer wears off
public void StabilizerWearingOff(Player player)
{
    var wearingOffDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Stabilizer_Wearing_Off);

    Console.WriteLine(wearingOffDescriptor.DescriptorText);
    // Output: "The Stabilizer fades. Your trauma comes roaring back, worse than before."

    player.AddPsychicStress(3); // Rebound stress
    player.RemoveTraumaSuppression();
}
```

### Example 6: Saga Quest Trauma Removal

```csharp
// Beginning trauma removal quest
public void BeginTraumaRemovalQuest(Player player, Trauma trauma)
{
    var beginningDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Quest_Beginning,
        traumaId: trauma.TraumaId);

    Console.WriteLine(beginningDescriptor.DescriptorText);
    // Output: "You've decided to confront your trauma. This won't be easy."

    // Initialize quest
    var sagaQuest = new SagaQuest { TraumaId = trauma.TraumaId, ... };
    player.ActiveQuests.Add(sagaQuest);
}

// During quest progression
public void TraumaQuestProgress(Player player, Trauma trauma)
{
    var duringDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Quest_During,
        traumaId: trauma.TraumaId);

    Console.WriteLine(duringDescriptor.DescriptorText);
    // Output: "The memories are overwhelming, but you push forward."
}

// Quest completion - trauma removed
public void CompleteTraumaRemovalQuest(Player player, Trauma trauma)
{
    // Completion descriptor
    var completionDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Quest_Completion,
        traumaId: trauma.TraumaId);

    Console.WriteLine(completionDescriptor.DescriptorText);
    // Output: "[TRAUMA REMOVED: Flashbacks] You've confronted the memories..."

    // Healing moment
    var healingDescriptor = traumaDescriptorService.GetRecoveryDescriptor(
        RecoveryType.Healing_Moment);

    Console.WriteLine(healingDescriptor.DescriptorText);
    // Output: "The weight lifts. For the first time in forever, you breathe easy."

    // Remove trauma
    player.RemoveTrauma(trauma);
}
```

## Trauma Types Covered

### Combat Traumas
- **Flashbacks** - Random combat stuns from reliving trauma
- **Battle Tremors** - Attack roll penalties from damaged nervous system
- **Hypervigilance** - Rest penalties and exhaustion from constant vigilance

### Blight-Related Traumas
- **Paradoxical Paranoia** - Perception disadvantage from corrupted reality
- **Auditory Hallucinations** - Concentration penalties from the Cursed Choir
- **Reality Dissociation** - Random AP loss from existential uncertainty

### Social Traumas
- **Corrupted Social Script** - Rhetoric penalties from broken social understanding
- **Trust Erosion** - Cooperation penalties from betrayal trauma

### Existential Traumas
- **Systemic Apathy** - Initiative penalties from nihilistic despair
- **Existential Dread** - Periodic stress gain from cosmic horror

## Integration with Trauma Economy System

The Trauma Descriptor Library integrates seamlessly with the existing Trauma Economy System (v0.15):

### Stress Accumulation → Breaking Point
```csharp
// TraumaEconomyService.cs
public void AddPsychicStress(Player player, int amount, string source)
{
    player.PsychicStress += amount;

    // Check for warning threshold (75-99%)
    if (player.PsychicStress >= 75 && player.PsychicStress < 100)
    {
        DisplayBreakingPointWarning(player);
    }

    // Check for breaking point (100%)
    if (player.PsychicStress >= 100)
    {
        TriggerBreakingPoint(player, source);
    }
}
```

### Trauma Progression (1 → 2 → 3)
```csharp
// As traumas worsen, use higher progression level descriptors
public void ProgressTrauma(Trauma trauma)
{
    trauma.ProgressionLevel++;

    // Manifestation descriptors automatically scale
    var manifestation = traumaDescriptorService.GetTraumaDescriptor(
        trauma.TraumaId,
        TraumaDescriptorType.Manifestation,
        progressionLevel: trauma.ProgressionLevel);

    // Progression level 2 descriptors are more severe
    // Progression level 3 descriptors are critical
}
```

### Trigger Condition Evaluation
```csharp
// TraumaManagementService.cs
public void EvaluateTraumaTriggers(Player player, GameContext context)
{
    foreach (var trauma in player.Traumas)
    {
        // Check environmental triggers
        if (context.LightLevel == LightLevel.Dim && trauma.TriggersOn("darkness"))
        {
            var triggerDescriptor = traumaDescriptorService.GetTraumaDescriptor(
                trauma.TraumaId,
                TraumaDescriptorType.Trigger,
                contextTag: "Environmental");

            DisplayTrigger(triggerDescriptor);
            ApplyTriggerEffect(trauma, "darkness");
        }

        // Check combat triggers
        if (context.InCombat && player.HealthPercent < 0.25 && trauma.TriggersOn("low_health"))
        {
            var triggerDescriptor = traumaDescriptorService.GetTraumaDescriptor(
                trauma.TraumaId,
                TraumaDescriptorType.Trigger,
                contextTag: "Combat");

            DisplayTrigger(triggerDescriptor);
            ApplyTriggerEffect(trauma, "low_health");
        }
    }
}
```

## Database Schema Reference

### Trauma_Descriptors Table
```sql
CREATE TABLE Trauma_Descriptors (
    descriptor_id INTEGER PRIMARY KEY,
    descriptor_name TEXT UNIQUE,
    trauma_id TEXT NOT NULL,              -- Links to Trauma.TraumaId
    trauma_name TEXT NOT NULL,            -- "[FLASHBACKS]"
    descriptor_type TEXT NOT NULL,        -- 'Acquisition', 'Manifestation', 'Trigger', etc.
    context_tag TEXT,                     -- 'Combat', 'Environmental', 'Social'
    descriptor_text TEXT NOT NULL,        -- The actual flavor text
    progression_level INTEGER,            -- 1, 2, or 3
    mechanical_context TEXT,              -- JSON: {"effect": "stunned", "duration": 1}
    spawn_weight REAL DEFAULT 1.0,
    display_conditions TEXT,              -- JSON: {"min_stress": 50}
    tags TEXT                             -- JSON array: ["Visceral", "Combat"]
);
```

### Breaking_Point_Descriptors Table
```sql
CREATE TABLE Breaking_Point_Descriptors (
    descriptor_id INTEGER PRIMARY KEY,
    descriptor_name TEXT UNIQUE,
    stress_threshold_min INTEGER NOT NULL,  -- 75 or 100
    stress_threshold_max INTEGER NOT NULL,  -- 99 or 100
    phase TEXT NOT NULL,                    -- 'Warning', 'Breaking', 'ResolveSuccess', etc.
    descriptor_text TEXT NOT NULL,
    spawn_weight REAL DEFAULT 1.0,
    tags TEXT
);
```

### Recovery_Descriptors Table
```sql
CREATE TABLE Recovery_Descriptors (
    descriptor_id INTEGER PRIMARY KEY,
    descriptor_name TEXT UNIQUE,
    recovery_type TEXT NOT NULL,           -- 'Stabilizer_Application', 'Quest_Completion', etc.
    trauma_id TEXT,                        -- Optional: specific trauma
    descriptor_text TEXT NOT NULL,
    spawn_weight REAL DEFAULT 1.0,
    tags TEXT
);
```

### Trauma_Trigger_Conditions Table
```sql
CREATE TABLE Trauma_Trigger_Conditions (
    trigger_id INTEGER PRIMARY KEY,
    trigger_name TEXT UNIQUE,
    trigger_category TEXT NOT NULL,        -- 'Environmental', 'Combat', 'Social'
    trigger_condition TEXT NOT NULL,       -- 'low_health', 'darkness', etc.
    applicable_trauma_ids TEXT NOT NULL,   -- JSON array: ["flashbacks", "battle_tremors"]
    thresholds TEXT,                       -- JSON: {"health_percent": 25}
    trigger_description TEXT NOT NULL,
    stress_impact TEXT,
    tags TEXT
);
```

## Performance Considerations

### Descriptor Caching
```csharp
// Cache frequently used descriptors
public class TraumaDescriptorService
{
    private Dictionary<string, List<TraumaDescriptor>> _descriptorCache = new();

    public TraumaDescriptor GetTraumaDescriptor(string traumaId, TraumaDescriptorType type, string? contextTag = null)
    {
        var cacheKey = $"{traumaId}_{type}_{contextTag}";

        if (!_descriptorCache.ContainsKey(cacheKey))
        {
            _descriptorCache[cacheKey] = LoadDescriptorsFromDatabase(traumaId, type, contextTag);
        }

        return _descriptorCache[cacheKey].RandomWeighted(d => d.SpawnWeight);
    }
}
```

### Trigger Evaluation Optimization
```csharp
// Only evaluate triggers for traumas player actually has
public void EvaluateTraumaTriggers(Player player, GameContext context)
{
    // Early exit if no traumas
    if (!player.HasTraumas) return;

    // Only check relevant triggers based on context
    if (context.InCombat)
    {
        EvaluateCombatTriggers(player, context);
    }
    else if (context.InSocialEncounter)
    {
        EvaluateSocialTriggers(player, context);
    }
    else
    {
        EvaluateEnvironmentalTriggers(player, context);
    }
}
```

## Success Criteria Checklist

- [x] 55+ trauma type descriptors (acquisition + manifestation)
- [x] 40+ trauma trigger descriptors (contextual)
- [x] 44+ breaking point descriptors (warnings + breaking)
- [x] 45+ recovery descriptors (suppression + removal)
- [x] Database schema created and populated
- [x] C# models created (TraumaDescriptor, BreakingPointDescriptor)
- [x] Integration guide documented
- [x] SQL migrations executable without errors
- [x] Total descriptor count: 180+

## Migration Path

### From Hardcoded Trauma Text
```csharp
// Before v0.38.14 (hardcoded)
if (trauma.TraumaId == "flashbacks")
{
    Console.WriteLine("[FLASHBACKS] You see the memory again.");
}

// After v0.38.14 (descriptor-based)
var descriptor = traumaDescriptorService.GetTraumaDescriptor(
    trauma.TraumaId,
    TraumaDescriptorType.Manifestation,
    contextTag: "Combat");

Console.WriteLine(descriptor.DescriptorText);
// Multiple variations, context-aware, progression-sensitive
```

## Conclusion

v0.38.14 transforms trauma from abstract mechanics into visceral, contextualized psychological horror. The descriptor library provides:

- **Narrative Depth**: 180+ unique descriptors for trauma manifestations
- **Contextual Awareness**: Triggers adapt to environment, combat, and social situations
- **Progression Scaling**: Descriptors intensify as traumas worsen (levels 1-3)
- **Integration**: Seamless connection to existing Trauma Economy System

Players will **feel** their traumas, not just see mechanical penalties. Psychological horror becomes tangible, moment-to-moment gameplay.
