> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.3](../v0.3.x/v0.3.3.md).

# Changelog: v0.3.3c - The Ecosystem (Integration)

**Release Date:** 2025-12-21

## Summary

This release integrates hazards and conditions into the procedural dungeon generation system via biome-based theming. The EnvironmentPopulator service assigns hazards and conditions to rooms based on their BiomeType (Ruin, Industrial, Organic, Void) and DangerLevel (Safe, Unstable, Hostile, Lethal). HazardTemplate entities define spawnable hazard types with BiomeTags for biome-filtered selection. BiomeEnvironmentMapping provides static mappings from biome types to valid condition types and danger level multipliers. During dungeon generation, DungeonGenerator calls EnvironmentPopulator.PopulateDungeonAsync() to roll for hazard/condition placement per room based on calculated spawn chances. The system creates DynamicHazard instances from HazardTemplate records, allowing for template-based hazard spawning. All 12 hazard templates are seeded via HazardTemplateSeeder with Domain 4 compliant descriptions. This release includes 21 new unit tests validating biome mappings, spawn chance calculations, and template-to-hazard conversion.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/HazardTemplate.cs` | Template entity for hazard definitions with BiomeTags, seeded at startup |
| `RuneAndRust.Core/Models/BiomeEnvironmentMapping.cs` | Static mapping of BiomeType to valid ConditionTypes and DangerLevel to spawn multipliers |
| `RuneAndRust.Core/Interfaces/IEnvironmentPopulator.cs` | Interface for environment population service with PopulateRoomAsync and PopulateDungeonAsync |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/EnvironmentPopulator.cs` | Core service for assigning hazards/conditions to rooms based on biome and danger level |

### Persistence Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Data/HazardTemplateSeeder.cs` | Seeds 12 hazard templates across 4 biomes with Domain 4 compliant descriptions |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/EnvironmentPopulatorTests.cs` | 21 unit tests validating biome mappings, spawn chances, and template-to-hazard conversion |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/AmbientCondition.cs` | Added BiomeTags property (List<BiomeType>) for biome-filtered spawning |
| `RuneAndRust.Engine/Services/DungeonGenerator.cs` | Added IEnvironmentPopulator dependency, calls PopulateDungeonAsync() after room creation |
| `RuneAndRust.Persistence/Data/ConditionSeeder.cs` | Added BiomeTags to all 8 existing condition seeds |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added HazardTemplates DbSet, configured BiomeTags JSONB columns for both HazardTemplate and AmbientCondition |
| `RuneAndRust.Terminal/Program.cs` | Registered IEnvironmentPopulator, added HazardTemplateSeeder call, updated version to v0.3.3c |
| `RuneAndRust.Tests/Engine/DungeonGeneratorTests.cs` | Added IEnvironmentPopulator mock to constructor |

---

## Code Implementation Details

### HazardTemplate Entity

**Key Properties:**
```csharp
public class HazardTemplate
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public HazardType HazardType { get; set; } = HazardType.Environmental;
    public TriggerType Trigger { get; set; } = TriggerType.Movement;
    public string EffectScript { get; set; } = string.Empty;
    public int MaxCooldown { get; set; } = 2;
    public bool OneTimeUse { get; set; } = false;
    public List<BiomeType> BiomeTags { get; set; } = new();
}
```

**Usage:**
- Seeded at startup via HazardTemplateSeeder
- Queried by EnvironmentPopulator during dungeon generation
- DynamicHazard instances are created from templates (copies all properties)

### BiomeEnvironmentMapping Static Class

**GetConditionTypes:**
```csharp
public static List<ConditionType> GetConditionTypes(BiomeType biome) => biome switch
{
    BiomeType.Ruin => new List<ConditionType> { ConditionType.LowVisibility, ConditionType.DreadPresence },
    BiomeType.Industrial => new List<ConditionType> { ConditionType.ToxicAtmosphere, ConditionType.StaticField, ConditionType.ScorchingHeat },
    BiomeType.Organic => new List<ConditionType> { ConditionType.BlightedGround, ConditionType.PsychicResonance, ConditionType.ToxicAtmosphere },
    BiomeType.Void => new List<ConditionType> { ConditionType.PsychicResonance, ConditionType.DreadPresence, ConditionType.DeepCold },
    _ => new List<ConditionType> { ConditionType.LowVisibility }
};
```

**GetDangerMultiplier:**
```csharp
public static float GetDangerMultiplier(DangerLevel level) => level switch
{
    DangerLevel.Safe => 0.1f,
    DangerLevel.Unstable => 0.3f,
    DangerLevel.Hostile => 0.5f,
    DangerLevel.Lethal => 0.7f,
    _ => 0.2f
};
```

### IEnvironmentPopulator Interface

```csharp
public interface IEnvironmentPopulator
{
    Task<Room> PopulateRoomAsync(Room room);
    Task PopulateDungeonAsync(IEnumerable<Room> rooms);
}
```

### EnvironmentPopulator Implementation

**Constants:**
```csharp
private const float BaseHazardChance = 0.2f;    // 20% base chance
private const float BaseConditionChance = 0.15f; // 15% base chance
```

**Spawn Chance Calculation:**
```csharp
var hazardChance = BaseHazardChance + BiomeEnvironmentMapping.GetDangerMultiplier(room.DangerLevel);
var conditionChance = BaseConditionChance + BiomeEnvironmentMapping.GetDangerMultiplier(room.DangerLevel);
```

| DangerLevel | Hazard Chance | Condition Chance |
|-------------|---------------|------------------|
| Safe | 30% | 25% |
| Unstable | 50% | 45% |
| Hostile | 70% | 65% |
| Lethal | 90% | 85% |

**PopulateRoomAsync Logic:**
1. Get room's BiomeType and DangerLevel
2. Calculate hazardChance and conditionChance
3. Roll d100 for hazard (if roll/100 <= chance, spawn hazard)
4. Query HazardTemplates filtered by BiomeTags matching room biome
5. Randomly select a template and create DynamicHazard instance
6. Roll d100 for condition (if roll/100 <= chance and room has no condition)
7. Query AmbientConditions filtered by BiomeTags and BiomeEnvironmentMapping
8. Randomly select a condition and assign to room.ConditionId

**PopulateDungeonAsync:**
- Iterates all rooms and calls PopulateRoomAsync for each
- Logs summary count of hazards and conditions assigned

**AssignHazardAsync:**
```csharp
private async Task AssignHazardAsync(Room room, BiomeType biome)
{
    var templates = await _hazardTemplateRepo.GetAllAsync();
    var validTemplates = templates
        .Where(t => t.BiomeTags.Count == 0 || t.BiomeTags.Contains(biome))
        .ToList();

    if (validTemplates.Count == 0) return;

    var template = validTemplates[_diceService.RollSingle(validTemplates.Count, "Hazard selection") - 1];

    var hazard = new DynamicHazard
    {
        Id = Guid.NewGuid(),
        RoomId = room.Id,
        Name = template.Name,
        Description = template.Description,
        HazardType = template.HazardType,
        Trigger = template.Trigger,
        EffectScript = template.EffectScript,
        MaxCooldown = template.MaxCooldown,
        OneTimeUse = template.OneTimeUse,
        State = HazardState.Dormant
    };

    room.Hazards.Add(hazard);
}
```

### AmbientCondition BiomeTags Addition

```csharp
public List<BiomeType> BiomeTags { get; set; } = new();
```

### DungeonGenerator Integration

**New Dependency:**
```csharp
private readonly IEnvironmentPopulator _environmentPopulator;
```

**GenerateTestMapAsync Update:**
```csharp
public async Task<Guid> GenerateTestMapAsync()
{
    await _roomRepository.ClearAllRoomsAsync();
    var rooms = CreateTestRooms();
    LinkRooms(rooms);

    // NEW: Populate with environmental hazards (v0.3.3c)
    await _environmentPopulator.PopulateDungeonAsync(rooms.Values);

    await _roomRepository.AddRangeAsync(rooms.Values);
    await _roomRepository.SaveChangesAsync();
    // ...
}
```

### Database Configuration

**HazardTemplate Entity Configuration:**
```csharp
modelBuilder.Entity<HazardTemplate>(entity =>
{
    entity.ToTable("HazardTemplates");
    entity.HasKey(t => t.Id);
    entity.HasIndex(t => t.Name).IsUnique();

    entity.Property(t => t.Name).HasMaxLength(100).IsRequired();
    entity.Property(t => t.Description).HasMaxLength(500).IsRequired();
    entity.Property(t => t.HazardType).HasConversion<int>().IsRequired();
    entity.Property(t => t.Trigger).HasConversion<int>().IsRequired();
    entity.Property(t => t.EffectScript).HasMaxLength(500).IsRequired();
    entity.Property(t => t.MaxCooldown).IsRequired();
    entity.Property(t => t.OneTimeUse).IsRequired();

    entity.Property(t => t.BiomeTags)
        .HasColumnType("jsonb")
        .HasConversion(
            v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
            v => JsonSerializer.Deserialize<List<BiomeType>>(v, (JsonSerializerOptions?)null) ?? new List<BiomeType>()
        )
        .IsRequired();
});
```

**AmbientCondition BiomeTags Configuration:**
```csharp
entity.Property(c => c.BiomeTags)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<List<BiomeType>>(v, (JsonSerializerOptions?)null) ?? new List<BiomeType>()
    )
    .IsRequired();
```

### HazardTemplateSeeder

**Seeded Hazard Templates (12 total):**

#### Ruin Biome (3 hazards)
| Name | Type | Trigger | Effect |
|------|------|---------|--------|
| Pressure Plate | Mechanical | Movement | DAMAGE:Physical:1d6 |
| Collapsing Floor | Environmental | Movement | DAMAGE:Physical:2d6 (one-time) |
| Dart Trap | Mechanical | Movement | DAMAGE:Physical:1d4;STATUS:Poisoned:2 |

#### Industrial Biome (3 hazards)
| Name | Type | Trigger | Effect |
|------|------|---------|--------|
| Steam Vent | Environmental | TurnStart | DAMAGE:Fire:1d4 |
| Electrified Floor | Mechanical | Movement | DAMAGE:Lightning:1d6;STATUS:Stunned:1 |
| Unstable Machinery | Mechanical | DamageTaken | DAMAGE:Physical:2d4 (one-time) |

#### Organic Biome (3 hazards)
| Name | Type | Trigger | Effect |
|------|------|---------|--------|
| Spore Pod | Biological | Movement | DAMAGE:Poison:1d4;STATUS:Poisoned:2 |
| Corruption Pool | Biological | Movement | CORRUPTION:2 |
| Grasping Tendrils | Biological | TurnStart | DAMAGE:Physical:1d4;STATUS:Slowed:1 |

#### Void Biome (3 hazards)
| Name | Type | Trigger | Effect |
|------|------|---------|--------|
| Reality Fissure | Environmental | TurnStart | STRESS:2;DAMAGE:Psychic:1d4 |
| Entropy Field | Environmental | Movement | DAMAGE:Cold:1d6 |
| Echoing Whispers | Environmental | TurnStart | STRESS:3 |

### ConditionSeeder BiomeTags Update

| Condition | BiomeTags |
|-----------|-----------|
| Psychic Resonance | Organic, Void |
| Toxic Atmosphere | Industrial, Organic |
| Deep Cold | Void |
| Scorching Heat | Industrial |
| Low Visibility | Ruin |
| Blighted Ground | Organic |
| Static Field | Industrial |
| Dread Presence | Ruin, Void |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Room Population Start | Debug | `"[Environment] Populating {RoomName} (Biome: {Biome}, Danger: {Danger}, HazardChance: {HazardChance:P0}, ConditionChance: {ConditionChance:P0})"` |
| Hazard Assigned | Info | `"[Environment] Assigned hazard [{HazardName}] to room {RoomName}"` |
| Condition Assigned | Info | `"[Environment] Assigned condition [{ConditionName}] to room {RoomName}"` |
| No Valid Templates | Warning | `"[Environment] No valid hazard templates for biome {Biome}"` |
| No Valid Conditions | Debug | `"[Environment] No valid conditions for biome {Biome}"` |
| Dungeon Population Start | Info | `"[Environment] Populating dungeon rooms"` |
| Dungeon Population Complete | Info | `"[Environment] Dungeon population complete. Assigned {HazardCount} hazards and {ConditionCount} conditions to {RoomCount} rooms"` |

---

## Test Coverage

**Total: 21 tests | Passed: 21 | Failed: 0 | Duration: 71ms**

### EnvironmentPopulatorTests (21 tests)

#### BiomeEnvironmentMapping Tests (6 tests)

| Test Name | Description |
|-----------|-------------|
| GetConditionTypes_AllBiomes_ReturnsNonEmptyList | All biomes return at least one valid condition |
| GetConditionTypes_RuinBiome_ReturnsCorrectTypes | Ruin returns LowVisibility, DreadPresence |
| GetConditionTypes_IndustrialBiome_ReturnsCorrectTypes | Industrial returns ToxicAtmosphere, StaticField, ScorchingHeat |
| GetConditionTypes_OrganicBiome_ReturnsCorrectTypes | Organic returns BlightedGround, PsychicResonance, ToxicAtmosphere |
| GetConditionTypes_VoidBiome_ReturnsCorrectTypes | Void returns PsychicResonance, DreadPresence, DeepCold |
| GetDangerMultiplier_ReturnsCorrectValue | Theory test for all danger levels |

#### PopulateRoomAsync Tests (9 tests)

| Test Name | Description |
|-----------|-------------|
| PopulateRoom_HighChanceRoll_AssignsHazard | Lethal danger with passing roll assigns hazard |
| PopulateRoom_LowChanceRoll_NoHazard | Safe danger with failing roll assigns no hazard |
| PopulateRoom_BiomeFiltersTemplates | Industrial room only gets Industrial hazards |
| PopulateRoom_NoMatchingTemplates_NoHazard | Void room with only Ruin templates assigns nothing |
| PopulateRoom_AssignsCondition | Passing condition roll assigns condition |
| PopulateRoom_ExistingCondition_NotOverwritten | Room with existing ConditionId is not modified |
| PopulateRoom_CreatesHazardFromTemplate | DynamicHazard copies all HazardTemplate properties |
| PopulateRoom_HazardHasDormantState | Created hazard starts in Dormant state |
| PopulateRoom_HazardHasCorrectRoomId | Created hazard has correct RoomId |

#### PopulateDungeonAsync Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| PopulateDungeon_ProcessesAllRooms | All rooms in list are populated |
| PopulateDungeon_EmptyRoomList_NoErrors | Empty room list doesn't throw |

#### DungeonGeneratorTests Updates (4 affected tests)

| Test Name | Change |
|-----------|--------|
| All 25 tests | Added IEnvironmentPopulator mock to constructor |

---

## DI Registration

**Program.cs Additions:**
```csharp
// Register Environment Ecosystem Services (v0.3.3c)
services.AddScoped<IEnvironmentPopulator, EnvironmentPopulator>();

// Seed data (added HazardTemplateSeeder)
HazardTemplateSeeder.SeedAsync(context).GetAwaiter().GetResult();
```

**Lifetime Rationale:**
- `EnvironmentPopulator` registered as Scoped (per-request lifecycle, matches DungeonGenerator)
- Uses existing repositories and DiceService

---

## Verification Results

### Build Output
```
Build succeeded.
    0 Error(s)
    73 Warning(s)

Time Elapsed 00:00:01.87
```

### Test Output
```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)

Passed!  - Failed:     0, Passed:    21, Skipped:     0, Total:    21, Duration: 71 ms
```

---

## Running Tests

### All EnvironmentPopulator Tests
```bash
dotnet test --filter "FullyQualifiedName~EnvironmentPopulatorTests"
```

### Specific Test Categories
```bash
# BiomeEnvironmentMapping tests
dotnet test --filter "FullyQualifiedName~EnvironmentPopulatorTests&Name~GetConditionTypes"

# PopulateRoom tests
dotnet test --filter "FullyQualifiedName~EnvironmentPopulatorTests&Name~PopulateRoom"

# PopulateDungeon tests
dotnet test --filter "FullyQualifiedName~EnvironmentPopulatorTests&Name~PopulateDungeon"
```

---

## Next Steps

The following features are planned for later versions:

### v0.4.0 - Worldbuilding Milestone
- **Room Biome Assignment**: DungeonGenerator assigns BiomeType and DangerLevel to generated rooms
- **Condition Persistence**: Save/load room conditions across sessions
- **Dynamic Condition Application**: Events/items that apply temporary conditions to rooms
- **Condition Intensity Levels**: Tiered severity (Mild/Moderate/Severe variants)
- **Player Condition Mitigation**: Equipment/abilities that reduce condition penalties

### Deferred: AI Environmental Awareness
AI hazard avoidance was originally planned for this version but is incompatible with the current combat architecture:
- Combat is action-based, not tile-based
- Enemies select attack types, not movement destinations
- No spatial movement system exists for AI to avoid hazards

This feature is deferred to a future version that introduces tactical movement (e.g., v0.5.x).

---

## Breaking Changes

None. This release is backward compatible.

---

## Migration Notes

### Database
A new migration is required to add the HazardTemplates table and BiomeTags columns.

**New Table: HazardTemplates**
- `Id` (Guid, PK)
- `Name` (varchar 100, Unique Index)
- `Description` (varchar 500)
- `HazardType` (int)
- `Trigger` (int)
- `EffectScript` (varchar 500)
- `MaxCooldown` (int)
- `OneTimeUse` (bool)
- `BiomeTags` (jsonb)

**AmbientConditions Table Alteration**
- Add `BiomeTags` (jsonb)

**Seeding**
Run `HazardTemplateSeeder.SeedAsync()` to populate 12 hazard templates.
Re-run `ConditionSeeder.SeedAsync()` to update condition BiomeTags (requires clearing existing data or manual update).

---

## Contributors

- Claude Code (Chronicle-Smith Agent)
