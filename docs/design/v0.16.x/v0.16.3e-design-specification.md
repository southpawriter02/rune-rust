# v0.16.3e Design Specification: Stat Verification Service

**Version:** 0.16.3e  
**Phase Name:** Stat Verification Service  
**Parent Version:** v0.16.3 (Smart Loot Generation)  
**Prerequisites:** v0.16.3d Complete (Loot Service Integration), v0.16.0 (Quality Tier System)  
**Estimated Tests:** ~3 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [StatRange Value Object](#4-statrange-value-object)
5. [IStatVerificationService Interface](#5-istatverificationservice-interface)
6. [Stat Ranges Configuration](#6-stat-ranges-configuration)
7. [Tier Scaling Reference](#7-tier-scaling-reference)
8. [Data Model Changes](#8-data-model-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the stat verification service that ensures generated loot items have tier-appropriate stats. The service validates that weapon damage, armor defense, and attribute bonuses fall within expected ranges for each quality tier.

Key verification rules:

| Tier | Name              | Damage Range | Attribute Bonus |
| ---- | ----------------- | ------------ | --------------- |
| 0    | Scavenged         | 1d6          | +0              |
| 1    | HandForged        | 1d6+1        | +1              |
| 2    | ClanForged        | 1d8+2        | +2              |
| 3    | MasterCrafted     | 2d6+2        | +3              |
| 4    | RuneEtched        | 2d6+4        | +4              |
| 5    | LegendaryArtifact | 2d8+6        | +5              |

This phase provides the final validation layer for the smart loot system, ensuring generated items meet player expectations for their quality tier.

### 1.2 Key Deliverables

| Category          | Items                      |
| ----------------- | -------------------------- |
| **Value Objects** | `StatRange`                |
| **Interfaces**    | `IStatVerificationService` |
| **Configuration** | `stat-ranges.json`         |
| **Tests**         | ~3 unit tests              |

### 1.3 Architectural Significance

This version establishes the **Stat Verification Pattern**:

- **Range-Based Validation**: Stats verified against min/max ranges per tier
- **Dice Expression Support**: Damage expressed as NdX+Y format
- **Fail-Fast Verification**: Invalid items caught before inventory
- **Configurable Ranges**: All stat ranges loaded from JSON configuration

---

## 2. Feature Overview

```
v0.16.3e Stat Verification Service
├── StatRange Value Object
│   ├── MinValue: int (minimum stat value)
│   ├── MaxValue: int (maximum stat value)
│   ├── ExpectedDice: string (e.g., "2d6+4")
│   ├── IsInRange(value): bool
│   └── GetAverageValue(): double
├── IStatVerificationService Interface
│   ├── VerifyItemStats(item, tier): StatVerificationResult
│   ├── GetExpectedDamage(tier): StatRange
│   ├── GetExpectedDefense(tier): StatRange
│   ├── GetExpectedAttributeBonus(tier): StatRange
│   └── IsValid(item, tier): bool
├── stat-ranges.json Configuration
│   ├── damageRanges: by tier
│   ├── defenseRanges: by tier
│   └── attributeBonusRanges: by tier
└── Tier Scaling
    ├── Tier 0: 1d6 damage, +0 attribute
    ├── Tier 4: 2d6+4 damage, +4 attribute
    └── Tier 5: 2d8+6 damage, +5 attribute
```

### 2.1 Scope Alignment

**In Scope:**

- `StatRange` value object with min/max and dice expression
- `IStatVerificationService` interface for tier validation
- `stat-ranges.json` configuration file
- Tier scaling verification logic
- Damage, defense, and attribute bonus validation

**Out of Scope:**

- Automatic stat correction (regenerate if invalid)
- Container loot (v0.16.4)
- Special item properties/effects

---

## 3. Architecture Diagrams

### 3.1 Stat Verification System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              STAT VERIFICATION SYSTEM OVERVIEW                       │
└─────────────────────────────────────────────────────────────────────┘

    LootService.GenerateLoot() → Item Generated
           │
           │  Item needs stat validation
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   IStatVerificationService                           │
├─────────────────────────────────────────────────────────────────────┤
│  + VerifyItemStats(item, tier): StatVerificationResult              │
│  + GetExpectedDamage(tier): StatRange                               │
│  + GetExpectedDefense(tier): StatRange                              │
│  + GetExpectedAttributeBonus(tier): StatRange                       │
│  + IsValid(item, tier): bool                                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Loads from configuration
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      stat-ranges.json                                │
├─────────────────────────────────────────────────────────────────────┤
│  {                                                                  │
│    "tiers": [                                                       │
│      { "tier": 0, "damage": "1d6", "defense": "1-2", "attr": 0 },  │
│      { "tier": 1, "damage": "1d6+1", ... },                         │
│      ...                                                            │
│    ]                                                                │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Returns validation result
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    StatVerificationResult                            │
├─────────────────────────────────────────────────────────────────────┤
│  IsValid: bool                                                      │
│  Violations: IReadOnlyList<StatViolation>                           │
│  ItemId: string                                                     │
│  QualityTier: QualityTier                                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Verification Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                  VERIFICATION DECISION TREE                          │
└─────────────────────────────────────────────────────────────────────┘

    VerifyItemStats(item, tier) Called
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 1: DETERMINE ITEM TYPE                                     │
    ├──────────────────────────────────────────────────────────────────┤
    │  item.ItemType == Weapon?                                        │
    │    → Verify damage range                                         │
    │                                                                  │
    │  item.ItemType == Armor?                                         │
    │    → Verify defense range                                        │
    │                                                                  │
    │  Has attribute bonuses?                                          │
    │    → Verify attribute bonus range                                │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 2: GET EXPECTED RANGES                                     │
    ├──────────────────────────────────────────────────────────────────┤
    │  damageRange = GetExpectedDamage(tier)                           │
    │  defenseRange = GetExpectedDefense(tier)                         │
    │  attrRange = GetExpectedAttributeBonus(tier)                     │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 3: VALIDATE DAMAGE (Weapons)                               │
    ├──────────────────────────────────────────────────────────────────┤
    │  item.DamageMin >= damageRange.MinValue?                         │
    │  item.DamageMax <= damageRange.MaxValue?                         │
    │                                                                  │
    │  If either fails:                                                │
    │    violations.Add(StatViolation.Damage(expected, actual))        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 4: VALIDATE DEFENSE (Armor)                                │
    ├──────────────────────────────────────────────────────────────────┤
    │  item.Defense >= defenseRange.MinValue?                          │
    │  item.Defense <= defenseRange.MaxValue?                          │
    │                                                                  │
    │  If either fails:                                                │
    │    violations.Add(StatViolation.Defense(expected, actual))       │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 5: VALIDATE ATTRIBUTE BONUSES                              │
    ├──────────────────────────────────────────────────────────────────┤
    │  FOR EACH attribute in item.AttributeBonuses:                    │
    │    attribute.Value >= attrRange.MinValue?                        │
    │    attribute.Value <= attrRange.MaxValue?                        │
    │                                                                  │
    │    If either fails:                                              │
    │      violations.Add(StatViolation.Attribute(name, expected, actual))│
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 6: RETURN RESULT                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │  Return StatVerificationResult:                                  │
    │    IsValid = violations.Count == 0                               │
    │    Violations = violations                                       │
    │    ItemId = item.Id                                              │
    │    QualityTier = tier                                            │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Tier Scaling Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│                      TIER SCALING VISUALIZATION                      │
└─────────────────────────────────────────────────────────────────────┘

    Damage Scaling (Weapons)
    ─────────────────────────────────────────────────────────────────
    Tier 0 (Scavenged):        ████                    (1d6 = 1-6)
    Tier 1 (HandForged):       █████                   (1d6+1 = 2-7)
    Tier 2 (ClanForged):       ███████                 (1d8+2 = 3-10)
    Tier 3 (MasterCrafted):    ██████████              (2d6+2 = 4-14)
    Tier 4 (RuneEtched):       ████████████            (2d6+4 = 6-16)
    Tier 5 (Legendary):        ██████████████████      (2d8+6 = 8-22)


    Defense Scaling (Armor)
    ─────────────────────────────────────────────────────────────────
    Tier 0: 1-2    ██
    Tier 1: 2-3    ███
    Tier 2: 3-5    █████
    Tier 3: 5-7    ███████
    Tier 4: 7-10   ██████████
    Tier 5: 10-14  ██████████████


    Attribute Bonus Scaling
    ─────────────────────────────────────────────────────────────────
    Tier 0: +0     (none)
    Tier 1: +1     █
    Tier 2: +2     ██
    Tier 3: +3     ███
    Tier 4: +4     ████
    Tier 5: +5     █████
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                LootService (uses verification)                 │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  GenerateLoot() now includes:                                 │  │
│  │    item = GenerateItem(...)                                   │  │
│  │    result = _statVerificationService.VerifyItemStats(item)   │  │
│  │    if (!result.IsValid) { Log warning, regenerate or flag }  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │          StatVerificationService (NEW)                         │  │
│  │         (implements IStatVerificationService)                  │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + VerifyItemStats(item, tier): StatVerificationResult        │  │
│  │  + GetExpectedDamage(tier): StatRange                         │  │
│  │  + GetExpectedDefense(tier): StatRange                        │  │
│  │  + GetExpectedAttributeBonus(tier): StatRange                 │  │
│  │  + IsValid(item, tier): bool                                  │  │
│  │                                                               │  │
│  │  Dependencies:                                                │  │
│  │  - IStatRangeProvider (loads stat-ranges.json)                │  │
│  │  - ILogger<StatVerificationService>                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                      StatRange                                  ││
│  │                   (Value Object)                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  MinValue: int              (minimum allowed stat value)        ││
│  │  MaxValue: int              (maximum allowed stat value)        ││
│  │  DiceExpression: string     (e.g., "2d6+4" for display)        ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  + IsInRange(value): bool                                       ││
│  │  + GetAverageValue(): double                                    ││
│  │  + FormatRange(): string                                        ││
│  │  + Create(min, max, dice): StatRange                            ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                StatVerificationResult                           ││
│  │                   (Value Object)                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  IsValid: bool                                                  ││
│  │  Violations: IReadOnlyList<StatViolation>                       ││
│  │  ItemId: string                                                 ││
│  │  QualityTier: QualityTier                                       ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                    StatViolation                                ││
│  │                   (Value Object)                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  StatType: StatViolationType (Damage, Defense, Attribute)       ││
│  │  StatName: string (e.g., "Damage", "Might")                     ││
│  │  ExpectedRange: StatRange                                       ││
│  │  ActualValue: int                                               ││
│  │  Message: string                                                ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. StatRange Value Object

### 4.1 Purpose

The `StatRange` value object defines the expected min/max values for a stat at a specific tier, along with a display-friendly dice expression.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/StatRange.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an expected range for a stat value.
/// </summary>
/// <remarks>
/// <para>
/// StatRange defines the minimum and maximum allowed values for a stat
/// at a specific quality tier. It also includes a dice expression for
/// display purposes (e.g., "2d6+4" for damage).
/// </para>
/// <para>
/// The dice expression is informational; the min/max values are derived
/// from the dice formula but stored explicitly for validation.
/// </para>
/// </remarks>
/// <param name="MinValue">Minimum allowed stat value (inclusive).</param>
/// <param name="MaxValue">Maximum allowed stat value (inclusive).</param>
/// <param name="DiceExpression">Display format (e.g., "2d6+4", "3-5").</param>
public readonly record struct StatRange(
    int MinValue,
    int MaxValue,
    string DiceExpression)
{
    /// <summary>
    /// Represents no range (invalid or N/A).
    /// </summary>
    public static StatRange None => new(0, 0, "N/A");

    /// <summary>
    /// Gets whether this range is valid (max >= min).
    /// </summary>
    public bool IsValid => MaxValue >= MinValue;

    /// <summary>
    /// Gets the range span (max - min).
    /// </summary>
    public int Span => MaxValue - MinValue;

    /// <summary>
    /// Checks if a value falls within this range (inclusive).
    /// </summary>
    /// <param name="value">The value to check.</param>
    /// <returns>True if value is within [MinValue, MaxValue].</returns>
    public bool IsInRange(int value) =>
        value >= MinValue && value <= MaxValue;

    /// <summary>
    /// Calculates the average value of this range.
    /// </summary>
    /// <returns>The midpoint of the range.</returns>
    public double GetAverageValue() =>
        (MinValue + MaxValue) / 2.0;

    /// <summary>
    /// Formats the range for display.
    /// </summary>
    /// <returns>A string like "1-6 (1d6)" or "6-16 (2d6+4)".</returns>
    public string FormatRange() =>
        $"{MinValue}-{MaxValue} ({DiceExpression})";

    /// <summary>
    /// Creates a StatRange with validation.
    /// </summary>
    public static StatRange Create(int minValue, int maxValue, string diceExpression)
    {
        ArgumentOutOfRangeException.ThrowIfNegative(minValue);
        ArgumentOutOfRangeException.ThrowIfLessThan(maxValue, minValue);
        ArgumentException.ThrowIfNullOrWhiteSpace(diceExpression);

        return new StatRange(minValue, maxValue, diceExpression);
    }

    /// <summary>
    /// Creates a StatRange from a dice expression.
    /// </summary>
    /// <remarks>
    /// Parses expressions like "1d6", "2d6+4", "1d8+2".
    /// Format: NdX or NdX+Y where N=count, X=sides, Y=bonus.
    /// </remarks>
    public static StatRange CreateFromDice(int diceCount, int diceSides, int bonus = 0)
    {
        ArgumentOutOfRangeException.ThrowIfLessThan(diceCount, 1);
        ArgumentOutOfRangeException.ThrowIfLessThan(diceSides, 1);
        ArgumentOutOfRangeException.ThrowIfNegative(bonus);

        var min = diceCount + bonus;         // Minimum: all 1s + bonus
        var max = (diceCount * diceSides) + bonus; // Maximum: all max + bonus

        var expression = bonus > 0
            ? $"{diceCount}d{diceSides}+{bonus}"
            : $"{diceCount}d{diceSides}";

        return new StatRange(min, max, expression);
    }

    /// <summary>
    /// Creates a StatRange for a flat value range.
    /// </summary>
    public static StatRange CreateFlat(int minValue, int maxValue) =>
        new(minValue, maxValue, $"{minValue}-{maxValue}");

    /// <summary>
    /// Creates a StatRange for a single fixed value.
    /// </summary>
    public static StatRange CreateFixed(int value) =>
        new(value, value, $"+{value}");

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() => FormatRange();
}
```

### 4.3 Supporting Types

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/StatVerificationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Contains the result of stat verification for an item.
/// </summary>
public readonly record struct StatVerificationResult(
    bool IsValid,
    IReadOnlyList<StatViolation> Violations,
    string ItemId,
    QualityTier QualityTier)
{
    /// <summary>
    /// Creates a valid result (no violations).
    /// </summary>
    public static StatVerificationResult Valid(string itemId, QualityTier tier) =>
        new(true, Array.Empty<StatViolation>(), itemId, tier);

    /// <summary>
    /// Creates an invalid result with violations.
    /// </summary>
    public static StatVerificationResult Invalid(
        string itemId,
        QualityTier tier,
        IReadOnlyList<StatViolation> violations) =>
        new(false, violations, itemId, tier);

    /// <summary>
    /// Gets a summary of all violations.
    /// </summary>
    public string GetViolationSummary() =>
        IsValid
            ? "All stats valid"
            : string.Join("; ", Violations.Select(v => v.Message));
}

/// <summary>
/// Types of stat violations.
/// </summary>
public enum StatViolationType
{
    /// <summary>Damage stat out of range.</summary>
    Damage,
    /// <summary>Defense stat out of range.</summary>
    Defense,
    /// <summary>Attribute bonus out of range.</summary>
    Attribute
}

/// <summary>
/// Represents a single stat violation.
/// </summary>
public readonly record struct StatViolation(
    StatViolationType StatType,
    string StatName,
    StatRange ExpectedRange,
    int ActualValue)
{
    /// <summary>
    /// Gets a human-readable violation message.
    /// </summary>
    public string Message =>
        $"{StatName} value {ActualValue} outside expected range " +
        $"{ExpectedRange.FormatRange()}";

    /// <summary>
    /// Creates a damage violation.
    /// </summary>
    public static StatViolation Damage(StatRange expected, int actual) =>
        new(StatViolationType.Damage, "Damage", expected, actual);

    /// <summary>
    /// Creates a defense violation.
    /// </summary>
    public static StatViolation Defense(StatRange expected, int actual) =>
        new(StatViolationType.Defense, "Defense", expected, actual);

    /// <summary>
    /// Creates an attribute violation.
    /// </summary>
    public static StatViolation Attribute(string attrName, StatRange expected, int actual) =>
        new(StatViolationType.Attribute, attrName, expected, actual);
}
```

---

## 5. IStatVerificationService Interface

### 5.1 Purpose

The `IStatVerificationService` interface provides stat validation for generated items, ensuring they meet tier-appropriate requirements.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IStatVerificationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides stat verification for generated loot items.
/// </summary>
/// <remarks>
/// <para>
/// The stat verification service validates that generated items have
/// stats appropriate for their quality tier. It checks damage ranges
/// for weapons, defense for armor, and attribute bonuses for all items.
/// </para>
/// <para>
/// Verification uses configurable stat ranges loaded from stat-ranges.json,
/// allowing easy tuning of tier scaling without code changes.
/// </para>
/// </remarks>
public interface IStatVerificationService
{
    /// <summary>
    /// Verifies all stats on an item against tier expectations.
    /// </summary>
    /// <param name="item">The item to verify.</param>
    /// <param name="tier">The expected quality tier.</param>
    /// <returns>Verification result with any violations.</returns>
    StatVerificationResult VerifyItemStats(Item item, QualityTier tier);

    /// <summary>
    /// Gets the expected damage range for a tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>The expected damage range.</returns>
    StatRange GetExpectedDamage(QualityTier tier);

    /// <summary>
    /// Gets the expected defense range for a tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>The expected defense range.</returns>
    StatRange GetExpectedDefense(QualityTier tier);

    /// <summary>
    /// Gets the expected attribute bonus range for a tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>The expected attribute bonus range.</returns>
    StatRange GetExpectedAttributeBonus(QualityTier tier);

    /// <summary>
    /// Quick check if an item's stats are valid for a tier.
    /// </summary>
    /// <param name="item">The item to check.</param>
    /// <param name="tier">The expected quality tier.</param>
    /// <returns>True if all stats are within expected ranges.</returns>
    bool IsValid(Item item, QualityTier tier);

    /// <summary>
    /// Gets all stat ranges for a tier.
    /// </summary>
    /// <param name="tier">The quality tier.</param>
    /// <returns>Dictionary of stat name to expected range.</returns>
    IReadOnlyDictionary<string, StatRange> GetAllRanges(QualityTier tier);
}
```

### 5.3 Usage Examples

```csharp
// Verify a generated item
var item = _itemGenerator.Generate(lootEntry, tier);
var result = _statVerificationService.VerifyItemStats(item, tier);

if (!result.IsValid)
{
    _logger.LogWarning(
        "Item {ItemId} failed stat verification: {Violations}",
        item.Id, result.GetViolationSummary());

    // Option 1: Regenerate the item
    item = _itemGenerator.Regenerate(lootEntry, tier);

    // Option 2: Flag for review
    item.AddFlag(ItemFlag.StatViolation);
}

// Quick validation check
if (_statVerificationService.IsValid(item, tier))
{
    inventory.Add(item);
}

// Get expected ranges for display
var damageRange = _statVerificationService.GetExpectedDamage(QualityTier.RuneEtched);
Console.WriteLine($"Tier 4 weapons deal {damageRange.FormatRange()} damage");
// Output: "Tier 4 weapons deal 6-16 (2d6+4) damage"
```

---

## 6. Stat Ranges Configuration

### 6.1 Configuration File

**File:** `config/stat-ranges.json`

```json
{
    "$schema": "./schemas/stat-ranges.schema.json",
    "version": "1.0.0",
    "tiers": [
        {
            "tier": 0,
            "tierName": "Scavenged",
            "damage": {
                "diceCount": 1,
                "diceSides": 6,
                "bonus": 0,
                "min": 1,
                "max": 6
            },
            "defense": {
                "min": 1,
                "max": 2
            },
            "attributeBonus": {
                "min": 0,
                "max": 0
            }
        },
        {
            "tier": 1,
            "tierName": "HandForged",
            "damage": {
                "diceCount": 1,
                "diceSides": 6,
                "bonus": 1,
                "min": 2,
                "max": 7
            },
            "defense": {
                "min": 2,
                "max": 3
            },
            "attributeBonus": {
                "min": 1,
                "max": 1
            }
        },
        {
            "tier": 2,
            "tierName": "ClanForged",
            "damage": {
                "diceCount": 1,
                "diceSides": 8,
                "bonus": 2,
                "min": 3,
                "max": 10
            },
            "defense": {
                "min": 3,
                "max": 5
            },
            "attributeBonus": {
                "min": 2,
                "max": 2
            }
        },
        {
            "tier": 3,
            "tierName": "MasterCrafted",
            "damage": {
                "diceCount": 2,
                "diceSides": 6,
                "bonus": 2,
                "min": 4,
                "max": 14
            },
            "defense": {
                "min": 5,
                "max": 7
            },
            "attributeBonus": {
                "min": 3,
                "max": 3
            }
        },
        {
            "tier": 4,
            "tierName": "RuneEtched",
            "damage": {
                "diceCount": 2,
                "diceSides": 6,
                "bonus": 4,
                "min": 6,
                "max": 16
            },
            "defense": {
                "min": 7,
                "max": 10
            },
            "attributeBonus": {
                "min": 4,
                "max": 4
            }
        },
        {
            "tier": 5,
            "tierName": "LegendaryArtifact",
            "damage": {
                "diceCount": 2,
                "diceSides": 8,
                "bonus": 6,
                "min": 8,
                "max": 22
            },
            "defense": {
                "min": 10,
                "max": 14
            },
            "attributeBonus": {
                "min": 5,
                "max": 5
            }
        }
    ]
}
```

### 6.2 Configuration Schema

**File:** `config/schemas/stat-ranges.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "stat-ranges.schema.json",
    "title": "Stat Ranges Configuration",
    "description": "Defines expected stat ranges for each quality tier",
    "type": "object",
    "required": ["version", "tiers"],
    "properties": {
        "$schema": { "type": "string" },
        "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "tiers": {
            "type": "array",
            "minItems": 6,
            "maxItems": 6,
            "items": { "$ref": "#/$defs/tierDefinition" }
        }
    },
    "$defs": {
        "tierDefinition": {
            "type": "object",
            "required": [
                "tier",
                "tierName",
                "damage",
                "defense",
                "attributeBonus"
            ],
            "properties": {
                "tier": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 5
                },
                "tierName": { "type": "string" },
                "damage": { "$ref": "#/$defs/diceRange" },
                "defense": { "$ref": "#/$defs/flatRange" },
                "attributeBonus": { "$ref": "#/$defs/flatRange" }
            }
        },
        "diceRange": {
            "type": "object",
            "required": ["diceCount", "diceSides", "bonus", "min", "max"],
            "properties": {
                "diceCount": { "type": "integer", "minimum": 1 },
                "diceSides": { "type": "integer", "minimum": 1 },
                "bonus": { "type": "integer", "minimum": 0 },
                "min": { "type": "integer", "minimum": 1 },
                "max": { "type": "integer", "minimum": 1 }
            }
        },
        "flatRange": {
            "type": "object",
            "required": ["min", "max"],
            "properties": {
                "min": { "type": "integer", "minimum": 0 },
                "max": { "type": "integer", "minimum": 0 }
            }
        }
    }
}
```

---

## 7. Tier Scaling Reference

### 7.1 Complete Tier Reference Table

| Tier | Name              | Damage | Defense | Attr | Monster Level |
| ---- | ----------------- | ------ | ------- | ---- | ------------- |
| 0    | Scavenged         | 1d6    | 1-2     | +0   | 1-4           |
| 1    | HandForged        | 1d6+1  | 2-3     | +1   | 5-9           |
| 2    | ClanForged        | 1d8+2  | 3-5     | +2   | 10-19         |
| 3    | MasterCrafted     | 2d6+2  | 5-7     | +3   | 20-34         |
| 4    | RuneEtched        | 2d6+4  | 7-10    | +4   | 35-49         |
| 5    | LegendaryArtifact | 2d8+6  | 10-14   | +5   | 50+           |

### 7.2 Damage Calculation Details

```
Dice Expression Format: NdX+Y
  N = number of dice
  X = sides per die
  Y = flat bonus

Tier 0: 1d6     → Min: 1, Max: 6,  Avg: 3.5
Tier 1: 1d6+1   → Min: 2, Max: 7,  Avg: 4.5
Tier 2: 1d8+2   → Min: 3, Max: 10, Avg: 6.5
Tier 3: 2d6+2   → Min: 4, Max: 14, Avg: 9.0
Tier 4: 2d6+4   → Min: 6, Max: 16, Avg: 11.0
Tier 5: 2d8+6   → Min: 8, Max: 22, Avg: 15.0
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

| Type                       | Layer       | Category     | Description                   |
| -------------------------- | ----------- | ------------ | ----------------------------- |
| `StatRange`                | Domain      | Value Object | Min/max range with dice expr  |
| `StatVerificationResult`   | Domain      | Value Object | Verification outcome          |
| `StatViolation`            | Domain      | Value Object | Single violation detail       |
| `StatViolationType`        | Domain      | Enum         | Damage, Defense, Attribute    |
| `IStatVerificationService` | Application | Interface    | Verification service contract |

### 8.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Enums/
│   └── StatViolationType.cs                   ← NEW
└── ValueObjects/
    ├── StatRange.cs                           ← NEW
    ├── StatVerificationResult.cs              ← NEW
    └── StatViolation.cs                       ← NEW

src/Core/RuneAndRust.Application/
└── Interfaces/
    └── IStatVerificationService.cs            ← NEW

config/
├── stat-ranges.json                           ← NEW
└── schemas/
    └── stat-ranges.schema.json                ← NEW
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component                 | Level       | Events                     |
| ------------------------- | ----------- | -------------------------- |
| `StatVerificationService` | Information | Verification passed/failed |
| `StatVerificationService` | Debug       | Individual stat checks     |
| `StatVerificationService` | Warning     | Stat violations found      |
| `StatVerificationService` | Error       | Configuration load failure |

### 9.2 Log Message Templates

```csharp
// Information - Verification passed
_logger.LogInformation(
    "Item {ItemId} passed stat verification for tier {Tier}",
    item.Id, tier);

// Warning - Violations found
_logger.LogWarning(
    "Item {ItemId} failed stat verification for tier {Tier}: {Violations}",
    item.Id, tier, result.GetViolationSummary());

// Debug - Individual checks
_logger.LogDebug(
    "Checking {StatType} for {ItemId}: Value={Value}, Expected={Range}",
    statType, item.Id, actualValue, expectedRange.FormatRange());

// Error - Config failure
_logger.LogError(
    "Failed to load stat ranges configuration: {Error}",
    exception.Message);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                  | Test Count |
| ------------------------ | ---------- |
| StatRange                | ~1         |
| StatVerificationResult   | ~1         |
| IStatVerificationService | ~1         |
| **Total**                | **~3**     |

### 10.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StatRangeTests.cs`

```csharp
[TestFixture]
public class StatRangeTests
{
    [Test]
    public void CreateFromDice_CalculatesCorrectRange()
    {
        // Arrange & Act
        var range = StatRange.CreateFromDice(diceCount: 2, diceSides: 6, bonus: 4);

        // Assert (2d6+4 = min 6, max 16)
        range.MinValue.Should().Be(6);
        range.MaxValue.Should().Be(16);
        range.DiceExpression.Should().Be("2d6+4");
        range.GetAverageValue().Should().Be(11.0);
    }

    [Test]
    public void IsInRange_ReturnsTrueForValidValue()
    {
        // Arrange
        var range = StatRange.Create(1, 6, "1d6");

        // Assert
        range.IsInRange(1).Should().BeTrue();
        range.IsInRange(3).Should().BeTrue();
        range.IsInRange(6).Should().BeTrue();
        range.IsInRange(0).Should().BeFalse();
        range.IsInRange(7).Should().BeFalse();
    }
}
```

**File:** `tests/RuneAndRust.Application.UnitTests/Services/StatVerificationServiceTests.cs`

```csharp
[TestFixture]
public class StatVerificationServiceTests
{
    [Test]
    public void VerifyItemStats_Tier0Weapon_AcceptsDamage1d6()
    {
        // Arrange
        var service = CreateService();
        var weapon = CreateWeapon(damageMin: 1, damageMax: 6);

        // Act
        var result = service.VerifyItemStats(weapon, QualityTier.Scavenged);

        // Assert
        result.IsValid.Should().BeTrue();
        result.Violations.Should().BeEmpty();
    }

    [Test]
    public void VerifyItemStats_Tier4Weapon_AcceptsDamage2d6Plus4()
    {
        // Arrange
        var service = CreateService();
        var weapon = CreateWeapon(damageMin: 6, damageMax: 16);

        // Act
        var result = service.VerifyItemStats(weapon, QualityTier.RuneEtched);

        // Assert
        result.IsValid.Should().BeTrue();
    }

    [Test]
    public void VerifyItemStats_Tier4AttributeBonus_AcceptsPlus4()
    {
        // Arrange
        var service = CreateService();
        var item = CreateItemWithAttributeBonus("Might", 4);

        // Act
        var result = service.VerifyItemStats(item, QualityTier.RuneEtched);

        // Assert
        result.IsValid.Should().BeTrue();
    }

    [Test]
    public void VerifyItemStats_InvalidStats_ReturnsViolations()
    {
        // Arrange
        var service = CreateService();
        var weapon = CreateWeapon(damageMin: 20, damageMax: 30); // Way too high for Tier 0

        // Act
        var result = service.VerifyItemStats(weapon, QualityTier.Scavenged);

        // Assert
        result.IsValid.Should().BeFalse();
        result.Violations.Should().ContainSingle();
        result.Violations[0].StatType.Should().Be(StatViolationType.Damage);
    }
}
```

---

## 11. Use Cases

### UC-001: Verify Generated Weapon Stats

**Actor:** Loot Generation System  
**Precondition:** Weapon generated from loot table  
**Flow:** Generate weapon → Call VerifyItemStats → Check damage range for tier → Return valid result  
**Postcondition:** Weapon confirmed to have tier-appropriate damage

### UC-002: Verify Armor Defense

**Actor:** Loot Generation System  
**Precondition:** Armor generated from loot table  
**Flow:** Generate armor → Call VerifyItemStats → Check defense range for tier → Return valid result  
**Postcondition:** Armor confirmed to have tier-appropriate defense

### UC-003: Handle Stat Violation

**Actor:** LootService  
**Precondition:** Generated item fails verification  
**Flow:** Verify stats → Violations found → Log warning → Regenerate or flag item  
**Postcondition:** Invalid item handled appropriately

### UC-004: Display Expected Stats

**Actor:** Tooltip System  
**Flow:** Get tier ranges → Display expected damage/defense → Player understands item quality  
**Postcondition:** Player sees tier expectations for comparison

---

## 12. Deliverable Checklist

### Domain Layer

- [ ] `StatRange` value object created
- [ ] `StatVerificationResult` value object created
- [ ] `StatViolation` value object created
- [ ] `StatViolationType` enum created

### Application Layer

- [ ] `IStatVerificationService` interface created

### Configuration

- [ ] `stat-ranges.json` configuration file created
- [ ] `stat-ranges.schema.json` schema file created

### Testing

- [ ] ~3 unit tests implemented
- [ ] All tests passing

### Documentation

- [ ] XML documentation on all public types
- [ ] Inline comments for verification logic

---

## 13. Acceptance Criteria

### Functional

- [ ] Tier 0 items accept 1d6 damage (1-6)
- [ ] Tier 4 items accept 2d6+4 damage (6-16)
- [ ] Attribute bonuses validated within tier range
- [ ] Defense values validated within tier range
- [ ] Violations clearly reported with expected vs actual
- [ ] Configuration loaded from JSON file

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 tests pass
- [ ] XML documentation complete on all public members
- [ ] Code follows established patterns from v0.16.3a-d

---

## 14. Dependencies

### 14.1 Required from Previous Versions

| Type          | Location             | Usage in this phase |
| ------------- | -------------------- | ------------------- |
| `QualityTier` | Domain/Enums         | Tier identification |
| `Item`        | Domain/Entities      | Item being verified |
| `LootDrop`    | Domain/ValueObjects  | Integration point   |
| `LootService` | Application/Services | Calls verification  |

### 14.2 Provides to Future Phases

| Type                       | Usage                              |
| -------------------------- | ---------------------------------- |
| `IStatVerificationService` | v0.16.4: Container loot validation |
| `StatRange`                | UI: Display expected stats         |

---

## 15. Future Considerations

### 15.1 Deferred to v0.16.4

- **Container Loot**: Verification for chest and container drops

### 15.2 Deferred to v0.16.5

- **Unique Items**: Special stat rules for legendary items

### 15.3 Out of Scope

- **Auto-Correction**: Automatically fixing invalid stats (future)
- **Stat Rerolling**: Allowing players to reroll stats (future)
- **Special Properties**: Magic effects, procs, set bonuses (future)
- **Luck Modifier**: Player stats affecting stat rolls (future)

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
