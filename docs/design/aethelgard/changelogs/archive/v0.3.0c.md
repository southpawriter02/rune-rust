> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.0](../v0.3.x/v0.3.0.md).

# v0.3.0c: The Scar (Consequences)

**Release Date**: 2025-12-20

## Summary

This release implements the third and final phase of the v0.3.0 Trauma Economy milestone: **Breaking Point Resolution and Permanent Traumas**. When a character's psychic stress reaches 100, they trigger a Breaking Point event that rolls a WILL-based resolve check to determine the outcome - stabilization, trauma acquisition, or catastrophic collapse.

---

## New Features

### Breaking Point Resolution System
- **WILL-based Resolve Check**: When stress reaches 100, roll WILL dice pool with difficulty 3
  - **Stabilized** (3+ successes): Stress resets to 75, character gains Disoriented status for 2 turns
  - **Trauma** (<3 successes, no fumble): Stress resets to 50, character acquires a random permanent trauma
  - **Catastrophe** (0 successes + botches): Stress resets to 50, character acquires trauma + Stunned status

### Trauma System
- **Permanent Psychological Scars**: Traumas persist across combat encounters and affect character capabilities
- **4 Trauma Categories**:
  - **Phobias**: Fear-based, triggered by environmental conditions
  - **Somatic**: Physical manifestations with permanent attribute penalties
  - **Delusions**: Distorted perception affecting behavior
  - **Compulsions**: Forced behavioral patterns

### 10 Starter Traumas

| ID | Name | Type | Effect |
|----|------|------|--------|
| TRM_NYCTO | Nyctophobia | Phobia | +2 stress/turn in dark areas |
| TRM_CLAUSTRO | Claustrophobia | Phobia | +2 stress/turn in confined spaces |
| TRM_HEMATO | Hemophobia | Phobia | +1 stress/turn when blood is drawn |
| TRM_SHAKES | The Shakes | Somatic | Permanent -1 Finesse |
| TRM_MIGRAINES | Chronic Migraines | Somatic | Permanent -1 Wits |
| TRM_FATIGUE | Bone-Deep Exhaustion | Somatic | Permanent -1 Sturdiness |
| TRM_PARANOIA | Paranoia | Delusion | +1 stress when receiving ally effects |
| TRM_VOICES | The Whispers | Delusion | Permanent -1 Will |
| TRM_SELFHARM | Self-Destructive Urges | Compulsion | Triggers at Fractured stress tier |
| TRM_HOARDER | Compulsive Hoarding | Compulsion | +1 stress when discarding items |

### Status Effects
- **Disoriented** (new): Mental impairment from near-breaking. -1 to all dice pools. Applied when stabilizing from a Breaking Point. Does not stack; reapplication refreshes duration only. Enum value: 4.

---

## Files Created

| File | Purpose | Lines |
|------|---------|-------|
| `Core/Enums/TraumaType.cs` | 4-category trauma classification enum (Phobia, Compulsion, Delusion, Somatic) | ~25 |
| `Core/Enums/BreakingPointOutcome.cs` | Breaking Point resolution outcomes enum (Stabilized, Trauma, Catastrophe) | ~30 |
| `Core/Entities/Trauma.cs` | Persistent trauma entity with Id, DefinitionId, Name, Description, Type, Source, AcquiredAt, IsActive properties | ~45 |
| `Core/Models/Combat/TraumaDefinition.cs` | Trauma template record with AttributePenalties dictionary, StressPerTurnInCondition, TriggerCondition; includes `CreateInstance(source)` factory method | ~42 |
| `Core/Models/Combat/BreakingPointResult.cs` | Breaking Point resolution result record with Outcome, AcquiredTrauma, NewStressLevel, ResolveSuccesses, ResolveBotches, WasStunned, WasDisoriented | ~35 |
| `Engine/Services/TraumaRegistry.cs` | Static registry of 10 starter traumas with `GetRandom()`, `GetById(id)`, `GetByType(type)` methods | ~167 |

---

## Files Modified

### Core Layer

| File | Change | Details |
|------|--------|---------|
| `Core/Entities/Character.cs` | Added `ActiveTraumas` property | New `List<Trauma>` property in Trauma System region (v0.3.0c) |
| `Core/Enums/StatusEffectType.cs` | Added `Disoriented` status effect | Value 4 in DEBUFFS section, includes XML documentation |
| `Core/Interfaces/ITraumaService.cs` | Added Breaking Point resolution methods | New region with `ResolveBreakingPoint()`, `ApplyTraumaPenalties()`, `GetTraumaAttributePenalty()` |

### Engine Layer

| File | Change | Details |
|------|--------|---------|
| `Engine/Services/TraumaService.cs` | Implemented Breaking Point resolution | New `#region Breaking Point Resolution (v0.3.0c)` with full WILL-based resolve check logic, trauma acquisition, and attribute penalty application |
| `Engine/Services/TraumaService.cs` | Updated `HandleBreakingPoint()` | Now calls `ResolveBreakingPoint()` for player combatants; non-player combatants reset to stress 75 |
| `Engine/Services/CombatService.cs` | Added `ITraumaService` injection | Constructor parameter added, field stored as `_traumaService` |
| `Engine/Services/CombatService.cs` | Added trauma trigger processing | New `ProcessTraumaTriggers()` method in `#region Trauma System (v0.3.0c)`, called at turn start for player combatants |

### Test Layer

| File | Change | Details |
|------|--------|---------|
| `Tests/Engine/TraumaServiceTests.cs` | Added 18 new test cases | Two new test regions: `Breaking Point Tests (v0.3.0c)` and `Trauma Registry Tests (v0.3.0c)` |
| `Tests/Engine/TraumaServiceTests.cs` | Updated existing stress tests | `InflictStress_ClampsAt100` and `InflictStress_TriggersBreakingPointAt100` updated for new Breaking Point behavior |
| `Tests/Engine/CombatServiceTests.cs` | Added `ITraumaService` mock | Mock added to constructor call to support new dependency |

---

## Technical Implementation

### Architecture

```
Breaking Point Cycle:
┌───────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│  InflictStress()  │───▶│ HandleBreaking   │───▶│ ResolveBreaking     │
│ (Stress hits 100) │    │ Point()          │    │ Point()             │
└───────────────────┘    └──────────────────┘    └─────────────────────┘
                                                           │
                              ┌─────────────────────────────┼─────────────────────────────┐
                              ▼                             ▼                             ▼
                    ┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
                    │   STABILIZED    │           │     TRAUMA      │           │   CATASTROPHE   │
                    │ Stress = 75     │           │ Stress = 50     │           │ Stress = 50     │
                    │ + Disoriented   │           │ + Random Trauma │           │ + Trauma        │
                    └─────────────────┘           └─────────────────┘           │ + Stunned       │
                                                                                └─────────────────┘
```

### Trauma Trigger Processing Flow

```
Turn Start (NextTurn)
    │
    ├── Process DoT damage (StatusEffectService)
    ├── Process trait regeneration (CreatureTraitService)
    ├── Process stamina regeneration (ResourceService)
    ├── Process ability cooldowns (AbilityService)
    │
    └── Process trauma triggers (NEW - v0.3.0c)
            │
            └── For each active trauma with "Always active" trigger:
                    │
                    └── InflictStress(combatant, StressPerTurnInCondition, "Trauma: {Name}")
```

### Decision Logic

```csharp
public BreakingPointResult ResolveBreakingPoint(Character character, string source)
{
    var willValue = character.GetAttribute(CharacterAttribute.Will);
    var resolveRoll = _dice.Roll(willValue, $"{character.Name} Breaking Point Resolve");

    if (resolveRoll.Successes >= 3)
        outcome = BreakingPointOutcome.Stabilized;   // Stress = 75, +Disoriented
    else if (resolveRoll.Successes == 0 && resolveRoll.Botches > 0)
        outcome = BreakingPointOutcome.Catastrophe;  // Stress = 50, +Trauma, +Stunned
    else
        outcome = BreakingPointOutcome.Trauma;       // Stress = 50, +Trauma
}
```

### Trauma Definition Structure

```csharp
public record TraumaDefinition(
    string DefinitionId,           // e.g., "TRM_SHAKES"
    string Name,                   // e.g., "The Shakes"
    string Description,            // Narrative flavor text
    TraumaType Type,               // Phobia, Somatic, Delusion, Compulsion
    Dictionary<CharacterAttribute, int> AttributePenalties,  // e.g., {Finesse: -1}
    int StressPerTurnInCondition,  // Passive stress per turn when triggered
    string TriggerCondition        // e.g., "Always active", "In dark areas"
)
{
    public Trauma CreateInstance(string source) => new()
    {
        DefinitionId = DefinitionId,
        Name = Name,
        Description = Description,
        Type = Type,
        Source = source,
        AcquiredAt = DateTime.UtcNow,
        IsActive = true
    };
}
```

### Attribute Penalty Application

```csharp
public void ApplyTraumaPenalties(Character character, Trauma trauma)
{
    var definition = TraumaRegistry.GetById(trauma.DefinitionId);

    foreach (var penalty in definition.AttributePenalties)
    {
        var currentValue = character.GetAttribute(penalty.Key);
        var newValue = Math.Max(1, currentValue + penalty.Value); // Min 1
        character.SetAttribute(penalty.Key, newValue);
    }
}
```

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Breaking Point triggered | Warning | `"BREAKING POINT: {Name} triggered. Source: {Source}. Rolling WILL resolve check..."` |
| Resolve check rolled | Information | `"Resolve check: {Will}d10 = {Successes} successes, {Botches} botches"` |
| Stabilized outcome | Information | `"{Name} STABILIZED from Breaking Point. Stress reset to 75. Gains Disoriented status."` |
| Trauma outcome | Warning | `"{Name} acquired trauma at Breaking Point: {Trauma}. Stress reset to 50."` |
| Catastrophe outcome | Critical | `"{Name} CATASTROPHE at Breaking Point! Acquired trauma: {Trauma}. Stress reset to 50. Gains Stunned."` |
| Breaking Point resolved | Warning | `"BREAKING POINT RESOLVED: {Target} - Outcome: {Outcome}, New Stress: {Stress}"` |
| Non-player Breaking Point | Warning | `"BREAKING POINT: {Target} (non-player) stress reset to 75"` |
| Penalty applied | Information | `"{Name} trauma penalty applied: {Attribute} {CurrentValue} -> {NewValue} (from {Trauma})"` |
| No definition found | Warning | `"No trauma definition found for {DefinitionId}, skipping penalty application"` |
| Trauma trigger processing | Debug | `"Processing {Count} active traumas for {Name}"` |
| Trauma trigger applied | Debug | `"Trauma trigger: {Trauma} inflicted {Net} stress (Raw: {Raw}, Mitigated: {Mit})"` |

---

## Test Coverage

### New Tests (18 total)

#### Breaking Point Resolution Tests
- `ResolveBreakingPoint_Stabilized_WhenThreeOrMoreSuccesses` - Verifies 3+ successes → Stabilized, stress=75, Disoriented=true
- `ResolveBreakingPoint_Trauma_WhenFewerThanThreeSuccessesNoBotches` - Verifies <3 successes → Trauma, stress=50, trauma acquired
- `ResolveBreakingPoint_Catastrophe_WhenZeroSuccessesAndBotches` - Verifies 0 successes + botches → Catastrophe, Stunned=true
- `ResolveBreakingPoint_Trauma_NotCatastrophe_WhenZeroSuccessesButNoBotches` - Edge case: 0 successes without botches is Trauma, not Catastrophe
- `ResolveBreakingPoint_AddsTraumaToCharacterActiveTraumas` - Verifies trauma added to character's list with correct source

#### Trauma Penalty Tests
- `ApplyTraumaPenalties_AppliesAttributePenalties` - Verifies Finesse reduced by The Shakes (-1)
- `ApplyTraumaPenalties_ClampsAttributeToMinimumOne` - Verifies attributes never go below 1
- `GetTraumaAttributePenalty_ReturnsTotalPenaltiesForAttribute` - Verifies penalty calculation from active traumas
- `GetTraumaAttributePenalty_IgnoresInactiveTraumas` - Verifies inactive traumas don't contribute to penalties

#### HandleBreakingPoint Integration Tests
- `HandleBreakingPoint_ResolvesBreakingPointForPlayerCombatant` - Verifies full resolution flow for players
- `HandleBreakingPoint_ResetsStressTo75ForNonPlayerCombatant` - Verifies simplified handling for enemies

#### TraumaRegistry Tests
- `TraumaRegistry_HasAllStarterTraumas` - Verifies 10+ traumas registered
- `TraumaRegistry_GetById_ReturnsCorrectTrauma` - Verifies TRM_NYCTO lookup
- `TraumaRegistry_GetById_ReturnsNullForInvalidId` - Verifies null for unknown IDs
- `TraumaRegistry_GetByType_ReturnsMatchingTraumas` - Verifies 3+ Phobia type traumas
- `TraumaRegistry_GetRandom_ReturnsValidTrauma` - Verifies random selection returns valid trauma

#### TraumaDefinition Tests
- `TraumaDefinition_CreateInstance_CreatesValidTrauma` - Verifies factory method creates correct trauma entity

#### Updated Existing Tests
- `InflictStress_ClampsAt100AndTriggersBreakingPoint` - Updated: now expects stress=50 (Trauma outcome)
- `InflictStress_TriggersBreakingPointAt100` - Updated: now expects stress=50 (Trauma outcome)

### Test Results
```
Passed: 1655 | Failed: 0 | Skipped: 0
Duration: 604ms
```

---

## Integration Notes

### Combat Service Integration
- `ITraumaService` injected into `CombatService` constructor (12th parameter)
- Trauma triggers processed at turn start after ability cooldowns, before defending stance reset
- Only "Always active" traumas trigger automatically via `ProcessTraumaTriggers()`
- Combat log shows trauma stress application: `"[magenta]{Name}[/] suffers from [grey]{trauma.Name}[/] (+{stress} stress)"`

### Character Entity
- `ActiveTraumas` list persists with character (new region: Trauma System v0.3.0c)
- Traumas applied via `TraumaDefinition.CreateInstance(source)` factory method
- Attribute penalties applied immediately upon trauma acquisition

### Combatant Sync
- `HandleBreakingPoint()` syncs stress from `CharacterSource.PsychicStress` back to `Combatant.CurrentStress`
- Non-player combatants (enemies) reset to 75 without trauma mechanics

---

## Design Decisions

### Why Stress Resets Differ (75 vs 50)
- **Stabilized (75)**: Character barely held on; still fragile but functional
- **Trauma/Catastrophe (50)**: Mental break occurred; character is recovering but scarred

### Why Random Trauma Selection
- Mirrors unpredictable nature of psychological breaks
- Future enhancement: weighted selection based on combat context

### Why Attribute Minimum of 1
- Prevents characters from becoming completely non-functional
- Aligns with D10 dice pool minimum (always roll at least 1 die)

### Phobia vs Somatic Design
- **Phobias**: Conditional stress accumulation (environmental triggers)
- **Somatic**: Permanent attribute penalties (always active)
- This split creates meaningful gameplay variety

---

## Known Limitations

1. **Environmental Triggers**: Phobia triggers (dark areas, confined spaces) require environment system integration (future version)
2. **Combat-Specific Triggers**: Hemophobia and similar triggers require damage event hooks (future version)
3. **Disoriented Status**: Status effect enum exists but dice pool penalty not yet wired into roll mechanics
4. **Stunned Application**: Breaking Point returns `WasStunned` flag but status effect not automatically applied to combatant
5. **Trauma Removal**: No mechanism to cure or remove traumas (intentional for v0.3.0c - traumas are permanent scars)

---

## Milestone Status

**v0.3.0 Trauma Economy: COMPLETE**

| Phase | Feature | Status | Tests Added |
|-------|---------|--------|-------------|
| v0.3.0a | Psychic Stress + Resolve Checks | Complete | 28 |
| v0.3.0b | Corruption + Tier System | Complete | 28 |
| v0.3.0c | Breaking Point + Traumas | Complete | 18 |
| **Total** | | | **74 tests** |

---

## Directory Structure

```
RuneAndRust.Core/
├── Entities/
│   ├── Character.cs          [MODIFIED - ActiveTraumas]
│   └── Trauma.cs              [NEW]
├── Enums/
│   ├── BreakingPointOutcome.cs [NEW]
│   ├── StatusEffectType.cs    [MODIFIED - Disoriented]
│   └── TraumaType.cs          [NEW]
├── Interfaces/
│   └── ITraumaService.cs      [MODIFIED - Breaking Point methods]
└── Models/Combat/
    ├── BreakingPointResult.cs [NEW]
    └── TraumaDefinition.cs    [NEW]

RuneAndRust.Engine/
└── Services/
    ├── CombatService.cs       [MODIFIED - ITraumaService, ProcessTraumaTriggers]
    ├── TraumaRegistry.cs      [NEW]
    └── TraumaService.cs       [MODIFIED - Breaking Point implementation]

RuneAndRust.Tests/
└── Engine/
    ├── CombatServiceTests.cs  [MODIFIED - ITraumaService mock]
    └── TraumaServiceTests.cs  [MODIFIED - 18 new tests]
```

---

## Related Documentation

- [v0.3.0a Changelog](v0.3.0a.md) - Psychic Stress System
- [v0.3.0b Changelog](v0.3.0b.md) - Corruption & Tiers
